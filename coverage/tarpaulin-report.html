<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 72px;
}
.code-line {
  margin: 0;
  height: 1em;
  counter-increment: line;

  position: absolute;
  padding: 0 0.3em 0.3em 0.3em;
  display: inherit;
  width: 100%;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

.code-text-container {
  position: relative;
  height: 1em;
  padding: 0.3em 0;
}

.cover-indicator {
  display: flex;
  width: 100%;
  position: absolute;
  justify-content: end;
  height: 1em;
  align-items: center;
  padding: 0 0.3em 0.3em 0.3em;
}

.cover-indicator.check-cover::after {
  content: "\2713";
  font-weight: bold;
  background-color: var(--green);
  height: 1em;
}

.cover-indicator.no-cover::after {
  content: "\2716";
  font-weight: bold;
  background-color: var(--red);
  height: 1em;
}

.stat-line-hit {
  max-width: 48px;
  overflow: hidden;
  font-weight: bold;
  margin-right: 4px;
  background-color: var(--green);
  position: relative;
  top: 0.1em;
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","home","shift","code","vincents-ai","engram","build.rs"],"content":"use std::env;\nuse std::process::Command;\n\nfn main() {\n    let package_version = get_package_version();\n    let git_info = extract_git_info();\n    let build_timestamp = generate_build_timestamp();\n\n    set_build_environment_variables(\u0026package_version, \u0026git_info, \u0026build_timestamp);\n\n    let full_version = create_version_string(\u0026package_version, \u0026git_info);\n    println!(\"cargo:rustc-env=ENGRAM_FULL_VERSION={}\", full_version);\n}\n\nfn get_package_version() -\u003e String {\n    env::var(\"CARGO_PKG_VERSION\").unwrap_or_default()\n}\n\n#[derive(Debug, Clone)]\nstruct GitInfo {\n    tag: String,\n    commit_sha: String,\n    commit_date: String,\n    is_tagged_release: bool,\n}\n\nfn extract_git_info() -\u003e GitInfo {\n    // Try to get release tag first, fallback to commit\n    let tag_info = get_git_tag();\n    let commit_info = get_git_commit();\n\n    GitInfo {\n        tag: tag_info.clone(),\n        commit_sha: commit_info.sha,\n        commit_date: commit_info.date,\n        is_tagged_release: !tag_info.is_empty(),\n    }\n}\n\nfn get_git_tag() -\u003e String {\n    match Command::new(\"git\")\n        .args([\"describe\", \"--tags\", \"--abbrev=0\", \"--exact-match\", \"v*\"])\n        .output()\n    {\n        Ok(output) if output.status.success() =\u003e {\n            let tag_output = String::from_utf8_lossy(\u0026output.stdout);\n            let tag = tag_output.trim();\n            if tag.starts_with('v') {\n                tag.to_string()\n            } else {\n                String::new()\n            }\n        }\n        _ =\u003e String::new(),\n    }\n}\n\nfn get_git_commit() -\u003e CommitInfo {\n    match Command::new(\"git\")\n        .args([\"log\", \"-1\", \"--format=%H %ci %s\"])\n        .output()\n    {\n        Ok(output) if output.status.success() =\u003e {\n            let git_info = String::from_utf8_lossy(\u0026output.stdout);\n            let parts: Vec\u003c\u0026str\u003e = git_info.split_whitespace().collect();\n            if parts.len() \u003e= 2 {\n                CommitInfo {\n                    sha: parts[0].to_string(),\n                    date: parts[1].to_string(),\n                }\n            } else {\n                CommitInfo {\n                    sha: \"unknown\".to_string(),\n                    date: \"unknown\".to_string(),\n                }\n            }\n        }\n        _ =\u003e CommitInfo {\n            sha: \"unknown\".to_string(),\n            date: \"unknown\".to_string(),\n        },\n    }\n}\n\n#[derive(Debug, Clone)]\nstruct CommitInfo {\n    sha: String,\n    date: String,\n}\n\nfn generate_build_timestamp() -\u003e String {\n    chrono::Utc::now().format(\"%Y-%m-%dT%H:%M:%SZ\").to_string()\n}\n\nfn set_build_environment_variables(version: \u0026str, git_info: \u0026GitInfo, build_timestamp: \u0026str) {\n    println!(\"cargo:rustc-env=ENGRAM_VERSION={}\", version);\n    println!(\"cargo:rustc-env=ENGRAM_GIT_TAG={}\", git_info.tag);\n    println!(\"cargo:rustc-env=ENGRAM_COMMIT_SHA={}\", git_info.commit_sha);\n    println!(\n        \"cargo:rustc-env=ENGRAM_COMMIT_DATE={}\",\n        git_info.commit_date\n    );\n    println!(\"cargo:rustc-env=ENGRAM_BUILD_TIMESTAMP={}\", build_timestamp);\n    println!(\n        \"cargo:rustc-env=ENGRAM_IS_TAGGED_RELEASE={}\",\n        git_info.is_tagged_release\n    );\n}\n\nfn create_version_string(package_version: \u0026str, git_info: \u0026GitInfo) -\u003e String {\n    if git_info.is_tagged_release {\n        // For tagged releases, show just the version (stable)\n        package_version.to_string()\n    } else if !git_info.commit_sha.is_empty() \u0026\u0026 git_info.commit_sha != \"unknown\" {\n        // For dev builds, show commit SHA (safely handle short SHAs)\n        let sha_len = std::cmp::min(8, git_info.commit_sha.len());\n        format!(\n            \"{} ({} {})\",\n            package_version,\n            \u0026git_info.commit_sha[..sha_len],\n            git_info.commit_date\n        )\n    } else {\n        // Fallback for builds without git\n        package_version.to_string()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_git_info_structure() {\n        let info = extract_git_info();\n        // Should always create valid GitInfo\n        assert!(!info.commit_sha.is_empty() || info.tag.is_empty());\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","examples","basic_usage.rs"],"content":"//! Basic usage example for Engram Rust implementation\n\nuse engram::{\n    entities::Task,\n    storage::{GitStorage, Storage},\n    Entity,\n};\n\nfn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    println!(\"Engram Rust Implementation - Basic Usage Example\");\n    println!(\"=============================================\");\n\n    // Initialize storage\n    let mut storage = GitStorage::new(\".\", \"example-agent\")?;\n    println!(\"‚úÖ Storage initialized\");\n\n    // Create a sample task\n    let task = Task::new(\n        \"Example Task\".to_string(),\n        \"This is a sample task created using Rust API\".to_string(),\n        \"example-agent\".to_string(),\n        engram::entities::TaskPriority::Medium,\n        None,\n    );\n\n    let generic_task = task.to_generic();\n\n    // Store task\n    storage.store(\u0026generic_task)?;\n    println!(\"‚úÖ Task created: {}\", task.id);\n\n    // Retrieve task\n    if let Some(retrieved_task) = storage.get(\u0026task.id, \"task\")? {\n        println!(\n            \"‚úÖ Task retrieved: {}\",\n            retrieved_task\n                .data\n                .get(\"title\")\n                .and_then(|v| v.as_str())\n                .unwrap_or(\"Untitled\")\n        );\n        println!(\n            \"   Description: {}\",\n            retrieved_task\n                .data\n                .get(\"description\")\n                .and_then(|v| v.as_str())\n                .unwrap_or(\"No description\")\n        );\n    }\n\n    // List all tasks for agent\n    let tasks = storage.query_by_agent(\"example-agent\", Some(\"task\"))?;\n    println!(\"‚úÖ Found {} tasks for agent\", tasks.len());\n\n    println!();\n    println!(\"This example demonstrates:\");\n    println!(\"1. Git-based storage initialization\");\n    println!(\"2. Entity creation and storage\");\n    println!(\"3. Entity retrieval\");\n    println!(\"4. Agent-based querying\");\n    println!(\"5. Extensible entity system\");\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","examples","feature_demonstrations.rs"],"content":"//! Engram Feature Demonstrations\n//!\n//! This example provides demonstrations of core Engram features including\n//! entity creation, relationships, validation, sessions, workflows, and backup.\n\nuse engram::entities::{Context, ContextRelevance, Entity, Reasoning, Task};\nuse engram::storage::memory_only_storage::MemoryStorage;\nuse engram::storage::Storage;\nuse engram::Entity as _;\n\nfn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    println!(\"Engram Feature Demonstrations\");\n    println!(\"==============================\\n\");\n\n    let mut storage = MemoryStorage::new(\"demo-agent\");\n    println!(\"‚úÖ Storage initialized\\n\");\n\n    // Create entities\n    let task = Task::new(\n        \"Implement authentication\".to_string(),\n        \"Add JWT-based authentication to API\".to_string(),\n        \"demo-agent\".to_string(),\n        engram::entities::TaskPriority::High,\n        None,\n    );\n\n    let mut reasoning = Reasoning::new(\n        \"JWT chosen for simplicity\".to_string(),\n        task.id.clone(),\n        \"demo-agent\".to_string(),\n    );\n    reasoning.add_step(\n        \"Evaluate authentication options\".to_string(),\n        \"JWT provides stateless authentication\".to_string(),\n        0.85,\n    );\n    reasoning.add_step(\n        \"Compare JWT vs OAuth2\".to_string(),\n        \"JWT simpler for our use case\".to_string(),\n        0.9,\n    );\n    reasoning.set_conclusion(\"Implement JWT authentication\".to_string(), 0.9);\n\n    let context = Context::new(\n        \"JWT RFC 7519\".to_string(),\n        \"JSON Web Token specification\".to_string(),\n        \"documentation\".to_string(),\n        ContextRelevance::High,\n        \"demo-agent\".to_string(),\n    );\n\n    storage.store(\u0026task.to_generic())?;\n    storage.store(\u0026reasoning.to_generic())?;\n    storage.store(\u0026context.to_generic())?;\n    println!(\"‚úÖ Created task, reasoning, and context\");\n\n    // Show entity types\n    println!(\"\\nüì¶ Supported Entity Types:\");\n    println!(\"   ‚Ä¢ Task - Work items with priorities and status\");\n    println!(\"   ‚Ä¢ Context - Background information and docs\");\n    println!(\"   ‚Ä¢ Reasoning - Decision chains with confidence\");\n    println!(\"   ‚Ä¢ Knowledge - Information with categorization\");\n    println!(\"   ‚Ä¢ Session - Agent work sessions with metrics\");\n    println!(\"   ‚Ä¢ Relationship - Entity connections (graph)\");\n    println!(\"   ‚Ä¢ Workflow - State machine definitions\");\n    println!(\"   ‚Ä¢ Compliance - Requirements tracking\");\n    println!(\"   ‚Ä¢ Standard - Team standards with versioning\");\n    println!(\"   ‚Ä¢ ADR - Architectural Decision Records\");\n\n    // Show features\n    println!(\"\\nüéØ Key Features:\");\n    println!(\"1. Entity Management\");\n    println!(\"   - Create, read, update, delete entities\");\n    println!(\"   - Type-safe entity trait with validation\");\n    println!(\"   - Generic entity representation for dynamic handling\");\n    println!(\"   - Agent-based filtering and querying\");\n\n    println!(\"\\n2. Relationship System\");\n    println!(\"   - Graph-based entity relationships\");\n    println!(\"   - Types: DependsOn, Contains, References, etc.\");\n    println!(\"   - Direction: Unidirectional, Bidirectional\");\n    println!(\"   - Strength: Weak, Medium, Strong, Critical\");\n    println!(\"   - Path finding and graph traversal\");\n\n    println!(\"\\n3. Validation System\");\n    println!(\"   - Task ID extraction: [TASK-123], [task:id], Refs: #456\");\n    println!(\"   - Relationship requirements (reasoning + context)\");\n    println!(\"   - Pre-commit hook integration\");\n    println!(\"   - Exemption handling for chore/docs/fixup\");\n\n    println!(\"\\n4. Session Management\");\n    println!(\"   - Track agent work sessions\");\n    println!(\"   - Goals and outcomes documentation\");\n    println!(\"   - Task/context/knowledge associations\");\n    println!(\"   - SPACE framework metrics\");\n    println!(\"   - DORA metrics integration\");\n\n    println!(\"\\n5. Workflow Engine\");\n    println!(\"   - Custom state machine definitions\");\n    println!(\"   - State transitions with conditions\");\n    println!(\"   - Prompt templates per state\");\n    println!(\"   - Permission schemes\");\n    println!(\"   - Task-workflow association\");\n\n    println!(\"\\n6. Perkeep Integration\");\n    println!(\"   - Content-addressable backup (SHA-256)\");\n    println!(\"   - Entity type filtering\");\n    println!(\"   - Relationship preservation\");\n    println!(\"   - Selective restore by blob reference\");\n\n    // Show CLI commands\n    println!(\"\\nüíª CLI Commands:\");\n    println!(\"   engram task create --title 'Task' --priority high\");\n    println!(\"   engram context create --title 'Context' --source docs\");\n    println!(\"   engram reasoning create --title 'Reasoning' --task-id \u003cid\u003e\");\n    println!(\"   engram relationship create --source-id a --target-id b --type depends_on\");\n    println!(\"   engram validation commit --message 'feat: implement [TASK-ID]'\");\n    println!(\"   engram session start --agent alice\");\n    println!(\"   engram workflow create --title 'My Workflow'\");\n    println!(\"   engram perkeep backup --description 'Backup'\");\n\n    // Show storage backends\n    println!(\"\\nüíæ Storage Backends:\");\n    println!(\"   ‚Ä¢ GitStorage - Content-addressable Git-based storage\");\n    println!(\"   ‚Ä¢ MemoryStorage - In-memory storage for testing\");\n    println!(\"   ‚Ä¢ RelationshipStorage - Graph relationship queries\");\n    println!(\"   ‚Ä¢ GitRefsStorage - Git references for collaboration\");\n\n    // Show configuration\n    println!(\"\\n‚öôÔ∏è Configuration (.engram/config.yaml):\");\n    println!(\"   app:\");\n    println!(\"     log_level: info\");\n    println!(\"     default_agent: default\");\n    println!(\"   workspace:\");\n    println!(\"     agents:\");\n    println!(\"       coder:\");\n    println!(\"         type: implementation\");\n    println!(\"   storage:\");\n    println!(\"     storage_type: git\");\n    println!(\"     base_path: .engram\");\n\n    println!(\"\\nüéØ This demonstrates:\");\n    println!(\"1. ‚úÖ Multi-entity creation and storage\");\n    println!(\"2. ‚úÖ Entity relationships and graph operations\");\n    println!(\"3. ‚úÖ Commit validation with task references\");\n    println!(\"4. ‚úÖ Session tracking with goals/outcomes\");\n    println!(\"5. ‚úÖ Workflow state machine concepts\");\n    println!(\"6. ‚úÖ Perkeep backup/restore integration\");\n    println!(\"7. ‚úÖ Storage backend options\");\n    println!(\"8. ‚úÖ CLI command overview\");\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","examples","memory_storage_demo.rs"],"content":"//! Demonstration using memory storage (no Git dependency)\n\nuse engram::entities::Task;\nuse engram::storage::{memory_only_storage::MemoryStorage, Storage};\nuse engram::Entity;\n\nfn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    println!(\"Engram Rust Implementation - Memory Storage Demo\");\n    println!(\"=============================================\");\n\n    // Initialize memory storage\n    let mut storage = MemoryStorage::new(\"demo-agent\");\n    println!(\"‚úÖ Memory storage initialized\");\n\n    // Create some sample tasks\n    let tasks = vec![\n        Task::new(\n            \"Setup project structure\".to_string(),\n            \"Create directories and initial files\".to_string(),\n            \"demo-agent\".to_string(),\n            engram::entities::TaskPriority::High,\n            None,\n        ),\n        Task::new(\n            \"Implement core entities\".to_string(),\n            \"Define Task, Context, Reasoning types\".to_string(),\n            \"demo-agent\".to_string(),\n            engram::entities::TaskPriority::Medium,\n            None,\n        ),\n        Task::new(\n            \"Add CLI interface\".to_string(),\n            \"Create modular command structure\".to_string(),\n            \"demo-agent\".to_string(),\n            engram::entities::TaskPriority::Medium,\n            None,\n        ),\n    ];\n\n    // Store tasks\n    for task in \u0026tasks {\n        let generic_task = task.to_generic();\n        storage.store(\u0026generic_task)?;\n        println!(\"‚úÖ Task created: {}\", task.id);\n    }\n\n    // Query tasks by agent\n    let retrieved_tasks = storage.query_by_agent(\"demo-agent\", Some(\"task\"))?;\n    println!(\"‚úÖ Retrieved {} tasks\", retrieved_tasks.len());\n\n    for task in \u0026retrieved_tasks {\n        println!(\n            \"üìã Task: {} [{}] - {}\",\n            task.id,\n            task.entity_type,\n            task.data\n                .get(\"title\")\n                .and_then(|v| v.as_str())\n                .unwrap_or(\"Untitled\")\n        );\n    }\n\n    // Show commit history\n    let history = storage.history(Some(5))?;\n    println!(\"‚úÖ Recent operations:\");\n    for commit in \u0026history {\n        println!(\n            \"  ‚Ä¢ {} - {} ({})\",\n            commit.timestamp.format(\"%H:%M:%S\"),\n            commit.message,\n            commit.author\n        );\n    }\n\n    println!();\n    println!(\"This demonstrates:\");\n    println!(\"1. ‚úÖ In-memory storage without external dependencies\");\n    println!(\"2. ‚úÖ Entity creation and validation\");\n    println!(\"3. ‚úÖ Query operations with filtering\");\n    println!(\"4. ‚úÖ Extensible entity system\");\n    println!(\"5. ‚úÖ Operation history tracking\");\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","examples","perkeep_demo.rs"],"content":"//! Perkeep backup/restore demonstration\n//!\n//! This example demonstrates the Perkeep integration concepts for\n//! backing up and restoring entity data.\n\nfn main() {\n    println!(\"Engram Perkeep Backup/Restore Demo\");\n    println!(\"===================================\\n\");\n\n    println!(\"üì¶ Perkeep Backup Features:\");\n    println!(\"1. ‚úÖ Content-addressable storage (SHA-256)\");\n    println!(\"2. ‚úÖ Entity type filtering (task, context, etc.)\");\n    println!(\"3. ‚úÖ Relationship preservation\");\n    println!(\"4. ‚úÖ Backup metadata and versioning\");\n    println!(\"5. ‚úÖ Selective restore by blob reference\");\n\n    // Show backup commands\n    println!(\"\\nüíæ Backup Commands:\");\n    println!(\"   engram perkeep backup                    # All entities\");\n    println!(\"   engram perkeep backup --entity-type task # Specific type\");\n    println!(\"   engram perkeep backup --description 'Weekly backup'\");\n    println!(\"   engram perkeep backup --include-relationships\");\n\n    // Show restore commands\n    println!(\"\\nüîÑ Restore Commands:\");\n    println!(\"   engram perkeep restore                   # Latest backup\");\n    println!(\"   engram perkeep restore --blobref 'sha256-...'\");\n    println!(\"   engram perkeep restore --dry-run         # Preview only\");\n    println!(\"   engram perkeep restore --agent default   # To specific agent\");\n\n    // Show management commands\n    println!(\"\\nüõ†Ô∏è Management Commands:\");\n    println!(\"   engram perkeep list                      # List backups\");\n    println!(\"   engram perkeep list --detailed\");\n    println!(\"   engram perkeep health                    # Server health\");\n    println!(\"   engram perkeep config --server 'http://localhost:3179'\");\n\n    // Show configuration\n    println!(\"\\n‚öôÔ∏è Configuration:\");\n    println!(\"   PERKEEP_SERVER=http://localhost:3179\");\n    println!(\"   PERKEEP_AUTH_TOKEN=your-token (optional)\");\n\n    // Note about Perkeep server\n    println!(\"\\nüìå Perkeep Server:\");\n    println!(\"   Perkeep is a personal data store server.\");\n    println!(\"   Install: https://perkeep.org/\");\n    println!(\"   Default port: 3179\");\n\n    // Backup process\n    println!(\"\\nüîç Backup Process:\");\n    println!(\"   1. Connect to Perkeep server\");\n    println!(\"   2. Serialize entities to JSON\");\n    println!(\"   3. Upload as blobs (content-addressed)\");\n    println!(\"   4. Create schema object tracking blobs\");\n    println!(\"   5. Store metadata (timestamps, counts)\");\n\n    // Restore process\n    println!(\"\\nüîç Restore Process:\");\n    println!(\"   1. Fetch backup metadata\");\n    println!(\"   2. Retrieve all entity blobs\");\n    println!(\"   3. Deserialize JSON to entities\");\n    println!(\"   4. Store in Engram storage\");\n\n    // Use cases\n    println!(\"\\nüí° Use Cases:\");\n    println!(\"   ‚Ä¢ Disaster recovery\");\n    println!(\"   ‚Ä¢ Cross-machine transfer\");\n    println!(\"   ‚Ä¢ Long-term archival\");\n    println!(\"   ‚Ä¢ Version history\");\n\n    println!(\"\\nüéØ Perkeep Integration Benefits:\");\n    println!(\"1. ‚úÖ Content-addressable integrity\");\n    println!(\"2. ‚úÖ Selective backup/restore\");\n    println!(\"3. ‚úÖ Relationship preservation\");\n    println!(\"4. ‚úÖ Metadata tracking\");\n    println!(\"5. ‚úÖ Server-based storage\");\n\n    println!(\"\\nüíª Perkeep CLI Integration:\");\n    println!(\"   Note: Requires running Perkeep server\");\n    println!(\"   Example: export PERKEEP_SERVER=http://localhost:3179\");\n    println!(\"   Then use: engram perkeep backup --description 'Backup'\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","examples","test_migration.rs"],"content":"// Simple test of migration functionality\nuse engram::migration::Migration;\n\nfn main() {\n    println!(\"üß™ Testing migration functionality...\");\n\n    // Test basic migration creation\n    match Migration::new(\".\", \"default\", false, false) {\n        Ok(mut migration) =\u003e {\n            println!(\"‚úÖ Migration instance created successfully\");\n\n            // Test pre-flight validation\n            match Migration::validate_migration_readiness(\".\") {\n                Ok(()) =\u003e println!(\"‚úÖ Pre-flight validation passed\"),\n                Err(e) =\u003e println!(\"‚ùå Pre-flight validation failed: {}\", e),\n            }\n\n            println!(\"‚úÖ Migration implementation is working correctly!\");\n        }\n        Err(e) =\u003e println!(\"‚ùå Migration creation failed: {}\", e),\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","analytics","mod.rs"],"content":"//! Analytics module for Engram\n//!\n//! Provides SPACE framework and DORA metrics calculation\n//! for productivity analysis and session management.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\n\n/// SPACE framework metrics\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SpaceMetrics {\n    pub satisfaction_score: f64,\n    pub performance_score: f64,\n    pub activity_score: f64,\n    pub communication_score: f64,\n    pub efficiency_score: f64,\n    pub overall_score: f64,\n}\n\n/// DORA metrics\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DoraMetrics {\n    pub deployment_frequency: u32,\n    pub lead_time: f64,\n    pub change_failure_rate: f64,\n    pub mean_time_to_recover: f64,\n}\n\n/// Session analytics\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SessionAnalytics {\n    pub session_id: String,\n    pub agent_name: String,\n    pub start_time: DateTime\u003cUtc\u003e,\n    pub end_time: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    pub space_metrics: SpaceMetrics,\n    pub dora_metrics: DoraMetrics,\n    pub tasks_completed: u32,\n    pub context_items_created: u32,\n    pub reasoning_steps_taken: u32,\n    pub knowledge_items_added: u32,\n}\n\nimpl SessionAnalytics {\n    pub fn calculate_productivity_score(\u0026self) -\u003e f64 {\n        let base_score = self.space_metrics.overall_score;\n        let task_weight = 0.3;\n        let activity_weight = 0.4;\n        let duration_weight = 0.3;\n\n        let duration_factor = if let Some(end_time) = self.end_time {\n            let duration = end_time\n                .signed_duration_since(self.start_time)\n                .num_minutes() as f64;\n            if duration \u003e 480.0 {\n                0.7\n            } else if duration \u003e 240.0 {\n                0.85\n            } else {\n                1.0\n            }\n        } else {\n            0.5\n        };\n\n        base_score * (task_weight + activity_weight * duration_factor + duration_weight)\n    }\n\n    pub fn generate_summary(\u0026self) -\u003e String {\n        let end_status = if let Some(end_time) = self.end_time {\n            format!(\"ended at {}\", end_time.format(\"%Y-%m-%d %H:%M\"))\n        } else {\n            \"ongoing\".to_string()\n        };\n\n        format!(\n            \"Session {}: {} ({}) | Productivity: {:.2}\",\n            self.session_id,\n            self.agent_name,\n            end_status,\n            self.calculate_productivity_score()\n        )\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct FatigueAnalysis {\n    pub optimal_session_length: u32,\n    pub current_session_length: u32,\n    pub fatigue_risk_level: String,\n    pub recommendation: String,\n}\n\nimpl FatigueAnalysis {\n    pub fn analyze(\u0026self, session_duration_minutes: u32) -\u003e \u0026str {\n        if session_duration_minutes \u003e self.optimal_session_length * 2 {\n            \"high\"\n        } else if session_duration_minutes \u003e self.optimal_session_length {\n            \"medium\"\n        } else {\n            \"low\"\n        }\n    }\n}\n\n/// Task duration analytics report\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TaskDurationReport {\n    pub period_days: u32,\n    pub total_tasks: u32,\n    pub completed_tasks: u32,\n    pub avg_completion_time_seconds: f64,\n    pub median_completion_time_seconds: f64,\n    pub min_completion_time_seconds: f64,\n    pub max_completion_time_seconds: f64,\n    pub tasks_by_agent: Vec\u003cAgentTaskMetrics\u003e,\n    pub tasks_by_priority: Vec\u003cPriorityTaskMetrics\u003e,\n    pub throughput_per_day: f64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AgentTaskMetrics {\n    pub agent: String,\n    pub tasks_completed: u32,\n    pub avg_duration_seconds: f64,\n    pub total_seconds: f64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PriorityTaskMetrics {\n    pub priority: String,\n    pub tasks_completed: u32,\n    pub avg_duration_seconds: f64,\n}\n\n/// Workflow stage analytics report\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkflowStageReport {\n    pub workflow_id: String,\n    pub total_instances: u32,\n    pub completed_instances: u32,\n    pub failed_instances: u32,\n    pub avg_cycle_time_seconds: f64,\n    pub stage_dwell_times: Vec\u003cStageDwellMetrics\u003e,\n    pub transition_counts: Vec\u003cTransitionMetrics\u003e,\n    pub completion_rate: f64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct StageDwellMetrics {\n    pub stage_name: String,\n    pub avg_time_seconds: f64,\n    pub min_time_seconds: f64,\n    pub max_time_seconds: f64,\n    pub total_entries: u32,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TransitionMetrics {\n    pub from_state: String,\n    pub to_state: String,\n    pub count: u32,\n    pub avg_transition_time_seconds: f64,\n}\n\n/// Bottleneck analysis report\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct BottleneckReport {\n    pub generated_at: DateTime\u003cUtc\u003e,\n    pub period_days: u32,\n    pub overall_metrics: BottleneckOverallMetrics,\n    pub task_bottlenecks: Vec\u003cTaskBottleneck\u003e,\n    pub workflow_bottlenecks: Vec\u003cWorkflowBottleneck\u003e,\n    pub recommendations: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct BottleneckOverallMetrics {\n    pub total_tasks_created: u32,\n    pub total_tasks_completed: u32,\n    pub completion_rate: f64,\n    pub avg_cycle_time_seconds: f64,\n    pub blocked_task_rate: f64,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TaskBottleneck {\n    pub task_id: String,\n    pub title: String,\n    pub agent: String,\n    pub time_in_current_status_seconds: f64,\n    pub status: String,\n    pub priority: String,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkflowBottleneck {\n    pub workflow_id: String,\n    pub stage_name: String,\n    pub avg_dwell_time_seconds: f64,\n    pub total_instances_stuck: u32,\n    pub severity: String,\n}\n\nuse crate::entities::{Entity, Task, TaskStatus};\nuse crate::storage::Storage;\nuse std::collections::HashMap;\n\nimpl TaskDurationReport {\n    pub fn generate\u003cS: Storage\u003e(storage: \u0026S, days: u32) -\u003e Result\u003cSelf, String\u003e {\n        let cutoff = Utc::now() - chrono::Duration::days(days as i64);\n        let task_ids = storage.list_ids(\"task\").map_err(|e| e.to_string())?;\n\n        let mut durations: Vec\u003cf64\u003e = Vec::new();\n        let mut agent_metrics: HashMap\u003cString, (u32, f64)\u003e = HashMap::new();\n        let mut priority_metrics: HashMap\u003cString, (u32, f64)\u003e = HashMap::new();\n        let mut total_tasks = 0;\n        let mut completed_tasks = 0;\n\n        for id in task_ids {\n            if let Ok(Some(entity)) = storage.get(\u0026id, \"task\") {\n                if let Ok(task) = Task::from_generic(entity) {\n                    total_tasks += 1;\n\n                    if let Some(end_time) = task.end_time {\n                        if end_time \u003e cutoff {\n                            completed_tasks += 1;\n                            let duration_seconds = end_time\n                                .signed_duration_since(task.start_time)\n                                .num_seconds()\n                                as f64;\n                            durations.push(duration_seconds);\n\n                            agent_metrics\n                                .entry(task.agent.clone())\n                                .and_modify(|(count, total)| {\n                                    *count += 1;\n                                    *total += duration_seconds;\n                                })\n                                .or_insert((1, duration_seconds));\n\n                            let priority = format!(\"{:?}\", task.priority).to_lowercase();\n                            priority_metrics\n                                .entry(priority)\n                                .and_modify(|(count, total)| {\n                                    *count += 1;\n                                    *total += duration_seconds;\n                                })\n                                .or_insert((1, duration_seconds));\n                        }\n                    }\n                }\n            }\n        }\n\n        durations.sort_by(|a, b| a.partial_cmp(b).unwrap());\n        let avg = durations.iter().sum::\u003cf64\u003e() / durations.len().max(1) as f64;\n        let median = if durations.is_empty() {\n            0.0\n        } else {\n            durations[durations.len() / 2]\n        };\n        let min = durations.first().copied().unwrap_or(0.0);\n        let max = durations.last().copied().unwrap_or(0.0);\n\n        let tasks_by_agent: Vec\u003cAgentTaskMetrics\u003e = agent_metrics\n            .into_iter()\n            .map(|(agent, (count, total))| AgentTaskMetrics {\n                agent,\n                tasks_completed: count,\n                avg_duration_seconds: total / count.max(1) as f64,\n                total_seconds: total,\n            })\n            .collect();\n\n        let tasks_by_priority: Vec\u003cPriorityTaskMetrics\u003e = priority_metrics\n            .into_iter()\n            .map(|(priority, (count, total))| PriorityTaskMetrics {\n                priority,\n                tasks_completed: count,\n                avg_duration_seconds: total / count.max(1) as f64,\n            })\n            .collect();\n\n        Ok(TaskDurationReport {\n            period_days: days,\n            total_tasks,\n            completed_tasks,\n            avg_completion_time_seconds: avg,\n            median_completion_time_seconds: median,\n            min_completion_time_seconds: min,\n            max_completion_time_seconds: max,\n            tasks_by_agent,\n            tasks_by_priority,\n            throughput_per_day: completed_tasks as f64 / days.max(1) as f64,\n        })\n    }\n}\n\nimpl WorkflowStageReport {\n    pub fn generate\u003cS: Storage + 'static\u003e(\n        storage: S,\n        workflow_id: \u0026str,\n        days: u32,\n    ) -\u003e Result\u003cSelf, String\u003e {\n        use crate::engines::workflow_engine::{WorkflowAutomationEngine, WorkflowStatus};\n\n        let cutoff = Utc::now() - chrono::Duration::days(days as i64);\n        let engine = WorkflowAutomationEngine::new(storage);\n        let instances = engine.list_active_instances();\n\n        let filtered_instances: Vec\u003c_\u003e = instances\n            .into_iter()\n            .filter(|i| i.workflow_id == workflow_id \u0026\u0026 i.started_at \u003e cutoff)\n            .collect();\n\n        let completed_count = filtered_instances\n            .iter()\n            .filter(|i| matches!(i.status, WorkflowStatus::Completed))\n            .count() as u32;\n        let failed_count = filtered_instances\n            .iter()\n            .filter(|i| matches!(i.status, WorkflowStatus::Failed(_)))\n            .count() as u32;\n\n        let mut cycle_times: Vec\u003cf64\u003e = Vec::new();\n        let mut stage_times: HashMap\u003cString, Vec\u003cf64\u003e\u003e = HashMap::new();\n        let mut transitions: HashMap\u003c(String, String), u32\u003e = HashMap::new();\n\n        for instance in \u0026filtered_instances {\n            if let Some(completed) = instance.completed_at {\n                cycle_times.push(\n                    completed\n                        .signed_duration_since(instance.started_at)\n                        .num_seconds() as f64,\n                );\n            }\n\n            let _prev_state: Option\u003cString\u003e = None;\n            for event in \u0026instance.execution_history {\n                if let Some(to) = \u0026event.to_state {\n                    let dwell = event\n                        .timestamp\n                        .signed_duration_since(instance.started_at)\n                        .num_seconds() as f64;\n                    stage_times\n                        .entry(to.clone())\n                        .and_modify(|v| v.push(dwell))\n                        .or_insert_with(|| vec![dwell]);\n                }\n\n                if let (Some(from), Some(to)) = (\u0026event.from_state, \u0026event.to_state) {\n                    *transitions.entry((from.clone(), to.clone())).or_insert(0) += 1;\n                }\n            }\n        }\n\n        let avg_cycle = cycle_times.iter().sum::\u003cf64\u003e() / cycle_times.len().max(1) as f64;\n\n        let stage_dwell_times: Vec\u003cStageDwellMetrics\u003e = stage_times\n            .into_iter()\n            .map(|(stage, times)| {\n                let mut sorted = times.clone();\n                sorted.sort_by(|a, b| a.partial_cmp(b).unwrap());\n                StageDwellMetrics {\n                    stage_name: stage,\n                    avg_time_seconds: times.iter().sum::\u003cf64\u003e() / times.len().max(1) as f64,\n                    min_time_seconds: sorted.first().copied().unwrap_or(0.0),\n                    max_time_seconds: sorted.last().copied().unwrap_or(0.0),\n                    total_entries: times.len() as u32,\n                }\n            })\n            .collect();\n\n        let transition_counts: Vec\u003cTransitionMetrics\u003e = transitions\n            .into_iter()\n            .map(|((from, to), count)| TransitionMetrics {\n                from_state: from,\n                to_state: to,\n                count,\n                avg_transition_time_seconds: 0.0,\n            })\n            .collect();\n\n        Ok(WorkflowStageReport {\n            workflow_id: workflow_id.to_string(),\n            total_instances: filtered_instances.len() as u32,\n            completed_instances: completed_count,\n            failed_instances: failed_count,\n            avg_cycle_time_seconds: avg_cycle,\n            stage_dwell_times,\n            transition_counts,\n            completion_rate: if filtered_instances.is_empty() {\n                0.0\n            } else {\n                completed_count as f64 / filtered_instances.len() as f64\n            },\n        })\n    }\n}\n\nimpl BottleneckReport {\n    pub fn generate\u003cS: Storage + 'static\u003e(storage: S, days: u32) -\u003e Result\u003cSelf, String\u003e {\n        let cutoff = Utc::now() - chrono::Duration::days(days as i64);\n        let task_ids = storage.list_ids(\"task\").map_err(|e| e.to_string())?;\n\n        let mut total_created = 0;\n        let mut total_completed = 0;\n        let mut cycle_times: Vec\u003cf64\u003e = Vec::new();\n        let mut blocked_count = 0;\n        let mut task_bottlenecks: Vec\u003cTaskBottleneck\u003e = Vec::new();\n\n        for id in task_ids {\n            if let Ok(Some(entity)) = storage.get(\u0026id, \"task\") {\n                if let Ok(task) = Task::from_generic(entity) {\n                    if task.start_time \u003e cutoff {\n                        total_created += 1;\n\n                        match task.status {\n                            TaskStatus::Blocked =\u003e {\n                                blocked_count += 1;\n                                let seconds_stuck = Utc::now()\n                                    .signed_duration_since(task.start_time)\n                                    .num_seconds()\n                                    as f64;\n                                if seconds_stuck \u003e 86400.0 {\n                                    task_bottlenecks.push(TaskBottleneck {\n                                        task_id: task.id,\n                                        title: task.title,\n                                        agent: task.agent,\n                                        time_in_current_status_seconds: seconds_stuck,\n                                        status: format!(\"{:?}\", task.status),\n                                        priority: format!(\"{:?}\", task.priority),\n                                    });\n                                }\n                            }\n                            TaskStatus::Done | TaskStatus::Cancelled =\u003e {\n                                total_completed += 1;\n                                if let Some(end_time) = task.end_time {\n                                    cycle_times.push(\n                                        end_time\n                                            .signed_duration_since(task.start_time)\n                                            .num_seconds()\n                                            as f64,\n                                    );\n                                }\n                            }\n                            _ =\u003e {\n                                let seconds_in_status = Utc::now()\n                                    .signed_duration_since(task.start_time)\n                                    .num_seconds()\n                                    as f64;\n                                if seconds_in_status \u003e 259200.0 {\n                                    task_bottlenecks.push(TaskBottleneck {\n                                        task_id: task.id,\n                                        title: task.title,\n                                        agent: task.agent,\n                                        time_in_current_status_seconds: seconds_in_status,\n                                        status: format!(\"{:?}\", task.status),\n                                        priority: format!(\"{:?}\", task.priority),\n                                    });\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        task_bottlenecks.sort_by(|a, b| {\n            b.time_in_current_status_seconds\n                .partial_cmp(\u0026a.time_in_current_status_seconds)\n                .unwrap()\n        });\n        task_bottlenecks.truncate(10);\n\n        let avg_cycle = cycle_times.iter().sum::\u003cf64\u003e() / cycle_times.len().max(1) as f64;\n\n        let mut recommendations: Vec\u003cString\u003e = Vec::new();\n        if blocked_count as f64 / total_created.max(1) as f64 \u003e 0.1 {\n            recommendations.push(\n                \"High blocked task rate detected. Review blockers and dependencies.\".to_string(),\n            );\n        }\n        if avg_cycle \u003e 172800.0 {\n            recommendations.push(\n                \"Average cycle time exceeds 2 days. Consider breaking down tasks.\".to_string(),\n            );\n        }\n        if task_bottlenecks.len() \u003e 3 {\n            recommendations.push(\n                \"Multiple long-running tasks detected. Consider reassessment or escalation.\"\n                    .to_string(),\n            );\n        }\n\n        Ok(BottleneckReport {\n            generated_at: Utc::now(),\n            period_days: days,\n            overall_metrics: BottleneckOverallMetrics {\n                total_tasks_created: total_created,\n                total_tasks_completed: total_completed,\n                completion_rate: total_completed as f64 / total_created.max(1) as f64,\n                avg_cycle_time_seconds: avg_cycle,\n                blocked_task_rate: blocked_count as f64 / total_created.max(1) as f64,\n            },\n            task_bottlenecks,\n            workflow_bottlenecks: Vec::new(),\n            recommendations,\n        })\n    }\n}\n","traces":[{"line":45,"address":[17606496],"length":1,"stats":{"Line":0}},{"line":46,"address":[17606555],"length":1,"stats":{"Line":0}},{"line":47,"address":[17391633],"length":1,"stats":{"Line":0}},{"line":48,"address":[17391647],"length":1,"stats":{"Line":0}},{"line":49,"address":[17391661],"length":1,"stats":{"Line":0}},{"line":51,"address":[17391692,17391883],"length":1,"stats":{"Line":0}},{"line":52,"address":[17606713,17606651],"length":1,"stats":{"Line":0}},{"line":53,"address":[24725877,24725923],"length":1,"stats":{"Line":0}},{"line":54,"address":[24265279],"length":1,"stats":{"Line":0}},{"line":55,"address":[19025213,19025281],"length":1,"stats":{"Line":0}},{"line":56,"address":[18888067],"length":1,"stats":{"Line":0}},{"line":57,"address":[17536049,17536003],"length":1,"stats":{"Line":0}},{"line":58,"address":[18888099],"length":1,"stats":{"Line":0}},{"line":60,"address":[24726051],"length":1,"stats":{"Line":0}},{"line":63,"address":[18888029],"length":1,"stats":{"Line":0}},{"line":66,"address":[18888119],"length":1,"stats":{"Line":0}},{"line":69,"address":[17606072,17605712,17606066],"length":1,"stats":{"Line":0}},{"line":70,"address":[17594222],"length":1,"stats":{"Line":0}},{"line":71,"address":[19024275,19024374],"length":1,"stats":{"Line":0}},{"line":73,"address":[24264442],"length":1,"stats":{"Line":0}},{"line":76,"address":[18887317,18887428],"length":1,"stats":{"Line":0}},{"line":81,"address":[19024619,19024529],"length":1,"stats":{"Line":0}},{"line":95,"address":[17534768],"length":1,"stats":{"Line":0}},{"line":96,"address":[17594121,17594038],"length":1,"stats":{"Line":0}},{"line":97,"address":[16752356],"length":1,"stats":{"Line":0}},{"line":98,"address":[19024093,19024144],"length":1,"stats":{"Line":0}},{"line":99,"address":[17390786],"length":1,"stats":{"Line":0}},{"line":101,"address":[16752379],"length":1,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":231},{"path":["/","home","shift","code","vincents-ai","engram","src","ask.rs"],"content":"//! Natural Language Query Interface for Engram\n//!\n//! Provides conversational access to Engram's memory system through pattern matching\n//! and entity extraction. Maps natural language queries to structured Engram operations.\n\nuse crate::error::EngramError;\nuse crate::nlq::NLQEngine;\nuse crate::storage::GitRefsStorage;\nuse clap::Subcommand;\nuse serde_json;\n\n/// Natural language query commands\n#[derive(Subcommand)]\npub enum AskCommands {\n    /// Ask a natural language query about your Engram data\n    Query {\n        /// Natural language query to execute\n        #[arg(help = \"Natural language query about your Engram data\")]\n        query: String,\n\n        /// Context for the query (task ID, agent, etc.)\n        #[arg(\n            long,\n            short = 'c',\n            help = \"Context for the query (task ID, agent, etc.)\"\n        )]\n        context: Option\u003cString\u003e,\n\n        /// Verbose output with detailed explanation\n        #[arg(long, short = 'v', help = \"Verbose output with detailed explanation\")]\n        verbose: bool,\n\n        /// Output in JSON format for programmatic use\n        #[arg(long, short = 'j', help = \"Output in JSON format for programmatic use\")]\n        json: bool,\n    },\n}\n\n/// Handle natural language query commands\npub async fn handle_ask_command(command: AskCommands) -\u003e Result\u003c(), EngramError\u003e {\n    let AskCommands::Query {\n        query,\n        context,\n        verbose,\n        json,\n    } = command;\n\n    let nlq_engine = NLQEngine::new();\n    let storage = GitRefsStorage::new(\".\", \"default\")?;\n\n    match nlq_engine.process_query(\u0026query, context, \u0026storage).await {\n        Ok(result) =\u003e {\n            if json {\n                let json_output = serde_json::json!({\n                    \"success\": result.success,\n                    \"query\": query,\n                    \"response\": result.formatted_response,\n                    \"data\": result.data,\n                    \"execution_time_ms\": result.execution_time_ms\n                });\n                println!(\"{}\", serde_json::to_string_pretty(\u0026json_output)?);\n            } else {\n                println!(\"{}\", result.formatted_response);\n\n                if verbose {\n                    println!(\"\\n--- Debug Information ---\");\n                    println!(\"Execution time: {}ms\", result.execution_time_ms);\n                    println!(\"Raw data: {}\", serde_json::to_string_pretty(\u0026result.data)?);\n                }\n            }\n        }\n        Err(e) =\u003e {\n            if json {\n                let error_output = serde_json::json!({\n                    \"success\": false,\n                    \"query\": query,\n                    \"error\": e.to_string()\n                });\n                println!(\"{}\", serde_json::to_string_pretty(\u0026error_output)?);\n            } else {\n                println!(\"Error processing query: {}\", e);\n            }\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":40,"address":[19284016,19284033],"length":1,"stats":{"Line":0}},{"line":42,"address":[14857273],"length":1,"stats":{"Line":0}},{"line":43,"address":[14857292],"length":1,"stats":{"Line":0}},{"line":44,"address":[16096069],"length":1,"stats":{"Line":0}},{"line":45,"address":[21521390],"length":1,"stats":{"Line":0}},{"line":48,"address":[16096087],"length":1,"stats":{"Line":0}},{"line":49,"address":[15337483,15338200,15337572],"length":1,"stats":{"Line":0}},{"line":51,"address":[14885762,14885659,14885156,14885987],"length":1,"stats":{"Line":0}},{"line":52,"address":[19327442],"length":1,"stats":{"Line":0}},{"line":53,"address":[14787813],"length":1,"stats":{"Line":0}},{"line":54,"address":[21984481,21984735,21983369,21984919,21985243,21984185,21984989,21985980,21984077,21984115,21985173,21984413,21984665],"length":1,"stats":{"Line":0}},{"line":61,"address":[16099548,16099477],"length":1,"stats":{"Line":0}},{"line":63,"address":[16220255,16220166],"length":1,"stats":{"Line":0}},{"line":65,"address":[19327649],"length":1,"stats":{"Line":0}},{"line":66,"address":[16097544],"length":1,"stats":{"Line":0}},{"line":67,"address":[14886613],"length":1,"stats":{"Line":0}},{"line":68,"address":[14859317,14858941],"length":1,"stats":{"Line":0}},{"line":72,"address":[16220065],"length":1,"stats":{"Line":0}},{"line":73,"address":[16097284],"length":1,"stats":{"Line":0}},{"line":74,"address":[16100490,16101901,16100149,16100815,16100561,16100296,16100886,16100745],"length":1,"stats":{"Line":0}},{"line":77,"address":[21526100],"length":1,"stats":{"Line":0}},{"line":79,"address":[21987225,21987154],"length":1,"stats":{"Line":0}},{"line":81,"address":[19330190,19330271],"length":1,"stats":{"Line":0}},{"line":86,"address":[15341211],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":24},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","adr.rs"],"content":"use crate::entities::{AdrStatus, Entity, ADR};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\n\n/// ADR commands\n#[derive(Debug, Subcommand)]\npub enum AdrCommands {\n    /// Create a new ADR\n    Create {\n        /// ADR title\n        #[arg(long, short)]\n        title: String,\n\n        /// ADR number\n        #[arg(long)]\n        number: u32,\n\n        /// Context and problem statement\n        #[arg(long)]\n        context: String,\n\n        /// Agent to assign\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n    },\n    /// Get ADR details\n    Get {\n        /// ADR ID\n        #[arg(help = \"ADR ID to retrieve\")]\n        id: String,\n    },\n    /// Update ADR\n    Update {\n        /// ADR ID\n        #[arg(help = \"ADR ID to update\")]\n        id: String,\n\n        /// ADR title\n        #[arg(long)]\n        title: Option\u003cString\u003e,\n\n        /// ADR status (proposed, accepted, deprecated, superseded)\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n\n        /// Context and problem statement\n        #[arg(long)]\n        context: Option\u003cString\u003e,\n\n        /// Decision description\n        #[arg(long)]\n        decision: Option\u003cString\u003e,\n\n        /// Consequences of the decision\n        #[arg(long)]\n        consequences: Option\u003cString\u003e,\n\n        /// Implementation notes\n        #[arg(long)]\n        implementation: Option\u003cString\u003e,\n\n        /// Superseded by ADR ID\n        #[arg(long)]\n        superseded_by: Option\u003cString\u003e,\n    },\n    /// Delete ADR\n    Delete {\n        /// ADR ID\n        #[arg(help = \"ADR ID to delete\")]\n        id: String,\n    },\n    /// List ADRs\n    List {\n        /// Status filter\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n\n        /// Text search\n        #[arg(long)]\n        search: Option\u003cString\u003e,\n\n        /// Limit results\n        #[arg(long, default_value = \"20\")]\n        limit: usize,\n\n        /// Offset for pagination\n        #[arg(long, default_value = \"0\")]\n        offset: usize,\n    },\n    /// Accept an ADR\n    Accept {\n        /// ADR ID\n        #[arg(help = \"ADR ID to accept\")]\n        id: String,\n\n        /// Decision description\n        #[arg(long)]\n        decision: String,\n\n        /// Consequences of the decision\n        #[arg(long)]\n        consequences: String,\n    },\n    /// Add alternative to ADR\n    AddAlternative {\n        /// ADR ID\n        #[arg(help = \"ADR ID to add alternative to\")]\n        id: String,\n\n        /// Alternative description\n        #[arg(long)]\n        description: String,\n    },\n    /// Add stakeholder to ADR\n    AddStakeholder {\n        /// ADR ID\n        #[arg(help = \"ADR ID to add stakeholder to\")]\n        id: String,\n\n        /// Stakeholder name\n        #[arg(long)]\n        stakeholder: String,\n    },\n}\n\n/// Create a new ADR\npub fn create_adr\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    title: String,\n    number: u32,\n    context: String,\n    agent: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let adr = ADR::new(\n        title,\n        number,\n        agent.unwrap_or_else(|| \"cli\".to_string()),\n        context,\n    );\n\n    let generic = adr.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"‚úÖ ADR created: {}\", adr.id());\n    display_adr(\u0026adr);\n\n    Ok(())\n}\n\n/// Get ADR details\npub fn get_adr\u003cS: Storage\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"adr\")? {\n        let adr = ADR::from_generic(generic)?;\n        display_adr(\u0026adr);\n    } else {\n        println!(\"‚ùå ADR not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Update ADR\npub fn update_adr\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    title: Option\u003cString\u003e,\n    status: Option\u003cString\u003e,\n    context: Option\u003cString\u003e,\n    decision: Option\u003cString\u003e,\n    consequences: Option\u003cString\u003e,\n    implementation: Option\u003cString\u003e,\n    superseded_by: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"adr\")? {\n        let mut adr =\n            ADR::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        let mut updated = false;\n\n        if let Some(title) = title {\n            adr.title = title;\n            updated = true;\n        }\n\n        if let Some(status_str) = status {\n            let new_status = match status_str.to_lowercase().as_str() {\n                \"proposed\" =\u003e AdrStatus::Proposed,\n                \"accepted\" =\u003e AdrStatus::Accepted,\n                \"deprecated\" =\u003e AdrStatus::Deprecated,\n                \"superseded\" =\u003e AdrStatus::Superseded,\n                _ =\u003e {\n                    println!(\"‚ùå Invalid status. Use: proposed, accepted, deprecated, superseded\");\n                    return Ok(());\n                }\n            };\n            adr.status = new_status;\n            updated = true;\n        }\n\n        if let Some(context) = context {\n            adr.context = context;\n            updated = true;\n        }\n\n        if let Some(decision) = decision {\n            adr.decision = decision;\n            updated = true;\n        }\n\n        if let Some(consequences) = consequences {\n            adr.consequences = consequences;\n            updated = true;\n        }\n\n        if let Some(implementation) = implementation {\n            adr.set_implementation(implementation);\n            updated = true;\n        }\n\n        if let Some(superseded_by_id) = superseded_by {\n            if superseded_by_id.is_empty() {\n                adr.superseded_by = None;\n            } else {\n                adr.superseded_by = Some(superseded_by_id);\n                adr.status = AdrStatus::Superseded;\n            }\n            updated = true;\n        }\n\n        if !updated {\n            println!(\"No updates specified\");\n            return Ok(());\n        }\n\n        adr.updated_at = chrono::Utc::now();\n        let updated_generic = adr.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\"‚úÖ ADR updated: {}\", id);\n    } else {\n        println!(\"‚ùå ADR not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Delete ADR\npub fn delete_adr\u003cS: Storage\u003e(storage: \u0026mut S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"adr\")? {\n        let mut adr =\n            ADR::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        adr.deprecate(None);\n        let updated_generic = adr.to_generic();\n        storage.store(\u0026updated_generic)?;\n        println!(\"‚úÖ ADR deleted (deprecated): {}\", id);\n    } else {\n        println!(\"‚ùå ADR not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// List ADRs\npub fn list_adrs\u003cS: Storage\u003e(\n    storage: \u0026S,\n    status: Option\u003cString\u003e,\n    search: Option\u003cString\u003e,\n    limit: usize,\n    offset: usize,\n) -\u003e Result\u003c(), EngramError\u003e {\n    use crate::storage::QueryFilter;\n    use serde_json::Value;\n    use std::collections::HashMap;\n\n    let mut filter = QueryFilter {\n        entity_type: Some(\"adr\".to_string()),\n        text_search: search,\n        limit: Some(limit),\n        offset: Some(offset),\n        ..Default::default()\n    };\n\n    let mut field_filters = HashMap::new();\n\n    if let Some(status_filter) = status {\n        field_filters.insert(\"status\".to_string(), Value::String(status_filter));\n    }\n\n    if !field_filters.is_empty() {\n        filter.field_filters = field_filters;\n    }\n\n    let result = storage.query(\u0026filter)?;\n\n    println!(\"üìã ADRs List\");\n    println!(\"============\");\n\n    if result.entities.is_empty() {\n        println!(\"No ADRs found matching the criteria.\");\n        return Ok(());\n    }\n\n    println!(\n        \"Found {} ADRs (showing {} to {} of {})\",\n        result.total_count,\n        offset + 1,\n        offset + result.entities.len(),\n        result.total_count\n    );\n    println!();\n\n    for (i, entity) in result.entities.iter().enumerate() {\n        let adr_data = \u0026entity.data;\n        let index = offset + i + 1;\n\n        let title = adr_data\n            .get(\"title\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"Untitled ADR\");\n\n        let number = adr_data.get(\"number\").and_then(|v| v.as_u64()).unwrap_or(0);\n\n        let status = adr_data\n            .get(\"status\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"proposed\");\n\n        let status_symbol = match status {\n            \"accepted\" =\u003e \"‚úÖ\",\n            \"rejected\" =\u003e \"‚ùå\",\n            \"deprecated\" =\u003e \"üóëÔ∏è\",\n            \"superseded\" =\u003e \"‚¨ÜÔ∏è\",\n            \"proposed\" =\u003e \"üìù\",\n            _ =\u003e \"‚ùì\",\n        };\n\n        println!(\"{}. {} ADR-{:03} {}\", index, status_symbol, number, title);\n\n        println!(\"   ID: {}\", entity.id);\n\n        if let Some(context) = adr_data.get(\"context\").and_then(|v| v.as_str()) {\n            let truncated = if context.len() \u003e 80 {\n                format!(\"{}...\", \u0026context[..77])\n            } else {\n                context.to_string()\n            };\n            println!(\"   üìù Context: {}\", truncated);\n        }\n\n        if status == \"accepted\" {\n            if let Some(decision) = adr_data.get(\"decision\").and_then(|v| v.as_str()) {\n                let truncated = if decision.len() \u003e 60 {\n                    format!(\"{}...\", \u0026decision[..57])\n                } else {\n                    decision.to_string()\n                };\n                println!(\"   ‚úÖ Decision: {}\", truncated);\n            }\n        }\n\n        if let Some(alternatives) = adr_data.get(\"alternatives\").and_then(|v| v.as_array()) {\n            if !alternatives.is_empty() {\n                println!(\"   üîÄ {} alternative(s) considered\", alternatives.len());\n            }\n        }\n\n        println!(\n            \"   üìä Status: {} | üë§ Agent: {} | üìÖ {}\",\n            status,\n            entity.agent,\n            entity.timestamp.format(\"%Y-%m-%d %H:%M\")\n        );\n\n        println!();\n    }\n\n    if result.has_more {\n        println!(\"üí° Use --offset {} to see more ADRs\", offset + limit);\n    }\n\n    println!(\"üí° Use 'engram adr get \u003cid\u003e' to view full ADR details\");\n    println!(\"üí° Use 'engram adr accept \u003cid\u003e' to accept a proposed ADR\");\n\n    Ok(())\n}\n\n/// Accept an ADR\npub fn accept_adr\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    decision: String,\n    consequences: String,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"adr\")? {\n        let mut adr =\n            ADR::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        adr.accept(decision, consequences);\n        let updated_generic = adr.to_generic();\n        storage.store(\u0026updated_generic)?;\n        println!(\"‚úÖ ADR accepted: {}\", id);\n        display_adr(\u0026adr);\n    } else {\n        println!(\"‚ùå ADR not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Add alternative to ADR\npub fn add_alternative\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    description: String,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"adr\")? {\n        let mut adr =\n            ADR::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        let alt_id = adr.add_alternative(description);\n        let updated_generic = adr.to_generic();\n        storage.store(\u0026updated_generic)?;\n        println!(\"‚úÖ Alternative added to ADR {}: {}\", id, alt_id);\n    } else {\n        println!(\"‚ùå ADR not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Add stakeholder to ADR\npub fn add_stakeholder\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    stakeholder: String,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"adr\")? {\n        let mut adr =\n            ADR::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        adr.add_stakeholder(stakeholder.clone());\n        let updated_generic = adr.to_generic();\n        storage.store(\u0026updated_generic)?;\n        println!(\"‚úÖ Stakeholder added to ADR {}: {}\", id, stakeholder);\n    } else {\n        println!(\"‚ùå ADR not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Display ADR information\nfn display_adr(adr: \u0026ADR) {\n    println!(\"üìã ADR: {}\", adr.id());\n    println!(\"üî¢ Number: ADR-{:03}\", adr.number);\n    println!(\"üìù Title: {}\", adr.title);\n    println!(\"üìä Status: {:?}\", adr.status);\n    println!(\"ü§ñ Agent: {}\", adr.agent);\n    println!(\"üïê Created: {}\", adr.created_at.format(\"%Y-%m-%d %H:%M\"));\n    println!(\"üîÑ Updated: {}\", adr.updated_at.format(\"%Y-%m-%d %H:%M\"));\n\n    if let Some(decision_date) = adr.decision_date {\n        println!(\n            \"üìÖ Decision Date: {}\",\n            decision_date.format(\"%Y-%m-%d %H:%M\")\n        );\n    }\n\n    println!(\"üìù Context:\");\n    println!(\"{}\", adr.context);\n\n    if !adr.decision.is_empty() {\n        println!(\"‚úÖ Decision:\");\n        println!(\"{}\", adr.decision);\n    }\n\n    if !adr.consequences.is_empty() {\n        println!(\"üéØ Consequences:\");\n        println!(\"{}\", adr.consequences);\n    }\n\n    if let Some(ref implementation) = adr.implementation {\n        println!(\"üõ†Ô∏è Implementation:\");\n        println!(\"{}\", implementation);\n    }\n\n    if !adr.alternatives.is_empty() {\n        println!(\"üîÑ Alternatives: {}\", adr.alternatives.len());\n        for (i, alt) in adr.alternatives.iter().enumerate() {\n            println!(\"  {}. {}\", i + 1, alt.description);\n            if !alt.pros.is_empty() {\n                println!(\"     ‚úÖ Pros: {:?}\", alt.pros);\n            }\n            if !alt.cons.is_empty() {\n                println!(\"     ‚ùå Cons: {:?}\", alt.cons);\n            }\n            if let Some(ref reason) = alt.rejection_reason {\n                println!(\"     üö´ Rejected: {}\", reason);\n            }\n        }\n    }\n\n    if !adr.stakeholders.is_empty() {\n        println!(\"üë• Stakeholders: {:?}\", adr.stakeholders);\n    }\n\n    if !adr.related_adrs.is_empty() {\n        println!(\"üîó Related ADRs: {:?}\", adr.related_adrs);\n    }\n\n    if let Some(ref superseded_by) = adr.superseded_by {\n        println!(\"üîó Superseded By: {}\", superseded_by);\n    }\n\n    if !adr.supersedes.is_empty() {\n        println!(\"üìã Supersedes: {:?}\", adr.supersedes);\n    }\n}\n","traces":[{"line":128,"address":[15203776,15204625,15204650],"length":1,"stats":{"Line":0}},{"line":136,"address":[15203859],"length":1,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[15204049],"length":1,"stats":{"Line":0}},{"line":143,"address":[15204119,15204187],"length":1,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[15204501],"length":1,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[15215823],"length":1,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[15215894],"length":1,"stats":{"Line":0}},{"line":163,"address":[15206048,15208024,15211640],"length":1,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[15207338,15207137],"length":1,"stats":{"Line":0}},{"line":186,"address":[15207592,15207497,15207377],"length":1,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[15207730,15207651,15207691],"length":1,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[15207809,15207845],"length":1,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[15208377,15208312],"length":1,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[15208518,15208745,15208336],"length":1,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[15209096,15209284],"length":1,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[15209257],"length":1,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[15209535],"length":1,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[15209577],"length":1,"stats":{"Line":0}},{"line":237,"address":[15209609,15209680],"length":1,"stats":{"Line":0}},{"line":239,"address":[15209825],"length":1,"stats":{"Line":0}},{"line":241,"address":[15206785,15210087],"length":1,"stats":{"Line":0}},{"line":243,"address":[15209969],"length":1,"stats":{"Line":0}},{"line":247,"address":[15205883,15204736,15205889],"length":1,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[15205381],"length":1,"stats":{"Line":0}},{"line":252,"address":[15205452],"length":1,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[15222633,15215936,15217086],"length":1,"stats":{"Line":0}},{"line":274,"address":[15216151,15216071],"length":1,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[15216678],"length":1,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[15216823,15217121,15217330],"length":1,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[15217776,15222404],"length":1,"stats":{"Line":0}},{"line":298,"address":[15222431],"length":1,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[15218229],"length":1,"stats":{"Line":0}},{"line":310,"address":[15218282],"length":1,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[15219283,15222681,15222672],"length":1,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[15222745,15219447,15222736],"length":1,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[15219557,15219654],"length":1,"stats":{"Line":0}},{"line":328,"address":[15219693,15219741,15219612],"length":1,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[15220021],"length":1,"stats":{"Line":0}},{"line":337,"address":[15220334],"length":1,"stats":{"Line":0}},{"line":339,"address":[15222832,15220438,15222841],"length":1,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[15220727,15220816],"length":1,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[15221016,15220773],"length":1,"stats":{"Line":0}},{"line":348,"address":[15220626,15221114],"length":1,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[15221320],"length":1,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[15221915,15221838],"length":1,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[15222354],"length":1,"stats":{"Line":0}},{"line":375,"address":[15218640],"length":1,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[15218879],"length":1,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[15203592,15201936,15203360],"length":1,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[15203366,15202505,15202427,15203632,15203650],"length":1,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[15202877],"length":1,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[15203119],"length":1,"stats":{"Line":0}},{"line":399,"address":[15203215],"length":1,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[15213298,15213421,15211824],"length":1,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[15212601],"length":1,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[15212986],"length":1,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[15214954,15215051,15213600],"length":1,"stats":{"Line":0}},{"line":431,"address":[15213645,15213728,15215049],"length":1,"stats":{"Line":0}},{"line":432,"address":[15215090,15214051,15214960,15214129,15215072],"length":1,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[15214416,15214353],"length":1,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[15214962,15214083],"length":1,"stats":{"Line":0}},{"line":441,"address":[15214885],"length":1,"stats":{"Line":0}},{"line":445,"address":[20494032,20495461,20495467],"length":1,"stats":{"Line":0}},{"line":446,"address":[16142724],"length":1,"stats":{"Line":0}},{"line":447,"address":[16142864],"length":1,"stats":{"Line":0}},{"line":448,"address":[26195086],"length":1,"stats":{"Line":0}},{"line":449,"address":[19064420],"length":1,"stats":{"Line":0}},{"line":450,"address":[25734621],"length":1,"stats":{"Line":0}},{"line":451,"address":[15184527],"length":1,"stats":{"Line":0}},{"line":452,"address":[19076343],"length":1,"stats":{"Line":0}},{"line":454,"address":[18854532],"length":1,"stats":{"Line":0}},{"line":455,"address":[19076654,19076852],"length":1,"stats":{"Line":0}},{"line":461,"address":[26195932],"length":1,"stats":{"Line":0}},{"line":462,"address":[18854708],"length":1,"stats":{"Line":0}},{"line":464,"address":[25735406],"length":1,"stats":{"Line":0}},{"line":465,"address":[20495480],"length":1,"stats":{"Line":0}},{"line":466,"address":[19077040],"length":1,"stats":{"Line":0}},{"line":469,"address":[19006378],"length":1,"stats":{"Line":0}},{"line":470,"address":[26196411],"length":1,"stats":{"Line":0}},{"line":471,"address":[19006435],"length":1,"stats":{"Line":0}},{"line":474,"address":[19065789],"length":1,"stats":{"Line":0}},{"line":475,"address":[20495848],"length":1,"stats":{"Line":0}},{"line":476,"address":[26196651],"length":1,"stats":{"Line":0}},{"line":479,"address":[19066001],"length":1,"stats":{"Line":0}},{"line":480,"address":[26196795],"length":1,"stats":{"Line":0}},{"line":481,"address":[16144838,16144983],"length":1,"stats":{"Line":0}},{"line":482,"address":[19007402,19007161],"length":1,"stats":{"Line":0}},{"line":483,"address":[18856138],"length":1,"stats":{"Line":0}},{"line":484,"address":[19007420],"length":1,"stats":{"Line":0}},{"line":486,"address":[16145446],"length":1,"stats":{"Line":0}},{"line":487,"address":[25736889],"length":1,"stats":{"Line":0}},{"line":489,"address":[18856403],"length":1,"stats":{"Line":0}},{"line":490,"address":[18856457],"length":1,"stats":{"Line":0}},{"line":495,"address":[19007037],"length":1,"stats":{"Line":0}},{"line":496,"address":[18856580],"length":1,"stats":{"Line":0}},{"line":499,"address":[19067185],"length":1,"stats":{"Line":0}},{"line":500,"address":[18856711],"length":1,"stats":{"Line":0}},{"line":503,"address":[19067316],"length":1,"stats":{"Line":0}},{"line":504,"address":[26198143],"length":1,"stats":{"Line":0}},{"line":507,"address":[19067493],"length":1,"stats":{"Line":0}},{"line":508,"address":[18857019],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":206},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","compliance.rs"],"content":"use crate::entities::{Compliance, Entity};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\n\n/// Compliance commands\n#[derive(Debug, Subcommand)]\npub enum ComplianceCommands {\n    /// Create a new compliance requirement\n    Create {\n        /// Compliance requirement title\n        #[arg(long, short)]\n        title: String,\n\n        /// Compliance category\n        #[arg(long)]\n        category: String,\n\n        /// Severity level\n        #[arg(long, default_value = \"medium\")]\n        severity: String,\n\n        /// Description\n        #[arg(long)]\n        description: String,\n\n        /// Agent to assign\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n    },\n    /// List compliance requirements\n    List {\n        /// Agent filter\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Category filter\n        #[arg(long)]\n        category: Option\u003cString\u003e,\n\n        /// Limit results\n        #[arg(long, short)]\n        limit: Option\u003cusize\u003e,\n    },\n    /// Show compliance requirement details\n    Show {\n        /// Requirement ID\n        #[arg(help = \"Compliance requirement ID to show\")]\n        id: String,\n    },\n    /// Update compliance requirement\n    Update {\n        /// Requirement ID\n        #[arg(long, short)]\n        id: String,\n\n        /// Field to update (status, severity, description)\n        #[arg(long, short)]\n        field: String,\n\n        /// New value\n        #[arg(long, short)]\n        value: String,\n    },\n    /// Delete compliance requirement\n    Delete {\n        /// Requirement ID\n        #[arg(long, short)]\n        id: String,\n    },\n}\n\n/// Create compliance requirement\npub fn create_compliance\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    title: String,\n    description: String,\n    category: String,\n    agent: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let compliance = Compliance::new(\n        title,\n        description,\n        category,\n        agent.unwrap_or_else(|| \"default\".to_string()),\n    );\n\n    let generic = compliance.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"‚úÖ Compliance requirement created:\");\n    display_compliance(\u0026compliance);\n\n    Ok(())\n}\n\n/// List compliance requirements\npub fn list_compliance\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent: Option\u003c\u0026str\u003e,\n    category: Option\u003c\u0026str\u003e,\n    limit: Option\u003cusize\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut compliance_items =\n        storage.query_by_agent(agent.unwrap_or(\"default\"), Some(\"compliance\"))?;\n\n    // Filter by category if specified\n    if let Some(category_filter) = category {\n        compliance_items.retain(|generic_item| {\n            if let Ok(compliance_obj) = Compliance::from_generic(generic_item.clone()) {\n                compliance_obj.category.to_lowercase() == category_filter.to_lowercase()\n            } else {\n                false\n            }\n        });\n    }\n\n    // Apply limit\n    if let Some(limit_val) = limit {\n        compliance_items.truncate(limit_val);\n    }\n\n    if compliance_items.is_empty() {\n        println!(\"No compliance requirements found\");\n        return Ok(());\n    }\n\n    println!(\n        \"üîç Compliance Requirements ({} found):\",\n        compliance_items.len()\n    );\n    for generic_item in \u0026compliance_items {\n        if let Ok(compliance_obj) = Compliance::from_generic(generic_item.clone()) {\n            display_compliance_summary(\u0026compliance_obj);\n        }\n    }\n\n    Ok(())\n}\n\n/// Show compliance requirement details\npub fn show_compliance\u003cS: Storage\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    let generic = storage.get(id, \"compliance\")?;\n\n    if let Some(generic_item) = generic {\n        let compliance = Compliance::from_generic(generic_item)?;\n        display_compliance(\u0026compliance);\n    } else {\n        println!(\"‚ùå Compliance requirement '{}' not found\", id);\n    }\n\n    Ok(())\n}\n\n/// Update compliance requirement\npub fn update_compliance\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    field: \u0026str,\n    value: \u0026str,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let generic = storage.get(id, \"compliance\")?;\n\n    if let Some(generic_item) = generic {\n        let mut compliance = Compliance::from_generic(generic_item)?;\n\n        match field.to_lowercase().as_str() {\n            \"status\" =\u003e match value.to_lowercase().as_str() {\n                \"compliant\" =\u003e compliance.mark_compliant(),\n                \"noncompliant\" | \"non-compliant\" =\u003e {\n                    compliance.mark_non_compliant(Vec::new());\n                }\n                _ =\u003e {\n                    return Err(EngramError::Validation(format!(\n                        \"Invalid status: {}\",\n                        value\n                    )))\n                }\n            },\n            \"description\" =\u003e {\n                compliance.description = value.to_string();\n                compliance.updated_at = chrono::Utc::now();\n            }\n            _ =\u003e {\n                return Err(EngramError::Validation(format!(\n                    \"Cannot update field: {}\",\n                    field\n                )))\n            }\n        }\n\n        let updated_generic = compliance.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\"‚úÖ Compliance requirement updated:\");\n        display_compliance(\u0026compliance);\n    } else {\n        println!(\"‚ùå Compliance requirement '{}' not found\", id);\n    }\n\n    Ok(())\n}\n\n/// Delete compliance requirement\npub fn delete_compliance\u003cS: Storage\u003e(storage: \u0026mut S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    storage.delete(id, \"compliance\")?;\n    println!(\"‚úÖ Compliance requirement '{}' deleted\", id);\n    Ok(())\n}\n\n/// Display compliance requirement in detail\nfn display_compliance(compliance: \u0026Compliance) {\n    println!(\"ID: {}\", compliance.id);\n    println!(\"Title: {}\", compliance.title);\n    println!(\"Category: {}\", compliance.category);\n    println!(\"Status: {:?}\", compliance.status);\n    println!(\"Agent: {}\", compliance.agent);\n    println!(\"Description: {}\", compliance.description);\n\n    if let Some(severity) = \u0026compliance.severity {\n        println!(\"Severity: {:?}\", severity);\n    }\n\n    if let Some(due_date) = \u0026compliance.due_date {\n        println!(\"Due Date: {}\", due_date.format(\"%Y-%m-%d %H:%M\"));\n    }\n\n    println!(\n        \"Created: {}\",\n        compliance.created_at.format(\"%Y-%m-%d %H:%M\")\n    );\n    println!(\n        \"Updated: {}\",\n        compliance.updated_at.format(\"%Y-%m-%d %H:%M\")\n    );\n\n    if !compliance.tags.is_empty() {\n        println!(\"Tags: {}\", compliance.tags.join(\", \"));\n    }\n\n    if !compliance.violations.is_empty() {\n        println!(\"Violations: {} found\", compliance.violations.len());\n    }\n\n    if !compliance.evidence.is_empty() {\n        println!(\"Evidence: {} items\", compliance.evidence.len());\n    }\n}\n\n/// Display compliance requirement summary\nfn display_compliance_summary(compliance: \u0026Compliance) {\n    let status_icon = match compliance.status {\n        crate::entities::ComplianceStatus::Compliant =\u003e \"‚úÖ\",\n        crate::entities::ComplianceStatus::NonCompliant =\u003e \"‚ùå\",\n        crate::entities::ComplianceStatus::Pending =\u003e \"‚è≥\",\n        crate::entities::ComplianceStatus::Exempt =\u003e \"üîí\",\n    };\n\n    println!(\n        \"  {} [{}] {} - {} ({})\",\n        status_icon,\n        \u0026compliance.id[..8],\n        compliance.title,\n        compliance.category,\n        compliance.agent\n    );\n}\n","traces":[{"line":74,"address":[14662928,14663666],"length":1,"stats":{"Line":0}},{"line":82,"address":[14662993],"length":1,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[14661221,14660016,14661313],"length":1,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[14661856,14660452,14661862,14660516,14661328],"length":1,"stats":{"Line":0}},{"line":110,"address":[14661427,14661356],"length":1,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[14661422],"length":1,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[14661287],"length":1,"stats":{"Line":0}},{"line":128,"address":[14660577,14660635],"length":1,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[14660902],"length":1,"stats":{"Line":0}},{"line":142,"address":[14662894,14662782,14661920],"length":1,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[14662177],"length":1,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[14662765],"length":1,"stats":{"Line":0}},{"line":156,"address":[14666860,14664112,14666752],"length":1,"stats":{"Line":0}},{"line":162,"address":[14664253],"length":1,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[14665868,14665934,14666348],"length":1,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[14665595,14665576,14665330],"length":1,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[14665303,14665368],"length":1,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[14666456,14666385],"length":1,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[14666638],"length":1,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[14663824],"length":1,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[26081613,26081607,26080464],"length":1,"stats":{"Line":0}},{"line":213,"address":[20379719],"length":1,"stats":{"Line":0}},{"line":214,"address":[18949806],"length":1,"stats":{"Line":0}},{"line":215,"address":[18949912],"length":1,"stats":{"Line":0}},{"line":216,"address":[18950018],"length":1,"stats":{"Line":0}},{"line":217,"address":[18739631],"length":1,"stats":{"Line":0}},{"line":218,"address":[26081001],"length":1,"stats":{"Line":0}},{"line":220,"address":[18739843],"length":1,"stats":{"Line":0}},{"line":221,"address":[18739896],"length":1,"stats":{"Line":0}},{"line":224,"address":[18950510],"length":1,"stats":{"Line":0}},{"line":225,"address":[26081331,26081478],"length":1,"stats":{"Line":0}},{"line":228,"address":[18962200,18962378],"length":1,"stats":{"Line":0}},{"line":232,"address":[26081804],"length":1,"stats":{"Line":0}},{"line":237,"address":[18951195],"length":1,"stats":{"Line":0}},{"line":238,"address":[15419205,15419321],"length":1,"stats":{"Line":0}},{"line":241,"address":[17423692],"length":1,"stats":{"Line":0}},{"line":242,"address":[18892223],"length":1,"stats":{"Line":0}},{"line":245,"address":[18963130],"length":1,"stats":{"Line":0}},{"line":246,"address":[18892385],"length":1,"stats":{"Line":0}},{"line":251,"address":[18741280],"length":1,"stats":{"Line":0}},{"line":252,"address":[18741300],"length":1,"stats":{"Line":0}},{"line":253,"address":[18741335],"length":1,"stats":{"Line":0}},{"line":254,"address":[26082622],"length":1,"stats":{"Line":0}},{"line":255,"address":[17424261],"length":1,"stats":{"Line":0}},{"line":256,"address":[20381900],"length":1,"stats":{"Line":0}},{"line":259,"address":[18741472],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":93},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","context.rs"],"content":"//! Context command implementations\n\nuse crate::entities::{Context, ContextRelevance, Entity};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\nuse serde::Deserialize;\nuse std::fs;\nuse std::io::{self, Read};\n\n/// Context input structure for JSON\n#[derive(Debug, Deserialize)]\npub struct ContextInput {\n    pub title: String,\n    pub content: Option\u003cString\u003e,\n    pub source: Option\u003cString\u003e,\n    pub relevance: Option\u003cString\u003e,\n    pub source_id: Option\u003cString\u003e,\n    pub agent: Option\u003cString\u003e,\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n/// Context commands\n#[derive(Debug, Subcommand)]\npub enum ContextCommands {\n    /// Create a new context\n    Create {\n        /// Context title\n        #[arg(long, short, conflicts_with_all = [\"title_stdin\", \"title_file\"])]\n        title: Option\u003cString\u003e,\n\n        /// Context content\n        #[arg(long, short, conflicts_with_all = [\"content_stdin\", \"content_file\"])]\n        content: Option\u003cString\u003e,\n\n        /// Context source\n        #[arg(long, short)]\n        source: Option\u003cString\u003e,\n\n        /// Relevance level (low, medium, high, critical)\n        #[arg(long, short, default_value = \"medium\")]\n        relevance: String,\n\n        /// Source ID (URL, file path, etc.)\n        #[arg(long)]\n        source_id: Option\u003cString\u003e,\n\n        /// Assigned agent\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Tags (comma-separated)\n        #[arg(long)]\n        tags: Option\u003cString\u003e,\n\n        /// Read title from stdin\n        #[arg(long, conflicts_with_all = [\"title\", \"title_file\"])]\n        title_stdin: bool,\n\n        /// Read title from file\n        #[arg(long, conflicts_with_all = [\"title\", \"title_stdin\"])]\n        title_file: Option\u003cString\u003e,\n\n        /// Read content from stdin\n        #[arg(long, conflicts_with_all = [\"content\", \"content_file\"])]\n        content_stdin: bool,\n\n        /// Read content from file\n        #[arg(long, conflicts_with_all = [\"content\", \"content_stdin\"])]\n        content_file: Option\u003cString\u003e,\n\n        /// Create context from JSON input (stdin or file)\n        #[arg(long, conflicts_with_all = [\"title\", \"content\", \"title_stdin\", \"title_file\", \"content_stdin\", \"content_file\"])]\n        json: bool,\n\n        /// JSON file path (requires --json)\n        #[arg(long, requires = \"json\")]\n        json_file: Option\u003cString\u003e,\n    },\n    /// List contexts\n    List {\n        /// Filter by agent\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Filter by relevance\n        #[arg(long, short)]\n        relevance: Option\u003cString\u003e,\n\n        /// Limit number of results\n        #[arg(long, short)]\n        limit: Option\u003cusize\u003e,\n    },\n    /// Show context details\n    Show {\n        /// Context ID\n        #[arg(help = \"Context ID to show\")]\n        id: String,\n    },\n    /// Update context content\n    Update {\n        /// Context ID\n        #[arg(help = \"Context ID to update\")]\n        id: String,\n\n        /// New content\n        #[arg(long, short)]\n        content: String,\n    },\n    /// Delete a context\n    Delete {\n        /// Context ID\n        #[arg(help = \"Context ID to delete\")]\n        id: String,\n    },\n}\n\n/// Helper function to read from stdin\nfn read_stdin() -\u003e Result\u003cString, EngramError\u003e {\n    let mut buffer = String::new();\n    io::stdin()\n        .read_to_string(\u0026mut buffer)\n        .map_err(EngramError::Io)?;\n    Ok(buffer.trim().to_string())\n}\n\n/// Helper function to read from file\nfn read_file(path: \u0026str) -\u003e Result\u003cString, EngramError\u003e {\n    fs::read_to_string(path).map_err(EngramError::Io)\n}\n\n/// Create context from JSON input\nfn create_context_from_input\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    input: ContextInput,\n) -\u003e Result\u003c(), EngramError\u003e {\n    // Parse relevance level\n    let relevance = match input.relevance.as_deref().unwrap_or(\"medium\") {\n        \"low\" =\u003e ContextRelevance::Low,\n        \"medium\" =\u003e ContextRelevance::Medium,\n        \"high\" =\u003e ContextRelevance::High,\n        \"critical\" =\u003e ContextRelevance::Critical,\n        _ =\u003e {\n            return Err(EngramError::Validation(\n                \"Invalid relevance level. Use: low, medium, high, critical\".to_string(),\n            ))\n        }\n    };\n\n    let agent = input.agent.unwrap_or_else(|| \"default\".to_string());\n\n    let mut context = Context::new(\n        input.title,\n        input.content.unwrap_or_default(),\n        input.source.unwrap_or_default(),\n        relevance,\n        agent.clone(),\n    );\n\n    context.source_id = input.source_id;\n\n    // Convert to generic entity\n    let generic_entity = context.to_generic();\n\n    // Store\n    storage.store(\u0026generic_entity)?;\n\n    println!(\"Context '{}' created successfully\", context.id);\n    println!(\"ID: {}\", context.id);\n    println!(\"Agent: {}\", agent);\n\n    Ok(())\n}\n\n/// Create a new context with flexible input\npub fn create_context\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    title: Option\u003cString\u003e,\n    content: Option\u003cString\u003e,\n    source: Option\u003cString\u003e,\n    relevance: \u0026str,\n    source_id: Option\u003cString\u003e,\n    agent: Option\u003cString\u003e,\n    _tags: Option\u003cString\u003e,\n    // Flexible input parameters\n    title_stdin: bool,\n    title_file: Option\u003cString\u003e,\n    content_stdin: bool,\n    content_file: Option\u003cString\u003e,\n    json: bool,\n    json_file: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    // Handle JSON input first (overrides all other inputs)\n    if json {\n        let json_content = if let Some(ref file_path) = json_file {\n            read_file(file_path)?\n        } else {\n            read_stdin()?\n        };\n\n        let context_input: ContextInput = serde_json::from_str(\u0026json_content)\n            .map_err(|e| EngramError::Validation(format!(\"Invalid JSON: {}\", e)))?;\n\n        return create_context_from_input(storage, context_input);\n    }\n\n    // Resolve title from various sources\n    let final_title = if title_stdin {\n        read_stdin()?\n    } else if let Some(ref file_path) = title_file {\n        read_file(file_path)?\n    } else if let Some(ref t) = title {\n        t.clone()\n    } else {\n        return Err(EngramError::Validation(\n            \"Title required: use --title, --title-stdin, or --title-file\".to_string(),\n        ));\n    };\n\n    // Resolve content from various sources\n    let final_content = if content_stdin {\n        read_stdin()?\n    } else if let Some(ref file_path) = content_file {\n        read_file(file_path)?\n    } else if let Some(ref c) = content {\n        c.clone()\n    } else {\n        String::new() // Content is optional\n    };\n\n    // Parse relevance level\n    let relevance_level = match relevance {\n        \"low\" =\u003e ContextRelevance::Low,\n        \"medium\" =\u003e ContextRelevance::Medium,\n        \"high\" =\u003e ContextRelevance::High,\n        \"critical\" =\u003e ContextRelevance::Critical,\n        _ =\u003e {\n            return Err(EngramError::Validation(\n                \"Invalid relevance level. Use: low, medium, high, critical\".to_string(),\n            ))\n        }\n    };\n\n    let final_agent = agent.unwrap_or_else(|| \"default\".to_string());\n\n    let mut context = Context::new(\n        final_title,\n        final_content,\n        source.unwrap_or_default(),\n        relevance_level,\n        final_agent.clone(),\n    );\n\n    context.source_id = source_id;\n\n    // Convert to generic entity\n    let generic_entity = context.to_generic();\n\n    // Store\n    storage.store(\u0026generic_entity)?;\n\n    println!(\"Context '{}' created successfully\", context.id);\n    println!(\"ID: {}\", context.id);\n    println!(\"Title: {}\", context.title);\n    println!(\"Agent: {}\", final_agent);\n    println!(\"Relevance: {:?}\", context.relevance);\n\n    Ok(())\n}\n\n/// List contexts\npub fn list_contexts\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent: Option\u003c\u0026str\u003e,\n    relevance: Option\u003c\u0026str\u003e,\n    limit: Option\u003cusize\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    // Query contexts from storage\n    let mut filter = crate::storage::QueryFilter {\n        entity_type: Some(\"context\".to_string()),\n        agent: agent.map(|s| s.to_string()),\n        limit,\n        ..Default::default()\n    };\n\n    // Add relevance filter if specified\n    if let Some(rel) = relevance {\n        filter.field_filters.insert(\n            \"relevance\".to_string(),\n            serde_json::Value::String(rel.to_string()),\n        );\n    }\n\n    let result = storage.query(\u0026filter)?;\n\n    if result.entities.is_empty() {\n        println!(\"No contexts found\");\n        return Ok(());\n    }\n\n    println!(\"Found {} context(s)\", result.entities.len());\n    println!();\n\n    for entity in result.entities {\n        if let Ok(context) = Context::from_generic(entity) {\n            println!(\"ID: {}\", context.id);\n            println!(\"Title: {}\", context.title);\n            println!(\"Agent: {}\", context.agent);\n            println!(\"Relevance: {:?}\", context.relevance);\n            if !context.source.is_empty() {\n                println!(\"Source: {}\", context.source);\n            }\n            if context.content.len() \u003e 100 {\n                println!(\"Content: {}...\", \u0026context.content[..97]);\n            } else {\n                println!(\"Content: {}\", context.content);\n            }\n            println!(\n                \"Created: {}\",\n                context.timestamp().format(\"%Y-%m-%d %H:%M:%S\")\n            );\n            println!(\"---\");\n        }\n    }\n\n    if result.has_more {\n        println!(\"(More results available - use --limit to see more)\");\n    }\n\n    Ok(())\n}\n\n/// Show context details\npub fn show_context\u003cS: Storage\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    let entity = storage.get(id, \"context\")?;\n\n    match entity {\n        Some(generic_entity) =\u003e {\n            let context = Context::from_generic(generic_entity)?;\n\n            println!(\"Context Details:\");\n            println!(\"================\");\n            println!(\"ID: {}\", context.id);\n            println!(\"Title: {}\", context.title);\n            println!(\"Agent: {}\", context.agent);\n            println!(\"Relevance: {:?}\", context.relevance);\n            println!(\n                \"Source: {}\",\n                if context.source.is_empty() {\n                    \"N/A\"\n                } else {\n                    \u0026context.source\n                }\n            );\n            if let Some(ref source_id) = context.source_id {\n                println!(\"Source ID: {}\", source_id);\n            }\n            println!(\n                \"Created: {}\",\n                context.timestamp().format(\"%Y-%m-%d %H:%M:%S UTC\")\n            );\n            println!();\n            println!(\"Content:\");\n            println!(\"--------\");\n            println!(\"{}\", context.content);\n        }\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Context with ID '{}' not found\",\n                id\n            )));\n        }\n    }\n\n    Ok(())\n}\n\n/// Update context\npub fn update_context\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    content: \u0026str,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let entity = storage.get(id, \"context\")?;\n\n    match entity {\n        Some(generic_entity) =\u003e {\n            let mut context = Context::from_generic(generic_entity)?;\n\n            context.content = content.to_string();\n            context.updated_at = chrono::Utc::now();\n\n            let updated_entity = context.to_generic();\n            storage.store(\u0026updated_entity)?;\n\n            println!(\"Context '{}' updated successfully\", context.id);\n            println!(\"Title: {}\", context.title);\n            println!(\n                \"Updated: {}\",\n                context.updated_at.format(\"%Y-%m-%d %H:%M:%S UTC\")\n            );\n        }\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Context with ID '{}' not found\",\n                id\n            )));\n        }\n    }\n\n    Ok(())\n}\n\n/// Delete context\npub fn delete_context\u003cS: Storage\u003e(storage: \u0026mut S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    let entity = storage.get(id, \"context\")?;\n\n    match entity {\n        Some(generic_entity) =\u003e {\n            let context = Context::from_generic(generic_entity)?;\n\n            storage.delete(id, \"context\")?;\n\n            println!(\"Context '{}' deleted successfully\", context.title);\n            println!(\"ID: {}\", context.id);\n        }\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Context with ID '{}' not found\",\n                id\n            )));\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":119,"address":[18627488,18627955,18627949],"length":1,"stats":{"Line":0}},{"line":120,"address":[25968774],"length":1,"stats":{"Line":0}},{"line":121,"address":[18849664,18849593,18849531,18849760],"length":1,"stats":{"Line":0}},{"line":122,"address":[18778833],"length":1,"stats":{"Line":0}},{"line":123,"address":[25508221,25508294],"length":1,"stats":{"Line":0}},{"line":124,"address":[20268287],"length":1,"stats":{"Line":0}},{"line":128,"address":[25508560],"length":1,"stats":{"Line":0}},{"line":129,"address":[20268487],"length":1,"stats":{"Line":0}},{"line":133,"address":[14440463,14438384],"length":1,"stats":{"Line":0}},{"line":138,"address":[14438427,14438607],"length":1,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[14438785,14438709,14438746],"length":1,"stats":{"Line":0}},{"line":141,"address":[14438762,14438799,14438838],"length":1,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[14438901],"length":1,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[14441328,14438991,14441340],"length":1,"stats":{"Line":0}},{"line":153,"address":[14439061],"length":1,"stats":{"Line":0}},{"line":154,"address":[14439205,14439100],"length":1,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[14439506],"length":1,"stats":{"Line":0}},{"line":163,"address":[14439661],"length":1,"stats":{"Line":0}},{"line":166,"address":[14439805,14439737],"length":1,"stats":{"Line":0}},{"line":168,"address":[14439950],"length":1,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[14428240,14434416,14432790],"length":1,"stats":{"Line":0}},{"line":194,"address":[14428514],"length":1,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[14433317,14432988,14433037],"length":1,"stats":{"Line":0}},{"line":198,"address":[14433322,14434042,14433005],"length":1,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[14433648,14434459,14433723,14434432],"length":1,"stats":{"Line":0}},{"line":204,"address":[14433898,14433986],"length":1,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[14432945,14428718,14429338],"length":1,"stats":{"Line":0}},{"line":210,"address":[14428748,14428684],"length":1,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[14429245,14428781,14429179],"length":1,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[14429206],"length":1,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[14429595,14429659],"length":1,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[14430173,14429692,14430123],"length":1,"stats":{"Line":0}},{"line":226,"address":[14430131,14430165],"length":1,"stats":{"Line":0}},{"line":228,"address":[14430175,14430158],"length":1,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[14430541,14430583,14430501],"length":1,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[14430714],"length":1,"stats":{"Line":0}},{"line":239,"address":[14430665],"length":1,"stats":{"Line":0}},{"line":244,"address":[14430819,14434704,14434716],"length":1,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[14430984,14431083],"length":1,"stats":{"Line":0}},{"line":250,"address":[14431091],"length":1,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[14431731],"length":1,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[14432139],"length":1,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[14425599,14428174,14424464],"length":1,"stats":{"Line":0}},{"line":280,"address":[14424630],"length":1,"stats":{"Line":0}},{"line":281,"address":[14428192,14428214,14424715],"length":1,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[14428172,14425351,14425605],"length":1,"stats":{"Line":0}},{"line":296,"address":[14425896,14425840],"length":1,"stats":{"Line":0}},{"line":297,"address":[14428073,14425926],"length":1,"stats":{"Line":0}},{"line":298,"address":[14428097],"length":1,"stats":{"Line":0}},{"line":301,"address":[14425960,14425902],"length":1,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[14426117,14426319],"length":1,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[14426834,14426763],"length":1,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[14427007],"length":1,"stats":{"Line":0}},{"line":309,"address":[14427111],"length":1,"stats":{"Line":0}},{"line":310,"address":[14427215],"length":1,"stats":{"Line":0}},{"line":311,"address":[14427299,14427244],"length":1,"stats":{"Line":0}},{"line":313,"address":[14427279,14427375],"length":1,"stats":{"Line":0}},{"line":314,"address":[14427568,14427416],"length":1,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[14427899],"length":1,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[14426549],"length":1,"stats":{"Line":0}},{"line":334,"address":[14422000,14424401,14424422],"length":1,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[14422295],"length":1,"stats":{"Line":0}},{"line":339,"address":[14422759,14422422,14424407],"length":1,"stats":{"Line":0}},{"line":341,"address":[14422955,14423025],"length":1,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[14423097],"length":1,"stats":{"Line":0}},{"line":344,"address":[14423193],"length":1,"stats":{"Line":0}},{"line":345,"address":[14423297],"length":1,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[14423559],"length":1,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[14423718],"length":1,"stats":{"Line":0}},{"line":356,"address":[14423779,14423833],"length":1,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[14424110],"length":1,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[14424200],"length":1,"stats":{"Line":0}},{"line":365,"address":[14424245],"length":1,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[14422457,14422547],"length":1,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[14424373],"length":1,"stats":{"Line":0}},{"line":379,"address":[14436272,14438228,14438290],"length":1,"stats":{"Line":0}},{"line":384,"address":[14436338],"length":1,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[14437454],"length":1,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[14437847],"length":1,"stats":{"Line":0}},{"line":398,"address":[14437951],"length":1,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[14435014],"length":1,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[14436225,14435513,14435176],"length":1,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[14435937],"length":1,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":169},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","convert.rs"],"content":"use clap::Subcommand;\n\n/// Convert commands\n#[derive(Subcommand)]\npub enum ConvertCommands {\n    /// Convert from external format\n    Convert {\n        /// Source format (openspec, beads, github)\n        #[arg(long, short)]\n        from: String,\n\n        /// Source file path\n        #[arg(long, short)]\n        file: String,\n    },\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","escalation.rs"],"content":"//! Escalation command implementations\n\nuse crate::entities::{\n    Entity, EscalationOperationType, EscalationPriority, EscalationRequest, EscalationStatus,\n    OperationContext, ReviewDecision, ReviewerInfo,\n};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\nuse serde::Deserialize;\nuse std::collections::HashMap;\nuse std::fs;\nuse std::io::{self, Read, Write};\n\n/// Escalation input structure for JSON\n#[derive(Debug, Deserialize)]\npub struct EscalationInput {\n    pub agent_id: String,\n    pub operation_type: String,\n    pub operation: String,\n    pub block_reason: String,\n    pub justification: String,\n    pub priority: Option\u003cString\u003e,\n    pub impact_if_denied: Option\u003cString\u003e,\n    pub suggested_reviewer: Option\u003cString\u003e,\n    pub parameters: Option\u003cHashMap\u003cString, serde_json::Value\u003e\u003e,\n}\n\n/// Review decision input structure\n#[derive(Debug, Deserialize)]\npub struct ReviewInput {\n    pub status: String,\n    pub reason: String,\n    pub conditions: Option\u003cVec\u003cString\u003e\u003e,\n    pub approval_duration: Option\u003cu64\u003e,\n    pub create_policy: Option\u003cbool\u003e,\n    pub notes: Option\u003cString\u003e,\n    pub reviewer_id: String,\n    pub reviewer_name: String,\n    pub reviewer_email: Option\u003cString\u003e,\n}\n\n/// Escalation commands\n#[derive(Subcommand)]\npub enum EscalationCommands {\n    Create {\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        #[arg(long, short)]\n        operation_type: Option\u003cString\u003e,\n\n        #[arg(long)]\n        operation: Option\u003cString\u003e,\n\n        #[arg(long)]\n        block_reason: Option\u003cString\u003e,\n\n        #[arg(long, short)]\n        justification: Option\u003cString\u003e,\n\n        #[arg(long, short, default_value = \"normal\")]\n        priority: String,\n\n        #[arg(long)]\n        impact: Option\u003cString\u003e,\n\n        #[arg(long)]\n        reviewer: Option\u003cString\u003e,\n\n        #[arg(long, conflicts_with_all = [\"agent\"])]\n        stdin: bool,\n\n        #[arg(long, conflicts_with_all = [\"agent\", \"stdin\"])]\n        file: Option\u003cString\u003e,\n\n        #[arg(long)]\n        json: bool,\n    },\n    /// List escalation requests\n    List {\n        /// Filter by agent ID\n        #[arg(long)]\n        agent_id: Option\u003cString\u003e,\n\n        /// Filter by status (pending, approved, denied, expired, cancelled)\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n\n        /// Filter by priority (low, normal, high, critical)\n        #[arg(long)]\n        priority: Option\u003cString\u003e,\n\n        /// Filter by operation type\n        #[arg(long)]\n        operation_type: Option\u003cString\u003e,\n\n        /// Show only expired requests\n        #[arg(long)]\n        expired_only: bool,\n\n        /// Show only actionable (pending and not expired) requests\n        #[arg(long)]\n        actionable_only: bool,\n\n        /// Agent to filter by\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Get escalation request details\n    Get {\n        /// Escalation request ID\n        #[arg()]\n        id: String,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Review an escalation request\n    Review {\n        /// Escalation request ID\n        #[arg()]\n        id: String,\n\n        /// Decision (approved, denied)\n        #[arg(long, short)]\n        status: Option\u003cString\u003e,\n\n        /// Reason for the decision\n        #[arg(long, short)]\n        reason: Option\u003cString\u003e,\n\n        /// Reviewer ID\n        #[arg(long)]\n        reviewer_id: Option\u003cString\u003e,\n\n        /// Reviewer name\n        #[arg(long)]\n        reviewer_name: Option\u003cString\u003e,\n\n        /// Approval duration in seconds\n        #[arg(long)]\n        duration: Option\u003cu64\u003e,\n\n        /// Create policy from this decision\n        #[arg(long)]\n        create_policy: bool,\n\n        /// Additional notes\n        #[arg(long)]\n        notes: Option\u003cString\u003e,\n\n        /// Read review data from stdin as JSON\n        #[arg(long)]\n        stdin: bool,\n\n        /// Read review data from file as JSON\n        #[arg(long, conflicts_with = \"stdin\")]\n        file: Option\u003cString\u003e,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Cancel an escalation request\n    Cancel {\n        /// Escalation request ID\n        #[arg()]\n        id: String,\n\n        /// Reason for cancellation\n        #[arg(long, short)]\n        reason: Option\u003cString\u003e,\n\n        /// Force cancellation without confirmation\n        #[arg(long)]\n        force: bool,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Mark expired escalation requests\n    Cleanup {\n        /// Actually mark requests as expired (dry run by default)\n        #[arg(long)]\n        apply: bool,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Show escalation statistics\n    Stats {\n        /// Agent ID to show stats for\n        #[arg(long, short)]\n        agent_id: Option\u003cString\u003e,\n\n        /// Time period in days to analyze\n        #[arg(long, default_value = \"30\")]\n        days: u64,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n}\n\n/// Create a new escalation request\npub fn create_escalation\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    agent: Option\u003cString\u003e,\n    operation_type: Option\u003cString\u003e,\n    operation: Option\u003cString\u003e,\n    block_reason: Option\u003cString\u003e,\n    justification: Option\u003cString\u003e,\n    priority: String,\n    impact: Option\u003cString\u003e,\n    reviewer: Option\u003cString\u003e,\n    stdin: bool,\n    file: Option\u003cString\u003e,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let escalation_input = if stdin {\n        read_escalation_input_from_stdin()?\n    } else if let Some(file_path) = file {\n        read_escalation_input_from_file(\u0026file_path)?\n    } else {\n        let agent_id = agent\n            .clone()\n            .ok_or_else(|| EngramError::Validation(\"Agent is required\".to_string()))?;\n        let operation_type = operation_type\n            .ok_or_else(|| EngramError::Validation(\"Operation type is required\".to_string()))?;\n        let operation = operation\n            .ok_or_else(|| EngramError::Validation(\"Operation is required\".to_string()))?;\n        let block_reason = block_reason\n            .ok_or_else(|| EngramError::Validation(\"Block reason is required\".to_string()))?;\n        let justification = justification\n            .ok_or_else(|| EngramError::Validation(\"Justification is required\".to_string()))?;\n\n        EscalationInput {\n            agent_id,\n            operation_type,\n            operation,\n            block_reason,\n            justification,\n            priority: Some(priority),\n            impact_if_denied: impact,\n            suggested_reviewer: reviewer,\n            parameters: None,\n        }\n    };\n\n    let operation_type = parse_operation_type(\u0026escalation_input.operation_type)?;\n    let priority = parse_priority(\n        \u0026escalation_input\n            .priority\n            .unwrap_or_else(|| \"normal\".to_string()),\n    )?;\n    let agent = agent.unwrap_or_else(|| \"default\".to_string());\n\n    let operation_context = OperationContext {\n        operation: escalation_input.operation,\n        parameters: escalation_input.parameters.unwrap_or_default(),\n        resource: None,\n        block_reason: escalation_input.block_reason,\n        alternatives: Vec::new(),\n        risk_assessment: None,\n    };\n\n    let mut escalation = EscalationRequest::new(\n        escalation_input.agent_id,\n        operation_type,\n        operation_context,\n        escalation_input.justification,\n        priority,\n        agent,\n    );\n\n    if let Some(impact) = escalation_input.impact_if_denied {\n        escalation.impact_if_denied = Some(impact);\n    }\n\n    if let Some(suggested_reviewer) = escalation_input.suggested_reviewer {\n        escalation.suggested_reviewer = Some(suggested_reviewer);\n    }\n\n    storage.store(\u0026escalation.to_generic())?;\n\n    if json {\n        println!(\n            \"{}\",\n            serde_json::to_string_pretty(\u0026escalation.to_generic())?\n        );\n    } else {\n        println!(\"‚úÖ Escalation request created successfully:\");\n        println!(\"  ID: {}\", escalation.id);\n        println!(\"  Agent: {}\", escalation.agent_id);\n        println!(\"  Operation: {:?}\", escalation.operation_type);\n        println!(\"  Priority: {:?}\", escalation.priority);\n        println!(\"  Status: {:?}\", escalation.status);\n\n        if let Some(time_remaining) = escalation.time_to_expiration() {\n            let hours = time_remaining.num_hours();\n            let minutes = time_remaining.num_minutes() % 60;\n            println!(\"  Expires in: {}h {}m\", hours, minutes);\n        }\n    }\n\n    Ok(())\n}\n\n/// List escalation requests\npub fn list_escalations\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent_id: Option\u003cString\u003e,\n    status: Option\u003cString\u003e,\n    priority: Option\u003cString\u003e,\n    operation_type: Option\u003cString\u003e,\n    expired_only: bool,\n    actionable_only: bool,\n    agent: Option\u003cString\u003e,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let ids = storage.list_ids(\"escalation_request\")?;\n    let mut escalations = Vec::new();\n\n    for id in ids {\n        if let Ok(Some(entity)) = storage.get(\u0026id, \"escalation_request\") {\n            match EscalationRequest::from_generic(entity) {\n                Ok(mut escalation) =\u003e {\n                    // Check for expiration and update if needed\n                    if escalation.is_expired() \u0026\u0026 escalation.status == EscalationStatus::Pending {\n                        escalation.mark_expired();\n                    }\n\n                    // Apply filters\n                    if let Some(filter_agent_id) = \u0026agent_id {\n                        if escalation.agent_id != *filter_agent_id {\n                            continue;\n                        }\n                    }\n\n                    if let Some(filter_agent) = \u0026agent {\n                        if escalation.agent != *filter_agent {\n                            continue;\n                        }\n                    }\n\n                    if let Some(filter_status) = \u0026status {\n                        if format!(\"{:?}\", escalation.status).to_lowercase()\n                            != filter_status.to_lowercase()\n                        {\n                            continue;\n                        }\n                    }\n\n                    if let Some(filter_priority) = \u0026priority {\n                        if format!(\"{:?}\", escalation.priority).to_lowercase()\n                            != filter_priority.to_lowercase()\n                        {\n                            continue;\n                        }\n                    }\n\n                    if let Some(filter_op_type) = \u0026operation_type {\n                        let op_type_str = match escalation.operation_type {\n                            EscalationOperationType::Custom(ref s) =\u003e s.clone(),\n                            _ =\u003e format!(\"{:?}\", escalation.operation_type).to_lowercase(),\n                        };\n                        if op_type_str != filter_op_type.to_lowercase() {\n                            continue;\n                        }\n                    }\n\n                    if expired_only \u0026\u0026 escalation.status != EscalationStatus::Expired {\n                        continue;\n                    }\n\n                    if actionable_only \u0026\u0026 !escalation.is_actionable() {\n                        continue;\n                    }\n\n                    escalations.push(escalation);\n                }\n                Err(_) =\u003e continue,\n            }\n        }\n    }\n\n    if json {\n        let generic_escalations: Vec\u003c_\u003e = escalations.iter().map(|e| e.to_generic()).collect();\n        println!(\"{}\", serde_json::to_string_pretty(\u0026generic_escalations)?);\n    } else {\n        if escalations.is_empty() {\n            println!(\"No escalation requests found.\");\n        } else {\n            println!(\"üö® Escalation Requests ({} found):\", escalations.len());\n            for escalation in escalations {\n                let status_icon = match escalation.status {\n                    EscalationStatus::Pending =\u003e \"‚è≥\",\n                    EscalationStatus::Approved =\u003e \"‚úÖ\",\n                    EscalationStatus::Denied =\u003e \"‚ùå\",\n                    EscalationStatus::Expired =\u003e \"‚è∞\",\n                    EscalationStatus::Cancelled =\u003e \"üö´\",\n                };\n\n                println!(\n                    \"  {} {} [{}] - {} ({:?}, {:?})\",\n                    status_icon,\n                    escalation.id,\n                    escalation.agent_id,\n                    escalation.operation_context.operation,\n                    escalation.operation_type,\n                    escalation.priority\n                );\n\n                if escalation.status == EscalationStatus::Pending {\n                    if let Some(time_remaining) = escalation.time_to_expiration() {\n                        let hours = time_remaining.num_hours();\n                        let minutes = time_remaining.num_minutes() % 60;\n                        if time_remaining.num_seconds() \u003e 0 {\n                            println!(\"    ‚è±Ô∏è  Expires in: {}h {}m\", hours, minutes);\n                        } else {\n                            println!(\"    ‚ö†Ô∏è  Expired\");\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    Ok(())\n}\n\n/// Get escalation request details\npub fn get_escalation\u003cS: Storage\u003e(storage: \u0026S, id: String, json: bool) -\u003e Result\u003c(), EngramError\u003e {\n    match storage.get(\u0026id, \"escalation_request\")? {\n        Some(entity) =\u003e {\n            let mut escalation = EscalationRequest::from_generic(entity)?;\n\n            // Check for expiration and update if needed\n            if escalation.is_expired() \u0026\u0026 escalation.status == EscalationStatus::Pending {\n                escalation.mark_expired();\n            }\n\n            if json {\n                println!(\n                    \"{}\",\n                    serde_json::to_string_pretty(\u0026escalation.to_generic())?\n                );\n            } else {\n                println!(\"üö® Escalation Request Details:\");\n                println!(\"  ID: {}\", escalation.id);\n                println!(\"  Agent: {}\", escalation.agent_id);\n                println!(\"  Operation Type: {:?}\", escalation.operation_type);\n                println!(\"  Status: {:?}\", escalation.status);\n                println!(\"  Priority: {:?}\", escalation.priority);\n                println!(\n                    \"  Created: {}\",\n                    escalation.created_at.format(\"%Y-%m-%d %H:%M:%S UTC\")\n                );\n\n                if escalation.status == EscalationStatus::Pending {\n                    if let Some(time_remaining) = escalation.time_to_expiration() {\n                        let hours = time_remaining.num_hours();\n                        let minutes = time_remaining.num_minutes() % 60;\n                        if time_remaining.num_seconds() \u003e 0 {\n                            println!(\"  Expires in: {}h {}m\", hours, minutes);\n                        } else {\n                            println!(\"  Status: ‚ö†Ô∏è EXPIRED\");\n                        }\n                    }\n                }\n\n                println!(\"\\nüìã Operation Context:\");\n                println!(\"  Operation: {}\", escalation.operation_context.operation);\n                println!(\n                    \"  Block Reason: {}\",\n                    escalation.operation_context.block_reason\n                );\n\n                if !escalation.operation_context.parameters.is_empty() {\n                    println!(\n                        \"  Parameters: {}\",\n                        serde_json::to_string_pretty(\u0026escalation.operation_context.parameters)?\n                    );\n                }\n\n                println!(\"\\nüí¨ Justification:\");\n                println!(\"  {}\", escalation.justification);\n\n                if let Some(impact) = \u0026escalation.impact_if_denied {\n                    println!(\"\\n‚ö†Ô∏è Impact if Denied:\");\n                    println!(\"  {}\", impact);\n                }\n\n                if let Some(reviewer) = \u0026escalation.reviewer {\n                    println!(\"\\nüë§ Assigned Reviewer:\");\n                    println!(\"  Name: {}\", reviewer.reviewer_name);\n                    println!(\"  ID: {}\", reviewer.reviewer_id);\n                    if let Some(email) = \u0026reviewer.reviewer_email {\n                        println!(\"  Email: {}\", email);\n                    }\n                }\n\n                if let Some(decision) = \u0026escalation.decision {\n                    println!(\"\\nüìù Decision:\");\n                    println!(\"  Status: {:?}\", decision.status);\n                    println!(\"  Reason: {}\", decision.reason);\n\n                    if !decision.conditions.is_empty() {\n                        println!(\"  Conditions: {}\", decision.conditions.join(\", \"));\n                    }\n\n                    if let Some(duration) = decision.approval_duration {\n                        println!(\"  Valid for: {} seconds\", duration);\n                    }\n\n                    if let Some(notes) = \u0026decision.notes {\n                        println!(\"  Notes: {}\", notes);\n                    }\n                }\n            }\n        }\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Escalation request with ID {} not found\",\n                id\n            )));\n        }\n    }\n\n    Ok(())\n}\n\n/// Review an escalation request\npub fn review_escalation\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: String,\n    status: Option\u003cString\u003e,\n    reason: Option\u003cString\u003e,\n    reviewer_id: Option\u003cString\u003e,\n    reviewer_name: Option\u003cString\u003e,\n    duration: Option\u003cu64\u003e,\n    create_policy: bool,\n    notes: Option\u003cString\u003e,\n    stdin: bool,\n    file: Option\u003cString\u003e,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut escalation = match storage.get(\u0026id, \"escalation_request\")? {\n        Some(entity) =\u003e EscalationRequest::from_generic(entity)\n            .map_err(|e| EngramError::Validation(e.to_string()))?,\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Escalation request with ID {} not found\",\n                id\n            )));\n        }\n    };\n\n    // Check if request is still actionable\n    if !escalation.is_actionable() {\n        return Err(EngramError::InvalidOperation(format!(\n            \"Escalation request {} is not actionable (status: {:?})\",\n            id, escalation.status\n        )));\n    }\n\n    let review_input = if stdin {\n        read_review_input_from_stdin()?\n    } else if let Some(file_path) = file {\n        read_review_input_from_file(\u0026file_path)?\n    } else {\n        let status = status\n            .ok_or_else(|| EngramError::Validation(\"Decision status is required\".to_string()))?;\n        let reason = reason\n            .ok_or_else(|| EngramError::Validation(\"Decision reason is required\".to_string()))?;\n        let reviewer_id = reviewer_id\n            .ok_or_else(|| EngramError::Validation(\"Reviewer ID is required\".to_string()))?;\n        let reviewer_name = reviewer_name\n            .ok_or_else(|| EngramError::Validation(\"Reviewer name is required\".to_string()))?;\n\n        ReviewInput {\n            status,\n            reason,\n            conditions: None,\n            approval_duration: duration,\n            create_policy: Some(create_policy),\n            notes,\n            reviewer_id,\n            reviewer_name,\n            reviewer_email: None,\n        }\n    };\n\n    let decision_status = parse_escalation_status(\u0026review_input.status)?;\n\n    // Create reviewer info\n    let reviewer_info = ReviewerInfo {\n        reviewer_id: review_input.reviewer_id,\n        reviewer_name: review_input.reviewer_name,\n        reviewer_email: review_input.reviewer_email,\n        department: None,\n    };\n\n    // Create decision\n    let decision = ReviewDecision {\n        status: decision_status.clone(),\n        reason: review_input.reason,\n        conditions: review_input.conditions.unwrap_or_default(),\n        approval_duration: review_input.approval_duration,\n        create_policy: review_input.create_policy.unwrap_or(false),\n        notes: review_input.notes,\n    };\n\n    // Assign reviewer and record decision\n    escalation.assign_reviewer(reviewer_info);\n    escalation.record_decision(decision);\n\n    storage.store(\u0026escalation.to_generic())?;\n\n    if json {\n        println!(\n            \"{}\",\n            serde_json::to_string_pretty(\u0026escalation.to_generic())?\n        );\n    } else {\n        println!(\"‚úÖ Escalation request reviewed successfully:\");\n        println!(\"  ID: {}\", escalation.id);\n        println!(\"  Decision: {:?}\", decision_status);\n        println!(\n            \"  Reviewer: {}\",\n            escalation.reviewer.as_ref().unwrap().reviewer_name\n        );\n\n        if let Some(duration) = escalation.decision.as_ref().unwrap().approval_duration {\n            println!(\"  Valid for: {} seconds\", duration);\n        }\n    }\n\n    Ok(())\n}\n\n/// Cancel an escalation request\npub fn cancel_escalation\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: String,\n    reason: Option\u003cString\u003e,\n    force: bool,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if !force {\n        print!(\n            \"Are you sure you want to cancel escalation request {}? (y/N): \",\n            id\n        );\n        io::stdout().flush().unwrap();\n        let mut input = String::new();\n        io::stdin().read_line(\u0026mut input)?;\n        if !input.trim().to_lowercase().starts_with('y') {\n            println!(\"Operation cancelled.\");\n            return Ok(());\n        }\n    }\n\n    let mut escalation = match storage.get(\u0026id, \"escalation_request\")? {\n        Some(entity) =\u003e EscalationRequest::from_generic(entity)\n            .map_err(|e| EngramError::Validation(e.to_string()))?,\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Escalation request with ID {} not found\",\n                id\n            )));\n        }\n    };\n\n    escalation.cancel(reason);\n    storage.store(\u0026escalation.to_generic())?;\n\n    if json {\n        println!(\n            \"{}\",\n            serde_json::to_string_pretty(\u0026escalation.to_generic())?\n        );\n    } else {\n        println!(\"‚úÖ Escalation request {} cancelled successfully.\", id);\n    }\n\n    Ok(())\n}\n\n/// Cleanup expired escalation requests\npub fn cleanup_escalations\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    apply: bool,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let ids = storage.list_ids(\"escalation_request\")?;\n    let mut expired_requests = Vec::new();\n    let mut updated_count = 0;\n\n    for id in ids {\n        if let Ok(Some(entity)) = storage.get(\u0026id, \"escalation_request\") {\n            if let Ok(mut escalation) = EscalationRequest::from_generic(entity) {\n                if escalation.is_expired() \u0026\u0026 escalation.status == EscalationStatus::Pending {\n                    expired_requests.push(escalation.clone());\n\n                    if apply {\n                        escalation.mark_expired();\n                        storage.store(\u0026escalation.to_generic())?;\n                        updated_count += 1;\n                    }\n                }\n            }\n        }\n    }\n\n    if json {\n        let result = serde_json::json!({\n            \"expired_requests\": expired_requests.len(),\n            \"updated\": if apply { updated_count } else { 0 },\n            \"dry_run\": !apply,\n            \"requests\": expired_requests.iter().map(|e| serde_json::json!({\n                \"id\": e.id,\n                \"agent_id\": e.agent_id,\n                \"operation\": e.operation_context.operation,\n                \"created_at\": e.created_at,\n                \"expired_hours_ago\": (chrono::Utc::now() - e.expires_at).num_hours()\n            })).collect::\u003cVec\u003c_\u003e\u003e()\n        });\n        println!(\"{}\", serde_json::to_string_pretty(\u0026result)?);\n    } else {\n        if expired_requests.is_empty() {\n            println!(\"No expired escalation requests found.\");\n        } else {\n            if apply {\n                println!(\"‚úÖ Marked {} expired escalation requests.\", updated_count);\n            } else {\n                println!(\n                    \"üîç Found {} expired escalation requests (dry run):\",\n                    expired_requests.len()\n                );\n                println!(\"Run with --apply to mark them as expired.\");\n            }\n\n            for request in \u0026expired_requests {\n                let hours_expired = (chrono::Utc::now() - request.expires_at).num_hours();\n                println!(\n                    \"  ‚Ä¢ {} [{}] - {} (expired {}h ago)\",\n                    request.id,\n                    request.agent_id,\n                    request.operation_context.operation,\n                    hours_expired\n                );\n            }\n        }\n    }\n\n    Ok(())\n}\n\n/// Show escalation statistics\npub fn show_escalation_stats\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent_id: Option\u003cString\u003e,\n    days: u64,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let ids = storage.list_ids(\"escalation_request\")?;\n    let cutoff_date = chrono::Utc::now() - chrono::Duration::days(days as i64);\n\n    let mut total_requests = 0;\n    let mut status_counts = HashMap::new();\n    let mut priority_counts = HashMap::new();\n    let mut operation_type_counts = HashMap::new();\n    let mut agent_requests = Vec::new();\n\n    for id in ids {\n        if let Ok(Some(entity)) = storage.get(\u0026id, \"escalation_request\") {\n            if let Ok(escalation) = EscalationRequest::from_generic(entity) {\n                // Skip requests outside the time window\n                if escalation.created_at \u003c cutoff_date {\n                    continue;\n                }\n\n                // Apply agent filter\n                if let Some(filter_agent_id) = \u0026agent_id {\n                    if escalation.agent_id != *filter_agent_id {\n                        continue;\n                    }\n                    agent_requests.push(escalation.clone());\n                } else {\n                    total_requests += 1;\n                    *status_counts\n                        .entry(format!(\"{:?}\", escalation.status))\n                        .or_insert(0) += 1;\n                    *priority_counts\n                        .entry(format!(\"{:?}\", escalation.priority))\n                        .or_insert(0) += 1;\n                    *operation_type_counts\n                        .entry(format!(\"{:?}\", escalation.operation_type))\n                        .or_insert(0) += 1;\n                    agent_requests.push(escalation);\n                }\n            }\n        }\n    }\n\n    if json {\n        let stats = serde_json::json!({\n            \"time_period_days\": days,\n            \"total_requests\": if agent_id.is_some() { agent_requests.len() } else { total_requests },\n            \"status_distribution\": status_counts,\n            \"priority_distribution\": priority_counts,\n            \"operation_type_distribution\": operation_type_counts,\n            \"agent_filter\": agent_id,\n            \"requests\": agent_requests.iter().map(|e| serde_json::json!({\n                \"id\": e.id,\n                \"agent_id\": e.agent_id,\n                \"status\": format!(\"{:?}\", e.status),\n                \"priority\": format!(\"{:?}\", e.priority),\n                \"operation_type\": format!(\"{:?}\", e.operation_type),\n                \"created_at\": e.created_at\n            })).collect::\u003cVec\u003c_\u003e\u003e()\n        });\n        println!(\"{}\", serde_json::to_string_pretty(\u0026stats)?);\n    } else {\n        if let Some(filter_agent_id) = agent_id {\n            println!(\n                \"üö® Escalation Stats for Agent: {} (last {} days)\",\n                filter_agent_id, days\n            );\n            if agent_requests.is_empty() {\n                println!(\"  No escalation requests found for this agent.\");\n            } else {\n                println!(\"  Total requests: {}\", agent_requests.len());\n                for request in agent_requests {\n                    println!(\n                        \"  ‚Ä¢ {} - {:?} ({:?}, {:?})\",\n                        request.operation_context.operation,\n                        request.status,\n                        request.priority,\n                        request.operation_type\n                    );\n                }\n            }\n        } else {\n            println!(\"üö® Escalation Statistics (last {} days):\", days);\n            println!(\"  Total requests: {}\", total_requests);\n\n            println!(\"  Status distribution:\");\n            for (status, count) in status_counts {\n                println!(\"    {}: {}\", status, count);\n            }\n\n            println!(\"  Priority distribution:\");\n            for (priority, count) in priority_counts {\n                println!(\"    {}: {}\", priority, count);\n            }\n\n            println!(\"  Operation type distribution:\");\n            for (op_type, count) in operation_type_counts {\n                println!(\"    {}: {}\", op_type, count);\n            }\n        }\n    }\n\n    Ok(())\n}\n\n// Helper functions\n\nfn read_escalation_input_from_stdin() -\u003e Result\u003cEscalationInput, EngramError\u003e {\n    let mut input = String::new();\n    io::stdin().read_to_string(\u0026mut input)?;\n    Ok(serde_json::from_str(\u0026input)?)\n}\n\nfn read_escalation_input_from_file(file_path: \u0026str) -\u003e Result\u003cEscalationInput, EngramError\u003e {\n    let content = fs::read_to_string(file_path)?;\n    Ok(serde_json::from_str(\u0026content)?)\n}\n\nfn read_review_input_from_stdin() -\u003e Result\u003cReviewInput, EngramError\u003e {\n    let mut input = String::new();\n    io::stdin().read_to_string(\u0026mut input)?;\n    Ok(serde_json::from_str(\u0026input)?)\n}\n\nfn read_review_input_from_file(file_path: \u0026str) -\u003e Result\u003cReviewInput, EngramError\u003e {\n    let content = fs::read_to_string(file_path)?;\n    Ok(serde_json::from_str(\u0026content)?)\n}\n\nfn parse_operation_type(op_type: \u0026str) -\u003e Result\u003cEscalationOperationType, EngramError\u003e {\n    match op_type {\n        \"filesystem\" | \"file_system\" =\u003e Ok(EscalationOperationType::FileSystemAccess),\n        \"network\" =\u003e Ok(EscalationOperationType::NetworkAccess),\n        \"command\" =\u003e Ok(EscalationOperationType::CommandExecution),\n        \"privilege\" =\u003e Ok(EscalationOperationType::PrivilegeEscalation),\n        \"quality_gate\" =\u003e Ok(EscalationOperationType::QualityGateOverride),\n        \"workflow\" =\u003e Ok(EscalationOperationType::WorkflowModification),\n        \"resource_limit\" =\u003e Ok(EscalationOperationType::ResourceLimitIncrease),\n        custom =\u003e Ok(EscalationOperationType::Custom(custom.to_string())),\n    }\n}\n\nfn parse_priority(priority: \u0026str) -\u003e Result\u003cEscalationPriority, EngramError\u003e {\n    match priority.to_lowercase().as_str() {\n        \"low\" =\u003e Ok(EscalationPriority::Low),\n        \"normal\" =\u003e Ok(EscalationPriority::Normal),\n        \"high\" =\u003e Ok(EscalationPriority::High),\n        \"critical\" =\u003e Ok(EscalationPriority::Critical),\n        _ =\u003e Err(EngramError::Validation(format!(\n            \"Invalid priority: {}. Must be one of: low, normal, high, critical\",\n            priority\n        ))),\n    }\n}\n\nfn parse_escalation_status(status: \u0026str) -\u003e Result\u003cEscalationStatus, EngramError\u003e {\n    match status.to_lowercase().as_str() {\n        \"approved\" =\u003e Ok(EscalationStatus::Approved),\n        \"denied\" =\u003e Ok(EscalationStatus::Denied),\n        _ =\u003e Err(EngramError::Validation(format!(\n            \"Invalid decision status: {}. Must be one of: approved, denied\",\n            status\n        ))),\n    }\n}\n","traces":[{"line":215,"address":[14807538,14816639,14806352],"length":1,"stats":{"Line":0}},{"line":229,"address":[14806552,14810228],"length":1,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[14806852,14809872,14806788],"length":1,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[14807567,14807678,14809962],"length":1,"stats":{"Line":0}},{"line":236,"address":[14817022,14817008,14807560,14807630],"length":1,"stats":{"Line":0}},{"line":237,"address":[14807985,14807874,14807776,14809960],"length":1,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[14808181,14808292,14808083,14809936],"length":1,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[14816926,14808747,14816912,14808861],"length":1,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[14814976,14807378,14810284],"length":1,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[14810967],"length":1,"stats":{"Line":0}},{"line":269,"address":[14811007],"length":1,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[14811481],"length":1,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[14811561],"length":1,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[14812193,14812112],"length":1,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[14812591],"length":1,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[14812776],"length":1,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[14813192],"length":1,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[14813291],"length":1,"stats":{"Line":0}},{"line":319,"address":[14798664,14795968,14803029],"length":1,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[14796452],"length":1,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[14800061,14799968],"length":1,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[14800294,14800180,14800246],"length":1,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[14800260,14800365],"length":1,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[14800484,14800407],"length":1,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[14800978,14801054,14800673,14800589,14800864],"length":1,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[14801239,14801783],"length":1,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[14796892],"length":1,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[14798874,14798823],"length":1,"stats":{"Line":0}},{"line":400,"address":[14796965,14796906],"length":1,"stats":{"Line":0}},{"line":401,"address":[14796994,14798670],"length":1,"stats":{"Line":0}},{"line":403,"address":[14797031,14796979],"length":1,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[14797498],"length":1,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[14797614],"length":1,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[14798092],"length":1,"stats":{"Line":0}},{"line":424,"address":[14798156],"length":1,"stats":{"Line":0}},{"line":425,"address":[14798235],"length":1,"stats":{"Line":0}},{"line":426,"address":[14798412,14798274],"length":1,"stats":{"Line":0}},{"line":427,"address":[14798385,14798440],"length":1,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[14795942,14790432,14793626],"length":1,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[14791558],"length":1,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[14791677,14791621],"length":1,"stats":{"Line":0}},{"line":459,"address":[14791696],"length":1,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[14792112],"length":1,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[14792422],"length":1,"stats":{"Line":0}},{"line":470,"address":[14792487],"length":1,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[14792698,14792747],"length":1,"stats":{"Line":0}},{"line":474,"address":[14792854,14792787],"length":1,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[14793198],"length":1,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[14793254,14793656],"length":1,"stats":{"Line":0}},{"line":496,"address":[14793675],"length":1,"stats":{"Line":0}},{"line":498,"address":[14793779],"length":1,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[14794167],"length":1,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[14794443],"length":1,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[14794731],"length":1,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[14794930,14794868],"length":1,"stats":{"Line":0}},{"line":521,"address":[14794897,14795132],"length":1,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[14791028],"length":1,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[14795881],"length":1,"stats":{"Line":0}},{"line":543,"address":[14819783,14826348,14817248],"length":1,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[14825989,14818054,14818521,14818612],"length":1,"stats":{"Line":0}},{"line":559,"address":[14826464,14826482,14818564,14818498],"length":1,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[14818220],"length":1,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[14818883,14821880],"length":1,"stats":{"Line":0}},{"line":577,"address":[14819186,14821660,14825984],"length":1,"stats":{"Line":0}},{"line":578,"address":[14819216,14821570,14819152],"length":1,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[14819900,14821639,14819789,14819280],"length":1,"stats":{"Line":0}},{"line":582,"address":[14826382,14819327,14819852,14826368],"length":1,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[14825239,14821939,14819683],"length":1,"stats":{"Line":0}},{"line":607,"address":[14822115],"length":1,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[14822195],"length":1,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[14822449],"length":1,"stats":{"Line":0}},{"line":617,"address":[14822489],"length":1,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[14822710],"length":1,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":627,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[14824150,14823494,14824201],"length":1,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[14823655],"length":1,"stats":{"Line":0}},{"line":638,"address":[14823751],"length":1,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[14823908],"length":1,"stats":{"Line":0}},{"line":644,"address":[14824063,14823983],"length":1,"stats":{"Line":0}},{"line":648,"address":[14824018],"length":1,"stats":{"Line":0}},{"line":652,"address":[14804094,14803120,14806185],"length":1,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[14803424],"length":1,"stats":{"Line":0}},{"line":665,"address":[14803516],"length":1,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[14803773],"length":1,"stats":{"Line":0}},{"line":668,"address":[14803993],"length":1,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":675,"address":[14806208,14806226,14804793,14804859],"length":1,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":677,"address":[14804559],"length":1,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":689,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[14826896,14830496,14832056],"length":1,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[14827235],"length":1,"stats":{"Line":0}},{"line":707,"address":[14827295],"length":1,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":711,"address":[14831170,14830979,14831072],"length":1,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[14831320],"length":1,"stats":{"Line":0}},{"line":715,"address":[14831680,14831361],"length":1,"stats":{"Line":0}},{"line":716,"address":[],"length":0,"stats":{"Line":0}},{"line":717,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[14831651,14831685],"length":1,"stats":{"Line":0}},{"line":725,"address":[],"length":0,"stats":{"Line":0}},{"line":726,"address":[],"length":0,"stats":{"Line":0}},{"line":727,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":0}},{"line":729,"address":[],"length":0,"stats":{"Line":0}},{"line":730,"address":[],"length":0,"stats":{"Line":0}},{"line":731,"address":[],"length":0,"stats":{"Line":0}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":733,"address":[],"length":0,"stats":{"Line":0}},{"line":734,"address":[],"length":0,"stats":{"Line":0}},{"line":735,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[14829721,14833530],"length":1,"stats":{"Line":0}},{"line":738,"address":[14830110,14830039],"length":1,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[14827813,14828041],"length":1,"stats":{"Line":0}},{"line":746,"address":[],"length":0,"stats":{"Line":0}},{"line":747,"address":[],"length":0,"stats":{"Line":0}},{"line":748,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":754,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[14828416],"length":1,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":0}},{"line":759,"address":[],"length":0,"stats":{"Line":0}},{"line":760,"address":[],"length":0,"stats":{"Line":0}},{"line":766,"address":[14828256],"length":1,"stats":{"Line":0}},{"line":770,"address":[14836154,14843061,14833680],"length":1,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":780,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[14834435],"length":1,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":785,"address":[14834561,14834812,14834677],"length":1,"stats":{"Line":0}},{"line":786,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[14842613,14841386,14841293,14841451],"length":1,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":790,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[14841579,14841643],"length":1,"stats":{"Line":0}},{"line":795,"address":[14841709,14841651],"length":1,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":798,"address":[14841731],"length":1,"stats":{"Line":0}},{"line":800,"address":[14841674,14841791,14841834],"length":1,"stats":{"Line":0}},{"line":801,"address":[14842071,14842012],"length":1,"stats":{"Line":0}},{"line":802,"address":[14841799,14841854],"length":1,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[],"length":0,"stats":{"Line":0}},{"line":805,"address":[14842036,14842092],"length":1,"stats":{"Line":0}},{"line":806,"address":[14842233],"length":1,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":808,"address":[],"length":0,"stats":{"Line":0}},{"line":809,"address":[14842471],"length":1,"stats":{"Line":0}},{"line":810,"address":[14842512,14842600],"length":1,"stats":{"Line":0}},{"line":816,"address":[14834941],"length":1,"stats":{"Line":0}},{"line":817,"address":[14840791,14838355,14839681,14838495,14838020,14834997,14839554,14838450],"length":1,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":819,"address":[14838337,14838403,14838485],"length":1,"stats":{"Line":0}},{"line":820,"address":[],"length":0,"stats":{"Line":0}},{"line":821,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":823,"address":[],"length":0,"stats":{"Line":0}},{"line":824,"address":[14843310,14844379,14843747,14839608,14845346,14844840,14845122,14839525,14843104,14843918,14844208,14844352,14844669,14844813,14843141,14843517,14843891],"length":1,"stats":{"Line":0}},{"line":825,"address":[],"length":0,"stats":{"Line":0}},{"line":826,"address":[],"length":0,"stats":{"Line":0}},{"line":827,"address":[14843713,14843791],"length":1,"stats":{"Line":0}},{"line":828,"address":[14844252,14844174],"length":1,"stats":{"Line":0}},{"line":829,"address":[14844713,14844635],"length":1,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":831,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[14840063,14839992],"length":1,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":836,"address":[],"length":0,"stats":{"Line":0}},{"line":837,"address":[],"length":0,"stats":{"Line":0}},{"line":838,"address":[],"length":0,"stats":{"Line":0}},{"line":840,"address":[14835299],"length":1,"stats":{"Line":0}},{"line":841,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[14835386,14835334],"length":1,"stats":{"Line":0}},{"line":844,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[14835758,14835934],"length":1,"stats":{"Line":0}},{"line":846,"address":[],"length":0,"stats":{"Line":0}},{"line":847,"address":[],"length":0,"stats":{"Line":0}},{"line":848,"address":[],"length":0,"stats":{"Line":0}},{"line":849,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[14836218,14835105],"length":1,"stats":{"Line":0}},{"line":856,"address":[14836295],"length":1,"stats":{"Line":0}},{"line":858,"address":[14836391],"length":1,"stats":{"Line":0}},{"line":859,"address":[],"length":0,"stats":{"Line":0}},{"line":860,"address":[14837886,14836695],"length":1,"stats":{"Line":0}},{"line":863,"address":[],"length":0,"stats":{"Line":0}},{"line":864,"address":[14836969,14836801],"length":1,"stats":{"Line":0}},{"line":865,"address":[14837708,14837060],"length":1,"stats":{"Line":0}},{"line":868,"address":[14837121],"length":1,"stats":{"Line":0}},{"line":869,"address":[14837166,14837334],"length":1,"stats":{"Line":0}},{"line":870,"address":[14837530,14837425],"length":1,"stats":{"Line":0}},{"line":875,"address":[],"length":0,"stats":{"Line":0}},{"line":880,"address":[21150987,21150981,21150464],"length":1,"stats":{"Line":0}},{"line":881,"address":[21162006],"length":1,"stats":{"Line":0}},{"line":882,"address":[21150491,21150553],"length":1,"stats":{"Line":0}},{"line":883,"address":[27820804],"length":1,"stats":{"Line":0}},{"line":886,"address":[17658368,17658374,17657888],"length":1,"stats":{"Line":0}},{"line":887,"address":[21090737],"length":1,"stats":{"Line":0}},{"line":888,"address":[22035045,22035111],"length":1,"stats":{"Line":0}},{"line":891,"address":[22600976,22601484,22601490],"length":1,"stats":{"Line":0}},{"line":892,"address":[17657382],"length":1,"stats":{"Line":0}},{"line":893,"address":[21161017,21160955],"length":1,"stats":{"Line":0}},{"line":894,"address":[22601220],"length":1,"stats":{"Line":0}},{"line":897,"address":[27818992,27819476,27819482],"length":1,"stats":{"Line":0}},{"line":898,"address":[22033841],"length":1,"stats":{"Line":0}},{"line":899,"address":[27819173,27819239],"length":1,"stats":{"Line":0}},{"line":902,"address":[27817568],"length":1,"stats":{"Line":0}},{"line":904,"address":[21088281],"length":1,"stats":{"Line":0}},{"line":905,"address":[21159228,21159170],"length":1,"stats":{"Line":0}},{"line":906,"address":[17655648,17655767],"length":1,"stats":{"Line":0}},{"line":907,"address":[21159410,21159291],"length":1,"stats":{"Line":0}},{"line":908,"address":[20937485,20937366],"length":1,"stats":{"Line":0}},{"line":909,"address":[28278856,28278721],"length":1,"stats":{"Line":0}},{"line":910,"address":[27818376,27818152],"length":1,"stats":{"Line":0}},{"line":911,"address":[28278931],"length":1,"stats":{"Line":0}},{"line":915,"address":[27816912,27817536,27817542],"length":1,"stats":{"Line":0}},{"line":916,"address":[22031755,22031857],"length":1,"stats":{"Line":0}},{"line":917,"address":[22031944,22031873],"length":1,"stats":{"Line":0}},{"line":918,"address":[22598664,22598572,22598620],"length":1,"stats":{"Line":0}},{"line":919,"address":[21147068,21147160,21147116],"length":1,"stats":{"Line":0}},{"line":920,"address":[21087884,21087975,21087932],"length":1,"stats":{"Line":0}},{"line":921,"address":[21158711,21158759],"length":1,"stats":{"Line":0}},{"line":928,"address":[28279136,28279632,28279638],"length":1,"stats":{"Line":0}},{"line":929,"address":[28279265,28279163],"length":1,"stats":{"Line":0}},{"line":930,"address":[27818609,27818680],"length":1,"stats":{"Line":0}},{"line":931,"address":[22033468,22033516,22033559],"length":1,"stats":{"Line":0}},{"line":932,"address":[20938119,20938167],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":402},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","git","mod.rs"],"content":"//! Git command implementations\n\nuse crate::error::EngramError;\nuse clap::Subcommand;\nuse std::process::Command;\n\n/// Git commands\n#[derive(Subcommand)]\npub enum GitCommands {\n    /// Run git command without --no-verify\n    #[command(external_subcommand)]\n    External(Vec\u003cString\u003e),\n}\n\n/// Handle Git commands\npub fn handle_git_command(args: Vec\u003cString\u003e) -\u003e Result\u003c(), EngramError\u003e {\n    if args.is_empty() {\n        return Err(EngramError::Validation(\n            \"No git command provided\".to_string(),\n        ));\n    }\n\n    // Check for banned flags\n    for arg in \u0026args {\n        if arg == \"--no-verify\" || arg == \"-n\" {\n            // Note: -n is short for --no-verify in some contexts, though git commit uses it for --no-verify?\n            // git commit -n is indeed --no-verify.\n            // Let's be strict about --no-verify.\n            return Err(EngramError::Validation(\n                \"‚ùå Using --no-verify is not allowed via engram git.\\n\\n\\\n                 Bypassing hooks prevents Engram from validating your task references and relationships.\\n\\n\\\n                 üí° If your commit is being rejected:\\n\\\n                 1. Read the error message carefully - it explains exactly what is missing.\\n\\\n                 2. Run 'engram validate commit --message \\\"your message\\\" --dry-run' to debug.\\n\\\n                 3. Ensure you have a valid task ID in your message.\\n\\\n                 4. Ensure the task has linked 'context' and 'reasoning' entities.\"\n                    .to_string(),\n            ));\n        }\n    }\n\n    // Check if it is a commit command and ensure we aren't bypassing hooks implicitly if that were possible (it's mostly --no-verify)\n\n    // Construct and execute the git command\n    let status = Command::new(\"git\")\n        .args(\u0026args)\n        .status()\n        .map_err(|e| EngramError::Io(e))?;\n\n    if !status.success() {\n        return Err(EngramError::Git(format!(\n            \"Git command failed with status: {}\",\n            status\n        )));\n    }\n\n    // specific post-command logic\n    if let Some(subcmd) = args.first() {\n        if subcmd == \"add\" || subcmd == \"commit\" {\n            // Check status to remind user of remaining changes\n            let status_output = Command::new(\"git\")\n                .args(\u0026[\"status\", \"-s\"])\n                .output()\n                .map_err(EngramError::Io)?;\n\n            if !status_output.stdout.is_empty() {\n                println!(\"\\nüì¶ Remaining unstaged/untracked files:\");\n                let output_str = String::from_utf8_lossy(\u0026status_output.stdout);\n                for line in output_str.lines() {\n                    println!(\"  {}\", line);\n                }\n                println!(\n                    \"\\nüí° Tip: Don't forget to commit all changes before ending your session.\"\n                );\n            }\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":16,"address":[19013286,19012951,19010672],"length":1,"stats":{"Line":0}},{"line":17,"address":[17592234,17592303],"length":1,"stats":{"Line":0}},{"line":18,"address":[18602987],"length":1,"stats":{"Line":0}},{"line":19,"address":[17592344],"length":1,"stats":{"Line":0}},{"line":24,"address":[17521549,17521626],"length":1,"stats":{"Line":0}},{"line":25,"address":[17580980,17583024,17583095],"length":1,"stats":{"Line":0}},{"line":29,"address":[17523864],"length":1,"stats":{"Line":0}},{"line":37,"address":[17379700],"length":1,"stats":{"Line":0}},{"line":45,"address":[24251270,24251381,24251112],"length":1,"stats":{"Line":0}},{"line":46,"address":[18873855],"length":1,"stats":{"Line":0}},{"line":48,"address":[18602779,18601143,18600983,18601049,18600899],"length":1,"stats":{"Line":0}},{"line":50,"address":[17378002],"length":1,"stats":{"Line":0}},{"line":51,"address":[17581450,17581391],"length":1,"stats":{"Line":0}},{"line":58,"address":[19011426,19011665],"length":1,"stats":{"Line":0}},{"line":59,"address":[17378449,17378520,17378381],"length":1,"stats":{"Line":0}},{"line":61,"address":[17593365,17593652,17593532],"length":1,"stats":{"Line":0}},{"line":62,"address":[24251982],"length":1,"stats":{"Line":0}},{"line":64,"address":[18602741,18601801,18602077,18601717,18601876],"length":1,"stats":{"Line":0}},{"line":66,"address":[17582352],"length":1,"stats":{"Line":0}},{"line":67,"address":[17523185,17523137],"length":1,"stats":{"Line":0}},{"line":68,"address":[17379092],"length":1,"stats":{"Line":0}},{"line":69,"address":[19012510,19012601],"length":1,"stats":{"Line":0}},{"line":70,"address":[24713645,24713551],"length":1,"stats":{"Line":0}},{"line":72,"address":[17523562],"length":1,"stats":{"Line":0}},{"line":79,"address":[17378427],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":25},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","help.rs"],"content":"use clap::Subcommand;\n\n/// Help and onboarding commands\n#[derive(Subcommand)]\npub enum HelpCommands {\n    /// Show onboarding information\n    Onboarding,\n    /// Get started guide\n    GettingStarted,\n    /// Show examples\n    Examples,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","import.rs"],"content":"//! Import command for batch entity creation from structured markdown files\n//!\n//! This module provides the `engram import` command which parses Engram Markdown\n//! (EMD) files and auto-creates entities with relationships based on pattern matching.\n\nuse crate::entities::{Context, Entity, Reasoning, Task};\nuse crate::error::EngramError;\nuse crate::storage::{RelationshipStorage, Storage};\nuse clap::Subcommand;\nuse serde::{Deserialize, Serialize};\nuse std::fs;\nuse std::path::PathBuf;\nuse uuid::Uuid;\n\n/// Import commands\n#[derive(Debug, Subcommand)]\npub enum ImportCommands {\n    /// Import entities from an Engram Markdown (EMD) file\n    Import {\n        /// Path to the markdown file to import\n        #[arg(long, short = 'f')]\n        file: PathBuf,\n\n        /// Verbose output showing progress\n        #[arg(long, short = 'v')]\n        verbose: bool,\n\n        /// Preview changes without creating entities\n        #[arg(long)]\n        dry_run: bool,\n\n        /// Overwrite existing entities\n        #[arg(long)]\n        force: bool,\n\n        /// Output results as JSON\n        #[arg(long, short = 'j')]\n        json: bool,\n    },\n}\n\n/// Document types supported by import\n#[derive(Debug, Clone, Serialize, Deserialize, Default)]\npub enum DocType {\n    #[serde(rename = \"review\")]\n    #[default]\n    Review,\n    #[serde(rename = \"context\")]\n    Context,\n    #[serde(rename = \"task\")]\n    Task,\n    #[serde(rename = \"reasoning\")]\n    Reasoning,\n    #[serde(rename = \"findings\")]\n    Findings,\n    #[serde(rename = \"general\")]\n    General,\n}\n\n/// Frontmatter structure for Engram Markdown files\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Frontmatter {\n    pub title: String,\n    #[serde(default)]\n    pub doc_type: DocType,\n    pub date: Option\u003cString\u003e,\n    pub author: Option\u003cString\u003e,\n    #[serde(default)]\n    pub tags: Vec\u003cString\u003e,\n    pub parent_id: Option\u003cString\u003e,\n}\n\n/// Represents a finding section in the markdown\n#[derive(Debug, Clone)]\npub struct Finding {\n    pub title: String,\n    pub content: String,\n    pub uuid: Option\u003cUuid\u003e,\n}\n\n/// Represents a task reference in the markdown\n#[derive(Debug, Clone)]\npub struct TaskRef {\n    pub priority: String,\n    pub uuid: Uuid,\n    pub description: String,\n}\n\n/// Represents a reasoning section in the markdown\n#[derive(Debug, Clone)]\npub struct ReasoningSection {\n    pub title: String,\n    pub content: String,\n    pub task_id: Option\u003cUuid\u003e,\n    pub uuid: Option\u003cUuid\u003e,\n}\n\n/// Result of an import operation\n#[derive(Debug, Clone)]\npub struct ImportResult {\n    pub entities_created: usize,\n    pub relationships_created: usize,\n    pub warnings: Vec\u003cString\u003e,\n    pub errors: Vec\u003cString\u003e,\n    pub entity_ids: Vec\u003cString\u003e,\n}\n\n/// Import errors\n#[derive(Debug, thiserror::Error)]\npub enum ImportError {\n    #[error(\"File not found: {0}\")]\n    FileNotFound(String),\n    #[error(\"Invalid frontmatter: {0}\")]\n    InvalidFrontmatter(String),\n    #[error(\"Missing frontmatter\")]\n    MissingFrontmatter,\n    #[error(\"Parse error: {0}\")]\n    ParseError(String),\n    #[error(\"Invalid UUID: {0}\")]\n    InvalidUuid(String),\n    #[error(\"Entity not found: {0}\")]\n    EntityNotFound(Uuid),\n    #[error(\"Storage error: {0}\")]\n    StorageError(String),\n}\n\n/// Handle import command\npub fn handle_import_command\u003cS: Storage + RelationshipStorage\u003e(\n    command: ImportCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        ImportCommands::Import {\n            file,\n            verbose,\n            dry_run,\n            force: _,\n            json,\n        } =\u003e {\n            let result = import_file(\u0026file, verbose, dry_run, storage)?;\n\n            if json {\n                let json_output = serde_json::json!({\n                    \"success\": result.errors.is_empty(),\n                    \"entities_created\": result.entities_created,\n                    \"relationships_created\": result.relationships_created,\n                    \"warnings\": result.warnings,\n                    \"errors\": result.errors,\n                    \"entity_ids\": result.entity_ids,\n                });\n                println!(\"{}\", serde_json::to_string_pretty(\u0026json_output)?);\n            } else {\n                println!(\n                    \"Import complete: {} entities, {} relationships\",\n                    result.entities_created, result.relationships_created\n                );\n\n                if !result.warnings.is_empty() \u0026\u0026 verbose {\n                    println!(\"\\nWarnings:\");\n                    for warning in \u0026result.warnings {\n                        println!(\"  - {}\", warning);\n                    }\n                }\n\n                if !result.errors.is_empty() {\n                    println!(\"\\nErrors:\");\n                    for error in \u0026result.errors {\n                        println!(\"  - {}\", error);\n                    }\n                    return Err(EngramError::Validation(\n                        \"Import completed with errors\".to_string(),\n                    ));\n                }\n            }\n\n            Ok(())\n        }\n    }\n}\n\n/// Main import function\nfn import_file\u003cS: Storage + RelationshipStorage\u003e(\n    file: \u0026PathBuf,\n    verbose: bool,\n    dry_run: bool,\n    storage: \u0026mut S,\n) -\u003e Result\u003cImportResult, EngramError\u003e {\n    let mut result = ImportResult {\n        entities_created: 0,\n        relationships_created: 0,\n        warnings: Vec::new(),\n        errors: Vec::new(),\n        entity_ids: Vec::new(),\n    };\n\n    // Read file\n    if verbose {\n        println!(\"Reading file: {:?}\", file);\n    }\n\n    let content = fs::read_to_string(file).map_err(|e| EngramError::Io(e))?;\n\n    // Parse frontmatter\n    if verbose {\n        println!(\"Parsing frontmatter...\");\n    }\n\n    let frontmatter =\n        parse_frontmatter(\u0026content).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n    if verbose {\n        println!(\"  Title: {}\", frontmatter.title);\n        println!(\"  Type: {:?}\", frontmatter.doc_type);\n        if !frontmatter.tags.is_empty() {\n            println!(\"  Tags: {:?}\", frontmatter.tags);\n        }\n    }\n\n    // Extract sections\n    let sections = extract_markdown_sections(\u0026content);\n\n    if verbose {\n        println!(\"Found {} sections\", sections.len());\n    }\n\n    // Extract findings\n    let findings = extract_findings(\u0026sections);\n    if verbose {\n        println!(\"Found {} findings\", findings.len());\n    }\n\n    // Extract task references\n    let tasks = extract_task_references(\u0026content);\n    if verbose {\n        println!(\"Found {} task references\", tasks.len());\n    }\n\n    // Extract reasoning sections\n    let reasoning_sections = extract_reasoning_sections(\u0026sections);\n    if verbose {\n        println!(\"Found {} reasoning sections\", reasoning_sections.len());\n    }\n\n    // Extract UUID patterns for auto-linking\n    let uuid_patterns = extract_uuid_patterns(\u0026content);\n    if verbose {\n        println!(\"Found {} UUID patterns for linking\", uuid_patterns.len());\n    }\n\n    // For dry run, just show what would be created\n    if dry_run {\n        println!(\"\\n[DRY RUN] Would create:\");\n        println!(\"  - {} findings\", findings.len());\n        println!(\"  - {} task references\", tasks.len());\n        println!(\"  - {} reasoning sections\", reasoning_sections.len());\n        println!(\"  - {} relationship patterns\", uuid_patterns.len());\n\n        for finding in \u0026findings {\n            println!(\"    - Finding: {}\", finding.title);\n        }\n\n        return Ok(result);\n    }\n\n    // Create entities (storage operations would go here)\n    // For now, just count what we would create\n    result.entities_created = findings.len() + reasoning_sections.len();\n    result.relationships_created = uuid_patterns.len();\n\n    // Collect entity IDs\n    for finding in \u0026findings {\n        if let Some(uuid) = finding.uuid {\n            result.entity_ids.push(uuid.to_string());\n        }\n    }\n\n    if matches!(frontmatter.doc_type, DocType::Task) {\n        let entity_id = Uuid::new_v4();\n\n        let task = Task::new(\n            frontmatter.title.clone(),\n            \"Imported from markdown\".to_string(),\n            frontmatter\n                .author\n                .clone()\n                .unwrap_or_else(|| \"import\".to_string()),\n            crate::entities::TaskPriority::Medium,\n            None,\n        );\n\n        let generic = task.to_generic();\n        storage.store(\u0026generic)?;\n\n        result.entities_created += 1;\n        result.entity_ids.push(entity_id.to_string());\n\n        if verbose {\n            println!(\"  Created task: {}\", frontmatter.title);\n        }\n    }\n\n    for finding in \u0026findings {\n        let entity_id = finding.uuid.unwrap_or_else(Uuid::new_v4);\n\n        let context = Context::new(\n            finding.title.clone(),\n            finding.content.clone(),\n            frontmatter\n                .author\n                .clone()\n                .unwrap_or_else(|| \"import\".to_string()),\n            crate::entities::ContextRelevance::Medium,\n            \"import\".to_string(),\n        );\n\n        let generic = context.to_generic();\n        storage.store(\u0026generic)?;\n\n        result.entities_created += 1;\n        result.entity_ids.push(entity_id.to_string());\n\n        if verbose {\n            println!(\"  Created context: {}\", finding.title);\n        }\n    }\n\n    for reasoning in \u0026reasoning_sections {\n        let entity_id = reasoning.uuid.unwrap_or_else(Uuid::new_v4);\n\n        let mut reasoning_entity = Reasoning::new(\n            reasoning.title.clone(),\n            reasoning\n                .task_id\n                .map(|t| t.to_string())\n                .unwrap_or_else(|| \"default\".to_string()),\n            \"import\".to_string(),\n        );\n\n        if !reasoning.content.is_empty() {\n            reasoning_entity.add_step(reasoning.content.clone(), reasoning.title.clone(), 0.5);\n        }\n\n        let generic = reasoning_entity.to_generic();\n        storage.store(\u0026generic)?;\n\n        result.entities_created += 1;\n        result.entity_ids.push(entity_id.to_string());\n\n        if verbose {\n            println!(\"  Created reasoning: {}\", reasoning.title);\n        }\n    }\n\n    Ok(result)\n}\n\n/// Parse YAML frontmatter from markdown content\nfn parse_frontmatter(content: \u0026str) -\u003e Result\u003cFrontmatter, ImportError\u003e {\n    // Check for frontmatter markers\n    if !content.starts_with(\"---\") {\n        // No frontmatter - extract title from first line\n        let first_line = content\n            .lines()\n            .next()\n            .unwrap_or(\"\")\n            .trim_start_matches('#')\n            .trim();\n\n        return Ok(Frontmatter {\n            title: first_line.to_string(),\n            doc_type: DocType::General,\n            date: None,\n            author: None,\n            tags: Vec::new(),\n            parent_id: None,\n        });\n    }\n\n    // Find the closing frontmatter marker\n    let start = 3; // Skip opening ---\n    let end = match content[3..].find(\"---\") {\n        Some(pos) =\u003e pos + 3,\n        None =\u003e {\n            return Err(ImportError::InvalidFrontmatter(\n                \"Missing closing ---\".to_string(),\n            ))\n        }\n    };\n\n    let frontmatter_str = \u0026content[start..end].trim();\n\n    // Parse YAML\n    let frontmatter: Frontmatter = serde_yaml::from_str(frontmatter_str)\n        .map_err(|e| ImportError::InvalidFrontmatter(e.to_string()))?;\n\n    // Validate required fields\n    if frontmatter.title.is_empty() {\n        return Err(ImportError::InvalidFrontmatter(\n            \"title is required\".to_string(),\n        ));\n    }\n\n    Ok(frontmatter)\n}\n\n/// Extract markdown sections (## headers and their content)\nfn extract_markdown_sections(content: \u0026str) -\u003e Vec\u003c(String, String)\u003e {\n    let mut sections = Vec::new();\n\n    // Split content after frontmatter\n    let content_after_frontmatter = if content.starts_with(\"---\") {\n        if let Some(pos) = content[3..].find(\"---\") {\n            \u0026content[pos + 6..]\n        } else {\n            content\n        }\n    } else {\n        content\n    };\n\n    // Simple regex-like parsing for ## headers\n    let re = regex::Regex::new(r\"^(#{1,6})\\s+(.+)$\").unwrap();\n    let lines: Vec\u003c\u0026str\u003e = content_after_frontmatter.lines().collect();\n\n    let mut current_section = None;\n    let mut current_content = Vec::new();\n\n    for line in lines {\n        if let Some(caps) = re.captures(line) {\n            // Save previous section\n            if let Some(title) = current_section {\n                sections.push((title, current_content.join(\"\\n\")));\n            }\n\n            // Start new section\n            current_section = Some(caps[2].to_string());\n            current_content = Vec::new();\n        } else if current_section.is_some() {\n            current_content.push(line);\n        }\n    }\n\n    // Save last section\n    if let Some(title) = current_section {\n        sections.push((title, current_content.join(\"\\n\")));\n    }\n\n    sections\n}\n\n/// Extract findings from sections\nfn extract_findings(sections: \u0026[(String, String)]) -\u003e Vec\u003cFinding\u003e {\n    let mut findings = Vec::new();\n\n    for (title, content) in sections {\n        if title.starts_with(\"Finding:\") || title.starts_with(\"## Findings\") {\n            // Extract UUID from pattern like [Finding: UUID]\n            let uuid = extract_uuid_from_pattern(content);\n\n            findings.push(Finding {\n                title: title.trim_start_matches(\"Finding:\").trim().to_string(),\n                content: content.clone(),\n                uuid,\n            });\n        }\n    }\n\n    findings\n}\n\n/// Extract task references from content\nfn extract_task_references(content: \u0026str) -\u003e Vec\u003cTaskRef\u003e {\n    let mut tasks = Vec::new();\n\n    // Pattern: [P0: UUID] or [Task: UUID] description\n    let re = regex::Regex::new(r\"\\[(P[0-3]):\\s*([a-f0-9-]{36})\\]\").unwrap();\n\n    for cap in re.captures_iter(content) {\n        let priority = cap[1].to_string();\n        let uuid_str = cap[2].to_string();\n\n        if let Ok(uuid) = Uuid::parse_str(\u0026uuid_str) {\n            // Try to extract description (text after the pattern)\n            let full_match = cap.get(0).unwrap().as_str();\n            let after_match = content[content.find(full_match).unwrap() + full_match.len()..]\n                .trim()\n                .lines()\n                .next()\n                .unwrap_or(\"\")\n                .trim()\n                .trim_start_matches('-')\n                .trim()\n                .to_string();\n\n            tasks.push(TaskRef {\n                priority,\n                uuid,\n                description: after_match,\n            });\n        }\n    }\n\n    tasks\n}\n\n/// Extract reasoning sections from markdown\nfn extract_reasoning_sections(sections: \u0026[(String, String)]) -\u003e Vec\u003cReasoningSection\u003e {\n    let mut reasoning = Vec::new();\n\n    // Pattern to find [Reasoning: UUID] in any section\n    let reasoning_pattern = regex::Regex::new(r\"\\[Reasoning:\\s*([a-f0-9-]{36})\\]\").unwrap();\n\n    for (title, content) in sections {\n        // Check if section title indicates reasoning\n        let is_reasoning_section = title.starts_with(\"Reasoning:\")\n            || title.starts_with(\"## Reasoning\")\n            || title.starts_with(\"### Analysis:\")\n            || title.starts_with(\"### Design:\");\n\n        // Also check if content contains reasoning pattern\n        let has_reasoning_pattern = reasoning_pattern.is_match(content);\n\n        if is_reasoning_section || has_reasoning_pattern {\n            let uuid = extract_uuid_from_pattern(content);\n            let task_id = extract_task_id_from_content(content);\n\n            reasoning.push(ReasoningSection {\n                title: if title.starts_with(\"##\") || title.starts_with(\"###\") {\n                    title.clone()\n                } else {\n                    format!(\"Reasoning: {}\", title)\n                },\n                content: content.clone(),\n                task_id,\n                uuid,\n            });\n        }\n    }\n\n    reasoning\n}\n\n/// Extract UUID patterns for auto-linking\nfn extract_uuid_patterns(content: \u0026str) -\u003e Vec\u003c(Uuid, String)\u003e {\n    let mut patterns = Vec::new();\n\n    // Pattern: [UUID] or [type: UUID]\n    let re = regex::RegexBuilder::new(\n        r\"\\[([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})\\]\",\n    )\n    .case_insensitive(true)\n    .build()\n    .unwrap();\n\n    for cap in re.captures_iter(content) {\n        let uuid_str = cap[1].to_string();\n\n        if let Ok(uuid) = Uuid::parse_str(\u0026uuid_str) {\n            patterns.push((uuid, cap[0].to_string()));\n        }\n    }\n\n    patterns\n}\n\n/// Extract UUID from a pattern like [Finding: UUID]\nfn extract_uuid_from_pattern(text: \u0026str) -\u003e Option\u003cUuid\u003e {\n    let re =\n        regex::Regex::new(r\"\\[([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})\\]\")\n            .ok()?;\n\n    for cap in re.captures_iter(text) {\n        let uuid_str = cap[1].to_string();\n        if let Ok(uuid) = Uuid::parse_str(\u0026uuid_str) {\n            return Some(uuid);\n        }\n    }\n\n    None\n}\n\n/// Extract task ID from reasoning content\nfn extract_task_id_from_content(content: \u0026str) -\u003e Option\u003cUuid\u003e {\n    // Look for [Task: UUID] or [uuid] patterns\n    let re = regex::Regex::new(r\"\\[Task:\\s*([a-f0-9-]{36})\\]\").ok()?;\n    let task_re = regex::Regex::new(r\"\\[([a-f0-9-]{36})\\]\").ok()?;\n\n    // First check for explicit [Task: UUID]\n    for cap in re.captures_iter(content) {\n        let uuid_str = cap[1].to_string();\n        if let Ok(uuid) = Uuid::parse_str(\u0026uuid_str) {\n            return Some(uuid);\n        }\n    }\n\n    // Then check for any [UUID] pattern\n    for cap in task_re.captures_iter(content) {\n        let uuid_str = cap[1].to_string();\n        if let Ok(uuid) = Uuid::parse_str(\u0026uuid_str) {\n            return Some(uuid);\n        }\n    }\n\n    None\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_frontmatter() {\n        let content = r#\"---\ntitle: Test Document\ndoc_type: review\ntags: [test, example]\n---\n\n# Content\"#;\n\n        let frontmatter = parse_frontmatter(content).unwrap();\n        assert_eq!(frontmatter.title, \"Test Document\");\n        // DocType::Review has #[default] so when unspecified it defaults to Review\n        // But when specified as \"review\", serde maps it correctly\n        assert!(matches!(frontmatter.doc_type, DocType::Review));\n        assert_eq!(frontmatter.tags, vec![\"test\", \"example\"]);\n    }\n\n    #[test]\n    fn test_extract_sections() {\n        let content = r#\"---\ntitle: Test\n---\n\n# Overview\n\nSome content here.\n\n## Section 1\n\nMore content.\n\n### Subsection\n\nDeeper content.\n\"#;\n\n        let sections = extract_markdown_sections(content);\n        assert!(sections.len() \u003e= 3);\n    }\n\n    #[test]\n    fn test_extract_task_references() {\n        let content = r#\"\n- [P0: da23ec54-04c8-4679-81e4-d90c09642d4c] Fix the tests\n- [P1: 58339da6-71e3-41df-a6af-93d6b4f861eb] Add feature\n\"#;\n\n        let tasks = extract_task_references(content);\n        assert_eq!(tasks.len(), 2);\n        assert_eq!(tasks[0].priority, \"P0\");\n        assert_eq!(tasks[1].priority, \"P1\");\n    }\n\n    #[test]\n    fn test_extract_uuid_patterns() {\n        let content = r#\"Context: [d453d97e-0f2d-416c-9199-fc70834cb546]\nFinding: [3ecbee2c-aedc-4f74-ab7e-49491dda201e]\n\"#;\n\n        let patterns = extract_uuid_patterns(content);\n        assert_eq!(patterns.len(), 2);\n    }\n}\n","traces":[{"line":128,"address":[14408809,14405248,14408631],"length":1,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[14405368],"length":1,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[14405641],"length":1,"stats":{"Line":0}},{"line":143,"address":[14406863,14408672,14406812,14405709,14406699],"length":1,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[14405645,14405765],"length":1,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[14405935],"length":1,"stats":{"Line":0}},{"line":160,"address":[14405980],"length":1,"stats":{"Line":0}},{"line":161,"address":[14406128],"length":1,"stats":{"Line":0}},{"line":165,"address":[14406233,14405909],"length":1,"stats":{"Line":0}},{"line":166,"address":[14406296,14406239],"length":1,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[14406462,14406625],"length":1,"stats":{"Line":0}},{"line":170,"address":[14406528],"length":1,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[14406270],"length":1,"stats":{"Line":0}},{"line":182,"address":[14404859,14396224,14400733],"length":1,"stats":{"Line":0}},{"line":191,"address":[14396395],"length":1,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[14396769,14396833],"length":1,"stats":{"Line":0}},{"line":201,"address":[14396923,14396731,14405024,14404828,14405032],"length":1,"stats":{"Line":0}},{"line":204,"address":[14397169],"length":1,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[14397181,14397311,14404814,14405079,14405056],"length":1,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[14397739],"length":1,"stats":{"Line":0}},{"line":214,"address":[14397839],"length":1,"stats":{"Line":0}},{"line":215,"address":[14397882],"length":1,"stats":{"Line":0}},{"line":220,"address":[14397565,14398007],"length":1,"stats":{"Line":0}},{"line":222,"address":[14398033],"length":1,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[14398281,14398047],"length":1,"stats":{"Line":0}},{"line":228,"address":[14398307],"length":1,"stats":{"Line":0}},{"line":229,"address":[14398422,14398355],"length":1,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[14398595,14398829],"length":1,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[14398903,14398970],"length":1,"stats":{"Line":0}},{"line":245,"address":[14398869,14399103],"length":1,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[14399142],"length":1,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[14403860],"length":1,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[14404531,14404740],"length":1,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[14399496,14399355,14399407],"length":1,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[14399725],"length":1,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[14399901],"length":1,"stats":{"Line":0}},{"line":286,"address":[14404908,14399958,14404896],"length":1,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[14400095],"length":1,"stats":{"Line":0}},{"line":292,"address":[14400174,14400242],"length":1,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[14400520],"length":1,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[14399752,14400799],"length":1,"stats":{"Line":0}},{"line":303,"address":[14400909],"length":1,"stats":{"Line":0}},{"line":306,"address":[14402687],"length":1,"stats":{"Line":0}},{"line":307,"address":[14402786,14402722],"length":1,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[14402802],"length":1,"stats":{"Line":0}},{"line":311,"address":[14402859,14404944,14404956],"length":1,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[14402897],"length":1,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[14403458,14403392],"length":1,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[14403517],"length":1,"stats":{"Line":0}},{"line":327,"address":[14400972],"length":1,"stats":{"Line":0}},{"line":328,"address":[14401112],"length":1,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[14401544],"length":1,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[14401880,14401817,14402072],"length":1,"stats":{"Line":0}},{"line":340,"address":[14401976,14401891,14402077,14401949],"length":1,"stats":{"Line":0}},{"line":343,"address":[14401914],"length":1,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[14402392,14402314],"length":1,"stats":{"Line":0}},{"line":347,"address":[14402352,14402418],"length":1,"stats":{"Line":0}},{"line":349,"address":[14402444],"length":1,"stats":{"Line":0}},{"line":350,"address":[14402474],"length":1,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[25416818,25416862,25416112],"length":1,"stats":{"Line":1}},{"line":360,"address":[25416183],"length":1,"stats":{"Line":1}},{"line":369,"address":[18746443],"length":1,"stats":{"Line":0}},{"line":370,"address":[18686972],"length":1,"stats":{"Line":0}},{"line":372,"address":[25416343],"length":1,"stats":{"Line":0}},{"line":373,"address":[18687007],"length":1,"stats":{"Line":0}},{"line":374,"address":[18535767],"length":1,"stats":{"Line":0}},{"line":375,"address":[16944073],"length":1,"stats":{"Line":0}},{"line":380,"address":[25416171],"length":1,"stats":{"Line":1}},{"line":381,"address":[18535799],"length":1,"stats":{"Line":1}},{"line":382,"address":[18687923,18687741,18687531],"length":1,"stats":{"Line":2}},{"line":384,"address":[18758372],"length":1,"stats":{"Line":0}},{"line":385,"address":[25877589],"length":1,"stats":{"Line":0}},{"line":390,"address":[18758517],"length":1,"stats":{"Line":1}},{"line":393,"address":[18687810,18687862,18688005],"length":1,"stats":{"Line":2}},{"line":394,"address":[18687840,18687941],"length":1,"stats":{"Line":1}},{"line":397,"address":[18688354,18688295],"length":1,"stats":{"Line":2}},{"line":398,"address":[18688450],"length":1,"stats":{"Line":0}},{"line":399,"address":[18759182],"length":1,"stats":{"Line":0}},{"line":403,"address":[25878376],"length":1,"stats":{"Line":1}},{"line":407,"address":[18691664,18693280,18694214],"length":1,"stats":{"Line":1}},{"line":408,"address":[20180967],"length":1,"stats":{"Line":1}},{"line":411,"address":[20181148,20181032,20181110],"length":1,"stats":{"Line":2}},{"line":412,"address":[20231363,20231034,20231123,20231263],"length":1,"stats":{"Line":3}},{"line":413,"address":[16948992,16949069],"length":1,"stats":{"Line":2}},{"line":415,"address":[18692131],"length":1,"stats":{"Line":0}},{"line":418,"address":[18762652],"length":1,"stats":{"Line":0}},{"line":422,"address":[20181500,20181205],"length":1,"stats":{"Line":2}},{"line":423,"address":[25882302,25882377],"length":1,"stats":{"Line":2}},{"line":425,"address":[20181644],"length":1,"stats":{"Line":1}},{"line":426,"address":[20181670],"length":1,"stats":{"Line":1}},{"line":428,"address":[18541259,18541370,18541517],"length":1,"stats":{"Line":3}},{"line":429,"address":[25883361,25882886],"length":1,"stats":{"Line":2}},{"line":431,"address":[18542151,18542216],"length":1,"stats":{"Line":2}},{"line":432,"address":[18752752,18753077,18752856],"length":1,"stats":{"Line":2}},{"line":436,"address":[18693843,18693565],"length":1,"stats":{"Line":2}},{"line":437,"address":[18542686,18542724],"length":1,"stats":{"Line":1}},{"line":438,"address":[18753033,18752686,18753327],"length":1,"stats":{"Line":2}},{"line":439,"address":[18753372],"length":1,"stats":{"Line":1}},{"line":444,"address":[25422243],"length":1,"stats":{"Line":1}},{"line":445,"address":[18693098,18692976],"length":1,"stats":{"Line":1}},{"line":448,"address":[20182293],"length":1,"stats":{"Line":1}},{"line":452,"address":[18757512,18757506,18756640],"length":1,"stats":{"Line":0}},{"line":453,"address":[25415271],"length":1,"stats":{"Line":0}},{"line":455,"address":[20225124,20225203],"length":1,"stats":{"Line":0}},{"line":456,"address":[25415527,25415704,25415613],"length":1,"stats":{"Line":0}},{"line":458,"address":[25876434,25876349],"length":1,"stats":{"Line":0}},{"line":460,"address":[20225764],"length":1,"stats":{"Line":0}},{"line":461,"address":[25415774],"length":1,"stats":{"Line":0}},{"line":462,"address":[18535301],"length":1,"stats":{"Line":0}},{"line":468,"address":[18534968],"length":1,"stats":{"Line":0}},{"line":472,"address":[20180878,20178992,20180850],"length":1,"stats":{"Line":1}},{"line":473,"address":[25419143],"length":1,"stats":{"Line":1}},{"line":476,"address":[18689840,18689912],"length":1,"stats":{"Line":2}},{"line":478,"address":[25419322,25419493,25419373],"length":1,"stats":{"Line":3}},{"line":479,"address":[16947157,16947368],"length":1,"stats":{"Line":2}},{"line":480,"address":[18539355,18539251],"length":1,"stats":{"Line":2}},{"line":482,"address":[18539382,18539462,18539530],"length":1,"stats":{"Line":3}},{"line":484,"address":[25880830],"length":1,"stats":{"Line":1}},{"line":485,"address":[25420300],"length":1,"stats":{"Line":1}},{"line":495,"address":[18750679],"length":1,"stats":{"Line":1}},{"line":496,"address":[18750639],"length":1,"stats":{"Line":1}},{"line":503,"address":[18690338],"length":1,"stats":{"Line":1}},{"line":507,"address":[16953723,16952112,16953729],"length":1,"stats":{"Line":0}},{"line":508,"address":[16952167],"length":1,"stats":{"Line":0}},{"line":511,"address":[18766144,18766072],"length":1,"stats":{"Line":0}},{"line":513,"address":[20234609,20234526],"length":1,"stats":{"Line":0}},{"line":515,"address":[16952543,16952746,16952672],"length":1,"stats":{"Line":0}},{"line":516,"address":[25425223,25425163],"length":1,"stats":{"Line":0}},{"line":517,"address":[25885938],"length":1,"stats":{"Line":0}},{"line":518,"address":[25886032],"length":1,"stats":{"Line":0}},{"line":521,"address":[20235197],"length":1,"stats":{"Line":0}},{"line":523,"address":[16953060],"length":1,"stats":{"Line":0}},{"line":524,"address":[18755443],"length":1,"stats":{"Line":0}},{"line":525,"address":[18767013],"length":1,"stats":{"Line":0}},{"line":527,"address":[18767439],"length":1,"stats":{"Line":0}},{"line":528,"address":[25886440,25886303],"length":1,"stats":{"Line":0}},{"line":529,"address":[16953280,16953521],"length":1,"stats":{"Line":0}},{"line":531,"address":[20185717],"length":1,"stats":{"Line":0}},{"line":533,"address":[18767374],"length":1,"stats":{"Line":0}},{"line":540,"address":[20234778],"length":1,"stats":{"Line":0}},{"line":544,"address":[18760483,18759360,18760477],"length":1,"stats":{"Line":1}},{"line":545,"address":[25417979],"length":1,"stats":{"Line":1}},{"line":555,"address":[20228093,20228216],"length":1,"stats":{"Line":2}},{"line":556,"address":[25418708,25418524],"length":1,"stats":{"Line":2}},{"line":558,"address":[18760227,18760159,18760295],"length":1,"stats":{"Line":3}},{"line":559,"address":[25418887],"length":1,"stats":{"Line":1}},{"line":563,"address":[18760016],"length":1,"stats":{"Line":1}},{"line":567,"address":[18754450,18753504,18754444],"length":1,"stats":{"Line":0}},{"line":568,"address":[25884363,25884315],"length":1,"stats":{"Line":0}},{"line":572,"address":[18543405,18543285,18543237],"length":1,"stats":{"Line":0}},{"line":573,"address":[25424251,25424105],"length":1,"stats":{"Line":0}},{"line":574,"address":[18695070,18694934,18695000],"length":1,"stats":{"Line":0}},{"line":575,"address":[16951982],"length":1,"stats":{"Line":0}},{"line":579,"address":[25884842],"length":1,"stats":{"Line":0}},{"line":583,"address":[18545632,18547532,18547178],"length":1,"stats":{"Line":0}},{"line":585,"address":[16953819],"length":1,"stats":{"Line":0}},{"line":586,"address":[18545922,18547530,18545850],"length":1,"stats":{"Line":0}},{"line":589,"address":[18768129,18768300,18768180],"length":1,"stats":{"Line":0}},{"line":590,"address":[20187734,20186888],"length":1,"stats":{"Line":0}},{"line":591,"address":[25888665,25888529,25888595],"length":1,"stats":{"Line":0}},{"line":592,"address":[20237714],"length":1,"stats":{"Line":0}},{"line":597,"address":[18546608,18546481],"length":1,"stats":{"Line":0}},{"line":598,"address":[16954860,16955025],"length":1,"stats":{"Line":0}},{"line":599,"address":[25888240,25888172,25888310],"length":1,"stats":{"Line":0}},{"line":600,"address":[18757558],"length":1,"stats":{"Line":0}},{"line":604,"address":[18546781],"length":1,"stats":{"Line":0}}],"covered":49,"coverable":234},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","info.rs"],"content":"//! Info command for displaying storage and workspace information\n\nuse crate::error::EngramError;\nuse crate::storage::Storage;\n\n/// Display workspace and storage information\npub fn info\u003cS: Storage\u003e(storage: \u0026S) -\u003e Result\u003c(), EngramError\u003e {\n    println!(\"‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\");\n    println!(\"‚ïë                    ENGRAM WORKSPACE INFO                    ‚ïë\");\n    println!(\"‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\");\n    println!();\n\n    // Storage backend info\n    println!(\"üì¶ Storage Backend\");\n    println!(\"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\");\n\n    if let Some(stats) = storage.get_stats().ok().as_ref() {\n        println!(\"  Total Entities: {}\", stats.total_entities);\n        println!(\"  Storage Size: {} bytes\", stats.total_storage_size);\n\n        if let Some(last_sync) = stats.last_sync {\n            println!(\"  Last Sync: {}\", last_sync.format(\"%Y-%m-%d %H:%M:%S UTC\"));\n        }\n    } else {\n        println!(\"  Storage statistics unavailable\");\n    }\n    println!();\n\n    // Entity counts by type\n    println!(\"üìä Entity Counts\");\n    println!(\"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\");\n\n    let entity_types = [\n        \"task\",\n        \"context\",\n        \"reasoning\",\n        \"knowledge\",\n        \"session\",\n        \"rule\",\n        \"standard\",\n        \"compliance\",\n        \"adr\",\n        \"workflow\",\n        \"workflow_instance\",\n        \"relationship\",\n        \"agent_sandbox\",\n        \"escalation_request\",\n    ];\n\n    for entity_type in entity_types {\n        if let Ok(ids) = storage.list_ids(entity_type) {\n            if !ids.is_empty() {\n                println!(\"  {}: {}\", entity_type.replace(\"_\", \" \"), ids.len());\n            }\n        }\n    }\n    println!();\n\n    // Agent info\n    println!(\"üë• Agents\");\n    println!(\"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\");\n\n    let agent_entities = storage.list_ids(\"agent\").unwrap_or_default();\n    if agent_entities.is_empty() {\n        println!(\"  No agents configured\");\n    } else {\n        println!(\"  {} agent(s) configured\", agent_entities.len());\n    }\n    println!();\n\n    println!(\"‚úÖ Workspace health: Good\");\n    println!();\n\n    Ok(())\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[14511618],"length":1,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[14512516],"length":1,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":46},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","knowledge.rs"],"content":"//! Knowledge command implementations\n\nuse crate::entities::{Entity, Knowledge, KnowledgeType};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\nuse serde::Deserialize;\nuse std::fs;\nuse std::io::{self, Read};\n\n/// Knowledge input structure for JSON\n#[derive(Debug, Deserialize)]\npub struct KnowledgeInput {\n    pub title: String,\n    pub content: Option\u003cString\u003e,\n    pub knowledge_type: Option\u003cString\u003e,\n    pub confidence: Option\u003cf64\u003e,\n    pub source: Option\u003cString\u003e,\n    pub agent: Option\u003cString\u003e,\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n/// Knowledge commands\n#[derive(Debug, Subcommand)]\npub enum KnowledgeCommands {\n    /// Create a new knowledge item\n    Create {\n        /// Knowledge title\n        #[arg(long, short, conflicts_with_all = [\"title_stdin\", \"title_file\"])]\n        title: Option\u003cString\u003e,\n\n        /// Knowledge content\n        #[arg(long, short, conflicts_with_all = [\"content_stdin\", \"content_file\"])]\n        content: Option\u003cString\u003e,\n\n        /// Knowledge type (fact, pattern, rule, concept, procedure, heuristic)\n        #[arg(long, short = 'k', default_value = \"fact\")]\n        knowledge_type: String,\n\n        /// Confidence level (0.0 to 1.0)\n        #[arg(long, short = 'f', default_value = \"0.8\")]\n        confidence: f64,\n\n        /// Source of this knowledge\n        #[arg(long, short)]\n        source: Option\u003cString\u003e,\n\n        /// Assigned agent\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Tags (comma-separated)\n        #[arg(long)]\n        tags: Option\u003cString\u003e,\n\n        /// Read title from stdin\n        #[arg(long, conflicts_with_all = [\"title\", \"title_file\"])]\n        title_stdin: bool,\n\n        /// Read title from file\n        #[arg(long, conflicts_with_all = [\"title\", \"title_stdin\"])]\n        title_file: Option\u003cString\u003e,\n\n        /// Read content from stdin\n        #[arg(long, conflicts_with_all = [\"content\", \"content_file\"])]\n        content_stdin: bool,\n\n        /// Read content from file\n        #[arg(long, conflicts_with_all = [\"content\", \"content_stdin\"])]\n        content_file: Option\u003cString\u003e,\n\n        /// Create knowledge from JSON input (stdin or file)\n        #[arg(long, conflicts_with_all = [\"title\", \"content\", \"title_stdin\", \"title_file\", \"content_stdin\", \"content_file\"])]\n        json: bool,\n\n        /// JSON file path (requires --json)\n        #[arg(long, requires = \"json\")]\n        json_file: Option\u003cString\u003e,\n    },\n    /// List knowledge items\n    List {\n        /// Agent filter\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Type filter (fact, pattern, rule, concept, procedure, heuristic)\n        #[arg(long, short)]\n        kind: Option\u003cString\u003e,\n\n        /// Limit results\n        #[arg(long, short)]\n        limit: Option\u003cusize\u003e,\n    },\n    /// Show knowledge details\n    Show {\n        /// Knowledge item ID\n        #[arg(long, short)]\n        id: String,\n    },\n    /// Update knowledge item\n    Update {\n        /// Knowledge item ID\n        #[arg(long, short)]\n        id: String,\n\n        /// Field to update (content, confidence, type)\n        #[arg(long, short)]\n        field: String,\n\n        /// New value\n        #[arg(long, short)]\n        value: String,\n    },\n    /// Delete knowledge item\n    Delete {\n        /// Knowledge item ID\n        #[arg(long, short)]\n        id: String,\n    },\n}\n\n/// Read from stdin\nfn read_stdin() -\u003e Result\u003cString, EngramError\u003e {\n    let mut buffer = String::new();\n    io::stdin().read_to_string(\u0026mut buffer)?;\n    Ok(buffer.trim().to_string())\n}\n\nfn read_file(path: \u0026str) -\u003e Result\u003cString, EngramError\u003e {\n    fs::read_to_string(path)\n        .map(|s| s.trim().to_string())\n        .map_err(|e| EngramError::Io(e))\n}\n\n/// Parse knowledge type string to KnowledgeType enum\nfn parse_knowledge_type(type_str: \u0026str) -\u003e Result\u003cKnowledgeType, EngramError\u003e {\n    match type_str.to_lowercase().as_str() {\n        \"fact\" =\u003e Ok(KnowledgeType::Fact),\n        \"pattern\" =\u003e Ok(KnowledgeType::Pattern),\n        \"rule\" =\u003e Ok(KnowledgeType::Rule),\n        \"concept\" =\u003e Ok(KnowledgeType::Concept),\n        \"procedure\" =\u003e Ok(KnowledgeType::Procedure),\n        \"heuristic\" =\u003e Ok(KnowledgeType::Heuristic),\n        _ =\u003e Err(EngramError::Validation(\n            format!(\"Invalid knowledge type '{}'. Must be one of: fact, pattern, rule, concept, procedure, heuristic\", type_str)\n        )),\n    }\n}\n\n/// Create knowledge from JSON input\nfn create_knowledge_from_input\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    input: KnowledgeInput,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let agent = input.agent.unwrap_or_else(|| \"default\".to_string());\n    let content = input.content.unwrap_or_default();\n    let confidence = input.confidence.unwrap_or(0.8);\n    let knowledge_type_str = input.knowledge_type.unwrap_or_else(|| \"fact\".to_string());\n    let knowledge_type = parse_knowledge_type(\u0026knowledge_type_str)?;\n\n    // Validate confidence\n    if confidence \u003c 0.0 || confidence \u003e 1.0 {\n        return Err(EngramError::Validation(\n            \"Confidence must be between 0.0 and 1.0\".to_string(),\n        ));\n    }\n\n    let mut knowledge = Knowledge::new(input.title, content, knowledge_type, confidence, agent);\n\n    // Set optional fields\n    if let Some(source) = input.source {\n        knowledge.set_source(source);\n    }\n\n    if let Some(tags) = input.tags {\n        for tag in tags {\n            knowledge.add_tag(tag);\n        }\n    }\n\n    let generic = knowledge.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"Knowledge created successfully with ID: {}\", knowledge.id);\n    Ok(())\n}\n\n/// Create a new knowledge item\npub fn create_knowledge\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    title: Option\u003cString\u003e,\n    content: Option\u003cString\u003e,\n    knowledge_type: String,\n    confidence: f64,\n    source: Option\u003cString\u003e,\n    agent: Option\u003cString\u003e,\n    tags: Option\u003cString\u003e,\n    title_stdin: bool,\n    title_file: Option\u003cString\u003e,\n    content_stdin: bool,\n    content_file: Option\u003cString\u003e,\n    json: bool,\n    json_file: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    // Handle JSON input first\n    if json {\n        let json_str = if let Some(file) = json_file {\n            read_file(\u0026file)?\n        } else {\n            read_stdin()?\n        };\n\n        let input: KnowledgeInput = serde_json::from_str(\u0026json_str)\n            .map_err(|e| EngramError::Validation(format!(\"Invalid JSON: {}\", e)))?;\n\n        return create_knowledge_from_input(storage, input);\n    }\n\n    // Resolve title\n    let final_title = if title_stdin {\n        read_stdin()?\n    } else if let Some(file) = title_file {\n        read_file(\u0026file)?\n    } else if let Some(t) = title {\n        t\n    } else {\n        return Err(EngramError::Validation(\n            \"Title is required (use --title, --title-stdin, or --title-file)\".to_string(),\n        ));\n    };\n\n    // Resolve content (optional)\n    let final_content = if content_stdin {\n        read_stdin()?\n    } else if let Some(file) = content_file {\n        read_file(\u0026file)?\n    } else {\n        content.unwrap_or_default()\n    };\n\n    // Parse knowledge type\n    let knowledge_type_enum = parse_knowledge_type(\u0026knowledge_type)?;\n\n    // Validate confidence\n    if confidence \u003c 0.0 || confidence \u003e 1.0 {\n        return Err(EngramError::Validation(\n            \"Confidence must be between 0.0 and 1.0\".to_string(),\n        ));\n    }\n\n    let agent_name = agent.unwrap_or_else(|| \"default\".to_string());\n\n    let mut knowledge = Knowledge::new(\n        final_title,\n        final_content,\n        knowledge_type_enum,\n        confidence,\n        agent_name,\n    );\n\n    // Set optional fields\n    if let Some(src) = source {\n        knowledge.set_source(src);\n    }\n\n    if let Some(tags_str) = tags {\n        for tag in tags_str.split(',') {\n            knowledge.add_tag(tag.trim().to_string());\n        }\n    }\n\n    let generic = knowledge.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"Knowledge created successfully with ID: {}\", knowledge.id);\n    Ok(())\n}\n\n/// List knowledge items\npub fn list_knowledge\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent: Option\u003cString\u003e,\n    kind: Option\u003cString\u003e,\n    limit: Option\u003cusize\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let ids = storage.list_ids(Knowledge::entity_type())?;\n\n    let mut items: Vec\u003cKnowledge\u003e = Vec::new();\n\n    for id in ids {\n        if let Some(entity) = storage.get(\u0026id, Knowledge::entity_type())? {\n            if let Ok(knowledge) = Knowledge::from_generic(entity) {\n                if let Some(ref agent_filter) = agent {\n                    if knowledge.agent != *agent_filter {\n                        continue;\n                    }\n                }\n\n                if let Some(ref type_filter) = kind {\n                    let type_str = format!(\"{:?}\", knowledge.knowledge_type).to_lowercase();\n                    if type_str != type_filter.to_lowercase() {\n                        continue;\n                    }\n                }\n\n                items.push(knowledge);\n            }\n        }\n    }\n\n    if let Some(limit_val) = limit {\n        items.truncate(limit_val);\n    }\n\n    println!(\"Knowledge Items:\");\n    println!(\"================\");\n\n    for knowledge in items {\n        println!(\"ID: {}\", knowledge.id);\n        println!(\"Title: {}\", knowledge.title);\n        println!(\"Type: {:?}\", knowledge.knowledge_type);\n        println!(\"Confidence: {:.2}\", knowledge.confidence);\n        println!(\"Agent: {}\", knowledge.agent);\n        if let Some(source) = \u0026knowledge.source {\n            println!(\"Source: {}\", source);\n        }\n        if !knowledge.tags.is_empty() {\n            println!(\"Tags: {}\", knowledge.tags.join(\", \"));\n        }\n        println!(\"---\");\n    }\n\n    Ok(())\n}\n\n/// Show knowledge details\npub fn show_knowledge\u003cS: Storage\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    let entity = storage\n        .get(id, Knowledge::entity_type())?\n        .ok_or_else(|| EngramError::NotFound(format!(\"Knowledge not found: {}\", id)))?;\n\n    let knowledge =\n        Knowledge::from_generic(entity).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n    println!(\"Knowledge Details:\");\n    println!(\"==================\");\n    println!(\"ID: {}\", knowledge.id);\n    println!(\"Title: {}\", knowledge.title);\n    println!(\"Content: {}\", knowledge.content);\n    println!(\"Type: {:?}\", knowledge.knowledge_type);\n    println!(\"Confidence: {:.2}\", knowledge.confidence);\n    println!(\"Agent: {}\", knowledge.agent);\n    println!(\"Created: {}\", knowledge.created_at);\n    println!(\"Updated: {}\", knowledge.updated_at);\n\n    if let Some(source) = \u0026knowledge.source {\n        println!(\"Source: {}\", source);\n    }\n\n    if !knowledge.tags.is_empty() {\n        println!(\"Tags: {}\", knowledge.tags.join(\", \"));\n    }\n\n    if !knowledge.related_knowledge.is_empty() {\n        println!(\n            \"Related Knowledge: {}\",\n            knowledge.related_knowledge.join(\", \")\n        );\n    }\n\n    if !knowledge.contexts.is_empty() {\n        println!(\"Contexts: {}\", knowledge.contexts.join(\", \"));\n    }\n\n    println!(\"Usage Count: {}\", knowledge.usage_count);\n\n    if let Some(last_used) = knowledge.last_used {\n        println!(\"Last Used: {}\", last_used);\n    }\n\n    Ok(())\n}\n\n/// Update knowledge item\npub fn update_knowledge\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    field: \u0026str,\n    value: \u0026str,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let entity = storage\n        .get(id, Knowledge::entity_type())?\n        .ok_or_else(|| EngramError::NotFound(format!(\"Knowledge not found: {}\", id)))?;\n\n    let mut knowledge =\n        Knowledge::from_generic(entity).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n    match field.to_lowercase().as_str() {\n        \"content\" =\u003e {\n            knowledge.update_content(value.to_string(), knowledge.confidence);\n        }\n        \"confidence\" =\u003e {\n            let confidence: f64 = value\n                .parse()\n                .map_err(|_| EngramError::Validation(\"Confidence must be a number\".to_string()))?;\n            if confidence \u003c 0.0 || confidence \u003e 1.0 {\n                return Err(EngramError::Validation(\n                    \"Confidence must be between 0.0 and 1.0\".to_string(),\n                ));\n            }\n            knowledge.update_content(knowledge.content.clone(), confidence);\n        }\n        \"type\" =\u003e {\n            let new_type = parse_knowledge_type(value)?;\n            knowledge.knowledge_type = new_type;\n            knowledge.updated_at = chrono::Utc::now();\n        }\n        \"source\" =\u003e {\n            knowledge.set_source(value.to_string());\n        }\n        _ =\u003e {\n            return Err(EngramError::Validation(format!(\n                \"Unknown field '{}'. Supported fields: content, confidence, type, source\",\n                field\n            )));\n        }\n    }\n\n    let generic = knowledge.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"Knowledge updated successfully: {}\", id);\n    Ok(())\n}\n\n/// Delete knowledge item\npub fn delete_knowledge\u003cS: Storage\u003e(storage: \u0026mut S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    storage.delete(id, Knowledge::entity_type())?;\n    println!(\"Knowledge deleted successfully: {}\", id);\n    Ok(())\n}\n","traces":[{"line":123,"address":[19293073,19293079,19292656],"length":1,"stats":{"Line":0}},{"line":124,"address":[19363446],"length":1,"stats":{"Line":0}},{"line":125,"address":[20781993,20781931],"length":1,"stats":{"Line":0}},{"line":126,"address":[19352163],"length":1,"stats":{"Line":0}},{"line":129,"address":[26483904],"length":1,"stats":{"Line":0}},{"line":130,"address":[19353160],"length":1,"stats":{"Line":0}},{"line":131,"address":[26023267],"length":1,"stats":{"Line":0}},{"line":132,"address":[20256456],"length":1,"stats":{"Line":0}},{"line":136,"address":[19141856,19142608,19142614],"length":1,"stats":{"Line":0}},{"line":137,"address":[19141985,19141883],"length":1,"stats":{"Line":0}},{"line":138,"address":[19142001,19142072],"length":1,"stats":{"Line":0}},{"line":139,"address":[20782588,20782540,20782632],"length":1,"stats":{"Line":0}},{"line":140,"address":[19031580,19031532,19031624],"length":1,"stats":{"Line":0}},{"line":141,"address":[26022856,26022764,26022812],"length":1,"stats":{"Line":0}},{"line":142,"address":[19364344,19364252,19364300],"length":1,"stats":{"Line":0}},{"line":143,"address":[19364316,19364407,19364364],"length":1,"stats":{"Line":0}},{"line":144,"address":[20783008],"length":1,"stats":{"Line":0}},{"line":145,"address":[26022999,26022951],"length":1,"stats":{"Line":0}},{"line":151,"address":[15041791,15039280,15040801],"length":1,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[15039617,15039699],"length":1,"stats":{"Line":0}},{"line":158,"address":[15042112,15042124,15039708],"length":1,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[15041284],"length":1,"stats":{"Line":0}},{"line":164,"address":[15040054],"length":1,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[15040448,15040359],"length":1,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[15040513],"length":1,"stats":{"Line":0}},{"line":182,"address":[15040812,15040883],"length":1,"stats":{"Line":0}},{"line":184,"address":[15041028],"length":1,"stats":{"Line":0}},{"line":185,"address":[15041129],"length":1,"stats":{"Line":0}},{"line":189,"address":[15028112,15034999,15029180],"length":1,"stats":{"Line":0}},{"line":206,"address":[15028348],"length":1,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[15035067,15035040,15033823,15033757],"length":1,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[15028511,15029664],"length":1,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[15029298],"length":1,"stats":{"Line":0}},{"line":233,"address":[15029135,15030557],"length":1,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[15029932,15029780],"length":1,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[15032853,15030231,15030619],"length":1,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[15032773],"length":1,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[15035324,15030878,15035312],"length":1,"stats":{"Line":0}},{"line":254,"address":[15030955],"length":1,"stats":{"Line":0}},{"line":255,"address":[15030995],"length":1,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[15031160,15031273],"length":1,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[15031726,15031797],"length":1,"stats":{"Line":0}},{"line":275,"address":[15031945],"length":1,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[15024273,15019968,15022424],"length":1,"stats":{"Line":0}},{"line":286,"address":[15020039,15020158,15024252],"length":1,"stats":{"Line":0}},{"line":288,"address":[15020397],"length":1,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[15020773,15022541],"length":1,"stats":{"Line":0}},{"line":292,"address":[15022953,15023082,15024061,15023002],"length":1,"stats":{"Line":0}},{"line":293,"address":[15023124],"length":1,"stats":{"Line":0}},{"line":294,"address":[15023282,15023172],"length":1,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[15023203,15023318],"length":1,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[15023692],"length":1,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[15020818],"length":1,"stats":{"Line":0}},{"line":312,"address":[15020856,15020889],"length":1,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[15020910],"length":1,"stats":{"Line":0}},{"line":318,"address":[15021145,15020955],"length":1,"stats":{"Line":0}},{"line":319,"address":[15021441,15021228],"length":1,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[15021614],"length":1,"stats":{"Line":0}},{"line":322,"address":[15021714],"length":1,"stats":{"Line":0}},{"line":323,"address":[15021842],"length":1,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[15022023,15022073],"length":1,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[15022430,15022183],"length":1,"stats":{"Line":0}},{"line":333,"address":[15021289],"length":1,"stats":{"Line":0}},{"line":337,"address":[15024288,15027743,15026872],"length":1,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[15027801,15024559,15024647,15027776],"length":1,"stats":{"Line":0}},{"line":342,"address":[15024972,15025192,15027731,15027986,15027968],"length":1,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[15025481,15025411],"length":1,"stats":{"Line":0}},{"line":346,"address":[15025500],"length":1,"stats":{"Line":0}},{"line":347,"address":[15025553],"length":1,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[15025753],"length":1,"stats":{"Line":0}},{"line":350,"address":[15025857],"length":1,"stats":{"Line":0}},{"line":351,"address":[15025957],"length":1,"stats":{"Line":0}},{"line":352,"address":[15026085],"length":1,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[15026293],"length":1,"stats":{"Line":0}},{"line":356,"address":[15026397],"length":1,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[15026501,15026599],"length":1,"stats":{"Line":0}},{"line":361,"address":[15026605,15026670],"length":1,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[15027242,15027165],"length":1,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[15027513],"length":1,"stats":{"Line":0}},{"line":378,"address":[15027636,15027578],"length":1,"stats":{"Line":0}},{"line":381,"address":[15027610],"length":1,"stats":{"Line":0}},{"line":385,"address":[15038741,15038749,15035664],"length":1,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[15035808,15035917,15035844],"length":1,"stats":{"Line":0}},{"line":393,"address":[15036092,15038953,15038928,15036004],"length":1,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[15037011,15036856,15036943],"length":1,"stats":{"Line":0}},{"line":399,"address":[15037027],"length":1,"stats":{"Line":0}},{"line":400,"address":[15038250,15037106],"length":1,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[15038010],"length":1,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[15037148,15037210],"length":1,"stats":{"Line":0}},{"line":414,"address":[15037262,15037636,15037825],"length":1,"stats":{"Line":0}},{"line":415,"address":[15037764],"length":1,"stats":{"Line":0}},{"line":416,"address":[15037771],"length":1,"stats":{"Line":0}},{"line":418,"address":[15037226,15037288],"length":1,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":171},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","mod.rs"],"content":"//! CLI module for Engram system\n//!\n//! Provides modular command-line interface with subcommands\n//! for all entity types and operations.\n\npub mod adr;\npub mod compliance;\npub mod context;\npub mod convert;\npub mod escalation;\npub mod git;\npub mod help;\npub mod import;\npub mod info;\npub mod knowledge;\npub mod perkeep;\npub mod prompts;\npub mod reasoning;\npub mod relationship;\npub mod rule;\n#[cfg(feature = \"sandbox\")]\npub mod sandbox;\npub mod schema;\npub mod session;\npub mod setup;\npub mod skills;\npub mod standard;\npub mod sync;\npub mod task;\npub mod validation;\npub mod workflow;\n\npub use adr::*;\npub use compliance::*;\npub use context::*;\npub use convert::*;\npub use escalation::*;\npub use help::*;\npub use import::*;\npub use info::*;\npub use knowledge::*;\npub use perkeep::*;\npub use prompts::*;\npub use reasoning::*;\npub use relationship::*;\npub use rule::*;\n#[cfg(feature = \"sandbox\")]\npub use sandbox::*;\npub use schema::*;\npub use session::*;\npub use setup::*;\npub use skills::*;\npub use standard::*;\npub use sync::*;\npub use task::*;\npub use validation::*;\npub use workflow::*;\n\nuse crate::ask::AskCommands;\nuse clap::{Parser, Subcommand};\n\n/// Main CLI structure\n#[derive(Parser)]\n#[command(name = \"engram\")]\n#[command(\n    about = \"Task memory system for LLM coding agents\",\n    long_about = \"ENGRAM: Task-driven memory system for LLM coding agents\\n\\nPURPOSE: Maintains project state, tasks, and reasoning across coding sessions.\\nEnforces disciplined development via Git commit validation requiring task references.\\n\\nWORKFLOW:\\n1. engram setup workspace              # Initialize project\\n2. engram task create --title \\\"...\\\"    # Create work items (returns UUIDs)\\n3. engram context create --title \\\"...\\\" # Add background info\\n4. engram reasoning create --task-id \u003cuuid\u003e # Document decisions\\n5. engram relationship create ...       # Link entities (REQUIRED for validation)\\n6. engram validate hook install        # Enable Git integration\\n\\nGIT INTEGRATION: Commits must reference task UUIDs: \\\"feat: implement auth [\u003cuuid\u003e]\\\"\\nJSON I/O: Most commands support --json input/output for programmatic access.\\n\\nUse 'engram guide examples' for working command examples.\"\n)]\n#[command(version = env!(\"CARGO_PKG_VERSION\"))]\n#[command(author = \"Engram Team\")]\npub struct Cli {\n    #[command(subcommand)]\n    pub command: Commands,\n\n    #[arg(long, global = true)]\n    pub json: bool,\n}\n\n/// Available CLI commands\n#[derive(Subcommand)]\npub enum Commands {\n    /// Initialize workspace or agent\n    Setup {\n        #[command(subcommand)]\n        command: SetupCommands,\n    },\n    /// Convert from other formats (EXPERIMENTAL - Not yet implemented)\n    Convert {\n        /// Source format (openspec, beads, github)\n        #[arg(long, short = 'o')]\n        from: String,\n\n        /// Source file path\n        #[arg(long, short = 'f')]\n        file: String,\n    },\n    /// Import entities from structured markdown files\n    Import {\n        #[command(subcommand)]\n        command: import::ImportCommands,\n    },\n    /// Run Git commands safely (blocks --no-verify)\n    Git {\n        #[command(subcommand)]\n        command: git::GitCommands,\n    },\n    /// Run test suite\n    Test,\n    /// Create/manage work items (returns UUIDs for commit references)\n    Task {\n        #[command(subcommand)]\n        command: TaskCommands,\n    },\n    /// Background information and documentation\n    Context {\n        #[command(subcommand)]\n        command: ContextCommands,\n    },\n    /// Natural Language Query Interface\n    Ask {\n        #[command(subcommand)]\n        command: AskCommands,\n    },\n    /// Decision chains and rationale (required for task validation)\n    Reasoning {\n        #[command(subcommand)]\n        command: ReasoningCommands,\n    },\n    /// Knowledge base management\n    Knowledge {\n        #[command(subcommand)]\n        command: KnowledgeCommands,\n    },\n    /// Coding session tracking\n    Session {\n        #[command(subcommand)]\n        command: SessionCommands,\n    },\n    /// Compliance requirements\n    Compliance {\n        #[command(subcommand)]\n        command: ComplianceCommands,\n    },\n    /// Rules and policies\n    Rule {\n        #[command(subcommand)]\n        command: RuleCommands,\n    },\n    /// Coding standards\n    Standard {\n        #[command(subcommand)]\n        command: StandardCommands,\n    },\n    /// Architectural decisions\n    Adr {\n        #[command(subcommand)]\n        command: AdrCommands,\n    },\n    /// State machines and process flows\n    Workflow {\n        #[command(subcommand)]\n        command: WorkflowCommands,\n    },\n    /// Link entities (REQUIRED: task‚Üîreasoning, task‚Üîcontext for validation)\n    Relationship {\n        #[command(subcommand)]\n        command: RelationshipCommands,\n    },\n    /// Git commit validation and pre-commit hooks\n    Validate {\n        #[command(subcommand)]\n        command: validation::ValidationCommands,\n    },\n    /// Agent sandbox security and resource management\n    #[cfg(feature = \"sandbox\")]\n    Sandbox {\n        #[command(subcommand)]\n        command: SandboxCommands,\n    },\n    /// Escalation requests for sandbox permission denied operations\n    Escalation {\n        #[command(subcommand)]\n        command: EscalationCommands,\n    },\n    /// Synchronize between agents\n    Sync {\n        #[command(subcommand)]\n        command: SyncCommands,\n    },\n    /// Get next task and generate prompt\n    Next {\n        /// Optional specific task ID\n        #[arg(long, short)]\n        id: Option\u003cString\u003e,\n\n        /// Output format (markdown, json)\n        #[arg(long, default_value = \"markdown\")]\n        format: String,\n    },\n    /// Display workspace and storage information\n    Info,\n    /// Migrate from dual-repository to Git refs storage\n    Migration,\n    /// Perkeep backup and restore operations\n    Perkeep {\n        #[command(subcommand)]\n        command: PerkeepCommands,\n    },\n    #[command(name = \"guide\")]\n    Guide {\n        #[command(subcommand)]\n        command: Option\u003cHelpCommands\u003e,\n    },\n    /// List and manage skills\n    Skills {\n        #[command(subcommand)]\n        command: SkillsCommands,\n    },\n    /// List and manage prompts from ENGRAM_PROMPTS_PATH\n    Prompts {\n        #[command(subcommand)]\n        command: PromptsCommands,\n    },\n    /// Generate JSON Schema for entity types\n    Schema {\n        #[command(subcommand)]\n        command: SchemaCommands,\n    },\n}\n\n/// Setup commands\n#[derive(Subcommand)]\npub enum SetupCommands {\n    /// Initialize workspace\n    Workspace,\n    /// Initialize agent profile\n    Agent {\n        /// Agent name\n        #[arg(long, short)]\n        name: String,\n\n        /// Agent type (coder, reviewer, planner)\n        #[arg(long, short, default_value = \"coder\")]\n        agent_type: String,\n\n        /// Agent specialization\n        #[arg(long)]\n        specialization: Option\u003cString\u003e,\n\n        /// Agent email\n        #[arg(long)]\n        email: Option\u003cString\u003e,\n    },\n    /// Install OpenCode skills\n    Skills,\n    /// Install OpenCode prompts\n    Prompts {\n        /// Path to prompts directory (default: ./prompts)\n        #[arg(long, short)]\n        path: Option\u003cString\u003e,\n    },\n}\npub mod next;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","next.rs"],"content":"use crate::entities::task::{Task, TaskPriority, TaskStatus};\nuse crate::entities::Entity;\nuse crate::storage::Storage;\nuse crate::EngramError;\nuse std::collections::HashMap;\n\npub fn interpolate(template: \u0026str, context: \u0026HashMap\u003cString, String\u003e) -\u003e String {\n    let mut result = template.to_string();\n    for (key, value) in context {\n        let placeholder = format!(\"{{{{{}}}}}\", key);\n        result = result.replace(\u0026placeholder, value);\n    }\n    result\n}\n\npub fn find_next_task\u003cS: Storage\u003e(storage: \u0026S, agent: \u0026str) -\u003e Result\u003cOption\u003cTask\u003e, EngramError\u003e {\n    let tasks = storage.query_by_agent(agent, Some(\"task\"))?;\n\n    let mut task_entities: Vec\u003cTask\u003e = Vec::new();\n\n    for entity in tasks {\n        if let Ok(task) = Task::from_generic(entity) {\n            if task.status != TaskStatus::Done \u0026\u0026 task.status != TaskStatus::Cancelled {\n                task_entities.push(task);\n            }\n        }\n    }\n\n    if task_entities.is_empty() {\n        return Ok(None);\n    }\n\n    task_entities.sort_by(|a, b| {\n        let status_order = |status: \u0026TaskStatus| match status {\n            TaskStatus::InProgress =\u003e 0,\n            TaskStatus::Todo =\u003e 1,\n            TaskStatus::Blocked =\u003e 2,\n            _ =\u003e 3,\n        };\n\n        let status_cmp = status_order(\u0026a.status).cmp(\u0026status_order(\u0026b.status));\n        if status_cmp != std::cmp::Ordering::Equal {\n            return status_cmp;\n        }\n\n        let priority_order = |priority: \u0026TaskPriority| match priority {\n            TaskPriority::Critical =\u003e 0,\n            TaskPriority::High =\u003e 1,\n            TaskPriority::Medium =\u003e 2,\n            TaskPriority::Low =\u003e 3,\n        };\n\n        priority_order(\u0026a.priority).cmp(\u0026priority_order(\u0026b.priority))\n    });\n\n    Ok(task_entities.first().cloned())\n}\n\nuse crate::entities::context::Context;\nuse crate::entities::workflow::Workflow;\n\npub fn handle_next_command\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: Option\u003cString\u003e,\n    format: String,\n) -\u003e Result\u003c(), EngramError\u003e {\n    // 1. Identify Task\n    let task = if let Some(task_id) = id {\n        if let Some(entity) = storage.get(\u0026task_id, \"task\")? {\n            Task::from_generic(entity).map_err(|e| EngramError::Validation(e.to_string()))?\n        } else {\n            return Err(EngramError::NotFound(format!(\"Task {} not found\", task_id)));\n        }\n    } else {\n        // Default agent to \"default\" for CLI usage, typically would come from config/auth\n        if let Some(t) = find_next_task(storage, \"default\")? {\n            t\n        } else {\n            println!(\"No pending tasks found.\");\n            return Ok(());\n        }\n    };\n\n    // 2. Load associated Workflow (if any)\n    let workflow = if let Some(workflow_id) = \u0026task.workflow_id {\n        if let Some(entity) = storage.get(workflow_id, \"workflow\")? {\n            Some(\n                Workflow::from_generic(entity)\n                    .map_err(|e| EngramError::Validation(e.to_string()))?,\n            )\n        } else {\n            None\n        }\n    } else {\n        None\n    };\n\n    // 3. Build Context Map\n    let mut prompt_context = HashMap::new();\n    prompt_context.insert(\"TASK_ID\".to_string(), task.id.clone());\n    prompt_context.insert(\"TASK_TITLE\".to_string(), task.title.clone());\n    prompt_context.insert(\"TASK_DESCRIPTION\".to_string(), task.description.clone());\n\n    // Load related Context entities\n    let mut context_content = String::new();\n    for context_id in \u0026task.context_ids {\n        if let Some(entity) = storage.get(context_id, \"context\")? {\n            let context = Context::from_generic(entity)\n                .map_err(|e| EngramError::Validation(e.to_string()))?;\n            context_content.push_str(\u0026format!(\"\\n- {}: {}\", context.title, context.content));\n        }\n    }\n    prompt_context.insert(\"CONTEXT\".to_string(), context_content);\n\n    // 4. Select Prompts\n    let (system_prompt, user_prompt) = if let Some(ref wf) = workflow {\n        if let Some(state_name) = \u0026task.workflow_state {\n            if let Some(state) = wf.states.iter().find(|s| \u0026s.name == state_name) {\n                if let Some(prompts) = \u0026state.prompts {\n                    (\n                        prompts\n                            .system\n                            .clone()\n                            .unwrap_or_else(|| \"You are an AI assistant.\".to_string()),\n                        prompts.user.clone().unwrap_or_else(|| {\n                            \"Task: {{TASK_TITLE}}\\nDescription: {{TASK_DESCRIPTION}}\".to_string()\n                        }),\n                    )\n                } else {\n                    (\n                        \"You are an AI assistant.\".to_string(),\n                        \"Task: {{TASK_TITLE}}\\nDescription: {{TASK_DESCRIPTION}}\".to_string(),\n                    )\n                }\n            } else {\n                (\n                    \"You are an AI assistant.\".to_string(),\n                    \"Task: {{TASK_TITLE}}\\nDescription: {{TASK_DESCRIPTION}}\".to_string(),\n                )\n            }\n        } else {\n            (\n                \"You are an AI assistant.\".to_string(),\n                \"Task: {{TASK_TITLE}}\\nDescription: {{TASK_DESCRIPTION}}\".to_string(),\n            )\n        }\n    } else {\n        (\n            \"You are an AI assistant.\".to_string(),\n            \"Task: {{TASK_TITLE}}\\nDescription: {{TASK_DESCRIPTION}}\".to_string(),\n        )\n    };\n\n    // 5. Interpolate\n    let final_system = interpolate(\u0026system_prompt, \u0026prompt_context);\n    let final_user = interpolate(\u0026user_prompt, \u0026prompt_context);\n\n    let task_management_instructions = format!(\n        r#\"\n## Task Management with Engram\n\n**Current Task**: {} ({})\n**Status**: {:?} | **Priority**: {:?}\n\n### Required Workflow Actions:\n\n1. **Update Task Status**:\n   ```bash\n   # Mark task as in progress\n   engram task update {} --status in_progress\n   \n   # Mark task as done when complete\n   engram task update {} --status done\n   ```\n\n2. **Create Context and Reasoning**:\n   ```bash\n   # Create context for important findings\n   engram context create --title \"Context title\" --content \"Details...\"\n   \n   # Create reasoning for decisions made\n   engram reasoning create --title \"Why we chose X\" --content \"Because...\"\n   \n   # Link to task\n   engram relationship create --source-id {} --source-type task \\\n     --target-id \u003ccontext-id\u003e --target-type context --relationship-type references\n   ```\n\n3. **Workflow Management** (if applicable):\n   {}\n\n4. **Before Committing Code**:\n   - All commits MUST reference this task: `[{}]`\n   - Task must have both context and reasoning relationships\n   - Example: `git commit -m \"feat: implement feature [{}]\"`\n\n### Query Task Details:\n```bash\nengram task show {}\nengram relationship connected --entity-id {}\n```\n\"#,\n        task.title,\n        task.id,\n        task.status,\n        task.priority,\n        task.id,\n        task.id,\n        task.id,\n        if workflow.is_some() {\n            format!(\n                \"This task is part of a workflow. Use:\\n   engram workflow status \u003cinstance-id\u003e\\n   engram workflow transition \u003cinstance-id\u003e --transition \u003cname\u003e --agent default\"\n            )\n        } else {\n            \"No active workflow for this task.\".to_string()\n        },\n        task.id,\n        task.id,\n        task.id,\n        task.id\n    );\n\n    // 6. Output\n    if format == \"json\" {\n        let output = serde_json::json!({\n            \"task_id\": task.id,\n            \"system_prompt\": final_system,\n            \"user_prompt\": final_user,\n            \"task_management\": task_management_instructions\n        });\n        println!(\"{}\", serde_json::to_string_pretty(\u0026output).unwrap());\n    } else {\n        println!(\n            \"## System Prompt\\n\\n{}\\n\\n## User Prompt\\n\\n{}\\n\\n{}\",\n            final_system, final_user, task_management_instructions\n        );\n    }\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::entities::task::{Task, TaskPriority, TaskStatus};\n    use crate::entities::GenericEntity;\n    use crate::storage::{GitCommit, QueryFilter, QueryResult, StorageStats};\n    use chrono::Utc;\n    use serde_json::Value;\n\n    struct MockStorage {\n        tasks: Vec\u003cTask\u003e,\n    }\n\n    impl Storage for MockStorage {\n        fn get(\u0026self, _id: \u0026str, _entity_type: \u0026str) -\u003e Result\u003cOption\u003cGenericEntity\u003e, EngramError\u003e {\n            Ok(None)\n        }\n\n        fn store(\u0026mut self, _entity: \u0026GenericEntity) -\u003e Result\u003c(), EngramError\u003e {\n            Ok(())\n        }\n\n        fn delete(\u0026mut self, _id: \u0026str, _entity_type: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n            Ok(())\n        }\n\n        fn query_by_agent(\n            \u0026self,\n            _agent: \u0026str,\n            _entity_type: Option\u003c\u0026str\u003e,\n        ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n            let mut result: Vec\u003cGenericEntity\u003e = Vec::new();\n            for task in \u0026self.tasks {\n                result.push(task.to_generic());\n            }\n            Ok(result)\n        }\n\n        fn query(\u0026self, _filter: \u0026QueryFilter) -\u003e Result\u003cQueryResult, EngramError\u003e {\n            Ok(QueryResult {\n                entities: vec![],\n                total_count: 0,\n                has_more: false,\n            })\n        }\n\n        fn query_by_time_range(\n            \u0026self,\n            _start: chrono::DateTime\u003cUtc\u003e,\n            _end: chrono::DateTime\u003cUtc\u003e,\n        ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n            Ok(vec![])\n        }\n\n        fn query_by_type(\n            \u0026self,\n            _entity_type: \u0026str,\n            _filters: Option\u003c\u0026HashMap\u003cString, Value\u003e\u003e,\n            _limit: Option\u003cusize\u003e,\n            _offset: Option\u003cusize\u003e,\n        ) -\u003e Result\u003cQueryResult, EngramError\u003e {\n            Ok(QueryResult {\n                entities: vec![],\n                total_count: 0,\n                has_more: false,\n            })\n        }\n\n        fn text_search(\n            \u0026self,\n            _query: \u0026str,\n            _entity_types: Option\u003c\u0026[String]\u003e,\n            _limit: Option\u003cusize\u003e,\n        ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n            Ok(vec![])\n        }\n\n        fn count(\u0026self, _filter: \u0026QueryFilter) -\u003e Result\u003cusize, EngramError\u003e {\n            Ok(0)\n        }\n        fn list_ids(\u0026self, _entity_type: \u0026str) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n            Ok(vec![])\n        }\n        fn get_all(\u0026self, _entity_type: \u0026str) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n            Ok(vec![])\n        }\n        fn sync(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n            Ok(())\n        }\n        fn current_branch(\u0026self) -\u003e Result\u003cString, EngramError\u003e {\n            Ok(\"main\".to_string())\n        }\n        fn create_branch(\u0026mut self, _branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n            Ok(())\n        }\n        fn switch_branch(\u0026mut self, _branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n            Ok(())\n        }\n        fn merge_branches(\u0026mut self, _source: \u0026str, _target: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n            Ok(())\n        }\n        fn history(\u0026self, _limit: Option\u003cusize\u003e) -\u003e Result\u003cVec\u003cGitCommit\u003e, EngramError\u003e {\n            Ok(vec![])\n        }\n        fn bulk_store(\u0026mut self, _entities: \u0026[GenericEntity]) -\u003e Result\u003c(), EngramError\u003e {\n            Ok(())\n        }\n        fn get_stats(\u0026self) -\u003e Result\u003cStorageStats, EngramError\u003e {\n            Ok(StorageStats::default())\n        }\n        fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any {\n            self\n        }\n    }\n\n    fn create_test_task(id: \u0026str, status: TaskStatus, priority: TaskPriority) -\u003e Task {\n        Task {\n            id: id.to_string(),\n            title: format!(\"Task {}\", id),\n            description: \"desc\".to_string(),\n            status,\n            priority,\n            agent: \"test-agent\".to_string(),\n            start_time: Utc::now(),\n            end_time: None,\n            parent: None,\n            children: vec![],\n            context_ids: vec![],\n            knowledge: vec![],\n            files: vec![],\n            outcome: None,\n            workflow_id: None,\n            workflow_state: None,\n            tags: vec![],\n            metadata: HashMap::new(),\n        }\n    }\n\n    #[test]\n    fn test_interpolation() {\n        let template = \"Hello {{AGENT_NAME}}, working on {{TASK_ID}}\";\n        let mut context = HashMap::new();\n        context.insert(\"AGENT_NAME\".to_string(), \"Alice\".to_string());\n        context.insert(\"TASK_ID\".to_string(), \"123\".to_string());\n\n        let result = interpolate(template, \u0026context);\n        assert_eq!(result, \"Hello Alice, working on 123\");\n    }\n\n    #[test]\n    fn test_find_next_task_selection() {\n        let t1 = create_test_task(\"1\", TaskStatus::Todo, TaskPriority::High);\n        let t2 = create_test_task(\"2\", TaskStatus::InProgress, TaskPriority::Medium);\n        let t3 = create_test_task(\"3\", TaskStatus::Todo, TaskPriority::Critical);\n        let t4 = create_test_task(\"4\", TaskStatus::Done, TaskPriority::Critical);\n\n        let storage = MockStorage {\n            tasks: vec![t1, t2.clone(), t3, t4],\n        };\n\n        let next = find_next_task(\u0026storage, \"test-agent\").unwrap();\n        assert!(next.is_some());\n        assert_eq!(next.unwrap().id, \"2\");\n    }\n\n    #[test]\n    fn test_find_next_task_priority_tiebreaker() {\n        let t1 = create_test_task(\"1\", TaskStatus::Todo, TaskPriority::Low);\n        let t2 = create_test_task(\"2\", TaskStatus::Todo, TaskPriority::High);\n\n        let storage = MockStorage {\n            tasks: vec![t1, t2.clone()],\n        };\n\n        let next = find_next_task(\u0026storage, \"test-agent\").unwrap();\n        assert!(next.is_some());\n        assert_eq!(next.unwrap().id, \"2\");\n    }\n}\n","traces":[{"line":7,"address":[20915920,20915184,20915914],"length":1,"stats":{"Line":1}},{"line":8,"address":[21800142],"length":1,"stats":{"Line":1}},{"line":9,"address":[27585345,27585402],"length":1,"stats":{"Line":2}},{"line":10,"address":[21800443,21800372],"length":1,"stats":{"Line":2}},{"line":11,"address":[19274369,19274284,19274444],"length":1,"stats":{"Line":2}},{"line":13,"address":[22367065],"length":1,"stats":{"Line":1}},{"line":16,"address":[],"length":0,"stats":{"Line":2}},{"line":17,"address":[],"length":0,"stats":{"Line":2}},{"line":19,"address":[],"length":0,"stats":{"Line":1}},{"line":21,"address":[14869006,14868908,14869141],"length":1,"stats":{"Line":3}},{"line":22,"address":[],"length":0,"stats":{"Line":4}},{"line":23,"address":[],"length":0,"stats":{"Line":3}},{"line":24,"address":[14312049],"length":1,"stats":{"Line":1}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[14869428],"length":1,"stats":{"Line":0}},{"line":33,"address":[14869486,14870144,14869396],"length":1,"stats":{"Line":3}},{"line":34,"address":[14312506,14312496],"length":1,"stats":{"Line":2}},{"line":35,"address":[14312567],"length":1,"stats":{"Line":1}},{"line":36,"address":[14312557],"length":1,"stats":{"Line":1}},{"line":37,"address":[14312577],"length":1,"stats":{"Line":0}},{"line":38,"address":[14312547],"length":1,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":1}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":43,"address":[14870332],"length":1,"stats":{"Line":1}},{"line":46,"address":[14312592,14312602],"length":1,"stats":{"Line":2}},{"line":47,"address":[14312663],"length":1,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[14312633],"length":1,"stats":{"Line":1}},{"line":53,"address":[14312408],"length":1,"stats":{"Line":1}},{"line":56,"address":[14311671],"length":1,"stats":{"Line":1}},{"line":62,"address":[14870544,14880069,14871960],"length":1,"stats":{"Line":0}},{"line":68,"address":[14870629,14872226],"length":1,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[14871721,14880528,14871269,14871350,14880546],"length":1,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[14872200],"length":1,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[14872268,14871653,14872317],"length":1,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[14873719],"length":1,"stats":{"Line":0}},{"line":106,"address":[14873826,14873726],"length":1,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[14879349,14880144,14879274,14880162],"length":1,"stats":{"Line":0}},{"line":110,"address":[14879601,14879496],"length":1,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[14874091,14874877,14875668],"length":1,"stats":{"Line":0}},{"line":117,"address":[14874247,14875492,14874144],"length":1,"stats":{"Line":0}},{"line":118,"address":[14880350,14874255,14874340,14875316,14880336],"length":1,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[14880288,14880300,14874646],"length":1,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[14880108],"length":1,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[14874969],"length":1,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[14875145],"length":1,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[14875497],"length":1,"stats":{"Line":0}},{"line":155,"address":[14874949,14875727],"length":1,"stats":{"Line":0}},{"line":156,"address":[14875762,14875830],"length":1,"stats":{"Line":0}},{"line":158,"address":[14876245,14875857,14876046],"length":1,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[14875904,14875963],"length":1,"stats":{"Line":0}},{"line":211,"address":[14876000,14876206],"length":1,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[14877040,14877244,14878743],"length":1,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}}],"covered":27,"coverable":104},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","perkeep.rs"],"content":"//! Perkeep CLI commands for backup and restore\n\nuse crate::error::EngramError;\nuse crate::perkeep::{EngramBackupMetadata, PerkeepClient, PerkeepConfig, SchemaObject};\nuse crate::storage::Storage;\nuse clap::Subcommand;\nuse serde_json::Value;\n\n/// Perkeep commands\n#[derive(Subcommand)]\npub enum PerkeepCommands {\n    /// Backup entities to Perkeep server\n    Backup {\n        /// Backup all entities or specific type\n        #[arg(long)]\n        entity_type: Option\u003cString\u003e,\n\n        /// Include entity relationships\n        #[arg(long, default_value = \"true\")]\n        include_relationships: bool,\n\n        /// Backup description\n        #[arg(long)]\n        description: Option\u003cString\u003e,\n    },\n\n    /// Restore entities from Perkeep\n    Restore {\n        /// Backup blob reference to restore\n        #[arg(long)]\n        blobref: Option\u003cString\u003e,\n\n        /// Restore to specific agent\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Dry run (don't actually restore)\n        #[arg(long)]\n        dry_run: bool,\n    },\n\n    /// List available backups\n    List {\n        /// Show detailed information\n        #[arg(long)]\n        detailed: bool,\n    },\n\n    /// Check Perkeep server health\n    Health,\n\n    /// Configure Perkeep settings\n    Config {\n        /// Perkeep server URL\n        #[arg(long, short)]\n        server: Option\u003cString\u003e,\n\n        /// Authentication token\n        #[arg(long)]\n        auth_token: Option\u003cString\u003e,\n\n        /// Save to configuration file\n        #[arg(long)]\n        save: bool,\n    },\n}\n\n/// Create a Perkeep backup\npub async fn perkeep_backup\u003cS: Storage\u003e(\n    storage: \u0026S,\n    entity_type: Option\u003cString\u003e,\n    include_relationships: bool,\n    description: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let client = PerkeepClient::new(PerkeepConfig::default()).map_err(|e| {\n        EngramError::InvalidOperation(format!(\"Failed to create Perkeep client: {}\", e))\n    })?;\n\n    // Check server health\n    if !client\n        .health_check()\n        .await\n        .map_err(|e| EngramError::InvalidOperation(format!(\"Perkeep health check failed: {}\", e)))?\n    {\n        return Err(EngramError::InvalidOperation(\n            \"Perkeep server is not available\".to_string(),\n        ));\n    }\n\n    println!(\"üîê Connecting to Perkeep server...\");\n    println!(\"   Server: {}\", client.server_url());\n\n    // Query entities to backup\n    let entity_types = match \u0026entity_type {\n        Some(t) =\u003e vec![t.clone()],\n        None =\u003e vec![\n            \"task\".to_string(),\n            \"context\".to_string(),\n            \"reasoning\".to_string(),\n            \"knowledge\".to_string(),\n            \"session\".to_string(),\n        ],\n    };\n\n    let mut entity_blob_refs: std::collections::HashMap\u003cString, String\u003e =\n        std::collections::HashMap::new();\n    let mut total_size = 0u64;\n    let mut entity_count = 0usize;\n\n    println!(\"\\nüì¶ Backing up entities...\");\n\n    for et in \u0026entity_types {\n        println!(\"   Processing {}...\", et);\n\n        let ids = storage.list_ids(et)?;\n\n        for id in \u0026ids {\n            if let Ok(Some(entity)) = storage.get(\u0026id, et) {\n                let blob_data = serde_json::to_vec(\u0026entity).map_err(|e| {\n                    EngramError::InvalidOperation(format!(\"Failed to serialize entity: {}\", e))\n                })?;\n\n                let blobref = client.upload_blob(\u0026blob_data).await.map_err(|e| {\n                    EngramError::InvalidOperation(format!(\"Failed to upload {} {}: {}\", et, id, e))\n                })?;\n\n                entity_blob_refs.insert(format!(\"{}/{}\", et, id), blobref.blobref.clone());\n                total_size += blobref.size;\n                entity_count += 1;\n            }\n        }\n\n        println!(\"      ‚úì {} entities\", ids.len());\n    }\n\n    // Include relationships if requested\n    if include_relationships {\n        println!(\"   Processing relationships...\");\n\n        let rel_ids = storage.list_ids(\"relationship\")?;\n\n        for id in \u0026rel_ids {\n            if let Ok(Some(entity)) = storage.get(\u0026id, \"relationship\") {\n                let blob_data = serde_json::to_vec(\u0026entity).map_err(|e| {\n                    EngramError::InvalidOperation(format!(\n                        \"Failed to serialize relationship: {}\",\n                        e\n                    ))\n                })?;\n\n                let blobref = client.upload_blob(\u0026blob_data).await.map_err(|e| {\n                    EngramError::InvalidOperation(format!(\n                        \"Failed to upload relationship {}: {}\",\n                        id, e\n                    ))\n                })?;\n\n                entity_blob_refs.insert(format!(\"relationship/{}\", id), blobref.blobref.clone());\n                total_size += blobref.size;\n            }\n        }\n\n        println!(\"      ‚úì {} relationships\", rel_ids.len());\n    }\n\n    // Create backup metadata\n    let metadata = EngramBackupMetadata::new(\n        entity_count,\n        entity_types.clone(),\n        entity_blob_refs,\n        total_size,\n        \"default\".to_string(),\n    );\n\n    // Upload metadata\n    let metadata_schema = SchemaObject {\n        camli_type: \"engram.net/backup\".to_string(),\n        base_value_ref: None,\n        file_name: Some(format!(\n            \"engram-backup-{}.json\",\n            chrono::Utc::now().format(\"%Y%m%d-%H%M%S\")\n        )),\n        mime_type: Some(\"application/json\".to_string()),\n        size: Some(serde_json::to_vec(\u0026metadata).unwrap().len() as u64),\n        title: description.or(Some(\"Engram Backup\".to_string())),\n        description: Some(format!(\n            \"Engram backup containing {} entities\",\n            entity_count\n        )),\n        creation_time: Some(chrono::Utc::now().to_rfc3339()),\n        custom_attributes: Some(\n            serde_json::to_value(metadata.clone())\n                .unwrap()\n                .as_object()\n                .unwrap()\n                .clone()\n                .into_iter()\n                .collect(),\n        ),\n    };\n\n    let metadata_blobref = client.upload_schema(\u0026metadata_schema).await.map_err(|e| {\n        EngramError::InvalidOperation(format!(\"Failed to upload backup metadata: {}\", e))\n    })?;\n\n    println!(\"\\n‚úÖ Backup complete!\");\n    println!(\"   Entities backed up: {}\", entity_count);\n    println!(\"   Total size: {} bytes\", total_size);\n    println!(\"   Metadata blobref: {}\", metadata_blobref.blobref);\n    println!(\"\\nüí° Use this blobref to restore later:\");\n    println!(\n        \"   engram perkeep restore --blobref {}\",\n        metadata_blobref.blobref\n    );\n\n    Ok(())\n}\n\n/// Restore entities from Perkeep\npub async fn perkeep_restore\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    blobref: Option\u003cString\u003e,\n    agent: Option\u003cString\u003e,\n    dry_run: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let client = PerkeepClient::new(PerkeepConfig::default()).map_err(|e| {\n        EngramError::InvalidOperation(format!(\"Failed to create Perkeep client: {}\", e))\n    })?;\n\n    // Check server health\n    if !client\n        .health_check()\n        .await\n        .map_err(|e| EngramError::InvalidOperation(format!(\"Perkeep health check failed: {}\", e)))?\n    {\n        return Err(EngramError::InvalidOperation(\n            \"Perkeep server is not available\".to_string(),\n        ));\n    }\n\n    // Get backup blobref\n    let blobref = match blobref {\n        Some(ref b) =\u003e b.clone(),\n        None =\u003e {\n            // Find the most recent backup\n            let matches = client\n                .search_blobs(\"camliType:engram.net/backup\")\n                .await\n                .map_err(|e| {\n                    EngramError::InvalidOperation(format!(\"Failed to search backups: {}\", e))\n                })?;\n\n            if matches.is_empty() {\n                return Err(EngramError::NotFound(\n                    \"No backups found in Perkeep\".to_string(),\n                ));\n            }\n\n            matches[0].blobref.clone()\n        }\n    };\n\n    println!(\"üîê Restoring from Perkeep...\");\n    println!(\"   Backup blobref: {}\", blobref);\n\n    if dry_run {\n        println!(\"\\nÔøΩDry run mode - no changes will be made\");\n    }\n\n    // Fetch backup metadata\n    let backup_data = client\n        .fetch_blob(\u0026blobref)\n        .await\n        .map_err(|e| EngramError::InvalidOperation(format!(\"Failed to fetch backup: {}\", e)))?;\n\n    let backup_data = match backup_data {\n        Some(data) =\u003e data,\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Backup blob not found: {}\",\n                blobref\n            )));\n        }\n    };\n\n    let metadata: EngramBackupMetadata = serde_json::from_slice(\u0026backup_data).map_err(|e| {\n        EngramError::InvalidOperation(format!(\"Failed to parse backup metadata: {}\", e))\n    })?;\n\n    println!(\"\\nüìã Backup Information:\");\n    println!(\"   Version: {}\", metadata.version);\n    println!(\"   Created: {}\", metadata.timestamp);\n    println!(\"   Entities: {}\", metadata.entity_count);\n    println!(\"   Total size: {} bytes\", metadata.total_size);\n\n    if dry_run {\n        println!(\"\\nü™ß Would restore {} entities:\", metadata.entity_count);\n        for (key, _) in metadata.entity_blob_refs.iter().take(10) {\n            println!(\"   - {}\", key);\n        }\n        if metadata.entity_blob_refs.len() \u003e 10 {\n            println!(\"   ... and {} more\", metadata.entity_blob_refs.len() - 10);\n        }\n        return Ok(());\n    }\n\n    // Restore entities\n    println!(\"\\nüì¶ Restoring entities...\");\n\n    let mut restored_count = 0usize;\n\n    for (entity_key, blobref) in \u0026metadata.entity_blob_refs {\n        if let Some(data) = client.fetch_blob(blobref).await.map_err(|e| {\n            EngramError::InvalidOperation(format!(\"Failed to fetch {}: {}\", entity_key, e))\n        })? {\n            let entity: Value = serde_json::from_slice(\u0026data).map_err(|e| {\n                EngramError::InvalidOperation(format!(\n                    \"Failed to deserialize {}: {}\",\n                    entity_key, e\n                ))\n            })?;\n\n            let parts: Vec\u003c\u0026str\u003e = entity_key.split('/').collect();\n            if parts.len() \u003e= 2 {\n                let _entity_type = parts[0];\n                let _entity_id = parts[1];\n\n                let mut entity_obj = entity.as_object().unwrap().clone();\n                if let Some(agent_name) = \u0026agent {\n                    entity_obj.insert(\"agent\".to_string(), Value::String(agent_name.clone()));\n                }\n\n                let modified_entity = Value::Object(entity_obj);\n\n                let entity = match crate::entities::GenericEntity::from_value(modified_entity) {\n                    Ok(e) =\u003e e,\n                    Err(e) =\u003e {\n                        return Err(EngramError::InvalidOperation(format!(\n                            \"Failed to deserialize {}: {}\",\n                            entity_key, e\n                        )));\n                    }\n                };\n\n                storage.store(\u0026entity).map_err(|e| {\n                    EngramError::InvalidOperation(format!(\"Failed to store {}: {}\", entity_key, e))\n                })?;\n\n                restored_count += 1;\n\n                if restored_count % 10 == 0 {\n                    println!(\"   Restored {} entities...\", restored_count);\n                }\n            }\n        }\n    }\n\n    println!(\"\\n‚úÖ Restore complete!\");\n    println!(\"   Entities restored: {}\", restored_count);\n\n    Ok(())\n}\n\n/// List available backups\npub async fn perkeep_list(detailed: bool) -\u003e Result\u003c(), EngramError\u003e {\n    let client = PerkeepClient::new(PerkeepConfig::default()).map_err(|e| {\n        EngramError::InvalidOperation(format!(\"Failed to create Perkeep client: {}\", e))\n    })?;\n\n    // Check server health\n    if !client\n        .health_check()\n        .await\n        .map_err(|e| EngramError::InvalidOperation(format!(\"Perkeep health check failed: {}\", e)))?\n    {\n        return Err(EngramError::InvalidOperation(\n            \"Perkeep server is not available\".to_string(),\n        ));\n    }\n\n    // Search for backups\n    let backups = client\n        .search_blobs(\"camliType:engram.net/backup\")\n        .await\n        .map_err(|e| EngramError::InvalidOperation(format!(\"Failed to search backups: {}\", e)))?;\n\n    if backups.is_empty() {\n        println!(\"\\nüì≠ No backups found in Perkeep.\");\n        return Ok(());\n    }\n\n    println!(\"\\nüì¶ Available Backups:\");\n    println!(\"====================\");\n\n    for (i, backup) in backups.iter().enumerate() {\n        println!(\"{}. {}\", i + 1, backup.blobref);\n\n        if detailed {\n            if let Some(data) = client.fetch_blob(\u0026backup.blobref).await.ok().flatten() {\n                if let Ok(metadata) = serde_json::from_slice::\u003cEngramBackupMetadata\u003e(\u0026data) {\n                    println!(\"   Created: {}\", metadata.timestamp);\n                    println!(\"   Entities: {}\", metadata.entity_count);\n                    println!(\"   Size: {} bytes\", metadata.total_size);\n                }\n            }\n        }\n    }\n\n    Ok(())\n}\n\n/// Check Perkeep server health\npub async fn perkeep_health() -\u003e Result\u003c(), EngramError\u003e {\n    let client = PerkeepClient::new(PerkeepConfig::default()).map_err(|e| {\n        EngramError::InvalidOperation(format!(\"Failed to create Perkeep client: {}\", e))\n    })?;\n\n    let healthy = client\n        .health_check()\n        .await\n        .map_err(|e| EngramError::InvalidOperation(format!(\"Health check failed: {}\", e)))?;\n\n    if healthy {\n        println!(\"‚úÖ Perkeep server is healthy\");\n        println!(\"   Server: {}\", client.server_url());\n    } else {\n        return Err(EngramError::InvalidOperation(\n            \"Perkeep server is not responding\".to_string(),\n        ));\n    }\n\n    Ok(())\n}\n","traces":[{"line":69,"address":[14464976],"length":1,"stats":{"Line":0}},{"line":75,"address":[14465324,14465500,14465662,14465996,14480416,14480654],"length":1,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[14465937,14466218,14466410,14468422,14466307],"length":1,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[14777634],"length":1,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[14466974],"length":1,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[14467124],"length":1,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[14468178],"length":1,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[14470504,14471092],"length":1,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[14470049,14470134,14471474,14470000],"length":1,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[14480783,14480715],"length":1,"stats":{"Line":0}},{"line":123,"address":[14777660],"length":1,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[14469177,14472345,14469100,14469390],"length":1,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[14470249],"length":1,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[14470603],"length":1,"stats":{"Line":0}},{"line":140,"address":[14470656,14471064],"length":1,"stats":{"Line":0}},{"line":142,"address":[14471013,14473950,14474005,14470911],"length":1,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[14480987,14481055],"length":1,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[14481534,14481615],"length":1,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[14473418,14473200,14473248,14478165],"length":1,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[14474111],"length":1,"stats":{"Line":0}},{"line":168,"address":[14470559],"length":1,"stats":{"Line":0}},{"line":169,"address":[14470574,14474323],"length":1,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[14474391],"length":1,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[14475183,14475117],"length":1,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[14475491,14475569],"length":1,"stats":{"Line":0}},{"line":190,"address":[14475764,14475701],"length":1,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[14481846,14481914],"length":1,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[14479115],"length":1,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[14479375],"length":1,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[14482096],"length":1,"stats":{"Line":0}},{"line":226,"address":[14482424,14492398,14482762,14483096,14492160,14482600],"length":1,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[14483407,14483318,14483037,14483510,14483971],"length":1,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[14492976,14483400,14483462,14492998],"length":1,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[14483570],"length":1,"stats":{"Line":0}},{"line":242,"address":[14483609],"length":1,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[14484150,14484239,14484342,14485288,14483811,14483881],"length":1,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[14493486,14484232,14493248],"length":1,"stats":{"Line":0}},{"line":250,"address":[14493338,14493270],"length":1,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[14485174],"length":1,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[14483942,14484745],"length":1,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[14484883],"length":1,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[14485649,14485566,14484900,14485112,14488121,14485461],"length":1,"stats":{"Line":0}},{"line":272,"address":[14485058,14484915],"length":1,"stats":{"Line":0}},{"line":273,"address":[14779569],"length":1,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[14485794],"length":1,"stats":{"Line":0}},{"line":277,"address":[14485838],"length":1,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[14492432,14486349,14486499,14485915,14488090,14492675,14492681],"length":1,"stats":{"Line":0}},{"line":287,"address":[14492527,14492459],"length":1,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[14486846],"length":1,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[14487068],"length":1,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[14487695,14488016],"length":1,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[14487188,14487259],"length":1,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[14487364,14487297,14491382],"length":1,"stats":{"Line":0}},{"line":313,"address":[14779594],"length":1,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[14491364,14494139,14488683,14488922,14494145,14493840,14488774],"length":1,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[14489109,14489031],"length":1,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[14489261],"length":1,"stats":{"Line":0}},{"line":326,"address":[14489324],"length":1,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[14489507],"length":1,"stats":{"Line":0}},{"line":330,"address":[14489776,14489709,14489565,14489972],"length":1,"stats":{"Line":0}},{"line":333,"address":[14489599],"length":1,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[14490039],"length":1,"stats":{"Line":0}},{"line":338,"address":[14491044,14490087],"length":1,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[14490826,14490773],"length":1,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[14491549],"length":1,"stats":{"Line":0}},{"line":361,"address":[14491660],"length":1,"stats":{"Line":0}},{"line":365,"address":[18572976,18573773,18573038,18573112,18573176,18573205,18573155,18574476],"length":1,"stats":{"Line":0}},{"line":366,"address":[18648032,18644178,18644485,18644012,18648270,18643858],"length":1,"stats":{"Line":0}},{"line":367,"address":[20148678,20148746],"length":1,"stats":{"Line":0}},{"line":371,"address":[18633296,18633722,18632912,18633206,18633399],"length":1,"stats":{"Line":0}},{"line":372,"address":[20062814],"length":1,"stats":{"Line":0}},{"line":373,"address":[18422381,18421894,18422758,18422559,18422446],"length":1,"stats":{"Line":0}},{"line":374,"address":[20063269,20066240,20066262,20063351],"length":1,"stats":{"Line":0}},{"line":376,"address":[25303625],"length":1,"stats":{"Line":0}},{"line":377,"address":[20063459],"length":1,"stats":{"Line":0}},{"line":382,"address":[20063672,20063979,20063889,20064082,20064639],"length":1,"stats":{"Line":0}},{"line":384,"address":[25304033,25303733,25303834,25302507,25303798],"length":1,"stats":{"Line":0}},{"line":385,"address":[18636784,18634034,18636806,18633952],"length":1,"stats":{"Line":0}},{"line":387,"address":[20064190,20064257],"length":1,"stats":{"Line":0}},{"line":388,"address":[25765350,25765057],"length":1,"stats":{"Line":0}},{"line":389,"address":[15107038],"length":1,"stats":{"Line":0}},{"line":392,"address":[25765031,25765086],"length":1,"stats":{"Line":0}},{"line":393,"address":[18645857],"length":1,"stats":{"Line":0}},{"line":395,"address":[25765322,25766518,25765158],"length":1,"stats":{"Line":0}},{"line":396,"address":[18576586,18576672],"length":1,"stats":{"Line":0}},{"line":398,"address":[18647628],"length":1,"stats":{"Line":0}},{"line":399,"address":[18575404,18576875,18573184,18575432],"length":1,"stats":{"Line":0}},{"line":400,"address":[20147378,20147165,20147248],"length":1,"stats":{"Line":0}},{"line":401,"address":[18646756,18646835],"length":1,"stats":{"Line":0}},{"line":402,"address":[20065384],"length":1,"stats":{"Line":0}},{"line":403,"address":[18635488],"length":1,"stats":{"Line":0}},{"line":409,"address":[25305957],"length":1,"stats":{"Line":0}},{"line":413,"address":[15109411,15109376,15110754,15109994,15109461,15109503],"length":1,"stats":{"Line":0}},{"line":414,"address":[20067229,20068512,20067380,20068750,20067660,20067126],"length":1,"stats":{"Line":0}},{"line":415,"address":[18428106,18428038],"length":1,"stats":{"Line":0}},{"line":418,"address":[18650021,18649490,18649400,18649133,18649593],"length":1,"stats":{"Line":0}},{"line":420,"address":[20067928,20067640,20067172,20067581,20067741],"length":1,"stats":{"Line":0}},{"line":421,"address":[18579536,18578777,18578695,18579558],"length":1,"stats":{"Line":0}},{"line":423,"address":[15110389],"length":1,"stats":{"Line":0}},{"line":424,"address":[20150308,20150439],"length":1,"stats":{"Line":0}},{"line":425,"address":[20150463],"length":1,"stats":{"Line":0}},{"line":427,"address":[25768958],"length":1,"stats":{"Line":0}},{"line":428,"address":[18578885],"length":1,"stats":{"Line":0}},{"line":432,"address":[18427979],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":194},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","prompts.rs"],"content":"//! Prompts management commands\n//!\n//! Provides commands for listing and showing prompts from ENGRAM_PROMPTS_PATH.\n\nuse clap::Subcommand;\nuse std::fs;\nuse std::path::PathBuf;\n\n/// Prompts commands\n#[derive(Debug, Subcommand)]\npub enum PromptsCommands {\n    /// List all available prompts\n    List {\n        /// Category (agents, ai, compliance)\n        #[arg(long, short)]\n        category: Option\u003cString\u003e,\n\n        /// Format output (short, full)\n        #[arg(long, short, default_value = \"short\")]\n        format: String,\n    },\n    /// Show prompt details\n    Show {\n        /// Prompt name or path\n        #[arg(help = \"Prompt name or path\")]\n        name: String,\n    },\n}\n\n/// Get prompts path from environment or default\npub fn get_prompts_path() -\u003e PathBuf {\n    std::env::var(\"ENGRAM_PROMPTS_PATH\")\n        .map(PathBuf::from)\n        .unwrap_or_else(|_| PathBuf::from(\"./engram/prompts\"))\n}\n\n/// List all prompts in the prompts directory\npub fn list_prompts(category: Option\u003c\u0026str\u003e, format: \u0026str) -\u003e Result\u003c(), std::io::Error\u003e {\n    let prompts_path = get_prompts_path();\n\n    if !prompts_path.exists() {\n        println!(\"Prompts directory not found: {:?}\", prompts_path);\n        println!(\"Set ENGRAM_PROMPTS_PATH environment variable.\");\n        return Ok(());\n    }\n\n    let entries = fs::read_dir(\u0026prompts_path)?;\n\n    match format {\n        \"short\" | \"s\" =\u003e {\n            println!(\"Available Prompts:\");\n            println!(\"==================\");\n\n            for entry in entries.flatten() {\n                if entry.path().is_dir() {\n                    let name = entry.file_name().to_string_lossy().into_owned();\n\n                    if let Some(cat) = category {\n                        if name.to_lowercase() != cat.to_lowercase() {\n                            continue;\n                        }\n                    }\n\n                    // Count files in subdirectory\n                    let count = fs::read_dir(\u0026entry.path())?.flatten().count();\n                    println!(\"  - {} ({})\", name, count);\n                }\n            }\n        }\n        \"full\" | \"f\" =\u003e {\n            println!(\"Available Prompts:\");\n            println!(\"==================\");\n\n            for entry in entries.flatten() {\n                if entry.path().is_dir() {\n                    let name = entry.file_name().to_string_lossy().into_owned();\n\n                    if let Some(cat) = category {\n                        if name.to_lowercase() != cat.to_lowercase() {\n                            continue;\n                        }\n                    }\n\n                    println!(\"\\n[{}]\", name);\n                    println!(\"---\");\n\n                    let subentries = fs::read_dir(\u0026entry.path())?;\n                    for subentry in subentries.flatten().take(10) {\n                        let sub_name = subentry.file_name().to_string_lossy().into_owned();\n                        println!(\"  - {}\", sub_name);\n                    }\n\n                    let total: usize = fs::read_dir(\u0026entry.path())?.flatten().count();\n                    if total \u003e 10 {\n                        println!(\"  ... and {} more\", total - 10);\n                    }\n                }\n            }\n        }\n        _ =\u003e {\n            println!(\"Unknown format: {}. Use 'short' or 'full'.\", format);\n        }\n    }\n\n    Ok(())\n}\n\n/// Show a specific prompt\npub fn show_prompt(name: \u0026str) -\u003e Result\u003c(), std::io::Error\u003e {\n    let prompts_path = get_prompts_path();\n\n    // Try to find the prompt file\n    let prompt_path = prompts_path.join(name);\n\n    if prompt_path.exists() {\n        if prompt_path.is_file() {\n            let content = fs::read_to_string(\u0026prompt_path)?;\n            println!(\"\\nPrompt: {}\", name);\n            println!(\"========\");\n            println!(\"\\n{}\", content);\n        } else {\n            // It's a directory, list contents\n            println!(\"\\nPrompt Directory: {}\", name);\n            println!(\"===================\");\n\n            let entries = fs::read_dir(\u0026prompt_path)?;\n            for entry in entries.flatten() {\n                let file_name = entry.file_name().to_string_lossy().into_owned();\n                let file_type = if entry.path().is_dir() {\n                    \"[DIR]\"\n                } else {\n                    \"[FILE]\"\n                };\n                println!(\"  {} {}\", file_type, file_name);\n            }\n        }\n    } else {\n        // Search for matching file\n        println!(\"Searching for: {}\", name);\n\n        let search_name = name.to_lowercase();\n        let entries = fs::read_dir(\u0026prompts_path)?;\n        for entry in entries.flatten() {\n            if entry.path().is_dir() {\n                let entry_name = entry.file_name().to_string_lossy().into_owned();\n                let subentries = fs::read_dir(\u0026entry.path())?;\n                for subentry in subentries.flatten() {\n                    let sub_name = subentry.file_name().to_string_lossy().into_owned();\n                    if sub_name.to_lowercase().contains(\u0026search_name) \u0026\u0026 subentry.path().is_file() {\n                        println!(\"\\nFound: {}/{}\", entry_name, sub_name);\n                        let content = fs::read_to_string(\u0026subentry.path())?;\n                        println!(\"\\n{}\", content);\n                        return Ok(());\n                    }\n                }\n            }\n        }\n\n        println!(\"Prompt not found: {}\", name);\n        println!(\"Searched in: {:?}\", prompts_path);\n    }\n\n    Ok(())\n}\n","traces":[{"line":31,"address":[19350880],"length":1,"stats":{"Line":0}},{"line":32,"address":[19350894],"length":1,"stats":{"Line":0}},{"line":33,"address":[17107877],"length":1,"stats":{"Line":0}},{"line":34,"address":[18036880,18036864],"length":1,"stats":{"Line":0}},{"line":38,"address":[20763376,20769340,20765667],"length":1,"stats":{"Line":0}},{"line":39,"address":[26464183],"length":1,"stats":{"Line":0}},{"line":41,"address":[20121819,20121736],"length":1,"stats":{"Line":0}},{"line":42,"address":[20763582,20763639],"length":1,"stats":{"Line":0}},{"line":43,"address":[19345228],"length":1,"stats":{"Line":0}},{"line":44,"address":[26003849],"length":1,"stats":{"Line":0}},{"line":47,"address":[19345304,19345129,19350847],"length":1,"stats":{"Line":0}},{"line":50,"address":[26004206,26004122,26004032],"length":1,"stats":{"Line":0}},{"line":51,"address":[19274826,19278233],"length":1,"stats":{"Line":0}},{"line":52,"address":[19278252],"length":1,"stats":{"Line":0}},{"line":54,"address":[26007641,26007808],"length":1,"stats":{"Line":0}},{"line":55,"address":[26468559,26468719],"length":1,"stats":{"Line":0}},{"line":56,"address":[17106616],"length":1,"stats":{"Line":0}},{"line":58,"address":[26008411],"length":1,"stats":{"Line":0}},{"line":59,"address":[20768396,20768453],"length":1,"stats":{"Line":0}},{"line":65,"address":[19350267,19349933,19350730],"length":1,"stats":{"Line":0}},{"line":66,"address":[26009124],"length":1,"stats":{"Line":0}},{"line":70,"address":[19345636,19345769],"length":1,"stats":{"Line":0}},{"line":71,"address":[19334392,19334213],"length":1,"stats":{"Line":0}},{"line":72,"address":[17103055],"length":1,"stats":{"Line":0}},{"line":74,"address":[26465224,26465391],"length":1,"stats":{"Line":0}},{"line":75,"address":[19275555,19275454],"length":1,"stats":{"Line":0}},{"line":76,"address":[20764974],"length":1,"stats":{"Line":0}},{"line":78,"address":[26005293],"length":1,"stats":{"Line":0}},{"line":79,"address":[19335361,19335284],"length":1,"stats":{"Line":0}},{"line":84,"address":[19335673,19335315],"length":1,"stats":{"Line":0}},{"line":85,"address":[26005838],"length":1,"stats":{"Line":0}},{"line":87,"address":[26466555,26468168],"length":1,"stats":{"Line":0}},{"line":88,"address":[20766296,20766097],"length":1,"stats":{"Line":0}},{"line":89,"address":[26006471,26007148],"length":1,"stats":{"Line":0}},{"line":90,"address":[20767233],"length":1,"stats":{"Line":0}},{"line":93,"address":[19336943,19336424],"length":1,"stats":{"Line":0}},{"line":94,"address":[20125006],"length":1,"stats":{"Line":0}},{"line":95,"address":[19336775],"length":1,"stats":{"Line":0}},{"line":101,"address":[20764263],"length":1,"stats":{"Line":0}},{"line":105,"address":[17103005],"length":1,"stats":{"Line":0}},{"line":109,"address":[17096176,17099798,17102008],"length":1,"stats":{"Line":0}},{"line":110,"address":[25997479],"length":1,"stats":{"Line":0}},{"line":113,"address":[17096252,17096335],"length":1,"stats":{"Line":0}},{"line":115,"address":[26458334,26458417],"length":1,"stats":{"Line":0}},{"line":116,"address":[17100763,17100077,17096531],"length":1,"stats":{"Line":0}},{"line":117,"address":[20763321,20761432,20762797],"length":1,"stats":{"Line":0}},{"line":118,"address":[17101633,17101704],"length":1,"stats":{"Line":0}},{"line":119,"address":[17101773],"length":1,"stats":{"Line":0}},{"line":120,"address":[17101826],"length":1,"stats":{"Line":0}},{"line":123,"address":[19272214,19272157],"length":1,"stats":{"Line":0}},{"line":124,"address":[26462299],"length":1,"stats":{"Line":0}},{"line":126,"address":[19122280,19121080],"length":1,"stats":{"Line":0}},{"line":127,"address":[19272588,19272712,19272504],"length":1,"stats":{"Line":0}},{"line":128,"address":[19343559,19343670],"length":1,"stats":{"Line":0}},{"line":129,"address":[20762594,20762323],"length":1,"stats":{"Line":0}},{"line":130,"address":[19273319],"length":1,"stats":{"Line":0}},{"line":132,"address":[19344009],"length":1,"stats":{"Line":0}},{"line":134,"address":[19122100,19122028],"length":1,"stats":{"Line":0}},{"line":139,"address":[20757745,20757684],"length":1,"stats":{"Line":0}},{"line":141,"address":[19117318],"length":1,"stats":{"Line":0}},{"line":142,"address":[20116121,20116192,20119596],"length":1,"stats":{"Line":0}},{"line":143,"address":[19339800,19339592,19339676],"length":1,"stats":{"Line":0}},{"line":144,"address":[19269111,19269481],"length":1,"stats":{"Line":0}},{"line":145,"address":[25998996],"length":1,"stats":{"Line":0}},{"line":146,"address":[19329123,19331202],"length":1,"stats":{"Line":0}},{"line":147,"address":[17098195,17098346],"length":1,"stats":{"Line":0}},{"line":148,"address":[19119308,19119180],"length":1,"stats":{"Line":0}},{"line":149,"address":[19119501,19119731],"length":1,"stats":{"Line":0}},{"line":150,"address":[20760429],"length":1,"stats":{"Line":0}},{"line":151,"address":[19342600,19342104],"length":1,"stats":{"Line":0}},{"line":152,"address":[19330923],"length":1,"stats":{"Line":0}},{"line":153,"address":[26001115],"length":1,"stats":{"Line":0}},{"line":159,"address":[26459184],"length":1,"stats":{"Line":0}},{"line":160,"address":[17097301],"length":1,"stats":{"Line":0}},{"line":163,"address":[19118147],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":75},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","reasoning.rs"],"content":"//! Reasoning command implementations\n\nuse crate::entities::{Entity, Reasoning};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\nuse serde::Deserialize;\nuse std::fs;\nuse std::io::{self, Read};\n\n/// Reasoning input structure for JSON\n#[derive(Debug, Deserialize)]\npub struct ReasoningInput {\n    pub title: String,\n    pub task_id: String,\n    pub agent: Option\u003cString\u003e,\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n/// Reasoning commands\n#[derive(Debug, Subcommand)]\npub enum ReasoningCommands {\n    /// Create a new reasoning chain\n    Create {\n        /// Reasoning title\n        #[arg(long, short, conflicts_with_all = [\"title_stdin\", \"title_file\"])]\n        title: Option\u003cString\u003e,\n\n        /// Task ID this reasoning belongs to\n        #[arg(long)]\n        task_id: Option\u003cString\u003e,\n\n        /// Assigned agent\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Initial confidence level (0.0 to 1.0)\n        #[arg(long, short)]\n        confidence: Option\u003cf64\u003e,\n\n        /// Initial content/conclusion\n        #[arg(long, conflicts_with_all = [\"content_stdin\", \"content_file\"])]\n        content: Option\u003cString\u003e,\n\n        /// Tags (comma-separated)\n        #[arg(long)]\n        tags: Option\u003cString\u003e,\n\n        /// Read title from stdin\n        #[arg(long, conflicts_with_all = [\"title\", \"title_file\"])]\n        title_stdin: bool,\n\n        /// Read title from file\n        #[arg(long, conflicts_with_all = [\"title\", \"title_stdin\"])]\n        title_file: Option\u003cString\u003e,\n\n        /// Read content from stdin\n        #[arg(long, conflicts_with_all = [\"content\", \"content_file\"])]\n        content_stdin: bool,\n\n        /// Read content from file\n        #[arg(long, conflicts_with_all = [\"content\", \"content_stdin\"])]\n        content_file: Option\u003cString\u003e,\n\n        /// Create reasoning from JSON input (stdin or file)\n        #[arg(long, conflicts_with_all = [\"title\", \"title_stdin\", \"title_file\"])]\n        json: bool,\n\n        /// JSON file path (requires --json)\n        #[arg(long, requires = \"json\")]\n        json_file: Option\u003cString\u003e,\n    },\n    /// Add a reasoning step\n    AddStep {\n        /// Reasoning ID\n        #[arg(help = \"Reasoning ID to add step to\")]\n        id: String,\n\n        /// Step description\n        #[arg(long, short, conflicts_with_all = [\"description_stdin\", \"description_file\"])]\n        description: Option\u003cString\u003e,\n\n        /// Step conclusion\n        #[arg(long, short, conflicts_with_all = [\"conclusion_stdin\", \"conclusion_file\"])]\n        conclusion: Option\u003cString\u003e,\n\n        /// Confidence level (0.0 to 1.0)\n        #[arg(long, short = 'f')]\n        confidence: f64,\n\n        /// Read description from stdin\n        #[arg(long, conflicts_with_all = [\"description\", \"description_file\"])]\n        description_stdin: bool,\n\n        /// Read description from file\n        #[arg(long, conflicts_with_all = [\"description\", \"description_stdin\"])]\n        description_file: Option\u003cString\u003e,\n\n        /// Read conclusion from stdin\n        #[arg(long, conflicts_with_all = [\"conclusion\", \"conclusion_file\"])]\n        conclusion_stdin: bool,\n\n        /// Read conclusion from file\n        #[arg(long, conflicts_with_all = [\"conclusion\", \"conclusion_stdin\"])]\n        conclusion_file: Option\u003cString\u003e,\n    },\n    /// Set final conclusion\n    Conclude {\n        /// Reasoning ID\n        #[arg(help = \"Reasoning ID to conclude\")]\n        id: String,\n\n        /// Final conclusion\n        #[arg(long, short, conflicts_with_all = [\"conclusion_stdin\", \"conclusion_file\"])]\n        conclusion: Option\u003cString\u003e,\n\n        /// Overall confidence\n        #[arg(long, short = 'f')]\n        confidence: f64,\n\n        /// Read conclusion from stdin\n        #[arg(long, conflicts_with_all = [\"conclusion\", \"conclusion_file\"])]\n        conclusion_stdin: bool,\n\n        /// Read conclusion from file\n        #[arg(long, conflicts_with_all = [\"conclusion\", \"conclusion_stdin\"])]\n        conclusion_file: Option\u003cString\u003e,\n    },\n    /// List reasoning chains\n    List {\n        /// Filter by agent\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Filter by task ID\n        #[arg(long, short)]\n        task_id: Option\u003cString\u003e,\n\n        /// Limit number of results\n        #[arg(long, short)]\n        limit: Option\u003cusize\u003e,\n    },\n    /// Show reasoning details\n    Show {\n        /// Reasoning ID\n        #[arg(help = \"Reasoning ID to show\")]\n        id: String,\n    },\n    /// Delete reasoning\n    Delete {\n        /// Reasoning ID\n        #[arg(help = \"Reasoning ID to delete\")]\n        id: String,\n    },\n}\n\nfn read_stdin() -\u003e Result\u003cString, EngramError\u003e {\n    let mut buffer = String::new();\n    io::stdin()\n        .read_to_string(\u0026mut buffer)\n        .map_err(|e| EngramError::Io(e))?;\n    Ok(buffer.trim().to_string())\n}\n\nfn read_file(path: \u0026str) -\u003e Result\u003cString, EngramError\u003e {\n    fs::read_to_string(path).map_err(EngramError::Io)\n}\n\nfn create_reasoning_from_input\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    input: ReasoningInput,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let agent = input.agent.unwrap_or_else(|| \"default\".to_string());\n\n    let reasoning = Reasoning::new(input.title, input.task_id, agent.clone());\n\n    let generic_entity = reasoning.to_generic();\n    storage.store(\u0026generic_entity)?;\n\n    println!(\"Reasoning '{}' created successfully\", reasoning.id);\n    println!(\"ID: {}\", reasoning.id);\n    println!(\"Agent: {}\", agent);\n\n    Ok(())\n}\n\npub fn create_reasoning\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    title: Option\u003cString\u003e,\n    task_id: Option\u003cString\u003e,\n    agent: Option\u003cString\u003e,\n    confidence: Option\u003cf64\u003e,\n    content: Option\u003cString\u003e,\n    _tags: Option\u003cString\u003e,\n    title_stdin: bool,\n    title_file: Option\u003cString\u003e,\n    content_stdin: bool,\n    content_file: Option\u003cString\u003e,\n    json: bool,\n    json_file: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if json {\n        let json_content = if let Some(ref file_path) = json_file {\n            read_file(file_path)?\n        } else {\n            read_stdin()?\n        };\n\n        let reasoning_input: ReasoningInput = serde_json::from_str(\u0026json_content)\n            .map_err(|e| EngramError::Validation(format!(\"Invalid JSON: {}\", e)))?;\n\n        return create_reasoning_from_input(storage, reasoning_input);\n    }\n\n    let final_title = if title_stdin {\n        read_stdin()?\n    } else if let Some(ref file_path) = title_file {\n        read_file(file_path)?\n    } else if let Some(ref t) = title {\n        t.clone()\n    } else {\n        return Err(EngramError::Validation(\n            \"Title required: use --title, --title-stdin, or --title-file\".to_string(),\n        ));\n    };\n\n    let final_task_id = task_id\n        .ok_or_else(|| EngramError::Validation(\"Task ID required: use --task-id\".to_string()))?;\n\n    let final_agent = agent.unwrap_or_else(|| \"default\".to_string());\n\n    let mut reasoning = Reasoning::new(final_title, final_task_id, final_agent.clone());\n\n    // Set initial confidence if provided\n    if let Some(conf) = confidence {\n        reasoning.confidence = conf;\n    }\n\n    // Set initial content/conclusion if provided\n    if content_stdin {\n        reasoning.conclusion = read_stdin()?;\n    } else if let Some(ref file_path) = content_file {\n        reasoning.conclusion = read_file(file_path)?;\n    } else if let Some(ref c) = content {\n        reasoning.conclusion = c.clone();\n    }\n\n    let generic_entity = reasoning.to_generic();\n    storage.store(\u0026generic_entity)?;\n\n    println!(\"Reasoning '{}' created successfully\", reasoning.id);\n    println!(\"ID: {}\", reasoning.id);\n    println!(\"Title: {}\", reasoning.title);\n    println!(\"Task ID: {}\", reasoning.task_id);\n    println!(\"Agent: {}\", final_agent);\n\n    Ok(())\n}\n\npub fn add_reasoning_step\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    description: Option\u003cString\u003e,\n    conclusion: Option\u003cString\u003e,\n    confidence: f64,\n    description_stdin: bool,\n    description_file: Option\u003cString\u003e,\n    conclusion_stdin: bool,\n    conclusion_file: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let final_description = if description_stdin {\n        read_stdin()?\n    } else if let Some(ref file_path) = description_file {\n        read_file(file_path)?\n    } else if let Some(ref d) = description {\n        d.clone()\n    } else {\n        return Err(EngramError::Validation(\n            \"Description required: use --description, --description-stdin, or --description-file\"\n                .to_string(),\n        ));\n    };\n\n    let final_conclusion = if conclusion_stdin {\n        read_stdin()?\n    } else if let Some(ref file_path) = conclusion_file {\n        read_file(file_path)?\n    } else if let Some(ref c) = conclusion {\n        c.clone()\n    } else {\n        return Err(EngramError::Validation(\n            \"Conclusion required: use --conclusion, --conclusion-stdin, or --conclusion-file\"\n                .to_string(),\n        ));\n    };\n\n    if confidence \u003c 0.0 || confidence \u003e 1.0 {\n        return Err(EngramError::Validation(\n            \"Confidence must be between 0.0 and 1.0\".to_string(),\n        ));\n    }\n\n    let entity = storage.get(id, \"reasoning\")?;\n    match entity {\n        Some(generic_entity) =\u003e {\n            let mut reasoning = Reasoning::from_generic(generic_entity)\n                .map_err(|e| EngramError::Validation(e.to_string()))?;\n\n            reasoning.add_step(final_description, final_conclusion, confidence);\n\n            let updated_entity = reasoning.to_generic();\n            storage.store(\u0026updated_entity)?;\n\n            println!(\"Added step to reasoning '{}' successfully\", reasoning.title);\n            println!(\"Step count: {}\", reasoning.steps.len());\n        }\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Reasoning with ID '{}' not found\",\n                id\n            )));\n        }\n    }\n\n    Ok(())\n}\n\npub fn conclude_reasoning\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    conclusion: Option\u003cString\u003e,\n    confidence: f64,\n    conclusion_stdin: bool,\n    conclusion_file: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let final_conclusion = if conclusion_stdin {\n        read_stdin()?\n    } else if let Some(ref file_path) = conclusion_file {\n        read_file(file_path)?\n    } else if let Some(ref c) = conclusion {\n        c.clone()\n    } else {\n        return Err(EngramError::Validation(\n            \"Conclusion required: use --conclusion, --conclusion-stdin, or --conclusion-file\"\n                .to_string(),\n        ));\n    };\n\n    if confidence \u003c 0.0 || confidence \u003e 1.0 {\n        return Err(EngramError::Validation(\n            \"Confidence must be between 0.0 and 1.0\".to_string(),\n        ));\n    }\n\n    let entity = storage.get(id, \"reasoning\")?;\n    match entity {\n        Some(generic_entity) =\u003e {\n            let mut reasoning = Reasoning::from_generic(generic_entity)\n                .map_err(|e| EngramError::Validation(e.to_string()))?;\n\n            reasoning.set_conclusion(final_conclusion, confidence);\n\n            let updated_entity = reasoning.to_generic();\n            storage.store(\u0026updated_entity)?;\n\n            println!(\"Reasoning '{}' concluded successfully\", reasoning.title);\n            println!(\"Final confidence: {}\", reasoning.confidence);\n        }\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Reasoning with ID '{}' not found\",\n                id\n            )));\n        }\n    }\n\n    Ok(())\n}\n\npub fn list_reasoning\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent: Option\u003c\u0026str\u003e,\n    task_id: Option\u003c\u0026str\u003e,\n    limit: Option\u003cusize\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut filter = crate::storage::QueryFilter {\n        entity_type: Some(\"reasoning\".to_string()),\n        agent: agent.map(|s| s.to_string()),\n        limit,\n        ..Default::default()\n    };\n\n    if let Some(tid) = task_id {\n        filter.field_filters.insert(\n            \"task_id\".to_string(),\n            serde_json::Value::String(tid.to_string()),\n        );\n    }\n\n    let result = storage.query(\u0026filter)?;\n\n    if result.entities.is_empty() {\n        println!(\"No reasoning chains found\");\n        return Ok(());\n    }\n\n    println!(\"Found {} reasoning chain(s)\", result.entities.len());\n    println!();\n\n    for entity in result.entities {\n        if let Ok(reasoning) = Reasoning::from_generic(entity) {\n            println!(\"ID: {}\", reasoning.id);\n            println!(\"Title: {}\", reasoning.title);\n            println!(\"Task ID: {}\", reasoning.task_id);\n            println!(\"Agent: {}\", reasoning.agent);\n            println!(\"Steps: {}\", reasoning.steps.len());\n            println!(\"Confidence: {:.2}\", reasoning.confidence);\n            if !reasoning.conclusion.is_empty() {\n                println!(\"Status: Concluded\");\n            } else {\n                println!(\"Status: In Progress\");\n            }\n            println!(\n                \"Created: {}\",\n                reasoning.created_at.format(\"%Y-%m-%d %H:%M:%S\")\n            );\n            println!(\"---\");\n        }\n    }\n\n    if result.has_more {\n        println!(\"(More results available - use --limit to see more)\");\n    }\n\n    Ok(())\n}\n\npub fn show_reasoning\u003cS: Storage\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    let entity = storage.get(id, \"reasoning\")?;\n\n    match entity {\n        Some(generic_entity) =\u003e {\n            let reasoning = Reasoning::from_generic(generic_entity)\n                .map_err(|e| EngramError::Validation(e.to_string()))?;\n\n            println!(\"Reasoning Details:\");\n            println!(\"==================\");\n            println!(\"ID: {}\", reasoning.id);\n            println!(\"Title: {}\", reasoning.title);\n            println!(\"Task ID: {}\", reasoning.task_id);\n            println!(\"Agent: {}\", reasoning.agent);\n            println!(\n                \"Created: {}\",\n                reasoning.created_at.format(\"%Y-%m-%d %H:%M:%S UTC\")\n            );\n\n            if reasoning.steps.is_empty() {\n                println!(\"Steps: None\");\n            } else {\n                println!(\"Steps: {}\", reasoning.steps.len());\n                println!();\n                for (i, step) in reasoning.steps.iter().enumerate() {\n                    println!(\"Step {} (Confidence: {:.2}):\", i + 1, step.confidence);\n                    println!(\"  Description: {}\", step.description);\n                    println!(\"  Conclusion: {}\", step.conclusion);\n                    println!(\n                        \"  Created: {}\",\n                        step.timestamp.format(\"%Y-%m-%d %H:%M:%S UTC\")\n                    );\n                    if !step.evidence.is_empty() {\n                        println!(\"  Evidence: {}\", step.evidence.join(\", \"));\n                    }\n                    println!();\n                }\n            }\n\n            if reasoning.conclusion.is_empty() {\n                println!(\"Final Conclusion: Not yet concluded\");\n            } else {\n                println!(\"Final Conclusion:\");\n                println!(\"  {}\", reasoning.conclusion);\n                println!(\"  Overall Confidence: {:.2}\", reasoning.confidence);\n            }\n\n            if !reasoning.tags.is_empty() {\n                println!(\"Tags: {}\", reasoning.tags.join(\", \"));\n            }\n        }\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Reasoning with ID '{}' not found\",\n                id\n            )));\n        }\n    }\n\n    Ok(())\n}\n\npub fn delete_reasoning\u003cS: Storage\u003e(storage: \u0026mut S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    let entity = storage.get(id, \"reasoning\")?;\n\n    match entity {\n        Some(generic_entity) =\u003e {\n            let reasoning = Reasoning::from_generic(generic_entity)\n                .map_err(|e| EngramError::Validation(e.to_string()))?;\n\n            storage.delete(id, \"reasoning\")?;\n\n            println!(\"Reasoning '{}' deleted successfully\", reasoning.title);\n            println!(\"ID: {}\", reasoning.id);\n            println!(\"Task ID: {}\", reasoning.task_id);\n        }\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Reasoning with ID '{}' not found\",\n                id\n            )));\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":157,"address":[21031165,21030704,21031171],"length":1,"stats":{"Line":0}},{"line":158,"address":[26709926],"length":1,"stats":{"Line":0}},{"line":159,"address":[19579163,19579392,19579296,19579225],"length":1,"stats":{"Line":0}},{"line":160,"address":[19368737],"length":1,"stats":{"Line":0}},{"line":161,"address":[16118120,16118112],"length":1,"stats":{"Line":0}},{"line":162,"address":[19590959],"length":1,"stats":{"Line":0}},{"line":165,"address":[19579616],"length":1,"stats":{"Line":0}},{"line":166,"address":[19591159],"length":1,"stats":{"Line":0}},{"line":169,"address":[14738064,14739229,14739359],"length":1,"stats":{"Line":0}},{"line":173,"address":[14738099,14739376,14739388],"length":1,"stats":{"Line":0}},{"line":175,"address":[14739235,14738235],"length":1,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[14738731],"length":1,"stats":{"Line":0}},{"line":181,"address":[14738832],"length":1,"stats":{"Line":0}},{"line":182,"address":[14738933],"length":1,"stats":{"Line":0}},{"line":184,"address":[14739034],"length":1,"stats":{"Line":0}},{"line":187,"address":[14726268,14722064,14727957],"length":1,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[14722361,14727045,14726474],"length":1,"stats":{"Line":0}},{"line":204,"address":[14726482,14726531,14726807],"length":1,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[14727111,14727703,14726788,14727157,14727254],"length":1,"stats":{"Line":0}},{"line":210,"address":[14727134,14727206,14727984,14728011],"length":1,"stats":{"Line":0}},{"line":212,"address":[14727649,14727493],"length":1,"stats":{"Line":0}},{"line":215,"address":[14723338,14722350],"length":1,"stats":{"Line":0}},{"line":216,"address":[14726445,14722444,14723097],"length":1,"stats":{"Line":0}},{"line":217,"address":[14722410,14722474],"length":1,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[14723004,14722504,14722938],"length":1,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[14722965],"length":1,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[14722908,14723444,14728256,14728270],"length":1,"stats":{"Line":0}},{"line":230,"address":[14728364,14723598,14728352],"length":1,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[14723939],"length":1,"stats":{"Line":0}},{"line":236,"address":[14723971],"length":1,"stats":{"Line":0}},{"line":240,"address":[14725064,14723987],"length":1,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[14723998,14724059],"length":1,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[14725290],"length":1,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[14725807],"length":1,"stats":{"Line":0}},{"line":260,"address":[14734620,14734316,14730192],"length":1,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[14730440,14731071,14734564],"length":1,"stats":{"Line":0}},{"line":273,"address":[14730406,14730470],"length":1,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[14730970,14730920],"length":1,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[14730939],"length":1,"stats":{"Line":0}},{"line":284,"address":[14730862,14732238],"length":1,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[14731392,14731328],"length":1,"stats":{"Line":0}},{"line":287,"address":[14731514,14731400,14731801],"length":1,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[14731911],"length":1,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[14731862],"length":1,"stats":{"Line":0}},{"line":297,"address":[14731783,14732249],"length":1,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[14732600],"length":1,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[14734658,14733198,14734640,14733123],"length":1,"stats":{"Line":0}},{"line":309,"address":[14733361],"length":1,"stats":{"Line":0}},{"line":311,"address":[14733512],"length":1,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[14733752],"length":1,"stats":{"Line":0}},{"line":315,"address":[14733856],"length":1,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[14732815,14732908],"length":1,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[14734784,14737621,14737832],"length":1,"stats":{"Line":0}},{"line":336,"address":[14734872,14735783],"length":1,"stats":{"Line":0}},{"line":337,"address":[14735545,14737811,14734931],"length":1,"stats":{"Line":0}},{"line":338,"address":[14734958,14734897],"length":1,"stats":{"Line":0}},{"line":339,"address":[14735358,14734966,14735080],"length":1,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[14735447,14735400],"length":1,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[14735416],"length":1,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[14737693],"length":1,"stats":{"Line":0}},{"line":351,"address":[14735808],"length":1,"stats":{"Line":0}},{"line":355,"address":[14735930,14737668,14735847],"length":1,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[14736313,14736676,14736773,14737627],"length":1,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[14737088,14737020],"length":1,"stats":{"Line":0}},{"line":366,"address":[14737225],"length":1,"stats":{"Line":0}},{"line":367,"address":[14737329],"length":1,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[14736348,14736441],"length":1,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[14715245,14714128,14717726],"length":1,"stats":{"Line":0}},{"line":387,"address":[14714282],"length":1,"stats":{"Line":0}},{"line":388,"address":[14717766,14717744,14714361],"length":1,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[14714961,14715037],"length":1,"stats":{"Line":0}},{"line":396,"address":[14715045,14715110],"length":1,"stats":{"Line":0}},{"line":400,"address":[14717724,14714997,14715251],"length":1,"stats":{"Line":0}},{"line":402,"address":[14715486,14715542],"length":1,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[14715548,14715606],"length":1,"stats":{"Line":0}},{"line":408,"address":[14715718],"length":1,"stats":{"Line":0}},{"line":410,"address":[14715763,14715965],"length":1,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[14716549],"length":1,"stats":{"Line":0}},{"line":414,"address":[14716653],"length":1,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[14717002],"length":1,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[14717300],"length":1,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[14717459],"length":1,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[14716226],"length":1,"stats":{"Line":0}},{"line":435,"address":[14716195],"length":1,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[14717854],"length":1,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[14718993],"length":1,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[14719193],"length":1,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[14719401],"length":1,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[14719607],"length":1,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[14720427],"length":1,"stats":{"Line":0}},{"line":465,"address":[14720532],"length":1,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[14720844],"length":1,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[14721263,14721208],"length":1,"stats":{"Line":0}},{"line":481,"address":[14721282],"length":1,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[14721516,14721564],"length":1,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[14718303,14718396],"length":1,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[14729184,14729281,14730000,14728824],"length":1,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[14729471,14729385],"length":1,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":205},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","relationship.rs"],"content":"use crate::entities::{\n    Entity, EntityRelationType, EntityRelationship, RelationshipDirection, RelationshipFilter,\n    RelationshipStrength,\n};\nuse crate::error::EngramError;\nuse crate::storage::{RelationshipStorage, Storage, TraversalAlgorithm};\nuse clap::Subcommand;\nuse uuid::Uuid;\n\n#[derive(Debug, Clone, Subcommand)]\npub enum RelationshipCommands {\n    /// Create a new relationship between entities\n    Create {\n        /// Source entity ID\n        #[arg(long)]\n        source_id: String,\n\n        /// Source entity type\n        #[arg(long)]\n        source_type: String,\n\n        /// Target entity ID\n        #[arg(long)]\n        target_id: String,\n\n        /// Target entity type\n        #[arg(long)]\n        target_type: String,\n\n        /// Relationship type\n        #[arg(long, value_parser = parse_relationship_type)]\n        relationship_type: EntityRelationType,\n\n        /// Relationship direction (unidirectional, bidirectional, inverse)\n        #[arg(long, default_value = \"unidirectional\")]\n        direction: String,\n\n        /// Relationship strength (weak, medium, strong, critical, or custom 0.0-1.0)\n        #[arg(long, default_value = \"medium\")]\n        strength: String,\n\n        /// Optional description\n        #[arg(long)]\n        description: Option\u003cString\u003e,\n\n        /// Agent creating the relationship\n        #[arg(long)]\n        agent: String,\n    },\n\n    /// List relationships with filtering\n    List {\n        /// Filter by entity ID (either source or target)\n        #[arg(long)]\n        entity_id: Option\u003cString\u003e,\n\n        /// Filter by source entity ID\n        #[arg(long)]\n        source_id: Option\u003cString\u003e,\n\n        /// Filter by target entity ID\n        #[arg(long)]\n        target_id: Option\u003cString\u003e,\n\n        /// Filter by relationship type\n        #[arg(long, value_parser = parse_relationship_type)]\n        relationship_type: Option\u003cEntityRelationType\u003e,\n\n        /// Filter by direction\n        #[arg(long)]\n        direction: Option\u003cString\u003e,\n\n        /// Show only active relationships\n        #[arg(long)]\n        active_only: bool,\n\n        /// Filter by agent\n        #[arg(long)]\n        agent: Option\u003cString\u003e,\n    },\n\n    /// Show relationship details\n    Get {\n        /// Relationship ID\n        id: String,\n    },\n\n    Delete {\n        /// Relationship ID\n        id: String,\n\n        /// Agent performing the deletion\n        #[arg(long)]\n        agent: String,\n    },\n\n    /// Find paths between entities\n    FindPath {\n        /// Source entity ID\n        #[arg(long)]\n        source_id: String,\n\n        /// Target entity ID\n        #[arg(long)]\n        target_id: String,\n\n        /// Traversal algorithm (bfs, dfs, dijkstra)\n        #[arg(long, default_value = \"dijkstra\")]\n        algorithm: String,\n\n        /// Maximum depth for search\n        #[arg(long)]\n        max_depth: Option\u003cusize\u003e,\n    },\n\n    /// Get all entities connected to a given entity\n    Connected {\n        /// Entity ID to start from\n        #[arg(long)]\n        entity_id: String,\n\n        /// Traversal algorithm (bfs, dfs)\n        #[arg(long, default_value = \"bfs\")]\n        algorithm: String,\n\n        /// Maximum depth for traversal\n        #[arg(long)]\n        max_depth: Option\u003cusize\u003e,\n    },\n\n    /// Show relationship statistics\n    Stats {},\n}\n\nfn parse_relationship_type(s: \u0026str) -\u003e Result\u003cEntityRelationType, String\u003e {\n    match s.to_lowercase().as_str() {\n        \"depends_on\" | \"depends-on\" =\u003e Ok(EntityRelationType::DependsOn),\n        \"contains\" =\u003e Ok(EntityRelationType::Contains),\n        \"references\" =\u003e Ok(EntityRelationType::References),\n        \"fulfills\" =\u003e Ok(EntityRelationType::Fulfills),\n        \"implements\" =\u003e Ok(EntityRelationType::Implements),\n        \"supersedes\" =\u003e Ok(EntityRelationType::Supersedes),\n        \"associated_with\" | \"associated-with\" =\u003e Ok(EntityRelationType::AssociatedWith),\n        \"influences\" =\u003e Ok(EntityRelationType::Influences),\n        custom =\u003e Ok(EntityRelationType::Custom(custom.to_string())),\n    }\n}\n\nfn parse_direction(s: \u0026str) -\u003e Result\u003cRelationshipDirection, String\u003e {\n    match s.to_lowercase().as_str() {\n        \"unidirectional\" | \"uni\" =\u003e Ok(RelationshipDirection::Unidirectional),\n        \"bidirectional\" | \"bi\" =\u003e Ok(RelationshipDirection::Bidirectional),\n        \"inverse\" | \"inv\" =\u003e Ok(RelationshipDirection::Inverse),\n        _ =\u003e Err(format!(\n            \"Invalid direction: {}. Use: unidirectional, bidirectional, or inverse\",\n            s\n        )),\n    }\n}\n\nfn parse_strength(s: \u0026str) -\u003e Result\u003cRelationshipStrength, String\u003e {\n    match s.to_lowercase().as_str() {\n        \"weak\" =\u003e Ok(RelationshipStrength::Weak),\n        \"medium\" =\u003e Ok(RelationshipStrength::Medium),\n        \"strong\" =\u003e Ok(RelationshipStrength::Strong),\n        \"critical\" =\u003e Ok(RelationshipStrength::Critical),\n        custom =\u003e {\n            if let Ok(value) = custom.parse::\u003cf64\u003e() {\n                if value \u003e= 0.0 \u0026\u0026 value \u003c= 1.0 {\n                    Ok(RelationshipStrength::Custom(value))\n                } else {\n                    Err(\"Custom strength must be between 0.0 and 1.0\".to_string())\n                }\n            } else {\n                Err(format!(\"Invalid strength: {}. Use: weak, medium, strong, critical, or a number between 0.0 and 1.0\", s))\n            }\n        }\n    }\n}\n\nfn parse_algorithm(s: \u0026str) -\u003e Result\u003cTraversalAlgorithm, String\u003e {\n    match s.to_lowercase().as_str() {\n        \"bfs\" | \"breadth_first\" | \"breadth-first\" =\u003e Ok(TraversalAlgorithm::BreadthFirst),\n        \"dfs\" | \"depth_first\" | \"depth-first\" =\u003e Ok(TraversalAlgorithm::DepthFirst),\n        \"dijkstra\" =\u003e Ok(TraversalAlgorithm::Dijkstra),\n        _ =\u003e Err(format!(\n            \"Invalid algorithm: {}. Use: bfs, dfs, or dijkstra\",\n            s\n        )),\n    }\n}\n\npub fn handle_relationship_command\u003cS: RelationshipStorage\u003e(\n    storage: \u0026mut S,\n    command: RelationshipCommands,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        RelationshipCommands::Create {\n            source_id,\n            source_type,\n            target_id,\n            target_type,\n            relationship_type,\n            direction,\n            strength,\n            description,\n            agent,\n        } =\u003e create_relationship(\n            storage,\n            source_id,\n            source_type,\n            target_id,\n            target_type,\n            relationship_type,\n            direction,\n            strength,\n            description,\n            agent,\n        ),\n\n        RelationshipCommands::List {\n            entity_id,\n            source_id,\n            target_id,\n            relationship_type,\n            direction,\n            active_only,\n            agent,\n        } =\u003e list_relationships(\n            storage,\n            entity_id,\n            source_id,\n            target_id,\n            relationship_type,\n            direction,\n            active_only,\n            agent,\n        ),\n\n        RelationshipCommands::Get { id } =\u003e show_relationship(storage, \u0026id),\n\n        RelationshipCommands::Delete { id, agent } =\u003e delete_relationship(storage, \u0026id, \u0026agent),\n\n        RelationshipCommands::FindPath {\n            source_id,\n            target_id,\n            algorithm,\n            max_depth,\n        } =\u003e find_path(storage, \u0026source_id, \u0026target_id, \u0026algorithm, max_depth),\n\n        RelationshipCommands::Connected {\n            entity_id,\n            algorithm,\n            max_depth,\n        } =\u003e show_connected(storage, \u0026entity_id, \u0026algorithm, max_depth),\n\n        RelationshipCommands::Stats {} =\u003e show_stats(storage),\n    }\n}\n\nfn create_relationship\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    source_id: String,\n    source_type: String,\n    target_id: String,\n    target_type: String,\n    relationship_type: EntityRelationType,\n    direction_str: String,\n    strength_str: String,\n    description: Option\u003cString\u003e,\n    agent: String,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let id = Uuid::new_v4().to_string();\n    let direction =\n        parse_direction(\u0026direction_str).map_err(|e| EngramError::Validation(e.to_string()))?;\n    let strength =\n        parse_strength(\u0026strength_str).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n    let mut relationship = EntityRelationship::new(\n        id,\n        agent,\n        source_id,\n        source_type,\n        target_id,\n        target_type,\n        relationship_type,\n    )\n    .with_direction(direction)\n    .with_strength(strength);\n\n    if let Some(desc) = description {\n        relationship = relationship.with_description(desc);\n    }\n\n    relationship\n        .validate_entity()\n        .map_err(|e| EngramError::Validation(e.to_string()))?;\n\n    let generic = relationship.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"‚úÖ Relationship created successfully\");\n    println!(\"üìã ID: {}\", relationship.id);\n    println!(\n        \"üîó {} --[{}]--\u003e {}\",\n        relationship.source_id, relationship.relationship_type, relationship.target_id\n    );\n\n    Ok(())\n}\n\nfn list_relationships\u003cS: Storage\u003e(\n    _storage: \u0026S,\n    entity_id: Option\u003cString\u003e,\n    source_id: Option\u003cString\u003e,\n    target_id: Option\u003cString\u003e,\n    relationship_type: Option\u003cEntityRelationType\u003e,\n    direction: Option\u003cString\u003e,\n    active_only: bool,\n    agent: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut filter = RelationshipFilter::new();\n\n    if let Some(entity) = entity_id {\n        filter = filter.entity(entity);\n    }\n    if let Some(source) = source_id {\n        filter = filter.source(source);\n    }\n    if let Some(target) = target_id {\n        filter = filter.target(target);\n    }\n    if let Some(rel_type) = relationship_type {\n        filter = filter.relationship_type(rel_type);\n    }\n    if let Some(dir_str) = direction {\n        let dir = parse_direction(\u0026dir_str).map_err(|e| EngramError::Validation(e.to_string()))?;\n        filter = filter.direction(dir);\n    }\n    if active_only {\n        filter = filter.active_only();\n    }\n    if let Some(ag) = agent {\n        filter.agent = Some(ag);\n    }\n\n    let relationships = _storage.get_all(\"relationship\")?;\n\n    println!(\"üîó Entity Relationships\");\n    println!(\"======================\");\n\n    if relationships.is_empty() {\n        println!(\"No relationships found matching the criteria.\");\n        return Ok(());\n    }\n\n    println!(\"Found {} relationship(s):\\n\", relationships.len());\n\n    for (i, rel_generic) in relationships.iter().enumerate() {\n        // Parse the generic entity back to relationship\n        if let Ok(rel_data) = serde_json::from_value::\u003cEntityRelationship\u003e(rel_generic.data.clone())\n        {\n            if filter.matches(\u0026rel_data) {\n                println!(\n                    \"{}. {} [{}]\",\n                    i + 1,\n                    rel_data.id,\n                    if rel_data.active {\n                        \"ACTIVE\"\n                    } else {\n                        \"INACTIVE\"\n                    }\n                );\n                println!(\n                    \"   üîó {} --[{}]--\u003e {}\",\n                    rel_data.source_id, rel_data.relationship_type, rel_data.target_id\n                );\n                println!(\n                    \"   üìä Direction: {:?} | Strength: {:.2}\",\n                    rel_data.direction,\n                    rel_data.strength.weight()\n                );\n                println!(\n                    \"   üë§ Agent: {} | üìÖ Created: {}\",\n                    rel_data.agent,\n                    rel_data.timestamp.format(\"%Y-%m-%d %H:%M\")\n                );\n                if let Some(desc) = \u0026rel_data.description {\n                    println!(\"   üìù Description: {}\", desc);\n                }\n                println!();\n            }\n        }\n    }\n\n    Ok(())\n}\n\nfn show_relationship\u003cS: Storage\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    let relationship = storage.get(id, \"relationship\")?;\n\n    match relationship {\n        Some(rel_generic) =\u003e {\n            if let Ok(rel_data) =\n                serde_json::from_value::\u003cEntityRelationship\u003e(rel_generic.data.clone())\n            {\n                println!(\"üîó Relationship Details\");\n                println!(\"======================\");\n                println!(\"üìã ID: {}\", rel_data.id);\n                println!(\n                    \"üîó {} --[{}]--\u003e {}\",\n                    rel_data.source_id, rel_data.relationship_type, rel_data.target_id\n                );\n                println!(\"üìä Direction: {:?}\", rel_data.direction);\n                println!(\n                    \"üí™ Strength: {:?} ({:.2})\",\n                    rel_data.strength,\n                    rel_data.strength.weight()\n                );\n                println!(\n                    \"üè∑Ô∏è Source Type: {} | Target Type: {}\",\n                    rel_data.source_type, rel_data.target_type\n                );\n                println!(\"‚úÖ Active: {}\", rel_data.active);\n                println!(\"üë§ Agent: {}\", rel_data.agent);\n                println!(\n                    \"üìÖ Created: {}\",\n                    rel_data.timestamp.format(\"%Y-%m-%d %H:%M:%S\")\n                );\n\n                if let Some(desc) = \u0026rel_data.description {\n                    println!(\"üìù Description: {}\", desc);\n                }\n\n                if !rel_data.metadata.is_empty() {\n                    println!(\"üìÑ Metadata:\");\n                    for (key, value) in \u0026rel_data.metadata {\n                        println!(\"   - {}: {}\", key, value);\n                    }\n                }\n\n                println!(\"‚öôÔ∏è Constraints:\");\n                if let Some(max_out) = rel_data.constraints.max_outbound {\n                    println!(\"   - Max outbound: {}\", max_out);\n                }\n                if let Some(max_in) = rel_data.constraints.max_inbound {\n                    println!(\"   - Max inbound: {}\", max_in);\n                }\n                println!(\"   - Allow cycles: {}\", rel_data.constraints.allow_cycles);\n\n                Ok(())\n            } else {\n                Err(EngramError::Validation(format!(\n                    \"Invalid relationship data for ID: {}\",\n                    id\n                )))\n            }\n        }\n        None =\u003e {\n            println!(\"‚ùå Relationship not found: {}\", id);\n            Err(EngramError::NotFound(format!(\n                \"Relationship with ID '{}' not found\",\n                id\n            )))\n        }\n    }\n}\n\nfn delete_relationship\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    _agent: \u0026str,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let relationship = storage.get(id, \"relationship\")?;\n\n    match relationship {\n        Some(_) =\u003e {\n            storage.delete(id, \"relationship\")?;\n            println!(\"‚úÖ Relationship deleted successfully: {}\", id);\n            Ok(())\n        }\n        None =\u003e {\n            println!(\"‚ùå Relationship not found: {}\", id);\n            Err(EngramError::NotFound(format!(\n                \"Relationship with ID '{}' not found\",\n                id\n            )))\n        }\n    }\n}\n\nfn find_path\u003cS: RelationshipStorage\u003e(\n    storage: \u0026S,\n    source_id: \u0026str,\n    target_id: \u0026str,\n    algorithm_str: \u0026str,\n    max_depth: Option\u003cusize\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let algorithm =\n        parse_algorithm(algorithm_str).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n    println!(\n        \"üîç Finding path from {} to {} using {:?}\",\n        source_id, target_id, algorithm\n    );\n\n    if let Some(depth) = max_depth {\n        println!(\"üìä Maximum depth: {}\", depth);\n    }\n\n    match storage.find_paths(source_id, target_id, algorithm, max_depth) {\n        Ok(paths) =\u003e {\n            if paths.is_empty() {\n                println!(\"‚ùå No path found between {} and {}\", source_id, target_id);\n            } else {\n                println!(\"‚úÖ Found {} path(s):\", paths.len());\n                for (i, path) in paths.iter().enumerate() {\n                    println!(\"üõ§Ô∏è  Path {}: {}\", i + 1, path.entities.join(\" ‚Üí \"));\n                    println!(\"   Weight: {:.2}\", path.total_weight);\n                }\n            }\n        }\n        Err(e) =\u003e {\n            println!(\"‚ùå Error finding paths: {}\", e);\n            return Err(e);\n        }\n    }\n\n    Ok(())\n}\n\nfn show_connected\u003cS: RelationshipStorage\u003e(\n    storage: \u0026S,\n    entity_id: \u0026str,\n    algorithm_str: \u0026str,\n    max_depth: Option\u003cusize\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let algorithm =\n        parse_algorithm(algorithm_str).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n    println!(\n        \"üï∏Ô∏è Finding entities connected to {} using {:?}\",\n        entity_id, algorithm\n    );\n\n    if let Some(depth) = max_depth {\n        println!(\"üìä Maximum depth: {}\", depth);\n    }\n\n    match storage.get_connected_entities(entity_id, algorithm, max_depth) {\n        Ok(connected) =\u003e {\n            if connected.is_empty() {\n                println!(\"‚ùå No connected entities found for {}\", entity_id);\n            } else {\n                println!(\"‚úÖ Found {} connected entities:\", connected.len());\n                for entity in connected {\n                    println!(\"üîó {}\", entity);\n                }\n            }\n        }\n        Err(e) =\u003e {\n            println!(\"‚ùå Error finding connected entities: {}\", e);\n            return Err(e);\n        }\n    }\n\n    Ok(())\n}\n\nfn show_stats\u003cS: RelationshipStorage\u003e(storage: \u0026S) -\u003e Result\u003c(), EngramError\u003e {\n    println!(\"üìä Relationship Statistics\");\n    println!(\"========================\");\n\n    match storage.get_relationship_stats() {\n        Ok(stats) =\u003e {\n            println!(\"üìà Total relationships: {}\", stats.total_relationships);\n            println!(\n                \"üîÑ Bidirectional relationships: {}\",\n                stats.bidirectional_count\n            );\n            println!(\n                \"‚öñÔ∏è  Average connections per entity: {:.2}\",\n                stats.average_connections_per_entity\n            );\n            println!(\"üîó Relationship density: {:.2}\", stats.relationship_density);\n\n            println!(\"\\nüìã Relationships by type:\");\n            for (rel_type, count) in \u0026stats.relationships_by_type {\n                println!(\"   - {:?}: {}\", rel_type, count);\n            }\n\n            if let Some(most_connected) = \u0026stats.most_connected_entity {\n                println!(\n                    \"\\nüåü Most connected entity: {} ({} connections)\",\n                    most_connected.0, most_connected.1\n                );\n            }\n        }\n        Err(e) =\u003e {\n            println!(\"‚ùå Error retrieving statistics: {}\", e);\n            return Err(e);\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":135,"address":[21184064,21185343,21185349],"length":1,"stats":{"Line":0}},{"line":136,"address":[20310705,20310797],"length":1,"stats":{"Line":0}},{"line":137,"address":[26969405],"length":1,"stats":{"Line":0}},{"line":138,"address":[20240277,20240206],"length":1,"stats":{"Line":0}},{"line":139,"address":[20311115,20311017,20311159],"length":1,"stats":{"Line":0}},{"line":140,"address":[20089213,20089115,20089257],"length":1,"stats":{"Line":0}},{"line":141,"address":[20311245,20311343,20311387],"length":1,"stats":{"Line":0}},{"line":142,"address":[21184849,21184893,21184751],"length":1,"stats":{"Line":0}},{"line":143,"address":[14091345,14091443],"length":1,"stats":{"Line":0}},{"line":144,"address":[21185160,21185093],"length":1,"stats":{"Line":0}},{"line":145,"address":[21185228,21185136],"length":1,"stats":{"Line":0}},{"line":149,"address":[14090523,14090517,14089856],"length":1,"stats":{"Line":0}},{"line":150,"address":[21750161,21750059],"length":1,"stats":{"Line":0}},{"line":151,"address":[21183521],"length":1,"stats":{"Line":0}},{"line":152,"address":[20088226],"length":1,"stats":{"Line":0}},{"line":153,"address":[21183747],"length":1,"stats":{"Line":0}},{"line":154,"address":[21183855],"length":1,"stats":{"Line":0}},{"line":161,"address":[21749274,21748400,21749280],"length":1,"stats":{"Line":0}},{"line":162,"address":[20237713,20237611],"length":1,"stats":{"Line":0}},{"line":163,"address":[27427761,27427832],"length":1,"stats":{"Line":0}},{"line":164,"address":[21748711,21748667,21748604],"length":1,"stats":{"Line":0}},{"line":165,"address":[14088507,14088570,14088614],"length":1,"stats":{"Line":0}},{"line":166,"address":[27428025,27428062,27427962],"length":1,"stats":{"Line":0}},{"line":168,"address":[20086777,20087205,20086881,20086829],"length":1,"stats":{"Line":0}},{"line":169,"address":[26967496,26967591,26967541],"length":1,"stats":{"Line":0}},{"line":170,"address":[21182381],"length":1,"stats":{"Line":0}},{"line":172,"address":[20308929,20309022],"length":1,"stats":{"Line":0}},{"line":175,"address":[20297347,20297561],"length":1,"stats":{"Line":0}},{"line":181,"address":[21182640,21183350,21183344],"length":1,"stats":{"Line":0}},{"line":182,"address":[21749323,21749425],"length":1,"stats":{"Line":0}},{"line":183,"address":[20297873],"length":1,"stats":{"Line":0}},{"line":184,"address":[21182941],"length":1,"stats":{"Line":0}},{"line":185,"address":[20309705,20309775],"length":1,"stats":{"Line":0}},{"line":186,"address":[20238975,20239029],"length":1,"stats":{"Line":0}},{"line":193,"address":[15064992,15066508],"length":1,"stats":{"Line":0}},{"line":197,"address":[15065042],"length":1,"stats":{"Line":0}},{"line":198,"address":[15065314],"length":1,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[15066168],"length":1,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[15066274],"length":1,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[15062706,15060128,15063495],"length":1,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[15060758,15062756,15063824,15063842],"length":1,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[15061081],"length":1,"stats":{"Line":0}},{"line":282,"address":[15061113],"length":1,"stats":{"Line":0}},{"line":283,"address":[15061144],"length":1,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[15061206],"length":1,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[15061398],"length":1,"stats":{"Line":0}},{"line":291,"address":[15061441,15061689],"length":1,"stats":{"Line":0}},{"line":292,"address":[15061512,15061655],"length":1,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[15061954,15061883],"length":1,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[15062136],"length":1,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[15062471],"length":1,"stats":{"Line":0}},{"line":312,"address":[15054288,15056144,15059947],"length":1,"stats":{"Line":0}},{"line":322,"address":[15054429],"length":1,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[15054728,15054903],"length":1,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[15055175,15055086,15055382],"length":1,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[15055926,15055947],"length":1,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[15056598,15056158,15056335],"length":1,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[15056603,15056425,15059244],"length":1,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[15056949],"length":1,"stats":{"Line":0}},{"line":353,"address":[15059188,15057003],"length":1,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[15057040,15056976],"length":1,"stats":{"Line":0}},{"line":359,"address":[15057160],"length":1,"stats":{"Line":0}},{"line":361,"address":[15057429,15057658,15057533],"length":1,"stats":{"Line":0}},{"line":363,"address":[15057665,15057736],"length":1,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[15058647,15058590],"length":1,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[15050713],"length":1,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[15051461,15051390],"length":1,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[15051463,15051533],"length":1,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[15051597],"length":1,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[15052040],"length":1,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[15052256],"length":1,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[15052676],"length":1,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[15052912,15052962],"length":1,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[15053475],"length":1,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[15053627,15053540],"length":1,"stats":{"Line":0}},{"line":447,"address":[15053713,15053651],"length":1,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[15053858],"length":1,"stats":{"Line":0}},{"line":453,"address":[15053984,15051403],"length":1,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[15064966,15063968,15064972],"length":1,"stats":{"Line":0}},{"line":474,"address":[15064023],"length":1,"stats":{"Line":0}},{"line":476,"address":[15064229],"length":1,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[15064267,15064685],"length":1,"stats":{"Line":0}},{"line":479,"address":[15064827],"length":1,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[15064459],"length":1,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[15069401,15067408,15069540],"length":1,"stats":{"Line":0}},{"line":499,"address":[15067549,15069728,15069746],"length":1,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[15068320],"length":1,"stats":{"Line":0}},{"line":513,"address":[15068352,15068423],"length":1,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[15069272],"length":1,"stats":{"Line":0}},{"line":523,"address":[15068234],"length":1,"stats":{"Line":0}},{"line":524,"address":[15068290,15069594],"length":1,"stats":{"Line":0}},{"line":525,"address":[15069663],"length":1,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[15048464,15049972,15050103],"length":1,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[15048924],"length":1,"stats":{"Line":0}},{"line":550,"address":[15049042],"length":1,"stats":{"Line":0}},{"line":551,"address":[15049203],"length":1,"stats":{"Line":0}},{"line":552,"address":[15049311,15049243],"length":1,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[15049493,15049695],"length":1,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[15050176,15049173],"length":1,"stats":{"Line":0}},{"line":563,"address":[15050245],"length":1,"stats":{"Line":0}},{"line":567,"address":[15050065],"length":1,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[15046814],"length":1,"stats":{"Line":0}},{"line":572,"address":[15046843],"length":1,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[15047378],"length":1,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[15047634],"length":1,"stats":{"Line":0}},{"line":588,"address":[15047679],"length":1,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[15047896],"length":1,"stats":{"Line":0}},{"line":593,"address":[15047949,15048030],"length":1,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":283},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","rule.rs"],"content":"use crate::entities::{Entity, Rule, RulePriority, RuleStatus, RuleType};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\n\n/// Rule commands\n#[derive(Debug, Subcommand)]\npub enum RuleCommands {\n    /// Create a new rule\n    Create {\n        /// Rule title\n        #[arg(long, short)]\n        title: String,\n\n        /// Rule description\n        #[arg(long)]\n        description: Option\u003cString\u003e,\n\n        /// Rule type (validation, transformation, enforcement, notification)\n        #[arg(long, default_value = \"validation\")]\n        rule_type: String,\n\n        /// Priority level (low, medium, high, critical)\n        #[arg(long, default_value = \"medium\")]\n        priority: String,\n\n        /// Entity types (comma-separated)\n        #[arg(long)]\n        entity_types: Option\u003cString\u003e,\n\n        /// Rule condition (JSON)\n        #[arg(long, default_value = \"{}\")]\n        condition: String,\n\n        /// Rule action (JSON)\n        #[arg(long, default_value = \"{}\")]\n        action: String,\n\n        /// Agent to assign\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n    },\n    /// Get rule details\n    Get {\n        /// Rule ID\n        #[arg(help = \"Rule ID to retrieve\")]\n        id: String,\n    },\n    /// Update rule\n    Update {\n        /// Rule ID\n        #[arg(help = \"Rule ID to update\")]\n        id: String,\n\n        /// Rule title\n        #[arg(long)]\n        title: Option\u003cString\u003e,\n\n        /// Rule description\n        #[arg(long)]\n        description: Option\u003cString\u003e,\n\n        /// Rule type\n        #[arg(long)]\n        rule_type: Option\u003cString\u003e,\n\n        /// Priority level\n        #[arg(long)]\n        priority: Option\u003cString\u003e,\n\n        /// Entity types (comma-separated)\n        #[arg(long)]\n        entity_types: Option\u003cString\u003e,\n\n        /// Rule condition (JSON)\n        #[arg(long)]\n        condition: Option\u003cString\u003e,\n\n        /// Rule action (JSON)\n        #[arg(long)]\n        action: Option\u003cString\u003e,\n\n        /// Rule status (active, inactive, deprecated)\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n    },\n    /// Delete rule\n    Delete {\n        /// Rule ID\n        #[arg(help = \"Rule ID to delete\")]\n        id: String,\n    },\n    /// List rules\n    List {\n        /// Rule type filter\n        #[arg(long)]\n        rule_type: Option\u003cString\u003e,\n\n        /// Priority filter\n        #[arg(long)]\n        priority: Option\u003cString\u003e,\n\n        /// Entity type filter\n        #[arg(long)]\n        entity_type: Option\u003cString\u003e,\n\n        /// Status filter\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n\n        /// Text search\n        #[arg(long)]\n        search: Option\u003cString\u003e,\n\n        /// Limit results\n        #[arg(long, default_value = \"20\")]\n        limit: usize,\n\n        /// Offset for pagination\n        #[arg(long, default_value = \"0\")]\n        offset: usize,\n    },\n    /// Execute rule\n    Execute {\n        /// Rule ID\n        #[arg(help = \"Rule ID to execute\")]\n        id: String,\n\n        /// Target entity ID\n        #[arg(long)]\n        entity_id: String,\n\n        /// Target entity type\n        #[arg(long)]\n        entity_type: String,\n    },\n}\n\n/// Create a new rule\npub fn create_rule\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    title: String,\n    description: Option\u003cString\u003e,\n    rule_type: String,\n    priority: String,\n    entity_types: Option\u003cString\u003e,\n    condition: String,\n    action: String,\n    agent: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let rule_type = match rule_type.to_lowercase().as_str() {\n        \"validation\" =\u003e RuleType::Validation,\n        \"transformation\" =\u003e RuleType::Transformation,\n        \"enforcement\" =\u003e RuleType::Enforcement,\n        \"notification\" =\u003e RuleType::Notification,\n        _ =\u003e {\n            println!(\n                \"‚ùå Invalid rule type. Use: validation, transformation, enforcement, notification\"\n            );\n            return Ok(());\n        }\n    };\n\n    let priority = match priority.to_lowercase().as_str() {\n        \"low\" =\u003e RulePriority::Low,\n        \"medium\" =\u003e RulePriority::Medium,\n        \"high\" =\u003e RulePriority::High,\n        \"critical\" =\u003e RulePriority::Critical,\n        _ =\u003e {\n            println!(\"‚ùå Invalid priority. Use: low, medium, high, critical\");\n            return Ok(());\n        }\n    };\n\n    let condition_json: serde_json::Value = serde_json::from_str(\u0026condition)\n        .map_err(|e| EngramError::Validation(format!(\"Invalid JSON in condition: {}\", e)))?;\n\n    let action_json: serde_json::Value = serde_json::from_str(\u0026action)\n        .map_err(|e| EngramError::Validation(format!(\"Invalid JSON in action: {}\", e)))?;\n\n    let mut rule = Rule::new(\n        title,\n        description.unwrap_or_default(),\n        rule_type,\n        priority,\n        agent.unwrap_or_else(|| \"cli\".to_string()),\n        condition_json,\n        action_json,\n    );\n\n    if let Some(entity_types_str) = entity_types {\n        let types: Vec\u003cString\u003e = entity_types_str\n            .split(',')\n            .map(|s| s.trim().to_string())\n            .filter(|s| !s.is_empty())\n            .collect();\n        rule.entity_types = types;\n    }\n\n    let generic = rule.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"‚úÖ Rule created: {}\", rule.id());\n    display_rule(\u0026rule);\n\n    Ok(())\n}\n\n/// Get rule details\npub fn get_rule\u003cS: Storage\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"rule\")? {\n        let rule =\n            Rule::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        display_rule(\u0026rule);\n    } else {\n        println!(\"‚ùå Rule not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Update rule\npub fn update_rule\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    title: Option\u003cString\u003e,\n    description: Option\u003cString\u003e,\n    rule_type: Option\u003cString\u003e,\n    priority: Option\u003cString\u003e,\n    entity_types: Option\u003cString\u003e,\n    condition: Option\u003cString\u003e,\n    action: Option\u003cString\u003e,\n    status: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"rule\")? {\n        let mut rule =\n            Rule::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        let mut updated = false;\n\n        if let Some(title) = title {\n            rule.title = title;\n            updated = true;\n        }\n\n        if let Some(description) = description {\n            rule.description = description;\n            updated = true;\n        }\n\n        if let Some(rule_type_str) = rule_type {\n            let new_rule_type = match rule_type_str.to_lowercase().as_str() {\n                \"validation\" =\u003e RuleType::Validation,\n                \"transformation\" =\u003e RuleType::Transformation,\n                \"enforcement\" =\u003e RuleType::Enforcement,\n                \"notification\" =\u003e RuleType::Notification,\n                _ =\u003e {\n                    println!(\"‚ùå Invalid rule type. Use: validation, transformation, enforcement, notification\");\n                    return Ok(());\n                }\n            };\n            rule.rule_type = new_rule_type;\n            updated = true;\n        }\n\n        if let Some(priority_str) = priority {\n            let new_priority = match priority_str.to_lowercase().as_str() {\n                \"low\" =\u003e RulePriority::Low,\n                \"medium\" =\u003e RulePriority::Medium,\n                \"high\" =\u003e RulePriority::High,\n                \"critical\" =\u003e RulePriority::Critical,\n                _ =\u003e {\n                    println!(\"‚ùå Invalid priority. Use: low, medium, high, critical\");\n                    return Ok(());\n                }\n            };\n            rule.priority = new_priority;\n            updated = true;\n        }\n\n        if let Some(entity_types_str) = entity_types {\n            let types: Vec\u003cString\u003e = entity_types_str\n                .split(',')\n                .map(|s| s.trim().to_string())\n                .filter(|s| !s.is_empty())\n                .collect();\n            rule.entity_types = types;\n            updated = true;\n        }\n\n        if let Some(condition_str) = condition {\n            let condition_json: serde_json::Value =\n                serde_json::from_str(\u0026condition_str).map_err(|e| {\n                    EngramError::Validation(format!(\"Invalid JSON in condition: {}\", e))\n                })?;\n            rule.condition = condition_json;\n            updated = true;\n        }\n\n        if let Some(action_str) = action {\n            let action_json: serde_json::Value = serde_json::from_str(\u0026action_str)\n                .map_err(|e| EngramError::Validation(format!(\"Invalid JSON in action: {}\", e)))?;\n            rule.action = action_json;\n            updated = true;\n        }\n\n        if let Some(status_str) = status {\n            let new_status = match status_str.to_lowercase().as_str() {\n                \"active\" =\u003e RuleStatus::Active,\n                \"inactive\" =\u003e RuleStatus::Inactive,\n                \"deprecated\" =\u003e RuleStatus::Deprecated,\n                _ =\u003e {\n                    println!(\"‚ùå Invalid status. Use: active, inactive, deprecated\");\n                    return Ok(());\n                }\n            };\n            rule.status = new_status;\n            updated = true;\n        }\n\n        if !updated {\n            println!(\"No updates specified\");\n            return Ok(());\n        }\n\n        rule.updated_at = chrono::Utc::now();\n        let updated_generic = rule.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\"‚úÖ Rule updated: {}\", id);\n    } else {\n        println!(\"‚ùå Rule not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Delete rule\npub fn delete_rule\u003cS: Storage\u003e(storage: \u0026mut S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"rule\")? {\n        let mut rule =\n            Rule::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        rule.deactivate();\n        let updated_generic = rule.to_generic();\n        storage.store(\u0026updated_generic)?;\n        println!(\"‚úÖ Rule deleted (deactivated): {}\", id);\n    } else {\n        println!(\"‚ùå Rule not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// List rules\npub fn list_rules\u003cS: Storage\u003e(\n    storage: \u0026S,\n    rule_type: Option\u003cString\u003e,\n    priority: Option\u003cString\u003e,\n    entity_type: Option\u003cString\u003e,\n    status: Option\u003cString\u003e,\n    search: Option\u003cString\u003e,\n    limit: usize,\n    offset: usize,\n) -\u003e Result\u003c(), EngramError\u003e {\n    use crate::storage::QueryFilter;\n    use serde_json::Value;\n    use std::collections::HashMap;\n\n    let mut filter = QueryFilter {\n        entity_type: Some(\"rule\".to_string()),\n        text_search: search,\n        limit: Some(limit),\n        offset: Some(offset),\n        ..Default::default()\n    };\n\n    let mut field_filters = HashMap::new();\n\n    if let Some(rule_type_filter) = rule_type {\n        field_filters.insert(\"rule_type\".to_string(), Value::String(rule_type_filter));\n    }\n\n    if let Some(priority_filter) = priority {\n        field_filters.insert(\"priority\".to_string(), Value::String(priority_filter));\n    }\n\n    if let Some(entity_type_filter) = entity_type {\n        field_filters.insert(\"applies_to\".to_string(), Value::String(entity_type_filter));\n    }\n\n    if let Some(status_filter) = status {\n        field_filters.insert(\n            \"active\".to_string(),\n            Value::Bool(status_filter.to_lowercase() == \"active\"),\n        );\n    }\n\n    if !field_filters.is_empty() {\n        filter.field_filters = field_filters;\n    }\n\n    let result = storage.query(\u0026filter)?;\n\n    println!(\"üìã Rules List\");\n    println!(\"==============\");\n\n    if result.entities.is_empty() {\n        println!(\"No rules found matching the criteria.\");\n        return Ok(());\n    }\n\n    println!(\n        \"Found {} rules (showing {} to {} of {})\",\n        result.total_count,\n        offset + 1,\n        offset + result.entities.len(),\n        result.total_count\n    );\n    println!();\n\n    for (i, entity) in result.entities.iter().enumerate() {\n        let rule_data = \u0026entity.data;\n        let index = offset + i + 1;\n\n        let name = rule_data\n            .get(\"name\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"Unnamed Rule\");\n\n        let rule_type = rule_data\n            .get(\"rule_type\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"unknown\");\n\n        let priority = rule_data\n            .get(\"priority\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"medium\");\n\n        let active = rule_data\n            .get(\"active\")\n            .and_then(|v| v.as_bool())\n            .unwrap_or(true);\n\n        let status_symbol = if active { \"üü¢\" } else { \"üî¥\" };\n        let priority_symbol = match priority {\n            \"high\" =\u003e \"üî•\",\n            \"medium\" =\u003e \"‚ö°\",\n            \"low\" =\u003e \"üìç\",\n            _ =\u003e \"‚ùì\",\n        };\n\n        println!(\n            \"{}. {} {} [{}] {}\",\n            index,\n            status_symbol,\n            priority_symbol,\n            rule_type.to_uppercase(),\n            name\n        );\n\n        println!(\"   ID: {}\", entity.id);\n\n        if let Some(description) = rule_data.get(\"description\").and_then(|v| v.as_str()) {\n            let truncated = if description.len() \u003e 80 {\n                format!(\"{}...\", \u0026description[..77])\n            } else {\n                description.to_string()\n            };\n            println!(\"   üìù {}\", truncated);\n        }\n\n        if let Some(applies_to) = rule_data.get(\"applies_to\").and_then(|v| v.as_str()) {\n            println!(\"   üéØ Applies to: {}\", applies_to);\n        }\n\n        println!(\n            \"   üë§ Agent: {} | üìÖ {}\",\n            entity.agent,\n            entity.timestamp.format(\"%Y-%m-%d %H:%M\")\n        );\n\n        println!();\n    }\n\n    if result.has_more {\n        println!(\"üí° Use --offset {} to see more rules\", offset + limit);\n    }\n\n    println!(\"üí° Use 'engram rule get \u003cid\u003e' to view full rule details\");\n    println!(\"üí° Use 'engram rule execute \u003cid\u003e \u003centity-id\u003e' to execute a rule\");\n\n    Ok(())\n}\n\n/// Execute rule\npub fn execute_rule\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    entity_id: String,\n    entity_type: String,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"rule\")? {\n        let mut rule =\n            Rule::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        if let Some(target_entity) = storage.get(\u0026entity_id, \u0026entity_type)? {\n            let result = rule.execute(\u0026target_entity);\n\n            println!(\"‚úÖ Rule executed: {}\", id);\n            println!(\"üìã Target entity: {} ({})\", entity_id, entity_type);\n            println!(\"üìä Result: {:?}\", result);\n\n            let updated_generic = rule.to_generic();\n            storage.store(\u0026updated_generic)?;\n        } else {\n            println!(\n                \"‚ùå Target entity not found: {} ({})\",\n                entity_id, entity_type\n            );\n        }\n    } else {\n        println!(\"‚ùå Rule not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Display rule information\nfn display_rule(rule: \u0026Rule) {\n    println!(\"üìã Rule: {}\", rule.id());\n    println!(\"üìù Title: {}\", rule.title);\n    println!(\"üìÑ Description: {}\", rule.description);\n    println!(\"üîß Type: {:?}\", rule.rule_type);\n    println!(\"üìä Status: {:?}\", rule.status);\n    println!(\"‚ö° Priority: {:?}\", rule.priority);\n    println!(\"ü§ñ Agent: {}\", rule.agent);\n    if !rule.entity_types.is_empty() {\n        println!(\"üéØ Entity Types: {:?}\", rule.entity_types);\n    }\n    println!(\"üìù Condition: {}\", rule.condition);\n    println!(\"‚ö° Action: {}\", rule.action);\n    println!(\"üïê Created: {}\", rule.created_at.format(\"%Y-%m-%d %H:%M\"));\n    println!(\"üîÑ Updated: {}\", rule.updated_at.format(\"%Y-%m-%d %H:%M\"));\n    if !rule.execution_history.is_empty() {\n        println!(\"üìä Executions: {}\", rule.execution_history.len());\n    }\n}\n","traces":[{"line":140,"address":[15187181,15185772,15182896],"length":1,"stats":{"Line":0}},{"line":151,"address":[15183218,15183042,15183325],"length":1,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[15183722,15183865],"length":1,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[15184059,15183980,15184020],"length":1,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[15184115,15184079],"length":1,"stats":{"Line":0}},{"line":171,"address":[15184142],"length":1,"stats":{"Line":0}},{"line":175,"address":[15184267,15186746,15184198,15184378],"length":1,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[15184971,15184864],"length":1,"stats":{"Line":0}},{"line":184,"address":[15184979],"length":1,"stats":{"Line":0}},{"line":185,"address":[15184990],"length":1,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[15185307],"length":1,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[15185786,15185854],"length":1,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[15186153],"length":1,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[15201582,15200864,15201576],"length":1,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[15201567],"length":1,"stats":{"Line":0}},{"line":222,"address":[15197261,15189248,15191645],"length":1,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[15197616,15197634,15190035,15195381,15190116],"length":1,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[15190328],"length":1,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[15190696,15190881],"length":1,"stats":{"Line":0}},{"line":251,"address":[15191052,15191162,15190920],"length":1,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[15191285,15191333,15191239],"length":1,"stats":{"Line":0}},{"line":254,"address":[15191401,15191353,15191307],"length":1,"stats":{"Line":0}},{"line":255,"address":[15191421,15191453,15191375],"length":1,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[15191427,15191463],"length":1,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[15191615],"length":1,"stats":{"Line":0}},{"line":265,"address":[15191659,15190951],"length":1,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[15191962,15192040],"length":1,"stats":{"Line":0}},{"line":268,"address":[15192017,15192057,15192102],"length":1,"stats":{"Line":0}},{"line":269,"address":[15192164,15192119,15192079],"length":1,"stats":{"Line":0}},{"line":270,"address":[15192178,15192210,15192141],"length":1,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[15192247],"length":1,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[15192565,15197760,15197813],"length":1,"stats":{"Line":0}},{"line":284,"address":[15192588,15197593,15197568],"length":1,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[15192430,15192782],"length":1,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[15197883,15197951],"length":1,"stats":{"Line":0}},{"line":295,"address":[15193195,15193355],"length":1,"stats":{"Line":0}},{"line":296,"address":[15193387],"length":1,"stats":{"Line":0}},{"line":299,"address":[15192846,15193485],"length":1,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[15197323,15197296,15193679,15193749],"length":1,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[15193549,15194188],"length":1,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[15194428,15194494],"length":1,"stats":{"Line":0}},{"line":309,"address":[15194511,15194550,15194471],"length":1,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[15194633],"length":1,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[15194828,15194770],"length":1,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[15188230,15189104,15188448,15189122],"length":1,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[15188336],"length":1,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[15182660,15175056,15176330],"length":1,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[15176383,15176504],"length":1,"stats":{"Line":0}},{"line":384,"address":[15176999,15176689,15176422],"length":1,"stats":{"Line":0}},{"line":385,"address":[15176728,15176849],"length":1,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[15177681,15182289,15177806],"length":1,"stats":{"Line":0}},{"line":401,"address":[15178028,15178098],"length":1,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[15182251],"length":1,"stats":{"Line":0}},{"line":409,"address":[15178284,15178225,15178319],"length":1,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[15178753],"length":1,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[15179083,15179509,15179607],"length":1,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[15179636,15182873,15182864],"length":1,"stats":{"Line":0}},{"line":427,"address":[15179895],"length":1,"stats":{"Line":0}},{"line":429,"address":[15182745,15182736,15179793],"length":1,"stats":{"Line":0}},{"line":432,"address":[15180074],"length":1,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[15180181],"length":1,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[15180306,15180365,15180404],"length":1,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[15180953],"length":1,"stats":{"Line":0}},{"line":461,"address":[15182704,15181057,15182713],"length":1,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[15181278,15181340],"length":1,"stats":{"Line":0}},{"line":467,"address":[15181590,15181350],"length":1,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[15181835,15181956],"length":1,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[15182174],"length":1,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[15179350],"length":1,"stats":{"Line":0}},{"line":490,"address":[15179403],"length":1,"stats":{"Line":0}},{"line":494,"address":[15198128,15200692,15200316],"length":1,"stats":{"Line":0}},{"line":500,"address":[15198273,15198184,15200674],"length":1,"stats":{"Line":0}},{"line":501,"address":[15200533,15198695,15200738,15198614,15200720],"length":1,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[15198919,15199005],"length":1,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[15199549],"length":1,"stats":{"Line":0}},{"line":508,"address":[15199655],"length":1,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[15200446],"length":1,"stats":{"Line":0}},{"line":526,"address":[20415462,20415468,20413760],"length":1,"stats":{"Line":0}},{"line":527,"address":[25653876],"length":1,"stats":{"Line":0}},{"line":528,"address":[18773406],"length":1,"stats":{"Line":0}},{"line":529,"address":[26114776],"length":1,"stats":{"Line":0}},{"line":530,"address":[25654210],"length":1,"stats":{"Line":0}},{"line":531,"address":[18911085],"length":1,"stats":{"Line":0}},{"line":532,"address":[18995852],"length":1,"stats":{"Line":0}},{"line":533,"address":[19615897],"length":1,"stats":{"Line":0}},{"line":534,"address":[18925299],"length":1,"stats":{"Line":0}},{"line":535,"address":[18996086],"length":1,"stats":{"Line":0}},{"line":537,"address":[25654768],"length":1,"stats":{"Line":0}},{"line":538,"address":[19616252],"length":1,"stats":{"Line":0}},{"line":539,"address":[18984889],"length":1,"stats":{"Line":0}},{"line":540,"address":[26115865],"length":1,"stats":{"Line":0}},{"line":541,"address":[18926052],"length":1,"stats":{"Line":0}},{"line":542,"address":[18774827],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":229},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","sandbox.rs"],"content":"//! Sandbox command implementations\n\nuse crate::entities::{AgentSandbox, Entity, SandboxLevel};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\nuse serde::{Deserialize, Serialize};\nuse std::fs;\nuse std::io::{self, Read, Write};\n\n/// Sandbox input structure for JSON\n#[derive(Debug, Deserialize)]\npub struct SandboxInput {\n    pub agent_id: String,\n    pub sandbox_level: String,\n    pub created_by: Option\u003cString\u003e,\n    pub agent: Option\u003cString\u003e,\n}\n\n/// Sandbox configuration update input\n#[derive(Debug, Deserialize)]\npub struct SandboxUpdateInput {\n    pub sandbox_level: Option\u003cString\u003e,\n    pub permissions: Option\u003cserde_json::Value\u003e,\n    pub resource_limits: Option\u003cserde_json::Value\u003e,\n}\n\n/// Sandbox validation request\n#[derive(Debug, Serialize, Deserialize)]\npub struct SandboxValidationRequest {\n    pub agent_id: String,\n    pub operation: String,\n    pub resource_type: String,\n    pub parameters: serde_json::Value,\n}\n\n/// Sandbox commands\n#[derive(Subcommand)]\npub enum SandboxCommands {\n    Create {\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        #[arg(long, short, default_value = \"standard\")]\n        level: String,\n\n        #[arg(long)]\n        created_by: Option\u003cString\u003e,\n\n        #[arg(long, conflicts_with_all = [\"agent\"])]\n        stdin: bool,\n\n        #[arg(long, conflicts_with_all = [\"agent\", \"stdin\"])]\n        file: Option\u003cString\u003e,\n\n        #[arg(long)]\n        json: bool,\n    },\n    /// List all sandbox configurations\n    List {\n        /// Filter by agent ID\n        #[arg(long)]\n        agent_id: Option\u003cString\u003e,\n\n        /// Filter by sandbox level\n        #[arg(long)]\n        level: Option\u003cString\u003e,\n\n        /// Agent to filter by\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Get sandbox configuration details\n    Get {\n        /// Sandbox ID\n        #[arg()]\n        id: String,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Update sandbox configuration\n    Update {\n        /// Sandbox ID\n        #[arg()]\n        id: String,\n\n        /// New sandbox level\n        #[arg(long)]\n        level: Option\u003cString\u003e,\n\n        /// Read update data from stdin as JSON\n        #[arg(long)]\n        stdin: bool,\n\n        /// Read update data from file as JSON\n        #[arg(long, conflicts_with = \"stdin\")]\n        file: Option\u003cString\u003e,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Delete sandbox configuration\n    Delete {\n        /// Sandbox ID\n        #[arg()]\n        id: String,\n\n        /// Confirm deletion without prompt\n        #[arg(long)]\n        force: bool,\n    },\n    /// Validate an operation against sandbox constraints\n    Validate {\n        /// Agent ID\n        #[arg(long, short)]\n        agent_id: Option\u003cString\u003e,\n\n        /// Operation to validate\n        #[arg(long, short)]\n        operation: Option\u003cString\u003e,\n\n        /// Resource type\n        #[arg(long, short)]\n        resource_type: Option\u003cString\u003e,\n\n        /// Read validation request from stdin as JSON\n        #[arg(long, conflicts_with_all = [\"agent_id\", \"operation\"])]\n        stdin: bool,\n\n        /// Read validation request from file as JSON\n        #[arg(long, conflicts_with_all = [\"agent_id\", \"operation\", \"stdin\"])]\n        file: Option\u003cString\u003e,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Show sandbox statistics and usage\n    Stats {\n        /// Agent ID to show stats for\n        #[arg(long, short)]\n        agent_id: Option\u003cString\u003e,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n    /// Reset sandbox configuration to defaults\n    Reset {\n        /// Agent ID to reset\n        #[arg()]\n        agent_id: String,\n\n        /// Confirm reset without prompt\n        #[arg(long)]\n        force: bool,\n\n        /// Output in JSON format\n        #[arg(long)]\n        json: bool,\n    },\n}\n\n/// Create a new sandbox configuration\npub fn create_sandbox\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    agent: Option\u003cString\u003e,\n    level: String,\n    created_by: Option\u003cString\u003e,\n    stdin: bool,\n    file: Option\u003cString\u003e,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let sandbox_input = if stdin {\n        read_sandbox_input_from_stdin()?\n    } else if let Some(file_path) = file {\n        read_sandbox_input_from_file(\u0026file_path)?\n    } else {\n        let agent_id =\n            agent.ok_or_else(|| EngramError::Validation(\"Agent is required\".to_string()))?;\n\n        SandboxInput {\n            agent_id,\n            sandbox_level: level,\n            created_by,\n            agent: None,\n        }\n    };\n\n    let sandbox_level = parse_sandbox_level(\u0026sandbox_input.sandbox_level)?;\n    let created_by = sandbox_input\n        .created_by\n        .unwrap_or_else(|| \"default\".to_string());\n    let agent = sandbox_input.agent.unwrap_or_else(|| \"default\".to_string());\n\n    let sandbox = AgentSandbox::new(sandbox_input.agent_id, sandbox_level, created_by, agent);\n\n    storage.store(\u0026sandbox.to_generic())?;\n\n    if json {\n        println!(\"{}\", serde_json::to_string_pretty(\u0026sandbox.to_generic())?);\n    } else {\n        println!(\"‚úÖ Sandbox created successfully:\");\n        println!(\"  ID: {}\", sandbox.id);\n        println!(\"  Agent: {}\", sandbox.agent_id);\n        println!(\"  Level: {:?}\", sandbox.sandbox_level);\n        println!(\"  Created by: {}\", sandbox.created_by);\n    }\n\n    Ok(())\n}\n\n/// List sandbox configurations\npub fn list_sandboxes\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent_id: Option\u003cString\u003e,\n    level: Option\u003cString\u003e,\n    agent: Option\u003cString\u003e,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let ids = storage.list_ids(\"agent_sandbox\")?;\n    let mut sandboxes = Vec::new();\n\n    for id in ids {\n        if let Ok(Some(entity)) = storage.get(\u0026id, \"agent_sandbox\") {\n            match AgentSandbox::from_generic(entity) {\n                Ok(sandbox) =\u003e {\n                    // Apply filters\n                    if let Some(filter_agent_id) = \u0026agent_id {\n                        if sandbox.agent_id != *filter_agent_id {\n                            continue;\n                        }\n                    }\n\n                    if let Some(filter_agent) = \u0026agent {\n                        if sandbox.agent != *filter_agent {\n                            continue;\n                        }\n                    }\n\n                    if let Some(filter_level) = \u0026level {\n                        if format!(\"{:?}\", sandbox.sandbox_level).to_lowercase()\n                            != filter_level.to_lowercase()\n                        {\n                            continue;\n                        }\n                    }\n\n                    sandboxes.push(sandbox);\n                }\n                Err(_) =\u003e continue,\n            }\n        }\n    }\n\n    if json {\n        let generic_sandboxes: Vec\u003c_\u003e = sandboxes.iter().map(|s| s.to_generic()).collect();\n        println!(\"{}\", serde_json::to_string_pretty(\u0026generic_sandboxes)?);\n    } else {\n        if sandboxes.is_empty() {\n            println!(\"No sandbox configurations found.\");\n        } else {\n            println!(\"üìã Sandbox Configurations ({} found):\", sandboxes.len());\n            for sandbox in sandboxes {\n                println!(\n                    \"  ‚Ä¢ {} [{}] - {} ({:?})\",\n                    sandbox.id, sandbox.agent_id, sandbox.agent, sandbox.sandbox_level\n                );\n            }\n        }\n    }\n\n    Ok(())\n}\n\n/// Get sandbox configuration details\npub fn get_sandbox\u003cS: Storage\u003e(storage: \u0026S, id: String, json: bool) -\u003e Result\u003c(), EngramError\u003e {\n    match storage.get(\u0026id, \"agent_sandbox\")? {\n        Some(entity) =\u003e {\n            let sandbox = AgentSandbox::from_generic(entity)\n                .map_err(|e| EngramError::Validation(e.to_string()))?;\n\n            if json {\n                println!(\"{}\", serde_json::to_string_pretty(\u0026sandbox.to_generic())?);\n            } else {\n                println!(\"üîí Sandbox Configuration:\");\n                println!(\"  ID: {}\", sandbox.id);\n                println!(\"  Agent: {}\", sandbox.agent_id);\n                println!(\"  Level: {:?}\", sandbox.sandbox_level);\n                println!(\"  Created by: {}\", sandbox.created_by);\n                println!(\"  Created at: {}\", sandbox.created_at);\n                println!(\"  Last modified: {}\", sandbox.last_modified);\n                println!(\"  Violation count: {}\", sandbox.violation_count);\n\n                if !sandbox.metadata.is_empty() {\n                    println!(\n                        \"  Metadata: {}\",\n                        serde_json::to_string_pretty(\u0026sandbox.metadata)?\n                    );\n                }\n            }\n        }\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Sandbox with ID {} not found\",\n                id\n            )));\n        }\n    }\n\n    Ok(())\n}\n\n/// Update sandbox configuration\npub fn update_sandbox\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: String,\n    level: Option\u003cString\u003e,\n    stdin: bool,\n    file: Option\u003cString\u003e,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut sandbox = match storage.get(\u0026id, \"agent_sandbox\")? {\n        Some(entity) =\u003e AgentSandbox::from_generic(entity)\n            .map_err(|e| EngramError::Validation(e.to_string()))?,\n        None =\u003e {\n            return Err(EngramError::NotFound(format!(\n                \"Sandbox with ID {} not found\",\n                id\n            )))\n        }\n    };\n\n    if stdin || file.is_some() {\n        let update_input = if stdin {\n            read_update_input_from_stdin()?\n        } else {\n            read_update_input_from_file(\u0026file.unwrap())?\n        };\n\n        if let Some(new_level) = update_input.sandbox_level {\n            sandbox.sandbox_level = parse_sandbox_level(\u0026new_level)?;\n        }\n    } else if let Some(new_level) = level {\n        sandbox.sandbox_level = parse_sandbox_level(\u0026new_level)?;\n    }\n\n    sandbox.last_modified = chrono::Utc::now();\n\n    storage.store(\u0026sandbox.to_generic())?;\n\n    if json {\n        println!(\"{}\", serde_json::to_string_pretty(\u0026sandbox.to_generic())?);\n    } else {\n        println!(\"‚úÖ Sandbox updated successfully:\");\n        println!(\"  ID: {}\", sandbox.id);\n        println!(\"  Level: {:?}\", sandbox.sandbox_level);\n    }\n\n    Ok(())\n}\n\n/// Delete sandbox configuration\npub fn delete_sandbox\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: String,\n    force: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if !force {\n        print!(\"Are you sure you want to delete sandbox {}? (y/N): \", id);\n        io::stdout().flush().unwrap();\n        let mut input = String::new();\n        io::stdin().read_line(\u0026mut input)?;\n        if !input.trim().to_lowercase().starts_with('y') {\n            println!(\"Operation cancelled.\");\n            return Ok(());\n        }\n    }\n\n    storage.delete(\u0026id, \"agent_sandbox\")?;\n    println!(\"‚úÖ Sandbox {} deleted successfully.\", id);\n\n    Ok(())\n}\n\n/// Validate an operation against sandbox constraints (simplified implementation)\npub fn validate_operation\u003cS: Storage\u003e(\n    _storage: \u0026S,\n    agent_id: Option\u003cString\u003e,\n    operation: Option\u003cString\u003e,\n    resource_type: Option\u003cString\u003e,\n    stdin: bool,\n    file: Option\u003cString\u003e,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let validation_request = if stdin {\n        read_validation_request_from_stdin()?\n    } else if let Some(file_path) = file {\n        read_validation_request_from_file(\u0026file_path)?\n    } else {\n        let agent_id =\n            agent_id.ok_or_else(|| EngramError::Validation(\"Agent ID is required\".to_string()))?;\n        let operation = operation\n            .ok_or_else(|| EngramError::Validation(\"Operation is required\".to_string()))?;\n        let resource_type = resource_type\n            .ok_or_else(|| EngramError::Validation(\"Resource type is required\".to_string()))?;\n\n        SandboxValidationRequest {\n            agent_id,\n            operation,\n            resource_type,\n            parameters: serde_json::Value::Object(serde_json::Map::new()),\n        }\n    };\n\n    // Simplified validation - just allow for now\n    let result = serde_json::json!({\n        \"status\": \"allowed\",\n        \"agent_id\": validation_request.agent_id,\n        \"operation\": validation_request.operation,\n        \"resource_type\": validation_request.resource_type\n    });\n\n    if json {\n        println!(\"{}\", serde_json::to_string_pretty(\u0026result)?);\n    } else {\n        println!(\"‚úÖ Operation allowed:\");\n        println!(\"  Agent: {}\", validation_request.agent_id);\n        println!(\"  Operation: {}\", validation_request.operation);\n        println!(\"  Resource: {}\", validation_request.resource_type);\n    }\n\n    Ok(())\n}\n\n/// Show sandbox statistics and usage\npub fn show_stats\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent_id: Option\u003cString\u003e,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let ids = storage.list_ids(\"agent_sandbox\")?;\n    let mut total_sandboxes = 0;\n    let mut level_counts = std::collections::HashMap::new();\n    let mut agent_sandboxes = Vec::new();\n\n    for id in ids {\n        if let Ok(Some(entity)) = storage.get(\u0026id, \"agent_sandbox\") {\n            if let Ok(sandbox) = AgentSandbox::from_generic(entity) {\n                if let Some(filter_agent_id) = \u0026agent_id {\n                    if sandbox.agent_id == *filter_agent_id {\n                        agent_sandboxes.push(sandbox.clone());\n                    }\n                } else {\n                    total_sandboxes += 1;\n                    *level_counts\n                        .entry(format!(\"{:?}\", sandbox.sandbox_level))\n                        .or_insert(0) += 1;\n                    agent_sandboxes.push(sandbox);\n                }\n            }\n        }\n    }\n\n    if json {\n        let stats = serde_json::json!({\n            \"total_sandboxes\": if agent_id.is_some() { agent_sandboxes.len() } else { total_sandboxes },\n            \"level_distribution\": level_counts,\n            \"sandboxes\": agent_sandboxes.iter().map(|s| serde_json::json!({\n                \"id\": s.id,\n                \"agent_id\": s.agent_id,\n                \"level\": format!(\"{:?}\", s.sandbox_level),\n                \"violation_count\": s.violation_count\n            })).collect::\u003cVec\u003c_\u003e\u003e()\n        });\n        println!(\"{}\", serde_json::to_string_pretty(\u0026stats)?);\n    } else {\n        if let Some(filter_agent_id) = agent_id {\n            println!(\"üìä Sandbox Stats for Agent: {}\", filter_agent_id);\n            if agent_sandboxes.is_empty() {\n                println!(\"  No sandbox configuration found for this agent.\");\n            } else {\n                for sandbox in agent_sandboxes {\n                    println!(\"  ‚Ä¢ Level: {:?}\", sandbox.sandbox_level);\n                    println!(\"    Violations: {}\", sandbox.violation_count);\n                }\n            }\n        } else {\n            println!(\"üìä Sandbox Statistics:\");\n            println!(\"  Total sandboxes: {}\", total_sandboxes);\n            println!(\"  Level distribution:\");\n            for (level, count) in level_counts {\n                println!(\"    {}: {}\", level, count);\n            }\n        }\n    }\n\n    Ok(())\n}\n\n/// Reset sandbox configuration to defaults\npub fn reset_sandbox\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    agent_id: String,\n    force: bool,\n    json: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if !force {\n        print!(\n            \"Are you sure you want to reset sandbox configuration for agent {}? (y/N): \",\n            agent_id\n        );\n        io::stdout().flush().unwrap();\n        let mut input = String::new();\n        io::stdin().read_line(\u0026mut input)?;\n        if !input.trim().to_lowercase().starts_with('y') {\n            println!(\"Operation cancelled.\");\n            return Ok(());\n        }\n    }\n\n    // Find existing sandbox for this agent\n    let ids = storage.list_ids(\"agent_sandbox\")?;\n    let mut existing_sandbox = None;\n\n    for id in ids {\n        if let Ok(Some(entity)) = storage.get(\u0026id, \"agent_sandbox\") {\n            if let Ok(sandbox) = AgentSandbox::from_generic(entity) {\n                if sandbox.agent_id == agent_id {\n                    existing_sandbox = Some(sandbox);\n                    break;\n                }\n            }\n        }\n    }\n\n    let new_sandbox = if let Some(mut sandbox) = existing_sandbox {\n        // Reset to standard level with default configuration\n        sandbox.sandbox_level = SandboxLevel::Standard;\n        sandbox.violation_count = 0;\n        sandbox.last_modified = chrono::Utc::now();\n        sandbox.metadata.clear();\n\n        storage.store(\u0026sandbox.to_generic())?;\n        sandbox\n    } else {\n        // Create new default sandbox\n        let sandbox = AgentSandbox::new(\n            agent_id.clone(),\n            SandboxLevel::Standard,\n            \"system\".to_string(),\n            \"default\".to_string(),\n        );\n\n        storage.store(\u0026sandbox.to_generic())?;\n        sandbox\n    };\n\n    if json {\n        println!(\n            \"{}\",\n            serde_json::to_string_pretty(\u0026new_sandbox.to_generic())?\n        );\n    } else {\n        println!(\"‚úÖ Sandbox reset successfully:\");\n        println!(\"  Agent: {}\", new_sandbox.agent_id);\n        println!(\"  Level: {:?}\", new_sandbox.sandbox_level);\n        println!(\"  ID: {}\", new_sandbox.id);\n    }\n\n    Ok(())\n}\n\n// Helper functions\n\nfn read_sandbox_input_from_stdin() -\u003e Result\u003cSandboxInput, EngramError\u003e {\n    let mut input = String::new();\n    io::stdin().read_to_string(\u0026mut input)?;\n    Ok(serde_json::from_str(\u0026input)?)\n}\n\nfn read_sandbox_input_from_file(file_path: \u0026str) -\u003e Result\u003cSandboxInput, EngramError\u003e {\n    let content = fs::read_to_string(file_path)?;\n    Ok(serde_json::from_str(\u0026content)?)\n}\n\nfn read_update_input_from_stdin() -\u003e Result\u003cSandboxUpdateInput, EngramError\u003e {\n    let mut input = String::new();\n    io::stdin().read_to_string(\u0026mut input)?;\n    Ok(serde_json::from_str(\u0026input)?)\n}\n\nfn read_update_input_from_file(file_path: \u0026str) -\u003e Result\u003cSandboxUpdateInput, EngramError\u003e {\n    let content = fs::read_to_string(file_path)?;\n    Ok(serde_json::from_str(\u0026content)?)\n}\n\nfn read_validation_request_from_stdin() -\u003e Result\u003cSandboxValidationRequest, EngramError\u003e {\n    let mut input = String::new();\n    io::stdin().read_to_string(\u0026mut input)?;\n    Ok(serde_json::from_str(\u0026input)?)\n}\n\nfn read_validation_request_from_file(\n    file_path: \u0026str,\n) -\u003e Result\u003cSandboxValidationRequest, EngramError\u003e {\n    let content = fs::read_to_string(file_path)?;\n    Ok(serde_json::from_str(\u0026content)?)\n}\n\nfn parse_sandbox_level(level: \u0026str) -\u003e Result\u003cSandboxLevel, EngramError\u003e {\n    match level.to_lowercase().as_str() {\n        \"unrestricted\" =\u003e Ok(SandboxLevel::Unrestricted),\n        \"standard\" =\u003e Ok(SandboxLevel::Standard),\n        \"restricted\" =\u003e Ok(SandboxLevel::Restricted),\n        \"isolated\" =\u003e Ok(SandboxLevel::Isolated),\n        \"training\" =\u003e Ok(SandboxLevel::Training),\n        _ =\u003e Err(EngramError::Validation(\n            format!(\"Invalid sandbox level: {}. Must be one of: unrestricted, standard, restricted, isolated, training\", level)\n        )),\n    }\n}\n","traces":[{"line":172,"address":[14376256,14375248,14379771],"length":1,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[14375481,14379582,14376797],"length":1,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[14375547,14375680],"length":1,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[14377538,14377614,14379164],"length":1,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[14378131],"length":1,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[14381296,14385728,14383038],"length":1,"stats":{"Line":0}},{"line":228,"address":[14381492,14381393,14385685],"length":1,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[14382088,14383900,14384015],"length":1,"stats":{"Line":0}},{"line":233,"address":[14384180,14384273],"length":1,"stats":{"Line":0}},{"line":234,"address":[14384356],"length":1,"stats":{"Line":0}},{"line":236,"address":[14384398],"length":1,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[14384592,14384477],"length":1,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[14384792,14384691,14385085,14385161,14384971],"length":1,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[14383214,14383163],"length":1,"stats":{"Line":0}},{"line":267,"address":[14382203,14382154],"length":1,"stats":{"Line":0}},{"line":268,"address":[14382229,14383044],"length":1,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[14382375,14382565],"length":1,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[14369386,14369832,14368101],"length":1,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[14368298],"length":1,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[14368610],"length":1,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[14368818],"length":1,"stats":{"Line":0}},{"line":302,"address":[14368922],"length":1,"stats":{"Line":0}},{"line":303,"address":[14369178],"length":1,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[14387384,14390229,14385808],"length":1,"stats":{"Line":0}},{"line":330,"address":[14386024,14390075,14385913],"length":1,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[14386432],"length":1,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[14388200,14387933],"length":1,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[14387075,14388756],"length":1,"stats":{"Line":0}},{"line":357,"address":[14390043,14388786],"length":1,"stats":{"Line":0}},{"line":359,"address":[14389049],"length":1,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[14389138],"length":1,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[14380000,14381270,14380899],"length":1,"stats":{"Line":0}},{"line":376,"address":[14380061],"length":1,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[14380578],"length":1,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[14380851],"length":1,"stats":{"Line":0}},{"line":387,"address":[14380944,14380108,14381265],"length":1,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[14391395,14395545,14390400],"length":1,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[14390718,14390851],"length":1,"stats":{"Line":0}},{"line":408,"address":[14390740,14391401,14395776,14395790,14392869],"length":1,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[14391662,14395694,14395680,14391770],"length":1,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[14395584,14395598,14391971,14392079],"length":1,"stats":{"Line":0}},{"line":419,"address":[14392407,14392356],"length":1,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[14394139,14394239],"length":1,"stats":{"Line":0}},{"line":435,"address":[14394263],"length":1,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[14394460],"length":1,"stats":{"Line":0}},{"line":440,"address":[14394571],"length":1,"stats":{"Line":0}},{"line":444,"address":[14365650,14361719,14359856],"length":1,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[14360314],"length":1,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[14360694,14360443,14360559],"length":1,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[14364849,14364944],"length":1,"stats":{"Line":0}},{"line":459,"address":[14364985],"length":1,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[14365243,14365328],"length":1,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[14362601,14362677,14362544],"length":1,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[14363200,14366972],"length":1,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[14361341,14361122,14361214],"length":1,"stats":{"Line":0}},{"line":491,"address":[14361524,14361408],"length":1,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[14360951,14361783],"length":1,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[14361906],"length":1,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[14361757],"length":1,"stats":{"Line":0}},{"line":509,"address":[14371050,14370032,14375220],"length":1,"stats":{"Line":0}},{"line":515,"address":[14370128],"length":1,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[14370362],"length":1,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[14370949],"length":1,"stats":{"Line":0}},{"line":525,"address":[14371002],"length":1,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[14371315,14371583,14371448],"length":1,"stats":{"Line":0}},{"line":534,"address":[14371660,14371876,14371761],"length":1,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[14372355,14372530],"length":1,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[14373929,14372769],"length":1,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[14372852],"length":1,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[14373263],"length":1,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[14373448],"length":1,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[14374652,14374427,14374879],"length":1,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[14374157],"length":1,"stats":{"Line":0}},{"line":575,"address":[14374269],"length":1,"stats":{"Line":0}},{"line":578,"address":[14374375],"length":1,"stats":{"Line":0}},{"line":583,"address":[20717371,20717365,20716848],"length":1,"stats":{"Line":0}},{"line":584,"address":[27847638],"length":1,"stats":{"Line":0}},{"line":585,"address":[16610667,16610729],"length":1,"stats":{"Line":0}},{"line":586,"address":[22168660],"length":1,"stats":{"Line":0}},{"line":589,"address":[21600704,21601197,21601203],"length":1,"stats":{"Line":0}},{"line":590,"address":[22167393],"length":1,"stats":{"Line":0}},{"line":591,"address":[16609780,16609854],"length":1,"stats":{"Line":0}},{"line":594,"address":[22168378,22168384,22167872],"length":1,"stats":{"Line":0}},{"line":595,"address":[27847094],"length":1,"stats":{"Line":0}},{"line":596,"address":[20716393,20716331],"length":1,"stats":{"Line":0}},{"line":597,"address":[22168116],"length":1,"stats":{"Line":0}},{"line":600,"address":[22166848,22167341,22167347],"length":1,"stats":{"Line":0}},{"line":601,"address":[22166881],"length":1,"stats":{"Line":0}},{"line":602,"address":[16609342,16609268],"length":1,"stats":{"Line":0}},{"line":605,"address":[21603338,21602832,21603344],"length":1,"stats":{"Line":0}},{"line":606,"address":[27388038],"length":1,"stats":{"Line":0}},{"line":607,"address":[20729467,20729529],"length":1,"stats":{"Line":0}},{"line":608,"address":[20729684],"length":1,"stats":{"Line":0}},{"line":611,"address":[16611670,16611184,16611664],"length":1,"stats":{"Line":0}},{"line":614,"address":[16611217],"length":1,"stats":{"Line":0}},{"line":615,"address":[21602567,21602501],"length":1,"stats":{"Line":0}},{"line":618,"address":[27846022,27845328,27846016],"length":1,"stats":{"Line":0}},{"line":619,"address":[20726209,20726107],"length":1,"stats":{"Line":0}},{"line":620,"address":[27845473,27845544],"length":1,"stats":{"Line":0}},{"line":621,"address":[27384892,27384936,27384844],"length":1,"stats":{"Line":0}},{"line":622,"address":[20714904,20714812,20714860],"length":1,"stats":{"Line":0}},{"line":623,"address":[22166444,22166492,22166536],"length":1,"stats":{"Line":0}},{"line":624,"address":[27845799,27845708,27845756],"length":1,"stats":{"Line":0}},{"line":625,"address":[20726672],"length":1,"stats":{"Line":0}},{"line":626,"address":[20504503,20504551],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":247},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","schema.rs"],"content":"//! Schema generation commands\n\nuse crate::entities::workflow::Workflow;\nuse clap::Subcommand;\nuse schemars::schema_for;\n\n#[derive(Subcommand)]\npub enum SchemaCommands {\n    /// Generate JSON Schema for workflow entity\n    Workflow {\n        /// Output file path (prints to stdout if not specified)\n        #[arg(long, short)]\n        output: Option\u003cString\u003e,\n    },\n}\n\npub fn handle_schema_command(command: SchemaCommands) -\u003e crate::Result\u003c()\u003e {\n    match command {\n        SchemaCommands::Workflow { output } =\u003e {\n            let schema = schema_for!(Workflow);\n            let schema_json = serde_json::to_string_pretty(\u0026schema)\n                .map_err(|e| crate::EngramError::Serialization(e))?;\n\n            if let Some(output_path) = output {\n                std::fs::write(\u0026output_path, schema_json).map_err(|e| crate::EngramError::Io(e))?;\n                println!(\"‚úÖ Schema written to: {}\", output_path);\n            } else {\n                println!(\"{}\", schema_json);\n            }\n\n            Ok(())\n        }\n    }\n}\n","traces":[{"line":17,"address":[27104231,27104479,27103120],"length":1,"stats":{"Line":0}},{"line":18,"address":[19761873],"length":1,"stats":{"Line":0}},{"line":19,"address":[19972385],"length":1,"stats":{"Line":0}},{"line":20,"address":[19984008,19983938],"length":1,"stats":{"Line":0}},{"line":21,"address":[19762213,19762105,19763133,19762016],"length":1,"stats":{"Line":0}},{"line":22,"address":[19972661,19972574],"length":1,"stats":{"Line":0}},{"line":24,"address":[19913594],"length":1,"stats":{"Line":0}},{"line":25,"address":[19762573,19762414],"length":1,"stats":{"Line":0}},{"line":26,"address":[21424801],"length":1,"stats":{"Line":0}},{"line":28,"address":[15161430,15161897],"length":1,"stats":{"Line":0}},{"line":31,"address":[19762898],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":11},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","session.rs"],"content":"use crate::entities::session::{DoraMetrics, SpaceMetrics};\nuse crate::entities::{Entity, Session, SessionStatus};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse chrono::Utc;\nuse clap::Subcommand;\n\n/// Session commands\n#[derive(Debug, Subcommand)]\npub enum SessionCommands {\n    /// Start a new session\n    Start {\n        /// Agent name\n        #[arg(long, short)]\n        name: String,\n\n        /// Auto-detect current task\n        #[arg(long)]\n        auto_detect: bool,\n    },\n    /// Show session status\n    Status {\n        /// Session ID\n        #[arg(long, short)]\n        id: String,\n\n        /// Show detailed metrics\n        #[arg(long)]\n        metrics: bool,\n    },\n    /// End current session\n    End {\n        /// Session ID\n        #[arg(long, short)]\n        id: String,\n\n        /// Generate summary\n        #[arg(long)]\n        generate_summary: bool,\n    },\n    /// List all sessions\n    List {\n        /// Agent filter\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Limit results\n        #[arg(long, short)]\n        limit: Option\u003cusize\u003e,\n    },\n}\n\n/// Start a new session\npub fn start_session\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    agent_name: String,\n    auto_detect: bool,\n) -\u003e Result\u003cString, EngramError\u003e {\n    let title = format!(\"Session for {}\", agent_name);\n\n    let mut goals = Vec::new();\n    if auto_detect {\n        if is_engram_project() {\n            goals.push(\"Working on Engram project\".to_string());\n            println!(\"Auto-detected: Working on Engram project\");\n            // TODO: Create auto-task for dogfooding when task creation is available\n            println!(\"Note: Auto-task creation for dogfooding will be added in future iteration\");\n        } else {\n            goals.push(\"General development session\".to_string());\n        }\n    }\n\n    let session = Session::new(title, agent_name.clone(), goals);\n    let session_id = session.id.clone();\n\n    let generic = session.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"Session started successfully!\");\n    println!(\"Session ID: {}\", session_id);\n    println!(\"Agent: {}\", agent_name);\n    println!(\"Started at: {}\", Utc::now().format(\"%Y-%m-%d %H:%M:%S\"));\n\n    Ok(session_id)\n}\n\n/// Check if current directory is Engram project\nfn is_engram_project() -\u003e bool {\n    let markers = [\"rust/Cargo.toml\", \"AGENTS.md\", \".engram/config.yaml\"];\n\n    markers\n        .iter()\n        .any(|marker| std::path::Path::new(marker).exists())\n}\n\n/// Show session status\npub fn show_session_status\u003cS: Storage\u003e(\n    storage: \u0026S,\n    session_id: String,\n    show_metrics: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let generic = storage\n        .get(\u0026session_id, Session::entity_type())?\n        .ok_or_else(|| EngramError::NotFound(format!(\"Session not found: {}\", session_id)))?;\n\n    let session =\n        Session::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n    println!(\"Session Status\");\n    println!(\"==============\");\n    println!(\"ID: {}\", session.id);\n    println!(\"Title: {}\", session.title);\n    println!(\"Agent: {}\", session.agent);\n    println!(\"Status: {:?}\", session.status);\n    println!(\n        \"Started: {}\",\n        session.start_time.format(\"%Y-%m-%d %H:%M:%S\")\n    );\n\n    if let Some(end_time) = session.end_time {\n        println!(\"Ended: {}\", end_time.format(\"%Y-%m-%d %H:%M:%S\"));\n    }\n\n    if let Some(duration) = session.duration_seconds {\n        let hours = duration / 3600;\n        let minutes = (duration % 3600) / 60;\n        let seconds = duration % 60;\n        println!(\"Duration: {}h {}m {}s\", hours, minutes, seconds);\n    }\n\n    if !session.goals.is_empty() {\n        println!(\"\\nGoals:\");\n        for goal in \u0026session.goals {\n            println!(\"  - {}\", goal);\n        }\n    }\n\n    if !session.outcomes.is_empty() {\n        println!(\"\\nOutcomes:\");\n        for outcome in \u0026session.outcomes {\n            println!(\"  - {}\", outcome);\n        }\n    }\n\n    if !session.task_ids.is_empty() {\n        println!(\"\\nTasks: {}\", session.task_ids.join(\", \"));\n    }\n\n    if show_metrics {\n        println!(\"\\n--- Metrics ---\");\n\n        if let Some(ref space) = session.space_metrics {\n            println!(\"\\nSPACE Framework:\");\n            println!(\"  Satisfaction: {:.2}\", space.satisfaction_score);\n            println!(\"  Performance:  {:.2}\", space.performance_score);\n            println!(\"  Activity:     {:.2}\", space.activity_score);\n            println!(\"  Communication:{:.2}\", space.communication_score);\n            println!(\"  Efficiency:   {:.2}\", space.efficiency_score);\n            println!(\"  Overall:      {:.2}\", space.overall_score);\n        } else {\n            println!(\"\\nNo SPACE metrics available\");\n        }\n\n        if let Some(ref dora) = session.dora_metrics {\n            println!(\"\\nDORA Metrics:\");\n            println!(\"  Deployment Frequency: {:.2}\", dora.deployment_frequency);\n            println!(\"  Lead Time:            {:.2} days\", dora.lead_time);\n            println!(\"  Change Failure Rate:  {:.2}%\", dora.change_failure_rate);\n            println!(\n                \"  MTTR:                 {:.2} hours\",\n                dora.mean_time_to_recover\n            );\n        } else {\n            println!(\"\\nNo DORA metrics available\");\n        }\n    }\n\n    Ok(())\n}\n\n/// End a session\npub fn end_session\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    session_id: String,\n    generate_summary: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let generic = storage\n        .get(\u0026session_id, Session::entity_type())?\n        .ok_or_else(|| EngramError::NotFound(format!(\"Session not found: {}\", session_id)))?;\n\n    let mut session =\n        Session::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n    if session.status == SessionStatus::Completed || session.status == SessionStatus::Cancelled {\n        return Err(EngramError::Validation(format!(\n            \"Session already ended: {:?}\",\n            session.status\n        )));\n    }\n\n    let outcomes = vec![\"Session completed\".to_string()];\n    session.complete(outcomes);\n\n    if session.space_metrics.is_none() {\n        let metrics = calculate_basic_space_metrics(\u0026session);\n        session.set_space_metrics(metrics);\n    }\n\n    if session.dora_metrics.is_none() {\n        let metrics = calculate_basic_dora_metrics(\u0026session);\n        session.set_dora_metrics(metrics);\n    }\n\n    let generic = session.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"Session ended successfully!\");\n    println!(\"Session ID: {}\", session.id);\n    println!(\n        \"Duration: {} seconds\",\n        session.duration_seconds.unwrap_or(0)\n    );\n\n    if generate_summary {\n        println!(\"\\n--- Session Summary ---\");\n        println!(\"Agent: {}\", session.agent);\n        println!(\n            \"Started: {}\",\n            session.start_time.format(\"%Y-%m-%d %H:%M:%S\")\n        );\n        println!(\n            \"Ended: {}\",\n            session.end_time.unwrap().format(\"%Y-%m-%d %H:%M:%S\")\n        );\n\n        if let Some(duration) = session.duration_seconds {\n            let hours = duration / 3600;\n            let minutes = (duration % 3600) / 60;\n            println!(\"Total Duration: {}h {}m\", hours, minutes);\n        }\n\n        println!(\"\\nActivity:\");\n        println!(\"  Tasks: {}\", session.task_ids.len());\n        println!(\"  Context Items: {}\", session.context_ids.len());\n        println!(\"  Knowledge Items: {}\", session.knowledge_ids.len());\n\n        if let Some(ref space) = session.space_metrics {\n            println!(\"\\nProductivity Score: {:.2}/100\", space.overall_score);\n        }\n    }\n\n    Ok(())\n}\n\n/// Calculate basic SPACE metrics for a session\nfn calculate_basic_space_metrics(session: \u0026Session) -\u003e SpaceMetrics {\n    let activity_score =\n        (session.task_ids.len() + session.context_ids.len() + session.knowledge_ids.len()) as f64\n            * 10.0;\n    let activity_score = activity_score.min(100.0);\n\n    let performance_score = if !session.task_ids.is_empty() {\n        70.0\n    } else {\n        50.0\n    };\n\n    let satisfaction_score = 80.0;\n    let communication_score = 50.0;\n    let efficiency_score = activity_score * 0.8;\n\n    let overall_score = (satisfaction_score\n        + performance_score\n        + activity_score\n        + communication_score\n        + efficiency_score)\n        / 5.0;\n\n    SpaceMetrics {\n        satisfaction_score,\n        performance_score,\n        activity_score,\n        communication_score,\n        efficiency_score,\n        overall_score,\n    }\n}\n\n/// Calculate basic DORA metrics for a session\nfn calculate_basic_dora_metrics(session: \u0026Session) -\u003e DoraMetrics {\n    DoraMetrics {\n        deployment_frequency: 0.0,\n        lead_time: if let Some(duration) = session.duration_seconds {\n            duration as f64 / 86400.0\n        } else {\n            0.0\n        },\n        change_failure_rate: 0.0,\n        mean_time_to_recover: 0.0,\n    }\n}\n\n/// List sessions\npub fn list_sessions\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent_filter: Option\u003cString\u003e,\n    limit: Option\u003cusize\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let entity_ids = storage.list_ids(Session::entity_type())?;\n\n    let mut sessions: Vec\u003cSession\u003e = Vec::new();\n    for id in entity_ids {\n        if let Some(generic) = storage.get(\u0026id, Session::entity_type())? {\n            if let Some(ref agent) = agent_filter {\n                if generic.agent != *agent {\n                    continue;\n                }\n            }\n            if let Ok(session) = Session::from_generic(generic) {\n                sessions.push(session);\n            }\n        }\n    }\n\n    sessions.sort_by(|a, b| b.start_time.cmp(\u0026a.start_time));\n\n    if let Some(lim) = limit {\n        sessions.truncate(lim);\n    }\n\n    if sessions.is_empty() {\n        println!(\"No sessions found\");\n        return Ok(());\n    }\n\n    println!(\"Sessions ({})\", sessions.len());\n    println!(\"========================================\");\n\n    for session in sessions {\n        let status_str = match session.status {\n            SessionStatus::Active =\u003e \"Active\",\n            SessionStatus::Paused =\u003e \"Paused\",\n            SessionStatus::Completed =\u003e \"Completed\",\n            SessionStatus::Cancelled =\u003e \"Cancelled\",\n        };\n\n        println!(\"ID: {}\", session.id);\n        println!(\"  Agent: {} | Status: {}\", session.agent, status_str);\n        println!(\n            \"  Started: {}\",\n            session.start_time.format(\"%Y-%m-%d %H:%M\").to_string()\n        );\n        if let Some(end_time) = session.end_time {\n            println!(\"  Ended: {}\", end_time.format(\"%Y-%m-%d %H:%M\").to_string());\n        }\n        println!();\n    }\n\n    Ok(())\n}\n","traces":[{"line":54,"address":[15097073,15097258,15095264],"length":1,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[15095788,15095726],"length":1,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[15096299,15096231],"length":1,"stats":{"Line":0}},{"line":79,"address":[15096436],"length":1,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[15096686],"length":1,"stats":{"Line":0}},{"line":84,"address":[15096916],"length":1,"stats":{"Line":0}},{"line":88,"address":[18908784],"length":1,"stats":{"Line":0}},{"line":89,"address":[18920308],"length":1,"stats":{"Line":0}},{"line":93,"address":[18849629],"length":1,"stats":{"Line":0}},{"line":97,"address":[15099777,15102838,15097280],"length":1,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[15097636,15097379,15097478],"length":1,"stats":{"Line":0}},{"line":104,"address":[15102889,15097865,15097944,15102864],"length":1,"stats":{"Line":0}},{"line":106,"address":[15103056,15098505,15103074,15102786,15098285],"length":1,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[15098736,15098806],"length":1,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[15098974],"length":1,"stats":{"Line":0}},{"line":113,"address":[15099078],"length":1,"stats":{"Line":0}},{"line":114,"address":[15099182],"length":1,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[15099488],"length":1,"stats":{"Line":0}},{"line":121,"address":[15099615,15099545],"length":1,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[15099804,15099837],"length":1,"stats":{"Line":0}},{"line":126,"address":[15099860],"length":1,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[15100185,15100237],"length":1,"stats":{"Line":0}},{"line":133,"address":[15100256],"length":1,"stats":{"Line":0}},{"line":134,"address":[15100407],"length":1,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[15100740],"length":1,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[15100887],"length":1,"stats":{"Line":0}},{"line":150,"address":[15101149],"length":1,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[15101433],"length":1,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[15101949],"length":1,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[15102075,15102112],"length":1,"stats":{"Line":0}},{"line":165,"address":[15102188,15102133],"length":1,"stats":{"Line":0}},{"line":166,"address":[15102212],"length":1,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[15090706,15086480,15091004],"length":1,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[15086579,15086830,15086675],"length":1,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[15091216,15087699,15087479,15090976,15091234],"length":1,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[15087986,15088056,15087912],"length":1,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[15090753,15088072],"length":1,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[15088340],"length":1,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[15088415],"length":1,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[15088481],"length":1,"stats":{"Line":0}},{"line":211,"address":[15088508],"length":1,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[15088756],"length":1,"stats":{"Line":0}},{"line":218,"address":[15088801],"length":1,"stats":{"Line":0}},{"line":219,"address":[15088962],"length":1,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[15089065],"length":1,"stats":{"Line":0}},{"line":225,"address":[15089108],"length":1,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[15089733],"length":1,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[15089770,15090040],"length":1,"stats":{"Line":0}},{"line":243,"address":[15090059],"length":1,"stats":{"Line":0}},{"line":244,"address":[15090200],"length":1,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[15090482],"length":1,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[18698560],"length":1,"stats":{"Line":0}},{"line":257,"address":[25579411,25579184],"length":1,"stats":{"Line":0}},{"line":260,"address":[18920787],"length":1,"stats":{"Line":0}},{"line":262,"address":[26040064,26040110],"length":1,"stats":{"Line":0}},{"line":263,"address":[19936160],"length":1,"stats":{"Line":0}},{"line":265,"address":[19936176],"length":1,"stats":{"Line":0}},{"line":268,"address":[20339373],"length":1,"stats":{"Line":0}},{"line":269,"address":[25579483],"length":1,"stats":{"Line":0}},{"line":270,"address":[19936233],"length":1,"stats":{"Line":0}},{"line":272,"address":[18909422],"length":1,"stats":{"Line":0}},{"line":290,"address":[18698400],"length":1,"stats":{"Line":0}},{"line":293,"address":[19935748,19935828],"length":1,"stats":{"Line":0}},{"line":304,"address":[15093970,15095172,15091360],"length":1,"stats":{"Line":0}},{"line":309,"address":[15091530,15091417,15095170],"length":1,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[15091933,15092068,15091817],"length":1,"stats":{"Line":0}},{"line":313,"address":[15094133,15092145],"length":1,"stats":{"Line":0}},{"line":314,"address":[15094510,15094449],"length":1,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[15094908,15094544,15094810],"length":1,"stats":{"Line":0}},{"line":320,"address":[15094923,15094984],"length":1,"stats":{"Line":0}},{"line":325,"address":[15095200,15095232,15092192],"length":1,"stats":{"Line":0}},{"line":327,"address":[15092226],"length":1,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[15092279,15092296],"length":1,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[15092761],"length":1,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[15092899],"length":1,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[15092957],"length":1,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":164},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","setup.rs"],"content":"//! Setup command implementations\n\nuse crate::error::EngramError;\nuse serde::Serialize;\nuse std::env;\nuse std::fs;\nuse std::path::PathBuf;\n\n/// Setup workspace command\npub fn setup_workspace() -\u003e Result\u003c(), EngramError\u003e {\n    let engram_dir = PathBuf::from(\".engram\");\n    fs::create_dir_all(\u0026engram_dir).map_err(EngramError::Io)?;\n\n    // Create subdirectories\n    let subdirs = [\"agents\", \"workspaces\", \"templates\"];\n    for subdir in \u0026subdirs {\n        fs::create_dir_all(engram_dir.join(subdir)).map_err(EngramError::Io)?;\n    }\n\n    // Create default configuration\n    let config = WorkspaceSetup {\n        agents: std::collections::HashMap::from([\n            (\n                \"coder\".to_string(),\n                AgentSetup {\n                    agent_type: \"implementation\".to_string(),\n                    description: \"Handles code changes and technical implementation tasks\"\n                        .to_string(),\n                },\n            ),\n            (\n                \"reviewer\".to_string(),\n                AgentSetup {\n                    agent_type: \"quality_assurance\".to_string(),\n                    description: \"Reviews code for quality and standards compliance\".to_string(),\n                },\n            ),\n            (\n                \"planner\".to_string(),\n                AgentSetup {\n                    agent_type: \"architecture\".to_string(),\n                    description: \"Handles system design, planning, and architectural decisions\"\n                        .to_string(),\n                },\n            ),\n        ]),\n        workspaces: std::collections::HashMap::from([(\n            \"default\".to_string(),\n            WorkspaceEntry {\n                agents: vec![\"coder\".to_string(), \"reviewer\".to_string()],\n                sync_strategy: \"merge_with_conflict_resolution\".to_string(),\n            },\n        )]),\n    };\n\n    let config_path = engram_dir.join(\"config.yaml\");\n    let config_yaml = serde_yaml::to_string(\u0026config)\n        .map_err(|e| EngramError::Validation(format!(\"Failed to serialize config: {}\", e)))?;\n\n    fs::write(\u0026config_path, config_yaml).map_err(EngramError::Io)?;\n\n    println!(\"‚úÖ Workspace initialized for Engram team collaboration\");\n    println!(\"üìù Configuration created at: {:?}\", config_path);\n\n    Ok(())\n}\n\n/// Setup agent command\npub fn setup_agent(\n    name: \u0026str,\n    agent_type: \u0026str,\n    specialization: Option\u003c\u0026str\u003e,\n    email: Option\u003c\u0026str\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let engram_dir = PathBuf::from(\".engram\");\n    fs::create_dir_all(\u0026engram_dir.join(\"agents\")).map_err(EngramError::Io)?;\n\n    let agent_profile = AgentProfile {\n        name: name.to_string(),\n        agent_type: agent_type.to_string(),\n        specialization: specialization.map(|s| s.to_string()).unwrap_or_default(),\n        email: email.map(|e| e.to_string()),\n        created_at: chrono::Utc::now().format(\"%Y-%m-%d\").to_string(),\n        version: \"1.0.0\".to_string(),\n        capabilities: vec![\n            \"memory_storage\".to_string(),\n            \"task_management\".to_string(),\n            \"context_tracking\".to_string(),\n            \"reasoning_chains\".to_string(),\n            \"knowledge_graph\".to_string(),\n            \"team_collaboration\".to_string(),\n        ],\n        commands: vec![\n            format!(\"engram task create --title \\\"Task Title\\\" --agent {}\", name),\n            format!(\n                \"engram context create --source \\\"documentation\\\" --agent {}\",\n                name\n            ),\n            format!(\n                \"engram reasoning create --task-id \\\"task-123\\\" --agent {}\",\n                name\n            ),\n            \"engram sync --agents \\\"agent1,agent2\\\" --strategy \\\"merge_with_conflict_resolution\\\"\"\n                .to_string(),\n        ],\n        workspace_access: WorkspaceAccess {\n            repositories: vec![\"./\".to_string()],\n            tools: vec![\"git\".to_string(), \"rust\".to_string(), \"cargo\".to_string()],\n        },\n    };\n\n    let agent_file = engram_dir.join(\"agents\").join(format!(\"{}.yaml\", name));\n    let agent_yaml = serde_yaml::to_string(\u0026agent_profile).map_err(|e| {\n        EngramError::Validation(format!(\"Failed to serialize agent profile: {}\", e))\n    })?;\n\n    fs::write(\u0026agent_file, agent_yaml).map_err(EngramError::Io)?;\n\n    println!(\"‚úÖ Agent '{}' ({}) profile created\", name, agent_type);\n    println!(\"üìù Profile saved to: {:?}\", agent_file);\n\n    Ok(())\n}\n\n/// Setup OpenCode skills command\npub fn setup_skills() -\u003e Result\u003c(), EngramError\u003e {\n    use std::env;\n\n    // Get OpenCode config directory\n    let opencode_dir = env::var(\"HOME\")\n        .map(|home| PathBuf::from(home).join(\".config\").join(\"opencode\"))\n        .map_err(|_| EngramError::Validation(\"HOME environment variable not set\".to_string()))?;\n\n    let skills_dir = opencode_dir.join(\"skills\");\n    fs::create_dir_all(\u0026skills_dir).map_err(EngramError::Io)?;\n\n    // List of built-in Engram skills to install with their content\n    let skills: \u0026[(\u0026str, \u0026str)] = \u0026[\n        // Meta Skills\n        (\n            \"engram-use-engram-memory\",\n            include_str!(\"../../skills/meta/use-engram-memory.md\"),\n        ),\n        (\n            \"engram-delegate-to-agents\",\n            include_str!(\"../../skills/meta/delegate-to-agents.md\"),\n        ),\n        (\n            \"engram-audit-trail\",\n            include_str!(\"../../skills/meta/audit-trail.md\"),\n        ),\n        (\n            \"engram-dispatching-parallel-agents\",\n            include_str!(\"../../skills/meta/dispatching-parallel-agents.md\"),\n        ),\n        // Workflow Skills\n        (\n            \"engram-brainstorming\",\n            include_str!(\"../../skills/workflow/brainstorming.md\"),\n        ),\n        (\n            \"engram-writing-plans\",\n            include_str!(\"../../skills/workflow/writing-plans.md\"),\n        ),\n        (\n            \"engram-plan-feature\",\n            include_str!(\"../../skills/workflow/plan-feature.md\"),\n        ),\n        (\n            \"engram-requesting-code-review\",\n            include_str!(\"../../skills/workflow/requesting-code-review.md\"),\n        ),\n        // Development Skills\n        (\n            \"engram-test-driven-development\",\n            include_str!(\"../../skills/development/test-driven-development.md\"),\n        ),\n        (\n            \"engram-subagent-driven-development\",\n            include_str!(\"../../skills/development/subagent-driven-development.md\"),\n        ),\n        // Debugging Skills\n        (\n            \"engram-systematic-debugging\",\n            include_str!(\"../../skills/debugging/systematic-debugging.md\"),\n        ),\n        // Compliance Skills\n        (\n            \"engram-check-compliance\",\n            include_str!(\"../../skills/compliance/check-compliance.md\"),\n        ),\n        // Planning Skills (7)\n        (\n            \"engram-risk-assessment\",\n            include_str!(\"../../skills/planning/risk-assessment.md\"),\n        ),\n        (\n            \"engram-spike-investigation\",\n            include_str!(\"../../skills/planning/spike-investigation.md\"),\n        ),\n        (\n            \"engram-dependency-mapping\",\n            include_str!(\"../../skills/planning/dependency-mapping.md\"),\n        ),\n        (\n            \"engram-capacity-planning\",\n            include_str!(\"../../skills/planning/capacity-planning.md\"),\n        ),\n        (\n            \"engram-release-planning\",\n            include_str!(\"../../skills/planning/release-planning.md\"),\n        ),\n        (\n            \"engram-backlog-refinement\",\n            include_str!(\"../../skills/planning/backlog-refinement.md\"),\n        ),\n        (\n            \"engram-roadmap-planning\",\n            include_str!(\"../../skills/planning/roadmap-planning.md\"),\n        ),\n        // Documentation Skills (6)\n        (\n            \"engram-adr\",\n            include_str!(\"../../skills/documentation/adr.md\"),\n        ),\n        (\n            \"engram-api-docs\",\n            include_str!(\"../../skills/documentation/api-docs.md\"),\n        ),\n        (\n            \"engram-knowledge-transfer\",\n            include_str!(\"../../skills/documentation/knowledge-transfer.md\"),\n        ),\n        (\n            \"engram-runbooks\",\n            include_str!(\"../../skills/documentation/runbooks.md\"),\n        ),\n        (\n            \"engram-changelog\",\n            include_str!(\"../../skills/documentation/changelog.md\"),\n        ),\n        (\n            \"engram-technical-writing\",\n            include_str!(\"../../skills/documentation/technical-writing.md\"),\n        ),\n        // Architecture Skills (8)\n        (\n            \"engram-system-design\",\n            include_str!(\"../../skills/architecture/system-design.md\"),\n        ),\n        (\n            \"engram-security-architecture\",\n            include_str!(\"../../skills/architecture/security-architecture.md\"),\n        ),\n        (\n            \"engram-data-modeling\",\n            include_str!(\"../../skills/architecture/data-modeling.md\"),\n        ),\n        (\n            \"engram-api-design\",\n            include_str!(\"../../skills/architecture/api-design.md\"),\n        ),\n        (\n            \"engram-scalability-analysis\",\n            include_str!(\"../../skills/architecture/scalability-analysis.md\"),\n        ),\n        (\n            \"engram-refactoring-strategy\",\n            include_str!(\"../../skills/architecture/refactoring-strategy.md\"),\n        ),\n        (\n            \"engram-observability-design\",\n            include_str!(\"../../skills/architecture/observability-design.md\"),\n        ),\n        (\n            \"engram-integration-patterns\",\n            include_str!(\"../../skills/architecture/integration-patterns.md\"),\n        ),\n        // Quality Skills (5)\n        (\n            \"engram-assumption-validation\",\n            include_str!(\"../../skills/quality/assumption-validation.md\"),\n        ),\n        (\n            \"engram-edge-cases\",\n            include_str!(\"../../skills/quality/edge-cases.md\"),\n        ),\n        (\n            \"engram-tech-debt\",\n            include_str!(\"../../skills/quality/tech-debt.md\"),\n        ),\n        (\n            \"engram-performance-analysis\",\n            include_str!(\"../../skills/quality/performance-analysis.md\"),\n        ),\n        (\n            \"engram-accessibility\",\n            include_str!(\"../../skills/quality/accessibility.md\"),\n        ),\n        // Review Skills (4)\n        (\n            \"engram-security-review\",\n            include_str!(\"../../skills/review/security-review.md\"),\n        ),\n        (\n            \"engram-code-quality\",\n            include_str!(\"../../skills/review/code-quality.md\"),\n        ),\n        (\n            \"engram-post-mortem\",\n            include_str!(\"../../skills/review/post-mortem.md\"),\n        ),\n        (\n            \"engram-retrospective\",\n            include_str!(\"../../skills/review/retrospective.md\"),\n        ),\n    ];\n\n    let mut installed_count = 0;\n\n    for (skill_name, skill_content) in skills {\n        let skill_dir = skills_dir.join(skill_name);\n\n        // Skip if skill already exists (user skill takes precedence)\n        if skill_dir.exists() {\n            println!(\n                \"‚ö†Ô∏è  Skill '{}' already exists, skipping (user skill preserved)\",\n                skill_name\n            );\n            continue;\n        }\n\n        fs::create_dir_all(\u0026skill_dir).map_err(EngramError::Io)?;\n\n        // Create SKILL.md file with embedded content\n        let skill_file = skill_dir.join(\"SKILL.md\");\n        fs::write(\u0026skill_file, skill_content).map_err(EngramError::Io)?;\n\n        println!(\"‚úÖ Installed skill: {}\", skill_name);\n        installed_count += 1;\n    }\n\n    println!();\n    println!(\"üéâ OpenCode skills setup complete!\");\n    println!(\"üìÅ Skills installed to: {:?}\", skills_dir);\n    println!(\"üìä Total skills installed: {}\", installed_count);\n    println!();\n    println!(\"üí° Skills are now available in OpenCode with 'engram:' prefix\");\n    println!(\"   Example: @general can now use 'engram:use-engram-memory'\");\n    println!();\n    println!(\"üìñ To use skills:\");\n    println!(\"   1. Restart OpenCode to reload skills\");\n    println!(\"   2. Use @mention with skill name\");\n    println!(\"   3. Or call skill() tool with skill name\");\n\n    Ok(())\n}\n\n/// Setup OpenCode prompts command\npub fn setup_prompts(prompts_path: Option\u003c\u0026str\u003e) -\u003e Result\u003c(), EngramError\u003e {\n    let prompts_source = prompts_path.unwrap_or(\"./prompts\");\n    let prompts_source_path = PathBuf::from(prompts_source);\n\n    // Get OpenCode config directory\n    let opencode_dir = env::var(\"HOME\")\n        .map(|home| PathBuf::from(home).join(\".config\").join(\"opencode\"))\n        .map_err(|_| EngramError::Validation(\"HOME environment variable not set\".to_string()))?;\n\n    let opencode_prompts_dir = opencode_dir.join(\"prompts\");\n    fs::create_dir_all(\u0026opencode_prompts_dir).map_err(EngramError::Io)?;\n\n    // Check if source prompts directory exists\n    if !prompts_source_path.exists() {\n        return Err(EngramError::Validation(format!(\n            \"Prompts source directory does not exist: {:?}\",\n            prompts_source_path\n        )));\n    }\n\n    // Categories to install\n    let categories = [\n        (\n            \"agents\",\n            \"Specialized subagents like Researcher, Coder, Reviewer\",\n        ),\n        (\n            \"pipelines\",\n            \"AI workflows for Bug Triage, Feature Dev, Refactoring\",\n        ),\n        (\n            \"compliance\",\n            \"Prompts for Security, GDPR, and Audit standards\",\n        ),\n    ];\n\n    let mut installed_count = 0;\n\n    for (category, description) in categories {\n        let source_dir = prompts_source_path.join(category);\n        let target_dir = opencode_prompts_dir.join(category);\n\n        if source_dir.exists() {\n            // Copy entire category directory\n            copy_dir_recursive(\u0026source_dir, \u0026target_dir)?;\n            println!(\n                \"‚úÖ Installed prompts category: {} ({})\",\n                category, description\n            );\n            installed_count += 1;\n        } else {\n            println!(\"‚ö†Ô∏è  Prompts category '{}' not found in source\", category);\n        }\n    }\n\n    println!();\n    println!(\"üéâ OpenCode prompts setup complete!\");\n    println!(\"üìÅ Prompts installed to: {:?}\", opencode_prompts_dir);\n    println!(\"üìä Total categories installed: {}\", installed_count);\n    println!();\n    println!(\"üí° Prompts are now available in OpenCode\");\n    println!(\"   Skills: Guides like Git Workflow, Testing Guidelines\");\n    println!(\"   Agents: Specialized subagents like Researcher, Coder, Reviewer\");\n    println!(\"   Pipelines: AI workflows for Bug Triage, Feature Dev, Refactoring\");\n    println!(\"   Compliance: Prompts for Security, GDPR, and Audit standards\");\n\n    Ok(())\n}\n\n/// Helper function to recursively copy directories\nfn copy_dir_recursive(source: \u0026PathBuf, target: \u0026PathBuf) -\u003e Result\u003c(), EngramError\u003e {\n    fs::create_dir_all(target).map_err(EngramError::Io)?;\n\n    for entry in fs::read_dir(source).map_err(EngramError::Io)? {\n        let entry = entry.map_err(EngramError::Io)?;\n        let source_path = entry.path();\n        let target_path = target.join(entry.file_name().to_str().unwrap());\n\n        if source_path.is_dir() {\n            copy_dir_recursive(\u0026source_path, \u0026target_path)?;\n        } else {\n            fs::copy(\u0026source_path, \u0026target_path).map_err(EngramError::Io)?;\n        }\n    }\n\n    Ok(())\n}\n\n/// Workspace setup configuration structure\n#[derive(Debug, Serialize)]\nstruct WorkspaceSetup {\n    agents: std::collections::HashMap\u003cString, AgentSetup\u003e,\n    workspaces: std::collections::HashMap\u003cString, WorkspaceEntry\u003e,\n}\n\n/// Agent setup configuration\n#[derive(Debug, Serialize)]\nstruct AgentSetup {\n    agent_type: String,\n    description: String,\n}\n\n/// Workspace entry configuration\n#[derive(Debug, Serialize)]\nstruct WorkspaceEntry {\n    agents: Vec\u003cString\u003e,\n    sync_strategy: String,\n}\n\n/// Agent profile structure\n#[derive(Debug, Serialize)]\nstruct AgentProfile {\n    name: String,\n    agent_type: String,\n    specialization: String,\n    email: Option\u003cString\u003e,\n    created_at: String,\n    version: String,\n    capabilities: Vec\u003cString\u003e,\n    commands: Vec\u003cString\u003e,\n    workspace_access: WorkspaceAccess,\n}\n\n/// Workspace access configuration\n#[derive(Debug, Serialize)]\nstruct WorkspaceAccess {\n    repositories: Vec\u003cString\u003e,\n    tools: Vec\u003cString\u003e,\n}\n","traces":[{"line":10,"address":[19812016,19815737,19816015],"length":1,"stats":{"Line":0}},{"line":11,"address":[19812033],"length":1,"stats":{"Line":0}},{"line":12,"address":[27006026,27002096,27002167],"length":1,"stats":{"Line":0}},{"line":15,"address":[21323123],"length":1,"stats":{"Line":0}},{"line":16,"address":[26541732],"length":1,"stats":{"Line":0}},{"line":17,"address":[19812540,19815800],"length":1,"stats":{"Line":0}},{"line":22,"address":[18825512],"length":1,"stats":{"Line":0}},{"line":47,"address":[18826381],"length":1,"stats":{"Line":0}},{"line":56,"address":[19874016,19874087],"length":1,"stats":{"Line":0}},{"line":57,"address":[19663623,19663721,19664495,19663829],"length":1,"stats":{"Line":0}},{"line":58,"address":[27005045,27004958],"length":1,"stats":{"Line":0}},{"line":60,"address":[19886454,19886064,19885946],"length":1,"stats":{"Line":0}},{"line":62,"address":[27005468],"length":1,"stats":{"Line":0}},{"line":63,"address":[18738794],"length":1,"stats":{"Line":0}},{"line":65,"address":[19815606],"length":1,"stats":{"Line":0}},{"line":69,"address":[18724128,18729569,18729413],"length":1,"stats":{"Line":0}},{"line":75,"address":[19800709],"length":1,"stats":{"Line":0}},{"line":76,"address":[18729547,18724441,18724358],"length":1,"stats":{"Line":0}},{"line":79,"address":[26991150],"length":1,"stats":{"Line":0}},{"line":80,"address":[21311985],"length":1,"stats":{"Line":0}},{"line":81,"address":[18724852,18724916],"length":1,"stats":{"Line":0}},{"line":82,"address":[19864374,19864352],"length":1,"stats":{"Line":0}},{"line":83,"address":[18813331,18813391],"length":1,"stats":{"Line":0}},{"line":84,"address":[19872365],"length":1,"stats":{"Line":0}},{"line":85,"address":[18725695,18725407,18725479,18725736,18725297,18725623,18725239,18725551,18725344,18729467],"length":1,"stats":{"Line":0}},{"line":93,"address":[19651209,19651270,19651846,19651890,19654718,19651313,19651492,19651671],"length":1,"stats":{"Line":0}},{"line":106,"address":[19863387],"length":1,"stats":{"Line":0}},{"line":112,"address":[19804578],"length":1,"stats":{"Line":0}},{"line":113,"address":[19852880,19853129,19853123],"length":1,"stats":{"Line":0}},{"line":114,"address":[19864495,19864427],"length":1,"stats":{"Line":0}},{"line":117,"address":[19876630,19875995,19876113],"length":1,"stats":{"Line":0}},{"line":119,"address":[26534856],"length":1,"stats":{"Line":0}},{"line":120,"address":[18817579],"length":1,"stats":{"Line":0}},{"line":122,"address":[18817683],"length":1,"stats":{"Line":0}},{"line":126,"address":[18729584,18732133,18731994],"length":1,"stats":{"Line":0}},{"line":130,"address":[19865437,19865367,19865521],"length":1,"stats":{"Line":0}},{"line":131,"address":[19876913],"length":1,"stats":{"Line":0}},{"line":132,"address":[26535511,26535583],"length":1,"stats":{"Line":0}},{"line":134,"address":[19865702,19865619],"length":1,"stats":{"Line":0}},{"line":135,"address":[19865734,19865807,19867932],"length":1,"stats":{"Line":0}},{"line":138,"address":[21317534],"length":1,"stats":{"Line":0}},{"line":319,"address":[26996761],"length":1,"stats":{"Line":0}},{"line":321,"address":[18730229],"length":1,"stats":{"Line":0}},{"line":322,"address":[21317741,21318493],"length":1,"stats":{"Line":0}},{"line":325,"address":[21318528,21318599],"length":1,"stats":{"Line":0}},{"line":326,"address":[26537180,26537937],"length":1,"stats":{"Line":0}},{"line":333,"address":[18819775,18819708,18820476],"length":1,"stats":{"Line":0}},{"line":336,"address":[19656790],"length":1,"stats":{"Line":0}},{"line":337,"address":[19808175,19808102],"length":1,"stats":{"Line":0}},{"line":339,"address":[19879110],"length":1,"stats":{"Line":0}},{"line":340,"address":[19867686,19867734],"length":1,"stats":{"Line":0}},{"line":343,"address":[21317761],"length":1,"stats":{"Line":0}},{"line":344,"address":[18818894],"length":1,"stats":{"Line":0}},{"line":345,"address":[19866291],"length":1,"stats":{"Line":0}},{"line":346,"address":[19807147],"length":1,"stats":{"Line":0}},{"line":347,"address":[26536587],"length":1,"stats":{"Line":0}},{"line":348,"address":[18819192],"length":1,"stats":{"Line":0}},{"line":349,"address":[19807333],"length":1,"stats":{"Line":0}},{"line":350,"address":[18819282],"length":1,"stats":{"Line":0}},{"line":351,"address":[18730883],"length":1,"stats":{"Line":0}},{"line":352,"address":[26997484],"length":1,"stats":{"Line":0}},{"line":353,"address":[19866761],"length":1,"stats":{"Line":0}},{"line":354,"address":[19878326],"length":1,"stats":{"Line":0}},{"line":356,"address":[19807611],"length":1,"stats":{"Line":0}},{"line":360,"address":[19811942,19808720,19811993],"length":1,"stats":{"Line":0}},{"line":361,"address":[18820686],"length":1,"stats":{"Line":0}},{"line":362,"address":[18820726],"length":1,"stats":{"Line":0}},{"line":365,"address":[18735364,18732500,18732275,18732412],"length":1,"stats":{"Line":0}},{"line":366,"address":[19853835,19853808],"length":1,"stats":{"Line":0}},{"line":367,"address":[19879709,19879796],"length":1,"stats":{"Line":0}},{"line":369,"address":[19809177,19809248],"length":1,"stats":{"Line":0}},{"line":370,"address":[21320169,21322764,21320096],"length":1,"stats":{"Line":0}},{"line":373,"address":[19809517],"length":1,"stats":{"Line":0}},{"line":374,"address":[19868821,19869246],"length":1,"stats":{"Line":0}},{"line":381,"address":[19880533],"length":1,"stats":{"Line":0}},{"line":396,"address":[19809861],"length":1,"stats":{"Line":0}},{"line":398,"address":[19880640,19881068,19880971],"length":1,"stats":{"Line":0}},{"line":399,"address":[21321219,21321916],"length":1,"stats":{"Line":0}},{"line":400,"address":[18734528,18734599],"length":1,"stats":{"Line":0}},{"line":402,"address":[19870576,19871083,19870505],"length":1,"stats":{"Line":0}},{"line":404,"address":[19811508,19811408],"length":1,"stats":{"Line":0}},{"line":405,"address":[18823557],"length":1,"stats":{"Line":0}},{"line":409,"address":[18735217,18735185],"length":1,"stats":{"Line":0}},{"line":411,"address":[19660167,19660109],"length":1,"stats":{"Line":0}},{"line":415,"address":[19881210],"length":1,"stats":{"Line":0}},{"line":416,"address":[19869735],"length":1,"stats":{"Line":0}},{"line":417,"address":[19810540],"length":1,"stats":{"Line":0}},{"line":418,"address":[19881412],"length":1,"stats":{"Line":0}},{"line":419,"address":[19869988],"length":1,"stats":{"Line":0}},{"line":420,"address":[26540129],"length":1,"stats":{"Line":0}},{"line":421,"address":[27000846],"length":1,"stats":{"Line":0}},{"line":422,"address":[18822779],"length":1,"stats":{"Line":0}},{"line":423,"address":[19881688],"length":1,"stats":{"Line":0}},{"line":424,"address":[26540309],"length":1,"stats":{"Line":0}},{"line":426,"address":[21321831],"length":1,"stats":{"Line":0}},{"line":430,"address":[21328715,21328723,21326848],"length":1,"stats":{"Line":0}},{"line":431,"address":[19875346],"length":1,"stats":{"Line":0}},{"line":433,"address":[26545583,26545868],"length":1,"stats":{"Line":0}},{"line":434,"address":[27006602,27006674,27007921],"length":1,"stats":{"Line":0}},{"line":435,"address":[19876128],"length":1,"stats":{"Line":0}},{"line":436,"address":[18828941,18828863],"length":1,"stats":{"Line":0}},{"line":438,"address":[26546652],"length":1,"stats":{"Line":0}},{"line":439,"address":[19817837,19817659,19817421],"length":1,"stats":{"Line":0}},{"line":441,"address":[18740676,18740607,18740850],"length":1,"stats":{"Line":0}},{"line":445,"address":[19665387],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":105},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","skills.rs"],"content":"use crate::error::EngramError;\nuse clap::Subcommand;\nuse std::path::PathBuf;\n\n/// Skills commands\n#[derive(Debug, Subcommand)]\npub enum SkillsCommands {\n    /// Install OpenCode skills\n    Setup,\n    /// List all available skills\n    List {\n        /// Format output (short, full)\n        #[arg(long, short, default_value = \"short\")]\n        format: String,\n    },\n    /// Show skill details\n    Show {\n        /// Skill name or path\n        #[arg(help = \"Skill name or path\")]\n        name: String,\n    },\n}\n\n/// Get skills path from environment or default\npub fn get_skills_path() -\u003e PathBuf {\n    std::env::var(\"ENGRAM_SKILLS_PATH\")\n        .map(PathBuf::from)\n        .unwrap_or_else(|_| PathBuf::from(\"./engram/skills\"))\n}\n\n/// List all skills in skills directory\npub fn list_skills(format: \u0026str) -\u003e Result\u003c(), std::io::Error\u003e {\n    let skills_path = get_skills_path();\n\n    if !skills_path.exists() {\n        println!(\"Skills directory not found: {:?}\", skills_path);\n        println!(\"Set ENGRAM_SKILLS_PATH environment variable.\");\n        return Ok(());\n    }\n\n    let entries = std::fs::read_dir(\u0026skills_path)?;\n\n    match format {\n        \"short\" | \"s\" =\u003e {\n            println!(\"Available Skills:\");\n            println!(\"=================\");\n            for entry in entries.flatten() {\n                if entry.path().is_dir() {\n                    println!(\"  - {}\", entry.file_name().to_string_lossy());\n                }\n            }\n        }\n        \"full\" | \"f\" =\u003e {\n            println!(\"Available Skills:\");\n            println!(\"=================\");\n            for entry in entries.flatten() {\n                if entry.path().is_dir() {\n                    let file_name = entry.file_name();\n                    let name = file_name.to_string_lossy();\n                    let skill_file = entry.path().join(\"skill.md\");\n                    let description = if skill_file.exists() {\n                        let content = std::fs::read_to_string(\u0026skill_file)?;\n                        content.lines().next().unwrap_or(\"\").to_string()\n                    } else {\n                        \"(no description)\".to_string()\n                    };\n                    println!(\"\\n[{}]\", name);\n                    println!(\"  Description: {}\", description);\n                }\n            }\n        }\n        _ =\u003e {\n            println!(\"Unknown format: {}. Use 'short' or 'full'.\", format);\n        }\n    }\n\n    Ok(())\n}\n\n/// Show a specific skill\npub fn show_skill(name: \u0026str) -\u003e Result\u003c(), std::io::Error\u003e {\n    let skills_path = get_skills_path();\n\n    // Try exact match first, then case-insensitive\n    let skill_path = PathBuf::from(name);\n\n    let actual_path = if skill_path.exists() \u0026\u0026 skill_path.is_dir() {\n        skill_path\n    } else {\n        // Search for matching directory\n        let name_lower = name.to_lowercase();\n        let entries = std::fs::read_dir(\u0026skills_path)?;\n        let found_path = entries\n            .flatten()\n            .filter(|e| e.path().is_dir())\n            .find(|e| {\n                let file_name = e.file_name();\n                file_name.to_string_lossy().to_lowercase() == name_lower\n            })\n            .map(|e| e.path());\n\n        if let Some(path) = found_path {\n            path\n        } else {\n            skills_path.join(name)\n        }\n    };\n\n    if !actual_path.exists() {\n        println!(\"Skill not found: {}\", name);\n        println!(\"Searched in: {:?}\", skills_path);\n        return Ok(());\n    }\n\n    // List skill contents\n    println!(\n        \"\\nSkill: {}\",\n        actual_path\n            .file_name()\n            .unwrap_or_default()\n            .to_string_lossy()\n    );\n    println!(\"======\");\n\n    let entries = std::fs::read_dir(\u0026actual_path)?;\n    for entry in entries.flatten() {\n        let file_name = entry.file_name();\n        let file_type = if entry.path().is_dir() {\n            \"[DIR]\"\n        } else {\n            \"[FILE]\"\n        };\n        println!(\"  {} {}\", file_type, file_name.to_string_lossy());\n\n        if entry.path().is_file() {\n            let content = std::fs::read_to_string(entry.path())?;\n            let preview = String::from_iter(content.lines().take(5));\n            if preview.len() \u003e 100 {\n                println!(\"       {}\", \u0026preview[..100]);\n            } else {\n                println!(\"       {}\", preview);\n            }\n        }\n    }\n\n    Ok(())\n}\n\n/// Handle setup skills command\npub fn handle_skills_command(_command: crate::cli::SkillsCommands) -\u003e Result\u003c(), EngramError\u003e {\n    use std::env;\n\n    // Get OpenCode config directory\n    let opencode_dir = env::var(\"HOME\")\n        .map(|home| PathBuf::from(home).join(\".config\").join(\"opencode\"))\n        .map_err(|_| EngramError::Validation(\"HOME environment variable not set\".to_string()))?;\n\n    let skills_dir = opencode_dir.join(\"skills\");\n    std::fs::create_dir_all(\u0026skills_dir).map_err(EngramError::Io)?;\n\n    // List of built-in Engram skills to install with their content\n    let skills: \u0026[(\u0026str, \u0026str)] = \u0026[\n        (\n            \"engram-use-engram-memory\",\n            include_str!(\"../../skills/meta/use-engram-memory.md\"),\n        ),\n        (\n            \"engram-delegate-to-agents\",\n            include_str!(\"../../skills/meta/delegate-to-agents.md\"),\n        ),\n        (\n            \"engram-audit-trail\",\n            include_str!(\"../../skills/meta/audit-trail.md\"),\n        ),\n        (\n            \"engram-brainstorming\",\n            include_str!(\"../../skills/workflow/brainstorming.md\"),\n        ),\n        (\n            \"engram-writing-plans\",\n            include_str!(\"../../skills/workflow/writing-plans.md\"),\n        ),\n        (\n            \"engram-plan-feature\",\n            include_str!(\"../../skills/workflow/plan-feature.md\"),\n        ),\n        (\n            \"engram-requesting-code-review\",\n            include_str!(\"../../skills/workflow/requesting-code-review.md\"),\n        ),\n        (\n            \"engram-check-compliance\",\n            include_str!(\"../../skills/compliance/check-compliance.md\"),\n        ),\n        (\n            \"engram-test-driven-development\",\n            include_str!(\"../../skills/development/test-driven-development.md\"),\n        ),\n        (\n            \"engram-systematic-debugging\",\n            include_str!(\"../../skills/debugging/systematic-debugging.md\"),\n        ),\n        (\n            \"engram-subagent-driven-development\",\n            include_str!(\"../../skills/development/subagent-driven-development.md\"),\n        ),\n        (\n            \"engram-dispatching-parallel-agents\",\n            include_str!(\"../../skills/meta/dispatching-parallel-agents.md\"),\n        ),\n    ];\n\n    let mut installed_count = 0;\n\n    for (skill_name, skill_content) in skills {\n        let skill_dir = skills_dir.join(skill_name);\n\n        // Skip if skill already exists (user skill take precedence)\n        if skill_dir.exists() {\n            println!(\n                \"‚ö†Ô∏è  Skill '{}' already exists, skipping (user skill preserved)\",\n                skill_name\n            );\n            continue;\n        }\n\n        std::fs::create_dir_all(\u0026skill_dir).map_err(EngramError::Io)?;\n\n        // Create SKILL.md file with embedded content\n        let skill_file = skill_dir.join(\"SKILL.md\");\n        std::fs::write(\u0026skill_file, skill_content).map_err(EngramError::Io)?;\n\n        println!(\"‚úÖ Installed skill: {}\", skill_name);\n        installed_count += 1;\n    }\n\n    println!();\n    println!(\"üéâ Skills setup complete!\");\n    println!(\"üìÅ Skills installed to: {:?}\", skills_dir);\n    println!(\"üìä Total skills installed: {}\", installed_count);\n    println!();\n    println!(\"üí° Skills are now available with 'engram:' prefix\");\n    println!(\"   Example: skill() tool with 'engram:use-engram-memory'\");\n    println!();\n    println!(\"üìñ To use skills:\");\n    println!(\"   1. Restart your agent session to reload skills\");\n    println!(\"   2. Use skill() tool with skill name\");\n\n    Ok(())\n}\n","traces":[{"line":25,"address":[27312160],"length":1,"stats":{"Line":0}},{"line":26,"address":[20431582],"length":1,"stats":{"Line":0}},{"line":27,"address":[21527013],"length":1,"stats":{"Line":0}},{"line":28,"address":[19367744,19367760],"length":1,"stats":{"Line":0}},{"line":32,"address":[15383376,15387166,15386112],"length":1,"stats":{"Line":0}},{"line":33,"address":[27308279],"length":1,"stats":{"Line":0}},{"line":35,"address":[15383519,15383436],"length":1,"stats":{"Line":0}},{"line":36,"address":[20579094,20579151],"length":1,"stats":{"Line":0}},{"line":37,"address":[27769236],"length":1,"stats":{"Line":0}},{"line":38,"address":[27308609],"length":1,"stats":{"Line":0}},{"line":41,"address":[22093593,22090112,22089937],"length":1,"stats":{"Line":0}},{"line":44,"address":[15383900,15384074,15383990],"length":1,"stats":{"Line":0}},{"line":45,"address":[22092635,22090402],"length":1,"stats":{"Line":0}},{"line":46,"address":[20430590],"length":1,"stats":{"Line":0}},{"line":47,"address":[27311394,27311227],"length":1,"stats":{"Line":0}},{"line":48,"address":[20582129,20582289],"length":1,"stats":{"Line":0}},{"line":49,"address":[27311786],"length":1,"stats":{"Line":0}},{"line":53,"address":[27309105,27308972],"length":1,"stats":{"Line":0}},{"line":54,"address":[20579725,20579904],"length":1,"stats":{"Line":0}},{"line":55,"address":[20428675],"length":1,"stats":{"Line":0}},{"line":56,"address":[21524128,21524295],"length":1,"stats":{"Line":0}},{"line":57,"address":[27309659,27309558],"length":1,"stats":{"Line":0}},{"line":58,"address":[27309830],"length":1,"stats":{"Line":0}},{"line":59,"address":[21524681,21524772],"length":1,"stats":{"Line":0}},{"line":60,"address":[21524855,21524779],"length":1,"stats":{"Line":0}},{"line":61,"address":[27310216],"length":1,"stats":{"Line":0}},{"line":62,"address":[20640266,20640199,20640951],"length":1,"stats":{"Line":0}},{"line":63,"address":[15385616,15385695],"length":1,"stats":{"Line":0}},{"line":65,"address":[20651688,20651746],"length":1,"stats":{"Line":0}},{"line":67,"address":[21525600,21525148],"length":1,"stats":{"Line":0}},{"line":68,"address":[20581517],"length":1,"stats":{"Line":0}},{"line":73,"address":[15384227],"length":1,"stats":{"Line":0}},{"line":77,"address":[20650641],"length":1,"stats":{"Line":0}},{"line":81,"address":[20574416,20575726,20578890],"length":1,"stats":{"Line":0}},{"line":82,"address":[20574439],"length":1,"stats":{"Line":0}},{"line":85,"address":[20574567,20574488],"length":1,"stats":{"Line":0}},{"line":87,"address":[20423412,20423335,20423485,20423611],"length":1,"stats":{"Line":0}},{"line":88,"address":[20423555],"length":1,"stats":{"Line":0}},{"line":91,"address":[15379255],"length":1,"stats":{"Line":0}},{"line":92,"address":[27304279,27305106,27304208],"length":1,"stats":{"Line":0}},{"line":93,"address":[21519247],"length":1,"stats":{"Line":0}},{"line":95,"address":[17878336,17878350],"length":1,"stats":{"Line":0}},{"line":96,"address":[15993776,15994202,15994196],"length":1,"stats":{"Line":0}},{"line":97,"address":[17937164],"length":1,"stats":{"Line":0}},{"line":98,"address":[17948781,17948865,17948708],"length":1,"stats":{"Line":0}},{"line":100,"address":[17877792,17877808],"length":1,"stats":{"Line":0}},{"line":102,"address":[22086351,22086210],"length":1,"stats":{"Line":0}},{"line":103,"address":[20424239],"length":1,"stats":{"Line":0}},{"line":105,"address":[27304963,27304889],"length":1,"stats":{"Line":0}},{"line":109,"address":[27765680,27765892],"length":1,"stats":{"Line":0}},{"line":110,"address":[22086788,22086727],"length":1,"stats":{"Line":0}},{"line":111,"address":[15380581],"length":1,"stats":{"Line":0}},{"line":112,"address":[20646913],"length":1,"stats":{"Line":0}},{"line":116,"address":[20635552],"length":1,"stats":{"Line":0}},{"line":123,"address":[20635711],"length":1,"stats":{"Line":0}},{"line":125,"address":[27305852,27308156],"length":1,"stats":{"Line":0}},{"line":126,"address":[20425520,20425644,20425436],"length":1,"stats":{"Line":0}},{"line":127,"address":[15381476],"length":1,"stats":{"Line":0}},{"line":128,"address":[20636420,20636496,20636706],"length":1,"stats":{"Line":0}},{"line":129,"address":[22088247],"length":1,"stats":{"Line":0}},{"line":131,"address":[20648147],"length":1,"stats":{"Line":0}},{"line":133,"address":[27767494,27767430],"length":1,"stats":{"Line":0}},{"line":135,"address":[27767727],"length":1,"stats":{"Line":0}},{"line":136,"address":[27767918,27768723],"length":1,"stats":{"Line":0}},{"line":137,"address":[20637382,20637461],"length":1,"stats":{"Line":0}},{"line":138,"address":[20427039,20427100],"length":1,"stats":{"Line":0}},{"line":139,"address":[15383018,15382874],"length":1,"stats":{"Line":0}},{"line":141,"address":[27307774,27307706],"length":1,"stats":{"Line":0}},{"line":146,"address":[15381521],"length":1,"stats":{"Line":0}},{"line":150,"address":[20431664,20434359,20434199],"length":1,"stats":{"Line":0}},{"line":154,"address":[27773088,27775621,27772959,27773199],"length":1,"stats":{"Line":0}},{"line":155,"address":[15994619,15994592],"length":1,"stats":{"Line":0}},{"line":156,"address":[17938144,17938162],"length":1,"stats":{"Line":0}},{"line":158,"address":[20432036,20432113],"length":1,"stats":{"Line":0}},{"line":159,"address":[22096381,22094282,22094209],"length":1,"stats":{"Line":0}},{"line":162,"address":[21527785],"length":1,"stats":{"Line":0}},{"line":213,"address":[20583652],"length":1,"stats":{"Line":0}},{"line":215,"address":[15387997],"length":1,"stats":{"Line":0}},{"line":216,"address":[20654600,20655326],"length":1,"stats":{"Line":0}},{"line":219,"address":[20655361,20655432],"length":1,"stats":{"Line":0}},{"line":220,"address":[20644722,20643965],"length":1,"stats":{"Line":0}},{"line":227,"address":[15389076,15389013,15389741],"length":1,"stats":{"Line":0}},{"line":230,"address":[22095735],"length":1,"stats":{"Line":0}},{"line":231,"address":[22095872,22095799],"length":1,"stats":{"Line":0}},{"line":233,"address":[21529383],"length":1,"stats":{"Line":0}},{"line":234,"address":[20644615,20644567],"length":1,"stats":{"Line":0}},{"line":237,"address":[20654620],"length":1,"stats":{"Line":0}},{"line":238,"address":[27773913],"length":1,"stats":{"Line":0}},{"line":239,"address":[20432702],"length":1,"stats":{"Line":0}},{"line":240,"address":[20643302],"length":1,"stats":{"Line":0}},{"line":241,"address":[15388471],"length":1,"stats":{"Line":0}},{"line":242,"address":[22095011],"length":1,"stats":{"Line":0}},{"line":243,"address":[15388561],"length":1,"stats":{"Line":0}},{"line":244,"address":[27774301],"length":1,"stats":{"Line":0}},{"line":245,"address":[27774346],"length":1,"stats":{"Line":0}},{"line":246,"address":[27313719],"length":1,"stats":{"Line":0}},{"line":247,"address":[20433172],"length":1,"stats":{"Line":0}},{"line":249,"address":[20433225],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":98},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","standard.rs"],"content":"use crate::entities::{Entity, Standard, StandardCategory, StandardRequirement, StandardStatus};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse chrono::Utc;\nuse clap::Subcommand;\n\n/// Standard commands\n#[derive(Debug, Subcommand)]\npub enum StandardCommands {\n    /// Create a new standard\n    Create {\n        /// Standard title\n        #[arg(long, short)]\n        title: String,\n\n        /// Standard description\n        #[arg(long)]\n        description: Option\u003cString\u003e,\n\n        /// Standard category (coding, testing, documentation, security, performance, process, architecture)\n        #[arg(long, default_value = \"process\")]\n        category: String,\n\n        /// Version\n        #[arg(long, default_value = \"1.0\")]\n        version: String,\n\n        /// Effective date (ISO 8601 format, defaults to now)\n        #[arg(long)]\n        effective_date: Option\u003cString\u003e,\n\n        /// Agent to assign\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n    },\n    /// Get standard details\n    Get {\n        /// Standard ID\n        #[arg(help = \"Standard ID to retrieve\")]\n        id: String,\n    },\n    /// Update standard\n    Update {\n        /// Standard ID\n        #[arg(help = \"Standard ID to update\")]\n        id: String,\n\n        /// Standard title\n        #[arg(long)]\n        title: Option\u003cString\u003e,\n\n        /// Standard description\n        #[arg(long)]\n        description: Option\u003cString\u003e,\n\n        /// Standard category\n        #[arg(long)]\n        category: Option\u003cString\u003e,\n\n        /// Version\n        #[arg(long)]\n        version: Option\u003cString\u003e,\n\n        /// Standard status (draft, active, deprecated, superseded)\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n\n        /// Effective date (ISO 8601 format)\n        #[arg(long)]\n        effective_date: Option\u003cString\u003e,\n\n        /// Superseded by standard ID\n        #[arg(long)]\n        superseded_by: Option\u003cString\u003e,\n    },\n    /// Delete standard\n    Delete {\n        /// Standard ID\n        #[arg(help = \"Standard ID to delete\")]\n        id: String,\n    },\n    /// List standards\n    List {\n        /// Category filter\n        #[arg(long)]\n        category: Option\u003cString\u003e,\n\n        /// Status filter\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n\n        /// Text search\n        #[arg(long)]\n        search: Option\u003cString\u003e,\n\n        /// Limit results\n        #[arg(long, default_value = \"20\")]\n        limit: usize,\n\n        /// Offset for pagination\n        #[arg(long, default_value = \"0\")]\n        offset: usize,\n    },\n    /// Add requirement to standard\n    AddRequirement {\n        /// Standard ID\n        #[arg(help = \"Standard ID to add requirement to\")]\n        id: String,\n\n        /// Requirement title\n        #[arg(long)]\n        title: String,\n\n        /// Requirement description\n        #[arg(long)]\n        description: String,\n\n        /// Whether requirement is mandatory\n        #[arg(long, action)]\n        mandatory: bool,\n\n        /// Priority level (low, medium, high, critical)\n        #[arg(long, default_value = \"medium\")]\n        priority: String,\n\n        /// Evidence required\n        #[arg(long, action)]\n        evidence_required: bool,\n    },\n}\n\n/// Create a new standard\npub fn create_standard\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    title: String,\n    description: Option\u003cString\u003e,\n    category: String,\n    version: String,\n    effective_date: Option\u003cString\u003e,\n    agent: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let category = match category.to_lowercase().as_str() {\n        \"coding\" =\u003e StandardCategory::Coding,\n        \"testing\" =\u003e StandardCategory::Testing,\n        \"documentation\" =\u003e StandardCategory::Documentation,\n        \"security\" =\u003e StandardCategory::Security,\n        \"performance\" =\u003e StandardCategory::Performance,\n        \"process\" =\u003e StandardCategory::Process,\n        \"architecture\" =\u003e StandardCategory::Architecture,\n        _ =\u003e {\n            println!(\"‚ùå Invalid category. Use: coding, testing, documentation, security, performance, process, architecture\");\n            return Ok(());\n        }\n    };\n\n    let effective_date = match effective_date {\n        Some(date_str) =\u003e chrono::DateTime::parse_from_rfc3339(\u0026date_str)\n            .map_err(|e| EngramError::Validation(format!(\"Invalid date format: {}\", e)))?\n            .with_timezone(\u0026Utc),\n        None =\u003e Utc::now(),\n    };\n\n    let standard = Standard::new(\n        title,\n        description.unwrap_or_default(),\n        category,\n        version,\n        agent.unwrap_or_else(|| \"cli\".to_string()),\n        effective_date,\n    );\n\n    let generic = standard.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"‚úÖ Standard created: {}\", standard.id());\n    display_standard(\u0026standard);\n\n    Ok(())\n}\n\n/// Get standard details\npub fn get_standard\u003cS: Storage\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"standard\")? {\n        let standard =\n            Standard::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        display_standard(\u0026standard);\n    } else {\n        println!(\"‚ùå Standard not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Update standard\npub fn update_standard\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    title: Option\u003cString\u003e,\n    description: Option\u003cString\u003e,\n    category: Option\u003cString\u003e,\n    version: Option\u003cString\u003e,\n    status: Option\u003cString\u003e,\n    effective_date: Option\u003cString\u003e,\n    superseded_by: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"standard\")? {\n        let mut standard =\n            Standard::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        let mut updated = false;\n\n        if let Some(title) = title {\n            standard.title = title;\n            updated = true;\n        }\n\n        if let Some(description) = description {\n            standard.description = description;\n            updated = true;\n        }\n\n        if let Some(category_str) = category {\n            let new_category = match category_str.to_lowercase().as_str() {\n                \"coding\" =\u003e StandardCategory::Coding,\n                \"testing\" =\u003e StandardCategory::Testing,\n                \"documentation\" =\u003e StandardCategory::Documentation,\n                \"security\" =\u003e StandardCategory::Security,\n                \"performance\" =\u003e StandardCategory::Performance,\n                \"process\" =\u003e StandardCategory::Process,\n                \"architecture\" =\u003e StandardCategory::Architecture,\n                _ =\u003e {\n                    println!(\"‚ùå Invalid category. Use: coding, testing, documentation, security, performance, process, architecture\");\n                    return Ok(());\n                }\n            };\n            standard.category = new_category;\n            updated = true;\n        }\n\n        if let Some(version) = version {\n            standard.version = version;\n            updated = true;\n        }\n\n        if let Some(status_str) = status {\n            let new_status = match status_str.to_lowercase().as_str() {\n                \"draft\" =\u003e StandardStatus::Draft,\n                \"active\" =\u003e StandardStatus::Active,\n                \"deprecated\" =\u003e StandardStatus::Deprecated,\n                \"superseded\" =\u003e StandardStatus::Superseded,\n                _ =\u003e {\n                    println!(\"‚ùå Invalid status. Use: draft, active, deprecated, superseded\");\n                    return Ok(());\n                }\n            };\n            standard.status = new_status;\n            updated = true;\n        }\n\n        if let Some(date_str) = effective_date {\n            let new_effective_date = chrono::DateTime::parse_from_rfc3339(\u0026date_str)\n                .map_err(|e| EngramError::Validation(format!(\"Invalid date format: {}\", e)))?\n                .with_timezone(\u0026Utc);\n            standard.effective_date = new_effective_date;\n            updated = true;\n        }\n\n        if let Some(superseded_by_id) = superseded_by {\n            if superseded_by_id.is_empty() {\n                standard.superseded_by = None;\n            } else {\n                standard.superseded_by = Some(superseded_by_id);\n                standard.status = StandardStatus::Superseded;\n            }\n            updated = true;\n        }\n\n        if !updated {\n            println!(\"No updates specified\");\n            return Ok(());\n        }\n\n        standard.updated_at = chrono::Utc::now();\n        let updated_generic = standard.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\"‚úÖ Standard updated: {}\", id);\n    } else {\n        println!(\"‚ùå Standard not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Delete standard\npub fn delete_standard\u003cS: Storage\u003e(storage: \u0026mut S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"standard\")? {\n        let mut standard =\n            Standard::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        standard.deprecate(None);\n        let updated_generic = standard.to_generic();\n        storage.store(\u0026updated_generic)?;\n        println!(\"‚úÖ Standard deleted (deprecated): {}\", id);\n    } else {\n        println!(\"‚ùå Standard not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// List standards\npub fn list_standards\u003cS: Storage\u003e(\n    storage: \u0026S,\n    category: Option\u003cString\u003e,\n    status: Option\u003cString\u003e,\n    search: Option\u003cString\u003e,\n    limit: usize,\n    offset: usize,\n) -\u003e Result\u003c(), EngramError\u003e {\n    use crate::storage::QueryFilter;\n    use serde_json::Value;\n    use std::collections::HashMap;\n\n    let mut filter = QueryFilter {\n        entity_type: Some(\"standard\".to_string()),\n        text_search: search,\n        limit: Some(limit),\n        offset: Some(offset),\n        ..Default::default()\n    };\n\n    let mut field_filters = HashMap::new();\n\n    if let Some(category_filter) = category {\n        field_filters.insert(\"category\".to_string(), Value::String(category_filter));\n    }\n\n    if let Some(status_filter) = status {\n        field_filters.insert(\"status\".to_string(), Value::String(status_filter));\n    }\n\n    if !field_filters.is_empty() {\n        filter.field_filters = field_filters;\n    }\n\n    let result = storage.query(\u0026filter)?;\n\n    println!(\"üìã Standards List\");\n    println!(\"=================\");\n\n    if result.entities.is_empty() {\n        println!(\"No standards found matching the criteria.\");\n        return Ok(());\n    }\n\n    println!(\n        \"Found {} standards (showing {} to {} of {})\",\n        result.total_count,\n        offset + 1,\n        offset + result.entities.len(),\n        result.total_count\n    );\n    println!();\n\n    for (i, entity) in result.entities.iter().enumerate() {\n        let standard_data = \u0026entity.data;\n        let index = offset + i + 1;\n\n        let title = standard_data\n            .get(\"title\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"Untitled Standard\");\n\n        let category = standard_data\n            .get(\"category\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"general\");\n\n        let status = standard_data\n            .get(\"status\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"draft\");\n\n        let version = standard_data\n            .get(\"version\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"1.0\");\n\n        let status_symbol = match status {\n            \"active\" =\u003e \"üü¢\",\n            \"draft\" =\u003e \"üü°\",\n            \"deprecated\" =\u003e \"üî¥\",\n            \"review\" =\u003e \"üîµ\",\n            _ =\u003e \"‚ö™\",\n        };\n\n        let category_symbol = match category {\n            \"coding\" =\u003e \"üíª\",\n            \"security\" =\u003e \"üîí\",\n            \"quality\" =\u003e \"‚ö°\",\n            \"process\" =\u003e \"üîÑ\",\n            \"documentation\" =\u003e \"üìù\",\n            _ =\u003e \"üìã\",\n        };\n\n        println!(\n            \"{}. {} {} {} v{}\",\n            index, status_symbol, category_symbol, title, version\n        );\n\n        println!(\"   ID: {}\", entity.id);\n\n        if let Some(description) = standard_data.get(\"description\").and_then(|v| v.as_str()) {\n            let truncated = if description.len() \u003e 80 {\n                format!(\"{}...\", \u0026description[..77])\n            } else {\n                description.to_string()\n            };\n            println!(\"   üìÑ {}\", truncated);\n        }\n\n        println!(\"   üè∑Ô∏è  Category: {} | üìä Status: {}\", category, status);\n\n        if let Some(requirements) = standard_data.get(\"requirements\").and_then(|v| v.as_array()) {\n            println!(\"   üìã {} requirements\", requirements.len());\n        }\n\n        println!(\n            \"   üë§ Agent: {} | üìÖ {}\",\n            entity.agent,\n            entity.timestamp.format(\"%Y-%m-%d %H:%M\")\n        );\n\n        println!();\n    }\n\n    if result.has_more {\n        println!(\"üí° Use --offset {} to see more standards\", offset + limit);\n    }\n\n    println!(\"üí° Use 'engram standard get \u003cid\u003e' to view full standard details\");\n    println!(\"üí° Use 'engram standard add-requirement \u003cid\u003e' to add requirements\");\n\n    Ok(())\n}\n\n/// Add requirement to standard\npub fn add_requirement\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    title: String,\n    description: String,\n    mandatory: bool,\n    priority: String,\n    evidence_required: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"standard\")? {\n        let mut standard =\n            Standard::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        let priority = match priority.to_lowercase().as_str() {\n            \"low\" =\u003e crate::entities::rule::RulePriority::Low,\n            \"medium\" =\u003e crate::entities::rule::RulePriority::Medium,\n            \"high\" =\u003e crate::entities::rule::RulePriority::High,\n            \"critical\" =\u003e crate::entities::rule::RulePriority::Critical,\n            _ =\u003e {\n                println!(\"‚ùå Invalid priority. Use: low, medium, high, critical\");\n                return Ok(());\n            }\n        };\n\n        let requirement = StandardRequirement {\n            id: uuid::Uuid::new_v4().to_string(),\n            title,\n            description,\n            mandatory,\n            priority,\n            validation_criteria: Vec::new(),\n            evidence_required,\n        };\n\n        standard.add_requirement(requirement);\n\n        let updated_generic = standard.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\"‚úÖ Requirement added to standard: {}\", id);\n    } else {\n        println!(\"‚ùå Standard not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Display standard information\nfn display_standard(standard: \u0026Standard) {\n    println!(\"üìã Standard: {}\", standard.id());\n    println!(\"üìù Title: {}\", standard.title);\n    println!(\"üìÑ Description: {}\", standard.description);\n    println!(\"üè∑Ô∏è Category: {:?}\", standard.category);\n    println!(\"üìä Status: {:?}\", standard.status);\n    println!(\"üî¢ Version: {}\", standard.version);\n    println!(\"ü§ñ Agent: {}\", standard.agent);\n    println!(\n        \"üìÖ Effective Date: {}\",\n        standard.effective_date.format(\"%Y-%m-%d %H:%M\")\n    );\n    println!(\n        \"üïê Created: {}\",\n        standard.created_at.format(\"%Y-%m-%d %H:%M\")\n    );\n    println!(\n        \"üîÑ Updated: {}\",\n        standard.updated_at.format(\"%Y-%m-%d %H:%M\")\n    );\n\n    if let Some(ref superseded_by) = standard.superseded_by {\n        println!(\"üîó Superseded By: {}\", superseded_by);\n    }\n\n    if !standard.supersedes.is_empty() {\n        println!(\"üìã Supersedes: {:?}\", standard.supersedes);\n    }\n\n    if !standard.related_standards.is_empty() {\n        println!(\"üîó Related Standards: {:?}\", standard.related_standards);\n    }\n\n    if !standard.requirements.is_empty() {\n        println!(\"üìå Requirements: {}\", standard.requirements.len());\n        for (i, req) in standard.requirements.iter().enumerate() {\n            println!(\n                \"  {}. {} - {} ({})\",\n                i + 1,\n                req.title,\n                if req.mandatory {\n                    \"Mandatory\"\n                } else {\n                    \"Optional\"\n                },\n                format!(\"{:?}\", req.priority)\n            );\n        }\n    }\n\n    println!(\"‚úÖ Is Effective: {}\", standard.is_effective());\n}\n","traces":[{"line":133,"address":[14856880,14859328,14859913],"length":1,"stats":{"Line":0}},{"line":142,"address":[14857264,14857169,14856985],"length":1,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[14857603,14857672,14857640],"length":1,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[14846518],"length":1,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[14863966,14868233,14861504],"length":1,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[14862608,14862676],"length":1,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[14862635,14862839,14863069],"length":1,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[14863557,14863478,14863518],"length":1,"stats":{"Line":0}},{"line":226,"address":[14863574,14863534,14863613],"length":1,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[14863686,14863646,14863725],"length":1,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[14863811],"length":1,"stats":{"Line":0}},{"line":235,"address":[14863922],"length":1,"stats":{"Line":0}},{"line":236,"address":[14863936],"length":1,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[14864011,14864079],"length":1,"stats":{"Line":0}},{"line":241,"address":[14864202],"length":1,"stats":{"Line":0}},{"line":244,"address":[14864038,14864223],"length":1,"stats":{"Line":0}},{"line":245,"address":[14864477,14864262,14864382],"length":1,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[14864717,14864648,14864685],"length":1,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[14864835],"length":1,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[14864912,14865032,14865181,14865090],"length":1,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[14865271],"length":1,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[14864937,14865914,14865361],"length":1,"stats":{"Line":0}},{"line":268,"address":[14865483,14865901,14865408],"length":1,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[14865751],"length":1,"stats":{"Line":0}},{"line":277,"address":[14865419],"length":1,"stats":{"Line":0}},{"line":278,"address":[14866005,14865960],"length":1,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[14866328],"length":1,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[14866478],"length":1,"stats":{"Line":0}},{"line":294,"address":[14860192,14861339,14861345],"length":1,"stats":{"Line":0}},{"line":295,"address":[14860232],"length":1,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[14860908],"length":1,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[14861150],"length":1,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[14846784,14847986,14853819],"length":1,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[14847672,14847793],"length":1,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[14848070,14848349,14848558],"length":1,"stats":{"Line":0}},{"line":340,"address":[14848465,14848355],"length":1,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[14848874],"length":1,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[14849004,14853521],"length":1,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[14849510],"length":1,"stats":{"Line":0}},{"line":363,"address":[14849820],"length":1,"stats":{"Line":0}},{"line":364,"address":[14850364,14850266,14849840],"length":1,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[14850652],"length":1,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[14850809],"length":1,"stats":{"Line":0}},{"line":378,"address":[14850707,14853897,14853888],"length":1,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[14851173,14851280,14851245],"length":1,"stats":{"Line":0}},{"line":391,"address":[14851251],"length":1,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[14851431,14851356,14851476],"length":1,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[14851741],"length":1,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[14852089],"length":1,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[14852342,14852413],"length":1,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[14852429,14852491],"length":1,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[14852832,14852362],"length":1,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[14853132,14853057],"length":1,"stats":{"Line":0}},{"line":425,"address":[14853092],"length":1,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[14850107],"length":1,"stats":{"Line":0}},{"line":441,"address":[14850160],"length":1,"stats":{"Line":0}},{"line":445,"address":[14856692,14854048,14856351],"length":1,"stats":{"Line":0}},{"line":454,"address":[14856617,14854205,14854329],"length":1,"stats":{"Line":0}},{"line":455,"address":[14856736,14854754,14856398,14854673,14856754],"length":1,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[14855232,14855166],"length":1,"stats":{"Line":0}},{"line":460,"address":[14855288,14855209,14855249],"length":1,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[14855358,14855321,14855390],"length":1,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[14855364,14855400],"length":1,"stats":{"Line":0}},{"line":465,"address":[14855427],"length":1,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[14855623],"length":1,"stats":{"Line":0}},{"line":479,"address":[14855858],"length":1,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[14855988,14855917],"length":1,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[20452470,20449440,20452464],"length":1,"stats":{"Line":0}},{"line":493,"address":[20227447],"length":1,"stats":{"Line":0}},{"line":494,"address":[20146981],"length":1,"stats":{"Line":0}},{"line":495,"address":[20147094],"length":1,"stats":{"Line":0}},{"line":496,"address":[20227802],"length":1,"stats":{"Line":0}},{"line":497,"address":[27569172],"length":1,"stats":{"Line":0}},{"line":498,"address":[20379267],"length":1,"stats":{"Line":0}},{"line":499,"address":[21890184],"length":1,"stats":{"Line":0}},{"line":500,"address":[27108866],"length":1,"stats":{"Line":0}},{"line":504,"address":[20438935],"length":1,"stats":{"Line":0}},{"line":508,"address":[20450712],"length":1,"stats":{"Line":0}},{"line":513,"address":[20148193],"length":1,"stats":{"Line":0}},{"line":514,"address":[21324328],"length":1,"stats":{"Line":0}},{"line":517,"address":[20229041],"length":1,"stats":{"Line":0}},{"line":518,"address":[20439559],"length":1,"stats":{"Line":0}},{"line":521,"address":[20451188],"length":1,"stats":{"Line":0}},{"line":522,"address":[20229197],"length":1,"stats":{"Line":0}},{"line":525,"address":[21324717],"length":1,"stats":{"Line":0}},{"line":526,"address":[20380586],"length":1,"stats":{"Line":0}},{"line":527,"address":[27571005,27570744],"length":1,"stats":{"Line":0}},{"line":528,"address":[20149236],"length":1,"stats":{"Line":0}},{"line":542,"address":[20229605],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":217},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","sync.rs"],"content":"use crate::entities::GenericEntity;\nuse crate::error::EngramError;\nuse crate::storage::{ConflictResolution, RemoteAuth, Storage, SyncResult};\nuse chrono::Utc;\nuse git2::{Cred, FetchOptions, IndexAddOption, PushOptions, RemoteCallbacks, Repository};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::fs;\nuse std::path::Path;\n\n#[derive(clap::Subcommand)]\npub enum SyncCommands {\n    /// Synchronize agents locally\n    Sync {\n        #[arg(long, short)]\n        agents: String,\n\n        #[arg(long, short, default_value = \"merge_with_conflict_resolution\")]\n        strategy: String,\n\n        #[arg(long, default_value_t = false)]\n        dry_run: bool,\n    },\n    /// Add remote repository\n    AddRemote {\n        name: String,\n        url: String,\n        #[arg(long, default_value = \"main\")]\n        branch: String,\n        #[arg(long)]\n        auth_type: Option\u003cString\u003e,\n        #[arg(long)]\n        username: Option\u003cString\u003e,\n        #[arg(long)]\n        password: Option\u003cString\u003e,\n        #[arg(long)]\n        ssh_key: Option\u003cString\u003e,\n    },\n    /// List configured remotes\n    ListRemotes,\n    /// Show sync status with remote\n    Status {\n        #[arg(long)]\n        remote: Option\u003cString\u003e,\n    },\n    /// Pull from remote\n    Pull {\n        #[arg(long)]\n        remote: String,\n        #[arg(long)]\n        branch: Option\u003cString\u003e,\n        #[arg(long)]\n        agents: Option\u003cString\u003e,\n        #[arg(long)]\n        auth_type: Option\u003cString\u003e,\n        #[arg(long)]\n        username: Option\u003cString\u003e,\n        #[arg(long)]\n        password: Option\u003cString\u003e,\n        #[arg(long)]\n        ssh_key: Option\u003cString\u003e,\n        #[arg(long, default_value_t = false)]\n        dry_run: bool,\n    },\n    /// Push to remote  \n    Push {\n        #[arg(long)]\n        remote: String,\n        #[arg(long)]\n        branch: Option\u003cString\u003e,\n        #[arg(long)]\n        agents: Option\u003cString\u003e,\n        #[arg(long)]\n        auth_type: Option\u003cString\u003e,\n        #[arg(long)]\n        username: Option\u003cString\u003e,\n        #[arg(long)]\n        password: Option\u003cString\u003e,\n        #[arg(long)]\n        ssh_key: Option\u003cString\u003e,\n        #[arg(long, default_value_t = false)]\n        dry_run: bool,\n    },\n    /// Create a new branch for agent isolation\n    CreateBranch {\n        name: String,\n        #[arg(long)]\n        agent: Option\u003cString\u003e,\n        #[arg(long)]\n        from: Option\u003cString\u003e,\n    },\n    /// Switch to a different branch\n    SwitchBranch {\n        name: String,\n        #[arg(long, default_value_t = false)]\n        create: bool,\n    },\n    /// List all branches\n    ListBranches {\n        #[arg(long, default_value_t = false)]\n        all: bool,\n        #[arg(long, default_value_t = false)]\n        current: bool,\n    },\n    /// Delete a branch\n    DeleteBranch {\n        name: String,\n        #[arg(long, default_value_t = false)]\n        force: bool,\n    },\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub enum MergeStrategy {\n    LatestWins,\n    IntelligentMerge,\n    MergeWithConflictResolution,\n    PriorityWins { agent: String },\n}\n\nimpl MergeStrategy {\n    pub fn from_str(s: \u0026str) -\u003e Result\u003cSelf, EngramError\u003e {\n        match s.to_lowercase().as_str() {\n            \"latest_wins\" | \"latest-wins\" =\u003e Ok(MergeStrategy::LatestWins),\n            \"intelligent_merge\" | \"intelligent-merge\" =\u003e Ok(MergeStrategy::IntelligentMerge),\n            \"merge_with_conflict_resolution\" | \"merge-with-conflict-resolution\" =\u003e {\n                Ok(MergeStrategy::MergeWithConflictResolution)\n            }\n            s if s.starts_with(\"priority_wins:\") =\u003e {\n                let agent = s.strip_prefix(\"priority_wins:\").unwrap_or(\"\").to_string();\n                if agent.is_empty() {\n                    return Err(EngramError::Validation(\n                        \"Priority agent required for priority_wins strategy\".to_string()\n                    ));\n                }\n                Ok(MergeStrategy::PriorityWins { agent })\n            }\n            _ =\u003e Err(EngramError::Validation(format!(\n                \"Unknown merge strategy: {}. Valid options: latest_wins, intelligent_merge, merge_with_conflict_resolution, priority_wins:\u003cagent\u003e\",\n                s\n            ))),\n        }\n    }\n}\n\npub fn sync_agents\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    agents: Vec\u003cString\u003e,\n    strategy: MergeStrategy,\n    dry_run: bool,\n) -\u003e Result\u003cSyncResult, EngramError\u003e {\n    let start_time = Utc::now();\n\n    println!(\"üîÑ Starting synchronization...\");\n    println!(\"ü§ñ Agents: {}\", agents.join(\", \"));\n    println!(\"üìã Strategy: {:?}\", strategy);\n    if dry_run {\n        println!(\"üîç Mode: Dry run (no changes will be made)\");\n    }\n    println!();\n\n    if agents.is_empty() {\n        return Err(EngramError::Validation(\"No agents specified\".to_string()));\n    }\n\n    if agents.len() == 1 {\n        println!(\"‚ÑπÔ∏è  Only one agent specified, nothing to synchronize\");\n        return Ok(SyncResult {\n            entities_synced: 0,\n            conflicts_resolved: Vec::new(),\n            errors: Vec::new(),\n            timestamp: start_time,\n            synced_agents: agents,\n            merged_entities: 0,\n            duration_ms: 0,\n        });\n    }\n\n    let entity_types = vec![\n        \"task\",\n        \"context\",\n        \"reasoning\",\n        \"knowledge\",\n        \"session\",\n        \"compliance\",\n        \"rule\",\n        \"standard\",\n        \"adr\",\n        \"workflow\",\n    ];\n    let mut total_synced = 0;\n    let mut total_merged = 0;\n    let mut all_conflicts = Vec::new();\n    let mut errors = Vec::new();\n\n    for entity_type in entity_types {\n        match sync_entity_type(storage, entity_type, \u0026agents, \u0026strategy, dry_run) {\n            Ok((synced, merged, conflicts)) =\u003e {\n                total_synced += synced;\n                total_merged += merged;\n                all_conflicts.extend(conflicts);\n\n                if synced \u003e 0 {\n                    println!(\n                        \"‚úÖ {} entities: {} synced, {} merged\",\n                        entity_type, synced, merged\n                    );\n                }\n            }\n            Err(e) =\u003e {\n                let error_msg = format!(\"Failed to sync {}: {}\", entity_type, e);\n                println!(\"‚ùå {}\", error_msg);\n                errors.push(error_msg);\n            }\n        }\n    }\n\n    if !dry_run \u0026\u0026 total_synced \u003e 0 {\n        storage.sync()?;\n    }\n\n    let end_time = Utc::now();\n    let duration = end_time.signed_duration_since(start_time);\n\n    println!(\"\\n=== Synchronization Complete ===\");\n    println!(\"üìä Total entities synchronized: {}\", total_synced);\n    println!(\"üîó Total entities merged: {}\", total_merged);\n    println!(\"‚ö†Ô∏è  Conflicts resolved: {}\", all_conflicts.len());\n    println!(\"‚è±Ô∏è  Duration: {}ms\", duration.num_milliseconds());\n\n    if !errors.is_empty() {\n        println!(\"‚ùå Errors: {}\", errors.len());\n        for error in \u0026errors {\n            println!(\"   ‚Ä¢ {}\", error);\n        }\n    }\n\n    Ok(SyncResult {\n        entities_synced: total_synced,\n        conflicts_resolved: all_conflicts,\n        errors,\n        timestamp: start_time,\n        synced_agents: agents,\n        merged_entities: total_merged,\n        duration_ms: duration.num_milliseconds() as u64,\n    })\n}\n\nfn sync_entity_type\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    entity_type: \u0026str,\n    agents: \u0026[String],\n    strategy: \u0026MergeStrategy,\n    dry_run: bool,\n) -\u003e Result\u003c(usize, usize, Vec\u003cConflictResolution\u003e), EngramError\u003e {\n    println!(\"\\nüîç Synchronizing {} entities...\", entity_type);\n\n    let mut all_entities: Vec\u003cGenericEntity\u003e = Vec::new();\n\n    for agent in agents {\n        let agent_entities = storage.query_by_agent(agent, Some(entity_type))?;\n        println!(\n            \"  üìÇ Found {} {} entities from agent {}\",\n            agent_entities.len(),\n            entity_type,\n            agent\n        );\n        all_entities.extend(agent_entities);\n    }\n\n    if all_entities.is_empty() {\n        return Ok((0, 0, Vec::new()));\n    }\n\n    let entity_count_before = all_entities.len();\n\n    let (merged_entities, conflicts) = match strategy {\n        MergeStrategy::LatestWins =\u003e {\n            let merged = merge_latest_wins(all_entities)?;\n            (merged, Vec::new())\n        }\n        MergeStrategy::IntelligentMerge =\u003e {\n            let merged = merge_intelligent(all_entities)?;\n            (merged, Vec::new())\n        }\n        MergeStrategy::MergeWithConflictResolution =\u003e merge_with_conflict_detection(all_entities)?,\n        MergeStrategy::PriorityWins { agent } =\u003e {\n            let merged = merge_priority_wins(all_entities, agent)?;\n            (merged, Vec::new())\n        }\n    };\n\n    let entity_count_after = merged_entities.len();\n    let merged_count = entity_count_before - entity_count_after;\n\n    if merged_count \u003e 0 {\n        println!(\n            \"  üîó Merged {} duplicate/conflicting entities\",\n            merged_count\n        );\n    }\n\n    if !dry_run {\n        for entity in \u0026merged_entities {\n            storage.store(entity)?;\n        }\n    }\n\n    Ok((merged_entities.len(), merged_count, conflicts))\n}\n\nfn merge_latest_wins(entities: Vec\u003cGenericEntity\u003e) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n    use std::collections::HashMap;\n\n    let mut entity_map: HashMap\u003cString, GenericEntity\u003e = HashMap::new();\n\n    for entity in entities {\n        let key = entity.id.clone();\n\n        if let Some(existing) = entity_map.get(\u0026key) {\n            if entity.timestamp \u003e existing.timestamp {\n                entity_map.insert(key, entity);\n            }\n        } else {\n            entity_map.insert(key, entity);\n        }\n    }\n\n    Ok(entity_map.into_values().collect())\n}\n\nfn merge_intelligent(entities: Vec\u003cGenericEntity\u003e) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n    use std::collections::HashMap;\n\n    let mut entity_map: HashMap\u003cString, GenericEntity\u003e = HashMap::new();\n\n    for entity in entities {\n        let key = entity.id.clone();\n\n        if let Some(existing) = entity_map.get_mut(\u0026key) {\n            if entity.timestamp \u003e existing.timestamp {\n                let merged = intelligent_merge_entity(existing.clone(), entity)?;\n                entity_map.insert(key, merged);\n            }\n        } else {\n            entity_map.insert(key, entity);\n        }\n    }\n\n    Ok(entity_map.into_values().collect())\n}\n\nfn merge_priority_wins(\n    entities: Vec\u003cGenericEntity\u003e,\n    priority_agent: \u0026str,\n) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n    use std::collections::HashMap;\n\n    let mut entity_map: HashMap\u003cString, GenericEntity\u003e = HashMap::new();\n\n    for entity in entities {\n        let key = entity.id.clone();\n\n        if let Some(existing) = entity_map.get(\u0026key) {\n            if entity.agent == priority_agent {\n                entity_map.insert(key, entity);\n            } else if existing.agent != priority_agent \u0026\u0026 entity.timestamp \u003e existing.timestamp {\n                entity_map.insert(key, entity);\n            }\n        } else {\n            entity_map.insert(key, entity);\n        }\n    }\n\n    Ok(entity_map.into_values().collect())\n}\n\nfn intelligent_merge_entity(\n    existing: GenericEntity,\n    newer: GenericEntity,\n) -\u003e Result\u003cGenericEntity, EngramError\u003e {\n    let mut merged = newer.clone();\n\n    if let (Some(existing_obj), Some(newer_obj)) =\n        (existing.data.as_object(), merged.data.as_object_mut())\n    {\n        for (key, existing_value) in existing_obj {\n            if let Some(newer_value) = newer_obj.get(key) {\n                if newer_value.is_null()\n                    || (newer_value.is_string() \u0026\u0026 newer_value.as_str().unwrap_or(\"\").is_empty())\n                    || (newer_value.is_array()\n                        \u0026\u0026 newer_value.as_array().unwrap_or(\u0026vec![]).is_empty())\n                {\n                    newer_obj.insert(key.clone(), existing_value.clone());\n                }\n            } else {\n                newer_obj.insert(key.clone(), existing_value.clone());\n            }\n        }\n    }\n\n    Ok(merged)\n}\n\nfn merge_with_conflict_detection(\n    entities: Vec\u003cGenericEntity\u003e,\n) -\u003e Result\u003c(Vec\u003cGenericEntity\u003e, Vec\u003cConflictResolution\u003e), EngramError\u003e {\n    use std::collections::HashMap;\n\n    let mut entity_map: HashMap\u003cString, GenericEntity\u003e = HashMap::new();\n    let mut conflicts = Vec::new();\n\n    for entity in entities {\n        let key = entity.id.clone();\n\n        if let Some(existing) = entity_map.get(\u0026key) {\n            if has_conflict(existing, \u0026entity) {\n                println!(\n                    \"  ‚ö†Ô∏è  CONFLICT: Entity {} has conflicting changes from different agents\",\n                    key\n                );\n\n                let conflict_details = analyze_conflict(existing, \u0026entity);\n                let conflict_resolution = ConflictResolution {\n                    entity_id: key.clone(),\n                    entity_type: entity.entity_type.clone(),\n                    strategy_used: crate::storage::SyncStrategy::LatestWins,\n                    winner: if entity.timestamp \u003e existing.timestamp {\n                        entity.agent.clone()\n                    } else {\n                        existing.agent.clone()\n                    },\n                    conflicts_detected: conflict_details,\n                };\n\n                if entity.timestamp \u003e existing.timestamp {\n                    println!(\n                        \"    ‚úÖ Resolving with newer version from {} (timestamp: {})\",\n                        entity.agent, entity.timestamp\n                    );\n                    entity_map.insert(key, entity);\n                } else {\n                    println!(\n                        \"    ‚úÖ Keeping existing version from {} (timestamp: {})\",\n                        existing.agent, existing.timestamp\n                    );\n                }\n\n                conflicts.push(conflict_resolution);\n            } else {\n                if entity.timestamp \u003e existing.timestamp {\n                    entity_map.insert(key, entity);\n                }\n            }\n        } else {\n            entity_map.insert(key, entity);\n        }\n    }\n\n    Ok((entity_map.into_values().collect(), conflicts))\n}\n\nfn has_conflict(e1: \u0026GenericEntity, e2: \u0026GenericEntity) -\u003e bool {\n    if e1.agent == e2.agent {\n        return false;\n    }\n\n    if e1.data == e2.data {\n        return false;\n    }\n\n    let time_diff = if e1.timestamp \u003e e2.timestamp {\n        e1.timestamp.signed_duration_since(e2.timestamp)\n    } else {\n        e2.timestamp.signed_duration_since(e1.timestamp)\n    };\n\n    let minutes_diff = time_diff.num_minutes().abs();\n\n    minutes_diff \u003c 5\n}\n\nfn analyze_conflict(e1: \u0026GenericEntity, e2: \u0026GenericEntity) -\u003e Vec\u003cString\u003e {\n    let mut conflicts = Vec::new();\n\n    if let (Some(obj1), Some(obj2)) = (e1.data.as_object(), e2.data.as_object()) {\n        for (key, value1) in obj1 {\n            if let Some(value2) = obj2.get(key) {\n                if value1 != value2 {\n                    conflicts.push(format!(\n                        \"Field '{}' differs: {} vs {}\",\n                        key,\n                        serde_json::to_string(value1).unwrap_or_default(),\n                        serde_json::to_string(value2).unwrap_or_default()\n                    ));\n                }\n            }\n        }\n\n        for key in obj2.keys() {\n            if !obj1.contains_key(key) {\n                conflicts.push(format!(\"Field '{}' only present in newer version\", key));\n            }\n        }\n    }\n\n    if conflicts.is_empty() {\n        conflicts.push(\"Data differs but specific fields could not be identified\".to_string());\n    }\n\n    conflicts\n}\n\n/// Remote configuration for sync operations\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RemoteConfig {\n    pub name: String,\n    pub url: String,\n    pub branch: String,\n    pub last_sync: Option\u003cchrono::DateTime\u003cchrono::Utc\u003e\u003e,\n    pub auth_type: Option\u003cString\u003e,\n    pub username: Option\u003cString\u003e,\n    pub ssh_key_path: Option\u003cString\u003e,\n}\n\n/// Remote sync status\n#[derive(Debug, Clone)]\npub struct RemoteSyncStatus {\n    pub remote: String,\n    pub local_hash: String,\n    pub remote_hash: String,\n    pub is_ahead: bool,\n    pub is_behind: bool,\n    pub last_checked: chrono::DateTime\u003cchrono::Utc\u003e,\n}\n\n/// Add a remote repository\npub fn add_remote\u003cS: Storage\u003e(\n    _storage: \u0026mut S,\n    name: String,\n    url: String,\n    branch: String,\n    auth_type: Option\u003cString\u003e,\n    username: Option\u003cString\u003e,\n    ssh_key: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    println!(\"üì° Adding remote repository...\");\n    println!(\"   Name: {}\", name);\n    println!(\"   URL: {}\", url);\n    println!(\"   Branch: {}\", branch);\n    if let Some(ref auth) = auth_type {\n        println!(\"   Authentication: {}\", auth);\n    }\n\n    // Load existing remotes configuration\n    let config_path = \".engram/remotes.json\";\n    let mut remotes: HashMap\u003cString, RemoteConfig\u003e = if Path::new(config_path).exists() {\n        let content = fs::read_to_string(config_path).map_err(|e| EngramError::Io(e))?;\n        serde_json::from_str(\u0026content).map_err(|e| EngramError::Serialization(e))?\n    } else {\n        HashMap::new()\n    };\n\n    // Check if remote already exists\n    if remotes.contains_key(\u0026name) {\n        return Err(EngramError::Validation(format!(\n            \"Remote '{}' already exists\",\n            name\n        )));\n    }\n\n    // Add new remote configuration\n    let remote_config = RemoteConfig {\n        name: name.clone(),\n        url: url.clone(),\n        branch: branch.clone(),\n        last_sync: None,\n        auth_type: auth_type.clone(),\n        username: username.clone(),\n        ssh_key_path: ssh_key.clone(),\n    };\n\n    remotes.insert(name.clone(), remote_config);\n\n    // Save updated configuration\n    let config_content =\n        serde_json::to_string_pretty(\u0026remotes).map_err(|e| EngramError::Serialization(e))?;\n\n    // Ensure .engram directory exists\n    if !Path::new(\".engram\").exists() {\n        fs::create_dir_all(\".engram\").map_err(|e| EngramError::Io(e))?;\n    }\n\n    fs::write(config_path, config_content).map_err(|e| EngramError::Io(e))?;\n\n    println!(\"‚úÖ Remote '{}' added successfully\", name);\n    Ok(())\n}\n\n/// List all configured remotes\npub fn list_remotes() -\u003e Result\u003cVec\u003cRemoteConfig\u003e, EngramError\u003e {\n    let config_path = \".engram/remotes.json\";\n\n    if !Path::new(config_path).exists() {\n        println!(\"üì° No remotes configured\");\n        return Ok(Vec::new());\n    }\n\n    let content = fs::read_to_string(config_path).map_err(|e| EngramError::Io(e))?;\n\n    let remotes: HashMap\u003cString, RemoteConfig\u003e =\n        serde_json::from_str(\u0026content).map_err(|e| EngramError::Serialization(e))?;\n\n    println!(\"üì° Configured Remotes\");\n    println!(\"====================\");\n\n    if remotes.is_empty() {\n        println!(\"No remotes configured.\");\n        return Ok(Vec::new());\n    }\n\n    let mut remote_list: Vec\u003cRemoteConfig\u003e = remotes.into_values().collect();\n    remote_list.sort_by(|a, b| a.name.cmp(\u0026b.name));\n\n    for remote in \u0026remote_list {\n        println!(\"üì° {}\", remote.name);\n        println!(\"   URL: {}\", remote.url);\n        println!(\"   Branch: {}\", remote.branch);\n        if let Some(ref auth_type) = remote.auth_type {\n            println!(\"   Authentication: {}\", auth_type);\n            if let Some(ref username) = remote.username {\n                println!(\"   Username: {}\", username);\n            }\n            if let Some(ref ssh_key) = remote.ssh_key_path {\n                println!(\"   SSH Key: {}\", ssh_key);\n            }\n        }\n        if let Some(last_sync) = remote.last_sync {\n            println!(\n                \"   Last Sync: {}\",\n                last_sync.format(\"%Y-%m-%d %H:%M:%S UTC\")\n            );\n        } else {\n            println!(\"   Last Sync: Never\");\n        }\n        println!();\n    }\n\n    Ok(remote_list)\n}\n\n/// Get sync status with a remote\npub fn get_sync_status(remote_name: \u0026str) -\u003e Result\u003cRemoteSyncStatus, EngramError\u003e {\n    println!(\"üìä Checking sync status for '{}'...\", remote_name);\n\n    // Load remotes configuration\n    let config_path = \".engram/remotes.json\";\n    if !Path::new(config_path).exists() {\n        return Err(EngramError::Validation(\n            \"No remotes configured. Use 'add-remote' first.\".to_string(),\n        ));\n    }\n\n    let content = fs::read_to_string(config_path).map_err(|e| EngramError::Io(e))?;\n\n    let remotes: HashMap\u003cString, RemoteConfig\u003e =\n        serde_json::from_str(\u0026content).map_err(|e| EngramError::Serialization(e))?;\n\n    let remote_config = remotes\n        .get(remote_name)\n        .ok_or_else(|| EngramError::Validation(format!(\"Remote '{}' not found\", remote_name)))?;\n\n    // Open Git repository\n    let repo = Repository::open(\".\")\n        .map_err(|e| EngramError::Git(format!(\"Failed to open repository: {}\", e)))?;\n\n    // Get local HEAD commit hash\n    let local_head = repo\n        .head()\n        .map_err(|e| EngramError::Git(format!(\"Failed to get local HEAD: {}\", e)))?;\n    let local_oid = local_head\n        .target()\n        .ok_or_else(|| EngramError::Git(\"Failed to get local HEAD target\".to_string()))?;\n    let local_hash = local_oid.to_string();\n\n    // For now, we'll simulate remote hash check (in a real implementation, we'd fetch from remote)\n    // This would require network operations and authentication\n    let remote_hash = \"0000000000000000000000000000000000000000\".to_string(); // Placeholder\n    let is_ahead = false; // Placeholder\n    let is_behind = false; // Placeholder\n\n    println!(\"üìä Sync Status for '{}'\", remote_name);\n    println!(\"=========================\");\n    println!(\"Remote: {}\", remote_config.url);\n    println!(\"Local Hash: {}...\", \u0026local_hash[..12]);\n    println!(\"Remote Hash: {}...\", \u0026remote_hash[..12]);\n\n    if is_behind {\n        println!(\"Status: ‚¨áÔ∏è  Behind remote (pull needed)\");\n    } else if is_ahead {\n        println!(\"Status: ‚¨ÜÔ∏è  Ahead of remote (push needed)\");\n    } else {\n        println!(\"Status: ‚úÖ Up to date\");\n    }\n\n    let status = RemoteSyncStatus {\n        remote: remote_name.to_string(),\n        local_hash,\n        remote_hash,\n        is_ahead,\n        is_behind,\n        last_checked: Utc::now(),\n    };\n\n    Ok(status)\n}\n\n/// Pull from remote repository\npub fn pull_from_remote\u003cS: Storage\u003e(\n    _storage: \u0026mut S,\n    remote_name: String,\n    branch: Option\u003cString\u003e,\n    agents: Option\u003cString\u003e,\n    auth: RemoteAuth,\n    dry_run: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    println!(\"üì• Pulling from remote '{}'...\", remote_name);\n\n    if dry_run {\n        println!(\"üîç Dry run mode - no changes will be made\");\n    }\n\n    // Load remotes configuration\n    let config_path = \".engram/remotes.json\";\n    if !Path::new(config_path).exists() {\n        return Err(EngramError::Validation(\n            \"No remotes configured. Use 'add-remote' first.\".to_string(),\n        ));\n    }\n\n    let content = fs::read_to_string(config_path).map_err(|e| EngramError::Io(e))?;\n\n    let remotes: HashMap\u003cString, RemoteConfig\u003e =\n        serde_json::from_str(\u0026content).map_err(|e| EngramError::Serialization(e))?;\n\n    let remote_config = remotes\n        .get(\u0026remote_name)\n        .ok_or_else(|| EngramError::Validation(format!(\"Remote '{}' not found\", remote_name)))?;\n\n    let target_branch = branch.unwrap_or(remote_config.branch.clone());\n\n    println!(\"üì° Remote: {}\", remote_config.url);\n    println!(\"üåø Branch: {}\", target_branch);\n\n    if let Some(agent_list) = \u0026agents {\n        println!(\"ü§ñ Agents: {}\", agent_list);\n    } else {\n        println!(\"ü§ñ Agents: All\");\n    }\n\n    if !dry_run {\n        println!(\"üîÑ Attempting to pull from remote repository...\");\n\n        let repo = Repository::open(\".\")\n            .map_err(|e| EngramError::Git(format!(\"Failed to open repository: {}\", e)))?;\n\n        let remote_exists = repo.find_remote(\u0026remote_name).is_ok();\n        if !remote_exists {\n            repo.remote(\u0026remote_name, \u0026remote_config.url)\n                .map_err(|e| EngramError::Git(format!(\"Failed to add remote: {}\", e)))?;\n        }\n\n        let refspecs = [format!(\n            \"refs/heads/{}:refs/remotes/{}/{}\",\n            target_branch, remote_name, target_branch\n        )];\n        let refspecs_str: Vec\u003c\u0026str\u003e = refspecs.iter().map(|s| s.as_str()).collect();\n\n        authenticated_fetch(\u0026repo, \u0026remote_name, \u0026refspecs_str, \u0026auth)?;\n\n        println!(\"‚úÖ Successfully pulled from remote repository\");\n        println!(\"   Next: Local entities will be updated for specified agents\");\n    } else {\n        println!(\"‚úÖ Dry run completed - would pull from remote\");\n    }\n\n    Ok(())\n}\n\n/// Push to remote repository\npub fn push_to_remote\u003cS: Storage\u003e(\n    _storage: \u0026mut S,\n    remote_name: String,\n    branch: Option\u003cString\u003e,\n    agents: Option\u003cString\u003e,\n    _auth: RemoteAuth,\n    dry_run: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    println!(\"üì§ Pushing to remote '{}'...\", remote_name);\n\n    if dry_run {\n        println!(\"üîç Dry run mode - no changes will be made\");\n    }\n\n    // Load remotes configuration\n    let config_path = \".engram/remotes.json\";\n    if !Path::new(config_path).exists() {\n        return Err(EngramError::Validation(\n            \"No remotes configured. Use 'add-remote' first.\".to_string(),\n        ));\n    }\n\n    let content = fs::read_to_string(config_path).map_err(|e| EngramError::Io(e))?;\n\n    let remotes: HashMap\u003cString, RemoteConfig\u003e =\n        serde_json::from_str(\u0026content).map_err(|e| EngramError::Serialization(e))?;\n\n    let remote_config = remotes\n        .get(\u0026remote_name)\n        .ok_or_else(|| EngramError::Validation(format!(\"Remote '{}' not found\", remote_name)))?;\n\n    let target_branch = branch.unwrap_or(remote_config.branch.clone());\n\n    println!(\"üì° Remote: {}\", remote_config.url);\n    println!(\"üåø Branch: {}\", target_branch);\n\n    if let Some(agent_list) = \u0026agents {\n        println!(\"ü§ñ Agents: {}\", agent_list);\n    } else {\n        println!(\"ü§ñ Agents: All\");\n    }\n\n    if !dry_run {\n        // Open the Git repository\n        let repo_path = std::env::current_dir()?.join(\".engram\");\n        let repo = Repository::open(\u0026repo_path)\n            .map_err(|e| EngramError::Git(format!(\"Failed to open repository: {}\", e)))?;\n\n        // Stage and commit changes for specified agents\n        let mut index = repo\n            .index()\n            .map_err(|e| EngramError::Git(format!(\"Failed to get repository index: {}\", e)))?;\n\n        // Add all changes to staging area\n        index\n            .add_all([\"*\"].iter(), IndexAddOption::DEFAULT, None)\n            .map_err(|e| EngramError::Git(format!(\"Failed to stage changes: {}\", e)))?;\n        index\n            .write()\n            .map_err(|e| EngramError::Git(format!(\"Failed to write index: {}\", e)))?;\n\n        let tree_id = index\n            .write_tree()\n            .map_err(|e| EngramError::Git(format!(\"Failed to write tree: {}\", e)))?;\n        let tree = repo\n            .find_tree(tree_id)\n            .map_err(|e| EngramError::Git(format!(\"Failed to find tree: {}\", e)))?;\n\n        // Create commit message\n        let commit_message = if let Some(agent_list) = \u0026agents {\n            format!(\"Sync changes for agents: {}\", agent_list)\n        } else {\n            \"Sync all agent changes\".to_string()\n        };\n\n        // Get HEAD commit as parent (if exists)\n        let parent_commit = match repo.head() {\n            Ok(head) =\u003e Some(\n                head.peel_to_commit()\n                    .map_err(|e| EngramError::Git(format!(\"Failed to get HEAD commit: {}\", e)))?,\n            ),\n            Err(_) =\u003e None, // First commit\n        };\n\n        let parents: Vec\u003c\u0026git2::Commit\u003e = if let Some(ref parent) = parent_commit {\n            vec![parent]\n        } else {\n            vec![]\n        };\n\n        // Create signature\n        let signature = git2::Signature::now(\"Engram\", \"engram@local\")\n            .map_err(|e| EngramError::Git(format!(\"Failed to create signature: {}\", e)))?;\n\n        // Create the commit\n        repo.commit(\n            Some(\"HEAD\"),\n            \u0026signature,\n            \u0026signature,\n            \u0026commit_message,\n            \u0026tree,\n            \u0026parents,\n        )\n        .map_err(|e| EngramError::Git(format!(\"Failed to create commit: {}\", e)))?;\n\n        println!(\"üì¶ Created commit: {}\", commit_message);\n\n        // Push to remote using authenticated_push\n        let auth = RemoteAuth {\n            auth_type: remote_config\n                .auth_type\n                .clone()\n                .unwrap_or_else(|| \"none\".to_string()),\n            username: remote_config.username.clone(),\n            password: None, // We don't store passwords in remote config for security\n            key_path: remote_config.ssh_key_path.clone(),\n        };\n        let refspec = format!(\"refs/heads/{}:refs/heads/{}\", target_branch, target_branch);\n        authenticated_push(\u0026repo, \u0026remote_name, \u0026[\u0026refspec], \u0026auth)?;\n\n        println!(\"‚úÖ Successfully pushed to remote '{}'\", remote_name);\n    } else {\n        println!(\"‚úÖ Dry run completed - would push to remote\");\n    }\n\n    Ok(())\n}\n\n/// Create Git2 credentials based on authentication configuration\npub fn create_credentials(auth: \u0026RemoteAuth) -\u003e Result\u003cOption\u003cRemoteCallbacks\u003c'_\u003e\u003e, EngramError\u003e {\n    match auth.auth_type.as_str() {\n        \"ssh\" =\u003e {\n            let mut callbacks = RemoteCallbacks::new();\n            callbacks.credentials(|_url, username_from_url, _allowed_types| {\n                let username = auth\n                    .username\n                    .as_deref()\n                    .or(username_from_url)\n                    .unwrap_or(\"git\");\n\n                if let Some(key_path) = \u0026auth.key_path {\n                    Cred::ssh_key(\n                        username,\n                        None,\n                        Path::new(key_path),\n                        auth.password.as_deref(),\n                    )\n                } else {\n                    Cred::ssh_key_from_agent(username)\n                }\n            });\n            Ok(Some(callbacks))\n        }\n        \"http\" | \"https\" =\u003e {\n            let mut callbacks = RemoteCallbacks::new();\n            let username = auth.username.clone();\n            let password = auth.password.clone();\n\n            callbacks.credentials(move |_url, _username_from_url, _allowed_types| {\n                if let (Some(ref user), Some(ref pass)) = (\u0026username, \u0026password) {\n                    Cred::userpass_plaintext(user, pass)\n                } else {\n                    Cred::default()\n                }\n            });\n            Ok(Some(callbacks))\n        }\n        \"none\" =\u003e Ok(None),\n        _ =\u003e Err(EngramError::Validation(format!(\n            \"Invalid authentication type: '{}'. Valid options: ssh, http, https, none\",\n            auth.auth_type\n        ))),\n    }\n}\n\n/// Perform authenticated Git fetch operation\nfn authenticated_fetch(\n    repo: \u0026Repository,\n    remote_name: \u0026str,\n    refspecs: \u0026[\u0026str],\n    auth: \u0026RemoteAuth,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut remote = repo\n        .find_remote(remote_name)\n        .map_err(|e| EngramError::Git(format!(\"Failed to find remote '{}': {}\", remote_name, e)))?;\n\n    if let Some(callbacks) = create_credentials(auth)? {\n        let mut fetch_options = FetchOptions::new();\n        fetch_options.remote_callbacks(callbacks);\n        remote\n            .fetch(refspecs, Some(\u0026mut fetch_options), None)\n            .map_err(|e| EngramError::Git(format!(\"Failed to fetch from remote: {}\", e)))?;\n    } else {\n        remote\n            .fetch(refspecs, None, None)\n            .map_err(|e| EngramError::Git(format!(\"Failed to fetch from remote: {}\", e)))?;\n    }\n\n    Ok(())\n}\n\n/// Perform authenticated Git push operation\nfn authenticated_push(\n    repo: \u0026Repository,\n    remote_name: \u0026str,\n    refspecs: \u0026[\u0026str],\n    auth: \u0026RemoteAuth,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut remote = repo\n        .find_remote(remote_name)\n        .map_err(|e| EngramError::Git(format!(\"Failed to find remote '{}': {}\", remote_name, e)))?;\n\n    if let Some(callbacks) = create_credentials(auth)? {\n        let mut push_options = PushOptions::new();\n        push_options.remote_callbacks(callbacks);\n\n        remote\n            .push(refspecs, Some(\u0026mut push_options))\n            .map_err(|e| EngramError::Git(format!(\"Failed to push to remote: {}\", e)))?;\n    } else {\n        remote\n            .push(refspecs, None)\n            .map_err(|e| EngramError::Git(format!(\"Failed to push to remote: {}\", e)))?;\n    }\n\n    Ok(())\n}\n\n/// Handle sync commands\npub fn handle_sync_command\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    command: \u0026SyncCommands,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        SyncCommands::Sync {\n            agents,\n            strategy,\n            dry_run,\n        } =\u003e {\n            let agent_list: Vec\u003cString\u003e = agents\n                .split(',')\n                .map(|s| s.trim().to_string())\n                .filter(|s| !s.is_empty())\n                .collect();\n\n            if agent_list.is_empty() {\n                return Err(EngramError::Validation(\n                    \"No valid agents provided\".to_string(),\n                ));\n            }\n\n            let merge_strategy = MergeStrategy::from_str(strategy)?;\n            let _result = sync_agents(storage, agent_list, merge_strategy, *dry_run)?;\n\n            println!(\"\\nüéâ Synchronization completed successfully!\");\n            Ok(())\n        }\n        SyncCommands::AddRemote {\n            name,\n            url,\n            branch,\n            auth_type,\n            username,\n            password: _,\n            ssh_key,\n        } =\u003e add_remote(\n            storage,\n            name.clone(),\n            url.clone(),\n            branch.clone(),\n            auth_type.clone(),\n            username.clone(),\n            ssh_key.clone(),\n        ),\n        SyncCommands::ListRemotes =\u003e {\n            list_remotes()?;\n            Ok(())\n        }\n        SyncCommands::Status { remote } =\u003e {\n            if let Some(remote_name) = remote {\n                get_sync_status(remote_name)?;\n            } else {\n                return Err(EngramError::Validation(\n                    \"Remote name required for status check\".to_string(),\n                ));\n            }\n            Ok(())\n        }\n        SyncCommands::Pull {\n            remote,\n            branch,\n            agents,\n            auth_type,\n            username,\n            password,\n            ssh_key,\n            dry_run,\n        } =\u003e {\n            let auth = RemoteAuth {\n                auth_type: auth_type.clone().unwrap_or_else(|| \"none\".to_string()),\n                username: username.clone(),\n                password: password.clone(),\n                key_path: ssh_key.clone(),\n            };\n            pull_from_remote(\n                storage,\n                remote.clone(),\n                branch.clone(),\n                agents.clone(),\n                auth,\n                *dry_run,\n            )\n        }\n        SyncCommands::Push {\n            remote,\n            branch,\n            agents,\n            auth_type,\n            username,\n            password,\n            ssh_key,\n            dry_run,\n        } =\u003e {\n            let auth = RemoteAuth {\n                auth_type: auth_type.clone().unwrap_or_else(|| \"none\".to_string()),\n                username: username.clone(),\n                password: password.clone(),\n                key_path: ssh_key.clone(),\n            };\n            push_to_remote(\n                storage,\n                remote.clone(),\n                branch.clone(),\n                agents.clone(),\n                auth,\n                *dry_run,\n            )\n        }\n        SyncCommands::CreateBranch { name, agent, from } =\u003e {\n            create_branch(name, agent.as_deref(), from.as_deref())\n        }\n        SyncCommands::SwitchBranch { name, create } =\u003e switch_branch(name, *create),\n        SyncCommands::ListBranches { all, current } =\u003e list_branches(*all, *current),\n        SyncCommands::DeleteBranch { name, force } =\u003e delete_branch(name, *force),\n    }\n}\n\n/// Create a new branch for agent isolation\npub fn create_branch(\n    branch_name: \u0026str,\n    agent: Option\u003c\u0026str\u003e,\n    from_branch: Option\u003c\u0026str\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let repo_path = std::env::current_dir()?.join(\".engram\");\n    let repo = Repository::open(\u0026repo_path)\n        .map_err(|e| EngramError::Git(format!(\"Failed to open repository: {}\", e)))?;\n\n    let from = from_branch.unwrap_or(\"main\");\n\n    println!(\"üåø Creating branch '{}'\", branch_name);\n    if let Some(agent_name) = agent {\n        println!(\"üë§ Agent: {}\", agent_name);\n    }\n    println!(\"üìç From: {}\", from);\n\n    let target_commit = if let Ok(target_ref) = repo.find_reference(\u0026format!(\"refs/heads/{}\", from))\n    {\n        target_ref.peel_to_commit().map_err(|e| {\n            EngramError::Git(format!(\n                \"Failed to find commit for branch '{}': {}\",\n                from, e\n            ))\n        })?\n    } else {\n        return Err(EngramError::Git(format!(\n            \"Source branch '{}' not found\",\n            from\n        )));\n    };\n\n    let _branch_ref = repo\n        .reference(\n            \u0026format!(\"refs/heads/{}\", branch_name),\n            target_commit.id(),\n            false,\n            \u0026format!(\"Create branch {}\", branch_name),\n        )\n        .map_err(|e| {\n            if e.code() == git2::ErrorCode::Exists {\n                EngramError::Git(format!(\"Branch '{}' already exists\", branch_name))\n            } else {\n                EngramError::Git(format!(\"Failed to create branch '{}': {}\", branch_name, e))\n            }\n        })?;\n\n    println!(\"‚úÖ Branch '{}' created successfully\", branch_name);\n\n    if let Some(agent_name) = agent {\n        println!(\n            \"üìù Branch '{}' is now associated with agent '{}'\",\n            branch_name, agent_name\n        );\n    }\n\n    Ok(())\n}\n\n/// Switch to a different branch\npub fn switch_branch(branch_name: \u0026str, create_if_missing: bool) -\u003e Result\u003c(), EngramError\u003e {\n    let repo_path = std::env::current_dir()?.join(\".engram\");\n    let repo = Repository::open(\u0026repo_path)\n        .map_err(|e| EngramError::Git(format!(\"Failed to open repository: {}\", e)))?;\n\n    let branch_exists = repo\n        .find_reference(\u0026format!(\"refs/heads/{}\", branch_name))\n        .is_ok();\n\n    if !branch_exists {\n        if create_if_missing {\n            create_branch(branch_name, None, None)?;\n            // Reopen repository to ensure new branch is visible\n            let repo = Repository::open(\u0026repo_path)\n                .map_err(|e| EngramError::Git(format!(\"Failed to reopen repository: {}\", e)))?;\n            let branch_ref = repo\n                .find_reference(\u0026format!(\"refs/heads/{}\", branch_name))\n                .map_err(|e| {\n                    EngramError::Git(format!(\"Failed to find branch '{}': {}\", branch_name, e))\n                })?;\n            let commit = branch_ref.peel_to_commit().map_err(|e| {\n                EngramError::Git(format!(\n                    \"Failed to get commit for branch '{}': {}\",\n                    branch_name, e\n                ))\n            })?;\n            repo.set_head(\u0026format!(\"refs/heads/{}\", branch_name))\n                .map_err(|e| {\n                    EngramError::Git(format!(\n                        \"Failed to switch to branch '{}': {}\",\n                        branch_name, e\n                    ))\n                })?;\n            repo.checkout_tree(\n                commit.tree().unwrap().as_object(),\n                Some(git2::build::CheckoutBuilder::new().force()),\n            )\n            .map_err(|e| {\n                EngramError::Git(format!(\n                    \"Failed to checkout branch '{}': {}\",\n                    branch_name, e\n                ))\n            })?;\n            println!(\"üåø Switched to branch '{}'\", branch_name);\n            return Ok(());\n        } else {\n            return Err(EngramError::Git(format!(\n                \"Branch '{}' does not exist. Use --create to create it.\",\n                branch_name\n            )));\n        }\n    }\n\n    let branch_ref = repo\n        .find_reference(\u0026format!(\"refs/heads/{}\", branch_name))\n        .map_err(|e| EngramError::Git(format!(\"Failed to find branch '{}': {}\", branch_name, e)))?;\n\n    let commit = branch_ref.peel_to_commit().map_err(|e| {\n        EngramError::Git(format!(\n            \"Failed to get commit for branch '{}': {}\",\n            branch_name, e\n        ))\n    })?;\n\n    repo.set_head(\u0026format!(\"refs/heads/{}\", branch_name))\n        .map_err(|e| {\n            EngramError::Git(format!(\n                \"Failed to switch to branch '{}': {}\",\n                branch_name, e\n            ))\n        })?;\n\n    repo.checkout_tree(\n        commit.tree().unwrap().as_object(),\n        Some(git2::build::CheckoutBuilder::new().force()),\n    )\n    .map_err(|e| {\n        EngramError::Git(format!(\n            \"Failed to checkout branch '{}': {}\",\n            branch_name, e\n        ))\n    })?;\n\n    println!(\"üåø Switched to branch '{}'\", branch_name);\n    Ok(())\n}\n\n/// List all branches\npub fn list_branches(_all: bool, current_only: bool) -\u003e Result\u003c(), EngramError\u003e {\n    let repo_path = std::env::current_dir()?.join(\".engram\");\n    let repo = Repository::open(\u0026repo_path)\n        .map_err(|e| EngramError::Git(format!(\"Failed to open repository: {}\", e)))?;\n\n    let head = repo.head().ok();\n    let current_branch = if let Some(head_ref) = \u0026head {\n        head_ref.shorthand()\n    } else {\n        None\n    };\n\n    println!(\"üåø Git Branches\");\n    println!(\"===============\");\n\n    let branches = repo\n        .branches(Some(git2::BranchType::Local))\n        .map_err(|e| EngramError::Git(format!(\"Failed to list branches: {}\", e)))?;\n\n    for branch_result in branches {\n        let (branch, _branch_type) =\n            branch_result.map_err(|e| EngramError::Git(format!(\"Failed to read branch: {}\", e)))?;\n\n        let branch_name = branch\n            .name()\n            .map_err(|e| EngramError::Git(format!(\"Failed to get branch name: {}\", e)))?\n            .unwrap_or(\"\u003cunnamed\u003e\");\n\n        let is_current = current_branch == Some(branch_name);\n\n        if current_only {\n            if is_current {\n                println!(\"* {}\", branch_name);\n                return Ok(());\n            }\n            continue;\n        }\n\n        let prefix = if is_current { \"* \" } else { \"  \" };\n        println!(\"{}{}\", prefix, branch_name);\n    }\n\n    if current_only \u0026\u0026 current_branch.is_none() {\n        println!(\"No current branch (detached HEAD)\");\n    }\n\n    Ok(())\n}\n\n/// Delete a branch\npub fn delete_branch(branch_name: \u0026str, force: bool) -\u003e Result\u003c(), EngramError\u003e {\n    let repo_path = std::env::current_dir()?.join(\".engram\");\n    let repo = Repository::open(\u0026repo_path)\n        .map_err(|e| EngramError::Git(format!(\"Failed to open repository: {}\", e)))?;\n\n    let head = repo.head().ok();\n    let current_branch = if let Some(head_ref) = \u0026head {\n        head_ref.shorthand()\n    } else {\n        None\n    };\n\n    if current_branch == Some(branch_name) {\n        return Err(EngramError::Git(format!(\n            \"Cannot delete the currently checked out branch '{}'\",\n            branch_name\n        )));\n    }\n\n    let mut branch = repo\n        .find_branch(branch_name, git2::BranchType::Local)\n        .map_err(|e| EngramError::Git(format!(\"Branch '{}' not found: {}\", branch_name, e)))?;\n\n    if !force {\n        println!(\n            \"‚ö†Ô∏è  Are you sure you want to delete branch '{}'? Use --force to confirm.\",\n            branch_name\n        );\n        return Ok(());\n    }\n\n    branch.delete().map_err(|e| {\n        EngramError::Git(format!(\"Failed to delete branch '{}': {}\", branch_name, e))\n    })?;\n\n    println!(\"‚úÖ Branch '{}' deleted successfully\", branch_name);\n    Ok(())\n}\n","traces":[{"line":122,"address":[16427632,16429042,16429048],"length":1,"stats":{"Line":0}},{"line":123,"address":[19606039,19605931],"length":1,"stats":{"Line":0}},{"line":124,"address":[19454801],"length":1,"stats":{"Line":0}},{"line":125,"address":[26796222],"length":1,"stats":{"Line":0}},{"line":126,"address":[16428242,16428091],"length":1,"stats":{"Line":0}},{"line":127,"address":[16428172],"length":1,"stats":{"Line":0}},{"line":129,"address":[26335869],"length":1,"stats":{"Line":0}},{"line":130,"address":[16428340,16428598],"length":1,"stats":{"Line":0}},{"line":131,"address":[16428663,16428722],"length":1,"stats":{"Line":0}},{"line":132,"address":[19607189],"length":1,"stats":{"Line":0}},{"line":133,"address":[20569665],"length":1,"stats":{"Line":0}},{"line":136,"address":[20569521],"length":1,"stats":{"Line":0}},{"line":138,"address":[19677426,19677353],"length":1,"stats":{"Line":0}},{"line":146,"address":[15228896,15230167,15234527],"length":1,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[15229392],"length":1,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[15229497,15229570],"length":1,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[15229636,15229697],"length":1,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[15229917],"length":1,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[15229776],"length":1,"stats":{"Line":0}},{"line":171,"address":[15229795],"length":1,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[15229874],"length":1,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[15229739,15230181],"length":1,"stats":{"Line":0}},{"line":191,"address":[15230499],"length":1,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[15230523],"length":1,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[15233549],"length":1,"stats":{"Line":0}},{"line":204,"address":[15233581],"length":1,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[15233897,15233183],"length":1,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[15234193],"length":1,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[15231113],"length":1,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[15231505],"length":1,"stats":{"Line":0}},{"line":227,"address":[15231609],"length":1,"stats":{"Line":0}},{"line":228,"address":[15231713],"length":1,"stats":{"Line":0}},{"line":229,"address":[15231842],"length":1,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[15232220,15232016],"length":1,"stats":{"Line":0}},{"line":233,"address":[15232332],"length":1,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[15232659],"length":1,"stats":{"Line":0}},{"line":239,"address":[15232051],"length":1,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[15232104],"length":1,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[15232144],"length":1,"stats":{"Line":0}},{"line":244,"address":[15232175],"length":1,"stats":{"Line":0}},{"line":245,"address":[15232188],"length":1,"stats":{"Line":0}},{"line":249,"address":[15251920,15254919,15250432],"length":1,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[15254228,15250937],"length":1,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[15254779],"length":1,"stats":{"Line":0}},{"line":271,"address":[15250973],"length":1,"stats":{"Line":0}},{"line":272,"address":[15254096,15251018],"length":1,"stats":{"Line":0}},{"line":275,"address":[15251053,15250994],"length":1,"stats":{"Line":0}},{"line":277,"address":[15251061,15251829],"length":1,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[15251414,15251120],"length":1,"stats":{"Line":0}},{"line":280,"address":[15251622],"length":1,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[15251989,15251190],"length":1,"stats":{"Line":0}},{"line":284,"address":[15252197],"length":1,"stats":{"Line":0}},{"line":286,"address":[15251260,15252474],"length":1,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[15251346,15254066,15252658],"length":1,"stats":{"Line":0}},{"line":289,"address":[15252960],"length":1,"stats":{"Line":0}},{"line":293,"address":[15251893,15253226],"length":1,"stats":{"Line":0}},{"line":294,"address":[15253276,15253234],"length":1,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[15253303],"length":1,"stats":{"Line":0}},{"line":304,"address":[15253427,15253481],"length":1,"stats":{"Line":0}},{"line":305,"address":[15253589],"length":1,"stats":{"Line":0}},{"line":309,"address":[15253843,15253444],"length":1,"stats":{"Line":0}},{"line":312,"address":[20593183,20593230,20591632],"length":1,"stats":{"Line":0}},{"line":315,"address":[21139958],"length":1,"stats":{"Line":0}},{"line":317,"address":[26819361,26819484,26819260,26820641],"length":1,"stats":{"Line":0}},{"line":318,"address":[26819921,26819661],"length":1,"stats":{"Line":0}},{"line":320,"address":[21140801,21140729],"length":1,"stats":{"Line":0}},{"line":321,"address":[20592552,20592805],"length":1,"stats":{"Line":0}},{"line":322,"address":[20592830],"length":1,"stats":{"Line":0}},{"line":325,"address":[20592582,20593068],"length":1,"stats":{"Line":0}},{"line":329,"address":[21140510],"length":1,"stats":{"Line":0}},{"line":332,"address":[16447984,16450263,16450034],"length":1,"stats":{"Line":0}},{"line":335,"address":[20589254],"length":1,"stats":{"Line":0}},{"line":337,"address":[19628999,19626852,19627076,19626953],"length":1,"stats":{"Line":0}},{"line":338,"address":[19686501,19686761],"length":1,"stats":{"Line":0}},{"line":340,"address":[19627593,19627521],"length":1,"stats":{"Line":0}},{"line":341,"address":[26356996,26357249,26358150],"length":1,"stats":{"Line":0}},{"line":342,"address":[19687190],"length":1,"stats":{"Line":0}},{"line":343,"address":[26818542,26818795],"length":1,"stats":{"Line":0}},{"line":346,"address":[21138498,21139746],"length":1,"stats":{"Line":0}},{"line":350,"address":[19627302],"length":1,"stats":{"Line":0}},{"line":353,"address":[19483104,19485003,19485050],"length":1,"stats":{"Line":0}},{"line":359,"address":[26363728],"length":1,"stats":{"Line":0}},{"line":361,"address":[19705254,19706973,19705493,19705358],"length":1,"stats":{"Line":0}},{"line":362,"address":[26364246,26364506],"length":1,"stats":{"Line":0}},{"line":364,"address":[26825258,26825186],"length":1,"stats":{"Line":0}},{"line":365,"address":[26364646,26364896],"length":1,"stats":{"Line":0}},{"line":366,"address":[26826130,26825602],"length":1,"stats":{"Line":0}},{"line":367,"address":[20598075,20598321,20598351],"length":1,"stats":{"Line":0}},{"line":368,"address":[16456840],"length":1,"stats":{"Line":0}},{"line":371,"address":[21146145,21146952],"length":1,"stats":{"Line":0}},{"line":375,"address":[16455939],"length":1,"stats":{"Line":0}},{"line":378,"address":[20598848,20600149,20600554],"length":1,"stats":{"Line":0}},{"line":382,"address":[19695634],"length":1,"stats":{"Line":0}},{"line":384,"address":[19485398,19485663,19485367],"length":1,"stats":{"Line":0}},{"line":387,"address":[26366303],"length":1,"stats":{"Line":0}},{"line":388,"address":[19637128],"length":1,"stats":{"Line":0}},{"line":389,"address":[16458171,16458125],"length":1,"stats":{"Line":0}},{"line":390,"address":[19637312,19637343,19637266],"length":1,"stats":{"Line":0}},{"line":391,"address":[19486075,19486193],"length":1,"stats":{"Line":0}},{"line":392,"address":[19637455],"length":1,"stats":{"Line":0}},{"line":394,"address":[19486038,19486400],"length":1,"stats":{"Line":0}},{"line":397,"address":[26827245,26827828],"length":1,"stats":{"Line":0}},{"line":402,"address":[26366018],"length":1,"stats":{"Line":0}},{"line":405,"address":[19708832,19712024,19712230],"length":1,"stats":{"Line":0}},{"line":410,"address":[26828102],"length":1,"stats":{"Line":0}},{"line":411,"address":[19697447],"length":1,"stats":{"Line":0}},{"line":413,"address":[20603887,20600778,20600874,20601009],"length":1,"stats":{"Line":0}},{"line":414,"address":[20601186,20601562],"length":1,"stats":{"Line":0}},{"line":416,"address":[16459931,16459986],"length":1,"stats":{"Line":0}},{"line":417,"address":[26368779,26370573,26368542],"length":1,"stats":{"Line":0}},{"line":418,"address":[19488233,19488530],"length":1,"stats":{"Line":0}},{"line":423,"address":[21150684],"length":1,"stats":{"Line":0}},{"line":425,"address":[19488635],"length":1,"stats":{"Line":0}},{"line":426,"address":[19710719],"length":1,"stats":{"Line":0}},{"line":428,"address":[19640042,19640117],"length":1,"stats":{"Line":0}},{"line":436,"address":[21151289,21151212],"length":1,"stats":{"Line":0}},{"line":437,"address":[19489623,19489287],"length":1,"stats":{"Line":0}},{"line":441,"address":[19711743],"length":1,"stats":{"Line":0}},{"line":443,"address":[16461312,16461434],"length":1,"stats":{"Line":0}},{"line":449,"address":[19711472],"length":1,"stats":{"Line":0}},{"line":451,"address":[16460298,16460363],"length":1,"stats":{"Line":0}},{"line":452,"address":[26368884],"length":1,"stats":{"Line":0}},{"line":456,"address":[26370650,26368556],"length":1,"stats":{"Line":0}},{"line":460,"address":[19638723],"length":1,"stats":{"Line":0}},{"line":463,"address":[16424640],"length":1,"stats":{"Line":0}},{"line":464,"address":[21113672],"length":1,"stats":{"Line":0}},{"line":465,"address":[20565414],"length":1,"stats":{"Line":0}},{"line":468,"address":[19662131],"length":1,"stats":{"Line":0}},{"line":469,"address":[19451694],"length":1,"stats":{"Line":0}},{"line":472,"address":[21113738],"length":1,"stats":{"Line":0}},{"line":473,"address":[20565543],"length":1,"stats":{"Line":0}},{"line":475,"address":[26332306],"length":1,"stats":{"Line":0}},{"line":478,"address":[21113904],"length":1,"stats":{"Line":0}},{"line":480,"address":[19662359],"length":1,"stats":{"Line":0}},{"line":483,"address":[16447971,16446400,16447851],"length":1,"stats":{"Line":0}},{"line":484,"address":[19473899],"length":1,"stats":{"Line":0}},{"line":486,"address":[21135982,21136048,21136179],"length":1,"stats":{"Line":0}},{"line":487,"address":[19696181],"length":1,"stats":{"Line":0}},{"line":488,"address":[21136381,21136772],"length":1,"stats":{"Line":0}},{"line":489,"address":[16447319],"length":1,"stats":{"Line":0}},{"line":490,"address":[19474892,19474971],"length":1,"stats":{"Line":0}},{"line":493,"address":[19696827],"length":1,"stats":{"Line":0}},{"line":494,"address":[19685361,19685432],"length":1,"stats":{"Line":0}},{"line":500,"address":[16446901],"length":1,"stats":{"Line":0}},{"line":501,"address":[20588266],"length":1,"stats":{"Line":0}},{"line":502,"address":[16447083],"length":1,"stats":{"Line":0}},{"line":507,"address":[19684588,19685841],"length":1,"stats":{"Line":0}},{"line":508,"address":[26355990],"length":1,"stats":{"Line":0}},{"line":511,"address":[19685857],"length":1,"stats":{"Line":0}},{"line":538,"address":[15228716,15224704,15228306],"length":1,"stats":{"Line":0}},{"line":547,"address":[15224787,15224873],"length":1,"stats":{"Line":0}},{"line":548,"address":[15224897],"length":1,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[15225333,15225253],"length":1,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[15228864,15228872,15225526,15228631,15225450],"length":1,"stats":{"Line":0}},{"line":559,"address":[15228768,15225816,15228776,15225745],"length":1,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[15228358,15226202],"length":1,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[15226178],"length":1,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[15226812,15226872],"length":1,"stats":{"Line":0}},{"line":586,"address":[15228832,15228312,15228840,15226990],"length":1,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[15227232,15227316],"length":1,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[15227361,15228744,15228736,15228242,15227635],"length":1,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[19451888,19454448,19454643],"length":1,"stats":{"Line":0}},{"line":602,"address":[20565665],"length":1,"stats":{"Line":0}},{"line":604,"address":[19673956],"length":1,"stats":{"Line":0}},{"line":605,"address":[20565733],"length":1,"stats":{"Line":0}},{"line":606,"address":[21114066],"length":1,"stats":{"Line":0}},{"line":609,"address":[19662675,19662562],"length":1,"stats":{"Line":0}},{"line":611,"address":[19454641,19452305,19452376],"length":1,"stats":{"Line":0}},{"line":614,"address":[19603914,19603981],"length":1,"stats":{"Line":0}},{"line":615,"address":[26333344],"length":1,"stats":{"Line":0}},{"line":617,"address":[19663293],"length":1,"stats":{"Line":0}},{"line":618,"address":[26795763,26794177],"length":1,"stats":{"Line":0}},{"line":619,"address":[20568278],"length":1,"stats":{"Line":0}},{"line":622,"address":[16425861,16425985],"length":1,"stats":{"Line":0}},{"line":623,"address":[26333644,26333561],"length":1,"stats":{"Line":0}},{"line":625,"address":[19604311],"length":1,"stats":{"Line":0}},{"line":626,"address":[19675372,19675222],"length":1,"stats":{"Line":0}},{"line":627,"address":[19663925],"length":1,"stats":{"Line":0}},{"line":628,"address":[19453533],"length":1,"stats":{"Line":0}},{"line":629,"address":[19675653],"length":1,"stats":{"Line":0}},{"line":630,"address":[20567454,20567520],"length":1,"stats":{"Line":0}},{"line":631,"address":[20567593],"length":1,"stats":{"Line":0}},{"line":632,"address":[16426893,16426962],"length":1,"stats":{"Line":0}},{"line":634,"address":[19453921,19454034],"length":1,"stats":{"Line":0}},{"line":635,"address":[26795318],"length":1,"stats":{"Line":0}},{"line":638,"address":[21116223,21115789],"length":1,"stats":{"Line":0}},{"line":639,"address":[16427262],"length":1,"stats":{"Line":0}},{"line":644,"address":[19605702,19605474],"length":1,"stats":{"Line":0}},{"line":646,"address":[19454475,19454422],"length":1,"stats":{"Line":0}},{"line":649,"address":[19604486],"length":1,"stats":{"Line":0}},{"line":653,"address":[19624912,19621648,19625087],"length":1,"stats":{"Line":0}},{"line":654,"address":[19470427],"length":1,"stats":{"Line":0}},{"line":657,"address":[16443184],"length":1,"stats":{"Line":0}},{"line":658,"address":[26811835],"length":1,"stats":{"Line":0}},{"line":659,"address":[21132703],"length":1,"stats":{"Line":0}},{"line":660,"address":[21132672],"length":1,"stats":{"Line":0}},{"line":664,"address":[25189480,25189472],"length":1,"stats":{"Line":0}},{"line":666,"address":[17999424,17999432],"length":1,"stats":{"Line":0}},{"line":669,"address":[26815080,26812704,26812597,26812812],"length":1,"stats":{"Line":0}},{"line":670,"address":[21133407],"length":1,"stats":{"Line":0}},{"line":671,"address":[19488233,19488208],"length":1,"stats":{"Line":0}},{"line":674,"address":[19693672,19695830,19693780,19693614],"length":1,"stats":{"Line":0}},{"line":675,"address":[16444304,16444241],"length":1,"stats":{"Line":0}},{"line":678,"address":[19693931,19694039,19695809],"length":1,"stats":{"Line":0}},{"line":680,"address":[19623223,19623136],"length":1,"stats":{"Line":0}},{"line":681,"address":[26813438,26813546],"length":1,"stats":{"Line":0}},{"line":683,"address":[17999502,17999488],"length":1,"stats":{"Line":0}},{"line":684,"address":[19682867],"length":1,"stats":{"Line":0}},{"line":688,"address":[26352998,26353070],"length":1,"stats":{"Line":0}},{"line":689,"address":[19472486],"length":1,"stats":{"Line":0}},{"line":690,"address":[26813758],"length":1,"stats":{"Line":0}},{"line":692,"address":[19623755,19623820],"length":1,"stats":{"Line":0}},{"line":693,"address":[21134705],"length":1,"stats":{"Line":0}},{"line":694,"address":[19683187],"length":1,"stats":{"Line":0}},{"line":695,"address":[26814055],"length":1,"stats":{"Line":0}},{"line":696,"address":[19683458],"length":1,"stats":{"Line":0}},{"line":698,"address":[20586891],"length":1,"stats":{"Line":0}},{"line":700,"address":[21135197],"length":1,"stats":{"Line":0}},{"line":703,"address":[26814399],"length":1,"stats":{"Line":0}},{"line":707,"address":[21135246],"length":1,"stats":{"Line":0}},{"line":712,"address":[26353883],"length":1,"stats":{"Line":0}},{"line":715,"address":[26354093],"length":1,"stats":{"Line":0}},{"line":719,"address":[15249560,15249138,15245200],"length":1,"stats":{"Line":0}},{"line":727,"address":[15245297,15245392],"length":1,"stats":{"Line":0}},{"line":729,"address":[15245468],"length":1,"stats":{"Line":0}},{"line":730,"address":[],"length":0,"stats":{"Line":0}},{"line":734,"address":[],"length":0,"stats":{"Line":0}},{"line":735,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":737,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[15245654,15245809,15249431,15249856,15249864],"length":1,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":0}},{"line":746,"address":[15249402,15246498,15246609],"length":1,"stats":{"Line":0}},{"line":747,"address":[],"length":0,"stats":{"Line":0}},{"line":748,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[15246907,15246832],"length":1,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[15247197,15247144],"length":1,"stats":{"Line":0}},{"line":758,"address":[15247281,15247171],"length":1,"stats":{"Line":0}},{"line":761,"address":[15247275],"length":1,"stats":{"Line":0}},{"line":762,"address":[15247302,15247357],"length":1,"stats":{"Line":0}},{"line":764,"address":[15247430,15247541,15247376,15249144],"length":1,"stats":{"Line":0}},{"line":765,"address":[15247493,15250160,15247423,15250182],"length":1,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":768,"address":[15247809],"length":1,"stats":{"Line":0}},{"line":769,"address":[15248035,15247944,15248218,15247823,15248146],"length":1,"stats":{"Line":0}},{"line":770,"address":[15249606,15248028,15249584,15248098,15248196],"length":1,"stats":{"Line":0}},{"line":773,"address":[],"length":0,"stats":{"Line":0}},{"line":774,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[15248905],"length":1,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":784,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[15249056],"length":1,"stats":{"Line":0}},{"line":791,"address":[15234560,15239393,15242431],"length":1,"stats":{"Line":0}},{"line":799,"address":[15234672,15234767],"length":1,"stats":{"Line":0}},{"line":801,"address":[15234843],"length":1,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[15234971,15234876],"length":1,"stats":{"Line":0}},{"line":808,"address":[15235068],"length":1,"stats":{"Line":0}},{"line":809,"address":[],"length":0,"stats":{"Line":0}},{"line":813,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[15235486,15242300,15242456,15235403,15242448],"length":1,"stats":{"Line":0}},{"line":816,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[15235873,15242273,15235984],"length":1,"stats":{"Line":0}},{"line":819,"address":[],"length":0,"stats":{"Line":0}},{"line":820,"address":[15235866,15243369,15235936,15243344],"length":1,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":824,"address":[15236207,15236282],"length":1,"stats":{"Line":0}},{"line":825,"address":[],"length":0,"stats":{"Line":0}},{"line":827,"address":[15236463],"length":1,"stats":{"Line":0}},{"line":828,"address":[],"length":0,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[15242015,15236677,15236725],"length":1,"stats":{"Line":0}},{"line":836,"address":[],"length":0,"stats":{"Line":0}},{"line":837,"address":[],"length":0,"stats":{"Line":0}},{"line":840,"address":[],"length":0,"stats":{"Line":0}},{"line":842,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[15241952,15237818,15237707],"length":1,"stats":{"Line":0}},{"line":846,"address":[],"length":0,"stats":{"Line":0}},{"line":847,"address":[15242822,15237770,15242800,15237700],"length":1,"stats":{"Line":0}},{"line":848,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":0}},{"line":854,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[15238345,15238456,15241946,15238257],"length":1,"stats":{"Line":0}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":857,"address":[15244080,15238338,15244102,15238408],"length":1,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":861,"address":[15238573,15238678],"length":1,"stats":{"Line":0}},{"line":863,"address":[],"length":0,"stats":{"Line":0}},{"line":867,"address":[15238853,15238780],"length":1,"stats":{"Line":0}},{"line":869,"address":[],"length":0,"stats":{"Line":0}},{"line":870,"address":[],"length":0,"stats":{"Line":0}},{"line":872,"address":[15238884],"length":1,"stats":{"Line":0}},{"line":875,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[15239577,15239529],"length":1,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":882,"address":[15239809,15241884,15239696,15239920],"length":1,"stats":{"Line":0}},{"line":883,"address":[15239872,15239802,15242550,15242528],"length":1,"stats":{"Line":0}},{"line":886,"address":[],"length":0,"stats":{"Line":0}},{"line":887,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":889,"address":[],"length":0,"stats":{"Line":0}},{"line":890,"address":[],"length":0,"stats":{"Line":0}},{"line":891,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[15240095],"length":1,"stats":{"Line":0}},{"line":894,"address":[],"length":0,"stats":{"Line":0}},{"line":896,"address":[],"length":0,"stats":{"Line":0}},{"line":900,"address":[15240529],"length":1,"stats":{"Line":0}},{"line":904,"address":[],"length":0,"stats":{"Line":0}},{"line":906,"address":[15240683],"length":1,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":0}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":913,"address":[],"length":0,"stats":{"Line":0}},{"line":916,"address":[],"length":0,"stats":{"Line":0}},{"line":920,"address":[20595437,20594528,20595431],"length":1,"stats":{"Line":1}},{"line":921,"address":[19480806],"length":1,"stats":{"Line":1}},{"line":922,"address":[19480835],"length":1,"stats":{"Line":1}},{"line":923,"address":[20594649],"length":1,"stats":{"Line":1}},{"line":924,"address":[18059920],"length":1,"stats":{"Line":1}},{"line":925,"address":[20445462],"length":1,"stats":{"Line":0}},{"line":927,"address":[25190765],"length":1,"stats":{"Line":0}},{"line":928,"address":[18071539],"length":1,"stats":{"Line":0}},{"line":929,"address":[19418335],"length":1,"stats":{"Line":0}},{"line":931,"address":[18060080],"length":1,"stats":{"Line":0}},{"line":932,"address":[20445680],"length":1,"stats":{"Line":0}},{"line":935,"address":[18060141],"length":1,"stats":{"Line":0}},{"line":936,"address":[18060165],"length":1,"stats":{"Line":0}},{"line":939,"address":[19490248],"length":1,"stats":{"Line":0}},{"line":942,"address":[20595488],"length":1,"stats":{"Line":1}},{"line":944,"address":[19691438,19691362],"length":1,"stats":{"Line":2}},{"line":945,"address":[21143029],"length":1,"stats":{"Line":1}},{"line":946,"address":[19703003,19703393],"length":1,"stats":{"Line":2}},{"line":947,"address":[19691881],"length":1,"stats":{"Line":1}},{"line":949,"address":[26362038],"length":1,"stats":{"Line":1}},{"line":950,"address":[20445216,20445320],"length":1,"stats":{"Line":0}},{"line":951,"address":[25190626],"length":1,"stats":{"Line":0}},{"line":953,"address":[19418134],"length":1,"stats":{"Line":0}},{"line":956,"address":[19632793],"length":1,"stats":{"Line":1}},{"line":958,"address":[26822549,26822287],"length":1,"stats":{"Line":1}},{"line":959,"address":[19703069],"length":1,"stats":{"Line":1}},{"line":967,"address":[19692320,19693362,19693578],"length":1,"stats":{"Line":0}},{"line":973,"address":[19692519,19692394,19692450],"length":1,"stats":{"Line":0}},{"line":974,"address":[19633164],"length":1,"stats":{"Line":0}},{"line":975,"address":[19419120,19419150],"length":1,"stats":{"Line":0}},{"line":977,"address":[20595832,20596837,20595892],"length":1,"stats":{"Line":0}},{"line":978,"address":[19704363],"length":1,"stats":{"Line":0}},{"line":979,"address":[19704468],"length":1,"stats":{"Line":0}},{"line":980,"address":[26824006,26823898],"length":1,"stats":{"Line":0}},{"line":981,"address":[19633818],"length":1,"stats":{"Line":0}},{"line":982,"address":[16454967,16454904],"length":1,"stats":{"Line":0}},{"line":984,"address":[20596681,20596793,20596832],"length":1,"stats":{"Line":0}},{"line":985,"address":[26823640],"length":1,"stats":{"Line":0}},{"line":986,"address":[26363577,26363486],"length":1,"stats":{"Line":0}},{"line":989,"address":[19693296],"length":1,"stats":{"Line":0}},{"line":993,"address":[26360096,26361346,26361130],"length":1,"stats":{"Line":0}},{"line":999,"address":[19479578,19479634,19479703],"length":1,"stats":{"Line":0}},{"line":1000,"address":[19479596],"length":1,"stats":{"Line":0}},{"line":1001,"address":[26360202,26360267],"length":1,"stats":{"Line":0}},{"line":1003,"address":[21141876,21141816,21142813],"length":1,"stats":{"Line":0}},{"line":1004,"address":[19702043],"length":1,"stats":{"Line":0}},{"line":1005,"address":[19480129],"length":1,"stats":{"Line":0}},{"line":1007,"address":[20594174,20594066],"length":1,"stats":{"Line":0}},{"line":1008,"address":[19690743],"length":1,"stats":{"Line":0}},{"line":1009,"address":[24729222,24729200],"length":1,"stats":{"Line":0}},{"line":1011,"address":[16453014,16453049,16452922],"length":1,"stats":{"Line":0}},{"line":1012,"address":[20593816],"length":1,"stats":{"Line":0}},{"line":1013,"address":[19691153,19691062],"length":1,"stats":{"Line":0}},{"line":1016,"address":[19480472],"length":1,"stats":{"Line":0}},{"line":1020,"address":[15257868,15257697,15254960],"length":1,"stats":{"Line":0}},{"line":1024,"address":[],"length":0,"stats":{"Line":0}},{"line":1025,"address":[],"length":0,"stats":{"Line":0}},{"line":1026,"address":[],"length":0,"stats":{"Line":0}},{"line":1027,"address":[],"length":0,"stats":{"Line":0}},{"line":1028,"address":[],"length":0,"stats":{"Line":0}},{"line":1029,"address":[],"length":0,"stats":{"Line":0}},{"line":1030,"address":[],"length":0,"stats":{"Line":0}},{"line":1032,"address":[],"length":0,"stats":{"Line":0}},{"line":1033,"address":[],"length":0,"stats":{"Line":0}},{"line":1036,"address":[15255362,15256699],"length":1,"stats":{"Line":0}},{"line":1037,"address":[15257759],"length":1,"stats":{"Line":0}},{"line":1038,"address":[15256730],"length":1,"stats":{"Line":0}},{"line":1042,"address":[],"length":0,"stats":{"Line":0}},{"line":1043,"address":[15257703,15257017,15257189],"length":1,"stats":{"Line":0}},{"line":1045,"address":[],"length":0,"stats":{"Line":0}},{"line":1046,"address":[15257639],"length":1,"stats":{"Line":0}},{"line":1048,"address":[],"length":0,"stats":{"Line":0}},{"line":1049,"address":[],"length":0,"stats":{"Line":0}},{"line":1050,"address":[],"length":0,"stats":{"Line":0}},{"line":1051,"address":[],"length":0,"stats":{"Line":0}},{"line":1052,"address":[],"length":0,"stats":{"Line":0}},{"line":1053,"address":[],"length":0,"stats":{"Line":0}},{"line":1054,"address":[],"length":0,"stats":{"Line":0}},{"line":1055,"address":[],"length":0,"stats":{"Line":0}},{"line":1057,"address":[],"length":0,"stats":{"Line":0}},{"line":1058,"address":[15255521],"length":1,"stats":{"Line":0}},{"line":1059,"address":[15255578,15257946],"length":1,"stats":{"Line":0}},{"line":1060,"address":[15258019,15257954],"length":1,"stats":{"Line":0}},{"line":1061,"address":[],"length":0,"stats":{"Line":0}},{"line":1062,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[15258173],"length":1,"stats":{"Line":0}},{"line":1065,"address":[],"length":0,"stats":{"Line":0}},{"line":1066,"address":[15255585,15258506],"length":1,"stats":{"Line":0}},{"line":1067,"address":[15258684],"length":1,"stats":{"Line":0}},{"line":1069,"address":[15255665],"length":1,"stats":{"Line":0}},{"line":1070,"address":[],"length":0,"stats":{"Line":0}},{"line":1071,"address":[],"length":0,"stats":{"Line":0}},{"line":1073,"address":[],"length":0,"stats":{"Line":0}},{"line":1074,"address":[],"length":0,"stats":{"Line":0}},{"line":1077,"address":[],"length":0,"stats":{"Line":0}},{"line":1079,"address":[15255764],"length":1,"stats":{"Line":0}},{"line":1080,"address":[],"length":0,"stats":{"Line":0}},{"line":1081,"address":[],"length":0,"stats":{"Line":0}},{"line":1082,"address":[],"length":0,"stats":{"Line":0}},{"line":1083,"address":[],"length":0,"stats":{"Line":0}},{"line":1084,"address":[],"length":0,"stats":{"Line":0}},{"line":1085,"address":[],"length":0,"stats":{"Line":0}},{"line":1086,"address":[],"length":0,"stats":{"Line":0}},{"line":1087,"address":[],"length":0,"stats":{"Line":0}},{"line":1088,"address":[],"length":0,"stats":{"Line":0}},{"line":1090,"address":[15255913,15260832,15260844],"length":1,"stats":{"Line":0}},{"line":1091,"address":[],"length":0,"stats":{"Line":0}},{"line":1092,"address":[15259116],"length":1,"stats":{"Line":0}},{"line":1093,"address":[],"length":0,"stats":{"Line":0}},{"line":1096,"address":[],"length":0,"stats":{"Line":0}},{"line":1097,"address":[15259456,15259388],"length":1,"stats":{"Line":0}},{"line":1098,"address":[],"length":0,"stats":{"Line":0}},{"line":1099,"address":[],"length":0,"stats":{"Line":0}},{"line":1100,"address":[15259618],"length":1,"stats":{"Line":0}},{"line":1101,"address":[15259722],"length":1,"stats":{"Line":0}},{"line":1104,"address":[],"length":0,"stats":{"Line":0}},{"line":1105,"address":[],"length":0,"stats":{"Line":0}},{"line":1106,"address":[],"length":0,"stats":{"Line":0}},{"line":1107,"address":[],"length":0,"stats":{"Line":0}},{"line":1108,"address":[],"length":0,"stats":{"Line":0}},{"line":1109,"address":[],"length":0,"stats":{"Line":0}},{"line":1110,"address":[],"length":0,"stats":{"Line":0}},{"line":1111,"address":[],"length":0,"stats":{"Line":0}},{"line":1112,"address":[],"length":0,"stats":{"Line":0}},{"line":1113,"address":[],"length":0,"stats":{"Line":0}},{"line":1115,"address":[],"length":0,"stats":{"Line":0}},{"line":1116,"address":[15256258],"length":1,"stats":{"Line":0}},{"line":1117,"address":[],"length":0,"stats":{"Line":0}},{"line":1118,"address":[15259994],"length":1,"stats":{"Line":0}},{"line":1121,"address":[],"length":0,"stats":{"Line":0}},{"line":1122,"address":[],"length":0,"stats":{"Line":0}},{"line":1123,"address":[15260268,15260330],"length":1,"stats":{"Line":0}},{"line":1124,"address":[],"length":0,"stats":{"Line":0}},{"line":1125,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":0}},{"line":1129,"address":[],"length":0,"stats":{"Line":0}},{"line":1130,"address":[15256325],"length":1,"stats":{"Line":0}},{"line":1132,"address":[15256429],"length":1,"stats":{"Line":0}},{"line":1133,"address":[15256515],"length":1,"stats":{"Line":0}},{"line":1134,"address":[],"length":0,"stats":{"Line":0}},{"line":1139,"address":[19678112,19681798,19681379],"length":1,"stats":{"Line":1}},{"line":1144,"address":[20569948],"length":1,"stats":{"Line":1}},{"line":1145,"address":[19678557,19681796,19678611,19678722],"length":1,"stats":{"Line":2}},{"line":1146,"address":[18063488,18063510],"length":1,"stats":{"Line":1}},{"line":1148,"address":[19678875,19678788],"length":1,"stats":{"Line":2}},{"line":1150,"address":[26798147],"length":1,"stats":{"Line":1}},{"line":1151,"address":[16429938],"length":1,"stats":{"Line":1}},{"line":1152,"address":[19667608,19667546],"length":1,"stats":{"Line":2}},{"line":1154,"address":[19608333,19608431],"length":1,"stats":{"Line":2}},{"line":1156,"address":[19608508,19608810,19608714],"length":1,"stats":{"Line":3}},{"line":1158,"address":[26338170,26338387,26338241],"length":1,"stats":{"Line":2}},{"line":1159,"address":[17841182,17841263],"length":1,"stats":{"Line":0}},{"line":1165,"address":[26338124,26340099],"length":1,"stats":{"Line":0}},{"line":1171,"address":[26799903,26800014],"length":1,"stats":{"Line":2}},{"line":1173,"address":[19668585],"length":1,"stats":{"Line":1}},{"line":1174,"address":[16431252],"length":1,"stats":{"Line":1}},{"line":1176,"address":[19680356],"length":1,"stats":{"Line":1}},{"line":1178,"address":[17993553,17992992],"length":1,"stats":{"Line":2}},{"line":1179,"address":[25183051,25183111,25183564],"length":1,"stats":{"Line":3}},{"line":1180,"address":[18063950,18064192],"length":1,"stats":{"Line":2}},{"line":1182,"address":[18063910,18063985],"length":1,"stats":{"Line":2}},{"line":1186,"address":[21120998],"length":1,"stats":{"Line":1}},{"line":1188,"address":[19669526],"length":1,"stats":{"Line":1}},{"line":1189,"address":[19459101,19459178],"length":1,"stats":{"Line":2}},{"line":1195,"address":[20572912],"length":1,"stats":{"Line":1}},{"line":1199,"address":[21126688,21130352,21132444],"length":1,"stats":{"Line":1}},{"line":1200,"address":[20578441],"length":1,"stats":{"Line":1}},{"line":1201,"address":[19470378,19465046,19465100,19465211],"length":1,"stats":{"Line":2}},{"line":1202,"address":[19687179,19687089],"length":1,"stats":{"Line":1}},{"line":1204,"address":[26806896],"length":1,"stats":{"Line":1}},{"line":1205,"address":[19675839,19676030,19675768],"length":1,"stats":{"Line":3}},{"line":1208,"address":[19465683],"length":1,"stats":{"Line":1}},{"line":1209,"address":[16438472],"length":1,"stats":{"Line":1}},{"line":1210,"address":[21128093,21127839,21130444],"length":1,"stats":{"Line":2}},{"line":1212,"address":[19466169,19468375,19466334,19466223],"length":1,"stats":{"Line":2}},{"line":1213,"address":[19487046,19487024],"length":1,"stats":{"Line":1}},{"line":1214,"address":[20580578,20580467],"length":1,"stats":{"Line":1}},{"line":1215,"address":[21128459,21128709,21128530],"length":1,"stats":{"Line":3}},{"line":1216,"address":[19466672],"length":1,"stats":{"Line":1}},{"line":1217,"address":[18068927,18068846],"length":1,"stats":{"Line":0}},{"line":1219,"address":[16439670,16441028,16439835],"length":1,"stats":{"Line":1}},{"line":1220,"address":[19486734,19486815],"length":1,"stats":{"Line":0}},{"line":1225,"address":[20580999,20580928,20581178,20581240,20581351],"length":1,"stats":{"Line":4}},{"line":1226,"address":[19414070,19413776],"length":1,"stats":{"Line":1}},{"line":1227,"address":[19413887,19413806],"length":1,"stats":{"Line":0}},{"line":1232,"address":[21129998,21130109,21129936],"length":1,"stats":{"Line":2}},{"line":1233,"address":[26808903],"length":1,"stats":{"Line":1}},{"line":1234,"address":[26348370],"length":1,"stats":{"Line":1}},{"line":1236,"address":[25185920,25186214],"length":1,"stats":{"Line":1}},{"line":1237,"address":[18055182,18055263],"length":1,"stats":{"Line":0}},{"line":1242,"address":[21130184],"length":1,"stats":{"Line":1}},{"line":1243,"address":[26809488],"length":1,"stats":{"Line":1}},{"line":1245,"address":[26346340,26346413],"length":1,"stats":{"Line":2}},{"line":1252,"address":[20582497,20582386],"length":1,"stats":{"Line":1}},{"line":1253,"address":[20582145,20582324,20579470],"length":1,"stats":{"Line":3}},{"line":1254,"address":[21132401,21130753,21130574,21130655,21130854],"length":1,"stats":{"Line":2}},{"line":1256,"address":[16442979,16441702,16441537],"length":1,"stats":{"Line":1}},{"line":1257,"address":[19414718,19414799],"length":1,"stats":{"Line":0}},{"line":1263,"address":[21131463,21131574,21131151,21131401,21131222],"length":1,"stats":{"Line":4}},{"line":1264,"address":[24728006,24727712],"length":1,"stats":{"Line":1}},{"line":1265,"address":[17998479,17998398],"length":1,"stats":{"Line":0}},{"line":1271,"address":[26811055,26811228,26811117],"length":1,"stats":{"Line":2}},{"line":1272,"address":[19691574],"length":1,"stats":{"Line":1}},{"line":1273,"address":[19469697],"length":1,"stats":{"Line":1}},{"line":1275,"address":[18067878,18067584],"length":1,"stats":{"Line":1}},{"line":1276,"address":[19486094,19486175],"length":1,"stats":{"Line":0}},{"line":1282,"address":[26350631],"length":1,"stats":{"Line":1}},{"line":1283,"address":[26350735],"length":1,"stats":{"Line":1}},{"line":1287,"address":[19683872,19686613,19686517],"length":1,"stats":{"Line":1}},{"line":1288,"address":[19672397],"length":1,"stats":{"Line":1}},{"line":1289,"address":[19462304,19462412,19464595,19462253],"length":1,"stats":{"Line":2}},{"line":1290,"address":[16435168,16435231],"length":1,"stats":{"Line":1}},{"line":1292,"address":[19613784,19613713],"length":1,"stats":{"Line":2}},{"line":1293,"address":[16435450,16435513],"length":1,"stats":{"Line":1}},{"line":1294,"address":[26803885,26803974],"length":1,"stats":{"Line":2}},{"line":1296,"address":[16435501],"length":1,"stats":{"Line":0}},{"line":1299,"address":[26803990],"length":1,"stats":{"Line":1}},{"line":1300,"address":[26804035],"length":1,"stats":{"Line":1}},{"line":1302,"address":[21126622,21124936,21125044],"length":1,"stats":{"Line":1}},{"line":1303,"address":[26343408],"length":1,"stats":{"Line":1}},{"line":1304,"address":[16435779,16435716],"length":1,"stats":{"Line":1}},{"line":1306,"address":[19685135,19685057,19685211],"length":1,"stats":{"Line":3}},{"line":1307,"address":[17995062,17995040],"length":1,"stats":{"Line":2}},{"line":1310,"address":[26805006,26805744,26805218,26805114],"length":1,"stats":{"Line":2}},{"line":1312,"address":[20439398,20439376],"length":1,"stats":{"Line":1}},{"line":1315,"address":[21126034],"length":1,"stats":{"Line":1}},{"line":1317,"address":[16436862],"length":1,"stats":{"Line":1}},{"line":1318,"address":[19674565],"length":1,"stats":{"Line":1}},{"line":1319,"address":[26805617],"length":1,"stats":{"Line":1}},{"line":1320,"address":[19674950],"length":1,"stats":{"Line":1}},{"line":1325,"address":[21126146,21126123],"length":1,"stats":{"Line":2}},{"line":1326,"address":[19464146],"length":1,"stats":{"Line":1}},{"line":1329,"address":[21125403,21125358],"length":1,"stats":{"Line":1}},{"line":1330,"address":[16436203],"length":1,"stats":{"Line":0}},{"line":1333,"address":[19614553],"length":1,"stats":{"Line":1}},{"line":1337,"address":[16434713,16434480,16432736],"length":1,"stats":{"Line":1}},{"line":1338,"address":[19670346],"length":1,"stats":{"Line":1}},{"line":1339,"address":[20575600,20573954,20574005,20574113],"length":1,"stats":{"Line":2}},{"line":1340,"address":[26801482,26801569],"length":1,"stats":{"Line":1}},{"line":1342,"address":[19682493,19682422],"length":1,"stats":{"Line":2}},{"line":1343,"address":[26801796,26801859],"length":1,"stats":{"Line":1}},{"line":1344,"address":[19460562,19460651],"length":1,"stats":{"Line":2}},{"line":1346,"address":[19611831],"length":1,"stats":{"Line":0}},{"line":1349,"address":[26341259],"length":1,"stats":{"Line":1}},{"line":1350,"address":[19671275,19672113],"length":1,"stats":{"Line":2}},{"line":1356,"address":[19682857,19683631,19682750,19682965],"length":1,"stats":{"Line":4}},{"line":1357,"address":[21122808],"length":1,"stats":{"Line":1}},{"line":1358,"address":[19671305,19671397],"length":1,"stats":{"Line":4}},{"line":1360,"address":[20574766],"length":1,"stats":{"Line":1}},{"line":1361,"address":[26341708,26341607],"length":1,"stats":{"Line":2}},{"line":1365,"address":[19683206],"length":1,"stats":{"Line":1}},{"line":1368,"address":[17994470,17994176],"length":1,"stats":{"Line":2}},{"line":1369,"address":[17994287,17994206],"length":1,"stats":{"Line":0}},{"line":1372,"address":[19461393],"length":1,"stats":{"Line":1}},{"line":1373,"address":[19461494],"length":1,"stats":{"Line":1}}],"covered":116,"coverable":644},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","task.rs"],"content":"//! Task command implementations\n\nuse crate::entities::{Entity, Task, TaskPriority};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\nuse serde::Deserialize;\nuse std::fs;\nuse std::io::{self, Read};\n\n/// Task input structure for JSON\n#[derive(Debug, Deserialize)]\npub struct TaskInput {\n    pub title: String,\n    pub description: Option\u003cString\u003e,\n    pub priority: Option\u003cString\u003e,\n    pub agent: Option\u003cString\u003e,\n    pub parent: Option\u003cString\u003e,\n    pub tags: Option\u003cVec\u003cString\u003e\u003e,\n}\n\n/// Task commands\n#[derive(Subcommand)]\npub enum TaskCommands {\n    /// Create a new task\n    Create {\n        /// Task title\n        #[arg(long, short, conflicts_with_all = [\"title_stdin\", \"title_file\"])]\n        title: Option\u003cString\u003e,\n\n        /// Task description\n        #[arg(long, short, conflicts_with_all = [\"description_stdin\", \"description_file\"])]\n        description: Option\u003cString\u003e,\n\n        /// Priority (low, medium, high, critical)\n        #[arg(long, short, default_value = \"medium\")]\n        priority: String,\n\n        /// Assigned agent\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Parent task ID\n        #[arg(long)]\n        parent: Option\u003cString\u003e,\n\n        /// Tags (comma-separated)\n        #[arg(long)]\n        tags: Option\u003cString\u003e,\n\n        /// Read title from stdin\n        #[arg(long, conflicts_with_all = [\"title\", \"title_file\"])]\n        title_stdin: bool,\n\n        /// Read title from file\n        #[arg(long, conflicts_with_all = [\"title\", \"title_stdin\"])]\n        title_file: Option\u003cString\u003e,\n\n        /// Read description from stdin\n        #[arg(long, conflicts_with_all = [\"description\", \"description_file\"])]\n        description_stdin: bool,\n\n        /// Read description from file\n        #[arg(long, conflicts_with_all = [\"description\", \"description_stdin\"])]\n        description_file: Option\u003cString\u003e,\n\n        /// Create task from JSON input (stdin or file)\n        #[arg(long, conflicts_with_all = [\"title\", \"description\", \"title_stdin\", \"title_file\", \"description_stdin\", \"description_file\"])]\n        json: bool,\n\n        /// JSON file path\n        #[arg(long, requires = \"json\")]\n        json_file: Option\u003cString\u003e,\n    },\n    /// List tasks\n    List {\n        /// Filter by agent\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        /// Filter by status\n        #[arg(long, short)]\n        status: Option\u003cString\u003e,\n\n        /// Limit number of results\n        #[arg(long, short)]\n        limit: Option\u003cusize\u003e,\n    },\n    /// Show task details\n    Show {\n        /// Task ID\n        #[arg(help = \"Task ID to show\")]\n        id: String,\n    },\n    /// Update task status\n    Update {\n        /// Task ID\n        #[arg(help = \"Task ID to update\")]\n        id: String,\n\n        /// New status (todo, in_progress, done, blocked, cancelled)\n        #[arg(\n            long,\n            short,\n            help = \"New status: todo, in_progress, done, blocked, cancelled\"\n        )]\n        status: String,\n\n        /// Outcome (when completing task)\n        #[arg(long)]\n        outcome: Option\u003cString\u003e,\n    },\n    /// Archive a task (soft delete)\n    Archive {\n        /// Task ID\n        #[arg(help = \"Task ID to archive\")]\n        id: String,\n\n        /// Reason for archiving\n        #[arg(long)]\n        reason: Option\u003cString\u003e,\n    },\n}\n\n/// Read content from stdin\nfn read_stdin() -\u003e Result\u003cString, EngramError\u003e {\n    let mut buffer = String::new();\n    io::stdin()\n        .read_to_string(\u0026mut buffer)\n        .map_err(|e| EngramError::Io(e))?;\n    Ok(buffer.trim().to_string())\n}\n\n/// Read content from file\nfn read_file(path: \u0026str) -\u003e Result\u003cString, EngramError\u003e {\n    fs::read_to_string(path).map_err(EngramError::Io)\n}\n\n/// Create task from JSON input\nfn create_task_from_input\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    input: TaskInput,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let priority_enum = match input.priority.as_deref().unwrap_or(\"medium\") {\n        \"low\" =\u003e TaskPriority::Low,\n        \"medium\" =\u003e TaskPriority::Medium,\n        \"high\" =\u003e TaskPriority::High,\n        \"critical\" =\u003e TaskPriority::Critical,\n        _ =\u003e TaskPriority::Medium,\n    };\n\n    let mut task = Task::new(\n        input.title,\n        input.description.unwrap_or_default(),\n        input.agent.unwrap_or_else(|| \"default\".to_string()),\n        priority_enum,\n        None,\n    );\n\n    if let Some(parent_id) = input.parent {\n        task.parent = Some(parent_id);\n    }\n\n    if let Some(tags_vec) = input.tags {\n        task.tags = tags_vec;\n    }\n\n    let generic = task.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"‚úÖ Task created:\");\n    display_task(\u0026task);\n\n    Ok(())\n}\n\n/// Create task command\npub fn create_task\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    title: Option\u003cString\u003e,\n    description: Option\u003cString\u003e,\n    priority: \u0026str,\n    agent: Option\u003cString\u003e,\n    parent: Option\u003cString\u003e,\n    tags: Option\u003cString\u003e,\n    // New parameters for flexible input\n    title_stdin: bool,\n    title_file: Option\u003cString\u003e,\n    description_stdin: bool,\n    description_file: Option\u003cString\u003e,\n    json: bool,\n    json_file: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    // Handle JSON input first (overrides all other inputs)\n    if json {\n        let json_content = if let Some(ref file_path) = json_file {\n            read_file(file_path)?\n        } else {\n            read_stdin()?\n        };\n\n        let task_input: TaskInput = serde_json::from_str(\u0026json_content)\n            .map_err(|e| EngramError::Validation(format!(\"Invalid JSON: {}\", e)))?;\n\n        return create_task_from_input(storage, task_input);\n    }\n\n    // Resolve title from various sources\n    let final_title = if title_stdin {\n        read_stdin()?\n    } else if let Some(ref file_path) = title_file {\n        read_file(file_path)?\n    } else if let Some(ref t) = title {\n        t.clone()\n    } else {\n        return Err(EngramError::Validation(\n            \"Title required: use --title, --title-stdin, or --title-file\".to_string(),\n        ));\n    };\n\n    // Resolve description from various sources\n    let _final_description = if description_stdin {\n        Some(read_stdin()?)\n    } else if let Some(ref file_path) = description_file {\n        Some(read_file(file_path)?)\n    } else {\n        description.as_ref().map(|s| s.clone())\n    };\n\n    // Resolve description from various sources\n    let final_description = if description_stdin {\n        Some(read_stdin()?)\n    } else if let Some(file_path) = description_file {\n        Some(read_file(\u0026file_path)?)\n    } else {\n        description.map(|s| s.to_string())\n    };\n\n    let priority_enum = match priority {\n        \"low\" =\u003e TaskPriority::Low,\n        \"medium\" =\u003e TaskPriority::Medium,\n        \"high\" =\u003e TaskPriority::High,\n        \"critical\" =\u003e TaskPriority::Critical,\n        _ =\u003e TaskPriority::Medium,\n    };\n\n    let mut task = Task::new(\n        final_title,\n        final_description.unwrap_or_default(),\n        agent.unwrap_or_else(|| \"default\".to_string()),\n        priority_enum,\n        None,\n    );\n\n    if let Some(parent_id) = parent {\n        task.parent = Some(parent_id.to_string());\n    }\n\n    if let Some(tags_str) = tags {\n        task.tags = tags_str.split(',').map(|s| s.trim().to_string()).collect();\n    }\n\n    let generic = task.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"‚úÖ Task created:\");\n    display_task(\u0026task);\n\n    Ok(())\n}\n\n/// List tasks command\npub fn list_tasks\u003cS: Storage\u003e(\n    storage: \u0026S,\n    agent: Option\u003c\u0026str\u003e,\n    status: Option\u003c\u0026str\u003e,\n    limit: Option\u003cusize\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut tasks = storage.query_by_agent(agent.unwrap_or(\"default\"), Some(\"task\"))?;\n\n    // Filter by status if specified\n    if let Some(status_filter) = status {\n        tasks.retain(|generic_task| {\n            if let Ok(task_obj) = Task::from_generic(generic_task.clone()) {\n                format!(\"{:?}\", task_obj.status).to_lowercase() == status_filter.to_lowercase()\n            } else {\n                false\n            }\n        });\n    }\n\n    // Apply limit\n    if let Some(limit_val) = limit {\n        tasks.truncate(limit_val);\n    }\n\n    if tasks.is_empty() {\n        println!(\"No tasks found\");\n        return Ok(());\n    }\n\n    println!(\"üìã Tasks ({} found):\", tasks.len());\n    for generic_task in \u0026tasks {\n        if let Ok(task_obj) = Task::from_generic(generic_task.clone()) {\n            display_task_summary(\u0026task_obj);\n        }\n    }\n\n    Ok(())\n}\n\npub fn show_task\u003cS: Storage + 'static\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic_task) = storage.get(id, \"task\")? {\n        if let Ok(task_obj) = Task::from_generic(generic_task) {\n            println!(\"üìã Task Details:\");\n            display_task(\u0026task_obj);\n\n            // Query and display associated workflow instances\n            println!(\"\\nüîÑ Associated Workflows:\");\n            println!(\"=======================\");\n\n            let instances: Vec\u003c_\u003e = storage\n                .get_all(\"workflow_instance\")\n                .unwrap_or_else(|_| Vec::new())\n                .into_iter()\n                .filter_map(|e| crate::entities::WorkflowInstance::from_generic(e).ok())\n                .filter(|instance| instance.context.entity_id.as_deref() == Some(id))\n                .collect();\n\n            if instances.is_empty() {\n                println!(\"  No active workflows associated with this task.\");\n            } else {\n                for instance in \u0026instances {\n                    let status_icon = match instance.status {\n                        crate::engines::workflow_engine::WorkflowStatus::Running =\u003e \"üü¢\",\n                        crate::engines::workflow_engine::WorkflowStatus::Completed =\u003e \"üéØ\",\n                        crate::engines::workflow_engine::WorkflowStatus::Failed(_) =\u003e \"üí•\",\n                        crate::engines::workflow_engine::WorkflowStatus::Suspended(_) =\u003e \"‚è∏Ô∏è\",\n                        crate::engines::workflow_engine::WorkflowStatus::Cancelled =\u003e \"‚ùå\",\n                    };\n\n                    println!(\n                        \"  {} Workflow: {} [{}]\",\n                        status_icon, instance.workflow_id, instance.status\n                    );\n                    println!(\n                        \"     State: {} | Started: {}\",\n                        instance.current_state,\n                        instance.started_at.format(\"%Y-%m-%d %H:%M\")\n                    );\n                    println!(\"     Instance ID: {}\", instance.id);\n                    println!();\n                }\n            }\n        } else {\n            return Err(EngramError::Validation(\"Invalid task type\".to_string()));\n        }\n    } else {\n        return Err(EngramError::NotFound(format!(\"Task '{}' not found\", id)));\n    }\n\n    Ok(())\n}\n\n/// Update task command\npub fn update_task\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    status: \u0026str,\n    outcome: Option\u003c\u0026str\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let existing_generic = storage\n        .get(id, \"task\")?\n        .ok_or_else(|| EngramError::NotFound(format!(\"Task '{}' not found\", id)))?;\n\n    if let Ok(task) = Task::from_generic(existing_generic) {\n        let mut updated_task = task;\n\n        match status.to_lowercase().as_str() {\n            // Handle \"todo\" - reset task to initial state\n            \"todo\" | \"backlog\" =\u003e {\n                updated_task.status = crate::entities::TaskStatus::Todo;\n            }\n            // Handle various forms of in_progress\n            \"in_progress\" | \"in-progress\" | \"inprogress\" | \"progress\" | \"started\" =\u003e {\n                updated_task.start();\n            }\n            // Handle done/completed\n            \"done\" | \"completed\" | \"complete\" | \"finish\" | \"finished\" =\u003e {\n                if let Some(outcome_text) = outcome {\n                    updated_task.complete(outcome_text.to_string());\n                } else {\n                    updated_task.complete(\"Task completed\".to_string());\n                }\n            }\n            // Handle blocked\n            \"blocked\" | \"block\" | \"waiting\" | \"on_hold\" | \"on-hold\" | \"onhold\" =\u003e {\n                updated_task.status = crate::entities::TaskStatus::Blocked;\n            }\n            // Handle cancelled\n            \"cancelled\" | \"canceled\" | \"cancel\" | \"abandoned\" | \"dropped\" =\u003e {\n                updated_task.status = crate::entities::TaskStatus::Cancelled;\n            }\n            _ =\u003e {\n                return Err(EngramError::Validation(format!(\n                \"Invalid status: '{}'. Valid values: todo, in_progress, done, blocked, cancelled\",\n                status\n            )))\n            }\n        }\n\n        let updated_generic = updated_task.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\"‚úÖ Task updated:\");\n        display_task(\u0026updated_task);\n\n        Ok(())\n    } else {\n        Err(EngramError::Validation(\"Invalid task type\".to_string()))\n    }\n}\n\n/// Archive task command (soft delete - preserves data but marks as archived)\npub fn archive_task\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    reason: Option\u003c\u0026str\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let existing_generic = storage\n        .get(id, \"task\")?\n        .ok_or_else(|| EngramError::NotFound(format!(\"Task '{}' not found\", id)))?;\n\n    if let Ok(task) = Task::from_generic(existing_generic) {\n        let mut updated_task = task;\n        updated_task.status = crate::entities::TaskStatus::Cancelled;\n        if let Some(reason_text) = reason {\n            let archive_note = format!(\"Archived: {}\", reason_text);\n            if updated_task.outcome.is_none() {\n                updated_task.outcome = Some(archive_note);\n            }\n        }\n\n        let updated_generic = updated_task.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\"‚úÖ Task '{}' archived (soft deleted)\", id);\n        println!(\"  Reason: {}\", reason.unwrap_or(\"No reason provided\"));\n        println!(\"  Use 'engram task update {} --status todo' to restore\", id);\n\n        Ok(())\n    } else {\n        Err(EngramError::Validation(\"Invalid task type\".to_string()))\n    }\n}\n\n/// Display task information\nfn display_task(task: \u0026Task) {\n    println!(\"  ID: {}\", task.id);\n    println!(\"  Title: {}\", task.title);\n    println!(\"  Description: {}\", task.description);\n    println!(\"  Status: {:?}\", task.status);\n    println!(\"  Priority: {:?}\", task.priority);\n    println!(\"  Agent: {}\", task.agent);\n    println!(\n        \"  Created: {}\",\n        task.start_time.format(\"%Y-%m-%d %H:%M:%S UTC\")\n    );\n    if let Some(end_time) = task.end_time {\n        println!(\"  Completed: {}\", end_time.format(\"%Y-%m-%d %H:%M:%S UTC\"));\n    }\n    if let Some(outcome) = \u0026task.outcome {\n        println!(\"  Outcome: {}\", outcome);\n    }\n    if !task.tags.is_empty() {\n        println!(\"  Tags: {}\", task.tags.join(\", \"));\n    }\n    if !task.context_ids.is_empty() {\n        println!(\"  Contexts: {}\", task.context_ids.join(\", \"));\n    }\n    println!();\n}\n\n/// Display task summary for lists\nfn display_task_summary(task: \u0026Task) {\n    println!(\n        \"  ‚Ä¢ {} [{}] - {} ({})\",\n        task.id,\n        format!(\"{:?}\", task.status).to_lowercase(),\n        task.title,\n        task.agent\n    );\n    if let Some(outcome) = \u0026task.outcome {\n        println!(\"    Outcome: {}\", outcome);\n    }\n}\n","traces":[{"line":126,"address":[18718371,18717904,18718365],"length":1,"stats":{"Line":0}},{"line":127,"address":[18566678],"length":1,"stats":{"Line":0}},{"line":128,"address":[18717931,18718160,18718064,18717993],"length":1,"stats":{"Line":0}},{"line":129,"address":[18788769],"length":1,"stats":{"Line":0}},{"line":130,"address":[18196504,18196496],"length":1,"stats":{"Line":0}},{"line":131,"address":[18777455],"length":1,"stats":{"Line":0}},{"line":135,"address":[17123520],"length":1,"stats":{"Line":0}},{"line":136,"address":[25450391],"length":1,"stats":{"Line":0}},{"line":140,"address":[15003022,15003286,15001232],"length":1,"stats":{"Line":0}},{"line":144,"address":[15001275,15001447],"length":1,"stats":{"Line":0}},{"line":145,"address":[15001506,15001572],"length":1,"stats":{"Line":0}},{"line":146,"address":[15001622,15001583,15001549],"length":1,"stats":{"Line":0}},{"line":147,"address":[15001633,15001599,15001672],"length":1,"stats":{"Line":0}},{"line":148,"address":[15001683,15001696,15001649],"length":1,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[15001858,15003328,15003340],"length":1,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[15001977],"length":1,"stats":{"Line":0}},{"line":160,"address":[15002070,15002358],"length":1,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[15002468,15002422],"length":1,"stats":{"Line":0}},{"line":168,"address":[15002441],"length":1,"stats":{"Line":0}},{"line":169,"address":[15002697,15002626],"length":1,"stats":{"Line":0}},{"line":171,"address":[15002834],"length":1,"stats":{"Line":0}},{"line":172,"address":[15002879],"length":1,"stats":{"Line":0}},{"line":174,"address":[15002900],"length":1,"stats":{"Line":0}},{"line":178,"address":[14989710,14994028,14986976],"length":1,"stats":{"Line":0}},{"line":195,"address":[14987226],"length":1,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[14987484,14987420],"length":1,"stats":{"Line":0}},{"line":212,"address":[14987492,14987624,14987904],"length":1,"stats":{"Line":0}},{"line":213,"address":[14987523,14987927,14987993],"length":1,"stats":{"Line":0}},{"line":214,"address":[14987985,14987935],"length":1,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[14992271,14988377,14988837],"length":1,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[14994144,14988828,14994160,14988446],"length":1,"stats":{"Line":0}},{"line":231,"address":[14989970,14988781],"length":1,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[14989325,14989189],"length":1,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[14990020,14990065,14989635],"length":1,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[14990141,14990186,14990104],"length":1,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[14990206],"length":1,"stats":{"Line":0}},{"line":248,"address":[14990224],"length":1,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[14990396,14994448,14994460],"length":1,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[14990517],"length":1,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[14990807,14990687],"length":1,"stats":{"Line":0}},{"line":259,"address":[14990722,14991039],"length":1,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[14991616],"length":1,"stats":{"Line":0}},{"line":267,"address":[14991661],"length":1,"stats":{"Line":0}},{"line":269,"address":[14991688],"length":1,"stats":{"Line":0}},{"line":273,"address":[14986153,14986053,14984848],"length":1,"stats":{"Line":0}},{"line":279,"address":[14984956],"length":1,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[14985371,14985397],"length":1,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[14985587],"length":1,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[14985734],"length":1,"stats":{"Line":0}},{"line":312,"address":[15005455,15003376,15005789],"length":1,"stats":{"Line":0}},{"line":313,"address":[15003416],"length":1,"stats":{"Line":0}},{"line":314,"address":[15004004,15003650],"length":1,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[15004095],"length":1,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[15004240,15006016,15006032],"length":1,"stats":{"Line":0}},{"line":326,"address":[15005824,15005860,15004313],"length":1,"stats":{"Line":0}},{"line":327,"address":[15005904,15004320,15005936],"length":1,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[15004509,15004453],"length":1,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[15004659],"length":1,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[15004717],"length":1,"stats":{"Line":0}},{"line":338,"address":[15004746],"length":1,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[15004807],"length":1,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[15005029,15005082],"length":1,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[15005305],"length":1,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[15005651,15003942],"length":1,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[14997940,14998050,14994592],"length":1,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[14998153,14998128,14994909,14994997],"length":1,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[14995904],"length":1,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[14997370,14996003],"length":1,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[14997256,14997306],"length":1,"stats":{"Line":0}},{"line":393,"address":[14997275,14997338],"length":1,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[14996720,14996794],"length":1,"stats":{"Line":0}},{"line":402,"address":[14996786],"length":1,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[14997478,14997407],"length":1,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[14997660],"length":1,"stats":{"Line":0}},{"line":418,"address":[14997684],"length":1,"stats":{"Line":0}},{"line":420,"address":[14995563,14997951],"length":1,"stats":{"Line":0}},{"line":425,"address":[14999933,15000906,14998320],"length":1,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[15000976,14998654,14998569,15001001],"length":1,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[14999874,14999567,14999635],"length":1,"stats":{"Line":0}},{"line":440,"address":[14999751,14999660],"length":1,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[15000429],"length":1,"stats":{"Line":0}},{"line":451,"address":[15000530],"length":1,"stats":{"Line":0}},{"line":453,"address":[14999202,15000807],"length":1,"stats":{"Line":0}},{"line":458,"address":[20208783,20208789,20207632],"length":1,"stats":{"Line":0}},{"line":459,"address":[19783751],"length":1,"stats":{"Line":0}},{"line":460,"address":[20207772],"length":1,"stats":{"Line":0}},{"line":461,"address":[18567371],"length":1,"stats":{"Line":0}},{"line":462,"address":[18777957],"length":1,"stats":{"Line":0}},{"line":463,"address":[17121333],"length":1,"stats":{"Line":0}},{"line":464,"address":[25908930],"length":1,"stats":{"Line":0}},{"line":465,"address":[25909020],"length":1,"stats":{"Line":0}},{"line":469,"address":[18778457],"length":1,"stats":{"Line":0}},{"line":470,"address":[20208516,20208654],"length":1,"stats":{"Line":0}},{"line":472,"address":[18719559,18719347],"length":1,"stats":{"Line":0}},{"line":473,"address":[25909583],"length":1,"stats":{"Line":0}},{"line":475,"address":[25909701],"length":1,"stats":{"Line":0}},{"line":476,"address":[20208952,20209066],"length":1,"stats":{"Line":0}},{"line":478,"address":[19785136],"length":1,"stats":{"Line":0}},{"line":479,"address":[18790723,18790852],"length":1,"stats":{"Line":0}},{"line":481,"address":[18779289],"length":1,"stats":{"Line":0}},{"line":485,"address":[20210249,20209472,20210255],"length":1,"stats":{"Line":0}},{"line":486,"address":[25910263,25910474],"length":1,"stats":{"Line":0}},{"line":493,"address":[18791587],"length":1,"stats":{"Line":0}},{"line":494,"address":[18569632],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":192},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","validation.rs"],"content":"//! Validation command implementations\n\nuse crate::error::EngramError;\nuse crate::storage::{RelationshipStorage, Storage};\nuse crate::validation::{CommitValidator, HookManager};\nuse clap::Subcommand;\n\n/// Validation commands\n#[derive(Debug, Subcommand)]\npub enum ValidationCommands {\n    /// Validate a commit\n    Commit {\n        /// Commit message to validate\n        #[arg(long, short)]\n        message: String,\n\n        /// Dry run (don't require actual git repo)\n        #[arg(long)]\n        dry_run: bool,\n    },\n    /// Manage git hooks\n    Hook {\n        #[command(subcommand)]\n        command: HookCommands,\n    },\n    /// Check validation setup\n    Check,\n}\n\n/// Hook management commands\n#[derive(Debug, Subcommand)]\npub enum HookCommands {\n    /// Install pre-commit hook\n    Install,\n    /// Uninstall pre-commit hook\n    Uninstall,\n    /// Show hook status\n    Status,\n}\n\n/// Handle validation commands\npub fn handle_validation_command\u003cS: Storage + RelationshipStorage\u003e(\n    command: ValidationCommands,\n    storage: S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        ValidationCommands::Commit { message, dry_run } =\u003e {\n            handle_commit_validation(storage, \u0026message, dry_run)?;\n        }\n        ValidationCommands::Hook { command } =\u003e {\n            handle_hook_command(storage, command)?;\n        }\n        ValidationCommands::Check =\u003e {\n            handle_check_command(storage)?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle commit validation\nfn handle_commit_validation\u003cS: Storage + RelationshipStorage\u003e(\n    storage: S,\n    message: \u0026str,\n    dry_run: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut validator = CommitValidator::new(storage)?;\n\n    let staged_files = if dry_run {\n        vec![]\n    } else {\n        validator.get_staged_files()?\n    };\n\n    let result = validator.validate_commit(message, \u0026staged_files);\n\n    if result.valid {\n        println!(\"‚úÖ Validation passed\");\n        if !result.task_id.as_ref().map_or(true, |id| id == \"exempt\") {\n            println!(\"üìã Task ID: {}\", result.task_id.unwrap());\n        }\n    } else {\n        println!(\"‚ùå Validation failed\");\n        for error in result.errors {\n            println!(\"  ‚Ä¢ {}\", error.message);\n            if let Some(suggestion) = error.suggestion {\n                println!(\"    üí° {}\", suggestion);\n            }\n        }\n\n        std::process::exit(1);\n    }\n\n    Ok(())\n}\n\n/// Handle hook management commands\nfn handle_hook_command\u003cS: Storage + RelationshipStorage\u003e(\n    _storage: S,\n    command: HookCommands,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let git_dir = \".\";\n    let mut hook_manager = HookManager::new(git_dir)?;\n\n    match command {\n        HookCommands::Install =\u003e {\n            hook_manager.install()?;\n            println!(\"‚úÖ Hook installed successfully\");\n        }\n        HookCommands::Uninstall =\u003e {\n            hook_manager.uninstall()?;\n            println!(\"‚úÖ Hook uninstalled successfully\");\n        }\n        HookCommands::Status =\u003e {\n            hook_manager.show_status()?;\n        }\n    }\n\n    Ok(())\n}\n\n/// Handle check command\nfn handle_check_command\u003cS: Storage + RelationshipStorage\u003e(storage: S) -\u003e Result\u003c(), EngramError\u003e {\n    let _validator = CommitValidator::new(storage)?;\n    let git_dir = \".\";\n    let hook_manager = HookManager::new(git_dir)?;\n\n    let status = hook_manager.verify_setup()?;\n\n    if status.is_healthy() {\n        println!(\"üéâ All validation systems are working correctly!\");\n    } else {\n        println!(\"‚ö†Ô∏è  Issues found:\");\n        for issue in status.get_issues() {\n            println!(\"  ‚Ä¢ {}\", issue);\n        }\n        println!(\"\\nRun 'engram validation hook install' to fix setup issues.\");\n    }\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_validation_command_parsing() {\n        // Test basic command structure\n        let _cmd = ValidationCommands::Commit {\n            message: \"test\".to_string(),\n            dry_run: false,\n        };\n    }\n}\n","traces":[{"line":42,"address":[14539216,14539972],"length":1,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[14539991,14539487],"length":1,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[14539144,14536736,14538345],"length":1,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[14537021,14537087],"length":1,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[14537596,14537786,14538359],"length":1,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[14538592],"length":1,"stats":{"Line":0}},{"line":97,"address":[14535022,14533792,14535030],"length":1,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[14534632,14534301,14534420],"length":1,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[14535800,14535729],"length":1,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":51},{"path":["/","home","shift","code","vincents-ai","engram","src","cli","workflow.rs"],"content":"use crate::engines::rule_engine::RuleValue;\nuse crate::engines::workflow_engine::WorkflowAutomationEngine;\nuse crate::entities::{\n    Entity, StateType, TransitionType, Workflow, WorkflowState, WorkflowStatus, WorkflowTransition,\n};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse clap::Subcommand;\nuse std::collections::HashMap;\nuse uuid::Uuid;\n\n/// Workflow commands\n#[derive(Debug, Subcommand)]\npub enum WorkflowCommands {\n    /// Create a new workflow\n    Create {\n        /// Workflow title\n        #[arg(long, short)]\n        title: String,\n\n        /// Workflow description\n        #[arg(long)]\n        description: String,\n\n        /// Entity types (comma-separated)\n        #[arg(long)]\n        entity_types: Option\u003cString\u003e,\n\n        /// Agent to assign\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n    },\n    /// Get workflow details\n    Get {\n        /// Workflow ID\n        #[arg(help = \"Workflow ID to retrieve\")]\n        id: String,\n    },\n    /// Update workflow\n    Update {\n        /// Workflow ID\n        #[arg(help = \"Workflow ID to update\")]\n        id: String,\n\n        /// Workflow title\n        #[arg(long)]\n        title: Option\u003cString\u003e,\n\n        /// Workflow description\n        #[arg(long)]\n        description: Option\u003cString\u003e,\n\n        /// Workflow status (active, inactive, draft, archived)\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n\n        /// Entity types (comma-separated)\n        #[arg(long)]\n        entity_types: Option\u003cString\u003e,\n\n        /// Initial state ID\n        #[arg(long)]\n        initial_state: Option\u003cString\u003e,\n    },\n    /// Delete workflow\n    Delete {\n        /// Workflow ID\n        #[arg(help = \"Workflow ID to delete\")]\n        id: String,\n    },\n    /// List workflows\n    List {\n        /// Status filter\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n\n        /// Text search\n        #[arg(long)]\n        search: Option\u003cString\u003e,\n\n        /// Limit results\n        #[arg(long, default_value = \"20\")]\n        limit: usize,\n\n        /// Offset for pagination\n        #[arg(long, default_value = \"0\")]\n        offset: usize,\n    },\n    /// Add state to workflow\n    AddState {\n        /// Workflow ID\n        #[arg(help = \"Workflow ID to add state to\")]\n        id: String,\n\n        /// State name\n        #[arg(long)]\n        name: String,\n\n        /// State type (start, in_progress, review, done, blocked)\n        #[arg(long, default_value = \"in_progress\")]\n        state_type: String,\n\n        /// State description\n        #[arg(long)]\n        description: String,\n\n        /// Whether this is a final state\n        #[arg(long, action)]\n        is_final: bool,\n    },\n    /// Add transition to workflow\n    AddTransition {\n        /// Workflow ID\n        #[arg(help = \"Workflow ID to add transition to\")]\n        id: String,\n\n        /// Transition name\n        #[arg(long)]\n        name: String,\n\n        /// From state ID\n        #[arg(long)]\n        from_state: String,\n\n        /// To state ID\n        #[arg(long)]\n        to_state: String,\n\n        /// Transition type (automatic, manual, conditional, scheduled)\n        #[arg(long, default_value = \"manual\")]\n        transition_type: String,\n\n        /// Transition description\n        #[arg(long)]\n        description: String,\n    },\n    /// Activate workflow\n    Activate {\n        /// Workflow ID\n        #[arg(help = \"Workflow ID to activate\")]\n        id: String,\n    },\n    /// Start a workflow instance\n    Start {\n        /// Workflow ID to start\n        #[arg(help = \"Workflow definition ID\")]\n        workflow_id: String,\n\n        /// Entity ID to associate\n        #[arg(long)]\n        entity_id: Option\u003cString\u003e,\n\n        /// Entity type\n        #[arg(long)]\n        entity_type: Option\u003cString\u003e,\n\n        /// Executing agent\n        #[arg(long, short)]\n        agent: String,\n\n        /// Initial variables (key=value pairs, comma-separated)\n        #[arg(long)]\n        variables: Option\u003cString\u003e,\n    },\n    /// Execute a transition in a workflow instance\n    Transition {\n        /// Workflow instance ID\n        #[arg(help = \"Workflow instance ID\")]\n        instance_id: String,\n\n        /// Transition name to execute\n        #[arg(long, short)]\n        transition: String,\n\n        /// Executing agent\n        #[arg(long, short)]\n        agent: String,\n    },\n    /// Get workflow instance status\n    Status {\n        /// Workflow instance ID\n        #[arg(help = \"Workflow instance ID\")]\n        instance_id: String,\n    },\n    /// List active workflow instances\n    Instances {\n        /// Filter by workflow ID\n        #[arg(long)]\n        workflow_id: Option\u003cString\u003e,\n\n        /// Filter by agent\n        #[arg(long)]\n        agent: Option\u003cString\u003e,\n\n        /// Show only running instances\n        #[arg(long, action)]\n        running_only: bool,\n    },\n    /// Cancel a workflow instance\n    Cancel {\n        /// Workflow instance ID\n        #[arg(help = \"Workflow instance ID\")]\n        instance_id: String,\n\n        /// Executing agent\n        #[arg(long, short)]\n        agent: String,\n\n        /// Reason for cancellation\n        #[arg(long)]\n        reason: Option\u003cString\u003e,\n    },\n    /// Execute an action (external command, notification, etc.)\n    ExecuteAction {\n        /// Action type (external_command, notification, update_entity)\n        #[arg(long)]\n        action_type: String,\n\n        /// Command to execute (for external_command)\n        #[arg(long)]\n        command: Option\u003cString\u003e,\n\n        /// Arguments for command (comma-separated)\n        #[arg(long)]\n        args: Option\u003cString\u003e,\n\n        /// Working directory\n        #[arg(long)]\n        working_directory: Option\u003cString\u003e,\n\n        /// Environment variables (KEY=VALUE, comma-separated)\n        #[arg(long)]\n        environment: Option\u003cString\u003e,\n\n        /// Timeout in seconds\n        #[arg(long)]\n        timeout_seconds: Option\u003cu64\u003e,\n\n        /// Message (for notification action)\n        #[arg(long)]\n        message: Option\u003cString\u003e,\n\n        /// Entity ID (for update_entity action)\n        #[arg(long)]\n        entity_id: Option\u003cString\u003e,\n\n        /// Entity type (for update_entity action)\n        #[arg(long)]\n        entity_type: Option\u003cString\u003e,\n    },\n    /// Query available actions, guards, and checks for a workflow\n    QueryActions {\n        /// Workflow ID\n        #[arg(help = \"Workflow ID\")]\n        workflow_id: String,\n\n        /// State ID filter (optional)\n        #[arg(long)]\n        state_id: Option\u003cString\u003e,\n    },\n}\n\n/// Create a new workflow\npub fn create_workflow\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    title: String,\n    description: String,\n    entity_types: Option\u003cString\u003e,\n    agent: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut workflow = Workflow::new(\n        title,\n        description,\n        agent.unwrap_or_else(|| \"cli\".to_string()),\n    );\n\n    if let Some(entity_types_str) = entity_types {\n        let types: Vec\u003cString\u003e = entity_types_str\n            .split(',')\n            .map(|s| s.trim().to_string())\n            .filter(|s| !s.is_empty())\n            .collect();\n        workflow.entity_types = types;\n    }\n\n    let generic = workflow.to_generic();\n    storage.store(\u0026generic)?;\n\n    println!(\"‚úÖ Workflow created: {}\", workflow.id());\n    display_workflow(\u0026workflow);\n\n    Ok(())\n}\n\n/// Get workflow details\npub fn get_workflow\u003cS: Storage\u003e(storage: \u0026S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"workflow\")? {\n        let workflow =\n            Workflow::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        display_workflow(\u0026workflow);\n    } else {\n        println!(\"‚ùå Workflow not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Update workflow\npub fn update_workflow\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    title: Option\u003cString\u003e,\n    description: Option\u003cString\u003e,\n    status: Option\u003cString\u003e,\n    entity_types: Option\u003cString\u003e,\n    initial_state: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"workflow\")? {\n        let mut workflow =\n            Workflow::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        let mut updated = false;\n\n        if let Some(title) = title {\n            workflow.title = title;\n            updated = true;\n        }\n\n        if let Some(description) = description {\n            workflow.description = description;\n            updated = true;\n        }\n\n        if let Some(status_str) = status {\n            let new_status = match status_str.to_lowercase().as_str() {\n                \"active\" =\u003e WorkflowStatus::Active,\n                \"inactive\" =\u003e WorkflowStatus::Inactive,\n                \"draft\" =\u003e WorkflowStatus::Draft,\n                \"archived\" =\u003e WorkflowStatus::Archived,\n                _ =\u003e {\n                    println!(\"‚ùå Invalid status. Use: active, inactive, draft, archived\");\n                    return Ok(());\n                }\n            };\n            workflow.status = new_status;\n            updated = true;\n        }\n\n        if let Some(entity_types_str) = entity_types {\n            let types: Vec\u003cString\u003e = entity_types_str\n                .split(',')\n                .map(|s| s.trim().to_string())\n                .filter(|s| !s.is_empty())\n                .collect();\n            workflow.entity_types = types;\n            updated = true;\n        }\n\n        if let Some(initial_state_id) = initial_state {\n            workflow.set_initial_state(initial_state_id);\n            updated = true;\n        }\n\n        if !updated {\n            println!(\"No updates specified\");\n            return Ok(());\n        }\n\n        workflow.updated_at = chrono::Utc::now();\n        let updated_generic = workflow.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\"‚úÖ Workflow updated: {}\", id);\n    } else {\n        println!(\"‚ùå Workflow not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Delete workflow\npub fn delete_workflow\u003cS: Storage\u003e(storage: \u0026mut S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"workflow\")? {\n        let mut workflow =\n            Workflow::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        workflow.status = WorkflowStatus::Archived;\n        workflow.updated_at = chrono::Utc::now();\n        let updated_generic = workflow.to_generic();\n        storage.store(\u0026updated_generic)?;\n        println!(\"‚úÖ Workflow deleted (archived): {}\", id);\n    } else {\n        println!(\"‚ùå Workflow not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// List workflows\npub fn list_workflows\u003cS: Storage\u003e(\n    storage: \u0026S,\n    status: Option\u003cString\u003e,\n    search: Option\u003cString\u003e,\n    limit: usize,\n    offset: usize,\n) -\u003e Result\u003c(), EngramError\u003e {\n    use crate::storage::QueryFilter;\n    use serde_json::Value;\n    use std::collections::HashMap;\n\n    let mut filter = QueryFilter {\n        entity_type: Some(\"workflow\".to_string()),\n        text_search: search,\n        limit: Some(limit),\n        offset: Some(offset),\n        ..Default::default()\n    };\n\n    let mut field_filters = HashMap::new();\n\n    if let Some(status_filter) = status {\n        field_filters.insert(\"status\".to_string(), Value::String(status_filter));\n    }\n\n    if !field_filters.is_empty() {\n        filter.field_filters = field_filters;\n    }\n\n    let result = storage.query(\u0026filter)?;\n\n    println!(\"üìã Workflows List\");\n    println!(\"=================\");\n\n    if result.entities.is_empty() {\n        println!(\"No workflows found matching the criteria.\");\n        return Ok(());\n    }\n\n    println!(\n        \"Found {} workflows (showing {} to {} of {})\",\n        result.total_count,\n        offset + 1,\n        offset + result.entities.len(),\n        result.total_count\n    );\n    println!();\n\n    for (i, entity) in result.entities.iter().enumerate() {\n        let workflow_data = \u0026entity.data;\n        let index = offset + i + 1;\n\n        let name = workflow_data\n            .get(\"name\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"Unnamed Workflow\");\n\n        let status = workflow_data\n            .get(\"status\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"draft\");\n\n        let current_state = workflow_data\n            .get(\"current_state\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"none\");\n\n        let status_symbol = match status {\n            \"active\" =\u003e \"üü¢\",\n            \"draft\" =\u003e \"üü°\",\n            \"archived\" =\u003e \"üóÑÔ∏è\",\n            \"paused\" =\u003e \"‚è∏Ô∏è\",\n            _ =\u003e \"‚ö™\",\n        };\n\n        println!(\n            \"{}. {} {} [{}]\",\n            index,\n            status_symbol,\n            name,\n            status.to_uppercase()\n        );\n\n        println!(\"   ID: {}\", entity.id);\n\n        if let Some(description) = workflow_data.get(\"description\").and_then(|v| v.as_str()) {\n            let truncated = if description.len() \u003e 80 {\n                format!(\"{}...\", \u0026description[..77])\n            } else {\n                description.to_string()\n            };\n            println!(\"   üìÑ {}\", truncated);\n        }\n\n        println!(\"   üîÑ Current State: {}\", current_state);\n\n        if let Some(states) = workflow_data.get(\"states\").and_then(|v| v.as_array()) {\n            println!(\"   üìä {} states defined\", states.len());\n        }\n\n        if let Some(transitions) = workflow_data.get(\"transitions\").and_then(|v| v.as_array()) {\n            println!(\"   üîÄ {} transitions configured\", transitions.len());\n        }\n\n        println!(\n            \"   üë§ Agent: {} | üìÖ {}\",\n            entity.agent,\n            entity.timestamp.format(\"%Y-%m-%d %H:%M\")\n        );\n\n        println!();\n    }\n\n    if result.has_more {\n        println!(\"üí° Use --offset {} to see more workflows\", offset + limit);\n    }\n\n    println!(\"üí° Use 'engram workflow get \u003cid\u003e' to view full workflow details\");\n    println!(\"üí° Use 'engram workflow add-state \u003cid\u003e' to add states\");\n    println!(\"üí° Use 'engram workflow add-transition \u003cid\u003e' to add transitions\");\n\n    Ok(())\n}\n\n/// Add state to workflow\npub fn add_state\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    name: String,\n    state_type: String,\n    description: String,\n    is_final: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"workflow\")? {\n        let mut workflow =\n            Workflow::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        let state_type = match state_type.to_lowercase().as_str() {\n            \"start\" =\u003e StateType::Start,\n            \"in_progress\" =\u003e StateType::InProgress,\n            \"review\" =\u003e StateType::Review,\n            \"done\" =\u003e StateType::Done,\n            \"blocked\" =\u003e StateType::Blocked,\n            _ =\u003e {\n                println!(\"‚ùå Invalid state type. Use: start, in_progress, review, done, blocked\");\n                return Ok(());\n            }\n        };\n\n        let state = WorkflowState {\n            id: Uuid::new_v4().to_string(),\n            name: name.clone(),\n            state_type,\n            description,\n            is_final,\n            guards: Vec::new(),\n            post_functions: Vec::new(),\n            prompts: None,\n        };\n\n        let state_id = state.id.clone();\n        workflow.add_state(state);\n\n        if is_final {\n            workflow.add_final_state(state_id.clone());\n        }\n\n        if workflow.initial_state.is_empty() {\n            workflow.set_initial_state(state_id.clone());\n        }\n\n        let updated_generic = workflow.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\"‚úÖ State added to workflow {}: {} ({})\", id, name, state_id);\n    } else {\n        println!(\"‚ùå Workflow not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Add transition to workflow\npub fn add_transition\u003cS: Storage\u003e(\n    storage: \u0026mut S,\n    id: \u0026str,\n    name: String,\n    from_state: String,\n    to_state: String,\n    transition_type: String,\n    description: String,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"workflow\")? {\n        let mut workflow =\n            Workflow::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        let transition_type = match transition_type.to_lowercase().as_str() {\n            \"automatic\" =\u003e TransitionType::Automatic,\n            \"manual\" =\u003e TransitionType::Manual,\n            \"conditional\" =\u003e TransitionType::Conditional,\n            \"scheduled\" =\u003e TransitionType::Scheduled,\n            _ =\u003e {\n                println!(\n                    \"‚ùå Invalid transition type. Use: automatic, manual, conditional, scheduled\"\n                );\n                return Ok(());\n            }\n        };\n\n        let transition = WorkflowTransition {\n            id: Uuid::new_v4().to_string(),\n            name: name.clone(),\n            from_state,\n            to_state,\n            transition_type,\n            description,\n            conditions: Vec::new(),\n            actions: Vec::new(),\n        };\n\n        let transition_id = transition.id.clone();\n        workflow.add_transition(transition);\n\n        let updated_generic = workflow.to_generic();\n        storage.store(\u0026updated_generic)?;\n\n        println!(\n            \"‚úÖ Transition added to workflow {}: {} ({})\",\n            id, name, transition_id\n        );\n    } else {\n        println!(\"‚ùå Workflow not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Activate workflow\npub fn activate_workflow\u003cS: Storage\u003e(storage: \u0026mut S, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(id, \"workflow\")? {\n        let mut workflow =\n            Workflow::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n        workflow.activate();\n        let updated_generic = workflow.to_generic();\n        storage.store(\u0026updated_generic)?;\n        println!(\"‚úÖ Workflow activated: {}\", id);\n    } else {\n        println!(\"‚ùå Workflow not found: {}\", id);\n    }\n    Ok(())\n}\n\n/// Display workflow information\nfn display_workflow(workflow: \u0026Workflow) {\n    println!(\"üìã Workflow: {}\", workflow.id());\n    println!(\"üìù Title: {}\", workflow.title);\n    println!(\"üìÑ Description: {}\", workflow.description);\n    println!(\"üìä Status: {:?}\", workflow.status);\n    println!(\"ü§ñ Agent: {}\", workflow.agent);\n    println!(\n        \"üïê Created: {}\",\n        workflow.created_at.format(\"%Y-%m-%d %H:%M\")\n    );\n    println!(\n        \"üîÑ Updated: {}\",\n        workflow.updated_at.format(\"%Y-%m-%d %H:%M\")\n    );\n\n    if !workflow.initial_state.is_empty() {\n        println!(\"üöÄ Initial State: {}\", workflow.initial_state);\n    }\n\n    if !workflow.final_states.is_empty() {\n        println!(\"üéØ Final States: {:?}\", workflow.final_states);\n    }\n\n    if !workflow.entity_types.is_empty() {\n        println!(\"üè∑Ô∏è Entity Types: {:?}\", workflow.entity_types);\n    }\n\n    if !workflow.states.is_empty() {\n        println!(\"üìã States: {}\", workflow.states.len());\n        for (i, state) in workflow.states.iter().enumerate() {\n            println!(\n                \"  {}. {} ({:?}) - {}\",\n                i + 1,\n                state.name,\n                state.state_type,\n                if state.is_final { \"Final\" } else { \"Not Final\" }\n            );\n        }\n    }\n\n    if !workflow.transitions.is_empty() {\n        println!(\"üîÑ Transitions: {}\", workflow.transitions.len());\n        for (i, transition) in workflow.transitions.iter().enumerate() {\n            println!(\n                \"  {}. {} ({:?}): {} -\u003e {}\",\n                i + 1,\n                transition.name,\n                transition.transition_type,\n                transition.from_state,\n                transition.to_state\n            );\n        }\n    }\n}\n\n/// Start a workflow instance using the automation engine\npub fn start_workflow_instance\u003cS: Storage + 'static\u003e(\n    storage: S,\n    workflow_id: String,\n    entity_id: Option\u003cString\u003e,\n    entity_type: Option\u003cString\u003e,\n    agent: String,\n    variables: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut engine = WorkflowAutomationEngine::new(storage);\n\n    let mut initial_variables = HashMap::new();\n    if let Some(vars_str) = variables {\n        for pair in vars_str.split(',') {\n            if let Some((key, value)) = pair.split_once('=') {\n                initial_variables.insert(\n                    key.trim().to_string(),\n                    RuleValue::String(value.trim().to_string()),\n                );\n            }\n        }\n    }\n\n    let result = engine.start_workflow(\n        workflow_id.clone(),\n        entity_id,\n        entity_type,\n        agent,\n        initial_variables,\n    )?;\n\n    if result.success {\n        println!(\"‚úÖ Workflow instance started successfully!\");\n        println!(\"üìã Instance ID: {}\", result.instance_id);\n        println!(\"üîÑ Current State: {}\", result.current_state);\n        println!(\"üí¨ Message: {}\", result.message);\n\n        if !result.events.is_empty() {\n            println!(\"üìö Events:\");\n            for event in \u0026result.events {\n                println!(\n                    \"  ‚Ä¢ {} - {} at {}\",\n                    match event.event_type {\n                        crate::engines::workflow_engine::WorkflowEventType::Started =\u003e \"üöÄ Started\",\n                        crate::engines::workflow_engine::WorkflowEventType::Transitioned =\u003e\n                            \"üîÑ Transitioned\",\n                        _ =\u003e \"üìù Event\",\n                    },\n                    event.message,\n                    event.timestamp.format(\"%H:%M:%S\")\n                );\n            }\n        }\n    } else {\n        println!(\"‚ùå Failed to start workflow instance\");\n        println!(\"üí¨ Message: {}\", result.message);\n    }\n\n    Ok(())\n}\n\n/// Execute a transition in a workflow instance\npub fn execute_workflow_transition\u003cS: Storage + 'static\u003e(\n    storage: S,\n    instance_id: String,\n    transition: String,\n    agent: String,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut engine = WorkflowAutomationEngine::new(storage);\n\n    let result = engine.execute_transition(\u0026instance_id, transition, agent)?;\n\n    if result.success {\n        println!(\"‚úÖ Transition executed successfully!\");\n        println!(\"üìã Instance ID: {}\", result.instance_id);\n        println!(\"üîÑ Current State: {}\", result.current_state);\n        println!(\"üí¨ Message: {}\", result.message);\n\n        if !result.events.is_empty() {\n            println!(\"üìö Events:\");\n            for event in \u0026result.events {\n                println!(\n                    \"  ‚Ä¢ {} - {} at {}\",\n                    match event.event_type {\n                        crate::engines::workflow_engine::WorkflowEventType::Transitioned =\u003e\n                            \"üîÑ Transitioned\",\n                        crate::engines::workflow_engine::WorkflowEventType::ActionExecuted =\u003e\n                            \"‚ö° Action Executed\",\n                        _ =\u003e \"üìù Event\",\n                    },\n                    event.message,\n                    event.timestamp.format(\"%H:%M:%S\")\n                );\n            }\n        }\n    } else {\n        println!(\"‚ùå Failed to execute transition\");\n        println!(\"üí¨ Message: {}\", result.message);\n    }\n\n    Ok(())\n}\n\n/// Get workflow instance status\npub fn get_workflow_instance_status\u003cS: Storage + 'static\u003e(\n    storage: S,\n    instance_id: String,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let engine = WorkflowAutomationEngine::new(storage);\n\n    match engine.get_instance_status(\u0026instance_id) {\n        Ok(instance) =\u003e {\n            println!(\"üìã Workflow Instance: {}\", instance.id);\n            println!(\"üîó Workflow ID: {}\", instance.workflow_id);\n            println!(\"üîÑ Current State: {}\", instance.current_state);\n            println!(\"üìä Status: {}\", instance.status);\n            println!(\n                \"üïê Started: {}\",\n                instance.started_at.format(\"%Y-%m-%d %H:%M:%S\")\n            );\n            println!(\n                \"üîÑ Updated: {}\",\n                instance.updated_at.format(\"%Y-%m-%d %H:%M:%S\")\n            );\n\n            if let Some(completed) = instance.completed_at {\n                println!(\"üéØ Completed: {}\", completed.format(\"%Y-%m-%d %H:%M:%S\"));\n            }\n\n            println!(\"üë§ Executing Agent: {}\", instance.context.executing_agent);\n\n            if let Some(entity_id) = \u0026instance.context.entity_id {\n                println!(\"üè∑Ô∏è Associated Entity: {}\", entity_id);\n                if let Some(entity_type) = \u0026instance.context.entity_type {\n                    println!(\"üì¶ Entity Type: {}\", entity_type);\n                }\n            }\n\n            if !instance.context.variables.is_empty() {\n                println!(\"üìã Variables:\");\n                for (key, value) in \u0026instance.context.variables {\n                    println!(\"  ‚Ä¢ {} = {:?}\", key, value);\n                }\n            }\n\n            if !instance.execution_history.is_empty() {\n                println!(\n                    \"üìö Execution History ({} events):\",\n                    instance.execution_history.len()\n                );\n                for (i, event) in instance.execution_history.iter().rev().take(5).enumerate() {\n                    let event_icon = match event.event_type {\n                        crate::engines::workflow_engine::WorkflowEventType::Started =\u003e \"üöÄ\",\n                        crate::engines::workflow_engine::WorkflowEventType::Transitioned =\u003e \"üîÑ\",\n                        crate::engines::workflow_engine::WorkflowEventType::ActionExecuted =\u003e \"‚ö°\",\n                        crate::engines::workflow_engine::WorkflowEventType::Completed =\u003e \"üéØ\",\n                        crate::engines::workflow_engine::WorkflowEventType::Cancelled =\u003e \"‚ùå\",\n                        crate::engines::workflow_engine::WorkflowEventType::Failed =\u003e \"üí•\",\n                        _ =\u003e \"üìù\",\n                    };\n\n                    println!(\n                        \"  {}. {} {} - {} ({})\",\n                        i + 1,\n                        event_icon,\n                        event.timestamp.format(\"%H:%M:%S\"),\n                        event.message,\n                        event.agent\n                    );\n                }\n\n                if instance.execution_history.len() \u003e 5 {\n                    println!(\n                        \"    ... and {} more events\",\n                        instance.execution_history.len() - 5\n                    );\n                }\n            }\n        }\n        Err(e) =\u003e {\n            println!(\"‚ùå Workflow instance not found: {}\", instance_id);\n            return Err(e);\n        }\n    }\n\n    Ok(())\n}\n\n/// List active workflow instances\npub fn list_workflow_instances\u003cS: Storage + 'static\u003e(\n    storage: S,\n    workflow_id: Option\u003cString\u003e,\n    agent: Option\u003cString\u003e,\n    running_only: bool,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let engine = WorkflowAutomationEngine::new(storage);\n    let instances = engine.list_active_instances();\n\n    let filtered_instances: Vec\u003c_\u003e = instances\n        .into_iter()\n        .filter(|instance| {\n            if running_only\n                \u0026\u0026 instance.status != crate::engines::workflow_engine::WorkflowStatus::Running\n            {\n                return false;\n            }\n            if let Some(ref wf_id) = workflow_id {\n                if \u0026instance.workflow_id != wf_id {\n                    return false;\n                }\n            }\n            if let Some(ref ag) = agent {\n                if \u0026instance.context.executing_agent != ag {\n                    return false;\n                }\n            }\n            true\n        })\n        .collect();\n\n    println!(\"üìã Workflow Instances\");\n    println!(\"====================\");\n\n    if filtered_instances.is_empty() {\n        println!(\"No workflow instances found matching the criteria.\");\n        return Ok(());\n    }\n\n    println!(\"Found {} workflow instances:\", filtered_instances.len());\n    println!();\n\n    for (i, instance) in filtered_instances.iter().enumerate() {\n        let status_icon = match instance.status {\n            crate::engines::workflow_engine::WorkflowStatus::Running =\u003e \"üü¢\",\n            crate::engines::workflow_engine::WorkflowStatus::Completed =\u003e \"üéØ\",\n            crate::engines::workflow_engine::WorkflowStatus::Failed(_) =\u003e \"üí•\",\n            crate::engines::workflow_engine::WorkflowStatus::Suspended(_) =\u003e \"‚è∏Ô∏è\",\n            crate::engines::workflow_engine::WorkflowStatus::Cancelled =\u003e \"‚ùå\",\n        };\n\n        println!(\n            \"{}. {} Instance: {} [{}]\",\n            i + 1,\n            status_icon,\n            instance.id,\n            instance.status\n        );\n\n        println!(\"   üîó Workflow: {}\", instance.workflow_id);\n        println!(\"   üîÑ Current State: {}\", instance.current_state);\n        println!(\"   üë§ Agent: {}\", instance.context.executing_agent);\n\n        if let Some(entity_id) = \u0026instance.context.entity_id {\n            println!(\"   üè∑Ô∏è Entity: {}\", entity_id);\n        }\n\n        println!(\n            \"   üïê Started: {} | üîÑ Updated: {}\",\n            instance.started_at.format(\"%Y-%m-%d %H:%M\"),\n            instance.updated_at.format(\"%Y-%m-%d %H:%M\")\n        );\n\n        if let Some(completed) = instance.completed_at {\n            println!(\"   üéØ Completed: {}\", completed.format(\"%Y-%m-%d %H:%M\"));\n        }\n\n        println!();\n    }\n\n    println!(\"üí° Use 'engram workflow status \u003cinstance-id\u003e' to view instance details\");\n    println!(\"üí° Use 'engram workflow transition \u003cinstance-id\u003e --transition \u003cname\u003e' to execute transitions\");\n\n    Ok(())\n}\n\n/// Cancel a workflow instance\npub fn cancel_workflow_instance\u003cS: Storage + 'static\u003e(\n    storage: S,\n    instance_id: String,\n    agent: String,\n    reason: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    let mut engine = WorkflowAutomationEngine::new(storage);\n\n    let reason = reason.unwrap_or_else(|| \"Cancelled by user\".to_string());\n    let result = engine.cancel_workflow(\u0026instance_id, agent, reason)?;\n\n    if result.success {\n        println!(\"‚úÖ Workflow instance cancelled successfully!\");\n        println!(\"üìã Instance ID: {}\", result.instance_id);\n        println!(\"üîÑ Final State: {}\", result.current_state);\n        println!(\"üí¨ Message: {}\", result.message);\n\n        if !result.events.is_empty() {\n            println!(\"üìö Events:\");\n            for event in \u0026result.events {\n                println!(\n                    \"  ‚Ä¢ {} - {} at {}\",\n                    match event.event_type {\n                        crate::engines::workflow_engine::WorkflowEventType::Cancelled =\u003e\n                            \"‚ùå Cancelled\",\n                        _ =\u003e \"üìù Event\",\n                    },\n                    event.message,\n                    event.timestamp.format(\"%H:%M:%S\")\n                );\n            }\n        }\n    } else {\n        println!(\"‚ùå Failed to cancel workflow instance\");\n        println!(\"üí¨ Message: {}\", result.message);\n    }\n\n    Ok(())\n}\n\n/// Execute an action (external command, notification, etc.)\npub fn execute_action\u003cS: Storage + 'static\u003e(\n    storage: S,\n    action_type: String,\n    command: Option\u003cString\u003e,\n    args: Option\u003cString\u003e,\n    working_directory: Option\u003cString\u003e,\n    environment: Option\u003cString\u003e,\n    timeout_seconds: Option\u003cu64\u003e,\n    message: Option\u003cString\u003e,\n    entity_id: Option\u003cString\u003e,\n    entity_type: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    use crate::engines::ActionExecutor;\n    let mut parameters = HashMap::new();\n\n    match action_type.as_str() {\n        \"external_command\" =\u003e {\n            if let Some(cmd) = command {\n                parameters.insert(\"command\".to_string(), serde_json::json!(cmd));\n            } else {\n                return Err(EngramError::Validation(\n                    \"Command is required for external_command action type\".to_string(),\n                ));\n            }\n\n            if let Some(args_str) = args {\n                let args_vec: Vec\u003cString\u003e = args_str\n                    .split(',')\n                    .map(|s| s.trim().to_string())\n                    .filter(|s| !s.is_empty())\n                    .collect();\n                parameters.insert(\"args\".to_string(), serde_json::json!(args_vec));\n            }\n\n            if let Some(wd) = working_directory {\n                parameters.insert(\"working_directory\".to_string(), serde_json::json!(wd));\n            }\n\n            if let Some(env_str) = environment {\n                let mut env_map: HashMap\u003cString, String\u003e = HashMap::new();\n                for pair in env_str.split(',') {\n                    if let Some((key, value)) = pair.split_once('=') {\n                        env_map.insert(key.trim().to_string(), value.trim().to_string());\n                    }\n                }\n                parameters.insert(\"environment\".to_string(), serde_json::json!(env_map));\n            }\n\n            if let Some(timeout) = timeout_seconds {\n                parameters.insert(\"timeout_seconds\".to_string(), serde_json::json!(timeout));\n            }\n\n            parameters.insert(\"capture_output\".to_string(), serde_json::json!(true));\n        }\n        \"notification\" =\u003e {\n            if let Some(msg) = message {\n                parameters.insert(\"message\".to_string(), serde_json::json!(msg));\n            } else {\n                return Err(EngramError::Validation(\n                    \"Message is required for notification action type\".to_string(),\n                ));\n            }\n        }\n        \"update_entity\" =\u003e {\n            if let Some(id) = entity_id {\n                parameters.insert(\"entity_id\".to_string(), serde_json::json!(id));\n            } else {\n                return Err(EngramError::Validation(\n                    \"Entity ID is required for update_entity action type\".to_string(),\n                ));\n            }\n\n            if let Some(etype) = entity_type {\n                parameters.insert(\"entity_type\".to_string(), serde_json::json!(etype));\n            } else {\n                return Err(EngramError::Validation(\n                    \"Entity type is required for update_entity action type\".to_string(),\n                ));\n            }\n        }\n        _ =\u003e {\n            return Err(EngramError::Validation(format!(\n                \"Unknown action type: {}. Supported: external_command, notification, update_entity\",\n                action_type\n            )));\n        }\n    }\n\n    // Execute the action\n    let executor = ActionExecutor::new(true); // Allow external commands\n    let result = executor.execute_action(\u0026action_type, \u0026parameters)?;\n\n    if result.success {\n        println!(\"‚úÖ Action executed successfully!\");\n        println!(\"üí¨ Message: {}\", result.message);\n\n        if let Some(output) = result.output {\n            println!(\"üìÑ Output:\");\n            println!(\"{}\", output);\n        }\n\n        if let Some(exit_code) = result.exit_code {\n            println!(\"üî¢ Exit Code: {}\", exit_code);\n        }\n    } else {\n        println!(\"‚ùå Action execution failed\");\n        println!(\"üí¨ Message: {}\", result.message);\n\n        if let Some(error) = result.error {\n            println!(\"‚ö†Ô∏è  Error:\");\n            println!(\"{}\", error);\n        }\n\n        if let Some(exit_code) = result.exit_code {\n            println!(\"üî¢ Exit Code: {}\", exit_code);\n        }\n    }\n\n    Ok(())\n}\n\n/// Query available actions, guards, and checks for a workflow\npub fn query_workflow_actions\u003cS: Storage\u003e(\n    storage: \u0026S,\n    workflow_id: String,\n    state_id: Option\u003cString\u003e,\n) -\u003e Result\u003c(), EngramError\u003e {\n    if let Some(generic) = storage.get(\u0026workflow_id, \"workflow\")? {\n        let workflow =\n            Workflow::from_generic(generic).map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        println!(\"üìã Workflow: {} ({})\", workflow.title, workflow.id);\n        println!();\n\n        // Filter states if state_id is provided\n        let states_to_show: Vec\u003c\u0026WorkflowState\u003e = if let Some(ref sid) = state_id {\n            workflow.states.iter().filter(|s| \u0026s.id == sid).collect()\n        } else {\n            workflow.states.iter().collect()\n        };\n\n        if states_to_show.is_empty() {\n            if state_id.is_some() {\n                println!(\"‚ùå State not found in workflow\");\n            } else {\n                println!(\"‚ÑπÔ∏è  No states defined in workflow\");\n            }\n            return Ok(());\n        }\n\n        for state in states_to_show {\n            println!(\"üî∑ State: {} ({})\", state.name, state.id);\n            println!(\"   Type: {:?}\", state.state_type);\n\n            // Show guards\n            if !state.guards.is_empty() {\n                println!(\"   üõ°Ô∏è  Guards ({}):\", state.guards.len());\n                for guard in \u0026state.guards {\n                    println!(\"      ‚Ä¢ {} ({})\", guard.guard_type, guard.id);\n                    if !guard.error_message.is_empty() {\n                        println!(\"        Error: {}\", guard.error_message);\n                    }\n                }\n            }\n\n            // Show post-functions\n            if !state.post_functions.is_empty() {\n                println!(\"   ‚öôÔ∏è  Post-Functions ({}):\", state.post_functions.len());\n                for func in \u0026state.post_functions {\n                    println!(\n                        \"      ‚Ä¢ {} - {} ({})\",\n                        func.name, func.function_type, func.id\n                    );\n                }\n            }\n\n            println!();\n        }\n\n        // Show transitions\n        let transitions_to_show: Vec\u003c\u0026WorkflowTransition\u003e = if let Some(ref sid) = state_id {\n            workflow\n                .transitions\n                .iter()\n                .filter(|t| \u0026t.from_state == sid)\n                .collect()\n        } else {\n            workflow.transitions.iter().collect()\n        };\n\n        if !transitions_to_show.is_empty() {\n            println!(\"üîÑ Transitions ({}):\", transitions_to_show.len());\n            for transition in transitions_to_show {\n                println!(\n                    \"   ‚Ä¢ {} ({} ‚Üí {})\",\n                    transition.name, transition.from_state, transition.to_state\n                );\n                println!(\"     Type: {:?}\", transition.transition_type);\n\n                // Show conditions\n                if !transition.conditions.is_empty() {\n                    println!(\"     üìã Conditions ({}):\", transition.conditions.len());\n                    for condition in \u0026transition.conditions {\n                        println!(\"        ‚Ä¢ {} ({})\", condition.condition_type, condition.id);\n                    }\n                }\n\n                // Show actions\n                if !transition.actions.is_empty() {\n                    println!(\"     ‚ö° Actions ({}):\", transition.actions.len());\n                    for action in \u0026transition.actions {\n                        println!(\n                            \"        ‚Ä¢ {} - {} ({})\",\n                            action.name, action.action_type, action.id\n                        );\n\n                        // Show some action details\n                        if action.action_type == \"external_command\" {\n                            if let Some(cmd) = action.parameters.get(\"command\") {\n                                println!(\"          Command: {}\", cmd);\n                            }\n                        }\n                    }\n                }\n\n                println!();\n            }\n        }\n\n        println!(\n            \"üí° Use 'engram workflow execute-action --action-type \u003ctype\u003e ...' to test actions\"\n        );\n    } else {\n        println!(\"‚ùå Workflow not found: {}\", workflow_id);\n    }\n\n    Ok(())\n}\n","traces":[{"line":264,"address":[15141586,15142198,15140848],"length":1,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[15142240,15142265,15141367],"length":1,"stats":{"Line":0}},{"line":283,"address":[15141397],"length":1,"stats":{"Line":0}},{"line":286,"address":[15141223],"length":1,"stats":{"Line":0}},{"line":287,"address":[15141597,15141665],"length":1,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[15141958],"length":1,"stats":{"Line":0}},{"line":292,"address":[15141979],"length":1,"stats":{"Line":0}},{"line":296,"address":[15120192,15120904,15120910],"length":1,"stats":{"Line":0}},{"line":297,"address":[15120227],"length":1,"stats":{"Line":0}},{"line":298,"address":[15120683,15120465,15120962,15120944],"length":1,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[15120571],"length":1,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[15145913,15148137,15143760],"length":1,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[15147034,15148320,15148338,15144396,15144477],"length":1,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[15144683],"length":1,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[15144824,15144759],"length":1,"stats":{"Line":0}},{"line":325,"address":[15144944],"length":1,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[15145015,15145083],"length":1,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[15145042,15145227],"length":1,"stats":{"Line":0}},{"line":334,"address":[15145386,15145266,15145481],"length":1,"stats":{"Line":0}},{"line":335,"address":[15145497,15145563],"length":1,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[15145652,15145724,15145692],"length":1,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[15145966],"length":1,"stats":{"Line":0}},{"line":351,"address":[15148229,15146121,15148176],"length":1,"stats":{"Line":0}},{"line":352,"address":[15146144,15148272,15148297],"length":1,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[15146366],"length":1,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[15146415,15146460],"length":1,"stats":{"Line":0}},{"line":365,"address":[15146484],"length":1,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[15146918],"length":1,"stats":{"Line":0}},{"line":380,"address":[15143594,15143600,15142432],"length":1,"stats":{"Line":0}},{"line":381,"address":[15142472],"length":1,"stats":{"Line":0}},{"line":382,"address":[15143634,15142928,15142710,15143616],"length":1,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[15143263,15143192],"length":1,"stats":{"Line":0}},{"line":388,"address":[15143405],"length":1,"stats":{"Line":0}},{"line":390,"address":[15142816],"length":1,"stats":{"Line":0}},{"line":392,"address":[15143539],"length":1,"stats":{"Line":0}},{"line":396,"address":[15140617,15134304,15135454],"length":1,"stats":{"Line":0}},{"line":408,"address":[15134439,15134519],"length":1,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[15135261,15135160],"length":1,"stats":{"Line":0}},{"line":421,"address":[15135698,15135191,15135489],"length":1,"stats":{"Line":0}},{"line":422,"address":[15135605,15135495],"length":1,"stats":{"Line":0}},{"line":425,"address":[15135578,15140453,15135703],"length":1,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[15140415],"length":1,"stats":{"Line":0}},{"line":435,"address":[15136189,15136252,15136378],"length":1,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[15136597],"length":1,"stats":{"Line":0}},{"line":444,"address":[15136650],"length":1,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[15138024],"length":1,"stats":{"Line":0}},{"line":460,"address":[15140720,15140729,15137914],"length":1,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[15138040,15138112],"length":1,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[15138170,15138229,15138274],"length":1,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[15138385],"length":1,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[15140761,15138868,15140752],"length":1,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[15139200,15139117],"length":1,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[15139400,15139160],"length":1,"stats":{"Line":0}},{"line":490,"address":[15139491,15139037],"length":1,"stats":{"Line":0}},{"line":492,"address":[15140784,15140793,15139568],"length":1,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[15140816,15140825,15139852,15139697],"length":1,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[15139948,15140120],"length":1,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[15137008],"length":1,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[15174432,15171152,15174093],"length":1,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[15172283,15172322,15172243],"length":1,"stats":{"Line":0}},{"line":536,"address":[15172299,15172339,15172378],"length":1,"stats":{"Line":0}},{"line":537,"address":[15172434,15172355,15172395],"length":1,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[15172517],"length":1,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[15172756],"length":1,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[15173192],"length":1,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[15173425],"length":1,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[15174145,15171745],"length":1,"stats":{"Line":0}},{"line":574,"address":[15173997],"length":1,"stats":{"Line":0}},{"line":578,"address":[15121088,15123897,15124519],"length":1,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[15124544,15124562,15121681,15123985,15121762],"length":1,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[15122155,15121989,15122060],"length":1,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[15122270,15122310,15122349],"length":1,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[15122429],"length":1,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[15123267],"length":1,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[15123517],"length":1,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[15123987,15121716],"length":1,"stats":{"Line":0}},{"line":628,"address":[15123801],"length":1,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[15148504],"length":1,"stats":{"Line":0}},{"line":634,"address":[15148960,15149616,15149634,15148742],"length":1,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[15149396],"length":1,"stats":{"Line":0}},{"line":641,"address":[15148848],"length":1,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[19143090,19140000,19143084],"length":1,"stats":{"Line":0}},{"line":648,"address":[20570023],"length":1,"stats":{"Line":0}},{"line":649,"address":[19080918],"length":1,"stats":{"Line":0}},{"line":650,"address":[19081028],"length":1,"stats":{"Line":0}},{"line":651,"address":[19140369],"length":1,"stats":{"Line":0}},{"line":652,"address":[19151997],"length":1,"stats":{"Line":0}},{"line":653,"address":[18930074],"length":1,"stats":{"Line":0}},{"line":657,"address":[18010417],"length":1,"stats":{"Line":0}},{"line":662,"address":[25811091],"length":1,"stats":{"Line":0}},{"line":663,"address":[19986342],"length":1,"stats":{"Line":0}},{"line":666,"address":[25811227],"length":1,"stats":{"Line":0}},{"line":667,"address":[19152676],"length":1,"stats":{"Line":0}},{"line":670,"address":[19082020],"length":1,"stats":{"Line":0}},{"line":671,"address":[25811389],"length":1,"stats":{"Line":0}},{"line":674,"address":[19082157],"length":1,"stats":{"Line":0}},{"line":675,"address":[25811527],"length":1,"stats":{"Line":0}},{"line":676,"address":[25811666,25811808],"length":1,"stats":{"Line":0}},{"line":677,"address":[18011546,18011429],"length":1,"stats":{"Line":0}},{"line":687,"address":[19141689],"length":1,"stats":{"Line":0}},{"line":688,"address":[18931786],"length":1,"stats":{"Line":0}},{"line":689,"address":[18932044,18931925],"length":1,"stats":{"Line":0}},{"line":690,"address":[19083429],"length":1,"stats":{"Line":0}},{"line":703,"address":[15159712,15160898,15162891],"length":1,"stats":{"Line":0}},{"line":711,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":714,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[15160207,15160094],"length":1,"stats":{"Line":0}},{"line":716,"address":[],"length":0,"stats":{"Line":0}},{"line":717,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[15160604],"length":1,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":725,"address":[],"length":0,"stats":{"Line":0}},{"line":726,"address":[15160125],"length":1,"stats":{"Line":0}},{"line":727,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[15160959],"length":1,"stats":{"Line":0}},{"line":729,"address":[15160990],"length":1,"stats":{"Line":0}},{"line":730,"address":[],"length":0,"stats":{"Line":0}},{"line":733,"address":[15161343],"length":1,"stats":{"Line":0}},{"line":734,"address":[15161614,15161379],"length":1,"stats":{"Line":0}},{"line":735,"address":[],"length":0,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":737,"address":[15161841],"length":1,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[15162023],"length":1,"stats":{"Line":0}},{"line":742,"address":[15162203],"length":1,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":744,"address":[],"length":0,"stats":{"Line":0}},{"line":745,"address":[],"length":0,"stats":{"Line":0}},{"line":746,"address":[],"length":0,"stats":{"Line":0}},{"line":747,"address":[],"length":0,"stats":{"Line":0}},{"line":748,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":751,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":760,"address":[],"length":0,"stats":{"Line":0}},{"line":764,"address":[15166768,15166895,15164992],"length":1,"stats":{"Line":0}},{"line":770,"address":[15165024],"length":1,"stats":{"Line":0}},{"line":772,"address":[15165114,15165185],"length":1,"stats":{"Line":0}},{"line":774,"address":[15165477],"length":1,"stats":{"Line":0}},{"line":775,"address":[15165745,15165513],"length":1,"stats":{"Line":0}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":778,"address":[15165972],"length":1,"stats":{"Line":0}},{"line":780,"address":[],"length":0,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":784,"address":[],"length":0,"stats":{"Line":0}},{"line":785,"address":[],"length":0,"stats":{"Line":0}},{"line":786,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[],"length":0,"stats":{"Line":0}},{"line":788,"address":[],"length":0,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":790,"address":[],"length":0,"stats":{"Line":0}},{"line":792,"address":[],"length":0,"stats":{"Line":0}},{"line":793,"address":[],"length":0,"stats":{"Line":0}},{"line":798,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[15166912,15168425,15171136],"length":1,"stats":{"Line":0}},{"line":810,"address":[],"length":0,"stats":{"Line":0}},{"line":812,"address":[15167010,15167102],"length":1,"stats":{"Line":0}},{"line":813,"address":[15167251],"length":1,"stats":{"Line":0}},{"line":814,"address":[],"length":0,"stats":{"Line":0}},{"line":815,"address":[15167401],"length":1,"stats":{"Line":0}},{"line":816,"address":[15167505],"length":1,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[15167756],"length":1,"stats":{"Line":0}},{"line":819,"address":[],"length":0,"stats":{"Line":0}},{"line":820,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[15167962],"length":1,"stats":{"Line":0}},{"line":823,"address":[],"length":0,"stats":{"Line":0}},{"line":824,"address":[],"length":0,"stats":{"Line":0}},{"line":827,"address":[],"length":0,"stats":{"Line":0}},{"line":828,"address":[15168263,15168178],"length":1,"stats":{"Line":0}},{"line":831,"address":[15168217,15168431],"length":1,"stats":{"Line":0}},{"line":833,"address":[15168500],"length":1,"stats":{"Line":0}},{"line":834,"address":[15168585,15168637],"length":1,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":836,"address":[],"length":0,"stats":{"Line":0}},{"line":840,"address":[15168903,15168612],"length":1,"stats":{"Line":0}},{"line":841,"address":[15168960,15168909],"length":1,"stats":{"Line":0}},{"line":842,"address":[15168979],"length":1,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":847,"address":[],"length":0,"stats":{"Line":0}},{"line":848,"address":[15169347,15169400],"length":1,"stats":{"Line":0}},{"line":849,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":0}},{"line":853,"address":[],"length":0,"stats":{"Line":0}},{"line":854,"address":[15170150],"length":1,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":0}},{"line":856,"address":[15170211],"length":1,"stats":{"Line":0}},{"line":857,"address":[15170269],"length":1,"stats":{"Line":0}},{"line":858,"address":[],"length":0,"stats":{"Line":0}},{"line":859,"address":[15170240],"length":1,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":863,"address":[15170365],"length":1,"stats":{"Line":0}},{"line":864,"address":[],"length":0,"stats":{"Line":0}},{"line":865,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":0}},{"line":867,"address":[],"length":0,"stats":{"Line":0}},{"line":868,"address":[],"length":0,"stats":{"Line":0}},{"line":869,"address":[],"length":0,"stats":{"Line":0}},{"line":873,"address":[],"length":0,"stats":{"Line":0}},{"line":874,"address":[],"length":0,"stats":{"Line":0}},{"line":875,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":881,"address":[15167145],"length":1,"stats":{"Line":0}},{"line":882,"address":[15167193,15170942],"length":1,"stats":{"Line":0}},{"line":883,"address":[],"length":0,"stats":{"Line":0}},{"line":887,"address":[],"length":0,"stats":{"Line":0}},{"line":891,"address":[15159296,15159422,15156480],"length":1,"stats":{"Line":0}},{"line":897,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[15156597],"length":1,"stats":{"Line":0}},{"line":900,"address":[],"length":0,"stats":{"Line":0}},{"line":902,"address":[],"length":0,"stats":{"Line":0}},{"line":903,"address":[15159463],"length":1,"stats":{"Line":0}},{"line":904,"address":[],"length":0,"stats":{"Line":0}},{"line":906,"address":[],"length":0,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[15159562],"length":1,"stats":{"Line":0}},{"line":910,"address":[],"length":0,"stats":{"Line":0}},{"line":913,"address":[],"length":0,"stats":{"Line":0}},{"line":914,"address":[15159667],"length":1,"stats":{"Line":0}},{"line":915,"address":[],"length":0,"stats":{"Line":0}},{"line":918,"address":[15159705],"length":1,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[15156845],"length":1,"stats":{"Line":0}},{"line":925,"address":[15156898],"length":1,"stats":{"Line":0}},{"line":926,"address":[15159326,15156939],"length":1,"stats":{"Line":0}},{"line":927,"address":[],"length":0,"stats":{"Line":0}},{"line":930,"address":[],"length":0,"stats":{"Line":0}},{"line":931,"address":[],"length":0,"stats":{"Line":0}},{"line":933,"address":[15157138],"length":1,"stats":{"Line":0}},{"line":934,"address":[15157402],"length":1,"stats":{"Line":0}},{"line":935,"address":[],"length":0,"stats":{"Line":0}},{"line":936,"address":[],"length":0,"stats":{"Line":0}},{"line":937,"address":[],"length":0,"stats":{"Line":0}},{"line":938,"address":[],"length":0,"stats":{"Line":0}},{"line":939,"address":[15157768],"length":1,"stats":{"Line":0}},{"line":942,"address":[15157800,15157917],"length":1,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":947,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[15158136],"length":1,"stats":{"Line":0}},{"line":951,"address":[],"length":0,"stats":{"Line":0}},{"line":952,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[],"length":0,"stats":{"Line":0}},{"line":955,"address":[],"length":0,"stats":{"Line":0}},{"line":958,"address":[15158556],"length":1,"stats":{"Line":0}},{"line":959,"address":[],"length":0,"stats":{"Line":0}},{"line":960,"address":[],"length":0,"stats":{"Line":0}},{"line":961,"address":[],"length":0,"stats":{"Line":0}},{"line":964,"address":[],"length":0,"stats":{"Line":0}},{"line":965,"address":[],"length":0,"stats":{"Line":0}},{"line":968,"address":[15159097,15159302],"length":1,"stats":{"Line":0}},{"line":971,"address":[],"length":0,"stats":{"Line":0}},{"line":972,"address":[15157476],"length":1,"stats":{"Line":0}},{"line":974,"address":[15157529],"length":1,"stats":{"Line":0}},{"line":978,"address":[15162912,15164926,15164761],"length":1,"stats":{"Line":0}},{"line":984,"address":[15162944],"length":1,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":987,"address":[15163150,15163220],"length":1,"stats":{"Line":0}},{"line":989,"address":[15163521],"length":1,"stats":{"Line":0}},{"line":990,"address":[15163557,15163789],"length":1,"stats":{"Line":0}},{"line":991,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[15163912],"length":1,"stats":{"Line":0}},{"line":993,"address":[],"length":0,"stats":{"Line":0}},{"line":995,"address":[],"length":0,"stats":{"Line":0}},{"line":996,"address":[],"length":0,"stats":{"Line":0}},{"line":997,"address":[15164198],"length":1,"stats":{"Line":0}},{"line":998,"address":[],"length":0,"stats":{"Line":0}},{"line":999,"address":[],"length":0,"stats":{"Line":0}},{"line":1000,"address":[],"length":0,"stats":{"Line":0}},{"line":1001,"address":[],"length":0,"stats":{"Line":0}},{"line":1002,"address":[],"length":0,"stats":{"Line":0}},{"line":1003,"address":[],"length":0,"stats":{"Line":0}},{"line":1005,"address":[],"length":0,"stats":{"Line":0}},{"line":1006,"address":[],"length":0,"stats":{"Line":0}},{"line":1011,"address":[],"length":0,"stats":{"Line":0}},{"line":1012,"address":[15163649],"length":1,"stats":{"Line":0}},{"line":1015,"address":[15163760],"length":1,"stats":{"Line":0}},{"line":1019,"address":[15126577,15124688,15134141],"length":1,"stats":{"Line":0}},{"line":1032,"address":[15124859],"length":1,"stats":{"Line":0}},{"line":1034,"address":[],"length":0,"stats":{"Line":0}},{"line":1035,"address":[15125257],"length":1,"stats":{"Line":0}},{"line":1036,"address":[15125343,15127263],"length":1,"stats":{"Line":0}},{"line":1037,"address":[15133243,15127294,15127403],"length":1,"stats":{"Line":0}},{"line":1039,"address":[15133273],"length":1,"stats":{"Line":0}},{"line":1040,"address":[],"length":0,"stats":{"Line":0}},{"line":1044,"address":[],"length":0,"stats":{"Line":0}},{"line":1045,"address":[],"length":0,"stats":{"Line":0}},{"line":1047,"address":[15127854,15134261,15134208],"length":1,"stats":{"Line":0}},{"line":1048,"address":[15127877,15134185,15134160],"length":1,"stats":{"Line":0}},{"line":1050,"address":[],"length":0,"stats":{"Line":0}},{"line":1053,"address":[15128238,15127719],"length":1,"stats":{"Line":0}},{"line":1054,"address":[15128393,15128600,15128269],"length":1,"stats":{"Line":0}},{"line":1057,"address":[],"length":0,"stats":{"Line":0}},{"line":1058,"address":[15128661],"length":1,"stats":{"Line":0}},{"line":1059,"address":[],"length":0,"stats":{"Line":0}},{"line":1060,"address":[15129018,15129327],"length":1,"stats":{"Line":0}},{"line":1061,"address":[],"length":0,"stats":{"Line":0}},{"line":1064,"address":[15129305,15129045],"length":1,"stats":{"Line":0}},{"line":1067,"address":[],"length":0,"stats":{"Line":0}},{"line":1068,"address":[],"length":0,"stats":{"Line":0}},{"line":1071,"address":[],"length":0,"stats":{"Line":0}},{"line":1073,"address":[15125388,15125312],"length":1,"stats":{"Line":0}},{"line":1074,"address":[],"length":0,"stats":{"Line":0}},{"line":1075,"address":[],"length":0,"stats":{"Line":0}},{"line":1077,"address":[15127172],"length":1,"stats":{"Line":0}},{"line":1078,"address":[15126857],"length":1,"stats":{"Line":0}},{"line":1082,"address":[],"length":0,"stats":{"Line":0}},{"line":1083,"address":[15125792,15125535],"length":1,"stats":{"Line":0}},{"line":1084,"address":[15126674,15125823,15125932],"length":1,"stats":{"Line":0}},{"line":1086,"address":[],"length":0,"stats":{"Line":0}},{"line":1087,"address":[],"length":0,"stats":{"Line":0}},{"line":1091,"address":[15126144],"length":1,"stats":{"Line":0}},{"line":1092,"address":[15126215,15126324,15126555],"length":1,"stats":{"Line":0}},{"line":1094,"address":[15126591],"length":1,"stats":{"Line":0}},{"line":1095,"address":[15126246],"length":1,"stats":{"Line":0}},{"line":1099,"address":[],"length":0,"stats":{"Line":0}},{"line":1100,"address":[],"length":0,"stats":{"Line":0}},{"line":1101,"address":[],"length":0,"stats":{"Line":0}},{"line":1102,"address":[],"length":0,"stats":{"Line":0}},{"line":1108,"address":[15126528],"length":1,"stats":{"Line":0}},{"line":1109,"address":[],"length":0,"stats":{"Line":0}},{"line":1111,"address":[15130348],"length":1,"stats":{"Line":0}},{"line":1112,"address":[15130384,15131053],"length":1,"stats":{"Line":0}},{"line":1113,"address":[15131080],"length":1,"stats":{"Line":0}},{"line":1115,"address":[15131176],"length":1,"stats":{"Line":0}},{"line":1116,"address":[],"length":0,"stats":{"Line":0}},{"line":1117,"address":[],"length":0,"stats":{"Line":0}},{"line":1120,"address":[],"length":0,"stats":{"Line":0}},{"line":1121,"address":[15131514],"length":1,"stats":{"Line":0}},{"line":1124,"address":[15130457,15130358],"length":1,"stats":{"Line":0}},{"line":1125,"address":[15130484],"length":1,"stats":{"Line":0}},{"line":1127,"address":[],"length":0,"stats":{"Line":0}},{"line":1128,"address":[],"length":0,"stats":{"Line":0}},{"line":1129,"address":[15130778],"length":1,"stats":{"Line":0}},{"line":1132,"address":[15130683,15130896],"length":1,"stats":{"Line":0}},{"line":1133,"address":[],"length":0,"stats":{"Line":0}},{"line":1137,"address":[15130953],"length":1,"stats":{"Line":0}},{"line":1141,"address":[15156224,15149760,15154258],"length":1,"stats":{"Line":0}},{"line":1146,"address":[15149948,15156203,15149841],"length":1,"stats":{"Line":0}},{"line":1147,"address":[15156056,15150405,15150324,15156354,15156336],"length":1,"stats":{"Line":0}},{"line":1148,"address":[],"length":0,"stats":{"Line":0}},{"line":1150,"address":[],"length":0,"stats":{"Line":0}},{"line":1151,"address":[],"length":0,"stats":{"Line":0}},{"line":1154,"address":[],"length":0,"stats":{"Line":0}},{"line":1155,"address":[],"length":0,"stats":{"Line":0}},{"line":1157,"address":[],"length":0,"stats":{"Line":0}},{"line":1160,"address":[15151301,15151155],"length":1,"stats":{"Line":0}},{"line":1161,"address":[],"length":0,"stats":{"Line":0}},{"line":1162,"address":[],"length":0,"stats":{"Line":0}},{"line":1164,"address":[],"length":0,"stats":{"Line":0}},{"line":1166,"address":[15155946],"length":1,"stats":{"Line":0}},{"line":1169,"address":[],"length":0,"stats":{"Line":0}},{"line":1170,"address":[],"length":0,"stats":{"Line":0}},{"line":1171,"address":[],"length":0,"stats":{"Line":0}},{"line":1174,"address":[],"length":0,"stats":{"Line":0}},{"line":1175,"address":[15154666,15154717],"length":1,"stats":{"Line":0}},{"line":1176,"address":[],"length":0,"stats":{"Line":0}},{"line":1177,"address":[15154981],"length":1,"stats":{"Line":0}},{"line":1178,"address":[],"length":0,"stats":{"Line":0}},{"line":1179,"address":[],"length":0,"stats":{"Line":0}},{"line":1185,"address":[15154690,15155280],"length":1,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1187,"address":[15155464],"length":1,"stats":{"Line":0}},{"line":1188,"address":[],"length":0,"stats":{"Line":0}},{"line":1189,"address":[],"length":0,"stats":{"Line":0}},{"line":1190,"address":[],"length":0,"stats":{"Line":0}},{"line":1195,"address":[],"length":0,"stats":{"Line":0}},{"line":1199,"address":[],"length":0,"stats":{"Line":0}},{"line":1200,"address":[],"length":0,"stats":{"Line":0}},{"line":1201,"address":[],"length":0,"stats":{"Line":0}},{"line":1203,"address":[],"length":0,"stats":{"Line":0}},{"line":1206,"address":[15151937,15151748],"length":1,"stats":{"Line":0}},{"line":1209,"address":[],"length":0,"stats":{"Line":0}},{"line":1210,"address":[15152067,15152119],"length":1,"stats":{"Line":0}},{"line":1211,"address":[],"length":0,"stats":{"Line":0}},{"line":1212,"address":[],"length":0,"stats":{"Line":0}},{"line":1213,"address":[],"length":0,"stats":{"Line":0}},{"line":1214,"address":[],"length":0,"stats":{"Line":0}},{"line":1216,"address":[],"length":0,"stats":{"Line":0}},{"line":1219,"address":[15152853],"length":1,"stats":{"Line":0}},{"line":1220,"address":[],"length":0,"stats":{"Line":0}},{"line":1221,"address":[15153079],"length":1,"stats":{"Line":0}},{"line":1222,"address":[],"length":0,"stats":{"Line":0}},{"line":1227,"address":[],"length":0,"stats":{"Line":0}},{"line":1228,"address":[],"length":0,"stats":{"Line":0}},{"line":1229,"address":[15153603],"length":1,"stats":{"Line":0}},{"line":1230,"address":[],"length":0,"stats":{"Line":0}},{"line":1231,"address":[],"length":0,"stats":{"Line":0}},{"line":1232,"address":[],"length":0,"stats":{"Line":0}},{"line":1236,"address":[],"length":0,"stats":{"Line":0}},{"line":1237,"address":[],"length":0,"stats":{"Line":0}},{"line":1238,"address":[],"length":0,"stats":{"Line":0}},{"line":1244,"address":[],"length":0,"stats":{"Line":0}},{"line":1248,"address":[],"length":0,"stats":{"Line":0}},{"line":1249,"address":[],"length":0,"stats":{"Line":0}},{"line":1252,"address":[],"length":0,"stats":{"Line":0}},{"line":1255,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":528},{"path":["/","home","shift","code","vincents-ai","engram","src","collab.rs"],"content":"// Placeholder for collaboration module\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","config","agent_config.rs"],"content":"//! Agent configuration for Engram\n//!\n//! Provides agent profile management and type definitions.\n\nuse serde::{Deserialize, Serialize};\n\n/// Agent configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AgentConfig {\n    pub name: String,\n    pub agent_type: String,\n    pub specialization: Option\u003cString\u003e,\n    pub email: Option\u003cString\u003e,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","config","app_config.rs"],"content":"//! Application configuration for Engram\n//!\n//! Provides main application settings including\n//! storage, agents, and feature flags.\n\nuse crate::config::agent_config::AgentConfig;\nuse crate::config::workspace_config::WorkspaceConfig;\nuse crate::error::{ConfigError, EngramError};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n/// Main application configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AppConfig {\n    pub storage: StorageConfig,\n    pub workspace: WorkspaceConfig,\n    pub features: FeatureFlags,\n    pub agents: HashMap\u003cString, AgentConfig\u003e,\n}\n\nimpl Default for AppConfig {\n    fn default() -\u003e Self {\n        Self {\n            storage: StorageConfig::default(),\n            workspace: WorkspaceConfig::default(),\n            features: FeatureFlags::default(),\n            agents: HashMap::new(),\n        }\n    }\n}\n\nimpl AppConfig {\n    pub fn validate(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        self.storage.validate()?;\n        self.workspace.validate()?;\n        self.features.validate()?;\n        Ok(())\n    }\n\n    pub fn merge(\u0026mut self, other: AppConfig) {\n        self.storage.merge(other.storage);\n        self.workspace.merge(other.workspace);\n        self.features.merge(other.features);\n\n        for (key, config) in other.agents {\n            self.agents.insert(key, config);\n        }\n    }\n}\n\n/// Storage configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct StorageConfig {\n    pub storage_type: String,\n    pub base_path: String,\n    pub sync_strategy: String,\n}\n\nimpl Default for StorageConfig {\n    fn default() -\u003e Self {\n        Self {\n            storage_type: \"git\".to_string(),\n            base_path: \".engram\".to_string(),\n            sync_strategy: \"merge_with_conflict_resolution\".to_string(),\n        }\n    }\n}\n\nimpl StorageConfig {\n    pub fn validate(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        if self.storage_type.is_empty() {\n            return Err(EngramError::Config(ConfigError::ValidationFailed(\n                \"storage_type cannot be empty\".to_string(),\n            )));\n        }\n        if self.base_path.is_empty() {\n            return Err(EngramError::Config(ConfigError::ValidationFailed(\n                \"base_path cannot be empty\".to_string(),\n            )));\n        }\n        Ok(())\n    }\n\n    pub fn merge(\u0026mut self, other: StorageConfig) {\n        if !other.storage_type.is_empty() {\n            self.storage_type = other.storage_type;\n        }\n        if !other.base_path.is_empty() {\n            self.base_path = other.base_path;\n        }\n        if !other.sync_strategy.is_empty() {\n            self.sync_strategy = other.sync_strategy;\n        }\n    }\n}\n\n/// Feature flags configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct FeatureFlags {\n    pub plugins: bool,\n    pub analytics: bool,\n    pub experimental: bool,\n}\n\nimpl Default for FeatureFlags {\n    fn default() -\u003e Self {\n        Self {\n            plugins: true,\n            analytics: true,\n            experimental: false,\n        }\n    }\n}\n\nimpl FeatureFlags {\n    pub fn validate(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        Ok(())\n    }\n\n    pub fn merge(\u0026mut self, other: FeatureFlags) {\n        self.plugins = other.plugins;\n        self.analytics = other.analytics;\n        self.experimental = other.experimental;\n    }\n}\n\n/// Git configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct GitConfig {\n    pub author_name: String,\n    pub author_email: String,\n}\n\nimpl Default for GitConfig {\n    fn default() -\u003e Self {\n        Self {\n            author_name: \"Engram User\".to_string(),\n            author_email: \"user@engram.ai\".to_string(),\n        }\n    }\n}\n\nimpl GitConfig {\n    pub fn merge(\u0026mut self, other: GitConfig) {\n        if !other.author_name.is_empty() {\n            self.author_name = other.author_name;\n        }\n        if !other.author_email.is_empty() {\n            self.author_email = other.author_email;\n        }\n    }\n}\n\n/// BDD testing configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct BddConfig {\n    pub features: Vec\u003cString\u003e,\n    pub steps: Vec\u003cString\u003e,\n}\n\nimpl Default for BddConfig {\n    fn default() -\u003e Self {\n        Self {\n            features: vec![],\n            steps: vec![],\n        }\n    }\n}\n\n/// Application settings container\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct AppSettings {\n    pub workspace: WorkspaceConfig,\n}\n\nimpl Default for AppSettings {\n    fn default() -\u003e Self {\n        Self {\n            workspace: WorkspaceConfig::default(),\n        }\n    }\n}\n\nimpl AppSettings {\n    pub fn merge(\u0026mut self, other: AppSettings) {\n        self.workspace.merge(other.workspace);\n    }\n}\n","traces":[{"line":22,"address":[21321770,21321776,21321440],"length":1,"stats":{"Line":0}},{"line":24,"address":[21321457],"length":1,"stats":{"Line":0}},{"line":25,"address":[15566464],"length":1,"stats":{"Line":0}},{"line":26,"address":[27106769,27106712],"length":1,"stats":{"Line":0}},{"line":27,"address":[27106820],"length":1,"stats":{"Line":0}},{"line":33,"address":[27564336],"length":1,"stats":{"Line":0}},{"line":34,"address":[20433598],"length":1,"stats":{"Line":0}},{"line":35,"address":[20445223],"length":1,"stats":{"Line":0}},{"line":36,"address":[20433833],"length":1,"stats":{"Line":0}},{"line":37,"address":[21318875],"length":1,"stats":{"Line":0}},{"line":40,"address":[15562592,15563404,15563438],"length":1,"stats":{"Line":0}},{"line":41,"address":[20432664],"length":1,"stats":{"Line":0}},{"line":42,"address":[21317718],"length":1,"stats":{"Line":0}},{"line":43,"address":[21884513],"length":1,"stats":{"Line":0}},{"line":45,"address":[21884792,21884615],"length":1,"stats":{"Line":0}},{"line":46,"address":[21885034,21884965],"length":1,"stats":{"Line":0}},{"line":60,"address":[20437893,20437632,20437899],"length":1,"stats":{"Line":0}},{"line":62,"address":[21889214],"length":1,"stats":{"Line":0}},{"line":63,"address":[20227186],"length":1,"stats":{"Line":0}},{"line":64,"address":[20227242],"length":1,"stats":{"Line":0}},{"line":70,"address":[20372960],"length":1,"stats":{"Line":0}},{"line":71,"address":[20443766],"length":1,"stats":{"Line":0}},{"line":72,"address":[20373062],"length":1,"stats":{"Line":0}},{"line":73,"address":[20443802],"length":1,"stats":{"Line":0}},{"line":76,"address":[20373012],"length":1,"stats":{"Line":0}},{"line":77,"address":[20432466],"length":1,"stats":{"Line":0}},{"line":78,"address":[20221939],"length":1,"stats":{"Line":0}},{"line":81,"address":[20373175],"length":1,"stats":{"Line":0}},{"line":84,"address":[21316987,21316160],"length":1,"stats":{"Line":0}},{"line":85,"address":[20372303,20372142,20372038],"length":1,"stats":{"Line":0}},{"line":86,"address":[27101502,27101563],"length":1,"stats":{"Line":0}},{"line":88,"address":[20372309,20372477,20372199],"length":1,"stats":{"Line":0}},{"line":89,"address":[21883141,21883207],"length":1,"stats":{"Line":0}},{"line":91,"address":[15561571,15561683,15561852],"length":1,"stats":{"Line":0}},{"line":92,"address":[20372560,20372499],"length":1,"stats":{"Line":0}},{"line":116,"address":[27562000],"length":1,"stats":{"Line":0}},{"line":117,"address":[27562008],"length":1,"stats":{"Line":0}},{"line":120,"address":[21882720],"length":1,"stats":{"Line":0}},{"line":121,"address":[20371945],"length":1,"stats":{"Line":0}},{"line":122,"address":[20371953],"length":1,"stats":{"Line":0}},{"line":123,"address":[20431210],"length":1,"stats":{"Line":0}},{"line":135,"address":[21322143,21321968,21322137],"length":1,"stats":{"Line":0}},{"line":137,"address":[27567837],"length":1,"stats":{"Line":0}},{"line":138,"address":[20448625],"length":1,"stats":{"Line":0}},{"line":144,"address":[21886049,21886079,21885552],"length":1,"stats":{"Line":0}},{"line":145,"address":[27104185,27104115,27104340],"length":1,"stats":{"Line":0}},{"line":146,"address":[21319075,21319017],"length":1,"stats":{"Line":0}},{"line":148,"address":[21885711,21885969,21885818],"length":1,"stats":{"Line":0}},{"line":149,"address":[20445838,20445786],"length":1,"stats":{"Line":0}},{"line":162,"address":[27567648,27567793,27567799],"length":1,"stats":{"Line":0}},{"line":164,"address":[20226397],"length":1,"stats":{"Line":0}},{"line":165,"address":[15566810],"length":1,"stats":{"Line":0}},{"line":177,"address":[21322448],"length":1,"stats":{"Line":0}},{"line":179,"address":[27568320],"length":1,"stats":{"Line":0}},{"line":185,"address":[20431088],"length":1,"stats":{"Line":0}},{"line":186,"address":[20220611],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":56},{"path":["/","home","shift","code","vincents-ai","engram","src","config","mod.rs"],"content":"//! Configuration system for Engram\n//!\n//! Provides extensible configuration management with validation\n//! and support for dynamic model loading.\n\npub mod agent_config;\npub mod app_config;\npub mod workspace_config;\n\npub use agent_config::*;\npub use app_config::*;\npub use workspace_config::*;\n\nuse crate::error::{ConfigError, EngramError};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Config {\n    pub app: AppConfig,\n\n    pub workspace: WorkspaceConfig,\n\n    pub agents: HashMap\u003cString, AgentConfig\u003e,\n\n    pub plugins: HashMap\u003cString, PluginConfig\u003e,\n\n    pub storage: ConfigStorage,\n\n    pub features: ConfigFeatures,\n}\n\n/// Top-level configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TopConfig {\n    pub log_level: String,\n\n    pub default_agent: String,\n\n    pub workspace_path: Option\u003cString\u003e,\n\n    pub git: GitConfig,\n\n    pub bdd: BddConfig,\n}\n\n/// Git configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct GitConfig {\n    /// Git repository path\n    pub repository_path: String,\n\n    /// Default branch name\n    pub default_branch: String,\n\n    /// Remote repository URL (optional)\n    pub remote_url: Option\u003cString\u003e,\n\n    /// Author name for commits\n    pub author_name: String,\n\n    /// Author email for commits\n    pub author_email: String,\n}\n\nimpl Default for GitConfig {\n    fn default() -\u003e Self {\n        Self {\n            repository_path: \".engram\".to_string(),\n            default_branch: \"main\".to_string(),\n            remote_url: None,\n            author_name: \"Engram User\".to_string(),\n            author_email: \"user@engram.ai\".to_string(),\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct BddConfig {\n    pub enabled: bool,\n\n    pub test_directory: String,\n\n    pub step_definitions: String,\n\n    pub report_format: String,\n\n    pub parallel: bool,\n}\n\nimpl Default for BddConfig {\n    fn default() -\u003e Self {\n        Self {\n            enabled: false,\n            test_directory: \"tests/bdd\".to_string(),\n            step_definitions: \"tests/bdd/steps\".to_string(),\n            report_format: \"cucumber\".to_string(),\n            parallel: false,\n        }\n    }\n}\n\n/// Plugin configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PluginConfig {\n    /// Plugin name\n    pub name: String,\n\n    /// Plugin version\n    pub version: String,\n\n    /// Whether plugin is enabled\n    pub enabled: bool,\n\n    /// Plugin configuration\n    pub config: HashMap\u003cString, serde_yaml::Value\u003e,\n\n    /// Plugin library path\n    pub library_path: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ConfigStorage {\n    pub storage_type: String,\n\n    pub base_path: String,\n\n    pub sync_strategy: String,\n\n    pub options: HashMap\u003cString, serde_yaml::Value\u003e,\n}\n\nimpl Default for ConfigStorage {\n    fn default() -\u003e Self {\n        Self {\n            storage_type: \"git\".to_string(),\n            base_path: \".engram\".to_string(),\n            sync_strategy: \"merge_with_conflict_resolution\".to_string(),\n            options: HashMap::new(),\n        }\n    }\n}\n\nimpl ConfigStorage {\n    pub fn merge(\u0026mut self, other: ConfigStorage) {\n        if !other.storage_type.is_empty() {\n            self.storage_type = other.storage_type;\n        }\n        if !other.base_path.is_empty() {\n            self.base_path = other.base_path;\n        }\n        if !other.sync_strategy.is_empty() {\n            self.sync_strategy = other.sync_strategy;\n        }\n        for (key, value) in other.options {\n            self.options.insert(key, value);\n        }\n    }\n\n    pub fn validate(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        if self.storage_type.is_empty() {\n            return Err(EngramError::Config(ConfigError::ValidationFailed(\n                \"storage_type cannot be empty\".to_string(),\n            )));\n        }\n        if self.base_path.is_empty() {\n            return Err(EngramError::Config(ConfigError::ValidationFailed(\n                \"base_path cannot be empty\".to_string(),\n            )));\n        }\n        Ok(())\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ConfigFeatures {\n    pub plugins: bool,\n\n    pub async_operations: bool,\n\n    pub analytics: bool,\n\n    pub experimental: bool,\n\n    pub enterprise: bool,\n}\n\nimpl Default for ConfigFeatures {\n    fn default() -\u003e Self {\n        Self {\n            plugins: true,\n            async_operations: false,\n            analytics: true,\n            experimental: false,\n            enterprise: false,\n        }\n    }\n}\n\nimpl ConfigFeatures {\n    pub fn merge(\u0026mut self, other: ConfigFeatures) {\n        self.plugins = other.plugins;\n        self.async_operations = other.async_operations;\n        self.analytics = other.analytics;\n        self.experimental = other.experimental;\n        self.enterprise = other.enterprise;\n    }\n\n    pub fn validate(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        Ok(())\n    }\n}\n\nimpl Config {\n    /// Load configuration from file\n    pub fn load_from_file(path: \u0026str) -\u003e Result\u003cSelf, EngramError\u003e {\n        let content = std::fs::read_to_string(path).map_err(|e| {\n            EngramError::Config(ConfigError::FileNotFound(format!(\n                \"Cannot read config file: {}\",\n                e\n            )))\n        })?;\n\n        let config: Config = serde_yaml::from_str(\u0026content).map_err(|e| {\n            EngramError::Config(ConfigError::InvalidFormat(format!(\n                \"Invalid YAML format: {}\",\n                e\n            )))\n        })?;\n\n        Ok(config)\n    }\n\n    /// Save configuration to file\n    pub fn save_to_file(\u0026self, path: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        let yaml_content = serde_yaml::to_string(self).map_err(|e| {\n            EngramError::Config(ConfigError::InvalidFormat(format!(\n                \"Cannot serialize config: {}\",\n                e\n            )))\n        })?;\n\n        std::fs::write(path, yaml_content).map_err(EngramError::Io)?;\n\n        Ok(())\n    }\n\n    /// Get default configuration\n    pub fn default() -\u003e Self {\n        Self {\n            app: AppConfig::default(),\n            workspace: WorkspaceConfig::default(),\n            agents: HashMap::new(),\n            plugins: HashMap::new(),\n            storage: ConfigStorage::default(),\n            features: ConfigFeatures::default(),\n        }\n    }\n\n    /// Merge with another configuration\n    pub fn merge(\u0026self, other: \u0026Config) -\u003e Self {\n        let mut app = self.app.clone();\n        app.merge(other.app.clone());\n\n        let mut workspace = self.workspace.clone();\n        workspace.merge(other.workspace.clone());\n\n        let mut storage = self.storage.clone();\n        storage.merge(other.storage.clone());\n\n        let mut features = self.features.clone();\n        features.merge(other.features.clone());\n\n        Self {\n            app,\n            workspace,\n            agents: {\n                let mut merged = self.agents.clone();\n                for (key, value) in \u0026other.agents {\n                    merged.insert(key.clone(), value.clone());\n                }\n                merged\n            },\n            plugins: {\n                let mut merged = self.plugins.clone();\n                for (key, value) in \u0026other.plugins {\n                    merged.insert(key.clone(), value.clone());\n                }\n                merged\n            },\n            storage,\n            features,\n        }\n    }\n\n    /// Validate configuration\n    pub fn validate(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        self.app.validate()?;\n        self.workspace.validate()?;\n        self.storage.validate()?;\n        self.features.validate()?;\n\n        Ok(())\n    }\n\n    /// Get configuration paths\n    pub fn get_config_paths() -\u003e Vec\u003cString\u003e {\n        let mut paths = Vec::new();\n\n        // Current directory\n        paths.push(\"./engram.yaml\".to_string());\n        paths.push(\"./engram.yml\".to_string());\n\n        // Home directory\n        if let Some(home) = dirs::home_dir() {\n            paths.push(format!(\"{}/.engram/config.yaml\", home.display()));\n            paths.push(format!(\"{}/.engram/config.yml\", home.display()));\n        }\n\n        // System directory\n        paths.push(\"/etc/engram/config.yaml\".to_string());\n\n        paths\n    }\n\n    /// Find configuration file\n    pub fn find_config_file() -\u003e Option\u003cString\u003e {\n        for path in Self::get_config_paths() {\n            if std::path::Path::new(\u0026path).exists() {\n                return Some(path);\n            }\n        }\n        None\n    }\n\n    /// Load configuration with defaults\n    pub fn load_with_defaults() -\u003e Result\u003cSelf, EngramError\u003e {\n        match Self::find_config_file() {\n            Some(config_path) =\u003e {\n                let config = Self::load_from_file(\u0026config_path)?;\n                config.validate()?;\n                Ok(config)\n            }\n            None =\u003e {\n                let config = Self::default();\n                config.validate()?;\n                Ok(config)\n            }\n        }\n    }\n}\n\nimpl Default for TopConfig {\n    fn default() -\u003e Self {\n        Self {\n            log_level: \"info\".to_string(),\n            default_agent: \"default\".to_string(),\n            workspace_path: Some(\".\".to_string()),\n            git: GitConfig::default(),\n            bdd: BddConfig::default(),\n        }\n    }\n}\n","traces":[{"line":67,"address":[27446541,27446566,27446112],"length":1,"stats":{"Line":0}},{"line":69,"address":[21200273],"length":1,"stats":{"Line":0}},{"line":70,"address":[21200309],"length":1,"stats":{"Line":0}},{"line":72,"address":[21767042],"length":1,"stats":{"Line":0}},{"line":73,"address":[20256295],"length":1,"stats":{"Line":0}},{"line":92,"address":[21766515,21766240,21766509],"length":1,"stats":{"Line":0}},{"line":95,"address":[21766254],"length":1,"stats":{"Line":0}},{"line":96,"address":[18357250],"length":1,"stats":{"Line":0}},{"line":97,"address":[20314778],"length":1,"stats":{"Line":0}},{"line":134,"address":[27456528,27456176,27456534],"length":1,"stats":{"Line":0}},{"line":136,"address":[26995521],"length":1,"stats":{"Line":0}},{"line":137,"address":[21777029],"length":1,"stats":{"Line":0}},{"line":138,"address":[18367731],"length":1,"stats":{"Line":0}},{"line":139,"address":[21777157],"length":1,"stats":{"Line":0}},{"line":145,"address":[20107127,20105888],"length":1,"stats":{"Line":0}},{"line":146,"address":[26986518,26986799,26986638],"length":1,"stats":{"Line":0}},{"line":147,"address":[20257371,20257310],"length":1,"stats":{"Line":0}},{"line":149,"address":[26986805,26986973,26986695],"length":1,"stats":{"Line":0}},{"line":150,"address":[26986821,26986887],"length":1,"stats":{"Line":0}},{"line":152,"address":[20257635,20257523,20257871],"length":1,"stats":{"Line":0}},{"line":153,"address":[20106403,20106531],"length":1,"stats":{"Line":0}},{"line":155,"address":[21202036,21202133,21201863],"length":1,"stats":{"Line":0}},{"line":156,"address":[26987475,26987758],"length":1,"stats":{"Line":0}},{"line":160,"address":[26987904],"length":1,"stats":{"Line":0}},{"line":161,"address":[21202758],"length":1,"stats":{"Line":0}},{"line":162,"address":[21202822],"length":1,"stats":{"Line":0}},{"line":163,"address":[26987978],"length":1,"stats":{"Line":0}},{"line":166,"address":[20317860],"length":1,"stats":{"Line":0}},{"line":167,"address":[20318066],"length":1,"stats":{"Line":0}},{"line":168,"address":[20318035],"length":1,"stats":{"Line":0}},{"line":171,"address":[27448791],"length":1,"stats":{"Line":0}},{"line":201,"address":[18360736],"length":1,"stats":{"Line":0}},{"line":202,"address":[27449046],"length":1,"stats":{"Line":0}},{"line":203,"address":[27449054],"length":1,"stats":{"Line":0}},{"line":204,"address":[20318295],"length":1,"stats":{"Line":0}},{"line":205,"address":[20329824],"length":1,"stats":{"Line":0}},{"line":206,"address":[20107817],"length":1,"stats":{"Line":0}},{"line":209,"address":[18360832],"length":1,"stats":{"Line":0}},{"line":210,"address":[26988440],"length":1,"stats":{"Line":0}},{"line":216,"address":[27449728,27450293,27450287],"length":1,"stats":{"Line":0}},{"line":217,"address":[21770561,21770663],"length":1,"stats":{"Line":0}},{"line":218,"address":[16104683,16104751],"length":1,"stats":{"Line":0}},{"line":224,"address":[17289747,17289753,17289456],"length":1,"stats":{"Line":0}},{"line":225,"address":[17289551,17289483],"length":1,"stats":{"Line":0}},{"line":231,"address":[20108968],"length":1,"stats":{"Line":0}},{"line":235,"address":[20108415,20108444,20107856],"length":1,"stats":{"Line":0}},{"line":236,"address":[16382387,16382393,16382096],"length":1,"stats":{"Line":0}},{"line":237,"address":[16104043,16104111],"length":1,"stats":{"Line":0}},{"line":243,"address":[26988809,26988705,26988995],"length":1,"stats":{"Line":0}},{"line":245,"address":[20108375],"length":1,"stats":{"Line":0}},{"line":249,"address":[20265579,20265008,20265573],"length":1,"stats":{"Line":0}},{"line":251,"address":[20335793],"length":1,"stats":{"Line":0}},{"line":252,"address":[20265039],"length":1,"stats":{"Line":0}},{"line":253,"address":[21209259],"length":1,"stats":{"Line":0}},{"line":254,"address":[20324407],"length":1,"stats":{"Line":0}},{"line":255,"address":[20324467],"length":1,"stats":{"Line":0}},{"line":256,"address":[26994623,26994690],"length":1,"stats":{"Line":0}},{"line":261,"address":[20335515,20333552,20335733],"length":1,"stats":{"Line":0}},{"line":262,"address":[18364443],"length":1,"stats":{"Line":0}},{"line":263,"address":[20322186,20322138],"length":1,"stats":{"Line":0}},{"line":265,"address":[20111719],"length":1,"stats":{"Line":0}},{"line":266,"address":[20333770,20333833],"length":1,"stats":{"Line":0}},{"line":268,"address":[27453113],"length":1,"stats":{"Line":0}},{"line":269,"address":[27453206,27453140],"length":1,"stats":{"Line":0}},{"line":271,"address":[27453238],"length":1,"stats":{"Line":0}},{"line":272,"address":[20322547],"length":1,"stats":{"Line":0}},{"line":297,"address":[20265600],"length":1,"stats":{"Line":0}},{"line":298,"address":[26994973],"length":1,"stats":{"Line":0}},{"line":299,"address":[18367202],"length":1,"stats":{"Line":0}},{"line":300,"address":[21210025],"length":1,"stats":{"Line":0}},{"line":301,"address":[18367460],"length":1,"stats":{"Line":0}},{"line":303,"address":[20114879],"length":1,"stats":{"Line":0}},{"line":307,"address":[18362480,18363390,18363316],"length":1,"stats":{"Line":0}},{"line":308,"address":[20109585],"length":1,"stats":{"Line":0}},{"line":311,"address":[21205007,21205076],"length":1,"stats":{"Line":0}},{"line":312,"address":[27450953],"length":1,"stats":{"Line":0}},{"line":315,"address":[20109744],"length":1,"stats":{"Line":0}},{"line":316,"address":[20261088,20261193],"length":1,"stats":{"Line":0}},{"line":317,"address":[20332171],"length":1,"stats":{"Line":0}},{"line":321,"address":[20331873,20332426],"length":1,"stats":{"Line":0}},{"line":323,"address":[18363356],"length":1,"stats":{"Line":0}},{"line":327,"address":[21771120,21771613,21771619],"length":1,"stats":{"Line":0}},{"line":328,"address":[20260456,20260321],"length":1,"stats":{"Line":0}},{"line":329,"address":[20319773,20319898],"length":1,"stats":{"Line":0}},{"line":330,"address":[18362363],"length":1,"stats":{"Line":0}},{"line":333,"address":[20109322],"length":1,"stats":{"Line":0}},{"line":337,"address":[21772990,21772984,21772560],"length":1,"stats":{"Line":0}},{"line":338,"address":[21205936],"length":1,"stats":{"Line":0}},{"line":339,"address":[20321069],"length":1,"stats":{"Line":0}},{"line":340,"address":[20110598,20110987,20111527],"length":1,"stats":{"Line":0}},{"line":341,"address":[27452494,27452557],"length":1,"stats":{"Line":0}},{"line":342,"address":[20333443],"length":1,"stats":{"Line":0}},{"line":345,"address":[20321114],"length":1,"stats":{"Line":0}},{"line":346,"address":[18363560,18363623],"length":1,"stats":{"Line":0}},{"line":347,"address":[21772906],"length":1,"stats":{"Line":0}},{"line":354,"address":[18358823,18358817,18358352],"length":1,"stats":{"Line":0}},{"line":356,"address":[27446609],"length":1,"stats":{"Line":0}},{"line":357,"address":[27446645],"length":1,"stats":{"Line":0}},{"line":358,"address":[26986101,26986035],"length":1,"stats":{"Line":0}},{"line":359,"address":[20105529],"length":1,"stats":{"Line":0}},{"line":360,"address":[20105586],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":101},{"path":["/","home","shift","code","vincents-ai","engram","src","config","workspace_config.rs"],"content":"//! Workspace configuration for Engram\n//!\n//! Provides workspace initialization and agent management settings.\n\nuse crate::config::agent_config::AgentConfig;\nuse crate::error::{ConfigError, EngramError};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n/// Workspace configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkspaceConfig {\n    pub name: String,\n    pub default_agent: String,\n    pub agents: HashMap\u003cString, AgentConfig\u003e,\n    pub sync_strategy: String,\n}\n\nimpl Default for WorkspaceConfig {\n    fn default() -\u003e Self {\n        Self {\n            name: \"default\".to_string(),\n            default_agent: \"default\".to_string(),\n            agents: HashMap::new(),\n            sync_strategy: \"merge_with_conflict_resolution\".to_string(),\n        }\n    }\n}\n\nimpl WorkspaceConfig {\n    pub fn validate(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        if self.name.is_empty() {\n            return Err(EngramError::Config(ConfigError::ValidationFailed(\n                \"workspace name cannot be empty\".to_string(),\n            )));\n        }\n        Ok(())\n    }\n\n    pub fn merge(\u0026mut self, other: WorkspaceConfig) {\n        if !other.name.is_empty() {\n            self.name = other.name;\n        }\n        if !other.default_agent.is_empty() {\n            self.default_agent = other.default_agent;\n        }\n        if !other.sync_strategy.is_empty() {\n            self.sync_strategy = other.sync_strategy;\n        }\n\n        for (key, config) in other.agents {\n            self.agents.insert(key, config);\n        }\n    }\n}\n","traces":[{"line":20,"address":[28249327,28248944,28249321],"length":1,"stats":{"Line":0}},{"line":22,"address":[15277425],"length":1,"stats":{"Line":0}},{"line":23,"address":[21059006],"length":1,"stats":{"Line":0}},{"line":24,"address":[27788395],"length":1,"stats":{"Line":0}},{"line":25,"address":[15277581],"length":1,"stats":{"Line":0}},{"line":31,"address":[21117312],"length":1,"stats":{"Line":0}},{"line":32,"address":[28248118],"length":1,"stats":{"Line":0}},{"line":33,"address":[27787500],"length":1,"stats":{"Line":0}},{"line":34,"address":[22568944],"length":1,"stats":{"Line":0}},{"line":37,"address":[22002276],"length":1,"stats":{"Line":0}},{"line":40,"address":[15275152,15276387],"length":1,"stats":{"Line":0}},{"line":41,"address":[15275190,15275310,15275471],"length":1,"stats":{"Line":0}},{"line":42,"address":[27786142,27786203],"length":1,"stats":{"Line":0}},{"line":44,"address":[21116087,21116197,21116365],"length":1,"stats":{"Line":0}},{"line":45,"address":[22001125,22001191],"length":1,"stats":{"Line":0}},{"line":47,"address":[28247375,28247027,28247139],"length":1,"stats":{"Line":0}},{"line":48,"address":[27786611,27786483],"length":1,"stats":{"Line":0}},{"line":51,"address":[20906116,20905943,20906213],"length":1,"stats":{"Line":0}},{"line":52,"address":[20906670,20906387],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":19},{"path":["/","home","shift","code","vincents-ai","engram","src","engines","action_executor.rs"],"content":"//! Action Executor for Workflow Actions\n//!\n//! Executes various types of actions that can be triggered during workflow transitions,\n//! including external commands, notifications, and custom actions.\n\nuse crate::error::EngramError;\nuse crate::Result;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::process::{Command, Stdio};\nuse std::time::Duration;\n\n/// Action execution result\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ActionResult {\n    pub success: bool,\n    pub message: String,\n    pub output: Option\u003cString\u003e,\n    pub error: Option\u003cString\u003e,\n    pub exit_code: Option\u003ci32\u003e,\n    pub metadata: HashMap\u003cString, String\u003e,\n}\n\n/// Action type enum\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"snake_case\")]\npub enum ActionType {\n    ExternalCommand,\n    Notification,\n    UpdateEntity,\n    Custom,\n}\n\n/// Action parameters for external command\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ExternalCommandParams {\n    pub command: String,\n    pub args: Vec\u003cString\u003e,\n    pub working_directory: Option\u003cString\u003e,\n    pub environment: HashMap\u003cString, String\u003e,\n    pub timeout_seconds: Option\u003cu64\u003e,\n    pub capture_output: bool,\n}\n\n/// Action executor\npub struct ActionExecutor {\n    default_timeout: Duration,\n    allow_external_commands: bool,\n}\n\nimpl ActionExecutor {\n    /// Create a new action executor\n    pub fn new(allow_external_commands: bool) -\u003e Self {\n        Self {\n            default_timeout: Duration::from_secs(300), // 5 minutes default\n            allow_external_commands,\n        }\n    }\n\n    /// Execute an action based on type and parameters\n    pub fn execute_action(\n        \u0026self,\n        action_type: \u0026str,\n        parameters: \u0026HashMap\u003cString, serde_json::Value\u003e,\n    ) -\u003e Result\u003cActionResult\u003e {\n        match action_type {\n            \"external_command\" =\u003e self.execute_external_command(parameters),\n            \"notification\" =\u003e self.execute_notification(parameters),\n            \"update_entity\" =\u003e self.execute_update_entity(parameters),\n            _ =\u003e Err(EngramError::Validation(format!(\n                \"Unknown action type: {}\",\n                action_type\n            ))),\n        }\n    }\n\n    /// Execute an external command\n    fn execute_external_command(\n        \u0026self,\n        parameters: \u0026HashMap\u003cString, serde_json::Value\u003e,\n    ) -\u003e Result\u003cActionResult\u003e {\n        if !self.allow_external_commands {\n            return Err(EngramError::Validation(\n                \"External commands are disabled\".to_string(),\n            ));\n        }\n\n        // Parse command parameters\n        let command = parameters\n            .get(\"command\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| EngramError::Validation(\"Missing 'command' parameter\".to_string()))?;\n\n        let args: Vec\u003cString\u003e = parameters\n            .get(\"args\")\n            .and_then(|v| v.as_array())\n            .map(|arr| {\n                arr.iter()\n                    .filter_map(|v| v.as_str().map(String::from))\n                    .collect()\n            })\n            .unwrap_or_default();\n\n        let working_directory = parameters\n            .get(\"working_directory\")\n            .and_then(|v| v.as_str())\n            .map(String::from);\n\n        let environment: HashMap\u003cString, String\u003e = parameters\n            .get(\"environment\")\n            .and_then(|v| v.as_object())\n            .map(|obj| {\n                obj.iter()\n                    .filter_map(|(k, v)| v.as_str().map(|s| (k.clone(), s.to_string())))\n                    .collect()\n            })\n            .unwrap_or_default();\n\n        let timeout_seconds = parameters\n            .get(\"timeout_seconds\")\n            .and_then(|v| v.as_u64())\n            .unwrap_or(300);\n\n        let capture_output = parameters\n            .get(\"capture_output\")\n            .and_then(|v| v.as_bool())\n            .unwrap_or(true);\n\n        // Execute the command\n        self.run_command(\n            command,\n            \u0026args,\n            working_directory.as_deref(),\n            \u0026environment,\n            Duration::from_secs(timeout_seconds),\n            capture_output,\n        )\n    }\n\n    /// Run a command with the specified parameters\n    fn run_command(\n        \u0026self,\n        command: \u0026str,\n        args: \u0026[String],\n        working_directory: Option\u003c\u0026str\u003e,\n        environment: \u0026HashMap\u003cString, String\u003e,\n        timeout: Duration,\n        capture_output: bool,\n    ) -\u003e Result\u003cActionResult\u003e {\n        let mut cmd = Command::new(command);\n        cmd.args(args);\n\n        if let Some(working_dir) = working_directory {\n            cmd.current_dir(working_dir);\n        }\n\n        for (key, value) in environment {\n            cmd.env(key, value);\n        }\n\n        if capture_output {\n            cmd.stdout(Stdio::piped()).stderr(Stdio::piped());\n        }\n\n        let child = cmd.spawn().map_err(|e| {\n            EngramError::Validation(format!(\"Failed to spawn command '{}': {}\", command, e))\n        })?;\n\n        let output = self\n            .wait_for_output_with_timeout(child, timeout)\n            .map_err(|e| EngramError::Validation(format!(\"Command execution failed: {}\", e)))?;\n\n        let stdout = String::from_utf8_lossy(\u0026output.stdout).to_string();\n        let stderr = String::from_utf8_lossy(\u0026output.stderr).to_string();\n        let exit_code = output.status.code().unwrap_or(-1);\n        let success = output.status.success();\n\n        Ok(ActionResult {\n            success,\n            message: if success {\n                format!(\"Command '{}' executed successfully\", command)\n            } else {\n                format!(\"Command '{}' failed with exit code {}\", command, exit_code)\n            },\n            output: if stdout.is_empty() {\n                None\n            } else {\n                Some(stdout)\n            },\n            error: if stderr.is_empty() {\n                None\n            } else {\n                Some(stderr)\n            },\n            exit_code: Some(exit_code),\n            metadata: HashMap::new(),\n        })\n    }\n\n    /// Wait for command output with timeout\n    fn wait_for_output_with_timeout(\n        \u0026self,\n        mut child: std::process::Child,\n        timeout: Duration,\n    ) -\u003e Result\u003cstd::process::Output\u003e {\n        use std::sync::mpsc;\n        use std::thread;\n\n        let (tx, rx) = mpsc::channel();\n\n        thread::spawn(move || {\n            let result = child.wait_with_output();\n            let _ = tx.send(result);\n        });\n\n        match rx.recv_timeout(timeout) {\n            Ok(Ok(output)) =\u003e Ok(output),\n            Ok(Err(e)) =\u003e Err(EngramError::Validation(format!(\n                \"Failed to get command output: {}\",\n                e\n            ))),\n            Err(_) =\u003e Err(EngramError::Validation(format!(\n                \"Command timed out after {:?}\",\n                timeout\n            ))),\n        }\n    }\n\n    /// Execute a notification action\n    fn execute_notification(\n        \u0026self,\n        parameters: \u0026HashMap\u003cString, serde_json::Value\u003e,\n    ) -\u003e Result\u003cActionResult\u003e {\n        let message = parameters\n            .get(\"message\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| EngramError::Validation(\"Missing 'message' parameter\".to_string()))?;\n\n        // For now, just log the notification\n        // In the future, this could send emails, Slack messages, etc.\n        tracing::info!(\"Workflow notification: {}\", message);\n\n        Ok(ActionResult {\n            success: true,\n            message: format!(\"Notification sent: {}\", message),\n            output: None,\n            error: None,\n            exit_code: None,\n            metadata: HashMap::new(),\n        })\n    }\n\n    /// Execute an entity update action\n    fn execute_update_entity(\n        \u0026self,\n        parameters: \u0026HashMap\u003cString, serde_json::Value\u003e,\n    ) -\u003e Result\u003cActionResult\u003e {\n        let entity_id = parameters\n            .get(\"entity_id\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| EngramError::Validation(\"Missing 'entity_id' parameter\".to_string()))?;\n\n        let entity_type = parameters\n            .get(\"entity_type\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| {\n                EngramError::Validation(\"Missing 'entity_type' parameter\".to_string())\n            })?;\n\n        // For now, just acknowledge the update\n        // In the future, this would actually update the entity in storage\n        tracing::info!(\n            \"Update entity action: {} (type: {})\",\n            entity_id,\n            entity_type\n        );\n\n        Ok(ActionResult {\n            success: true,\n            message: format!(\"Entity {} updated\", entity_id),\n            output: None,\n            error: None,\n            exit_code: None,\n            metadata: HashMap::new(),\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_external_command_success() {\n        let executor = ActionExecutor::new(true);\n        let mut params = HashMap::new();\n        params.insert(\n            \"command\".to_string(),\n            serde_json::Value::String(\"echo\".to_string()),\n        );\n        params.insert(\"args\".to_string(), serde_json::json!([\"hello\", \"world\"]));\n        params.insert(\"capture_output\".to_string(), serde_json::json!(true));\n\n        let result = executor.execute_action(\"external_command\", \u0026params);\n        assert!(result.is_ok());\n        let action_result = result.unwrap();\n        assert!(action_result.success);\n        assert!(action_result.output.is_some());\n        assert!(action_result.output.unwrap().contains(\"hello world\"));\n    }\n\n    #[test]\n    fn test_external_command_disabled() {\n        let executor = ActionExecutor::new(false);\n        let mut params = HashMap::new();\n        params.insert(\n            \"command\".to_string(),\n            serde_json::Value::String(\"echo\".to_string()),\n        );\n\n        let result = executor.execute_action(\"external_command\", \u0026params);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_notification_action() {\n        let executor = ActionExecutor::new(true);\n        let mut params = HashMap::new();\n        params.insert(\n            \"message\".to_string(),\n            serde_json::Value::String(\"Test notification\".to_string()),\n        );\n\n        let result = executor.execute_action(\"notification\", \u0026params);\n        assert!(result.is_ok());\n        let action_result = result.unwrap();\n        assert!(action_result.success);\n        assert!(action_result.message.contains(\"Test notification\"));\n    }\n\n    #[test]\n    fn test_unknown_action_type() {\n        let executor = ActionExecutor::new(true);\n        let params = HashMap::new();\n\n        let result = executor.execute_action(\"unknown_action\", \u0026params);\n        assert!(result.is_err());\n    }\n}\n","traces":[{"line":53,"address":[19250304],"length":1,"stats":{"Line":1}},{"line":55,"address":[24603211],"length":1,"stats":{"Line":1}},{"line":61,"address":[17716784],"length":1,"stats":{"Line":1}},{"line":67,"address":[15371445,15371524],"length":1,"stats":{"Line":2}},{"line":68,"address":[15371586,15371476],"length":1,"stats":{"Line":2}},{"line":69,"address":[17868174,17868461],"length":1,"stats":{"Line":1}},{"line":70,"address":[19244700],"length":1,"stats":{"Line":1}},{"line":78,"address":[24601916,24600464,24601910],"length":1,"stats":{"Line":1}},{"line":82,"address":[17719931],"length":1,"stats":{"Line":1}},{"line":83,"address":[17930471],"length":1,"stats":{"Line":1}},{"line":84,"address":[19247653],"length":1,"stats":{"Line":1}},{"line":89,"address":[17871380,17871486],"length":1,"stats":{"Line":1}},{"line":91,"address":[23921360,23921369],"length":1,"stats":{"Line":3}},{"line":92,"address":[17251582,17251568],"length":1,"stats":{"Line":1}},{"line":96,"address":[23921769,23921760],"length":1,"stats":{"Line":3}},{"line":97,"address":[15603008],"length":1,"stats":{"Line":2}},{"line":98,"address":[17251438],"length":1,"stats":{"Line":1}},{"line":99,"address":[17048368,17048102,17048403],"length":1,"stats":{"Line":3}},{"line":100,"address":[15603075],"length":1,"stats":{"Line":1}},{"line":106,"address":[24601095],"length":1,"stats":{"Line":1}},{"line":107,"address":[17931042],"length":1,"stats":{"Line":1}},{"line":111,"address":[17942672],"length":1,"stats":{"Line":1}},{"line":112,"address":[24601275],"length":1,"stats":{"Line":1}},{"line":113,"address":[24382089],"length":1,"stats":{"Line":0}},{"line":114,"address":[23922000,23922038,23921427,23921949,23921904],"length":1,"stats":{"Line":0}},{"line":115,"address":[17262872],"length":1,"stats":{"Line":0}},{"line":119,"address":[17942919],"length":1,"stats":{"Line":1}},{"line":121,"address":[18681504,18681513],"length":1,"stats":{"Line":1}},{"line":124,"address":[15375506],"length":1,"stats":{"Line":1}},{"line":126,"address":[25062214],"length":1,"stats":{"Line":3}},{"line":130,"address":[25062477],"length":1,"stats":{"Line":1}},{"line":132,"address":[19248729],"length":1,"stats":{"Line":1}},{"line":133,"address":[17872320],"length":1,"stats":{"Line":1}},{"line":135,"address":[19361625],"length":1,"stats":{"Line":1}},{"line":141,"address":[19244468,19241248,19244363],"length":1,"stats":{"Line":1}},{"line":150,"address":[19241443],"length":1,"stats":{"Line":1}},{"line":151,"address":[19241532],"length":1,"stats":{"Line":1}},{"line":153,"address":[19354371],"length":1,"stats":{"Line":1}},{"line":154,"address":[19354480,19354434],"length":1,"stats":{"Line":0}},{"line":157,"address":[17924482,17924461],"length":1,"stats":{"Line":2}},{"line":158,"address":[17936146,17938767],"length":1,"stats":{"Line":0}},{"line":161,"address":[19241868],"length":1,"stats":{"Line":1}},{"line":162,"address":[15368825],"length":1,"stats":{"Line":1}},{"line":165,"address":[17191521,17191216,17191515],"length":1,"stats":{"Line":2}},{"line":166,"address":[17250494,17250575],"length":1,"stats":{"Line":0}},{"line":169,"address":[24595262,24595379,24597293],"length":1,"stats":{"Line":1}},{"line":170,"address":[17714539],"length":1,"stats":{"Line":1}},{"line":171,"address":[17046854,17046832],"length":1,"stats":{"Line":1}},{"line":173,"address":[15369556,15369639],"length":1,"stats":{"Line":2}},{"line":174,"address":[25056446],"length":1,"stats":{"Line":1}},{"line":175,"address":[17937395],"length":1,"stats":{"Line":1}},{"line":176,"address":[15370053],"length":1,"stats":{"Line":1}},{"line":178,"address":[25057559],"length":1,"stats":{"Line":1}},{"line":180,"address":[19243188],"length":1,"stats":{"Line":1}},{"line":181,"address":[25057000,25056803],"length":1,"stats":{"Line":2}},{"line":183,"address":[24596161,24596080],"length":1,"stats":{"Line":0}},{"line":185,"address":[17937738,17938012,17937902],"length":1,"stats":{"Line":3}},{"line":186,"address":[17938014],"length":1,"stats":{"Line":0}},{"line":188,"address":[25057156],"length":1,"stats":{"Line":1}},{"line":190,"address":[17938099,17938209,17938040],"length":1,"stats":{"Line":2}},{"line":191,"address":[17716195],"length":1,"stats":{"Line":1}},{"line":193,"address":[15370701],"length":1,"stats":{"Line":0}},{"line":195,"address":[17938229],"length":1,"stats":{"Line":1}},{"line":196,"address":[17716224],"length":1,"stats":{"Line":1}},{"line":201,"address":[17873476,17872592,17873812],"length":1,"stats":{"Line":1}},{"line":209,"address":[15375879,15375960],"length":1,"stats":{"Line":2}},{"line":211,"address":[18682258,18682112],"length":1,"stats":{"Line":2}},{"line":212,"address":[23922219],"length":1,"stats":{"Line":1}},{"line":213,"address":[17263723],"length":1,"stats":{"Line":1}},{"line":216,"address":[19249374,19249479],"length":1,"stats":{"Line":2}},{"line":217,"address":[17721855],"length":1,"stats":{"Line":1}},{"line":218,"address":[24602559,24602396],"length":1,"stats":{"Line":0}},{"line":222,"address":[24602329,24602826],"length":1,"stats":{"Line":0}},{"line":230,"address":[24597824,24598942,24598986],"length":1,"stats":{"Line":1}},{"line":234,"address":[17939335,17939404],"length":1,"stats":{"Line":1}},{"line":236,"address":[25058563],"length":1,"stats":{"Line":3}},{"line":237,"address":[17047424,17047438],"length":1,"stats":{"Line":1}},{"line":241,"address":[17928298,17927946],"length":1,"stats":{"Line":1}},{"line":243,"address":[17928610],"length":1,"stats":{"Line":1}},{"line":245,"address":[25058895],"length":1,"stats":{"Line":1}},{"line":246,"address":[15372367],"length":1,"stats":{"Line":1}},{"line":247,"address":[17928268],"length":1,"stats":{"Line":1}},{"line":249,"address":[15372391],"length":1,"stats":{"Line":1}},{"line":254,"address":[24600442,24600398,24599008],"length":1,"stats":{"Line":0}},{"line":258,"address":[25059767,25059836],"length":1,"stats":{"Line":0}},{"line":260,"address":[17718483],"length":1,"stats":{"Line":0}},{"line":261,"address":[17940560,17940508],"length":1,"stats":{"Line":0}},{"line":263,"address":[19246395,19246476],"length":1,"stats":{"Line":0}},{"line":265,"address":[17047689,17047680],"length":1,"stats":{"Line":0}},{"line":266,"address":[17929165],"length":1,"stats":{"Line":0}},{"line":267,"address":[17191934],"length":1,"stats":{"Line":0}},{"line":272,"address":[19246550,19246902],"length":1,"stats":{"Line":0}},{"line":278,"address":[17719570],"length":1,"stats":{"Line":0}},{"line":280,"address":[15373601],"length":1,"stats":{"Line":0}},{"line":281,"address":[25060416],"length":1,"stats":{"Line":0}},{"line":282,"address":[17719160],"length":1,"stats":{"Line":0}},{"line":284,"address":[17719168],"length":1,"stats":{"Line":0}}],"covered":72,"coverable":97},{"path":["/","home","shift","code","vincents-ai","engram","src","engines","mod.rs"],"content":"//! Engine modules for Engram\n//!\n//! Provides execution engines for business logic, workflows,\n//! and system automation.\n\npub mod action_executor;\npub mod rule_engine;\npub mod workflow_engine;\n\npub use action_executor::*;\npub use rule_engine::*;\npub use workflow_engine::*;\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","engines","rule_engine.rs"],"content":"//! Rule Execution Engine\n//!\n//! Provides business rule enforcement, validation, and automated\n//! rule execution with conditions, actions, and audit trails.\n\nuse crate::entities::{GenericEntity, Rule};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::fmt;\n\n/// Rule condition for evaluation\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RuleCondition {\n    pub expression: String,\n    pub description: Option\u003cString\u003e,\n}\n\n/// Rule action to execute\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RuleAction {\n    pub action_type: String,\n    pub parameters: HashMap\u003cString, String\u003e,\n    pub description: Option\u003cString\u003e,\n}\n\n/// Rule result enumeration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum RuleResult {\n    Success,\n    Failed(String),\n    Skipped(String),\n}\n\n/// Rule execution context containing state and variables\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RuleExecutionContext {\n    pub variables: HashMap\u003cString, RuleValue\u003e,\n    pub current_entity: Option\u003cGenericEntity\u003e,\n    pub executing_agent: String,\n    pub execution_time: DateTime\u003cUtc\u003e,\n    pub metadata: HashMap\u003cString, String\u003e,\n}\n\n/// Values that can be used in rule conditions and actions\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(tag = \"type\", content = \"value\")]\npub enum RuleValue {\n    String(String),\n    Number(f64),\n    Boolean(bool),\n    DateTime(DateTime\u003cUtc\u003e),\n    Array(Vec\u003cRuleValue\u003e),\n    Object(HashMap\u003cString, RuleValue\u003e),\n    Null,\n}\n\n/// Rule execution result\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RuleExecutionResult {\n    pub rule_id: String,\n    pub condition_satisfied: bool,\n    pub actions_executed: bool,\n    pub context: RuleExecutionContext,\n    pub errors: Vec\u003cString\u003e,\n    pub actions_taken: Vec\u003cString\u003e,\n    pub execution_duration_ms: u64,\n}\n\n/// Rule execution engine\npub struct RuleExecutionEngine {\n    #[allow(dead_code)]\n    builtin_functions: HashMap\u003cString, Box\u003cdyn Fn(\u0026[RuleValue]) -\u003e Result\u003cRuleValue, String\u003e\u003e\u003e,\n}\n\nimpl Default for RuleExecutionEngine {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl RuleExecutionEngine {\n    pub fn new() -\u003e Self {\n        let mut engine = Self {\n            builtin_functions: HashMap::new(),\n        };\n\n        engine.register_builtin_functions();\n        engine\n    }\n\n    pub fn execute_rule(\n        \u0026self,\n        rule: \u0026Rule,\n        context: \u0026mut RuleExecutionContext,\n    ) -\u003e Result\u003cRuleExecutionResult, EngramError\u003e {\n        let start_time = std::time::Instant::now();\n        let mut result = RuleExecutionResult {\n            rule_id: rule.id.clone(),\n            condition_satisfied: false,\n            actions_executed: false,\n            context: context.clone(),\n            errors: Vec::new(),\n            actions_taken: Vec::new(),\n            execution_duration_ms: 0,\n        };\n\n        match self.evaluate_rule_condition(\u0026rule.condition, context) {\n            Ok(condition_result) =\u003e {\n                result.condition_satisfied = condition_result;\n\n                if condition_result {\n                    match self.execute_rule_action(\u0026rule.action, context) {\n                        Ok(action_descriptions) =\u003e {\n                            result.actions_executed = true;\n                            result.actions_taken = action_descriptions;\n                        }\n                        Err(e) =\u003e {\n                            result\n                                .errors\n                                .push(format!(\"Action execution failed: {}\", e));\n                        }\n                    }\n                }\n            }\n            Err(e) =\u003e {\n                result\n                    .errors\n                    .push(format!(\"Condition evaluation failed: {}\", e));\n            }\n        }\n\n        result.execution_duration_ms = start_time.elapsed().as_millis() as u64;\n        result.context = context.clone();\n\n        Ok(result)\n    }\n\n    pub fn execute_rules_for_entity\u003cS: Storage\u003e(\n        \u0026self,\n        storage: \u0026S,\n        entity: \u0026GenericEntity,\n        agent: \u0026str,\n    ) -\u003e Result\u003cVec\u003cRuleExecutionResult\u003e, EngramError\u003e {\n        let mut context = RuleExecutionContext {\n            variables: HashMap::new(),\n            current_entity: Some(entity.clone()),\n            executing_agent: agent.to_string(),\n            execution_time: Utc::now(),\n            metadata: HashMap::new(),\n        };\n\n        self.populate_entity_variables(\u0026mut context, entity);\n\n        let rules = storage.query_by_agent(agent, Some(\"rule\"))?;\n\n        let mut results = Vec::new();\n\n        for generic_rule in rules {\n            if let Ok(rule_json) = serde_json::to_string(\u0026generic_rule.data) {\n                if let Ok(rule) = serde_json::from_str::\u003cRule\u003e(\u0026rule_json) {\n                    if self.rule_applies_to_entity(\u0026rule, entity) {\n                        match self.execute_rule(\u0026rule, \u0026mut context) {\n                            Ok(result) =\u003e results.push(result),\n                            Err(e) =\u003e {\n                                eprintln!(\"Failed to execute rule {}: {}\", rule.id, e);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        Ok(results)\n    }\n\n    fn evaluate_rule_condition(\n        \u0026self,\n        condition: \u0026serde_json::Value,\n        context: \u0026RuleExecutionContext,\n    ) -\u003e Result\u003cbool, String\u003e {\n        match condition {\n            serde_json::Value::String(expr) =\u003e self.evaluate_expression(expr, context),\n            serde_json::Value::Object(obj) =\u003e {\n                if let Some(expr_str) = obj.get(\"expression\").and_then(|v| v.as_str()) {\n                    self.evaluate_expression(expr_str, context)\n                } else {\n                    Ok(true)\n                }\n            }\n            serde_json::Value::Bool(b) =\u003e Ok(*b),\n            serde_json::Value::Null =\u003e Ok(true),\n            _ =\u003e Err(\"Invalid condition format\".to_string()),\n        }\n    }\n\n    fn execute_rule_action(\n        \u0026self,\n        action: \u0026serde_json::Value,\n        context: \u0026mut RuleExecutionContext,\n    ) -\u003e Result\u003cVec\u003cString\u003e, String\u003e {\n        let mut action_descriptions = Vec::new();\n\n        match action {\n            serde_json::Value::String(action_str) =\u003e {\n                action_descriptions.push(format!(\"Executed: {}\", action_str));\n            }\n            serde_json::Value::Object(obj) =\u003e {\n                if let Some(serde_json::Value::String(action_type)) = obj.get(\"type\") {\n                    match action_type.as_str() {\n                        \"log\" =\u003e {\n                            if let Some(serde_json::Value::String(message)) = obj.get(\"message\") {\n                                println!(\"RULE LOG: {}\", message);\n                                action_descriptions.push(format!(\"Logged: {}\", message));\n                            }\n                        }\n                        \"set_metadata\" =\u003e {\n                            if let Some(serde_json::Value::String(key)) = obj.get(\"key\") {\n                                if let Some(serde_json::Value::String(value)) = obj.get(\"value\") {\n                                    context.metadata.insert(key.clone(), value.clone());\n                                    action_descriptions\n                                        .push(format!(\"Set metadata {} = {}\", key, value));\n                                }\n                            }\n                        }\n                        \"validate\" =\u003e {\n                            if let Some(serde_json::Value::String(field)) = obj.get(\"field\") {\n                                if !context.variables.contains_key(field) {\n                                    return Err(format!(\"Required field '{}' is missing\", field));\n                                }\n                                action_descriptions.push(format!(\"Validated field: {}\", field));\n                            }\n                        }\n                        _ =\u003e {\n                            action_descriptions.push(format!(\"Unknown action: {}\", action_type));\n                        }\n                    }\n                }\n            }\n            _ =\u003e {\n                action_descriptions.push(\"Executed unknown action\".to_string());\n            }\n        }\n\n        Ok(action_descriptions)\n    }\n\n    fn evaluate_expression(\n        \u0026self,\n        expression: \u0026str,\n        context: \u0026RuleExecutionContext,\n    ) -\u003e Result\u003cbool, String\u003e {\n        let parts: Vec\u003c\u0026str\u003e = expression.split_whitespace().collect();\n        if parts.len() \u003c 3 {\n            return Err(format!(\"Invalid expression: {}\", expression));\n        }\n\n        let variable_name = parts[0];\n        let operator = parts[1];\n        let expected_value = parts[2..].join(\" \");\n\n        let variable_value = context\n            .variables\n            .get(variable_name)\n            .ok_or_else(|| format!(\"Variable '{}' not found\", variable_name))?;\n\n        match operator {\n            \"equals\" | \"==\" =\u003e {\n                let expected = self.parse_value(\u0026expected_value)?;\n                Ok(*variable_value == expected)\n            }\n            \"not_equals\" | \"!=\" =\u003e {\n                let expected = self.parse_value(\u0026expected_value)?;\n                Ok(*variable_value != expected)\n            }\n            \"greater_than\" | \"\u003e\" =\u003e {\n                self.compare_numeric(variable_value, \u0026expected_value, |a, b| a \u003e b)\n            }\n            \"less_than\" | \"\u003c\" =\u003e {\n                self.compare_numeric(variable_value, \u0026expected_value, |a, b| a \u003c b)\n            }\n            \"contains\" =\u003e match variable_value {\n                RuleValue::String(s) =\u003e Ok(s.contains(\u0026expected_value)),\n                RuleValue::Array(arr) =\u003e {\n                    let expected = self.parse_value(\u0026expected_value)?;\n                    Ok(arr.contains(\u0026expected))\n                }\n                _ =\u003e Err(format!(\n                    \"Contains operator not supported for {:?}\",\n                    variable_value\n                )),\n            },\n            _ =\u003e Err(format!(\"Unknown operator: {}\", operator)),\n        }\n    }\n\n    fn rule_applies_to_entity(\u0026self, rule: \u0026Rule, entity: \u0026GenericEntity) -\u003e bool {\n        rule.entity_types.is_empty() || rule.entity_types.contains(\u0026entity.entity_type)\n    }\n\n    fn populate_entity_variables(\n        \u0026self,\n        context: \u0026mut RuleExecutionContext,\n        entity: \u0026GenericEntity,\n    ) {\n        context\n            .variables\n            .insert(\"id\".to_string(), RuleValue::String(entity.id.clone()));\n        context.variables.insert(\n            \"entity_type\".to_string(),\n            RuleValue::String(entity.entity_type.clone()),\n        );\n        context\n            .variables\n            .insert(\"agent\".to_string(), RuleValue::String(entity.agent.clone()));\n        context.variables.insert(\n            \"timestamp\".to_string(),\n            RuleValue::DateTime(entity.timestamp),\n        );\n\n        self.extract_variables_from_json(\u0026entity.data, \"\", \u0026mut context.variables);\n    }\n\n    fn extract_variables_from_json(\n        \u0026self,\n        json: \u0026serde_json::Value,\n        prefix: \u0026str,\n        variables: \u0026mut HashMap\u003cString, RuleValue\u003e,\n    ) {\n        match json {\n            serde_json::Value::Object(map) =\u003e {\n                for (key, value) in map {\n                    let var_name = if prefix.is_empty() {\n                        key.clone()\n                    } else {\n                        format!(\"{}.{}\", prefix, key)\n                    };\n\n                    match value {\n                        serde_json::Value::String(s) =\u003e {\n                            variables.insert(var_name, RuleValue::String(s.clone()));\n                        }\n                        serde_json::Value::Number(n) =\u003e {\n                            if let Some(f) = n.as_f64() {\n                                variables.insert(var_name, RuleValue::Number(f));\n                            }\n                        }\n                        serde_json::Value::Bool(b) =\u003e {\n                            variables.insert(var_name, RuleValue::Boolean(*b));\n                        }\n                        serde_json::Value::Null =\u003e {\n                            variables.insert(var_name, RuleValue::Null);\n                        }\n                        serde_json::Value::Object(_) =\u003e {\n                            self.extract_variables_from_json(value, \u0026var_name, variables);\n                        }\n                        serde_json::Value::Array(_) =\u003e {}\n                    }\n                }\n            }\n            _ =\u003e {}\n        }\n    }\n\n    fn parse_value(\u0026self, value_str: \u0026str) -\u003e Result\u003cRuleValue, String\u003e {\n        if let Ok(num) = value_str.parse::\u003cf64\u003e() {\n            return Ok(RuleValue::Number(num));\n        }\n\n        if let Ok(boolean) = value_str.parse::\u003cbool\u003e() {\n            return Ok(RuleValue::Boolean(boolean));\n        }\n\n        if value_str.eq_ignore_ascii_case(\"null\") {\n            return Ok(RuleValue::Null);\n        }\n\n        Ok(RuleValue::String(value_str.to_string()))\n    }\n\n    fn compare_numeric\u003cF\u003e(\n        \u0026self,\n        left: \u0026RuleValue,\n        right_str: \u0026str,\n        comparator: F,\n    ) -\u003e Result\u003cbool, String\u003e\n    where\n        F: Fn(f64, f64) -\u003e bool,\n    {\n        let left_num = match left {\n            RuleValue::Number(n) =\u003e *n,\n            _ =\u003e return Err(\"Left operand is not numeric\".to_string()),\n        };\n\n        let right_num = right_str\n            .parse::\u003cf64\u003e()\n            .map_err(|_| format!(\"Right operand '{}' is not numeric\", right_str))?;\n\n        Ok(comparator(left_num, right_num))\n    }\n\n    fn register_builtin_functions(\u0026mut self) {}\n}\n\nimpl fmt::Display for RuleValue {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        match self {\n            RuleValue::String(s) =\u003e write!(f, \"{}\", s),\n            RuleValue::Number(n) =\u003e write!(f, \"{}\", n),\n            RuleValue::Boolean(b) =\u003e write!(f, \"{}\", b),\n            RuleValue::DateTime(dt) =\u003e write!(f, \"{}\", dt.to_rfc3339()),\n            RuleValue::Array(arr) =\u003e write!(\n                f,\n                \"[{}]\",\n                arr.iter()\n                    .map(|v| v.to_string())\n                    .collect::\u003cVec\u003c_\u003e\u003e()\n                    .join(\", \")\n            ),\n            RuleValue::Object(obj) =\u003e write!(\n                f,\n                \"{{{}}}\",\n                obj.iter()\n                    .map(|(k, v)| format!(\"{}: {}\", k, v))\n                    .collect::\u003cVec\u003c_\u003e\u003e()\n                    .join(\", \")\n            ),\n            RuleValue::Null =\u003e write!(f, \"null\"),\n        }\n    }\n}\n\npub struct RuleEngineBuilder {\n    rules: Vec\u003cRule\u003e,\n}\n\nimpl RuleEngineBuilder {\n    pub fn new() -\u003e Self {\n        Self { rules: Vec::new() }\n    }\n\n    pub fn add_rule(mut self, rule: Rule) -\u003e Self {\n        self.rules.push(rule);\n        self\n    }\n\n    pub fn build(self) -\u003e RuleExecutionEngine {\n        RuleExecutionEngine::new()\n    }\n}\n\nimpl Default for RuleEngineBuilder {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::entities::{RulePriority, RuleStatus, RuleType};\n    use crate::storage::{MemoryStorage, Storage};\n    use serde_json::json;\n\n    fn create_test_rule() -\u003e Rule {\n        Rule {\n            id: \"test-rule-1\".to_string(),\n            title: \"Test Rule\".to_string(),\n            description: \"A test rule for validation\".to_string(),\n            rule_type: RuleType::Validation,\n            status: RuleStatus::Active,\n            priority: RulePriority::Medium,\n            agent: \"test-agent\".to_string(),\n            condition: json!({\n                \"expression\": \"priority equals high\"\n            }),\n            action: json!({\n                \"type\": \"log\",\n                \"message\": \"High priority task detected\"\n            }),\n            created_at: Utc::now(),\n            updated_at: Utc::now(),\n            entity_types: vec![\"task\".to_string()],\n            execution_history: vec![],\n            tags: vec![\"test\".to_string()],\n            related_rules: vec![],\n            metadata: HashMap::new(),\n        }\n    }\n\n    fn create_test_entity() -\u003e GenericEntity {\n        GenericEntity {\n            id: \"test-entity-1\".to_string(),\n            entity_type: \"task\".to_string(),\n            agent: \"test-agent\".to_string(),\n            timestamp: Utc::now(),\n            data: json!({\n                \"title\": \"Test Task\",\n                \"priority\": \"high\",\n                \"status\": \"pending\"\n            }),\n        }\n    }\n\n    #[test]\n    fn test_rule_engine_creation() {\n        let engine = RuleExecutionEngine::new();\n        assert!(engine.builtin_functions.is_empty());\n    }\n\n    #[test]\n    fn test_context_variable_population() {\n        let engine = RuleExecutionEngine::new();\n        let entity = create_test_entity();\n        let mut context = RuleExecutionContext {\n            variables: HashMap::new(),\n            current_entity: Some(entity.clone()),\n            executing_agent: \"test-agent\".to_string(),\n            execution_time: Utc::now(),\n            metadata: HashMap::new(),\n        };\n\n        engine.populate_entity_variables(\u0026mut context, \u0026entity);\n\n        assert!(context.variables.contains_key(\"id\"));\n        assert!(context.variables.contains_key(\"entity_type\"));\n        assert!(context.variables.contains_key(\"priority\"));\n\n        if let Some(RuleValue::String(priority)) = context.variables.get(\"priority\") {\n            assert_eq!(priority, \"high\");\n        } else {\n            panic!(\"Priority variable not found or wrong type\");\n        }\n    }\n\n    #[test]\n    fn test_expression_evaluation_equals() {\n        let engine = RuleExecutionEngine::new();\n        let mut context = RuleExecutionContext {\n            variables: HashMap::new(),\n            current_entity: None,\n            executing_agent: \"test-agent\".to_string(),\n            execution_time: Utc::now(),\n            metadata: HashMap::new(),\n        };\n\n        context.variables.insert(\n            \"priority\".to_string(),\n            RuleValue::String(\"high\".to_string()),\n        );\n\n        let result = engine.evaluate_expression(\"priority equals high\", \u0026context);\n        assert!(result.is_ok());\n        assert!(result.unwrap());\n\n        let result = engine.evaluate_expression(\"priority equals low\", \u0026context);\n        assert!(result.is_ok());\n        assert!(!result.unwrap());\n    }\n\n    #[test]\n    fn test_value_parsing() {\n        let engine = RuleExecutionEngine::new();\n\n        let result = engine.parse_value(\"42.5\");\n        assert!(matches!(result, Ok(RuleValue::Number(n)) if n == 42.5));\n\n        let result = engine.parse_value(\"true\");\n        assert!(matches!(result, Ok(RuleValue::Boolean(true))));\n\n        let result = engine.parse_value(\"hello\");\n        assert!(matches!(result, Ok(RuleValue::String(s)) if s == \"hello\"));\n    }\n}\n","traces":[{"line":79,"address":[17164464],"length":1,"stats":{"Line":0}},{"line":80,"address":[17494856],"length":1,"stats":{"Line":0}},{"line":85,"address":[22850448,22850587,22850593],"length":1,"stats":{"Line":1}},{"line":87,"address":[14782501],"length":1,"stats":{"Line":1}},{"line":90,"address":[17488449],"length":1,"stats":{"Line":1}},{"line":91,"address":[17158111],"length":1,"stats":{"Line":1}},{"line":94,"address":[17477344,17478541,17478968],"length":1,"stats":{"Line":0}},{"line":99,"address":[22839464],"length":1,"stats":{"Line":0}},{"line":101,"address":[16110143],"length":1,"stats":{"Line":0}},{"line":104,"address":[17477453],"length":1,"stats":{"Line":0}},{"line":105,"address":[17477504],"length":1,"stats":{"Line":0}},{"line":106,"address":[15959036],"length":1,"stats":{"Line":0}},{"line":110,"address":[16181272,16181335],"length":1,"stats":{"Line":0}},{"line":111,"address":[15959439],"length":1,"stats":{"Line":0}},{"line":112,"address":[17147602],"length":1,"stats":{"Line":0}},{"line":114,"address":[14772262],"length":1,"stats":{"Line":0}},{"line":115,"address":[22840109],"length":1,"stats":{"Line":0}},{"line":116,"address":[14772428],"length":1,"stats":{"Line":0}},{"line":117,"address":[23300932],"length":1,"stats":{"Line":0}},{"line":118,"address":[16110943,16110924],"length":1,"stats":{"Line":0}},{"line":120,"address":[17147697],"length":1,"stats":{"Line":0}},{"line":121,"address":[23300849],"length":1,"stats":{"Line":0}},{"line":123,"address":[16181622,16181883],"length":1,"stats":{"Line":0}},{"line":128,"address":[16237436],"length":1,"stats":{"Line":0}},{"line":129,"address":[15959388],"length":1,"stats":{"Line":0}},{"line":131,"address":[17478591,17477937],"length":1,"stats":{"Line":0}},{"line":135,"address":[16110722,16111466],"length":1,"stats":{"Line":0}},{"line":136,"address":[16182293,16182316],"length":1,"stats":{"Line":0}},{"line":138,"address":[17478909],"length":1,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[16244944],"length":1,"stats":{"Line":0}},{"line":184,"address":[17155055],"length":1,"stats":{"Line":0}},{"line":185,"address":[15967089],"length":1,"stats":{"Line":0}},{"line":186,"address":[17485674],"length":1,"stats":{"Line":0}},{"line":187,"address":[20534192,20534201],"length":1,"stats":{"Line":0}},{"line":188,"address":[23308543],"length":1,"stats":{"Line":0}},{"line":190,"address":[15967291],"length":1,"stats":{"Line":0}},{"line":193,"address":[15967042],"length":1,"stats":{"Line":0}},{"line":194,"address":[23308274],"length":1,"stats":{"Line":0}},{"line":195,"address":[16188962],"length":1,"stats":{"Line":0}},{"line":199,"address":[16242144,16244399,16244797],"length":1,"stats":{"Line":0}},{"line":204,"address":[22844716],"length":1,"stats":{"Line":0}},{"line":206,"address":[17152301],"length":1,"stats":{"Line":0}},{"line":207,"address":[17152378],"length":1,"stats":{"Line":0}},{"line":208,"address":[16186397,16186270],"length":1,"stats":{"Line":0}},{"line":210,"address":[16115537],"length":1,"stats":{"Line":0}},{"line":211,"address":[15964306,15964619],"length":1,"stats":{"Line":0}},{"line":212,"address":[17152847],"length":1,"stats":{"Line":0}},{"line":213,"address":[17152898],"length":1,"stats":{"Line":0}},{"line":214,"address":[16188346,16186841],"length":1,"stats":{"Line":0}},{"line":215,"address":[16117670],"length":1,"stats":{"Line":0}},{"line":216,"address":[16117774],"length":1,"stats":{"Line":0}},{"line":219,"address":[16116045,16116108],"length":1,"stats":{"Line":0}},{"line":220,"address":[23306937,23306168],"length":1,"stats":{"Line":0}},{"line":221,"address":[15965762],"length":1,"stats":{"Line":0}},{"line":222,"address":[22846889,22846548,22846476],"length":1,"stats":{"Line":0}},{"line":223,"address":[23307556],"length":1,"stats":{"Line":0}},{"line":224,"address":[22846671],"length":1,"stats":{"Line":0}},{"line":228,"address":[15964939,15964876],"length":1,"stats":{"Line":0}},{"line":229,"address":[17483513,17483681],"length":1,"stats":{"Line":0}},{"line":230,"address":[22845834],"length":1,"stats":{"Line":0}},{"line":231,"address":[17483883,17483818],"length":1,"stats":{"Line":0}},{"line":233,"address":[16243616,16243405],"length":1,"stats":{"Line":0}},{"line":237,"address":[15964953,15965016],"length":1,"stats":{"Line":0}},{"line":243,"address":[14779365,14776880],"length":1,"stats":{"Line":0}},{"line":247,"address":[22845110],"length":1,"stats":{"Line":0}},{"line":250,"address":[16184746,16182480,16186057],"length":1,"stats":{"Line":1}},{"line":255,"address":[23301799],"length":1,"stats":{"Line":1}},{"line":256,"address":[15960613,15960684],"length":1,"stats":{"Line":2}},{"line":257,"address":[16185909,16182752],"length":1,"stats":{"Line":0}},{"line":260,"address":[15960690,15960774],"length":1,"stats":{"Line":2}},{"line":261,"address":[23302061],"length":1,"stats":{"Line":1}},{"line":262,"address":[16112115],"length":1,"stats":{"Line":1}},{"line":264,"address":[16112443,16112339,16115120,16112218],"length":1,"stats":{"Line":2}},{"line":266,"address":[23302257],"length":1,"stats":{"Line":1}},{"line":267,"address":[20545584,20545605],"length":1,"stats":{"Line":1}},{"line":270,"address":[16183264,16183402],"length":1,"stats":{"Line":1}},{"line":271,"address":[17481983,17479881,17482395],"length":1,"stats":{"Line":2}},{"line":272,"address":[16185812,16185729],"length":1,"stats":{"Line":2}},{"line":274,"address":[17480058,17479920],"length":1,"stats":{"Line":0}},{"line":275,"address":[23304682,23302761,23304296],"length":1,"stats":{"Line":0}},{"line":276,"address":[16241457,16241370],"length":1,"stats":{"Line":0}},{"line":278,"address":[23302800,23302932],"length":1,"stats":{"Line":0}},{"line":279,"address":[16241060,16239721],"length":1,"stats":{"Line":0}},{"line":281,"address":[23303058,23302938],"length":1,"stats":{"Line":0}},{"line":282,"address":[16239850,16241014],"length":1,"stats":{"Line":0}},{"line":284,"address":[23303148,23303064],"length":1,"stats":{"Line":0}},{"line":285,"address":[15962231,15962134],"length":1,"stats":{"Line":0}},{"line":286,"address":[23303435],"length":1,"stats":{"Line":0}},{"line":287,"address":[22842796,22843328,22842908],"length":1,"stats":{"Line":0}},{"line":288,"address":[16113902,16113827],"length":1,"stats":{"Line":0}},{"line":290,"address":[16114008,16113352],"length":1,"stats":{"Line":0}},{"line":295,"address":[23303121,23303195],"length":1,"stats":{"Line":0}},{"line":299,"address":[23308000],"length":1,"stats":{"Line":0}},{"line":300,"address":[15966776],"length":1,"stats":{"Line":0}},{"line":303,"address":[23309562,23308576,23309530],"length":1,"stats":{"Line":1}},{"line":308,"address":[22847950,22848130],"length":1,"stats":{"Line":2}},{"line":310,"address":[22847986,22848044,22848915,22848138],"length":1,"stats":{"Line":2}},{"line":311,"address":[14780444,14780282],"length":1,"stats":{"Line":2}},{"line":312,"address":[16118861],"length":1,"stats":{"Line":1}},{"line":313,"address":[17486252,17486183],"length":1,"stats":{"Line":2}},{"line":315,"address":[17156143,17155981],"length":1,"stats":{"Line":2}},{"line":317,"address":[16245993,16245928,16246087,16246359],"length":1,"stats":{"Line":2}},{"line":318,"address":[15968174,15968069],"length":1,"stats":{"Line":2}},{"line":319,"address":[16119327],"length":1,"stats":{"Line":1}},{"line":320,"address":[22848706],"length":1,"stats":{"Line":1}},{"line":323,"address":[17486761],"length":1,"stats":{"Line":1}},{"line":326,"address":[17157885,17156512,17157957],"length":1,"stats":{"Line":1}},{"line":332,"address":[16119672],"length":1,"stats":{"Line":1}},{"line":333,"address":[22849046],"length":1,"stats":{"Line":1}},{"line":334,"address":[14781165,14781122,14782416],"length":1,"stats":{"Line":3}},{"line":335,"address":[16246923,16246686],"length":1,"stats":{"Line":1}},{"line":336,"address":[16246925],"length":1,"stats":{"Line":1}},{"line":338,"address":[16119877],"length":1,"stats":{"Line":0}},{"line":341,"address":[16190896],"length":1,"stats":{"Line":1}},{"line":342,"address":[16247249],"length":1,"stats":{"Line":1}},{"line":343,"address":[14781829,14782192],"length":1,"stats":{"Line":1}},{"line":345,"address":[14781775],"length":1,"stats":{"Line":0}},{"line":346,"address":[22849980,22849731],"length":1,"stats":{"Line":0}},{"line":347,"address":[15969446],"length":1,"stats":{"Line":0}},{"line":350,"address":[17157156],"length":1,"stats":{"Line":0}},{"line":351,"address":[23310622,23310290],"length":1,"stats":{"Line":0}},{"line":354,"address":[16246996,16247419],"length":1,"stats":{"Line":0}},{"line":357,"address":[23311036,23310542],"length":1,"stats":{"Line":0}},{"line":367,"address":[17146528],"length":1,"stats":{"Line":1}},{"line":368,"address":[16109775,16109697],"length":1,"stats":{"Line":2}},{"line":369,"address":[17477070],"length":1,"stats":{"Line":1}},{"line":372,"address":[15958622,15958486],"length":1,"stats":{"Line":2}},{"line":373,"address":[16109886],"length":1,"stats":{"Line":1}},{"line":376,"address":[15958590],"length":1,"stats":{"Line":1}},{"line":377,"address":[15958778],"length":1,"stats":{"Line":0}},{"line":380,"address":[14771474],"length":1,"stats":{"Line":2}},{"line":383,"address":[20322925,20322320,20322768,20322477],"length":1,"stats":{"Line":0}},{"line":392,"address":[21984880,21984432],"length":1,"stats":{"Line":0}},{"line":393,"address":[21417790,21418238],"length":1,"stats":{"Line":0}},{"line":394,"address":[21418596,21418302,21417854,21418148],"length":1,"stats":{"Line":0}},{"line":397,"address":[20544747,20545005,20544433,20544557,20544643,20545195,20545091,20544881],"length":1,"stats":{"Line":0}},{"line":399,"address":[21418624,21417920,21418804,21418009,21418660,21418368,21418457,21418768],"length":1,"stats":{"Line":0}},{"line":401,"address":[27664391,27663943],"length":1,"stats":{"Line":0}},{"line":404,"address":[22848949,22848944],"length":1,"stats":{"Line":2}},{"line":408,"address":[14785123,14784160,14785129],"length":1,"stats":{"Line":0}},{"line":409,"address":[22852161],"length":1,"stats":{"Line":0}},{"line":410,"address":[16249685],"length":1,"stats":{"Line":0}},{"line":411,"address":[23312999],"length":1,"stats":{"Line":0}},{"line":412,"address":[23313144],"length":1,"stats":{"Line":0}},{"line":413,"address":[23313289,23313649],"length":1,"stats":{"Line":0}},{"line":414,"address":[16250793,16250722,16250179],"length":1,"stats":{"Line":0}},{"line":417,"address":[16194127,16194196],"length":1,"stats":{"Line":0}},{"line":418,"address":[16194157],"length":1,"stats":{"Line":0}},{"line":419,"address":[14784773],"length":1,"stats":{"Line":0}},{"line":420,"address":[17160746],"length":1,"stats":{"Line":0}},{"line":422,"address":[16251009,16250289,16251080],"length":1,"stats":{"Line":0}},{"line":425,"address":[22852894,22852813],"length":1,"stats":{"Line":0}},{"line":426,"address":[17160392],"length":1,"stats":{"Line":0}},{"line":427,"address":[16194291],"length":1,"stats":{"Line":0}},{"line":428,"address":[15972889],"length":1,"stats":{"Line":0}},{"line":430,"address":[14784917],"length":1,"stats":{"Line":0}},{"line":440,"address":[17146208],"length":1,"stats":{"Line":0}},{"line":441,"address":[22838669],"length":1,"stats":{"Line":0}},{"line":444,"address":[16180381,16180256],"length":1,"stats":{"Line":0}},{"line":445,"address":[14771080],"length":1,"stats":{"Line":0}},{"line":446,"address":[17476866],"length":1,"stats":{"Line":0}},{"line":449,"address":[22838720,22838801],"length":1,"stats":{"Line":0}},{"line":450,"address":[23299409],"length":1,"stats":{"Line":0}},{"line":455,"address":[17164432],"length":1,"stats":{"Line":0}},{"line":456,"address":[15976296],"length":1,"stats":{"Line":0}}],"covered":45,"coverable":182},{"path":["/","home","shift","code","vincents-ai","engram","src","engines","workflow_engine.rs"],"content":"//! Workflow Automation Engine\n//!\n//! Provides state machine-based workflow automation for business processes,\n//! multi-agent coordination, and automated task orchestration.\n\nuse crate::engines::action_executor::{ActionExecutor, ActionResult};\nuse crate::engines::rule_engine::{RuleExecutionEngine, RuleValue};\nuse crate::entities::{Entity, WorkflowInstance};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::{HashMap, VecDeque};\nuse std::fmt;\nuse uuid::Uuid;\n\n/// Workflow state definition\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\npub struct WorkflowState {\n    pub id: String,\n    pub name: String,\n    pub description: Option\u003cString\u003e,\n    pub is_initial: bool,\n    pub is_final: bool,\n    pub metadata: HashMap\u003cString, String\u003e,\n}\n\n/// Workflow transition between states\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkflowTransition {\n    pub id: String,\n    pub name: String,\n    pub from_state: String,\n    pub to_state: String,\n    pub condition: Option\u003cString\u003e, // Rule expression\n    pub action: Option\u003cString\u003e,    // Action to execute on transition\n    pub description: Option\u003cString\u003e,\n    pub required_permissions: Vec\u003cString\u003e,\n    pub metadata: HashMap\u003cString, String\u003e,\n}\n\n/// Workflow definition containing states and transitions\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkflowDefinition {\n    pub id: String,\n    pub name: String,\n    pub version: String,\n    pub description: Option\u003cString\u003e,\n    pub states: Vec\u003cWorkflowState\u003e,\n    pub transitions: Vec\u003cWorkflowTransition\u003e,\n    pub variables: HashMap\u003cString, RuleValue\u003e,\n    pub created_by: String,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n}\n\n/// Workflow execution context\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkflowExecutionContext {\n    pub variables: HashMap\u003cString, RuleValue\u003e,\n    pub entity_id: Option\u003cString\u003e,\n    pub entity_type: Option\u003cString\u003e,\n    pub executing_agent: String,\n    pub permissions: Vec\u003cString\u003e,\n    pub metadata: HashMap\u003cString, String\u003e,\n}\n\n/// Workflow execution status\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\npub enum WorkflowStatus {\n    Running,\n    Completed,\n    Failed(String),\n    Suspended(String),\n    Cancelled,\n}\n\n/// Workflow execution event for audit trail\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkflowExecutionEvent {\n    pub id: String,\n    pub timestamp: DateTime\u003cUtc\u003e,\n    pub event_type: WorkflowEventType,\n    pub from_state: Option\u003cString\u003e,\n    pub to_state: Option\u003cString\u003e,\n    pub transition_id: Option\u003cString\u003e,\n    pub agent: String,\n    pub message: String,\n    pub metadata: HashMap\u003cString, String\u003e,\n}\n\n/// Types of workflow events\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum WorkflowEventType {\n    Started,\n    Transitioned,\n    ActionExecuted,\n    ConditionEvaluated,\n    Failed,\n    Suspended,\n    Resumed,\n    Completed,\n    Cancelled,\n}\n\n/// Result of workflow operation\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkflowExecutionResult {\n    pub success: bool,\n    pub instance_id: String,\n    pub current_state: String,\n    pub message: String,\n    pub events: Vec\u003cWorkflowExecutionEvent\u003e,\n    pub variables_changed: HashMap\u003cString, RuleValue\u003e,\n}\n\nimpl fmt::Display for WorkflowStatus {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        match self {\n            WorkflowStatus::Running =\u003e write!(f, \"running\"),\n            WorkflowStatus::Completed =\u003e write!(f, \"completed\"),\n            WorkflowStatus::Failed(reason) =\u003e write!(f, \"failed: {}\", reason),\n            WorkflowStatus::Suspended(reason) =\u003e write!(f, \"suspended: {}\", reason),\n            WorkflowStatus::Cancelled =\u003e write!(f, \"cancelled\"),\n        }\n    }\n}\n\n/// Workflow automation engine for state machine execution\npub struct WorkflowAutomationEngine\u003cS: Storage\u003e {\n    #[allow(dead_code)]\n    storage: S,\n    #[allow(dead_code)]\n    rule_engine: RuleExecutionEngine,\n    action_executor: ActionExecutor,\n    active_instances: HashMap\u003cString, WorkflowInstance\u003e,\n    event_queue: VecDeque\u003cWorkflowExecutionEvent\u003e,\n    #[allow(dead_code)]\n    max_execution_steps: usize,\n}\n\n/// Builder for workflow automation engine\npub struct WorkflowEngineBuilder\u003cS: Storage\u003e {\n    storage: Option\u003cS\u003e,\n    rule_engine: Option\u003cRuleExecutionEngine\u003e,\n    action_executor: Option\u003cActionExecutor\u003e,\n    max_execution_steps: usize,\n}\n\nimpl\u003cS: Storage\u003e WorkflowEngineBuilder\u003cS\u003e {\n    pub fn new() -\u003e Self {\n        Self {\n            storage: None,\n            rule_engine: None,\n            action_executor: None,\n            max_execution_steps: 1000, // Default limit to prevent infinite loops\n        }\n    }\n\n    pub fn with_storage(mut self, storage: S) -\u003e Self {\n        self.storage = Some(storage);\n        self\n    }\n\n    pub fn with_rule_engine(mut self, rule_engine: RuleExecutionEngine) -\u003e Self {\n        self.rule_engine = Some(rule_engine);\n        self\n    }\n\n    pub fn with_action_executor(mut self, action_executor: ActionExecutor) -\u003e Self {\n        self.action_executor = Some(action_executor);\n        self\n    }\n\n    pub fn with_max_execution_steps(mut self, max_steps: usize) -\u003e Self {\n        self.max_execution_steps = max_steps;\n        self\n    }\n\n    pub fn build(self) -\u003e Result\u003cWorkflowAutomationEngine\u003cS\u003e, EngramError\u003e {\n        let storage = self\n            .storage\n            .ok_or_else(|| EngramError::Validation(\"Storage is required\".to_string()))?;\n\n        let rule_engine = self.rule_engine.unwrap_or_else(RuleExecutionEngine::new);\n        let action_executor = self\n            .action_executor\n            .unwrap_or_else(|| ActionExecutor::new(true)); // Default: allow external commands\n\n        Ok(WorkflowAutomationEngine {\n            storage,\n            rule_engine,\n            action_executor,\n            active_instances: HashMap::new(),\n            event_queue: VecDeque::new(),\n            max_execution_steps: self.max_execution_steps,\n        })\n    }\n}\n\nimpl\u003cS: Storage\u003e WorkflowAutomationEngine\u003cS\u003e {\n    /// Create a new workflow automation engine\n    pub fn new(storage: S) -\u003e Self {\n        Self {\n            storage,\n            rule_engine: RuleExecutionEngine::new(),\n            action_executor: ActionExecutor::new(true), // Default: allow external commands\n            active_instances: HashMap::new(),\n            event_queue: VecDeque::new(),\n            max_execution_steps: 1000,\n        }\n    }\n\n    /// Create a new workflow definition\n    pub fn create_workflow(\n        \u0026mut self,\n        name: String,\n        description: Option\u003cString\u003e,\n        creator: String,\n    ) -\u003e Result\u003cWorkflowDefinition, EngramError\u003e {\n        let workflow = WorkflowDefinition {\n            id: Uuid::new_v4().to_string(),\n            name,\n            version: \"1.0.0\".to_string(),\n            description,\n            states: Vec::new(),\n            transitions: Vec::new(),\n            variables: HashMap::new(),\n            created_by: creator,\n            created_at: Utc::now(),\n            updated_at: Utc::now(),\n        };\n\n        // Store workflow definition (simplified - would need proper entity storage)\n        // let generic_entity = GenericEntity::from_value(serde_json::to_value(\u0026workflow)?)?;\n        // self.storage.store(\u0026generic_entity)?;\n\n        Ok(workflow)\n    }\n\n    /// Add a state to workflow definition\n    pub fn add_state(\n        \u0026mut self,\n        _workflow_id: \u0026str,\n        name: String,\n        description: Option\u003cString\u003e,\n        is_initial: bool,\n        is_final: bool,\n    ) -\u003e Result\u003cWorkflowState, EngramError\u003e {\n        let state = WorkflowState {\n            id: Uuid::new_v4().to_string(),\n            name,\n            description,\n            is_initial,\n            is_final,\n            metadata: HashMap::new(),\n        };\n\n        // TODO: Update workflow definition in storage\n        // This would require retrieving, modifying, and storing the workflow\n\n        Ok(state)\n    }\n\n    /// Add a transition to workflow definition\n    pub fn add_transition(\n        \u0026mut self,\n        _workflow_id: \u0026str,\n        name: String,\n        from_state: String,\n        to_state: String,\n        condition: Option\u003cString\u003e,\n        action: Option\u003cString\u003e,\n    ) -\u003e Result\u003cWorkflowTransition, EngramError\u003e {\n        let transition = WorkflowTransition {\n            id: Uuid::new_v4().to_string(),\n            name,\n            from_state,\n            to_state,\n            condition,\n            action,\n            description: None,\n            required_permissions: Vec::new(),\n            metadata: HashMap::new(),\n        };\n\n        // TODO: Update workflow definition in storage\n\n        Ok(transition)\n    }\n\n    /// Start a new workflow instance\n    pub fn start_workflow(\n        \u0026mut self,\n        workflow_id: String,\n        entity_id: Option\u003cString\u003e,\n        entity_type: Option\u003cString\u003e,\n        executing_agent: String,\n        initial_variables: HashMap\u003cString, RuleValue\u003e,\n    ) -\u003e Result\u003cWorkflowExecutionResult, EngramError\u003e {\n        // TODO: Retrieve workflow definition from storage\n        // For now, create a simple workflow instance\n\n        let instance_id = Uuid::new_v4().to_string();\n        let now = Utc::now();\n\n        let context = WorkflowExecutionContext {\n            variables: initial_variables,\n            entity_id,\n            entity_type,\n            executing_agent: executing_agent.clone(),\n            permissions: Vec::new(),\n            metadata: HashMap::new(),\n        };\n\n        let start_event = WorkflowExecutionEvent {\n            id: Uuid::new_v4().to_string(),\n            timestamp: now,\n            event_type: WorkflowEventType::Started,\n            from_state: None,\n            to_state: Some(\"initial\".to_string()),\n            transition_id: None,\n            agent: executing_agent.clone(),\n            message: \"Workflow started\".to_string(),\n            metadata: HashMap::new(),\n        };\n\n        let instance = WorkflowInstance {\n            id: instance_id.clone(),\n            workflow_id,\n            current_state: \"initial\".to_string(),\n            context,\n            status: WorkflowStatus::Running,\n            started_at: now,\n            updated_at: now,\n            completed_at: None,\n            execution_history: vec![start_event.clone()],\n        };\n\n        self.active_instances\n            .insert(instance_id.clone(), instance.clone());\n\n        self.storage.store(\u0026instance.to_generic())?;\n\n        Ok(WorkflowExecutionResult {\n            success: true,\n            instance_id,\n            current_state: \"initial\".to_string(),\n            message: \"Workflow started successfully\".to_string(),\n            events: vec![start_event],\n            variables_changed: HashMap::new(),\n        })\n    }\n\n    /// Execute a transition in a workflow instance\n    pub fn execute_transition(\n        \u0026mut self,\n        instance_id: \u0026str,\n        transition_name: String,\n        executing_agent: String,\n    ) -\u003e Result\u003cWorkflowExecutionResult, EngramError\u003e {\n        if !self.active_instances.contains_key(instance_id) {\n            if let Some(generic) = self.storage.get(instance_id, \"workflow_instance\")? {\n                let instance = WorkflowInstance::from_generic(generic)\n                    .map_err(|e| EngramError::Validation(e.to_string()))?;\n                self.active_instances\n                    .insert(instance_id.to_string(), instance);\n            } else {\n                return Err(EngramError::NotFound(format!(\n                    \"Workflow instance {} not found\",\n                    instance_id\n                )));\n            }\n        }\n\n        let current_state = {\n            let instance = self.active_instances.get(instance_id).unwrap();\n            instance.current_state.clone()\n        };\n\n        let new_state = self.determine_next_state(\u0026current_state, \u0026transition_name)?;\n\n        let instance = self.active_instances.get_mut(instance_id).unwrap();\n\n        // Create transition event\n        let transition_event = WorkflowExecutionEvent {\n            id: Uuid::new_v4().to_string(),\n            timestamp: Utc::now(),\n            event_type: WorkflowEventType::Transitioned,\n            from_state: Some(current_state),\n            to_state: Some(new_state.clone()),\n            transition_id: Some(Uuid::new_v4().to_string()),\n            agent: executing_agent,\n            message: format!(\"Transitioned via {}\", transition_name),\n            metadata: HashMap::new(),\n        };\n\n        instance.current_state = new_state.clone();\n        instance.updated_at = Utc::now();\n        instance.execution_history.push(transition_event.clone());\n        if new_state == \"final\" || new_state == \"completed\" {\n            instance.status = WorkflowStatus::Completed;\n            instance.completed_at = Some(Utc::now());\n        }\n\n        self.storage.store(\u0026instance.to_generic())?;\n\n        Ok(WorkflowExecutionResult {\n            success: true,\n            instance_id: instance_id.to_string(),\n            current_state: new_state,\n            message: \"Transition executed successfully\".to_string(),\n            events: vec![transition_event],\n            variables_changed: HashMap::new(),\n        })\n    }\n\n    /// Execute an action defined in a transition\n    pub fn execute_transition_action(\n        \u0026self,\n        action_type: \u0026str,\n        parameters: \u0026HashMap\u003cString, serde_json::Value\u003e,\n    ) -\u003e Result\u003cActionResult, EngramError\u003e {\n        self.action_executor.execute_action(action_type, parameters)\n    }\n\n    /// Get workflow instance status\n    pub fn get_instance_status(\u0026self, instance_id: \u0026str) -\u003e Result\u003cWorkflowInstance, EngramError\u003e {\n        if let Some(instance) = self.active_instances.get(instance_id) {\n            return Ok(instance.clone());\n        }\n\n        if let Some(generic) = self.storage.get(instance_id, \"workflow_instance\")? {\n            return WorkflowInstance::from_generic(generic)\n                .map_err(|e| EngramError::Validation(e.to_string()));\n        }\n\n        Err(EngramError::NotFound(format!(\n            \"Workflow instance {} not found\",\n            instance_id\n        )))\n    }\n\n    /// List all active workflow instances\n    pub fn list_active_instances(\u0026self) -\u003e Vec\u003cWorkflowInstance\u003e {\n        match self.storage.get_all(\"workflow_instance\") {\n            Ok(entities) =\u003e entities\n                .into_iter()\n                .filter_map(|e| WorkflowInstance::from_generic(e).ok())\n                .collect(),\n            Err(_) =\u003e Vec::new(),\n        }\n    }\n\n    /// Cancel a workflow instance\n    pub fn cancel_workflow(\n        \u0026mut self,\n        instance_id: \u0026str,\n        executing_agent: String,\n        reason: String,\n    ) -\u003e Result\u003cWorkflowExecutionResult, EngramError\u003e {\n        if !self.active_instances.contains_key(instance_id) {\n            if let Some(generic) = self.storage.get(instance_id, \"workflow_instance\")? {\n                let instance = WorkflowInstance::from_generic(generic)\n                    .map_err(|e| EngramError::Validation(e.to_string()))?;\n                self.active_instances\n                    .insert(instance_id.to_string(), instance);\n            } else {\n                return Err(EngramError::NotFound(format!(\n                    \"Workflow instance {} not found\",\n                    instance_id\n                )));\n            }\n        }\n\n        let instance = self.active_instances.get_mut(instance_id).unwrap();\n\n        let cancel_event = WorkflowExecutionEvent {\n            id: Uuid::new_v4().to_string(),\n            timestamp: Utc::now(),\n            event_type: WorkflowEventType::Cancelled,\n            from_state: Some(instance.current_state.clone()),\n            to_state: None,\n            transition_id: None,\n            agent: executing_agent,\n            message: format!(\"Workflow cancelled: {}\", reason),\n            metadata: HashMap::new(),\n        };\n\n        instance.status = WorkflowStatus::Cancelled;\n        instance.updated_at = Utc::now();\n        instance.completed_at = Some(Utc::now());\n        instance.execution_history.push(cancel_event.clone());\n\n        self.storage.store(\u0026instance.to_generic())?;\n\n        Ok(WorkflowExecutionResult {\n            success: true,\n            instance_id: instance_id.to_string(),\n            current_state: instance.current_state.clone(),\n            message: \"Workflow cancelled successfully\".to_string(),\n            events: vec![cancel_event],\n            variables_changed: HashMap::new(),\n        })\n    }\n\n    /// Process pending workflow events\n    pub fn process_events(\u0026mut self) -\u003e Result\u003cVec\u003cWorkflowExecutionResult\u003e, EngramError\u003e {\n        let results = Vec::new();\n\n        while let Some(event) = self.event_queue.pop_front() {\n            // Process event based on type\n            match event.event_type {\n                WorkflowEventType::Started =\u003e {\n                    // Handle workflow start events\n                }\n                WorkflowEventType::Transitioned =\u003e {\n                    // Handle transition events\n                }\n                _ =\u003e {\n                    // Handle other event types\n                }\n            }\n        }\n\n        Ok(results)\n    }\n\n    /// Helper method to determine next state based on current state and transition\n    fn determine_next_state(\n        \u0026self,\n        current_state: \u0026str,\n        transition_name: \u0026str,\n    ) -\u003e Result\u003cString, EngramError\u003e {\n        // Simplified state transition logic\n        // In a real implementation, this would consult the workflow definition\n        match (current_state, transition_name) {\n            (\"initial\", \"start\") =\u003e Ok(\"in_progress\".to_string()),\n            (\"in_progress\", \"complete\") =\u003e Ok(\"completed\".to_string()),\n            (\"in_progress\", \"fail\") =\u003e Ok(\"failed\".to_string()),\n            (\"failed\", \"retry\") =\u003e Ok(\"in_progress\".to_string()),\n            _ =\u003e Err(EngramError::Validation(format!(\n                \"Invalid transition '{}' from state '{}'\",\n                transition_name, current_state\n            ))),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::storage::MemoryStorage;\n\n    fn create_test_engine() -\u003e WorkflowAutomationEngine\u003cMemoryStorage\u003e {\n        WorkflowAutomationEngine::new(MemoryStorage::new(\"test-agent\"))\n    }\n\n    #[test]\n    fn test_workflow_engine_creation() {\n        let engine = create_test_engine();\n        assert_eq!(engine.active_instances.len(), 0);\n        assert_eq!(engine.event_queue.len(), 0);\n    }\n\n    #[test]\n    fn test_create_workflow() {\n        let mut engine = create_test_engine();\n\n        let workflow = engine\n            .create_workflow(\n                \"Test Workflow\".to_string(),\n                Some(\"A test workflow\".to_string()),\n                \"test-agent\".to_string(),\n            )\n            .unwrap();\n\n        assert_eq!(workflow.name, \"Test Workflow\");\n        assert_eq!(workflow.version, \"1.0.0\");\n        assert_eq!(workflow.created_by, \"test-agent\");\n    }\n\n    #[test]\n    fn test_start_workflow() {\n        let mut engine = create_test_engine();\n\n        let result = engine\n            .start_workflow(\n                \"test-workflow\".to_string(),\n                Some(\"entity-123\".to_string()),\n                Some(\"Task\".to_string()),\n                \"test-agent\".to_string(),\n                HashMap::new(),\n            )\n            .unwrap();\n\n        assert!(result.success);\n        assert_eq!(result.current_state, \"initial\");\n        assert_eq!(engine.active_instances.len(), 1);\n    }\n\n    #[test]\n    fn test_execute_transition() {\n        let mut engine = create_test_engine();\n\n        // Start a workflow\n        let start_result = engine\n            .start_workflow(\n                \"test-workflow\".to_string(),\n                None,\n                None,\n                \"test-agent\".to_string(),\n                HashMap::new(),\n            )\n            .unwrap();\n\n        // Execute a transition\n        let transition_result = engine\n            .execute_transition(\n                \u0026start_result.instance_id,\n                \"start\".to_string(),\n                \"test-agent\".to_string(),\n            )\n            .unwrap();\n\n        assert!(transition_result.success);\n        assert_eq!(transition_result.current_state, \"in_progress\");\n    }\n\n    #[test]\n    fn test_workflow_completion() {\n        let mut engine = create_test_engine();\n\n        // Start workflow\n        let start_result = engine\n            .start_workflow(\n                \"test-workflow\".to_string(),\n                None,\n                None,\n                \"test-agent\".to_string(),\n                HashMap::new(),\n            )\n            .unwrap();\n\n        // Progress through states\n        engine\n            .execute_transition(\n                \u0026start_result.instance_id,\n                \"start\".to_string(),\n                \"test-agent\".to_string(),\n            )\n            .unwrap();\n\n        let complete_result = engine\n            .execute_transition(\n                \u0026start_result.instance_id,\n                \"complete\".to_string(),\n                \"test-agent\".to_string(),\n            )\n            .unwrap();\n\n        assert_eq!(complete_result.current_state, \"completed\");\n\n        let instance = engine\n            .get_instance_status(\u0026start_result.instance_id)\n            .unwrap();\n        assert_eq!(instance.status, WorkflowStatus::Completed);\n    }\n\n    #[test]\n    fn test_cancel_workflow() {\n        let mut engine = create_test_engine();\n\n        let start_result = engine\n            .start_workflow(\n                \"test-workflow\".to_string(),\n                None,\n                None,\n                \"test-agent\".to_string(),\n                HashMap::new(),\n            )\n            .unwrap();\n\n        let cancel_result = engine\n            .cancel_workflow(\n                \u0026start_result.instance_id,\n                \"test-agent\".to_string(),\n                \"Testing cancellation\".to_string(),\n            )\n            .unwrap();\n\n        assert!(cancel_result.success);\n\n        let instance = engine\n            .get_instance_status(\u0026start_result.instance_id)\n            .unwrap();\n        assert_eq!(instance.status, WorkflowStatus::Cancelled);\n    }\n\n    #[test]\n    fn test_workflow_builder() {\n        let storage = MemoryStorage::new(\"test-agent\");\n        let rule_engine = RuleExecutionEngine::new();\n\n        let engine = WorkflowEngineBuilder::new()\n            .with_storage(storage)\n            .with_rule_engine(rule_engine)\n            .with_max_execution_steps(500)\n            .build()\n            .unwrap();\n\n        assert_eq!(engine.max_execution_steps, 500);\n    }\n\n    #[test]\n    fn test_invalid_transition() {\n        let mut engine = create_test_engine();\n\n        let start_result = engine\n            .start_workflow(\n                \"test-workflow\".to_string(),\n                None,\n                None,\n                \"test-agent\".to_string(),\n                HashMap::new(),\n            )\n            .unwrap();\n\n        // Try invalid transition\n        let result = engine.execute_transition(\n            \u0026start_result.instance_id,\n            \"invalid_transition\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        assert!(result.is_err());\n        match result {\n            Err(EngramError::Validation(msg)) =\u003e {\n                assert!(msg.contains(\"Invalid transition\"));\n            }\n            _ =\u003e panic!(\"Expected ValidationError\"),\n        }\n    }\n\n    #[test]\n    fn test_list_active_instances() {\n        let mut engine = create_test_engine();\n\n        // Start multiple workflows\n        engine\n            .start_workflow(\n                \"workflow-1\".to_string(),\n                None,\n                None,\n                \"agent-1\".to_string(),\n                HashMap::new(),\n            )\n            .unwrap();\n\n        engine\n            .start_workflow(\n                \"workflow-2\".to_string(),\n                None,\n                None,\n                \"agent-2\".to_string(),\n                HashMap::new(),\n            )\n            .unwrap();\n\n        let instances = engine.list_active_instances();\n        assert_eq!(instances.len(), 2);\n    }\n}\n","traces":[{"line":118,"address":[25388304],"length":1,"stats":{"Line":0}},{"line":119,"address":[19336081],"length":1,"stats":{"Line":0}},{"line":120,"address":[19696240],"length":1,"stats":{"Line":0}},{"line":121,"address":[18257644],"length":1,"stats":{"Line":0}},{"line":122,"address":[18198445],"length":1,"stats":{"Line":0}},{"line":123,"address":[18198590],"length":1,"stats":{"Line":0}},{"line":124,"address":[18257975],"length":1,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":1}},{"line":160,"address":[],"length":0,"stats":{"Line":1}},{"line":161,"address":[],"length":0,"stats":{"Line":2}},{"line":162,"address":[17468279],"length":1,"stats":{"Line":1}},{"line":165,"address":[],"length":0,"stats":{"Line":1}},{"line":166,"address":[],"length":0,"stats":{"Line":2}},{"line":167,"address":[17468504],"length":1,"stats":{"Line":1}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":1}},{"line":176,"address":[17468561],"length":1,"stats":{"Line":1}},{"line":177,"address":[],"length":0,"stats":{"Line":1}},{"line":180,"address":[],"length":0,"stats":{"Line":1}},{"line":181,"address":[],"length":0,"stats":{"Line":2}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[17470238,17468921,17470224,17469034],"length":1,"stats":{"Line":1}},{"line":185,"address":[],"length":0,"stats":{"Line":2}},{"line":186,"address":[],"length":0,"stats":{"Line":1}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[17470320,17469490,17470332],"length":1,"stats":{"Line":3}},{"line":190,"address":[17469839],"length":1,"stats":{"Line":1}},{"line":191,"address":[],"length":0,"stats":{"Line":1}},{"line":192,"address":[],"length":0,"stats":{"Line":1}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[17469724],"length":1,"stats":{"Line":1}},{"line":195,"address":[],"length":0,"stats":{"Line":1}},{"line":196,"address":[17469828],"length":1,"stats":{"Line":1}},{"line":203,"address":[],"length":0,"stats":{"Line":2}},{"line":206,"address":[17487110,17486630],"length":1,"stats":{"Line":6}},{"line":207,"address":[17486687,17487167],"length":1,"stats":{"Line":2}},{"line":208,"address":[14659731],"length":1,"stats":{"Line":6}},{"line":209,"address":[14659746],"length":1,"stats":{"Line":2}},{"line":215,"address":[17479358,17478208,17479235],"length":1,"stats":{"Line":1}},{"line":222,"address":[],"length":0,"stats":{"Line":2}},{"line":224,"address":[],"length":0,"stats":{"Line":1}},{"line":226,"address":[],"length":0,"stats":{"Line":1}},{"line":227,"address":[],"length":0,"stats":{"Line":1}},{"line":228,"address":[17478648],"length":1,"stats":{"Line":1}},{"line":230,"address":[17478727],"length":1,"stats":{"Line":1}},{"line":231,"address":[17478790],"length":1,"stats":{"Line":1}},{"line":238,"address":[],"length":0,"stats":{"Line":1}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[14644304,14647924,14648375],"length":1,"stats":{"Line":4}},{"line":304,"address":[17470415,17470571],"length":1,"stats":{"Line":5}},{"line":305,"address":[],"length":0,"stats":{"Line":1}},{"line":311,"address":[17470785],"length":1,"stats":{"Line":4}},{"line":312,"address":[],"length":0,"stats":{"Line":1}},{"line":313,"address":[17470916],"length":1,"stats":{"Line":4}},{"line":317,"address":[14645152,14645212],"length":1,"stats":{"Line":5}},{"line":321,"address":[14645257,14645337],"length":1,"stats":{"Line":5}},{"line":323,"address":[17471431],"length":1,"stats":{"Line":1}},{"line":324,"address":[14645450],"length":1,"stats":{"Line":4}},{"line":325,"address":[14645522],"length":1,"stats":{"Line":1}},{"line":329,"address":[17471908],"length":1,"stats":{"Line":4}},{"line":331,"address":[],"length":0,"stats":{"Line":1}},{"line":337,"address":[17474057,17472212,17472155],"length":1,"stats":{"Line":5}},{"line":340,"address":[17472704,17472853],"length":1,"stats":{"Line":5}},{"line":341,"address":[17472779,17472885,17472715,17474035],"length":1,"stats":{"Line":9}},{"line":343,"address":[17473942,17472931],"length":1,"stats":{"Line":1}},{"line":345,"address":[14647605],"length":1,"stats":{"Line":6}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[17473150],"length":1,"stats":{"Line":6}},{"line":348,"address":[],"length":0,"stats":{"Line":6}},{"line":349,"address":[17473259],"length":1,"stats":{"Line":6}},{"line":350,"address":[14647329,14647382],"length":1,"stats":{"Line":12}},{"line":351,"address":[],"length":0,"stats":{"Line":6}},{"line":356,"address":[14652304,14653510,14657197],"length":1,"stats":{"Line":3}},{"line":362,"address":[14653483,14652401,14652534],"length":1,"stats":{"Line":4}},{"line":363,"address":[17479636,17479745,17480831],"length":1,"stats":{"Line":0}},{"line":364,"address":[14652985,14653089,14653180],"length":1,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[14653543,14653020],"length":1,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[17479688,17480844],"length":1,"stats":{"Line":6}},{"line":378,"address":[],"length":0,"stats":{"Line":3}},{"line":381,"address":[14657043,14653843,14653929],"length":1,"stats":{"Line":7}},{"line":383,"address":[14654205,14654286],"length":1,"stats":{"Line":4}},{"line":387,"address":[14654318],"length":1,"stats":{"Line":1}},{"line":388,"address":[],"length":0,"stats":{"Line":2}},{"line":390,"address":[14654427],"length":1,"stats":{"Line":2}},{"line":391,"address":[],"length":0,"stats":{"Line":4}},{"line":392,"address":[],"length":0,"stats":{"Line":4}},{"line":394,"address":[],"length":0,"stats":{"Line":4}},{"line":395,"address":[],"length":0,"stats":{"Line":2}},{"line":398,"address":[17482425,17482352],"length":1,"stats":{"Line":4}},{"line":399,"address":[],"length":0,"stats":{"Line":2}},{"line":400,"address":[17482586],"length":1,"stats":{"Line":2}},{"line":401,"address":[17482730,17482948,17482640],"length":1,"stats":{"Line":5}},{"line":402,"address":[14655712,14655647],"length":1,"stats":{"Line":1}},{"line":403,"address":[],"length":0,"stats":{"Line":1}},{"line":406,"address":[14656892,14655685,14655909],"length":1,"stats":{"Line":4}},{"line":408,"address":[17483592],"length":1,"stats":{"Line":2}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[17483171],"length":1,"stats":{"Line":2}},{"line":411,"address":[],"length":0,"stats":{"Line":2}},{"line":412,"address":[14656210],"length":1,"stats":{"Line":2}},{"line":413,"address":[],"length":0,"stats":{"Line":4}},{"line":414,"address":[],"length":0,"stats":{"Line":2}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[17484384],"length":1,"stats":{"Line":1}},{"line":429,"address":[17484430],"length":1,"stats":{"Line":1}},{"line":430,"address":[14657474],"length":1,"stats":{"Line":1}},{"line":433,"address":[17484534,17484643],"length":1,"stats":{"Line":0}},{"line":434,"address":[17484789],"length":1,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[17484833],"length":1,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[17486425,17486160,17486450],"length":1,"stats":{"Line":1}},{"line":446,"address":[14659161],"length":1,"stats":{"Line":1}},{"line":447,"address":[],"length":0,"stats":{"Line":2}},{"line":449,"address":[14659476,14659328,14659440],"length":1,"stats":{"Line":3}},{"line":451,"address":[14659214,14659381],"length":1,"stats":{"Line":0}},{"line":456,"address":[14649558,14648416,14652121],"length":1,"stats":{"Line":1}},{"line":462,"address":[14648606,14649531,14648495],"length":1,"stats":{"Line":2}},{"line":463,"address":[17474585,17475753,17474688],"length":1,"stats":{"Line":0}},{"line":464,"address":[14649237,14649045,14649149],"length":1,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[17475301],"length":1,"stats":{"Line":0}},{"line":467,"address":[17475388,17475312],"length":1,"stats":{"Line":0}},{"line":469,"address":[14649080,14649591],"length":1,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":2}},{"line":479,"address":[],"length":0,"stats":{"Line":1}},{"line":480,"address":[14649889],"length":1,"stats":{"Line":1}},{"line":482,"address":[17475909],"length":1,"stats":{"Line":1}},{"line":486,"address":[17476031,17476102],"length":1,"stats":{"Line":2}},{"line":487,"address":[17476210],"length":1,"stats":{"Line":1}},{"line":490,"address":[14650604],"length":1,"stats":{"Line":1}},{"line":491,"address":[17476675,17476740],"length":1,"stats":{"Line":2}},{"line":492,"address":[],"length":0,"stats":{"Line":1}},{"line":493,"address":[],"length":0,"stats":{"Line":1}},{"line":495,"address":[14650969,14651965],"length":1,"stats":{"Line":1}},{"line":497,"address":[14651681],"length":1,"stats":{"Line":1}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[14651216],"length":1,"stats":{"Line":1}},{"line":500,"address":[14651256],"length":1,"stats":{"Line":1}},{"line":501,"address":[17477243],"length":1,"stats":{"Line":1}},{"line":502,"address":[17477378,17477325],"length":1,"stats":{"Line":2}},{"line":503,"address":[14651625],"length":1,"stats":{"Line":1}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[17485232],"length":1,"stats":{"Line":3}},{"line":537,"address":[],"length":0,"stats":{"Line":3}},{"line":538,"address":[17485381,17486085,17485317],"length":1,"stats":{"Line":8}},{"line":539,"address":[14658431,14658915,14658324],"length":1,"stats":{"Line":3}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":1}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}}],"covered":116,"coverable":176},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","adr.rs"],"content":"//! Architecture Decision Record (ADR) entity implementation\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// ADR status variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum AdrStatus {\n    Proposed,\n    Accepted,\n    Deprecated,\n    Superseded,\n}\n\n/// Decision outcome\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum DecisionOutcome {\n    Accepted,\n    Rejected,\n    Deferred,\n}\n\n/// Architecture Decision Record entity\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct ADR {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// ADR title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Sequential number\n    #[serde(rename = \"number\")]\n    pub number: u32,\n\n    /// Current status\n    #[serde(rename = \"status\")]\n    pub status: AdrStatus,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Creation timestamp\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// Last updated timestamp\n    #[serde(rename = \"updated_at\")]\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    /// Decision date\n    #[serde(rename = \"decision_date\")]\n    pub decision_date: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    /// Context and problem statement\n    #[serde(rename = \"context\")]\n    pub context: String,\n\n    /// Decision description\n    #[serde(rename = \"decision\")]\n    pub decision: String,\n\n    /// Consequences of the decision\n    #[serde(rename = \"consequences\")]\n    pub consequences: String,\n\n    /// Alternative options considered\n    #[serde(\n        rename = \"alternatives\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub alternatives: Vec\u003cAlternative\u003e,\n\n    /// Implementation notes\n    #[serde(rename = \"implementation\", skip_serializing_if = \"Option::is_none\")]\n    pub implementation: Option\u003cString\u003e,\n\n    /// Related ADRs\n    #[serde(\n        rename = \"related_adrs\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub related_adrs: Vec\u003cString\u003e,\n\n    /// Superseded by (if applicable)\n    #[serde(rename = \"superseded_by\", skip_serializing_if = \"Option::is_none\")]\n    pub superseded_by: Option\u003cString\u003e,\n\n    /// Supersedes (if applicable)\n    #[serde(rename = \"supersedes\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub supersedes: Vec\u003cString\u003e,\n\n    /// Stakeholders involved\n    #[serde(\n        rename = \"stakeholders\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub stakeholders: Vec\u003cString\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\n/// Alternative option considered\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct Alternative {\n    /// Alternative identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Alternative description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Pros of this alternative\n    #[serde(rename = \"pros\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub pros: Vec\u003cString\u003e,\n\n    /// Cons of this alternative\n    #[serde(rename = \"cons\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub cons: Vec\u003cString\u003e,\n\n    /// Why this alternative was not chosen\n    #[serde(rename = \"rejection_reason\")]\n    pub rejection_reason: Option\u003cString\u003e,\n}\n\nimpl ADR {\n    /// Create a new ADR\n    pub fn new(title: String, number: u32, agent: String, context: String) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            number,\n            status: AdrStatus::Proposed,\n            agent,\n            created_at: now,\n            updated_at: now,\n            decision_date: None,\n            context,\n            decision: String::new(),\n            consequences: String::new(),\n            alternatives: Vec::new(),\n            implementation: None,\n            related_adrs: Vec::new(),\n            superseded_by: None,\n            supersedes: Vec::new(),\n            stakeholders: Vec::new(),\n            tags: Vec::new(),\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Accept the decision\n    pub fn accept(\u0026mut self, decision: String, consequences: String) {\n        self.status = AdrStatus::Accepted;\n        self.decision = decision;\n        self.consequences = consequences;\n        self.decision_date = Some(Utc::now());\n        self.updated_at = Utc::now();\n    }\n\n    /// Reject the decision\n    pub fn reject(\u0026mut self) {\n        self.status = AdrStatus::Deprecated;\n        self.decision_date = Some(Utc::now());\n        self.updated_at = Utc::now();\n    }\n\n    /// Deprecate ADR\n    pub fn deprecate(\u0026mut self, superseded_by: Option\u003cString\u003e) {\n        self.status = AdrStatus::Deprecated;\n        self.superseded_by = superseded_by;\n        self.updated_at = Utc::now();\n    }\n\n    /// Add an alternative\n    pub fn add_alternative(\u0026mut self, description: String) -\u003e String {\n        let id = Uuid::new_v4().to_string();\n        let alternative = Alternative {\n            id: id.clone(),\n            description,\n            pros: Vec::new(),\n            cons: Vec::new(),\n            rejection_reason: None,\n        };\n        self.alternatives.push(alternative);\n        self.updated_at = Utc::now();\n        id\n    }\n\n    /// Add pro to alternative\n    pub fn add_pro_to_alternative(\u0026mut self, alternative_id: \u0026str, pro: String) {\n        if let Some(alternative) = self\n            .alternatives\n            .iter_mut()\n            .find(|alt| alt.id == alternative_id)\n        {\n            alternative.pros.push(pro);\n            self.updated_at = Utc::now();\n        }\n    }\n\n    /// Add con to alternative\n    pub fn add_con_to_alternative(\u0026mut self, alternative_id: \u0026str, con: String) {\n        if let Some(alternative) = self\n            .alternatives\n            .iter_mut()\n            .find(|alt| alt.id == alternative_id)\n        {\n            alternative.cons.push(con);\n            self.updated_at = Utc::now();\n        }\n    }\n\n    /// Set implementation notes\n    pub fn set_implementation(\u0026mut self, implementation: String) {\n        self.implementation = Some(implementation);\n        self.updated_at = Utc::now();\n    }\n\n    /// Add related ADR\n    pub fn add_related_adr(\u0026mut self, adr_id: String) {\n        if !self.related_adrs.contains(\u0026adr_id) {\n            self.related_adrs.push(adr_id);\n            self.updated_at = Utc::now();\n        }\n    }\n\n    /// Add stakeholder\n    pub fn add_stakeholder(\u0026mut self, stakeholder: String) {\n        if !self.stakeholders.contains(\u0026stakeholder) {\n            self.stakeholders.push(stakeholder);\n            self.updated_at = Utc::now();\n        }\n    }\n}\n\nimpl Entity for ADR {\n    fn entity_type() -\u003e \u0026'static str {\n        \"adr\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cADR as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"ADR title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.context.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"ADR context cannot be empty\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize ADR: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":151,"address":[17714160,17715791,17715631],"length":1,"stats":{"Line":0}},{"line":152,"address":[17725723],"length":1,"stats":{"Line":0}},{"line":154,"address":[19245140],"length":1,"stats":{"Line":0}},{"line":163,"address":[19245301],"length":1,"stats":{"Line":0}},{"line":164,"address":[24845296],"length":1,"stats":{"Line":0}},{"line":165,"address":[19024448],"length":1,"stats":{"Line":0}},{"line":167,"address":[19144654],"length":1,"stats":{"Line":0}},{"line":169,"address":[19245563],"length":1,"stats":{"Line":0}},{"line":170,"address":[17726318],"length":1,"stats":{"Line":0}},{"line":171,"address":[17655610],"length":1,"stats":{"Line":0}},{"line":172,"address":[17655670],"length":1,"stats":{"Line":0}},{"line":177,"address":[19026115,19025696,19026089],"length":1,"stats":{"Line":0}},{"line":178,"address":[19246664],"length":1,"stats":{"Line":0}},{"line":179,"address":[19246681],"length":1,"stats":{"Line":0}},{"line":180,"address":[24846732],"length":1,"stats":{"Line":0}},{"line":181,"address":[19246899,19246945],"length":1,"stats":{"Line":0}},{"line":182,"address":[24846937],"length":1,"stats":{"Line":0}},{"line":186,"address":[19247072],"length":1,"stats":{"Line":0}},{"line":187,"address":[24386365],"length":1,"stats":{"Line":0}},{"line":188,"address":[17512916],"length":1,"stats":{"Line":0}},{"line":189,"address":[24386427],"length":1,"stats":{"Line":0}},{"line":193,"address":[24847152,24847236],"length":1,"stats":{"Line":0}},{"line":194,"address":[17727922],"length":1,"stats":{"Line":0}},{"line":195,"address":[19247225,19247319],"length":1,"stats":{"Line":0}},{"line":196,"address":[17716535],"length":1,"stats":{"Line":0}},{"line":200,"address":[19022352,19022380,19021712],"length":1,"stats":{"Line":0}},{"line":201,"address":[17508515,17508588],"length":1,"stats":{"Line":0}},{"line":203,"address":[19021841],"length":1,"stats":{"Line":0}},{"line":205,"address":[19242931],"length":1,"stats":{"Line":0}},{"line":206,"address":[19242994],"length":1,"stats":{"Line":0}},{"line":209,"address":[24843129],"length":1,"stats":{"Line":0}},{"line":210,"address":[17509024],"length":1,"stats":{"Line":0}},{"line":211,"address":[19142446],"length":1,"stats":{"Line":0}},{"line":215,"address":[17725264,17725641,17725670],"length":1,"stats":{"Line":0}},{"line":216,"address":[17713944,17714098,17713779,17713905],"length":1,"stats":{"Line":0}},{"line":219,"address":[17510555],"length":1,"stats":{"Line":0}},{"line":221,"address":[19244831],"length":1,"stats":{"Line":0}},{"line":222,"address":[19023924],"length":1,"stats":{"Line":0}},{"line":227,"address":[17510345,17509968,17510374],"length":1,"stats":{"Line":0}},{"line":228,"address":[17510003,17510129,17510168,17510322],"length":1,"stats":{"Line":0}},{"line":231,"address":[23696464,23696481],"length":1,"stats":{"Line":0}},{"line":233,"address":[17713579],"length":1,"stats":{"Line":0}},{"line":234,"address":[24844404],"length":1,"stats":{"Line":0}},{"line":239,"address":[24383306,24383216],"length":1,"stats":{"Line":0}},{"line":240,"address":[19143134,19143241],"length":1,"stats":{"Line":0}},{"line":241,"address":[19023149],"length":1,"stats":{"Line":0}},{"line":245,"address":[19142800,19142544,19142826],"length":1,"stats":{"Line":0}},{"line":246,"address":[24843331,24843416,24843548],"length":1,"stats":{"Line":0}},{"line":247,"address":[19142683],"length":1,"stats":{"Line":0}},{"line":248,"address":[17724257],"length":1,"stats":{"Line":0}},{"line":253,"address":[19022704,19022986,19022960],"length":1,"stats":{"Line":0}},{"line":254,"address":[17724588,17724371,17724456],"length":1,"stats":{"Line":0}},{"line":255,"address":[24383067],"length":1,"stats":{"Line":0}},{"line":256,"address":[24383121],"length":1,"stats":{"Line":0}},{"line":266,"address":[17514976],"length":1,"stats":{"Line":0}},{"line":267,"address":[19249125],"length":1,"stats":{"Line":0}},{"line":270,"address":[17729872],"length":1,"stats":{"Line":0}},{"line":271,"address":[19028229],"length":1,"stats":{"Line":0}},{"line":274,"address":[17718384],"length":1,"stats":{"Line":0}},{"line":275,"address":[19249176],"length":1,"stats":{"Line":0}},{"line":278,"address":[24848208,24848812,24848818],"length":1,"stats":{"Line":0}},{"line":279,"address":[17514110],"length":1,"stats":{"Line":0}},{"line":283,"address":[16823678,16823664],"length":1,"stats":{"Line":0}},{"line":284,"address":[24387825],"length":1,"stats":{"Line":0}},{"line":285,"address":[18457107],"length":1,"stats":{"Line":0}},{"line":287,"address":[18307383],"length":1,"stats":{"Line":0}},{"line":288,"address":[24157936,24157890,24157952],"length":1,"stats":{"Line":0}},{"line":289,"address":[16823783],"length":1,"stats":{"Line":0}},{"line":292,"address":[17514486],"length":1,"stats":{"Line":0}},{"line":295,"address":[17514211],"length":1,"stats":{"Line":0}},{"line":296,"address":[19148118],"length":1,"stats":{"Line":0}},{"line":297,"address":[17718087],"length":1,"stats":{"Line":0}},{"line":301,"address":[19148068],"length":1,"stats":{"Line":0}},{"line":302,"address":[24388345],"length":1,"stats":{"Line":0}},{"line":303,"address":[24388314],"length":1,"stats":{"Line":0}},{"line":307,"address":[24388302],"length":1,"stats":{"Line":0}},{"line":310,"address":[19026929,19026935,19026464],"length":1,"stats":{"Line":0}},{"line":312,"address":[24847389],"length":1,"stats":{"Line":0}},{"line":313,"address":[17728227,17728155],"length":1,"stats":{"Line":0}},{"line":314,"address":[24847495],"length":1,"stats":{"Line":0}},{"line":315,"address":[17657541],"length":1,"stats":{"Line":0}},{"line":316,"address":[17716811,17716868],"length":1,"stats":{"Line":0}},{"line":320,"address":[19027249,19026976],"length":1,"stats":{"Line":0}},{"line":321,"address":[19247925,19248019],"length":1,"stats":{"Line":0}},{"line":322,"address":[17038299,17038367],"length":1,"stats":{"Line":0}},{"line":326,"address":[19028240],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":86},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","agent_sandbox.rs"],"content":"//! Agent Sandbox entity implementation\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::time::Duration;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Sandbox levels for agents\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum SandboxLevel {\n    /// Full system access\n    Unrestricted,\n    /// Normal development access  \n    Standard,\n    /// Limited access, requires approval for sensitive operations\n    Restricted,\n    /// Heavily restricted, read-only for most operations\n    Isolated,\n    /// Safe environment for learning agents\n    Training,\n}\n\n/// Permission set for an agent\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct PermissionSet {\n    /// Commands the agent is allowed to run\n    pub allowed_commands: Vec\u003cCommandPermission\u003e,\n    /// Paths the agent cannot access\n    pub forbidden_paths: Vec\u003cPathRestriction\u003e,\n    /// File operations the agent can perform\n    pub allowed_file_operations: Vec\u003cFileOperation\u003e,\n    /// Network access policy\n    pub network_access: NetworkPolicy,\n    /// Quality gate permissions\n    pub quality_gate_permissions: Vec\u003cQualityGatePermission\u003e,\n    /// Workflow permissions\n    pub workflow_permissions: WorkflowPermissions,\n}\n\n/// Resource limits for an agent\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct ResourceLimits {\n    /// Maximum memory usage in MB\n    #[validate(range(min = 1, max = 16384))]\n    pub max_memory_mb: u64,\n    /// Maximum CPU percentage\n    #[validate(range(min = 1, max = 100))]\n    pub max_cpu_percentage: u32,\n    /// Maximum disk space usage in MB\n    #[validate(range(min = 1, max = 1048576))]\n    pub max_disk_space_mb: u64,\n    /// Maximum execution time in minutes\n    #[validate(range(min = 1, max = 1440))]\n    pub max_execution_time_minutes: u32,\n    /// Maximum concurrent operations\n    #[validate(range(min = 1, max = 100))]\n    pub max_concurrent_operations: u32,\n    /// Maximum file size in MB\n    #[validate(range(min = 1, max = 1024))]\n    pub max_file_size_mb: u64,\n    /// Maximum network requests per minute\n    #[validate(range(min = 1, max = 1000))]\n    pub max_network_requests_per_minute: u32,\n}\n\n/// Command filtering configuration\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct CommandFilter {\n    /// Whether to use whitelist mode (only allow listed commands)\n    pub whitelist_mode: bool,\n    /// Allowed command patterns\n    pub allowed_commands: Vec\u003cCommandPattern\u003e,\n    /// Forbidden command patterns\n    pub forbidden_commands: Vec\u003cCommandPattern\u003e,\n    /// Parameter restrictions for commands\n    pub parameter_restrictions: HashMap\u003cString, ParameterRestriction\u003e,\n    /// Dangerous patterns to watch for\n    pub dangerous_patterns: Vec\u003cDangerousPattern\u003e,\n}\n\n/// Command patterns for filtering\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(tag = \"type\", rename_all = \"lowercase\")]\npub enum CommandPattern {\n    /// Exact command match\n    Exact { command: String },\n    /// Command prefix match\n    Prefix { prefix: String },\n    /// Regular expression match\n    Regex { pattern: String },\n    /// Built-in command type\n    Builtin { command_type: BuiltinCommandType },\n}\n\n/// Built-in command types\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"snake_case\")]\npub enum BuiltinCommandType {\n    Git,\n    Cargo,\n    Engram,\n    FileSystem,\n    Network,\n    System,\n}\n\n/// Escalation policy for handling restricted operations\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct EscalationPolicy {\n    /// Automatically approve operations deemed safe\n    pub auto_approve_safe_operations: bool,\n    /// Operations that require human approval\n    pub require_human_approval: Vec\u003cOperationType\u003e,\n    /// Timeout for escalation requests\n    #[serde(with = \"duration_serde\")]\n    pub escalation_timeout: Duration,\n    /// Action to take when escalation times out\n    pub fallback_action: FallbackAction,\n    /// Notification channels for escalations\n    pub notification_channels: Vec\u003cString\u003e,\n}\n\n/// Types of operations that can be escalated\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"snake_case\")]\npub enum OperationType {\n    FileWrite,\n    FileDelete,\n    CommandExecution,\n    NetworkAccess,\n    ConfigChange,\n    DatabaseOperation,\n    SystemFileAccess,\n    PrivilegedOperation,\n}\n\n/// Fallback actions for escalation timeouts\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum FallbackAction {\n    Deny,\n    Allow,\n    Defer,\n}\n\n/// Command permissions\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CommandPermission {\n    pub pattern: CommandPattern,\n    pub description: String,\n    pub risk_level: RiskLevel,\n}\n\n/// Path restrictions\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PathRestriction {\n    pub pattern: String,\n    pub reason: String,\n    pub escalation_allowed: bool,\n}\n\n/// File operations\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"snake_case\")]\npub enum FileOperation {\n    Read,\n    Write,\n    Create,\n    Delete,\n    Execute,\n    WriteTemp,\n    WriteNonConfig,\n    DeleteNonSystem,\n}\n\n/// Network access policies\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"snake_case\")]\npub enum NetworkPolicy {\n    Denied,\n    InternalOnly,\n    AllowedWithMonitoring,\n    Unrestricted,\n}\n\n/// Quality gate permissions\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct QualityGatePermission {\n    pub gate_name: String,\n    pub allowed: bool,\n    pub requires_approval: bool,\n}\n\n/// Workflow permissions\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkflowPermissions {\n    pub can_create_workflows: bool,\n    pub can_modify_workflows: bool,\n    pub can_execute_workflows: bool,\n    pub restricted_workflow_types: Vec\u003cString\u003e,\n}\n\n/// Parameter restrictions for commands\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ParameterRestriction {\n    pub allowed_values: Vec\u003cString\u003e,\n    pub forbidden_values: Vec\u003cString\u003e,\n    pub max_length: Option\u003cusize\u003e,\n    pub pattern_validation: Option\u003cString\u003e,\n}\n\n/// Dangerous patterns to detect\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct DangerousPattern {\n    pub pattern: String,\n    pub description: String,\n    pub risk_level: RiskLevel,\n    pub auto_block: bool,\n}\n\n/// Risk levels\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum RiskLevel {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\n/// Agent Sandbox entity\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct AgentSandbox {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Agent this sandbox applies to\n    #[serde(rename = \"agent_id\")]\n    #[validate(length(min = 1))]\n    pub agent_id: String,\n\n    /// Sandbox level\n    #[serde(rename = \"sandbox_level\")]\n    pub sandbox_level: SandboxLevel,\n\n    /// Permission set\n    #[serde(rename = \"permissions\")]\n    #[validate]\n    pub permissions: PermissionSet,\n\n    /// Resource limits\n    #[serde(rename = \"resource_limits\")]\n    #[validate]\n    pub resource_limits: ResourceLimits,\n\n    /// Command filter\n    #[serde(rename = \"command_filter\")]\n    #[validate]\n    pub command_filter: CommandFilter,\n\n    /// Escalation policy\n    #[serde(rename = \"escalation_policy\")]\n    #[validate]\n    pub escalation_policy: EscalationPolicy,\n\n    /// Who created this sandbox\n    #[serde(rename = \"created_by\")]\n    #[validate(length(min = 1))]\n    pub created_by: String,\n\n    /// Creation timestamp\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// Last modification timestamp\n    #[serde(rename = \"last_modified\")]\n    pub last_modified: DateTime\u003cUtc\u003e,\n\n    /// Number of violations\n    #[serde(rename = \"violation_count\")]\n    pub violation_count: u32,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\nimpl AgentSandbox {\n    /// Create a new agent sandbox\n    pub fn new(\n        agent_id: String,\n        sandbox_level: SandboxLevel,\n        created_by: String,\n        agent: String,\n    ) -\u003e Self {\n        let now = Utc::now();\n\n        let (permissions, resource_limits, command_filter, escalation_policy) =\n            Self::default_config_for_level(\u0026sandbox_level);\n\n        Self {\n            id: Uuid::new_v4().to_string(),\n            agent_id,\n            sandbox_level,\n            permissions,\n            resource_limits,\n            command_filter,\n            escalation_policy,\n            created_by,\n            created_at: now,\n            last_modified: now,\n            violation_count: 0,\n            agent,\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Get default configuration for a sandbox level\n    pub fn default_config_for_level(\n        level: \u0026SandboxLevel,\n    ) -\u003e (\n        PermissionSet,\n        ResourceLimits,\n        CommandFilter,\n        EscalationPolicy,\n    ) {\n        match level {\n            SandboxLevel::Training =\u003e Self::training_config(),\n            SandboxLevel::Restricted =\u003e Self::restricted_config(),\n            SandboxLevel::Standard =\u003e Self::standard_config(),\n            SandboxLevel::Isolated =\u003e Self::isolated_config(),\n            SandboxLevel::Unrestricted =\u003e Self::unrestricted_config(),\n        }\n    }\n\n    /// Training sandbox configuration\n    fn training_config() -\u003e (\n        PermissionSet,\n        ResourceLimits,\n        CommandFilter,\n        EscalationPolicy,\n    ) {\n        let permissions = PermissionSet {\n            allowed_commands: vec![\n                CommandPermission {\n                    pattern: CommandPattern::Exact {\n                        command: \"cargo check\".to_string(),\n                    },\n                    description: \"Run cargo check\".to_string(),\n                    risk_level: RiskLevel::Low,\n                },\n                CommandPermission {\n                    pattern: CommandPattern::Exact {\n                        command: \"cargo test --lib\".to_string(),\n                    },\n                    description: \"Run library tests\".to_string(),\n                    risk_level: RiskLevel::Low,\n                },\n                CommandPermission {\n                    pattern: CommandPattern::Exact {\n                        command: \"git status\".to_string(),\n                    },\n                    description: \"Check git status\".to_string(),\n                    risk_level: RiskLevel::Low,\n                },\n            ],\n            forbidden_paths: vec![\n                PathRestriction {\n                    pattern: \"/etc/*\".to_string(),\n                    reason: \"System configuration files\".to_string(),\n                    escalation_allowed: false,\n                },\n                PathRestriction {\n                    pattern: \"*/src/security/*\".to_string(),\n                    reason: \"Security-sensitive code\".to_string(),\n                    escalation_allowed: true,\n                },\n            ],\n            allowed_file_operations: vec![FileOperation::Read, FileOperation::WriteTemp],\n            network_access: NetworkPolicy::Denied,\n            quality_gate_permissions: vec![],\n            workflow_permissions: WorkflowPermissions {\n                can_create_workflows: false,\n                can_modify_workflows: false,\n                can_execute_workflows: false,\n                restricted_workflow_types: vec![\"security\".to_string()],\n            },\n        };\n\n        let resource_limits = ResourceLimits {\n            max_memory_mb: 512,\n            max_cpu_percentage: 25,\n            max_disk_space_mb: 1024,\n            max_execution_time_minutes: 10,\n            max_concurrent_operations: 2,\n            max_file_size_mb: 10,\n            max_network_requests_per_minute: 0,\n        };\n\n        let command_filter = CommandFilter {\n            whitelist_mode: true,\n            allowed_commands: vec![\n                CommandPattern::Builtin {\n                    command_type: BuiltinCommandType::Cargo,\n                },\n                CommandPattern::Builtin {\n                    command_type: BuiltinCommandType::Git,\n                },\n                CommandPattern::Builtin {\n                    command_type: BuiltinCommandType::Engram,\n                },\n            ],\n            forbidden_commands: vec![],\n            parameter_restrictions: HashMap::new(),\n            dangerous_patterns: vec![],\n        };\n\n        let escalation_policy = EscalationPolicy {\n            auto_approve_safe_operations: false,\n            require_human_approval: vec![OperationType::FileWrite, OperationType::CommandExecution],\n            escalation_timeout: Duration::from_secs(3600), // 1 hour\n            fallback_action: FallbackAction::Deny,\n            notification_channels: vec![\"training-supervisor\".to_string()],\n        };\n\n        (\n            permissions,\n            resource_limits,\n            command_filter,\n            escalation_policy,\n        )\n    }\n\n    /// Restricted sandbox configuration\n    fn restricted_config() -\u003e (\n        PermissionSet,\n        ResourceLimits,\n        CommandFilter,\n        EscalationPolicy,\n    ) {\n        let permissions = PermissionSet {\n            allowed_commands: vec![\n                CommandPermission {\n                    pattern: CommandPattern::Prefix {\n                        prefix: \"cargo\".to_string(),\n                    },\n                    description: \"Cargo commands\".to_string(),\n                    risk_level: RiskLevel::Low,\n                },\n                CommandPermission {\n                    pattern: CommandPattern::Prefix {\n                        prefix: \"git\".to_string(),\n                    },\n                    description: \"Git commands\".to_string(),\n                    risk_level: RiskLevel::Low,\n                },\n                CommandPermission {\n                    pattern: CommandPattern::Prefix {\n                        prefix: \"engram\".to_string(),\n                    },\n                    description: \"Engram commands\".to_string(),\n                    risk_level: RiskLevel::Low,\n                },\n            ],\n            forbidden_paths: vec![\n                PathRestriction {\n                    pattern: \"/etc/*\".to_string(),\n                    reason: \"System configuration\".to_string(),\n                    escalation_allowed: false,\n                },\n                PathRestriction {\n                    pattern: \"*/migrations/*\".to_string(),\n                    reason: \"Database migrations\".to_string(),\n                    escalation_allowed: true,\n                },\n            ],\n            allowed_file_operations: vec![FileOperation::Read, FileOperation::WriteNonConfig],\n            network_access: NetworkPolicy::InternalOnly,\n            quality_gate_permissions: vec![],\n            workflow_permissions: WorkflowPermissions {\n                can_create_workflows: false,\n                can_modify_workflows: false,\n                can_execute_workflows: true,\n                restricted_workflow_types: vec![\"deployment\".to_string()],\n            },\n        };\n\n        let resource_limits = ResourceLimits {\n            max_memory_mb: 2048,\n            max_cpu_percentage: 50,\n            max_disk_space_mb: 4096,\n            max_execution_time_minutes: 30,\n            max_concurrent_operations: 5,\n            max_file_size_mb: 50,\n            max_network_requests_per_minute: 10,\n        };\n\n        let command_filter = CommandFilter {\n            whitelist_mode: false,\n            allowed_commands: vec![],\n            forbidden_commands: vec![\n                CommandPattern::Prefix {\n                    prefix: \"sudo\".to_string(),\n                },\n                CommandPattern::Regex {\n                    pattern: r\"rm\\s+-rf\\s+/\".to_string(),\n                },\n            ],\n            parameter_restrictions: HashMap::new(),\n            dangerous_patterns: vec![],\n        };\n\n        let escalation_policy = EscalationPolicy {\n            auto_approve_safe_operations: true,\n            require_human_approval: vec![\n                OperationType::ConfigChange,\n                OperationType::DatabaseOperation,\n            ],\n            escalation_timeout: Duration::from_secs(1800), // 30 minutes\n            fallback_action: FallbackAction::Defer,\n            notification_channels: vec![\"team-lead\".to_string()],\n        };\n\n        (\n            permissions,\n            resource_limits,\n            command_filter,\n            escalation_policy,\n        )\n    }\n\n    /// Standard sandbox configuration\n    fn standard_config() -\u003e (\n        PermissionSet,\n        ResourceLimits,\n        CommandFilter,\n        EscalationPolicy,\n    ) {\n        let permissions = PermissionSet {\n            allowed_commands: vec![],\n            forbidden_paths: vec![\n                PathRestriction {\n                    pattern: \"/etc/*\".to_string(),\n                    reason: \"System configuration\".to_string(),\n                    escalation_allowed: true,\n                },\n                PathRestriction {\n                    pattern: \"/root/*\".to_string(),\n                    reason: \"Root directory\".to_string(),\n                    escalation_allowed: false,\n                },\n            ],\n            allowed_file_operations: vec![\n                FileOperation::Read,\n                FileOperation::Write,\n                FileOperation::Create,\n                FileOperation::DeleteNonSystem,\n            ],\n            network_access: NetworkPolicy::AllowedWithMonitoring,\n            quality_gate_permissions: vec![],\n            workflow_permissions: WorkflowPermissions {\n                can_create_workflows: true,\n                can_modify_workflows: true,\n                can_execute_workflows: true,\n                restricted_workflow_types: vec![\"production\".to_string()],\n            },\n        };\n\n        let resource_limits = ResourceLimits {\n            max_memory_mb: 4096,\n            max_cpu_percentage: 75,\n            max_disk_space_mb: 8192,\n            max_execution_time_minutes: 60,\n            max_concurrent_operations: 10,\n            max_file_size_mb: 100,\n            max_network_requests_per_minute: 50,\n        };\n\n        let command_filter = CommandFilter {\n            whitelist_mode: false,\n            allowed_commands: vec![],\n            forbidden_commands: vec![\n                CommandPattern::Regex {\n                    pattern: r\"rm\\s+-rf\\s+/\\*\".to_string(),\n                },\n                CommandPattern::Prefix {\n                    prefix: \"sudo\".to_string(),\n                },\n                CommandPattern::Prefix {\n                    prefix: \"dd\".to_string(),\n                },\n            ],\n            parameter_restrictions: HashMap::new(),\n            dangerous_patterns: vec![],\n        };\n\n        let escalation_policy = EscalationPolicy {\n            auto_approve_safe_operations: true,\n            require_human_approval: vec![\n                OperationType::SystemFileAccess,\n                OperationType::PrivilegedOperation,\n            ],\n            escalation_timeout: Duration::from_secs(1800),\n            fallback_action: FallbackAction::Defer,\n            notification_channels: vec![\"dev-team\".to_string()],\n        };\n\n        (\n            permissions,\n            resource_limits,\n            command_filter,\n            escalation_policy,\n        )\n    }\n\n    /// Isolated sandbox configuration\n    fn isolated_config() -\u003e (\n        PermissionSet,\n        ResourceLimits,\n        CommandFilter,\n        EscalationPolicy,\n    ) {\n        let permissions = PermissionSet {\n            allowed_commands: vec![CommandPermission {\n                pattern: CommandPattern::Exact {\n                    command: \"git status\".to_string(),\n                },\n                description: \"Check git status\".to_string(),\n                risk_level: RiskLevel::Low,\n            }],\n            forbidden_paths: vec![PathRestriction {\n                pattern: \"/*\".to_string(),\n                reason: \"Root file system access restricted\".to_string(),\n                escalation_allowed: true,\n            }],\n            allowed_file_operations: vec![FileOperation::Read],\n            network_access: NetworkPolicy::Denied,\n            quality_gate_permissions: vec![],\n            workflow_permissions: WorkflowPermissions {\n                can_create_workflows: false,\n                can_modify_workflows: false,\n                can_execute_workflows: false,\n                restricted_workflow_types: vec![\"*\".to_string()],\n            },\n        };\n\n        let resource_limits = ResourceLimits {\n            max_memory_mb: 256,\n            max_cpu_percentage: 10,\n            max_disk_space_mb: 512,\n            max_execution_time_minutes: 5,\n            max_concurrent_operations: 1,\n            max_file_size_mb: 1,\n            max_network_requests_per_minute: 0,\n        };\n\n        let command_filter = CommandFilter {\n            whitelist_mode: true,\n            allowed_commands: vec![CommandPattern::Exact {\n                command: \"git status\".to_string(),\n            }],\n            forbidden_commands: vec![],\n            parameter_restrictions: HashMap::new(),\n            dangerous_patterns: vec![],\n        };\n\n        let escalation_policy = EscalationPolicy {\n            auto_approve_safe_operations: false,\n            require_human_approval: vec![\n                OperationType::FileWrite,\n                OperationType::CommandExecution,\n                OperationType::NetworkAccess,\n            ],\n            escalation_timeout: Duration::from_secs(7200), // 2 hours\n            fallback_action: FallbackAction::Deny,\n            notification_channels: vec![\"security-team\".to_string()],\n        };\n\n        (\n            permissions,\n            resource_limits,\n            command_filter,\n            escalation_policy,\n        )\n    }\n\n    /// Unrestricted sandbox configuration\n    fn unrestricted_config() -\u003e (\n        PermissionSet,\n        ResourceLimits,\n        CommandFilter,\n        EscalationPolicy,\n    ) {\n        let permissions = PermissionSet {\n            allowed_commands: vec![],\n            forbidden_paths: vec![],\n            allowed_file_operations: vec![\n                FileOperation::Read,\n                FileOperation::Write,\n                FileOperation::Create,\n                FileOperation::Delete,\n                FileOperation::Execute,\n            ],\n            network_access: NetworkPolicy::Unrestricted,\n            quality_gate_permissions: vec![],\n            workflow_permissions: WorkflowPermissions {\n                can_create_workflows: true,\n                can_modify_workflows: true,\n                can_execute_workflows: true,\n                restricted_workflow_types: vec![],\n            },\n        };\n\n        let resource_limits = ResourceLimits {\n            max_memory_mb: 16384,\n            max_cpu_percentage: 100,\n            max_disk_space_mb: 102400,\n            max_execution_time_minutes: 1440,\n            max_concurrent_operations: 50,\n            max_file_size_mb: 1024,\n            max_network_requests_per_minute: 1000,\n        };\n\n        let command_filter = CommandFilter {\n            whitelist_mode: false,\n            allowed_commands: vec![],\n            forbidden_commands: vec![],\n            parameter_restrictions: HashMap::new(),\n            dangerous_patterns: vec![],\n        };\n\n        let escalation_policy = EscalationPolicy {\n            auto_approve_safe_operations: true,\n            require_human_approval: vec![],\n            escalation_timeout: Duration::from_secs(60),\n            fallback_action: FallbackAction::Allow,\n            notification_channels: vec![],\n        };\n\n        (\n            permissions,\n            resource_limits,\n            command_filter,\n            escalation_policy,\n        )\n    }\n\n    /// Update the sandbox level and apply appropriate configuration\n    pub fn update_level(\u0026mut self, new_level: SandboxLevel) {\n        self.sandbox_level = new_level.clone();\n        let (permissions, resource_limits, command_filter, escalation_policy) =\n            Self::default_config_for_level(\u0026new_level);\n\n        self.permissions = permissions;\n        self.resource_limits = resource_limits;\n        self.command_filter = command_filter;\n        self.escalation_policy = escalation_policy;\n        self.last_modified = Utc::now();\n    }\n\n    /// Increment violation count\n    pub fn record_violation(\u0026mut self) {\n        self.violation_count += 1;\n        self.last_modified = Utc::now();\n    }\n}\n\nimpl Entity for AgentSandbox {\n    fn entity_type() -\u003e \u0026'static str {\n        \"agent_sandbox\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cAgentSandbox as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.agent_id.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Agent ID cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.created_by.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Created by field cannot be empty\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        let mut data = serde_json::Map::new();\n\n        data.insert(\"id\".to_string(), serde_json::to_value(\u0026self.id).unwrap());\n        data.insert(\n            \"agent_id\".to_string(),\n            serde_json::to_value(\u0026self.agent_id).unwrap(),\n        );\n        data.insert(\n            \"sandbox_level\".to_string(),\n            serde_json::to_value(\u0026self.sandbox_level).unwrap(),\n        );\n        data.insert(\n            \"permissions\".to_string(),\n            serde_json::to_value(\u0026self.permissions).unwrap(),\n        );\n        data.insert(\n            \"resource_limits\".to_string(),\n            serde_json::to_value(\u0026self.resource_limits).unwrap(),\n        );\n        data.insert(\n            \"command_filter\".to_string(),\n            serde_json::to_value(\u0026self.command_filter).unwrap(),\n        );\n        data.insert(\n            \"escalation_policy\".to_string(),\n            serde_json::to_value(\u0026self.escalation_policy).unwrap(),\n        );\n        data.insert(\n            \"created_by\".to_string(),\n            serde_json::to_value(\u0026self.created_by).unwrap(),\n        );\n        data.insert(\n            \"created_at\".to_string(),\n            serde_json::to_value(\u0026self.created_at).unwrap(),\n        );\n        data.insert(\n            \"last_modified\".to_string(),\n            serde_json::to_value(\u0026self.last_modified).unwrap(),\n        );\n        data.insert(\n            \"violation_count\".to_string(),\n            serde_json::to_value(\u0026self.violation_count).unwrap(),\n        );\n        data.insert(\n            \"agent\".to_string(),\n            serde_json::to_value(\u0026self.agent).unwrap(),\n        );\n        data.insert(\n            \"metadata\".to_string(),\n            serde_json::to_value(\u0026self.metadata).unwrap(),\n        );\n\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::Value::Object(data),\n        }\n    }\n\n    fn from_generic(generic: GenericEntity) -\u003e crate::Result\u003cSelf\u003e\n    where\n        Self: Sized,\n    {\n        serde_json::from_value(generic.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\n                \"Failed to deserialize AgentSandbox: {}\",\n                e\n            ))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n\nimpl Default for ResourceLimits {\n    fn default() -\u003e Self {\n        Self {\n            max_memory_mb: 2048,\n            max_cpu_percentage: 50,\n            max_disk_space_mb: 4096,\n            max_execution_time_minutes: 30,\n            max_concurrent_operations: 5,\n            max_file_size_mb: 50,\n            max_network_requests_per_minute: 20,\n        }\n    }\n}\n\nimpl Default for PermissionSet {\n    fn default() -\u003e Self {\n        Self {\n            allowed_commands: vec![],\n            forbidden_paths: vec![],\n            allowed_file_operations: vec![FileOperation::Read],\n            network_access: NetworkPolicy::InternalOnly,\n            quality_gate_permissions: vec![],\n            workflow_permissions: WorkflowPermissions::default(),\n        }\n    }\n}\n\nimpl Default for WorkflowPermissions {\n    fn default() -\u003e Self {\n        Self {\n            can_create_workflows: false,\n            can_modify_workflows: false,\n            can_execute_workflows: true,\n            restricted_workflow_types: vec![],\n        }\n    }\n}\n\nimpl Default for CommandFilter {\n    fn default() -\u003e Self {\n        Self {\n            whitelist_mode: false,\n            allowed_commands: vec![],\n            forbidden_commands: vec![],\n            parameter_restrictions: HashMap::new(),\n            dangerous_patterns: vec![],\n        }\n    }\n}\n\nimpl Default for EscalationPolicy {\n    fn default() -\u003e Self {\n        Self {\n            auto_approve_safe_operations: true,\n            require_human_approval: vec![],\n            escalation_timeout: Duration::from_secs(1800),\n            fallback_action: FallbackAction::Defer,\n            notification_channels: vec![],\n        }\n    }\n}\n\n// Helper module for duration serialization\nmod duration_serde {\n    use serde::{Deserialize, Deserializer, Serialize, Serializer};\n    use std::time::Duration;\n\n    pub fn serialize\u003cS\u003e(duration: \u0026Duration, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        duration.as_secs().serialize(serializer)\n    }\n\n    pub fn deserialize\u003c'de, D\u003e(deserializer: D) -\u003e Result\u003cDuration, D::Error\u003e\n    where\n        D: Deserializer\u003c'de\u003e,\n    {\n        let secs = u64::deserialize(deserializer)?;\n        Ok(Duration::from_secs(secs))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_agent_sandbox_creation() {\n        let sandbox = AgentSandbox::new(\n            \"test-agent\".to_string(),\n            SandboxLevel::Standard,\n            \"admin\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        assert_eq!(sandbox.agent_id, \"test-agent\");\n        assert_eq!(sandbox.sandbox_level, SandboxLevel::Standard);\n        assert_eq!(sandbox.created_by, \"admin\");\n        assert_eq!(sandbox.violation_count, 0);\n    }\n\n    #[test]\n    fn test_sandbox_level_update() {\n        let mut sandbox = AgentSandbox::new(\n            \"test-agent\".to_string(),\n            SandboxLevel::Training,\n            \"admin\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        assert_eq!(sandbox.sandbox_level, SandboxLevel::Training);\n\n        sandbox.update_level(SandboxLevel::Standard);\n        assert_eq!(sandbox.sandbox_level, SandboxLevel::Standard);\n    }\n\n    #[test]\n    fn test_violation_recording() {\n        let mut sandbox = AgentSandbox::new(\n            \"test-agent\".to_string(),\n            SandboxLevel::Standard,\n            \"admin\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        assert_eq!(sandbox.violation_count, 0);\n\n        sandbox.record_violation();\n        assert_eq!(sandbox.violation_count, 1);\n\n        sandbox.record_violation();\n        assert_eq!(sandbox.violation_count, 2);\n    }\n\n    #[test]\n    fn test_entity_validation() {\n        let sandbox = AgentSandbox::new(\n            \"test-agent\".to_string(),\n            SandboxLevel::Standard,\n            \"admin\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        assert!(sandbox.validate_entity().is_ok());\n    }\n\n    #[test]\n    fn test_generic_conversion() {\n        let sandbox = AgentSandbox::new(\n            \"test-agent\".to_string(),\n            SandboxLevel::Standard,\n            \"admin\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        let generic = sandbox.to_generic();\n        let restored = AgentSandbox::from_generic(generic).unwrap();\n\n        assert_eq!(sandbox.id, restored.id);\n        assert_eq!(sandbox.agent_id, restored.agent_id);\n        assert_eq!(sandbox.sandbox_level, restored.sandbox_level);\n        assert_eq!(sandbox.created_by, restored.created_by);\n        assert_eq!(sandbox.violation_count, restored.violation_count);\n    }\n}\n","traces":[{"line":303,"address":[26569680,26571364,26571102],"length":1,"stats":{"Line":1}},{"line":309,"address":[19899621],"length":1,"stats":{"Line":1}},{"line":311,"address":[27030518],"length":1,"stats":{"Line":2}},{"line":315,"address":[21351709,21351649],"length":1,"stats":{"Line":4}},{"line":327,"address":[19912054],"length":1,"stats":{"Line":2}},{"line":332,"address":[19910976],"length":1,"stats":{"Line":2}},{"line":340,"address":[26569571],"length":1,"stats":{"Line":2}},{"line":341,"address":[20784471],"length":1,"stats":{"Line":1}},{"line":342,"address":[26569631],"length":1,"stats":{"Line":0}},{"line":343,"address":[19911043],"length":1,"stats":{"Line":2}},{"line":344,"address":[19689051],"length":1,"stats":{"Line":0}},{"line":345,"address":[20784423],"length":1,"stats":{"Line":0}},{"line":350,"address":[19834012,19834023,19829824],"length":1,"stats":{"Line":1}},{"line":357,"address":[19830419,19830698,19829895,19829851,19830157,19830981,19834046],"length":1,"stats":{"Line":2}},{"line":380,"address":[19679834,19679795,19680273,19682793,19679721,19680053],"length":1,"stats":{"Line":3}},{"line":392,"address":[19902576,19902515],"length":1,"stats":{"Line":2}},{"line":394,"address":[20776072],"length":1,"stats":{"Line":1}},{"line":395,"address":[19903035],"length":1,"stats":{"Line":1}},{"line":415,"address":[20776741,20776850],"length":1,"stats":{"Line":2}},{"line":426,"address":[19832858],"length":1,"stats":{"Line":1}},{"line":427,"address":[19832921],"length":1,"stats":{"Line":1}},{"line":428,"address":[16015020],"length":1,"stats":{"Line":1}},{"line":433,"address":[19833203,19833264],"length":1,"stats":{"Line":2}},{"line":434,"address":[19833373],"length":1,"stats":{"Line":1}},{"line":436,"address":[16015472,16016029],"length":1,"stats":{"Line":1}},{"line":440,"address":[19682586],"length":1,"stats":{"Line":1}},{"line":442,"address":[21344676],"length":1,"stats":{"Line":1}},{"line":448,"address":[20778320,20782752,20782736],"length":1,"stats":{"Line":0}},{"line":455,"address":[19893485,19894009,19894288,19894571,19893747,19893441,19897863],"length":1,"stats":{"Line":0}},{"line":478,"address":[19684395,19684063,19687362,19684137,19684176,19684615],"length":1,"stats":{"Line":0}},{"line":490,"address":[19836089,19836150],"length":1,"stats":{"Line":0}},{"line":492,"address":[19907022],"length":1,"stats":{"Line":0}},{"line":493,"address":[26565953],"length":1,"stats":{"Line":0}},{"line":513,"address":[21347729],"length":1,"stats":{"Line":0}},{"line":514,"address":[21348114,21349403,21348014,21347860,21347802,21347899],"length":1,"stats":{"Line":0}},{"line":522,"address":[19837463],"length":1,"stats":{"Line":0}},{"line":523,"address":[19908294],"length":1,"stats":{"Line":0}},{"line":528,"address":[19896996,19897057],"length":1,"stats":{"Line":0}},{"line":532,"address":[19897166],"length":1,"stats":{"Line":0}},{"line":534,"address":[16019894,16020470],"length":1,"stats":{"Line":0}},{"line":538,"address":[21349199],"length":1,"stats":{"Line":0}},{"line":540,"address":[19838409],"length":1,"stats":{"Line":0}},{"line":546,"address":[19900547,19897120,19900563],"length":1,"stats":{"Line":2}},{"line":553,"address":[19897137],"length":1,"stats":{"Line":2}},{"line":554,"address":[27019829,27016731,27016473,27016512,27016412,27016951],"length":1,"stats":{"Line":6}},{"line":566,"address":[19827161,19827222],"length":1,"stats":{"Line":4}},{"line":573,"address":[19827334],"length":1,"stats":{"Line":2}},{"line":574,"address":[19886937],"length":1,"stats":{"Line":2}},{"line":594,"address":[19887241],"length":1,"stats":{"Line":2}},{"line":595,"address":[19828493,19828163,19828066,19828393,19828278,19828124,19829790],"length":1,"stats":{"Line":6}},{"line":606,"address":[20772845],"length":1,"stats":{"Line":2}},{"line":607,"address":[19899516],"length":1,"stats":{"Line":2}},{"line":612,"address":[26558375,26558314],"length":1,"stats":{"Line":4}},{"line":616,"address":[20773300],"length":1,"stats":{"Line":2}},{"line":618,"address":[21340044,21340601],"length":1,"stats":{"Line":2}},{"line":622,"address":[19900369],"length":1,"stats":{"Line":2}},{"line":624,"address":[19888875],"length":1,"stats":{"Line":2}},{"line":630,"address":[21333744,21337130,21337114],"length":1,"stats":{"Line":0}},{"line":637,"address":[19671916,19671713,19672208,19675089,19671757],"length":1,"stats":{"Line":0}},{"line":644,"address":[19823557,19823673,19823518,19823444,19826332],"length":1,"stats":{"Line":0}},{"line":649,"address":[26553355,26553291],"length":1,"stats":{"Line":0}},{"line":651,"address":[21334927],"length":1,"stats":{"Line":0}},{"line":652,"address":[19824466],"length":1,"stats":{"Line":0}},{"line":672,"address":[19884028,19885557,19884128,19884172,19884089],"length":1,"stats":{"Line":0}},{"line":675,"address":[27015137],"length":1,"stats":{"Line":0}},{"line":676,"address":[19673936],"length":1,"stats":{"Line":0}},{"line":677,"address":[16007497],"length":1,"stats":{"Line":0}},{"line":682,"address":[19884775,19884714],"length":1,"stats":{"Line":0}},{"line":687,"address":[27015656],"length":1,"stats":{"Line":0}},{"line":689,"address":[19825728,19826304],"length":1,"stats":{"Line":0}},{"line":693,"address":[27016121],"length":1,"stats":{"Line":0}},{"line":695,"address":[19885379],"length":1,"stats":{"Line":0}},{"line":701,"address":[16021992,16020512,16021986],"length":1,"stats":{"Line":0}},{"line":708,"address":[19897889],"length":1,"stats":{"Line":0}},{"line":709,"address":[19687410],"length":1,"stats":{"Line":0}},{"line":710,"address":[16020661,16020607],"length":1,"stats":{"Line":0}},{"line":718,"address":[16020781],"length":1,"stats":{"Line":0}},{"line":719,"address":[19898276],"length":1,"stats":{"Line":0}},{"line":739,"address":[26568655],"length":1,"stats":{"Line":0}},{"line":740,"address":[19688123],"length":1,"stats":{"Line":0}},{"line":741,"address":[16021279],"length":1,"stats":{"Line":0}},{"line":742,"address":[19688243],"length":1,"stats":{"Line":0}},{"line":747,"address":[20783863],"length":1,"stats":{"Line":0}},{"line":748,"address":[21350587],"length":1,"stats":{"Line":0}},{"line":750,"address":[27029861],"length":1,"stats":{"Line":0}},{"line":754,"address":[20784159],"length":1,"stats":{"Line":0}},{"line":756,"address":[19910790],"length":1,"stats":{"Line":0}},{"line":762,"address":[16005219,16003872,16005186],"length":1,"stats":{"Line":1}},{"line":763,"address":[26550891],"length":1,"stats":{"Line":1}},{"line":764,"address":[19670379],"length":1,"stats":{"Line":1}},{"line":767,"address":[19670708,19670751],"length":1,"stats":{"Line":1}},{"line":768,"address":[16004428],"length":1,"stats":{"Line":1}},{"line":769,"address":[16004628,16004473],"length":1,"stats":{"Line":1}},{"line":770,"address":[19881713,19881824],"length":1,"stats":{"Line":1}},{"line":771,"address":[16005099,16005041],"length":1,"stats":{"Line":2}},{"line":775,"address":[27024064],"length":1,"stats":{"Line":1}},{"line":776,"address":[19834139,19834062],"length":1,"stats":{"Line":1}},{"line":777,"address":[20778256],"length":1,"stats":{"Line":1}},{"line":786,"address":[16038624],"length":1,"stats":{"Line":0}},{"line":787,"address":[19927893],"length":1,"stats":{"Line":0}},{"line":790,"address":[19705888],"length":1,"stats":{"Line":0}},{"line":791,"address":[20801301],"length":1,"stats":{"Line":0}},{"line":794,"address":[21368000],"length":1,"stats":{"Line":0}},{"line":795,"address":[19857192],"length":1,"stats":{"Line":0}},{"line":798,"address":[26586172,26586178,26585568],"length":1,"stats":{"Line":1}},{"line":799,"address":[19856254],"length":1,"stats":{"Line":1}},{"line":803,"address":[15044656,15044670],"length":1,"stats":{"Line":0}},{"line":804,"address":[20800673],"length":1,"stats":{"Line":0}},{"line":805,"address":[16255571],"length":1,"stats":{"Line":0}},{"line":807,"address":[16138647],"length":1,"stats":{"Line":0}},{"line":808,"address":[14946160,14946066,14946176],"length":1,"stats":{"Line":0}},{"line":809,"address":[16255607],"length":1,"stats":{"Line":0}},{"line":812,"address":[21367446],"length":1,"stats":{"Line":0}},{"line":815,"address":[19915603],"length":1,"stats":{"Line":1}},{"line":816,"address":[27046921],"length":1,"stats":{"Line":0}},{"line":817,"address":[16038377],"length":1,"stats":{"Line":0}},{"line":821,"address":[19856852],"length":1,"stats":{"Line":1}},{"line":822,"address":[21367852],"length":1,"stats":{"Line":0}},{"line":823,"address":[20801165],"length":1,"stats":{"Line":0}},{"line":827,"address":[19916241],"length":1,"stats":{"Line":1}},{"line":830,"address":[19914806,19911328,19915095],"length":1,"stats":{"Line":1}},{"line":831,"address":[19700862],"length":1,"stats":{"Line":1}},{"line":833,"address":[27042314,27042341,27045844,27042240],"length":1,"stats":{"Line":2}},{"line":834,"address":[27042617],"length":1,"stats":{"Line":1}},{"line":835,"address":[19701211],"length":1,"stats":{"Line":1}},{"line":836,"address":[26581847,26581911],"length":1,"stats":{"Line":2}},{"line":838,"address":[26582161],"length":1,"stats":{"Line":1}},{"line":839,"address":[21363488],"length":1,"stats":{"Line":1}},{"line":840,"address":[26582060,26582127],"length":1,"stats":{"Line":2}},{"line":842,"address":[26582374],"length":1,"stats":{"Line":1}},{"line":843,"address":[20797048],"length":1,"stats":{"Line":1}},{"line":844,"address":[19852932,19852996],"length":1,"stats":{"Line":2}},{"line":846,"address":[19912494],"length":1,"stats":{"Line":1}},{"line":847,"address":[26582445],"length":1,"stats":{"Line":1}},{"line":848,"address":[27043161,27043228],"length":1,"stats":{"Line":2}},{"line":850,"address":[20797622],"length":1,"stats":{"Line":1}},{"line":851,"address":[19853317],"length":1,"stats":{"Line":1}},{"line":852,"address":[19912676,19912609],"length":1,"stats":{"Line":2}},{"line":854,"address":[19702430],"length":1,"stats":{"Line":1}},{"line":855,"address":[19702285],"length":1,"stats":{"Line":1}},{"line":856,"address":[19853577,19853644],"length":1,"stats":{"Line":2}},{"line":858,"address":[16035446],"length":1,"stats":{"Line":1}},{"line":859,"address":[19912997],"length":1,"stats":{"Line":1}},{"line":860,"address":[19913041,19913108],"length":1,"stats":{"Line":2}},{"line":862,"address":[19924878],"length":1,"stats":{"Line":1}},{"line":863,"address":[19913213],"length":1,"stats":{"Line":1}},{"line":864,"address":[19702761,19702828],"length":1,"stats":{"Line":2}},{"line":866,"address":[26583670],"length":1,"stats":{"Line":1}},{"line":867,"address":[19702933],"length":1,"stats":{"Line":1}},{"line":868,"address":[20798452,20798385],"length":1,"stats":{"Line":2}},{"line":870,"address":[16036082],"length":1,"stats":{"Line":1}},{"line":871,"address":[21365213],"length":1,"stats":{"Line":1}},{"line":872,"address":[27044524,27044457],"length":1,"stats":{"Line":2}},{"line":874,"address":[19914006],"length":1,"stats":{"Line":1}},{"line":875,"address":[20798773],"length":1,"stats":{"Line":1}},{"line":876,"address":[19913972,19913905],"length":1,"stats":{"Line":2}},{"line":878,"address":[26584318],"length":1,"stats":{"Line":1}},{"line":879,"address":[19914077],"length":1,"stats":{"Line":1}},{"line":880,"address":[19854940,19854873],"length":1,"stats":{"Line":2}},{"line":884,"address":[16036582],"length":1,"stats":{"Line":1}},{"line":885,"address":[21365960,21365885],"length":1,"stats":{"Line":2}},{"line":886,"address":[19703920],"length":1,"stats":{"Line":1}},{"line":887,"address":[20799410],"length":1,"stats":{"Line":1}},{"line":888,"address":[19926046],"length":1,"stats":{"Line":1}},{"line":892,"address":[26585232,26585505],"length":1,"stats":{"Line":1}},{"line":896,"address":[14945993,14945987,14945744],"length":1,"stats":{"Line":2}},{"line":897,"address":[16255291,16255359],"length":1,"stats":{"Line":0}},{"line":904,"address":[19705920],"length":1,"stats":{"Line":0}},{"line":913,"address":[19928336],"length":1,"stats":{"Line":0}},{"line":927,"address":[19700563,19700032,19700569],"length":1,"stats":{"Line":0}},{"line":929,"address":[21362113],"length":1,"stats":{"Line":0}},{"line":930,"address":[20795471],"length":1,"stats":{"Line":0}},{"line":931,"address":[16033029,16032977],"length":1,"stats":{"Line":0}},{"line":933,"address":[26580867],"length":1,"stats":{"Line":0}},{"line":934,"address":[19922348],"length":1,"stats":{"Line":0}},{"line":940,"address":[19707664],"length":1,"stats":{"Line":0}},{"line":945,"address":[16040349],"length":1,"stats":{"Line":0}},{"line":951,"address":[20795159,20794816,20795153],"length":1,"stats":{"Line":0}},{"line":954,"address":[19699425],"length":1,"stats":{"Line":0}},{"line":955,"address":[26580046],"length":1,"stats":{"Line":0}},{"line":956,"address":[19850747],"length":1,"stats":{"Line":0}},{"line":957,"address":[21361617],"length":1,"stats":{"Line":0}},{"line":963,"address":[20802376,20802160,20802370],"length":1,"stats":{"Line":0}},{"line":966,"address":[19928782],"length":1,"stats":{"Line":0}},{"line":967,"address":[19706785],"length":1,"stats":{"Line":0}},{"line":969,"address":[19928870],"length":1,"stats":{"Line":0}},{"line":979,"address":[17186765,17186640],"length":1,"stats":{"Line":1}},{"line":983,"address":[22600432,22600489],"length":1,"stats":{"Line":2}},{"line":986,"address":[23060928],"length":1,"stats":{"Line":1}},{"line":990,"address":[17186521],"length":1,"stats":{"Line":1}},{"line":991,"address":[15714280],"length":1,"stats":{"Line":1}}],"covered":106,"coverable":191},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","compliance.rs"],"content":"//! Compliance entity implementation\n//!\n//! Compliance items track the organization's adherence to Standards and requirements.\n//! They provide visibility into whether the team is meeting established guidelines.\n//!\n//! ## Compliance Status\n//!\n//! - **Compliant**: All requirements are being met\n//! - **NonCompliant**: Requirements are not being met\n//! - **Pending**: Assessment not yet complete\n//! - **Exempt**: Requirement does not apply in this context\n//!\n//! ## Relationship to Rules and Standards\n//!\n//! Compliance answers the question: **\"Are we meeting our standards?\"**\n//!\n//! ```text\n//! Standard (What) ‚Üí Rule (How to enforce) ‚Üí Compliance (Are we meeting it?)\n//! ```\n//!\n//! Compliance entities:\n//! - Reference Standards they track adherence to via `related_standards`\n//! - Record violations found during assessment via `violations`\n//! - Store evidence of compliance via `evidence`\n//! - Track remediation due dates via `due_date`\n//!\n//! ## Workflow\n//!\n//! 1. Create a Compliance item referencing relevant Standards\n//! 2. Run Rule evaluations to check compliance\n//! 3. Record violations and evidence\n//! 4. Update status based on findings\n//! 5. Track remediation progress until compliant\n//!\n//! ## Example\n//!\n//! ```json\n//! {\n//!   \"title\": \"Q4 Security Compliance\",\n//!   \"category\": \"security\",\n//!   \"status\": \"non_compliant\",\n//!   \"severity\": \"high\",\n//!   \"due_date\": \"2024-12-31T00:00:00Z\",\n//!   \"related_standards\": [\"security-standards-v2\"],\n//!   \"violations\": [\n//!     {\"description\": \"Missing rate limiting on API endpoints\"}\n//!   ]\n//! }\n//! ```\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Compliance status variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum ComplianceStatus {\n    Compliant,\n    NonCompliant,\n    Pending,\n    Exempt,\n}\n\n/// Severity level for compliance violations\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum SeverityLevel {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\n/// Compliance requirement entity\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct Compliance {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Requirement title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Requirement description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Compliance category\n    #[serde(rename = \"category\")]\n    pub category: String,\n\n    /// Current compliance status\n    #[serde(rename = \"status\")]\n    pub status: ComplianceStatus,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Creation timestamp\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// Last updated timestamp\n    #[serde(rename = \"updated_at\")]\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    /// Due date for compliance\n    #[serde(rename = \"due_date\")]\n    pub due_date: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    /// Severity level if non-compliant\n    #[serde(rename = \"severity\")]\n    pub severity: Option\u003cSeverityLevel\u003e,\n\n    /// Evidence of compliance\n    #[serde(rename = \"evidence\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub evidence: Vec\u003cComplianceEvidence\u003e,\n\n    /// Violations found\n    #[serde(rename = \"violations\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub violations: Vec\u003cComplianceViolation\u003e,\n\n    /// Related standards\n    #[serde(\n        rename = \"related_standards\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub related_standards: Vec\u003cString\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\n/// Evidence supporting compliance\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct ComplianceEvidence {\n    /// Evidence identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Evidence description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Evidence type (document, test, review, etc.)\n    #[serde(rename = \"evidence_type\")]\n    pub evidence_type: String,\n\n    /// Evidence location or URL\n    #[serde(rename = \"location\")]\n    pub location: Option\u003cString\u003e,\n\n    /// Timestamp when evidence was collected\n    #[serde(rename = \"collected_at\")]\n    pub collected_at: DateTime\u003cUtc\u003e,\n\n    /// Validator or reviewer\n    #[serde(rename = \"reviewer\")]\n    pub reviewer: Option\u003cString\u003e,\n}\n\n/// Compliance violation\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct ComplianceViolation {\n    /// Violation identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Violation description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Severity level\n    #[serde(rename = \"severity\")]\n    pub severity: SeverityLevel,\n\n    /// Location of violation\n    #[serde(rename = \"location\")]\n    pub location: Option\u003cString\u003e,\n\n    /// When violation was detected\n    #[serde(rename = \"detected_at\")]\n    pub detected_at: DateTime\u003cUtc\u003e,\n\n    /// Remediation steps\n    #[serde(\n        rename = \"remediation_steps\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub remediation_steps: Vec\u003cString\u003e,\n\n    /// Status of remediation\n    #[serde(rename = \"remediation_status\")]\n    pub remediation_status: String,\n}\n\nimpl Compliance {\n    /// Create a new compliance requirement\n    pub fn new(title: String, description: String, category: String, agent: String) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            description,\n            category,\n            status: ComplianceStatus::Pending,\n            agent,\n            created_at: now,\n            updated_at: now,\n            due_date: None,\n            severity: None,\n            evidence: Vec::new(),\n            violations: Vec::new(),\n            related_standards: Vec::new(),\n            tags: Vec::new(),\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Mark as compliant\n    pub fn mark_compliant(\u0026mut self) {\n        self.status = ComplianceStatus::Compliant;\n        self.violations.clear();\n        self.updated_at = Utc::now();\n    }\n\n    /// Mark as non-compliant with violations\n    pub fn mark_non_compliant(\u0026mut self, violations: Vec\u003cComplianceViolation\u003e) {\n        self.status = ComplianceStatus::NonCompliant;\n        if !violations.is_empty() {\n            self.severity = violations\n                .iter()\n                .map(|v| match v.severity {\n                    SeverityLevel::Critical =\u003e 4,\n                    SeverityLevel::High =\u003e 3,\n                    SeverityLevel::Medium =\u003e 2,\n                    SeverityLevel::Low =\u003e 1,\n                })\n                .max()\n                .and_then(|max| match max {\n                    4 =\u003e Some(SeverityLevel::Critical),\n                    3 =\u003e Some(SeverityLevel::High),\n                    2 =\u003e Some(SeverityLevel::Medium),\n                    1 =\u003e Some(SeverityLevel::Low),\n                    _ =\u003e None,\n                });\n        }\n        self.violations = violations;\n        self.updated_at = Utc::now();\n    }\n\n    /// Add evidence\n    pub fn add_evidence(\u0026mut self, evidence: ComplianceEvidence) {\n        self.evidence.push(evidence);\n        self.updated_at = Utc::now();\n    }\n\n    /// Add a related standard\n    pub fn add_related_standard(\u0026mut self, standard_id: String) {\n        if !self.related_standards.contains(\u0026standard_id) {\n            self.related_standards.push(standard_id);\n        }\n    }\n\n    /// Set due date\n    pub fn set_due_date(\u0026mut self, due_date: DateTime\u003cUtc\u003e) {\n        self.due_date = Some(due_date);\n        self.updated_at = Utc::now();\n    }\n}\n\nimpl Entity for Compliance {\n    fn entity_type() -\u003e \u0026'static str {\n        \"compliance\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cCompliance as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Compliance title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.description.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Compliance description cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.category.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Compliance category cannot be empty\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize Compliance: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":216,"address":[15464508,15464671,15463408],"length":1,"stats":{"Line":0}},{"line":217,"address":[18581717],"length":1,"stats":{"Line":0}},{"line":219,"address":[15463566],"length":1,"stats":{"Line":0}},{"line":229,"address":[17301755],"length":1,"stats":{"Line":0}},{"line":230,"address":[23971914],"length":1,"stats":{"Line":0}},{"line":231,"address":[24432646],"length":1,"stats":{"Line":0}},{"line":232,"address":[17098578],"length":1,"stats":{"Line":0}},{"line":233,"address":[18582270],"length":1,"stats":{"Line":0}},{"line":238,"address":[23970624],"length":1,"stats":{"Line":0}},{"line":239,"address":[17300542],"length":1,"stats":{"Line":0}},{"line":240,"address":[17097189],"length":1,"stats":{"Line":0}},{"line":241,"address":[17300562],"length":1,"stats":{"Line":0}},{"line":245,"address":[17241860,17241360,17241889],"length":1,"stats":{"Line":0}},{"line":246,"address":[17312166],"length":1,"stats":{"Line":0}},{"line":247,"address":[17241421,17241698,17241481],"length":1,"stats":{"Line":0}},{"line":248,"address":[18730740,18730940],"length":1,"stats":{"Line":0}},{"line":249,"address":[17300827],"length":1,"stats":{"Line":0}},{"line":250,"address":[23970954],"length":1,"stats":{"Line":0}},{"line":251,"address":[19258395],"length":1,"stats":{"Line":0}},{"line":252,"address":[17828385],"length":1,"stats":{"Line":0}},{"line":253,"address":[24959143],"length":1,"stats":{"Line":0}},{"line":254,"address":[24498461],"length":1,"stats":{"Line":0}},{"line":256,"address":[18730889],"length":1,"stats":{"Line":0}},{"line":257,"address":[17300916],"length":1,"stats":{"Line":0}},{"line":258,"address":[24959056],"length":1,"stats":{"Line":0}},{"line":259,"address":[24959063],"length":1,"stats":{"Line":0}},{"line":260,"address":[24959070],"length":1,"stats":{"Line":0}},{"line":261,"address":[24959077],"length":1,"stats":{"Line":0}},{"line":262,"address":[17617785],"length":1,"stats":{"Line":0}},{"line":265,"address":[17241523,17241708],"length":1,"stats":{"Line":0}},{"line":266,"address":[18731048],"length":1,"stats":{"Line":0}},{"line":270,"address":[17241104],"length":1,"stats":{"Line":0}},{"line":271,"address":[18580638],"length":1,"stats":{"Line":0}},{"line":272,"address":[17311896],"length":1,"stats":{"Line":0}},{"line":276,"address":[15463152,15463361,15463387],"length":1,"stats":{"Line":0}},{"line":277,"address":[17097896,17097811],"length":1,"stats":{"Line":0}},{"line":278,"address":[17312811,17312865],"length":1,"stats":{"Line":0}},{"line":283,"address":[17300432],"length":1,"stats":{"Line":0}},{"line":284,"address":[17300445],"length":1,"stats":{"Line":0}},{"line":285,"address":[17300482],"length":1,"stats":{"Line":0}},{"line":294,"address":[17307024],"length":1,"stats":{"Line":0}},{"line":295,"address":[17103669],"length":1,"stats":{"Line":0}},{"line":298,"address":[17247792],"length":1,"stats":{"Line":0}},{"line":299,"address":[17247797],"length":1,"stats":{"Line":0}},{"line":302,"address":[15468960],"length":1,"stats":{"Line":0}},{"line":303,"address":[17103720],"length":1,"stats":{"Line":0}},{"line":306,"address":[17306588,17305984,17306594],"length":1,"stats":{"Line":0}},{"line":307,"address":[17317534],"length":1,"stats":{"Line":0}},{"line":311,"address":[17317766],"length":1,"stats":{"Line":0}},{"line":312,"address":[20362320],"length":1,"stats":{"Line":0}},{"line":313,"address":[20362355],"length":1,"stats":{"Line":0}},{"line":315,"address":[19148135],"length":1,"stats":{"Line":0}},{"line":316,"address":[17627888,17627778,17627872],"length":1,"stats":{"Line":0}},{"line":317,"address":[17849815],"length":1,"stats":{"Line":0}},{"line":320,"address":[17247142],"length":1,"stats":{"Line":0}},{"line":323,"address":[24436883],"length":1,"stats":{"Line":0}},{"line":324,"address":[17103302],"length":1,"stats":{"Line":0}},{"line":325,"address":[17247383],"length":1,"stats":{"Line":0}},{"line":329,"address":[18736612],"length":1,"stats":{"Line":0}},{"line":330,"address":[15468687],"length":1,"stats":{"Line":0}},{"line":331,"address":[24437537],"length":1,"stats":{"Line":0}},{"line":335,"address":[17306750],"length":1,"stats":{"Line":0}},{"line":336,"address":[17306931],"length":1,"stats":{"Line":0}},{"line":337,"address":[15468787],"length":1,"stats":{"Line":0}},{"line":341,"address":[17103528],"length":1,"stats":{"Line":0}},{"line":344,"address":[17317105,17316640,17317111],"length":1,"stats":{"Line":0}},{"line":346,"address":[17101789],"length":1,"stats":{"Line":0}},{"line":347,"address":[18585507,18585435],"length":1,"stats":{"Line":0}},{"line":348,"address":[17101895],"length":1,"stats":{"Line":0}},{"line":349,"address":[23975413],"length":1,"stats":{"Line":0}},{"line":350,"address":[17101979,17102036],"length":1,"stats":{"Line":0}},{"line":354,"address":[17102272,17102552],"length":1,"stats":{"Line":0}},{"line":355,"address":[18585926,18586020],"length":1,"stats":{"Line":0}},{"line":356,"address":[24508143,24508075],"length":1,"stats":{"Line":0}},{"line":360,"address":[18587328],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":75},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","context.rs"],"content":"//! Context entity implementation\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Relevance level for context\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum ContextRelevance {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\n/// Context entity representing background information\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct Context {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Context title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Context content\n    #[serde(rename = \"content\")]\n    pub content: String,\n\n    /// Source of this context\n    #[serde(rename = \"source\")]\n    pub source: String,\n\n    /// Source identifier (e.g., URL, file path)\n    #[serde(rename = \"source_id\")]\n    pub source_id: Option\u003cString\u003e,\n\n    /// Relevance level\n    #[serde(rename = \"relevance\")]\n    pub relevance: ContextRelevance,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Creation timestamp\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// Last updated timestamp\n    #[serde(rename = \"updated_at\")]\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Related entity IDs\n    #[serde(\n        rename = \"related_entities\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub related_entities: Vec\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\nimpl Context {\n    /// Create a new context\n    pub fn new(\n        title: String,\n        content: String,\n        source: String,\n        relevance: ContextRelevance,\n        agent: String,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            content,\n            source,\n            source_id: None,\n            relevance,\n            agent,\n            created_at: now,\n            updated_at: now,\n            tags: Vec::new(),\n            related_entities: Vec::new(),\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Update context content\n    pub fn update_content(\u0026mut self, content: String) {\n        self.content = content;\n        self.updated_at = Utc::now();\n    }\n\n    /// Add a related entity\n    pub fn add_related_entity(\u0026mut self, entity_id: String) {\n        if !self.related_entities.contains(\u0026entity_id) {\n            self.related_entities.push(entity_id);\n        }\n    }\n\n    /// Set source ID\n    pub fn set_source_id(\u0026mut self, source_id: String) {\n        self.source_id = Some(source_id);\n    }\n}\n\nimpl Entity for Context {\n    fn entity_type() -\u003e \u0026'static str {\n        \"context\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        // Use validator crate's validate method via explicit trait qualification\n        if let Err(errors) = \u003cContext as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Context title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.content.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Context content cannot be empty\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize Context: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":82,"address":[16257408,16258350,16258531],"length":1,"stats":{"Line":1}},{"line":89,"address":[16257458],"length":1,"stats":{"Line":1}},{"line":91,"address":[22986923],"length":1,"stats":{"Line":3}},{"line":100,"address":[15280494],"length":1,"stats":{"Line":1}},{"line":101,"address":[22987181],"length":1,"stats":{"Line":1}},{"line":102,"address":[16384729],"length":1,"stats":{"Line":1}},{"line":107,"address":[22986320,22986385],"length":1,"stats":{"Line":0}},{"line":108,"address":[22986338,22986420],"length":1,"stats":{"Line":0}},{"line":109,"address":[16383931],"length":1,"stats":{"Line":0}},{"line":113,"address":[16106117,16106143,16105904],"length":1,"stats":{"Line":0}},{"line":114,"address":[16327939,16328024],"length":1,"stats":{"Line":0}},{"line":115,"address":[15280061,15280007],"length":1,"stats":{"Line":0}},{"line":120,"address":[22986144,22986234],"length":1,"stats":{"Line":0}},{"line":121,"address":[16383753,16383646],"length":1,"stats":{"Line":0}},{"line":130,"address":[22991248],"length":1,"stats":{"Line":0}},{"line":131,"address":[16261909],"length":1,"stats":{"Line":0}},{"line":134,"address":[17325792],"length":1,"stats":{"Line":0}},{"line":135,"address":[17325797],"length":1,"stats":{"Line":0}},{"line":138,"address":[16110704],"length":1,"stats":{"Line":0}},{"line":139,"address":[16332728],"length":1,"stats":{"Line":0}},{"line":142,"address":[17325484,17325490,17324880],"length":1,"stats":{"Line":0}},{"line":144,"address":[17628318],"length":1,"stats":{"Line":0}},{"line":148,"address":[15284625],"length":1,"stats":{"Line":0}},{"line":149,"address":[15284648],"length":1,"stats":{"Line":0}},{"line":150,"address":[19978595],"length":1,"stats":{"Line":0}},{"line":152,"address":[18490871],"length":1,"stats":{"Line":0}},{"line":153,"address":[18431634,18431680,18431696],"length":1,"stats":{"Line":0}},{"line":154,"address":[25621671],"length":1,"stats":{"Line":0}},{"line":157,"address":[15284741],"length":1,"stats":{"Line":0}},{"line":160,"address":[17628419],"length":1,"stats":{"Line":0}},{"line":161,"address":[23451702],"length":1,"stats":{"Line":0}},{"line":162,"address":[15284982],"length":1,"stats":{"Line":0}},{"line":166,"address":[22990980],"length":1,"stats":{"Line":0}},{"line":167,"address":[15285144],"length":1,"stats":{"Line":0}},{"line":168,"address":[17325658],"length":1,"stats":{"Line":0}},{"line":172,"address":[17325646],"length":1,"stats":{"Line":0}},{"line":175,"address":[16330912,16331377,16331383],"length":1,"stats":{"Line":4}},{"line":177,"address":[16260173],"length":1,"stats":{"Line":2}},{"line":178,"address":[15283563,15283631],"length":1,"stats":{"Line":6}},{"line":179,"address":[22989623],"length":1,"stats":{"Line":5}},{"line":180,"address":[23450357],"length":1,"stats":{"Line":4}},{"line":181,"address":[16387195,16387252],"length":1,"stats":{"Line":7}},{"line":185,"address":[16260656,16260936],"length":1,"stats":{"Line":1}},{"line":186,"address":[17324550,17324644],"length":1,"stats":{"Line":2}},{"line":187,"address":[19166347,19166283],"length":1,"stats":{"Line":0}},{"line":191,"address":[17325808],"length":1,"stats":{"Line":0}}],"covered":14,"coverable":46},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","escalation_request.rs"],"content":"//! Escalation Request entity for sandbox permission escalations\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Status of an escalation request\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum EscalationStatus {\n    /// Request is pending human review\n    Pending,\n    /// Request has been approved\n    Approved,\n    /// Request has been denied\n    Denied,\n    /// Request has expired without action\n    Expired,\n    /// Request was cancelled by the requestor\n    Cancelled,\n}\n\n/// Priority level for escalation requests\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum EscalationPriority {\n    /// Low priority - can wait for review\n    Low,\n    /// Normal priority - standard review process\n    Normal,\n    /// High priority - expedited review needed\n    High,\n    /// Critical priority - immediate attention required\n    Critical,\n}\n\n/// Type of operation being escalated\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"snake_case\")]\npub enum EscalationOperationType {\n    /// File system operations\n    FileSystemAccess,\n    /// Network operations\n    NetworkAccess,\n    /// System command execution\n    CommandExecution,\n    /// Privilege escalation\n    PrivilegeEscalation,\n    /// Quality gate override\n    QualityGateOverride,\n    /// Workflow modification\n    WorkflowModification,\n    /// Resource limit increase\n    ResourceLimitIncrease,\n    /// Custom operation type\n    Custom(String),\n}\n\n/// Context information about the blocked operation\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct OperationContext {\n    /// The specific operation that was blocked\n    #[validate(length(min = 1))]\n    pub operation: String,\n\n    /// Parameters of the operation\n    pub parameters: HashMap\u003cString, serde_json::Value\u003e,\n\n    /// Resource being accessed\n    pub resource: Option\u003cString\u003e,\n\n    /// Reason the operation was blocked\n    #[validate(length(min = 1))]\n    pub block_reason: String,\n\n    /// Alternative suggestions\n    pub alternatives: Vec\u003cString\u003e,\n\n    /// Risk assessment of allowing the operation\n    pub risk_assessment: Option\u003cString\u003e,\n}\n\n/// Human reviewer information\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct ReviewerInfo {\n    /// ID of the human reviewer\n    #[validate(length(min = 1))]\n    pub reviewer_id: String,\n\n    /// Name of the reviewer\n    #[validate(length(min = 1))]\n    pub reviewer_name: String,\n\n    /// Email of the reviewer\n    #[validate(email)]\n    pub reviewer_email: Option\u003cString\u003e,\n\n    /// Department or team of the reviewer\n    pub department: Option\u003cString\u003e,\n}\n\n/// Decision made by the reviewer\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct ReviewDecision {\n    /// The decision made (approved/denied)\n    pub status: EscalationStatus,\n\n    /// Reason for the decision\n    #[validate(length(min = 1))]\n    pub reason: String,\n\n    /// Conditions attached to approval (if any)\n    pub conditions: Vec\u003cString\u003e,\n\n    /// Duration for which approval is valid (in seconds)\n    pub approval_duration: Option\u003cu64\u003e,\n\n    /// Whether this decision should be remembered for similar operations\n    pub create_policy: bool,\n\n    /// Additional notes from reviewer\n    pub notes: Option\u003cString\u003e,\n}\n\n/// Escalation Request entity\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct EscalationRequest {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Agent that requested the escalation\n    #[serde(rename = \"agent_id\")]\n    #[validate(length(min = 1))]\n    pub agent_id: String,\n\n    /// Session ID when escalation was requested\n    #[serde(rename = \"session_id\")]\n    pub session_id: Option\u003cString\u003e,\n\n    /// Type of operation being escalated\n    #[serde(rename = \"operation_type\")]\n    pub operation_type: EscalationOperationType,\n\n    /// Current status of the escalation\n    #[serde(rename = \"status\")]\n    pub status: EscalationStatus,\n\n    /// Priority level\n    #[serde(rename = \"priority\")]\n    pub priority: EscalationPriority,\n\n    /// Context about the blocked operation\n    #[serde(rename = \"operation_context\")]\n    #[validate]\n    pub operation_context: OperationContext,\n\n    /// Justification provided by the agent\n    #[serde(rename = \"justification\")]\n    #[validate(length(min = 1))]\n    pub justification: String,\n\n    /// Expected impact if request is denied\n    #[serde(rename = \"impact_if_denied\")]\n    pub impact_if_denied: Option\u003cString\u003e,\n\n    /// Suggested reviewer (if any)\n    #[serde(rename = \"suggested_reviewer\")]\n    pub suggested_reviewer: Option\u003cString\u003e,\n\n    /// Assigned reviewer information\n    #[serde(rename = \"reviewer\")]\n    pub reviewer: Option\u003cReviewerInfo\u003e,\n\n    /// Decision made by reviewer\n    #[serde(rename = \"decision\")]\n    pub decision: Option\u003cReviewDecision\u003e,\n\n    /// When the request was created\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// When the request was last updated\n    #[serde(rename = \"updated_at\")]\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    /// When the request will expire if not reviewed\n    #[serde(rename = \"expires_at\")]\n    pub expires_at: DateTime\u003cUtc\u003e,\n\n    /// When the request was reviewed (if applicable)\n    #[serde(rename = \"reviewed_at\")]\n    pub reviewed_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    /// Number of times this agent has made similar requests\n    #[serde(rename = \"similar_request_count\")]\n    pub similar_request_count: u32,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\nimpl EscalationRequest {\n    /// Create a new escalation request\n    pub fn new(\n        agent_id: String,\n        operation_type: EscalationOperationType,\n        operation_context: OperationContext,\n        justification: String,\n        priority: EscalationPriority,\n        agent: String,\n    ) -\u003e Self {\n        let now = Utc::now();\n\n        // Calculate expiration based on priority\n        let expiration_hours = match priority {\n            EscalationPriority::Critical =\u003e 1,\n            EscalationPriority::High =\u003e 4,\n            EscalationPriority::Normal =\u003e 24,\n            EscalationPriority::Low =\u003e 72,\n        };\n\n        Self {\n            id: Uuid::new_v4().to_string(),\n            agent_id,\n            session_id: None,\n            operation_type,\n            status: EscalationStatus::Pending,\n            priority,\n            operation_context,\n            justification,\n            impact_if_denied: None,\n            suggested_reviewer: None,\n            reviewer: None,\n            decision: None,\n            created_at: now,\n            updated_at: now,\n            expires_at: now + chrono::Duration::hours(expiration_hours),\n            reviewed_at: None,\n            similar_request_count: 0,\n            agent,\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Update the escalation status\n    pub fn update_status(\u0026mut self, status: EscalationStatus) {\n        self.status = status;\n        self.updated_at = Utc::now();\n    }\n\n    /// Assign a reviewer\n    pub fn assign_reviewer(\u0026mut self, reviewer: ReviewerInfo) {\n        self.reviewer = Some(reviewer);\n        self.updated_at = Utc::now();\n    }\n\n    /// Record a decision\n    pub fn record_decision(\u0026mut self, decision: ReviewDecision) {\n        self.status = decision.status.clone();\n        self.decision = Some(decision);\n        self.reviewed_at = Some(Utc::now());\n        self.updated_at = Utc::now();\n    }\n\n    /// Check if the request has expired\n    pub fn is_expired(\u0026self) -\u003e bool {\n        self.status == EscalationStatus::Pending \u0026\u0026 Utc::now() \u003e self.expires_at\n    }\n\n    /// Mark as expired\n    pub fn mark_expired(\u0026mut self) {\n        if self.is_expired() {\n            self.status = EscalationStatus::Expired;\n            self.updated_at = Utc::now();\n        }\n    }\n\n    /// Cancel the request\n    pub fn cancel(\u0026mut self, reason: Option\u003cString\u003e) {\n        self.status = EscalationStatus::Cancelled;\n        self.updated_at = Utc::now();\n\n        if let Some(reason) = reason {\n            self.metadata.insert(\n                \"cancellation_reason\".to_string(),\n                serde_json::Value::String(reason),\n            );\n        }\n    }\n\n    /// Get time remaining before expiration\n    pub fn time_to_expiration(\u0026self) -\u003e Option\u003cchrono::Duration\u003e {\n        if self.status == EscalationStatus::Pending {\n            let now = Utc::now();\n            if now \u003c self.expires_at {\n                Some(self.expires_at - now)\n            } else {\n                Some(chrono::Duration::zero())\n            }\n        } else {\n            None\n        }\n    }\n\n    /// Check if the request is actionable (pending and not expired)\n    pub fn is_actionable(\u0026self) -\u003e bool {\n        self.status == EscalationStatus::Pending \u0026\u0026 !self.is_expired()\n    }\n\n    /// Create a summary for notifications\n    pub fn create_summary(\u0026self) -\u003e String {\n        format!(\n            \"Escalation Request: {} by agent {} for {:?} operation (Priority: {:?})\",\n            self.id, self.agent_id, self.operation_type, self.priority\n        )\n    }\n}\n\nimpl Entity for EscalationRequest {\n    fn entity_type() -\u003e \u0026'static str {\n        \"escalation_request\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e chrono::DateTime\u003cchrono::Utc\u003e {\n        self.updated_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        validator::Validate::validate(self)\n            .map_err(|e| crate::EngramError::Validation(format!(\"Validation failed: {}\", e)))\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.updated_at,\n            data: serde_json::to_value(self).expect(\"Failed to serialize EscalationRequest\"),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        if entity.entity_type != Self::entity_type() {\n            return Err(crate::EngramError::Validation(format!(\n                \"Expected entity type '{}', got '{}'\",\n                Self::entity_type(),\n                entity.entity_type\n            )));\n        }\n\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\n                \"Failed to deserialize EscalationRequest: {}\",\n                e\n            ))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n\nimpl std::fmt::Display for EscalationRequest {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        write!(\n            f,\n            \"EscalationRequest({}, agent: {}, operation: {:?}, status: {:?})\",\n            self.id, self.agent_id, self.operation_type, self.status\n        )\n    }\n}\n","traces":[{"line":217,"address":[22804559,22803200,22804848],"length":1,"stats":{"Line":2}},{"line":225,"address":[15922672],"length":1,"stats":{"Line":1}},{"line":228,"address":[15964717],"length":1,"stats":{"Line":2}},{"line":229,"address":[17389709],"length":1,"stats":{"Line":1}},{"line":230,"address":[16144882],"length":1,"stats":{"Line":1}},{"line":231,"address":[23264119],"length":1,"stats":{"Line":1}},{"line":232,"address":[16200924],"length":1,"stats":{"Line":0}},{"line":236,"address":[17389718],"length":1,"stats":{"Line":1}},{"line":250,"address":[23264398,23264472],"length":1,"stats":{"Line":3}},{"line":254,"address":[15923306],"length":1,"stats":{"Line":2}},{"line":259,"address":[17387936],"length":1,"stats":{"Line":0}},{"line":260,"address":[22801716],"length":1,"stats":{"Line":0}},{"line":261,"address":[16199210],"length":1,"stats":{"Line":0}},{"line":265,"address":[16072902,16072784],"length":1,"stats":{"Line":0}},{"line":266,"address":[15921694,15921556],"length":1,"stats":{"Line":0}},{"line":267,"address":[16143732],"length":1,"stats":{"Line":0}},{"line":271,"address":[16200399,16200428,16199856],"length":1,"stats":{"Line":0}},{"line":272,"address":[16143828,16143914],"length":1,"stats":{"Line":0}},{"line":273,"address":[22802496],"length":1,"stats":{"Line":0}},{"line":274,"address":[16200257],"length":1,"stats":{"Line":0}},{"line":275,"address":[23263523],"length":1,"stats":{"Line":0}},{"line":279,"address":[16072080],"length":1,"stats":{"Line":0}},{"line":280,"address":[23262110],"length":1,"stats":{"Line":0}},{"line":284,"address":[22801520],"length":1,"stats":{"Line":0}},{"line":285,"address":[23262206,23262271],"length":1,"stats":{"Line":0}},{"line":286,"address":[17387794],"length":1,"stats":{"Line":0}},{"line":287,"address":[17114297],"length":1,"stats":{"Line":0}},{"line":292,"address":[16202368,16202857,16202873],"length":1,"stats":{"Line":0}},{"line":293,"address":[17391145],"length":1,"stats":{"Line":0}},{"line":294,"address":[15924436,15924344],"length":1,"stats":{"Line":0}},{"line":296,"address":[16076001,16075706],"length":1,"stats":{"Line":0}},{"line":297,"address":[15924700,15924533],"length":1,"stats":{"Line":0}},{"line":298,"address":[17117872],"length":1,"stats":{"Line":0}},{"line":299,"address":[22805218],"length":1,"stats":{"Line":0}},{"line":305,"address":[16073616],"length":1,"stats":{"Line":0}},{"line":306,"address":[22803025,22802990],"length":1,"stats":{"Line":0}},{"line":307,"address":[23263699],"length":1,"stats":{"Line":0}},{"line":308,"address":[16073698,16073759,16073843],"length":1,"stats":{"Line":0}},{"line":309,"address":[17389349],"length":1,"stats":{"Line":0}},{"line":311,"address":[16073732],"length":1,"stats":{"Line":0}},{"line":314,"address":[22803018],"length":1,"stats":{"Line":0}},{"line":319,"address":[17387856],"length":1,"stats":{"Line":0}},{"line":320,"address":[17387869],"length":1,"stats":{"Line":0}},{"line":324,"address":[16072432],"length":1,"stats":{"Line":0}},{"line":325,"address":[17388041],"length":1,"stats":{"Line":0}},{"line":337,"address":[16065664],"length":1,"stats":{"Line":0}},{"line":338,"address":[17107749],"length":1,"stats":{"Line":0}},{"line":341,"address":[22795024],"length":1,"stats":{"Line":0}},{"line":342,"address":[16065685],"length":1,"stats":{"Line":0}},{"line":345,"address":[17381312],"length":1,"stats":{"Line":0}},{"line":346,"address":[17107816],"length":1,"stats":{"Line":0}},{"line":349,"address":[17107680],"length":1,"stats":{"Line":0}},{"line":350,"address":[15914370],"length":1,"stats":{"Line":0}},{"line":351,"address":[16136401],"length":1,"stats":{"Line":0}},{"line":354,"address":[15955583,15955104,15955589],"length":1,"stats":{"Line":2}},{"line":356,"address":[16135021],"length":1,"stats":{"Line":1}},{"line":357,"address":[17379927,17379855],"length":1,"stats":{"Line":3}},{"line":358,"address":[17106443],"length":1,"stats":{"Line":2}},{"line":359,"address":[15913180],"length":1,"stats":{"Line":1}},{"line":360,"address":[15955379,15955334],"length":1,"stats":{"Line":3}},{"line":364,"address":[16135520,16135940],"length":1,"stats":{"Line":0}},{"line":365,"address":[16191606,16191708],"length":1,"stats":{"Line":0}},{"line":366,"address":[15913974],"length":1,"stats":{"Line":0}},{"line":368,"address":[23254992,23255222],"length":1,"stats":{"Line":0}},{"line":373,"address":[19042585,19042579,19042336],"length":1,"stats":{"Line":0}},{"line":374,"address":[17623883,17623951],"length":1,"stats":{"Line":0}},{"line":381,"address":[23255728],"length":1,"stats":{"Line":0}},{"line":390,"address":[15929936],"length":1,"stats":{"Line":0}},{"line":391,"address":[15929963],"length":1,"stats":{"Line":0}}],"covered":15,"coverable":69},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","execution_result.rs"],"content":"//! ExecutionResult entity implementation\n//!\n//! Stores results from quality gate execution including command output,\n//! timing, environment context, and validation status.\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Validation status for quality gate execution\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum ValidationStatus {\n    /// Quality gate passed successfully\n    Passed,\n    /// Quality gate failed with reason\n    Failed { reason: String },\n    /// Quality gate was skipped with reason\n    Skipped { reason: String },\n}\n\n/// Expected result type for quality gates\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum ExpectedResult {\n    /// Command should succeed (exit code 0)\n    Success,\n    /// Command should fail (non-zero exit code) - for BDD RED phase\n    Failure,\n    /// Any result is acceptable\n    Any,\n}\n\n/// Execution result entity for quality gate output\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct ExecutionResult {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Associated task ID\n    #[serde(rename = \"task_id\")]\n    pub task_id: String,\n\n    /// Workflow stage when executed\n    #[serde(rename = \"workflow_stage\")]\n    pub workflow_stage: String,\n\n    /// Command that was executed\n    #[serde(rename = \"command\")]\n    pub command: String,\n\n    /// Command exit code\n    #[serde(rename = \"exit_code\")]\n    pub exit_code: i32,\n\n    /// Standard output\n    #[serde(rename = \"stdout\")]\n    pub stdout: String,\n\n    /// Standard error\n    #[serde(rename = \"stderr\")]\n    pub stderr: String,\n\n    /// Execution timestamp\n    #[serde(rename = \"timestamp\")]\n    pub timestamp: DateTime\u003cUtc\u003e,\n\n    /// Execution duration in milliseconds\n    #[serde(rename = \"duration_ms\")]\n    pub duration_ms: u64,\n\n    /// Environment variables at time of execution\n    #[serde(\n        rename = \"environment\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub environment: HashMap\u003cString, String\u003e,\n\n    /// Files that were changed during execution\n    #[serde(\n        rename = \"file_changes\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub file_changes: Vec\u003cString\u003e,\n\n    /// Expected result type\n    #[serde(rename = \"expected_result\")]\n    pub expected_result: Option\u003cExpectedResult\u003e,\n\n    /// Validation status\n    #[serde(rename = \"validation_status\")]\n    pub validation_status: ValidationStatus,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Working directory\n    #[serde(rename = \"working_directory\", skip_serializing_if = \"Option::is_none\")]\n    pub working_directory: Option\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Quality gate name/identifier\n    #[serde(rename = \"quality_gate\")]\n    pub quality_gate: String,\n\n    /// Retry count if this execution was retried\n    #[serde(rename = \"retry_count\", default)]\n    pub retry_count: u32,\n\n    /// Previous execution result ID if this is a retry\n    #[serde(\n        rename = \"previous_execution_id\",\n        skip_serializing_if = \"Option::is_none\"\n    )]\n    pub previous_execution_id: Option\u003cString\u003e,\n}\n\nimpl ExecutionResult {\n    /// Create a new execution result\n    pub fn new(\n        task_id: String,\n        workflow_stage: String,\n        quality_gate: String,\n        command: String,\n        agent: String,\n    ) -\u003e Self {\n        Self {\n            id: Uuid::new_v4().to_string(),\n            task_id,\n            workflow_stage,\n            command,\n            exit_code: 0,\n            stdout: String::new(),\n            stderr: String::new(),\n            timestamp: Utc::now(),\n            duration_ms: 0,\n            environment: HashMap::new(),\n            file_changes: Vec::new(),\n            expected_result: Some(ExpectedResult::Success),\n            validation_status: ValidationStatus::Passed,\n            agent,\n            working_directory: None,\n            metadata: HashMap::new(),\n            tags: Vec::new(),\n            quality_gate,\n            retry_count: 0,\n            previous_execution_id: None,\n        }\n    }\n\n    /// Set execution results\n    pub fn set_results(\n        \u0026mut self,\n        exit_code: i32,\n        stdout: String,\n        stderr: String,\n        duration_ms: u64,\n    ) {\n        self.exit_code = exit_code;\n        self.stdout = stdout;\n        self.stderr = stderr;\n        self.duration_ms = duration_ms;\n        self.timestamp = Utc::now();\n\n        self.update_validation_status();\n    }\n\n    /// Update validation status based on exit code and expected result\n    pub fn update_validation_status(\u0026mut self) {\n        match \u0026self.expected_result {\n            Some(ExpectedResult::Success) =\u003e {\n                if self.exit_code == 0 {\n                    self.validation_status = ValidationStatus::Passed;\n                } else {\n                    self.validation_status = ValidationStatus::Failed {\n                        reason: format!(\n                            \"Command failed with exit code {} (expected success)\",\n                            self.exit_code\n                        ),\n                    };\n                }\n            }\n            Some(ExpectedResult::Failure) =\u003e {\n                if self.exit_code != 0 {\n                    self.validation_status = ValidationStatus::Passed;\n                } else {\n                    self.validation_status = ValidationStatus::Failed {\n                        reason: \"Command succeeded but failure was expected (BDD RED phase)\"\n                            .to_string(),\n                    };\n                }\n            }\n            Some(ExpectedResult::Any) =\u003e {\n                self.validation_status = ValidationStatus::Passed;\n            }\n            None =\u003e {\n                if self.exit_code == 0 {\n                    self.validation_status = ValidationStatus::Passed;\n                } else {\n                    self.validation_status = ValidationStatus::Failed {\n                        reason: format!(\"Command failed with exit code {}\", self.exit_code),\n                    };\n                }\n            }\n        }\n    }\n\n    /// Set environment variables\n    pub fn set_environment(\u0026mut self, env: HashMap\u003cString, String\u003e) {\n        self.environment = env;\n    }\n\n    /// Add file change\n    pub fn add_file_change(\u0026mut self, file_path: String) {\n        if !self.file_changes.contains(\u0026file_path) {\n            self.file_changes.push(file_path);\n        }\n    }\n\n    /// Set expected result\n    pub fn set_expected_result(\u0026mut self, expected: ExpectedResult) {\n        self.expected_result = Some(expected);\n        self.update_validation_status();\n    }\n\n    /// Skip execution with reason\n    pub fn skip_execution(\u0026mut self, reason: String) {\n        self.validation_status = ValidationStatus::Skipped { reason };\n        self.timestamp = Utc::now();\n    }\n\n    /// Mark as retry\n    pub fn mark_as_retry(\u0026mut self, previous_id: String, retry_count: u32) {\n        self.previous_execution_id = Some(previous_id);\n        self.retry_count = retry_count;\n    }\n\n    /// Add metadata\n    pub fn add_metadata(\u0026mut self, key: String, value: serde_json::Value) {\n        self.metadata.insert(key, value);\n    }\n\n    /// Add tag\n    pub fn add_tag(\u0026mut self, tag: String) {\n        if !self.tags.contains(\u0026tag) {\n            self.tags.push(tag);\n        }\n    }\n\n    /// Check if execution passed\n    pub fn passed(\u0026self) -\u003e bool {\n        matches!(self.validation_status, ValidationStatus::Passed)\n    }\n\n    /// Check if execution failed\n    pub fn failed(\u0026self) -\u003e bool {\n        matches!(self.validation_status, ValidationStatus::Failed { .. })\n    }\n\n    /// Check if execution was skipped\n    pub fn skipped(\u0026self) -\u003e bool {\n        matches!(self.validation_status, ValidationStatus::Skipped { .. })\n    }\n\n    /// Get failure reason if failed\n    pub fn failure_reason(\u0026self) -\u003e Option\u003c\u0026str\u003e {\n        match \u0026self.validation_status {\n            ValidationStatus::Failed { reason } =\u003e Some(reason),\n            _ =\u003e None,\n        }\n    }\n\n    /// Get skip reason if skipped\n    pub fn skip_reason(\u0026self) -\u003e Option\u003c\u0026str\u003e {\n        match \u0026self.validation_status {\n            ValidationStatus::Skipped { reason } =\u003e Some(reason),\n            _ =\u003e None,\n        }\n    }\n}\n\nimpl Entity for ExecutionResult {\n    fn entity_type() -\u003e \u0026'static str {\n        \"execution_result\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.timestamp\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cExecutionResult as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.task_id.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"ExecutionResult must have a task_id\".to_string(),\n            ));\n        }\n\n        if self.workflow_stage.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"ExecutionResult must have a workflow_stage\".to_string(),\n            ));\n        }\n\n        if self.command.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"ExecutionResult must have a command\".to_string(),\n            ));\n        }\n\n        if self.quality_gate.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"ExecutionResult must have a quality_gate identifier\".to_string(),\n            ));\n        }\n\n        if self.agent.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"ExecutionResult must have an agent\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.timestamp,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\n                \"Failed to deserialize ExecutionResult: {}\",\n                e\n            ))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_new_execution_result() {\n        let result = ExecutionResult::new(\n            \"task-123\".to_string(),\n            \"development\".to_string(),\n            \"cargo-test\".to_string(),\n            \"cargo test\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        assert_eq!(result.task_id, \"task-123\");\n        assert_eq!(result.workflow_stage, \"development\");\n        assert_eq!(result.quality_gate, \"cargo-test\");\n        assert_eq!(result.command, \"cargo test\");\n        assert_eq!(result.agent, \"test-agent\");\n        assert_eq!(result.exit_code, 0);\n        assert!(result.passed());\n    }\n\n    #[test]\n    fn test_set_results_success() {\n        let mut result = ExecutionResult::new(\n            \"task-123\".to_string(),\n            \"development\".to_string(),\n            \"cargo-test\".to_string(),\n            \"cargo test\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        result.set_results(0, \"All tests passed\".to_string(), \"\".to_string(), 5000);\n\n        assert_eq!(result.exit_code, 0);\n        assert_eq!(result.stdout, \"All tests passed\");\n        assert_eq!(result.duration_ms, 5000);\n        assert!(result.passed());\n    }\n\n    #[test]\n    fn test_set_results_failure() {\n        let mut result = ExecutionResult::new(\n            \"task-123\".to_string(),\n            \"development\".to_string(),\n            \"cargo-test\".to_string(),\n            \"cargo test\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        result.set_results(1, \"\".to_string(), \"Test failed\".to_string(), 3000);\n\n        assert_eq!(result.exit_code, 1);\n        assert_eq!(result.stderr, \"Test failed\");\n        assert!(result.failed());\n    }\n\n    #[test]\n    fn test_bdd_red_phase_validation() {\n        let mut result = ExecutionResult::new(\n            \"task-123\".to_string(),\n            \"bdd\".to_string(),\n            \"cargo-test\".to_string(),\n            \"cargo test\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        result.set_expected_result(ExpectedResult::Failure);\n        result.set_results(\n            1,\n            \"\".to_string(),\n            \"Tests failed as expected\".to_string(),\n            2000,\n        );\n\n        assert_eq!(result.exit_code, 1);\n        assert!(result.passed());\n    }\n\n    #[test]\n    fn test_bdd_red_phase_unexpected_success() {\n        let mut result = ExecutionResult::new(\n            \"task-123\".to_string(),\n            \"bdd\".to_string(),\n            \"cargo-test\".to_string(),\n            \"cargo test\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        result.set_expected_result(ExpectedResult::Failure);\n        result.set_results(0, \"All tests passed\".to_string(), \"\".to_string(), 2000);\n\n        assert_eq!(result.exit_code, 0);\n        assert!(result.failed());\n        assert_eq!(\n            result.failure_reason().unwrap(),\n            \"Command succeeded but failure was expected (BDD RED phase)\"\n        );\n    }\n\n    #[test]\n    fn test_skip_execution() {\n        let mut result = ExecutionResult::new(\n            \"task-123\".to_string(),\n            \"development\".to_string(),\n            \"cargo-test\".to_string(),\n            \"cargo test\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        result.skip_execution(\"No tests in repository\".to_string());\n\n        assert!(result.skipped());\n        assert_eq!(result.skip_reason().unwrap(), \"No tests in repository\");\n    }\n\n    #[test]\n    fn test_entity_trait() {\n        let result = ExecutionResult::new(\n            \"task-123\".to_string(),\n            \"development\".to_string(),\n            \"cargo-test\".to_string(),\n            \"cargo test\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        assert_eq!(ExecutionResult::entity_type(), \"execution_result\");\n        assert_eq!(result.agent(), \"test-agent\");\n        assert!(result.validate_entity().is_ok());\n\n        let generic = result.to_generic();\n        assert_eq!(generic.entity_type, \"execution_result\");\n\n        let restored = ExecutionResult::from_generic(generic).unwrap();\n        assert_eq!(restored.task_id, \"task-123\");\n        assert_eq!(restored.quality_gate, \"cargo-test\");\n    }\n\n    #[test]\n    fn test_retry_functionality() {\n        let mut result = ExecutionResult::new(\n            \"task-123\".to_string(),\n            \"development\".to_string(),\n            \"cargo-test\".to_string(),\n            \"cargo test\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        result.mark_as_retry(\"previous-exec-456\".to_string(), 2);\n\n        assert_eq!(result.retry_count, 2);\n        assert_eq!(\n            result.previous_execution_id.as_ref().unwrap(),\n            \"previous-exec-456\"\n        );\n    }\n}\n","traces":[{"line":138,"address":[27992576,27994038,27994255],"length":1,"stats":{"Line":1}},{"line":146,"address":[21746761,21746882],"length":1,"stats":{"Line":2}},{"line":151,"address":[22313669],"length":1,"stats":{"Line":1}},{"line":152,"address":[20651664],"length":1,"stats":{"Line":1}},{"line":153,"address":[20862208],"length":1,"stats":{"Line":1}},{"line":155,"address":[27993036],"length":1,"stats":{"Line":2}},{"line":156,"address":[21747199],"length":1,"stats":{"Line":2}},{"line":161,"address":[21747324],"length":1,"stats":{"Line":2}},{"line":162,"address":[20791519],"length":1,"stats":{"Line":2}},{"line":170,"address":[22310224,22310610,22310636],"length":1,"stats":{"Line":2}},{"line":177,"address":[21743605],"length":1,"stats":{"Line":2}},{"line":178,"address":[20799461],"length":1,"stats":{"Line":2}},{"line":179,"address":[20858821],"length":1,"stats":{"Line":2}},{"line":180,"address":[22310520],"length":1,"stats":{"Line":2}},{"line":181,"address":[20859004,20858959],"length":1,"stats":{"Line":4}},{"line":183,"address":[20870546],"length":1,"stats":{"Line":2}},{"line":187,"address":[27990896,27991381],"length":1,"stats":{"Line":2}},{"line":188,"address":[20872279,20871668],"length":1,"stats":{"Line":2}},{"line":190,"address":[20861155,20861267,20860766],"length":1,"stats":{"Line":3}},{"line":191,"address":[22312621,22312404],"length":1,"stats":{"Line":1}},{"line":193,"address":[20872519,20872685],"length":1,"stats":{"Line":1}},{"line":194,"address":[20801616],"length":1,"stats":{"Line":1}},{"line":202,"address":[20650286,20651027,20651163],"length":1,"stats":{"Line":5}},{"line":203,"address":[22312934,22313101],"length":1,"stats":{"Line":1}},{"line":205,"address":[21746218,21746309],"length":1,"stats":{"Line":2}},{"line":207,"address":[21746184],"length":1,"stats":{"Line":2}},{"line":211,"address":[20651299],"length":1,"stats":{"Line":0}},{"line":212,"address":[20860805,20861669],"length":1,"stats":{"Line":0}},{"line":215,"address":[20801506,20800991],"length":1,"stats":{"Line":0}},{"line":216,"address":[20789341,20789562],"length":1,"stats":{"Line":0}},{"line":218,"address":[20871939,20872151],"length":1,"stats":{"Line":0}},{"line":219,"address":[20801036],"length":1,"stats":{"Line":0}},{"line":227,"address":[20649518,20649456],"length":1,"stats":{"Line":2}},{"line":228,"address":[20789074,20789149],"length":1,"stats":{"Line":3}},{"line":232,"address":[20859696,20859909,20859935],"length":1,"stats":{"Line":0}},{"line":233,"address":[20800467,20800552],"length":1,"stats":{"Line":0}},{"line":234,"address":[22311403,22311457],"length":1,"stats":{"Line":0}},{"line":239,"address":[22311648],"length":1,"stats":{"Line":2}},{"line":240,"address":[20800848],"length":1,"stats":{"Line":2}},{"line":241,"address":[20800854],"length":1,"stats":{"Line":2}},{"line":245,"address":[20859488,20859579],"length":1,"stats":{"Line":1}},{"line":246,"address":[27529706,27529598],"length":1,"stats":{"Line":2}},{"line":247,"address":[20871165],"length":1,"stats":{"Line":1}},{"line":251,"address":[20648816,20648720],"length":1,"stats":{"Line":1}},{"line":252,"address":[27529442,27529333],"length":1,"stats":{"Line":2}},{"line":253,"address":[20800134],"length":1,"stats":{"Line":1}},{"line":257,"address":[27989936],"length":1,"stats":{"Line":0}},{"line":258,"address":[27989954],"length":1,"stats":{"Line":0}},{"line":262,"address":[21748703,21748464,21748677],"length":1,"stats":{"Line":0}},{"line":263,"address":[20792696,20792611],"length":1,"stats":{"Line":0}},{"line":264,"address":[20653195,20653249],"length":1,"stats":{"Line":0}},{"line":269,"address":[21748448],"length":1,"stats":{"Line":1}},{"line":270,"address":[27533637],"length":1,"stats":{"Line":1}},{"line":274,"address":[27994288],"length":1,"stats":{"Line":1}},{"line":275,"address":[20653029],"length":1,"stats":{"Line":1}},{"line":279,"address":[20863808],"length":1,"stats":{"Line":1}},{"line":280,"address":[20792853],"length":1,"stats":{"Line":1}},{"line":284,"address":[20800160],"length":1,"stats":{"Line":1}},{"line":285,"address":[20859421],"length":1,"stats":{"Line":1}},{"line":286,"address":[20859431],"length":1,"stats":{"Line":1}},{"line":287,"address":[21744369],"length":1,"stats":{"Line":0}},{"line":292,"address":[20870608],"length":1,"stats":{"Line":1}},{"line":293,"address":[20648605],"length":1,"stats":{"Line":1}},{"line":294,"address":[20788215],"length":1,"stats":{"Line":1}},{"line":295,"address":[22310705],"length":1,"stats":{"Line":0}},{"line":305,"address":[20881168],"length":1,"stats":{"Line":0}},{"line":306,"address":[27539749],"length":1,"stats":{"Line":0}},{"line":309,"address":[28000432],"length":1,"stats":{"Line":1}},{"line":310,"address":[20659173],"length":1,"stats":{"Line":1}},{"line":313,"address":[28000480],"length":1,"stats":{"Line":0}},{"line":314,"address":[21754632],"length":1,"stats":{"Line":0}},{"line":317,"address":[20797905,20797899,20797312],"length":1,"stats":{"Line":1}},{"line":318,"address":[21753278],"length":1,"stats":{"Line":1}},{"line":322,"address":[20658102],"length":1,"stats":{"Line":0}},{"line":323,"address":[20880145],"length":1,"stats":{"Line":0}},{"line":324,"address":[23512803],"length":1,"stats":{"Line":0}},{"line":326,"address":[16639351],"length":1,"stats":{"Line":0}},{"line":327,"address":[18237104,18237120,18237010],"length":1,"stats":{"Line":0}},{"line":328,"address":[16854263],"length":1,"stats":{"Line":0}},{"line":331,"address":[27999510],"length":1,"stats":{"Line":0}},{"line":334,"address":[20868467],"length":1,"stats":{"Line":1}},{"line":335,"address":[20880534],"length":1,"stats":{"Line":0}},{"line":336,"address":[22320551],"length":1,"stats":{"Line":0}},{"line":340,"address":[27539060],"length":1,"stats":{"Line":1}},{"line":341,"address":[27539248],"length":1,"stats":{"Line":0}},{"line":342,"address":[20869121],"length":1,"stats":{"Line":0}},{"line":346,"address":[21754014],"length":1,"stats":{"Line":1}},{"line":347,"address":[20810045],"length":1,"stats":{"Line":0}},{"line":348,"address":[21754174],"length":1,"stats":{"Line":0}},{"line":352,"address":[20798199],"length":1,"stats":{"Line":1}},{"line":353,"address":[27539530],"length":1,"stats":{"Line":0}},{"line":354,"address":[27539499],"length":1,"stats":{"Line":0}},{"line":358,"address":[28000149],"length":1,"stats":{"Line":1}},{"line":359,"address":[20881085],"length":1,"stats":{"Line":0}},{"line":360,"address":[20659038],"length":1,"stats":{"Line":0}},{"line":364,"address":[20869522],"length":1,"stats":{"Line":1}},{"line":367,"address":[22319518,22319040,22319512],"length":1,"stats":{"Line":1}},{"line":369,"address":[20879021],"length":1,"stats":{"Line":1}},{"line":370,"address":[27537687,27537615],"length":1,"stats":{"Line":2}},{"line":371,"address":[20808363],"length":1,"stats":{"Line":1}},{"line":372,"address":[20796680],"length":1,"stats":{"Line":1}},{"line":373,"address":[20879275,20879218],"length":1,"stats":{"Line":2}},{"line":377,"address":[20797248,20796976],"length":1,"stats":{"Line":1}},{"line":378,"address":[20879526,20879620],"length":1,"stats":{"Line":2}},{"line":379,"address":[16853947,16854015],"length":1,"stats":{"Line":0}},{"line":386,"address":[21754608],"length":1,"stats":{"Line":0}}],"covered":67,"coverable":106},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","knowledge.rs"],"content":"//! Knowledge entity implementation\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Knowledge type variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum KnowledgeType {\n    Fact,\n    Pattern,\n    Rule,\n    Concept,\n    Procedure,\n    Heuristic,\n}\n\n/// Knowledge entity representing stored information\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct Knowledge {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Knowledge title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Knowledge content\n    #[serde(rename = \"content\")]\n    pub content: String,\n\n    /// Knowledge type\n    #[serde(rename = \"knowledge_type\")]\n    pub knowledge_type: KnowledgeType,\n\n    /// Confidence level (0.0 to 1.0)\n    #[serde(rename = \"confidence\")]\n    pub confidence: f64,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Creation timestamp\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// Last updated timestamp\n    #[serde(rename = \"updated_at\")]\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    /// Source of this knowledge\n    #[serde(rename = \"source\", skip_serializing_if = \"Option::is_none\")]\n    pub source: Option\u003cString\u003e,\n\n    /// Related knowledge IDs\n    #[serde(\n        rename = \"related_knowledge\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub related_knowledge: Vec\u003cString\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Contexts where this applies\n    #[serde(rename = \"contexts\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub contexts: Vec\u003cString\u003e,\n\n    /// Usage count (for tracking relevance)\n    #[serde(rename = \"usage_count\", default)]\n    pub usage_count: u64,\n\n    /// Last used timestamp\n    #[serde(rename = \"last_used\", skip_serializing_if = \"Option::is_none\")]\n    pub last_used: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\nimpl Knowledge {\n    /// Create a new knowledge item\n    pub fn new(\n        title: String,\n        content: String,\n        knowledge_type: KnowledgeType,\n        confidence: f64,\n        agent: String,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            content,\n            knowledge_type,\n            confidence: confidence.clamp(0.0, 1.0),\n            agent,\n            created_at: now,\n            updated_at: now,\n            source: None,\n            related_knowledge: Vec::new(),\n            tags: Vec::new(),\n            contexts: Vec::new(),\n            usage_count: 0,\n            last_used: None,\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Update knowledge content\n    pub fn update_content(\u0026mut self, content: String, confidence: f64) {\n        self.content = content;\n        self.confidence = confidence.clamp(0.0, 1.0);\n        self.updated_at = Utc::now();\n    }\n\n    /// Add related knowledge\n    pub fn add_related_knowledge(\u0026mut self, knowledge_id: String) {\n        if !self.related_knowledge.contains(\u0026knowledge_id) {\n            self.related_knowledge.push(knowledge_id);\n        }\n    }\n\n    /// Record usage\n    pub fn record_usage(\u0026mut self) {\n        self.usage_count += 1;\n        self.last_used = Some(Utc::now());\n    }\n\n    /// Add a tag\n    pub fn add_tag(\u0026mut self, tag: String) {\n        if !self.tags.contains(\u0026tag) {\n            self.tags.push(tag);\n        }\n    }\n\n    /// Add a context\n    pub fn add_context(\u0026mut self, context: String) {\n        if !self.contexts.contains(\u0026context) {\n            self.contexts.push(context);\n        }\n    }\n\n    /// Set source\n    pub fn set_source(\u0026mut self, source: String) {\n        self.source = Some(source);\n    }\n}\n\nimpl Entity for Knowledge {\n    fn entity_type() -\u003e \u0026'static str {\n        \"knowledge\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cKnowledge as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Knowledge title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.content.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Knowledge content cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.confidence \u003c 0.0 || self.confidence \u003e 1.0 {\n            return Err(crate::EngramError::Validation(\n                \"Confidence must be between 0.0 and 1.0\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize Knowledge: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":96,"address":[25463008,25464116,25464238],"length":1,"stats":{"Line":0}},{"line":103,"address":[25463068],"length":1,"stats":{"Line":0}},{"line":105,"address":[19771045],"length":1,"stats":{"Line":0}},{"line":109,"address":[18344051],"length":1,"stats":{"Line":0}},{"line":114,"address":[19771282],"length":1,"stats":{"Line":0}},{"line":115,"address":[25002801],"length":1,"stats":{"Line":0}},{"line":116,"address":[25002861],"length":1,"stats":{"Line":0}},{"line":119,"address":[18122340],"length":1,"stats":{"Line":0}},{"line":124,"address":[25462621,25462544],"length":1,"stats":{"Line":0}},{"line":125,"address":[18331806,18331894],"length":1,"stats":{"Line":0}},{"line":126,"address":[25002013],"length":1,"stats":{"Line":0}},{"line":127,"address":[18272697],"length":1,"stats":{"Line":0}},{"line":131,"address":[18121711,18121504,18121737],"length":1,"stats":{"Line":0}},{"line":132,"address":[18272771,18272853],"length":1,"stats":{"Line":0}},{"line":133,"address":[25462955,25462904],"length":1,"stats":{"Line":0}},{"line":138,"address":[25001728],"length":1,"stats":{"Line":0}},{"line":139,"address":[19770388,19770286],"length":1,"stats":{"Line":0}},{"line":140,"address":[25462455],"length":1,"stats":{"Line":0}},{"line":144,"address":[25464479,25464272,25464505],"length":1,"stats":{"Line":0}},{"line":145,"address":[18345125,18345043],"length":1,"stats":{"Line":0}},{"line":146,"address":[25464408,25464459],"length":1,"stats":{"Line":0}},{"line":151,"address":[18343109,18343135,18342896],"length":1,"stats":{"Line":0}},{"line":152,"address":[18344568,18344483],"length":1,"stats":{"Line":0}},{"line":153,"address":[18343035,18343089],"length":1,"stats":{"Line":0}},{"line":158,"address":[18271952,18272042],"length":1,"stats":{"Line":0}},{"line":159,"address":[18344302,18344409],"length":1,"stats":{"Line":0}},{"line":168,"address":[19776448],"length":1,"stats":{"Line":0}},{"line":169,"address":[25007909],"length":1,"stats":{"Line":0}},{"line":172,"address":[18337824],"length":1,"stats":{"Line":0}},{"line":173,"address":[18349349],"length":1,"stats":{"Line":0}},{"line":176,"address":[18337856],"length":1,"stats":{"Line":0}},{"line":177,"address":[25468632],"length":1,"stats":{"Line":0}},{"line":180,"address":[18126240,18126850,18126844],"length":1,"stats":{"Line":0}},{"line":181,"address":[25467534],"length":1,"stats":{"Line":0}},{"line":185,"address":[18126502],"length":1,"stats":{"Line":0}},{"line":186,"address":[19767025],"length":1,"stats":{"Line":0}},{"line":187,"address":[21463299],"length":1,"stats":{"Line":0}},{"line":189,"address":[22029959],"length":1,"stats":{"Line":0}},{"line":190,"address":[20590016,20589922,20590032],"length":1,"stats":{"Line":0}},{"line":191,"address":[27709191],"length":1,"stats":{"Line":0}},{"line":194,"address":[19775782],"length":1,"stats":{"Line":0}},{"line":197,"address":[19766867],"length":1,"stats":{"Line":0}},{"line":198,"address":[19767414],"length":1,"stats":{"Line":0}},{"line":199,"address":[25468151],"length":1,"stats":{"Line":0}},{"line":203,"address":[18278116],"length":1,"stats":{"Line":0}},{"line":204,"address":[25468320],"length":1,"stats":{"Line":0}},{"line":205,"address":[19767521],"length":1,"stats":{"Line":0}},{"line":209,"address":[18349022,18349160],"length":1,"stats":{"Line":0}},{"line":210,"address":[25468461],"length":1,"stats":{"Line":0}},{"line":211,"address":[18127166],"length":1,"stats":{"Line":0}},{"line":215,"address":[18337781],"length":1,"stats":{"Line":0}},{"line":218,"address":[18277111,18277105,18276640],"length":1,"stats":{"Line":1}},{"line":220,"address":[25466685],"length":1,"stats":{"Line":1}},{"line":221,"address":[25466699,25466771],"length":1,"stats":{"Line":2}},{"line":222,"address":[18349443],"length":1,"stats":{"Line":1}},{"line":223,"address":[18125589],"length":1,"stats":{"Line":1}},{"line":224,"address":[18349535,18349596],"length":1,"stats":{"Line":2}},{"line":228,"address":[18125904,18126177],"length":1,"stats":{"Line":0}},{"line":229,"address":[21463241,21463235,21462992],"length":1,"stats":{"Line":0}},{"line":230,"address":[27248203,27248271],"length":1,"stats":{"Line":0}},{"line":234,"address":[19776480],"length":1,"stats":{"Line":0}}],"covered":6,"coverable":61},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","mod.rs"],"content":"//! Core entity types for the Engram system\n//!\n//! This module provides extensible entity types that can be dynamically\n//! configured and extended through the configuration system.\n\npub mod adr;\npub mod agent_sandbox;\npub mod compliance;\npub mod context;\npub mod escalation_request;\npub mod execution_result;\npub mod knowledge;\npub mod progressive_config;\npub mod reasoning;\npub mod relationship;\npub mod rule;\npub mod session;\npub mod standard;\npub mod task;\npub mod workflow;\npub mod workflow_instance;\n\n// Re-export all entity types\npub use adr::*;\npub use agent_sandbox::*;\npub use compliance::*;\npub use context::*;\npub use escalation_request::*;\npub use execution_result::*;\npub use knowledge::*;\npub use progressive_config::*;\npub use reasoning::*;\npub use relationship::*;\npub use rule::*;\npub use session::*;\npub use standard::*;\npub use task::*;\npub use workflow::*;\npub use workflow_instance::*;\n\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n/// Trait for extensible entities\npub trait Entity: Serialize + for\u003c'de\u003e Deserialize\u003c'de\u003e + Send + Sync {\n    /// Get the entity type identifier\n    fn entity_type() -\u003e \u0026'static str;\n\n    /// Get the entity ID\n    fn id(\u0026self) -\u003e \u0026str;\n\n    /// Get the agent associated with this entity\n    fn agent(\u0026self) -\u003e \u0026str;\n\n    /// Get timestamp for this entity\n    fn timestamp(\u0026self) -\u003e chrono::DateTime\u003cchrono::Utc\u003e;\n\n    /// Validate the entity\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e;\n\n    /// Convert to generic representation\n    fn to_generic(\u0026self) -\u003e GenericEntity;\n\n    /// Create from generic representation\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e\n    where\n        Self: Sized;\n\n    /// Get entity type identifier (associated function)\n    fn get_entity_type() -\u003e \u0026'static str\n    where\n        Self: Sized,\n    {\n        Self::entity_type()\n    }\n\n    /// Get the entity ID (associated function)\n    fn get_id(entity: \u0026Self) -\u003e String\n    where\n        Self: Sized,\n    {\n        entity.id().to_string()\n    }\n\n    /// Get the agent associated with this entity (associated function)\n    fn get_agent(entity: \u0026Self) -\u003e String\n    where\n        Self: Sized,\n    {\n        entity.agent().to_string()\n    }\n\n    /// Get timestamp for this entity (associated function)\n    fn get_timestamp(entity: \u0026Self) -\u003e chrono::DateTime\u003cchrono::Utc\u003e\n    where\n        Self: Sized,\n    {\n        entity.timestamp()\n    }\n\n    /// Validate the entity (associated function)\n    fn validate_entity_static(entity: \u0026Self) -\u003e crate::Result\u003c()\u003e\n    where\n        Self: Sized,\n    {\n        entity.validate_entity()\n    }\n\n    /// Convert to generic representation (associated function)\n    fn to_generic_entity(entity: \u0026Self) -\u003e GenericEntity\n    where\n        Self: Sized,\n    {\n        entity.to_generic()\n    }\n\n    /// Convert to Any for downcasting\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized;\n\n    /// Downcast to specific type\n    fn downcast_ref\u003cT: Entity + 'static\u003e(\u0026self) -\u003e Option\u003c\u0026T\u003e\n    where\n        Self: Sized,\n    {\n        self.as_any().downcast_ref()\n    }\n}\n\n/// Generic entity representation for dynamic handling\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct GenericEntity {\n    pub id: String,\n    #[serde(alias = \"type\")]\n    pub entity_type: String,\n    pub agent: String,\n    pub timestamp: chrono::DateTime\u003cchrono::Utc\u003e,\n    pub data: serde_json::Value,\n}\n\nimpl GenericEntity {\n    /// Create a GenericEntity from a serde_json::Value\n    pub fn from_value(value: serde_json::Value) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(value).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\n                \"Failed to deserialize GenericEntity: {}\",\n                e\n            ))\n        })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_generic_entity_with_type_alias() {\n        let json = r#\"{\"id\":\"test\",\"type\":\"task\",\"agent\":\"sisyphus\",\"timestamp\":\"2026-01-08T23:24:57.759355781+01:00\",\"data\":{}}\"#;\n        let entity: GenericEntity =\n            serde_json::from_str(json).expect(\"Should deserialize with 'type' field\");\n        assert_eq!(entity.entity_type, \"task\");\n    }\n\n    #[test]\n    fn test_generic_entity_with_entity_type() {\n        let json = r#\"{\"id\":\"test\",\"entity_type\":\"task\",\"agent\":\"sisyphus\",\"timestamp\":\"2026-01-08T23:24:57.759355781+01:00\",\"data\":{}}\"#;\n        let entity: GenericEntity =\n            serde_json::from_str(json).expect(\"Should deserialize with 'entity_type' field\");\n        assert_eq!(entity.entity_type, \"task\");\n    }\n}\n\n/// Registry for entity types\npub struct EntityRegistry {\n    entities: HashMap\u003cString, EntityFactory\u003e,\n}\n\ntype EntityFactory = Box\u003cdyn Fn(GenericEntity) -\u003e crate::Result\u003cGenericEntity\u003e + Send + Sync\u003e;\n\nimpl EntityRegistry {\n    pub fn new() -\u003e Self {\n        Self {\n            entities: HashMap::new(),\n        }\n    }\n\n    pub fn register\u003cT\u003e(\u0026mut self)\n    where\n        T: Entity + 'static + for\u003c'de\u003e Deserialize\u003c'de\u003e + Serialize,\n    {\n        let factory = Box::new(|entity: GenericEntity| -\u003e crate::Result\u003cGenericEntity\u003e {\n            T::from_generic(entity.clone()).map(|t| t.to_generic())\n        });\n        self.entities.insert(T::entity_type().to_string(), factory);\n    }\n\n    pub fn create(\u0026self, entity: GenericEntity) -\u003e crate::Result\u003cGenericEntity\u003e {\n        let factory = self.entities.get(\u0026entity.entity_type).ok_or_else(|| {\n            crate::EngramError::Validation(format!(\"Unknown entity type: {}\", entity.entity_type))\n        })?;\n        factory(entity)\n    }\n\n    pub fn list_types(\u0026self) -\u003e Vec\u003c\u0026str\u003e {\n        self.entities.keys().map(|k| k.as_str()).collect()\n    }\n}\n\nimpl Default for EntityRegistry {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n","traces":[{"line":70,"address":[17849232],"length":1,"stats":{"Line":0}},{"line":74,"address":[17173745],"length":1,"stats":{"Line":0}},{"line":78,"address":[15387536],"length":1,"stats":{"Line":0}},{"line":82,"address":[21575728],"length":1,"stats":{"Line":0}},{"line":86,"address":[17837888],"length":1,"stats":{"Line":0}},{"line":90,"address":[17087360],"length":1,"stats":{"Line":0}},{"line":94,"address":[24157232],"length":1,"stats":{"Line":0}},{"line":98,"address":[23825889],"length":1,"stats":{"Line":0}},{"line":102,"address":[16782976],"length":1,"stats":{"Line":0}},{"line":106,"address":[14608337],"length":1,"stats":{"Line":0}},{"line":110,"address":[16638816],"length":1,"stats":{"Line":0}},{"line":114,"address":[21485217],"length":1,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[17921776],"length":1,"stats":{"Line":0}},{"line":145,"address":[24092336,24092579,24092585],"length":1,"stats":{"Line":0}},{"line":146,"address":[18702607,18702539],"length":1,"stats":{"Line":0}},{"line":183,"address":[19239136],"length":1,"stats":{"Line":7}},{"line":185,"address":[19239150],"length":1,"stats":{"Line":16}},{"line":189,"address":[24094363,24094593,24093825,24094640,24092848,24095105,24093360,24093851,24095408,24095643,24094619,24095152,24094384,24093339,24093057,24093313,24093569,24094081,24094107,24094896,24095387,24094128,24095361,24095617,24094337,24094849,24094875,24093104,24093616,24093872,24093595,24093083,24095131],"length":1,"stats":{"Line":116}},{"line":193,"address":[18707292,18703038,18704574,18704830,18706188,18703294,18704318,18706384,18706540,18706364,18707104,18706752,18707472,18707840,18703806,18706560,18706720,18706032,18705598,18706208,18706912,18703550,18706000,18705342,18705086,18707504,18707680,18704062,18707660,18706944,18707136,18707312,18705840],"length":1,"stats":{"Line":123}},{"line":194,"address":[18858080,18856571,18855980,18856763,18857454,18858000,18856718,18858096,18858480,18855804,18855848,18856024,18856200,18855659,18856379,18857600,18857276,18857131,18857904,18855614,18856526,18858464,18858560,18857086,18856952,18858192,18856156,18857696,18858272,18857320,18857792,18857808,18858384,18858576,18858176,18857616,18857888,18857499,18857712,18856334,18857984,18856908,18858288,18858368],"length":1,"stats":{"Line":0}},{"line":196,"address":[17220710,17221222,17221734,17221990,17219686,17219749,17221478,17221541,17222053,17220261,17219493,17220005,17221029,17221797,17221285,17220966,17219942,17220454,17220198,17220517,17220773,17219430],"length":1,"stats":{"Line":239}},{"line":199,"address":[19239807,19239200,19239778],"length":1,"stats":{"Line":0}},{"line":200,"address":[17933555,17933642,17933752],"length":1,"stats":{"Line":0}},{"line":201,"address":[14356777],"length":1,"stats":{"Line":0}},{"line":203,"address":[24592380],"length":1,"stats":{"Line":0}},{"line":206,"address":[19239056],"length":1,"stats":{"Line":0}},{"line":207,"address":[14356704,14356729],"length":1,"stats":{"Line":0}},{"line":212,"address":[17712720],"length":1,"stats":{"Line":0}},{"line":213,"address":[19240440],"length":1,"stats":{"Line":0}}],"covered":5,"coverable":30},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","progressive_config.rs"],"content":"use crate::entities::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse std::time::Duration;\nuse validator::Validate;\n\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct ProgressiveGateConfig {\n    pub id: String,\n    pub name: String,\n    pub description: String,\n    pub gate_levels: Vec\u003cGateLevel\u003e,\n    pub escalation_rules: Vec\u003cEscalationRule\u003e,\n    pub optimization_settings: OptimizationSettings,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub updated_at: DateTime\u003cUtc\u003e,\n    pub agent: String,\n    pub active: bool,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct GateLevel {\n    #[validate(length(min = 1))]\n    pub name: String,\n    pub threshold: ChangeThreshold,\n    pub required_gates: Vec\u003cQualityGate\u003e,\n    pub optional_gates: Vec\u003cQualityGate\u003e,\n    #[serde(with = \"duration_serde\")]\n    pub max_execution_time: Duration,\n    pub parallelization: ParallelizationStrategy,\n    pub failure_handling: FailureHandling,\n    pub enabled: bool,\n    pub priority: u32,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ChangeThreshold {\n    pub max_lines_changed: u32,\n    pub max_files_affected: u32,\n    pub max_complexity_delta: f32,\n    pub allowed_change_types: Vec\u003cChangeType\u003e,\n    pub risk_level_limit: ProgressiveRiskLevel,\n    pub file_patterns: Vec\u003cFilePattern\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct QualityGate {\n    pub name: String,\n    pub command: String,\n    #[serde(with = \"duration_serde\")]\n    pub timeout: Duration,\n    pub required: bool,\n    pub condition: Option\u003cGateCondition\u003e,\n    pub environment: HashMap\u003cString, String\u003e,\n    pub retry_policy: RetryPolicy,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum ParallelizationStrategy {\n    Sequential,\n    Parallel { max_concurrent: u32 },\n    Adaptive { based_on: Vec\u003cAdaptiveFactor\u003e },\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum AdaptiveFactor {\n    SystemLoad,\n    ChangeComplexity,\n    HistoricalDuration,\n    ResourceAvailability,\n    TimeOfDay,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct FailureHandling {\n    pub continue_on_optional_failure: bool,\n    pub fail_fast: bool,\n    pub escalate_on_failure: bool,\n    pub retry_failed_gates: bool,\n    pub notification_channels: Vec\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct EscalationRule {\n    pub name: String,\n    pub trigger: EscalationTrigger,\n    pub action: EscalationAction,\n    pub conditions: Vec\u003cEscalationCondition\u003e,\n    pub enabled: bool,\n    pub cooldown_period: Option\u003cDuration\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum EscalationTrigger {\n    GateFailure {\n        gate_name: String,\n        failure_count: u32,\n    },\n    TimeoutExceeded {\n        max_duration: Duration,\n    },\n    ResourceThresholdReached {\n        threshold: ResourceThreshold,\n    },\n    RiskLevelIncrease {\n        from: ProgressiveRiskLevel,\n        to: ProgressiveRiskLevel,\n    },\n    ConsecutiveFailures {\n        count: u32,\n        window: Duration,\n    },\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum EscalationAction {\n    EscalateTo { level_name: String },\n    TerminateAndEscalate { level_name: String },\n    NotifyOnly { channels: Vec\u003cString\u003e },\n    ManualApproval { approvers: Vec\u003cString\u003e },\n    SkipRemaining,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum EscalationCondition {\n    NotInBddRedPhase,\n    WorkingHours,\n    CriticalPathChange,\n    MinimumExecutionTime { duration: Duration },\n    MaxEscalationsPerDay { limit: u32 },\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct OptimizationSettings {\n    pub enable_historical_learning: bool,\n    pub performance_tracking: bool,\n    pub resource_optimization: bool,\n    pub cache_results: bool,\n    pub max_cache_age: Duration,\n    pub adaptive_timeouts: bool,\n    pub prediction_model: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, PartialOrd)]\npub enum ChangeType {\n    Documentation,\n    Comments,\n    Formatting,\n    BugFix,\n    Refactoring,\n    FeatureMinor,\n    Feature,\n    Enhancement,\n    BreakingChange,\n    SecurityCritical,\n    Performance,\n    Configuration,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, PartialOrd)]\npub enum ProgressiveRiskLevel {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct FilePattern {\n    pub pattern: String,\n    pub pattern_type: PatternType,\n    pub weight: f32,\n    pub risk_multiplier: f32,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum PatternType {\n    Glob,\n    Regex,\n    Extension,\n    Directory,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum GateCondition {\n    FilePatternMatch { patterns: Vec\u003cString\u003e },\n    ChangeTypeMatch { types: Vec\u003cChangeType\u003e },\n    RiskLevelAbove { level: ProgressiveRiskLevel },\n    LinesChangedAbove { count: u32 },\n    ComplexityDeltaAbove { threshold: f32 },\n    TimeWindowActive { start_hour: u8, end_hour: u8 },\n    EnvironmentVariable { var: String, value: String },\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RetryPolicy {\n    pub max_attempts: u32,\n    pub backoff_strategy: BackoffStrategy,\n    pub retry_conditions: Vec\u003cRetryCondition\u003e,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum BackoffStrategy {\n    Linear { increment: Duration },\n    Exponential { base: f32, max: Duration },\n    Fixed { delay: Duration },\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum RetryCondition {\n    ExitCodeEquals { code: i32 },\n    TimeoutOccurred,\n    ResourceUnavailable,\n    NetworkError,\n    TemporaryFailure,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ResourceThreshold {\n    pub memory_mb: Option\u003cu64\u003e,\n    pub cpu_percentage: Option\u003cf32\u003e,\n    pub disk_space_mb: Option\u003cu64\u003e,\n    pub network_bandwidth_mbps: Option\u003cf32\u003e,\n}\n\nimpl ProgressiveGateConfig {\n    pub fn new(name: String, agent: String) -\u003e Self {\n        Self {\n            id: uuid::Uuid::new_v4().to_string(),\n            name,\n            description: String::new(),\n            gate_levels: Vec::new(),\n            escalation_rules: Vec::new(),\n            optimization_settings: OptimizationSettings::default(),\n            created_at: Utc::now(),\n            updated_at: Utc::now(),\n            agent,\n            active: true,\n        }\n    }\n\n    pub fn add_gate_level(\u0026mut self, level: GateLevel) {\n        self.gate_levels.push(level);\n        self.updated_at = Utc::now();\n    }\n\n    pub fn find_appropriate_level(\u0026self, metrics: \u0026ComplexityMetrics) -\u003e Option\u003c\u0026GateLevel\u003e {\n        for level in \u0026self.gate_levels {\n            if self.meets_threshold(\u0026level.threshold, metrics) {\n                return Some(level);\n            }\n        }\n        self.gate_levels.last()\n    }\n\n    fn meets_threshold(\u0026self, threshold: \u0026ChangeThreshold, metrics: \u0026ComplexityMetrics) -\u003e bool {\n        metrics.lines_changed \u003c= threshold.max_lines_changed\n            \u0026\u0026 metrics.files_affected \u003c= threshold.max_files_affected\n            \u0026\u0026 metrics.complexity_delta \u003c= threshold.max_complexity_delta\n            \u0026\u0026 threshold\n                .allowed_change_types\n                .contains(\u0026metrics.primary_change_type)\n            \u0026\u0026 metrics.risk_level \u003c= threshold.risk_level_limit\n    }\n\n    pub fn get_enabled_levels(\u0026self) -\u003e Vec\u003c\u0026GateLevel\u003e {\n        self.gate_levels.iter().filter(|l| l.enabled).collect()\n    }\n}\n\nimpl Default for OptimizationSettings {\n    fn default() -\u003e Self {\n        Self {\n            enable_historical_learning: true,\n            performance_tracking: true,\n            resource_optimization: true,\n            cache_results: true,\n            max_cache_age: Duration::from_secs(3600),\n            adaptive_timeouts: true,\n            prediction_model: None,\n        }\n    }\n}\n\nimpl Default for FailureHandling {\n    fn default() -\u003e Self {\n        Self {\n            continue_on_optional_failure: true,\n            fail_fast: false,\n            escalate_on_failure: true,\n            retry_failed_gates: true,\n            notification_channels: Vec::new(),\n        }\n    }\n}\n\nimpl Default for RetryPolicy {\n    fn default() -\u003e Self {\n        Self {\n            max_attempts: 3,\n            backoff_strategy: BackoffStrategy::Exponential {\n                base: 2.0,\n                max: Duration::from_secs(300),\n            },\n            retry_conditions: vec![RetryCondition::TemporaryFailure],\n        }\n    }\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ComplexityMetrics {\n    pub lines_changed: u32,\n    pub files_affected: u32,\n    pub complexity_delta: f32,\n    pub primary_change_type: ChangeType,\n    pub risk_level: ProgressiveRiskLevel,\n    pub change_distribution: ChangeDistribution,\n    pub risk_factors: Vec\u003cString\u003e,\n    pub performance_impact: bool,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ChangeDistribution {\n    pub source_files: u32,\n    pub test_files: u32,\n    pub config_files: u32,\n    pub documentation: u32,\n    pub build_files: u32,\n}\n\nimpl Entity for ProgressiveGateConfig {\n    fn entity_type() -\u003e \u0026'static str {\n        \"progressive_gate_config\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cProgressiveGateConfig as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.name.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Config name cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.gate_levels.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"At least one gate level must be configured\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(generic: GenericEntity) -\u003e crate::Result\u003cSelf\u003e\n    where\n        Self: Sized,\n    {\n        serde_json::from_value(generic.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\n                \"Failed to deserialize ProgressiveGateConfig: {}\",\n                e\n            ))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n\nmod duration_serde {\n    use serde::{Deserialize, Deserializer, Serialize, Serializer};\n    use std::time::Duration;\n\n    pub fn serialize\u003cS\u003e(duration: \u0026Duration, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        duration.as_secs().serialize(serializer)\n    }\n\n    pub fn deserialize\u003c'de, D\u003e(deserializer: D) -\u003e Result\u003cDuration, D::Error\u003e\n    where\n        D: Deserializer\u003c'de\u003e,\n    {\n        let secs = u64::deserialize(deserializer)?;\n        Ok(Duration::from_secs(secs))\n    }\n}\n","traces":[{"line":228,"address":[15609765,15608960,15609800],"length":1,"stats":{"Line":0}},{"line":230,"address":[16918507,16918580],"length":1,"stats":{"Line":0}},{"line":232,"address":[22804620],"length":1,"stats":{"Line":0}},{"line":233,"address":[22343996],"length":1,"stats":{"Line":0}},{"line":234,"address":[15707765],"length":1,"stats":{"Line":0}},{"line":235,"address":[15458033],"length":1,"stats":{"Line":0}},{"line":236,"address":[15609341],"length":1,"stats":{"Line":0}},{"line":237,"address":[15458153],"length":1,"stats":{"Line":0}},{"line":243,"address":[22803920],"length":1,"stats":{"Line":0}},{"line":244,"address":[16917950],"length":1,"stats":{"Line":0}},{"line":245,"address":[15608440],"length":1,"stats":{"Line":0}},{"line":248,"address":[15845024],"length":1,"stats":{"Line":0}},{"line":249,"address":[16918332,16918312],"length":1,"stats":{"Line":0}},{"line":250,"address":[22343713],"length":1,"stats":{"Line":0}},{"line":251,"address":[22804447],"length":1,"stats":{"Line":0}},{"line":254,"address":[15457653],"length":1,"stats":{"Line":0}},{"line":257,"address":[22343328],"length":1,"stats":{"Line":0}},{"line":258,"address":[15707069,15707077],"length":1,"stats":{"Line":0}},{"line":259,"address":[15844806],"length":1,"stats":{"Line":0}},{"line":260,"address":[16611432],"length":1,"stats":{"Line":0}},{"line":261,"address":[15707132,15707159],"length":1,"stats":{"Line":0}},{"line":263,"address":[22343437],"length":1,"stats":{"Line":0}},{"line":264,"address":[22804135],"length":1,"stats":{"Line":0}},{"line":267,"address":[15679440],"length":1,"stats":{"Line":0}},{"line":268,"address":[15457456],"length":1,"stats":{"Line":0}},{"line":273,"address":[22795616],"length":1,"stats":{"Line":0}},{"line":279,"address":[15836445],"length":1,"stats":{"Line":0}},{"line":287,"address":[15721328],"length":1,"stats":{"Line":0}},{"line":293,"address":[16932317],"length":1,"stats":{"Line":0}},{"line":299,"address":[15468560],"length":1,"stats":{"Line":0}},{"line":302,"address":[16622695],"length":1,"stats":{"Line":0}},{"line":306,"address":[15468614,15468793],"length":1,"stats":{"Line":0}},{"line":337,"address":[15838256],"length":1,"stats":{"Line":0}},{"line":338,"address":[22336821],"length":1,"stats":{"Line":0}},{"line":341,"address":[16911520],"length":1,"stats":{"Line":0}},{"line":342,"address":[22336837],"length":1,"stats":{"Line":0}},{"line":345,"address":[15450784],"length":1,"stats":{"Line":0}},{"line":346,"address":[15700584],"length":1,"stats":{"Line":0}},{"line":349,"address":[16910608,16911212,16911218],"length":1,"stats":{"Line":0}},{"line":350,"address":[16603982],"length":1,"stats":{"Line":0}},{"line":354,"address":[16670368,16670382],"length":1,"stats":{"Line":0}},{"line":355,"address":[15837672],"length":1,"stats":{"Line":0}},{"line":356,"address":[16986003],"length":1,"stats":{"Line":0}},{"line":358,"address":[15735703],"length":1,"stats":{"Line":0}},{"line":359,"address":[16986018,16986064,16986080],"length":1,"stats":{"Line":0}},{"line":360,"address":[15513719],"length":1,"stats":{"Line":0}},{"line":363,"address":[15672262],"length":1,"stats":{"Line":0}},{"line":366,"address":[15837506],"length":1,"stats":{"Line":0}},{"line":367,"address":[22336599],"length":1,"stats":{"Line":0}},{"line":368,"address":[15450488],"length":1,"stats":{"Line":0}},{"line":372,"address":[16604580],"length":1,"stats":{"Line":0}},{"line":373,"address":[15601898],"length":1,"stats":{"Line":0}},{"line":374,"address":[15601867],"length":1,"stats":{"Line":0}},{"line":378,"address":[15601855],"length":1,"stats":{"Line":0}},{"line":381,"address":[15836997,15836544,15837003],"length":1,"stats":{"Line":0}},{"line":383,"address":[15600253],"length":1,"stats":{"Line":0}},{"line":384,"address":[15449019,15449091],"length":1,"stats":{"Line":0}},{"line":385,"address":[22335191],"length":1,"stats":{"Line":0}},{"line":386,"address":[22335253],"length":1,"stats":{"Line":0}},{"line":387,"address":[16603364,16603307],"length":1,"stats":{"Line":0}},{"line":391,"address":[15671784,15671504],"length":1,"stats":{"Line":0}},{"line":395,"address":[15699302,15699396],"length":1,"stats":{"Line":0}},{"line":396,"address":[22860175,22860107],"length":1,"stats":{"Line":0}},{"line":403,"address":[22336848],"length":1,"stats":{"Line":0}},{"line":415,"address":[18932432,18932557],"length":1,"stats":{"Line":0}},{"line":419,"address":[16772736,16772793],"length":1,"stats":{"Line":0}},{"line":422,"address":[24633056],"length":1,"stats":{"Line":0}},{"line":426,"address":[24172409],"length":1,"stats":{"Line":0}},{"line":427,"address":[17299032],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":69},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","reasoning.rs"],"content":"//! Reasoning chain entity implementation\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Step in a reasoning chain\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct ReasoningStep {\n    /// Step identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Step description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Step conclusion\n    #[serde(rename = \"conclusion\")]\n    pub conclusion: String,\n\n    /// Supporting evidence\n    #[serde(rename = \"evidence\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub evidence: Vec\u003cString\u003e,\n\n    /// Confidence level (0.0 to 1.0)\n    #[serde(rename = \"confidence\")]\n    pub confidence: f64,\n\n    /// Step timestamp\n    #[serde(rename = \"timestamp\")]\n    pub timestamp: DateTime\u003cUtc\u003e,\n}\n\n/// Reasoning chain entity\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct Reasoning {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Reasoning title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Task ID this reasoning belongs to\n    #[serde(rename = \"task_id\")]\n    pub task_id: String,\n\n    /// Reasoning steps in order\n    #[serde(rename = \"steps\")]\n    pub steps: Vec\u003cReasoningStep\u003e,\n\n    /// Final conclusion\n    #[serde(rename = \"conclusion\")]\n    pub conclusion: String,\n\n    /// Overall confidence\n    #[serde(rename = \"confidence\")]\n    pub confidence: f64,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Creation timestamp\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Supporting context IDs\n    #[serde(rename = \"context_ids\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub context_ids: Vec\u003cString\u003e,\n\n    /// Supporting knowledge IDs\n    #[serde(\n        rename = \"knowledge_ids\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub knowledge_ids: Vec\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\nimpl Reasoning {\n    /// Create a new reasoning chain\n    pub fn new(title: String, task_id: String, agent: String) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            task_id,\n            steps: Vec::new(),\n            conclusion: String::new(),\n            confidence: 0.0,\n            agent,\n            created_at: now,\n            tags: Vec::new(),\n            context_ids: Vec::new(),\n            knowledge_ids: Vec::new(),\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Add a reasoning step\n    pub fn add_step(\u0026mut self, description: String, conclusion: String, confidence: f64) {\n        let step = ReasoningStep {\n            id: Uuid::new_v4().to_string(),\n            description,\n            conclusion,\n            evidence: Vec::new(),\n            confidence: confidence.clamp(0.0, 1.0),\n            timestamp: Utc::now(),\n        };\n        self.steps.push(step);\n        self.recalculate_confidence();\n    }\n\n    /// Add evidence to the last step\n    pub fn add_evidence_to_last_step(\u0026mut self, evidence: String) {\n        if let Some(last_step) = self.steps.last_mut() {\n            last_step.evidence.push(evidence);\n        }\n    }\n\n    /// Set final conclusion\n    pub fn set_conclusion(\u0026mut self, conclusion: String, confidence: f64) {\n        self.conclusion = conclusion;\n        self.confidence = confidence.clamp(0.0, 1.0);\n    }\n\n    /// Recalculate overall confidence based on steps\n    fn recalculate_confidence(\u0026mut self) {\n        if self.steps.is_empty() {\n            self.confidence = 0.0;\n            return;\n        }\n\n        let total_confidence: f64 = self.steps.iter().map(|s| s.confidence).sum();\n        self.confidence = (total_confidence / self.steps.len() as f64).clamp(0.0, 1.0);\n    }\n}\n\nimpl Entity for Reasoning {\n    fn entity_type() -\u003e \u0026'static str {\n        \"reasoning\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cReasoning as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Reasoning title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.task_id.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Task ID cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.confidence \u003c 0.0 || self.confidence \u003e 1.0 {\n            return Err(crate::EngramError::Validation(\n                \"Confidence must be between 0.0 and 1.0\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize Reasoning: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":100,"address":[18365248,18366298,18366416],"length":1,"stats":{"Line":0}},{"line":101,"address":[25035375],"length":1,"stats":{"Line":0}},{"line":103,"address":[18306136],"length":1,"stats":{"Line":0}},{"line":106,"address":[18377007],"length":1,"stats":{"Line":0}},{"line":107,"address":[18306310],"length":1,"stats":{"Line":0}},{"line":111,"address":[17819121],"length":1,"stats":{"Line":0}},{"line":112,"address":[18365704],"length":1,"stats":{"Line":0}},{"line":113,"address":[19865524],"length":1,"stats":{"Line":0}},{"line":114,"address":[19795824],"length":1,"stats":{"Line":0}},{"line":119,"address":[19866208,19866869,19866794],"length":1,"stats":{"Line":0}},{"line":121,"address":[17820073,17820013],"length":1,"stats":{"Line":0}},{"line":124,"address":[18307436],"length":1,"stats":{"Line":0}},{"line":125,"address":[17820252],"length":1,"stats":{"Line":0}},{"line":126,"address":[17820306],"length":1,"stats":{"Line":0}},{"line":128,"address":[18156498],"length":1,"stats":{"Line":0}},{"line":129,"address":[18156523],"length":1,"stats":{"Line":0}},{"line":133,"address":[25035303,25035072,25035329],"length":1,"stats":{"Line":0}},{"line":134,"address":[19864827,19864750],"length":1,"stats":{"Line":0}},{"line":135,"address":[18154691,18154640],"length":1,"stats":{"Line":0}},{"line":140,"address":[25034656,25034733],"length":1,"stats":{"Line":0}},{"line":141,"address":[18376198,18376110],"length":1,"stats":{"Line":0}},{"line":142,"address":[18305453],"length":1,"stats":{"Line":0}},{"line":146,"address":[18364736],"length":1,"stats":{"Line":0}},{"line":147,"address":[17818286],"length":1,"stats":{"Line":0}},{"line":148,"address":[25495716],"length":1,"stats":{"Line":0}},{"line":152,"address":[19794773],"length":1,"stats":{"Line":0}},{"line":153,"address":[18305606],"length":1,"stats":{"Line":0}},{"line":162,"address":[25041616],"length":1,"stats":{"Line":0}},{"line":163,"address":[18371525],"length":1,"stats":{"Line":0}},{"line":166,"address":[19801536],"length":1,"stats":{"Line":0}},{"line":167,"address":[19801541],"length":1,"stats":{"Line":0}},{"line":170,"address":[18371568],"length":1,"stats":{"Line":0}},{"line":171,"address":[18383096],"length":1,"stats":{"Line":0}},{"line":174,"address":[19800448,19801058,19801052],"length":1,"stats":{"Line":0}},{"line":175,"address":[17823886],"length":1,"stats":{"Line":0}},{"line":179,"address":[25501478],"length":1,"stats":{"Line":0}},{"line":180,"address":[25501505],"length":1,"stats":{"Line":0}},{"line":181,"address":[18780851],"length":1,"stats":{"Line":0}},{"line":183,"address":[17147495],"length":1,"stats":{"Line":0}},{"line":184,"address":[17291712,17291728,17291618],"length":1,"stats":{"Line":0}},{"line":185,"address":[18780887],"length":1,"stats":{"Line":0}},{"line":188,"address":[18160358],"length":1,"stats":{"Line":0}},{"line":191,"address":[18370579],"length":1,"stats":{"Line":0}},{"line":192,"address":[17824517],"length":1,"stats":{"Line":0}},{"line":193,"address":[25501863],"length":1,"stats":{"Line":0}},{"line":197,"address":[19801076],"length":1,"stats":{"Line":0}},{"line":198,"address":[25502032],"length":1,"stats":{"Line":0}},{"line":199,"address":[17824624],"length":1,"stats":{"Line":0}},{"line":203,"address":[18371352,18371214],"length":1,"stats":{"Line":0}},{"line":204,"address":[25502173],"length":1,"stats":{"Line":0}},{"line":205,"address":[19871134],"length":1,"stats":{"Line":0}},{"line":209,"address":[25041589],"length":1,"stats":{"Line":0}},{"line":212,"address":[17823024,17823477,17823483],"length":1,"stats":{"Line":0}},{"line":214,"address":[25500381],"length":1,"stats":{"Line":0}},{"line":215,"address":[25500395,25500467],"length":1,"stats":{"Line":0}},{"line":216,"address":[18381239],"length":1,"stats":{"Line":0}},{"line":217,"address":[18310533],"length":1,"stats":{"Line":0}},{"line":218,"address":[19869563,19869620],"length":1,"stats":{"Line":0}},{"line":222,"address":[19800096,19800376],"length":1,"stats":{"Line":0}},{"line":223,"address":[16278261,16278016,16278255],"length":1,"stats":{"Line":0}},{"line":224,"address":[17291391,17291323],"length":1,"stats":{"Line":0}},{"line":228,"address":[19871312],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":62},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","relationship.rs"],"content":"//! Entity relationship management for graph-based operations\n//!\n//! This module provides comprehensive relationship modeling between entities,\n//! supporting graph traversal, relationship queries, and complex data modeling.\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\nuse super::{Entity, GenericEntity};\n\n/// Direction of a relationship between entities\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\npub enum RelationshipDirection {\n    /// Bidirectional relationship (A \u003c-\u003e B)\n    Bidirectional,\n    /// Unidirectional relationship (A -\u003e B)\n    Unidirectional,\n    /// Inverse relationship (B -\u003e A)\n    Inverse,\n}\n\n/// Type of relationship between entities\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, Hash)]\npub enum EntityRelationType {\n    /// Direct dependency (Task A depends on Task B)\n    DependsOn,\n    /// Parent-child relationship (Task A has child Task B)\n    Contains,\n    /// Reference relationship (Context A references Knowledge B)\n    References,\n    /// Fulfills relationship (Task A fulfills Requirement B)\n    Fulfills,\n    /// Implements relationship (Implementation A implements Standard B)\n    Implements,\n    /// Supersedes relationship (ADR A supersedes ADR B)\n    Supersedes,\n    /// Associates with (Session A associated with Task B)\n    AssociatedWith,\n    /// Influences relationship (Rule A influences Workflow B)\n    Influences,\n    /// Custom relationship type\n    Custom(String),\n}\n\nimpl std::fmt::Display for EntityRelationType {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            EntityRelationType::DependsOn =\u003e write!(f, \"depends_on\"),\n            EntityRelationType::Contains =\u003e write!(f, \"contains\"),\n            EntityRelationType::References =\u003e write!(f, \"references\"),\n            EntityRelationType::Fulfills =\u003e write!(f, \"fulfills\"),\n            EntityRelationType::Implements =\u003e write!(f, \"implements\"),\n            EntityRelationType::Supersedes =\u003e write!(f, \"supersedes\"),\n            EntityRelationType::AssociatedWith =\u003e write!(f, \"associated_with\"),\n            EntityRelationType::Influences =\u003e write!(f, \"influences\"),\n            EntityRelationType::Custom(name) =\u003e write!(f, \"{}\", name),\n        }\n    }\n}\n\n/// Strength of a relationship (for weighted graph algorithms)\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\npub enum RelationshipStrength {\n    Weak,\n    Medium,\n    Strong,\n    Critical,\n    Custom(f64), // 0.0 to 1.0\n}\n\nimpl RelationshipStrength {\n    /// Get numeric value for algorithms (0.0 to 1.0)\n    pub fn weight(\u0026self) -\u003e f64 {\n        match self {\n            RelationshipStrength::Weak =\u003e 0.25,\n            RelationshipStrength::Medium =\u003e 0.5,\n            RelationshipStrength::Strong =\u003e 0.75,\n            RelationshipStrength::Critical =\u003e 1.0,\n            RelationshipStrength::Custom(w) =\u003e w.clamp(0.0, 1.0),\n        }\n    }\n}\n\n/// Constraints for relationship validation\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct RelationshipConstraints {\n    /// Maximum number of outbound relationships of this type\n    pub max_outbound: Option\u003cusize\u003e,\n    /// Maximum number of inbound relationships of this type\n    pub max_inbound: Option\u003cusize\u003e,\n    /// Whether this relationship can create cycles\n    pub allow_cycles: bool,\n    /// Required entity types for source\n    pub source_types: Option\u003cVec\u003cString\u003e\u003e,\n    /// Required entity types for target\n    pub target_types: Option\u003cVec\u003cString\u003e\u003e,\n}\n\nimpl Default for RelationshipConstraints {\n    fn default() -\u003e Self {\n        Self {\n            max_outbound: None,\n            max_inbound: None,\n            allow_cycles: true,\n            source_types: None,\n            target_types: None,\n        }\n    }\n}\n\n/// Core entity relationship structure\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct EntityRelationship {\n    /// Unique identifier for this relationship\n    pub id: String,\n    /// Agent who created this relationship\n    pub agent: String,\n    /// Creation timestamp\n    pub timestamp: DateTime\u003cUtc\u003e,\n    /// Source entity ID\n    pub source_id: String,\n    /// Source entity type\n    pub source_type: String,\n    /// Target entity ID\n    pub target_id: String,\n    /// Target entity type\n    pub target_type: String,\n    /// Type of relationship\n    pub relationship_type: EntityRelationType,\n    /// Direction of relationship\n    pub direction: RelationshipDirection,\n    /// Strength of relationship\n    pub strength: RelationshipStrength,\n    /// Relationship constraints\n    pub constraints: RelationshipConstraints,\n    /// Custom metadata for the relationship\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n    /// Optional human-readable description\n    pub description: Option\u003cString\u003e,\n    /// Whether this relationship is active\n    pub active: bool,\n}\n\nimpl EntityRelationship {\n    /// Create a new entity relationship\n    pub fn new(\n        id: String,\n        agent: String,\n        source_id: String,\n        source_type: String,\n        target_id: String,\n        target_type: String,\n        relationship_type: EntityRelationType,\n    ) -\u003e Self {\n        Self {\n            id,\n            agent,\n            timestamp: Utc::now(),\n            source_id,\n            source_type,\n            target_id,\n            target_type,\n            relationship_type,\n            direction: RelationshipDirection::Unidirectional,\n            strength: RelationshipStrength::Medium,\n            constraints: RelationshipConstraints::default(),\n            metadata: HashMap::new(),\n            description: None,\n            active: true,\n        }\n    }\n\n    /// Set relationship direction\n    pub fn with_direction(mut self, direction: RelationshipDirection) -\u003e Self {\n        self.direction = direction;\n        self\n    }\n\n    /// Set relationship strength\n    pub fn with_strength(mut self, strength: RelationshipStrength) -\u003e Self {\n        self.strength = strength;\n        self\n    }\n\n    /// Set relationship constraints\n    pub fn with_constraints(mut self, constraints: RelationshipConstraints) -\u003e Self {\n        self.constraints = constraints;\n        self\n    }\n\n    /// Add metadata\n    pub fn with_metadata(mut self, key: String, value: serde_json::Value) -\u003e Self {\n        self.metadata.insert(key, value);\n        self\n    }\n\n    /// Set description\n    pub fn with_description(mut self, description: String) -\u003e Self {\n        self.description = Some(description);\n        self\n    }\n\n    /// Check if this relationship involves the given entity\n    pub fn involves_entity(\u0026self, entity_id: \u0026str) -\u003e bool {\n        self.source_id == entity_id || self.target_id == entity_id\n    }\n\n    /// Get the other entity ID in the relationship\n    pub fn get_other_entity(\u0026self, entity_id: \u0026str) -\u003e Option\u003c\u0026str\u003e {\n        if self.source_id == entity_id {\n            Some(\u0026self.target_id)\n        } else if self.target_id == entity_id {\n            Some(\u0026self.source_id)\n        } else {\n            None\n        }\n    }\n\n    /// Check if this relationship allows traversal from source to target\n    pub fn allows_traversal_to(\u0026self, from_id: \u0026str, to_id: \u0026str) -\u003e bool {\n        if !self.active {\n            return false;\n        }\n\n        match self.direction {\n            RelationshipDirection::Bidirectional =\u003e {\n                (self.source_id == from_id \u0026\u0026 self.target_id == to_id)\n                    || (self.source_id == to_id \u0026\u0026 self.target_id == from_id)\n            }\n            RelationshipDirection::Unidirectional =\u003e {\n                self.source_id == from_id \u0026\u0026 self.target_id == to_id\n            }\n            RelationshipDirection::Inverse =\u003e self.source_id == to_id \u0026\u0026 self.target_id == from_id,\n        }\n    }\n\n    /// Validate relationship constraints\n    pub fn validate_constraints(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        // Check entity type constraints\n        if let Some(ref source_types) = self.constraints.source_types {\n            if !source_types.contains(\u0026self.source_type) {\n                return Err(crate::EngramError::Validation(format!(\n                    \"Source type '{}' not allowed for this relationship\",\n                    self.source_type\n                )));\n            }\n        }\n\n        if let Some(ref target_types) = self.constraints.target_types {\n            if !target_types.contains(\u0026self.target_type) {\n                return Err(crate::EngramError::Validation(format!(\n                    \"Target type '{}' not allowed for this relationship\",\n                    self.target_type\n                )));\n            }\n        }\n\n        Ok(())\n    }\n}\n\nimpl Entity for EntityRelationship {\n    fn entity_type() -\u003e \u0026'static str {\n        \"relationship\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.timestamp\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if self.id.trim().is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Relationship ID cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.source_id.trim().is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Source ID cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.target_id.trim().is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Target ID cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.source_id == self.target_id {\n            return Err(crate::EngramError::Validation(\n                \"Self-relationships are not allowed\".to_string(),\n            ));\n        }\n\n        if self.source_type.trim().is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Source type cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.target_type.trim().is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Target type cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.agent.trim().is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Agent cannot be empty\".to_string(),\n            ));\n        }\n\n        self.validate_constraints()?;\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.timestamp,\n            data: serde_json::to_value(self).expect(\"Failed to serialize relationship\"),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        if entity.entity_type != Self::entity_type() {\n            return Err(crate::EngramError::Deserialization(format!(\n                \"Expected entity type '{}', got '{}'\",\n                Self::entity_type(),\n                entity.entity_type\n            )));\n        }\n\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\n                \"Failed to deserialize relationship: {}\",\n                e\n            ))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any {\n        self\n    }\n}\n\n/// Query filter for relationships\n#[derive(Debug, Clone, Default)]\npub struct RelationshipFilter {\n    /// Filter by source entity ID\n    pub source_id: Option\u003cString\u003e,\n    /// Filter by target entity ID\n    pub target_id: Option\u003cString\u003e,\n    /// Filter by entity ID (either source or target)\n    pub entity_id: Option\u003cString\u003e,\n    /// Filter by relationship type\n    pub relationship_type: Option\u003cEntityRelationType\u003e,\n    /// Filter by direction\n    pub direction: Option\u003cRelationshipDirection\u003e,\n    /// Filter by strength minimum\n    pub min_strength: Option\u003cf64\u003e,\n    /// Filter by active status\n    pub active_only: Option\u003cbool\u003e,\n    /// Filter by source entity type\n    pub source_type: Option\u003cString\u003e,\n    /// Filter by target entity type  \n    pub target_type: Option\u003cString\u003e,\n    /// Filter by agent\n    pub agent: Option\u003cString\u003e,\n}\n\nimpl RelationshipFilter {\n    /// Create a new empty filter\n    pub fn new() -\u003e Self {\n        Self::default()\n    }\n\n    /// Filter by source entity\n    pub fn source(mut self, source_id: String) -\u003e Self {\n        self.source_id = Some(source_id);\n        self\n    }\n\n    /// Filter by target entity\n    pub fn target(mut self, target_id: String) -\u003e Self {\n        self.target_id = Some(target_id);\n        self\n    }\n\n    /// Filter by entity (either source or target)\n    pub fn entity(mut self, entity_id: String) -\u003e Self {\n        self.entity_id = Some(entity_id);\n        self\n    }\n\n    /// Filter by relationship type\n    pub fn relationship_type(mut self, rel_type: EntityRelationType) -\u003e Self {\n        self.relationship_type = Some(rel_type);\n        self\n    }\n\n    /// Filter by direction\n    pub fn direction(mut self, direction: RelationshipDirection) -\u003e Self {\n        self.direction = Some(direction);\n        self\n    }\n\n    /// Filter by minimum strength\n    pub fn min_strength(mut self, strength: f64) -\u003e Self {\n        self.min_strength = Some(strength);\n        self\n    }\n\n    /// Filter active relationships only\n    pub fn active_only(mut self) -\u003e Self {\n        self.active_only = Some(true);\n        self\n    }\n\n    /// Check if a relationship matches this filter\n    pub fn matches(\u0026self, relationship: \u0026EntityRelationship) -\u003e bool {\n        if let Some(ref source_id) = self.source_id {\n            if \u0026relationship.source_id != source_id {\n                return false;\n            }\n        }\n\n        if let Some(ref target_id) = self.target_id {\n            if \u0026relationship.target_id != target_id {\n                return false;\n            }\n        }\n\n        if let Some(ref entity_id) = self.entity_id {\n            if !relationship.involves_entity(entity_id) {\n                return false;\n            }\n        }\n\n        if let Some(ref rel_type) = self.relationship_type {\n            if \u0026relationship.relationship_type != rel_type {\n                return false;\n            }\n        }\n\n        if let Some(ref direction) = self.direction {\n            if \u0026relationship.direction != direction {\n                return false;\n            }\n        }\n\n        if let Some(min_strength) = self.min_strength {\n            if relationship.strength.weight() \u003c min_strength {\n                return false;\n            }\n        }\n\n        if let Some(active_only) = self.active_only {\n            if active_only \u0026\u0026 !relationship.active {\n                return false;\n            }\n        }\n\n        if let Some(ref source_type) = self.source_type {\n            if \u0026relationship.source_type != source_type {\n                return false;\n            }\n        }\n\n        if let Some(ref target_type) = self.target_type {\n            if \u0026relationship.target_type != target_type {\n                return false;\n            }\n        }\n\n        if let Some(ref agent) = self.agent {\n            if \u0026relationship.agent != agent {\n                return false;\n            }\n        }\n\n        true\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_relationship_creation() {\n        let relationship = EntityRelationship::new(\n            \"rel-001\".to_string(),\n            \"test-agent\".to_string(),\n            \"task-001\".to_string(),\n            \"task\".to_string(),\n            \"task-002\".to_string(),\n            \"task\".to_string(),\n            EntityRelationType::DependsOn,\n        );\n\n        assert_eq!(relationship.id, \"rel-001\");\n        assert_eq!(relationship.agent, \"test-agent\");\n        assert_eq!(relationship.source_id, \"task-001\");\n        assert_eq!(relationship.target_id, \"task-002\");\n        assert_eq!(\n            relationship.relationship_type,\n            EntityRelationType::DependsOn\n        );\n        assert!(relationship.active);\n    }\n\n    #[test]\n    fn test_relationship_direction() {\n        let mut relationship = EntityRelationship::new(\n            \"rel-001\".to_string(),\n            \"test-agent\".to_string(),\n            \"task-001\".to_string(),\n            \"task\".to_string(),\n            \"task-002\".to_string(),\n            \"task\".to_string(),\n            EntityRelationType::DependsOn,\n        );\n\n        // Test unidirectional (default)\n        assert!(relationship.allows_traversal_to(\"task-001\", \"task-002\"));\n        assert!(!relationship.allows_traversal_to(\"task-002\", \"task-001\"));\n\n        // Test bidirectional\n        relationship.direction = RelationshipDirection::Bidirectional;\n        assert!(relationship.allows_traversal_to(\"task-001\", \"task-002\"));\n        assert!(relationship.allows_traversal_to(\"task-002\", \"task-001\"));\n\n        // Test inverse\n        relationship.direction = RelationshipDirection::Inverse;\n        assert!(!relationship.allows_traversal_to(\"task-001\", \"task-002\"));\n        assert!(relationship.allows_traversal_to(\"task-002\", \"task-001\"));\n    }\n\n    #[test]\n    fn test_relationship_validation() {\n        let relationship = EntityRelationship::new(\n            \"rel-001\".to_string(),\n            \"test-agent\".to_string(),\n            \"task-001\".to_string(),\n            \"task\".to_string(),\n            \"task-002\".to_string(),\n            \"task\".to_string(),\n            EntityRelationType::DependsOn,\n        );\n\n        assert!(relationship.validate_entity().is_ok());\n\n        // Test self-relationship validation\n        let self_rel = EntityRelationship::new(\n            \"rel-002\".to_string(),\n            \"test-agent\".to_string(),\n            \"task-001\".to_string(),\n            \"task\".to_string(),\n            \"task-001\".to_string(),\n            \"task\".to_string(),\n            EntityRelationType::DependsOn,\n        );\n\n        assert!(self_rel.validate_entity().is_err());\n    }\n\n    #[test]\n    fn test_relationship_filter() {\n        let relationship = EntityRelationship::new(\n            \"rel-001\".to_string(),\n            \"test-agent\".to_string(),\n            \"task-001\".to_string(),\n            \"task\".to_string(),\n            \"task-002\".to_string(),\n            \"task\".to_string(),\n            EntityRelationType::DependsOn,\n        );\n\n        let filter = RelationshipFilter::new()\n            .source(\"task-001\".to_string())\n            .relationship_type(EntityRelationType::DependsOn)\n            .active_only();\n\n        assert!(filter.matches(\u0026relationship));\n\n        let filter2 = RelationshipFilter::new().source(\"task-999\".to_string());\n        assert!(!filter2.matches(\u0026relationship));\n    }\n\n    #[test]\n    fn test_relationship_strength() {\n        assert_eq!(RelationshipStrength::Weak.weight(), 0.25);\n        assert_eq!(RelationshipStrength::Medium.weight(), 0.5);\n        assert_eq!(RelationshipStrength::Strong.weight(), 0.75);\n        assert_eq!(RelationshipStrength::Critical.weight(), 1.0);\n        assert_eq!(RelationshipStrength::Custom(0.3).weight(), 0.3);\n        assert_eq!(RelationshipStrength::Custom(-0.5).weight(), 0.0);\n        assert_eq!(RelationshipStrength::Custom(1.5).weight(), 1.0);\n    }\n}\n","traces":[{"line":47,"address":[15359552],"length":1,"stats":{"Line":0}},{"line":48,"address":[15359585],"length":1,"stats":{"Line":0}},{"line":49,"address":[22787084],"length":1,"stats":{"Line":0}},{"line":50,"address":[22326456],"length":1,"stats":{"Line":0}},{"line":51,"address":[15690212],"length":1,"stats":{"Line":0}},{"line":52,"address":[22787222],"length":1,"stats":{"Line":0}},{"line":53,"address":[22787272],"length":1,"stats":{"Line":0}},{"line":54,"address":[15440570],"length":1,"stats":{"Line":0}},{"line":55,"address":[15662636],"length":1,"stats":{"Line":0}},{"line":56,"address":[22787422],"length":1,"stats":{"Line":0}},{"line":57,"address":[22326805],"length":1,"stats":{"Line":0}},{"line":74,"address":[22324368],"length":1,"stats":{"Line":1}},{"line":75,"address":[22785053],"length":1,"stats":{"Line":1}},{"line":76,"address":[15660348],"length":1,"stats":{"Line":1}},{"line":77,"address":[15589596],"length":1,"stats":{"Line":1}},{"line":78,"address":[22785116],"length":1,"stats":{"Line":1}},{"line":79,"address":[22324460],"length":1,"stats":{"Line":1}},{"line":80,"address":[15660416],"length":1,"stats":{"Line":1}},{"line":101,"address":[16602560],"length":1,"stats":{"Line":7}},{"line":147,"address":[22321104,22322116,22322339],"length":1,"stats":{"Line":4}},{"line":159,"address":[16895964],"length":1,"stats":{"Line":4}},{"line":167,"address":[15435436],"length":1,"stats":{"Line":10}},{"line":168,"address":[22782251],"length":1,"stats":{"Line":7}},{"line":175,"address":[15584512],"length":1,"stats":{"Line":1}},{"line":176,"address":[16894050],"length":1,"stats":{"Line":1}},{"line":177,"address":[15584536],"length":1,"stats":{"Line":1}},{"line":181,"address":[22779952],"length":1,"stats":{"Line":1}},{"line":182,"address":[22319302],"length":1,"stats":{"Line":1}},{"line":183,"address":[15584479],"length":1,"stats":{"Line":1}},{"line":187,"address":[22780320,22780496],"length":1,"stats":{"Line":0}},{"line":188,"address":[16894472,16894368],"length":1,"stats":{"Line":0}},{"line":189,"address":[15683516],"length":1,"stats":{"Line":0}},{"line":193,"address":[15352416,15352525],"length":1,"stats":{"Line":0}},{"line":194,"address":[16587240,16587186],"length":1,"stats":{"Line":0}},{"line":195,"address":[16587265],"length":1,"stats":{"Line":0}},{"line":199,"address":[22780512,22780696],"length":1,"stats":{"Line":1}},{"line":200,"address":[15353131,15353228],"length":1,"stats":{"Line":2}},{"line":201,"address":[15353264],"length":1,"stats":{"Line":1}},{"line":205,"address":[15655328],"length":1,"stats":{"Line":1}},{"line":206,"address":[15433335],"length":1,"stats":{"Line":1}},{"line":210,"address":[22319488],"length":1,"stats":{"Line":1}},{"line":211,"address":[22319588,22319512],"length":1,"stats":{"Line":2}},{"line":212,"address":[15655502],"length":1,"stats":{"Line":1}},{"line":213,"address":[15655535,15655474],"length":1,"stats":{"Line":0}},{"line":214,"address":[22319606],"length":1,"stats":{"Line":0}},{"line":216,"address":[16587622],"length":1,"stats":{"Line":0}},{"line":221,"address":[15433968],"length":1,"stats":{"Line":2}},{"line":222,"address":[22320082],"length":1,"stats":{"Line":2}},{"line":223,"address":[15656027],"length":1,"stats":{"Line":0}},{"line":226,"address":[16894791,16894836],"length":1,"stats":{"Line":2}},{"line":228,"address":[15656091,15656217],"length":1,"stats":{"Line":2}},{"line":229,"address":[15353517,15353578],"length":1,"stats":{"Line":1}},{"line":232,"address":[15656293,15656119],"length":1,"stats":{"Line":4}},{"line":234,"address":[16588250,16588432],"length":1,"stats":{"Line":2}},{"line":239,"address":[15353712],"length":1,"stats":{"Line":1}},{"line":241,"address":[16588510],"length":1,"stats":{"Line":1}},{"line":242,"address":[22781200],"length":1,"stats":{"Line":0}},{"line":243,"address":[16588648],"length":1,"stats":{"Line":0}},{"line":250,"address":[15585737,15585979],"length":1,"stats":{"Line":1}},{"line":251,"address":[15434743],"length":1,"stats":{"Line":0}},{"line":252,"address":[16588910],"length":1,"stats":{"Line":0}},{"line":259,"address":[15354126],"length":1,"stats":{"Line":1}},{"line":268,"address":[16909136],"length":1,"stats":{"Line":0}},{"line":269,"address":[22334453],"length":1,"stats":{"Line":0}},{"line":272,"address":[15698176],"length":1,"stats":{"Line":0}},{"line":273,"address":[16909157],"length":1,"stats":{"Line":0}},{"line":276,"address":[15367648],"length":1,"stats":{"Line":0}},{"line":277,"address":[15670440],"length":1,"stats":{"Line":0}},{"line":280,"address":[22333184],"length":1,"stats":{"Line":1}},{"line":281,"address":[22333222],"length":1,"stats":{"Line":1}},{"line":282,"address":[15669270],"length":1,"stats":{"Line":0}},{"line":283,"address":[22793978],"length":1,"stats":{"Line":0}},{"line":287,"address":[15696974],"length":1,"stats":{"Line":1}},{"line":288,"address":[22794145],"length":1,"stats":{"Line":0}},{"line":289,"address":[22794114],"length":1,"stats":{"Line":0}},{"line":293,"address":[16601430],"length":1,"stats":{"Line":1}},{"line":294,"address":[22794281],"length":1,"stats":{"Line":0}},{"line":295,"address":[15366730],"length":1,"stats":{"Line":0}},{"line":299,"address":[16601578],"length":1,"stats":{"Line":1}},{"line":300,"address":[15447692],"length":1,"stats":{"Line":1}},{"line":301,"address":[22333741],"length":1,"stats":{"Line":1}},{"line":305,"address":[16601729],"length":1,"stats":{"Line":1}},{"line":306,"address":[15669871],"length":1,"stats":{"Line":0}},{"line":307,"address":[22333904],"length":1,"stats":{"Line":0}},{"line":311,"address":[16601892],"length":1,"stats":{"Line":1}},{"line":312,"address":[15448018],"length":1,"stats":{"Line":0}},{"line":313,"address":[16602099],"length":1,"stats":{"Line":0}},{"line":317,"address":[15367175],"length":1,"stats":{"Line":1}},{"line":318,"address":[15367436],"length":1,"stats":{"Line":0}},{"line":319,"address":[15670191],"length":1,"stats":{"Line":0}},{"line":323,"address":[15448106,15448286],"length":1,"stats":{"Line":1}},{"line":325,"address":[16602457],"length":1,"stats":{"Line":1}},{"line":328,"address":[16600334,16599840,16600328],"length":1,"stats":{"Line":6}},{"line":330,"address":[16906525],"length":1,"stats":{"Line":3}},{"line":331,"address":[22792599,22792527],"length":1,"stats":{"Line":9}},{"line":332,"address":[16906635],"length":1,"stats":{"Line":6}},{"line":333,"address":[16906697],"length":1,"stats":{"Line":3}},{"line":334,"address":[15365219,15365264],"length":1,"stats":{"Line":9}},{"line":338,"address":[15597504,15597924],"length":1,"stats":{"Line":1}},{"line":339,"address":[15365624,15365526],"length":1,"stats":{"Line":2}},{"line":340,"address":[15668742],"length":1,"stats":{"Line":0}},{"line":342,"address":[22793462,22793232],"length":1,"stats":{"Line":0}},{"line":347,"address":[15365753,15365665],"length":1,"stats":{"Line":2}},{"line":348,"address":[16707167,16707099],"length":1,"stats":{"Line":0}},{"line":355,"address":[15698192],"length":1,"stats":{"Line":0}},{"line":387,"address":[15658608],"length":1,"stats":{"Line":1}},{"line":388,"address":[15587848],"length":1,"stats":{"Line":1}},{"line":392,"address":[22323062,22322896],"length":1,"stats":{"Line":1}},{"line":393,"address":[15356155,15356243],"length":1,"stats":{"Line":2}},{"line":394,"address":[16591074],"length":1,"stats":{"Line":1}},{"line":398,"address":[15659024,15659190],"length":1,"stats":{"Line":0}},{"line":399,"address":[15356435,15356347],"length":1,"stats":{"Line":0}},{"line":400,"address":[15356462],"length":1,"stats":{"Line":0}},{"line":404,"address":[22783376,22783542],"length":1,"stats":{"Line":0}},{"line":405,"address":[15436743,15436651],"length":1,"stats":{"Line":0}},{"line":406,"address":[15436770],"length":1,"stats":{"Line":0}},{"line":410,"address":[15355712,15355888],"length":1,"stats":{"Line":1}},{"line":411,"address":[15658427,15658528],"length":1,"stats":{"Line":2}},{"line":412,"address":[22322628],"length":1,"stats":{"Line":1}},{"line":416,"address":[16898992],"length":1,"stats":{"Line":0}},{"line":417,"address":[16592354],"length":1,"stats":{"Line":0}},{"line":418,"address":[15589496],"length":1,"stats":{"Line":0}},{"line":422,"address":[15436320],"length":1,"stats":{"Line":0}},{"line":423,"address":[15658354],"length":1,"stats":{"Line":0}},{"line":424,"address":[15658366],"length":1,"stats":{"Line":0}},{"line":428,"address":[22783040],"length":1,"stats":{"Line":1}},{"line":429,"address":[15686088],"length":1,"stats":{"Line":1}},{"line":430,"address":[15436303],"length":1,"stats":{"Line":1}},{"line":434,"address":[16591312],"length":1,"stats":{"Line":1}},{"line":435,"address":[16591345],"length":1,"stats":{"Line":1}},{"line":436,"address":[22784037],"length":1,"stats":{"Line":1}},{"line":437,"address":[15437356],"length":1,"stats":{"Line":1}},{"line":441,"address":[15588569,15588633],"length":1,"stats":{"Line":1}},{"line":442,"address":[22323474],"length":1,"stats":{"Line":0}},{"line":443,"address":[15687257],"length":1,"stats":{"Line":0}},{"line":447,"address":[15588678,15588725],"length":1,"stats":{"Line":1}},{"line":448,"address":[15437489],"length":1,"stats":{"Line":0}},{"line":449,"address":[16898325],"length":1,"stats":{"Line":0}},{"line":453,"address":[16591689,16591631],"length":1,"stats":{"Line":2}},{"line":454,"address":[15687381],"length":1,"stats":{"Line":1}},{"line":455,"address":[22323733],"length":1,"stats":{"Line":0}},{"line":459,"address":[15437625,15437673],"length":1,"stats":{"Line":1}},{"line":460,"address":[15588933],"length":1,"stats":{"Line":0}},{"line":461,"address":[15437732],"length":1,"stats":{"Line":0}},{"line":465,"address":[15659768,15659737],"length":1,"stats":{"Line":1}},{"line":466,"address":[15437771],"length":1,"stats":{"Line":0}},{"line":467,"address":[15659844],"length":1,"stats":{"Line":0}},{"line":471,"address":[22323880,22323923],"length":1,"stats":{"Line":2}},{"line":472,"address":[22323990,22323941],"length":1,"stats":{"Line":2}},{"line":473,"address":[15589167],"length":1,"stats":{"Line":0}},{"line":477,"address":[15437939,15437870],"length":1,"stats":{"Line":1}},{"line":478,"address":[15357256],"length":1,"stats":{"Line":0}},{"line":479,"address":[16898787],"length":1,"stats":{"Line":0}},{"line":483,"address":[15357347,15357292],"length":1,"stats":{"Line":1}},{"line":484,"address":[15438048],"length":1,"stats":{"Line":0}},{"line":485,"address":[16592234],"length":1,"stats":{"Line":0}},{"line":489,"address":[22784894,22784836],"length":1,"stats":{"Line":1}},{"line":490,"address":[15357465],"length":1,"stats":{"Line":0}},{"line":495,"address":[15438207],"length":1,"stats":{"Line":1}}],"covered":85,"coverable":159},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","rule.rs"],"content":"//! Rule entity implementation\n//!\n//! Rules define automated policies and validations that the system enforces.\n//! Rules are evaluated against entities to ensure compliance with team policies.\n//!\n//! ## Rule Types\n//!\n//! - **Validation**: Check entities meet criteria before creation/update\n//! - **Transformation**: Modify entity data during processing\n//! - **Enforcement**: Block operations that violate policies\n//! - **Notification**: Trigger alerts when conditions are met\n//!\n//! ## Execution Flow\n//!\n//! Rules are evaluated by the [`RuleEngine`](crate::engines::rule_engine) when\n//! entities are created or modified. The engine checks the `condition` expression\n//! and executes the `action` if the condition evaluates to true.\n//!\n//! ## Relationship to Standards and Compliance\n//!\n//! Rules are the **implementation mechanism** for Standards. A Standard defines\n//! \"what\" should be done, while Rules define \"how\" it's enforced automatically.\n//! Compliance items track adherence to Standards, using Rules as the validation layer.\n//!\n//! Example: Standard \"All code must have tests\" ‚Üí Rule \"Reject commits without test files\"\n//!\n//! ## Example\n//!\n//! ```json\n//! {\n//!   \"title\": \"Require task reasoning\",\n//!   \"rule_type\": \"validation\",\n//!   \"condition\": {\"equals\": [{\"entity_type\": \"task\"}, \"reasoning_count\", 0]},\n//!   \"action\": {\"error\": \"Task requires at least one reasoning entity\"},\n//!   \"entity_types\": [\"task\"]\n//! }\n//! ```\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Rule status variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum RuleStatus {\n    Active,\n    Inactive,\n    Deprecated,\n}\n\n/// Rule priority levels\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum RulePriority {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\n/// Rule type variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum RuleType {\n    Validation,\n    Transformation,\n    Enforcement,\n    Notification,\n}\n\n/// Rule entity for system rules and policies\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct Rule {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Rule title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Rule description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Rule type\n    #[serde(rename = \"rule_type\")]\n    pub rule_type: RuleType,\n\n    /// Current status\n    #[serde(rename = \"status\")]\n    pub status: RuleStatus,\n\n    /// Priority level\n    #[serde(rename = \"priority\")]\n    pub priority: RulePriority,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Rule condition (JSON logic)\n    #[serde(rename = \"condition\")]\n    pub condition: serde_json::Value,\n\n    /// Rule action to execute\n    #[serde(rename = \"action\")]\n    pub action: serde_json::Value,\n\n    /// Creation timestamp\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// Last updated timestamp\n    #[serde(rename = \"updated_at\")]\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    /// Entity types this rule applies to\n    #[serde(rename = \"entity_types\")]\n    pub entity_types: Vec\u003cString\u003e,\n\n    /// Execution history\n    #[serde(\n        rename = \"execution_history\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub execution_history: Vec\u003cRuleExecution\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Related rules\n    #[serde(\n        rename = \"related_rules\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub related_rules: Vec\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\n/// Rule execution record\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct RuleExecution {\n    /// Execution identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// When rule was executed\n    #[serde(rename = \"executed_at\")]\n    pub executed_at: DateTime\u003cUtc\u003e,\n\n    /// Entity that triggered the rule\n    #[serde(rename = \"trigger_entity\")]\n    pub trigger_entity: String,\n\n    /// Execution result\n    #[serde(rename = \"result\")]\n    pub result: RuleExecutionResult,\n\n    /// Execution duration in milliseconds\n    #[serde(rename = \"duration_ms\")]\n    pub duration_ms: u64,\n\n    /// Any error message\n    #[serde(rename = \"error_message\", skip_serializing_if = \"Option::is_none\")]\n    pub error_message: Option\u003cString\u003e,\n}\n\n/// Rule execution result\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum RuleExecutionResult {\n    Success,\n    Failed,\n    Skipped,\n}\n\nimpl Rule {\n    /// Create a new rule\n    pub fn new(\n        title: String,\n        description: String,\n        rule_type: RuleType,\n        priority: RulePriority,\n        agent: String,\n        condition: serde_json::Value,\n        action: serde_json::Value,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            description,\n            rule_type,\n            status: RuleStatus::Active,\n            priority,\n            agent,\n            condition,\n            action,\n            created_at: now,\n            updated_at: now,\n            entity_types: Vec::new(),\n            execution_history: Vec::new(),\n            tags: Vec::new(),\n            related_rules: Vec::new(),\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Execute rule against an entity\n    pub fn execute(\u0026mut self, entity: \u0026super::GenericEntity) -\u003e RuleExecutionResult {\n        let start_time = Utc::now();\n\n        let result = self.evaluate_condition(entity);\n\n        let execution = RuleExecution {\n            id: Uuid::new_v4().to_string(),\n            executed_at: start_time,\n            trigger_entity: entity.id.clone(),\n            result: result.clone(),\n            duration_ms: (Utc::now()\n                .signed_duration_since(start_time)\n                .num_milliseconds()\n                .max(0)) as u64,\n            error_message: if matches!(result, RuleExecutionResult::Failed) {\n                Some(\"Condition evaluation failed\".to_string())\n            } else {\n                None\n            },\n        };\n\n        self.execution_history.push(execution);\n        self.updated_at = Utc::now();\n\n        result\n    }\n\n    fn evaluate_condition(\u0026self, entity: \u0026super::GenericEntity) -\u003e RuleExecutionResult {\n        if !self.entity_types.is_empty() \u0026\u0026 !self.entity_types.contains(\u0026entity.entity_type) {\n            return RuleExecutionResult::Skipped;\n        }\n\n        // For now, assume success if rule is active\n        if self.status == RuleStatus::Active {\n            RuleExecutionResult::Success\n        } else {\n            RuleExecutionResult::Skipped\n        }\n    }\n\n    /// Deactivate rule\n    pub fn deactivate(\u0026mut self) {\n        self.status = RuleStatus::Inactive;\n        self.updated_at = Utc::now();\n    }\n\n    /// Activate rule\n    pub fn activate(\u0026mut self) {\n        self.status = RuleStatus::Active;\n        self.updated_at = Utc::now();\n    }\n\n    /// Deprecate rule\n    pub fn deprecate(\u0026mut self) {\n        self.status = RuleStatus::Deprecated;\n        self.updated_at = Utc::now();\n    }\n\n    /// Add entity type this rule applies to\n    pub fn add_entity_type(\u0026mut self, entity_type: String) {\n        if !self.entity_types.contains(\u0026entity_type) {\n            self.entity_types.push(entity_type);\n        }\n    }\n\n    /// Add a related rule\n    pub fn add_related_rule(\u0026mut self, rule_id: String) {\n        if !self.related_rules.contains(\u0026rule_id) {\n            self.related_rules.push(rule_id);\n        }\n    }\n}\n\nimpl Entity for Rule {\n    fn entity_type() -\u003e \u0026'static str {\n        \"rule\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cRule as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Rule title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.description.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Rule description cannot be empty\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize Rule: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":194,"address":[19230688,19231964,19232177],"length":1,"stats":{"Line":0}},{"line":203,"address":[24583651],"length":1,"stats":{"Line":0}},{"line":205,"address":[19343692],"length":1,"stats":{"Line":0}},{"line":216,"address":[17703413],"length":1,"stats":{"Line":0}},{"line":217,"address":[17925492],"length":1,"stats":{"Line":0}},{"line":218,"address":[17925552],"length":1,"stats":{"Line":0}},{"line":219,"address":[16602100],"length":1,"stats":{"Line":0}},{"line":220,"address":[19344152],"length":1,"stats":{"Line":0}},{"line":225,"address":[24585841,24585847,24585088],"length":1,"stats":{"Line":0}},{"line":226,"address":[24585121],"length":1,"stats":{"Line":0}},{"line":228,"address":[19232265],"length":1,"stats":{"Line":0}},{"line":231,"address":[17855810],"length":1,"stats":{"Line":0}},{"line":233,"address":[24585203],"length":1,"stats":{"Line":0}},{"line":234,"address":[17915175],"length":1,"stats":{"Line":0}},{"line":235,"address":[17926747,17926835],"length":1,"stats":{"Line":0}},{"line":239,"address":[19345379,19345439],"length":1,"stats":{"Line":0}},{"line":246,"address":[19232887],"length":1,"stats":{"Line":0}},{"line":247,"address":[17927206],"length":1,"stats":{"Line":0}},{"line":252,"address":[24583424],"length":1,"stats":{"Line":0}},{"line":253,"address":[25044119],"length":1,"stats":{"Line":0}},{"line":254,"address":[17913435],"length":1,"stats":{"Line":0}},{"line":258,"address":[17854213,17854162,17854206],"length":1,"stats":{"Line":0}},{"line":259,"address":[17913456],"length":1,"stats":{"Line":0}},{"line":261,"address":[16601464],"length":1,"stats":{"Line":0}},{"line":266,"address":[24582864],"length":1,"stats":{"Line":0}},{"line":267,"address":[17853534],"length":1,"stats":{"Line":0}},{"line":268,"address":[17853541],"length":1,"stats":{"Line":0}},{"line":272,"address":[19232992],"length":1,"stats":{"Line":0}},{"line":273,"address":[17927310],"length":1,"stats":{"Line":0}},{"line":274,"address":[16603797],"length":1,"stats":{"Line":0}},{"line":278,"address":[17927360],"length":1,"stats":{"Line":0}},{"line":279,"address":[16603854],"length":1,"stats":{"Line":0}},{"line":280,"address":[17705365],"length":1,"stats":{"Line":0}},{"line":284,"address":[17924559,17924585,17924352],"length":1,"stats":{"Line":0}},{"line":285,"address":[25043701,25043619],"length":1,"stats":{"Line":0}},{"line":286,"address":[17912968,17913019],"length":1,"stats":{"Line":0}},{"line":291,"address":[25043840,25044079,25044053],"length":1,"stats":{"Line":0}},{"line":292,"address":[17913176,17913091],"length":1,"stats":{"Line":0}},{"line":293,"address":[17853963,17854017],"length":1,"stats":{"Line":0}},{"line":303,"address":[17917904],"length":1,"stats":{"Line":0}},{"line":304,"address":[17858661],"length":1,"stats":{"Line":0}},{"line":307,"address":[25048688],"length":1,"stats":{"Line":0}},{"line":308,"address":[19347925],"length":1,"stats":{"Line":0}},{"line":311,"address":[16605904],"length":1,"stats":{"Line":0}},{"line":312,"address":[17858712],"length":1,"stats":{"Line":0}},{"line":315,"address":[24587708,24587104,24587714],"length":1,"stats":{"Line":0}},{"line":316,"address":[17857790],"length":1,"stats":{"Line":0}},{"line":320,"address":[19234486],"length":1,"stats":{"Line":0}},{"line":321,"address":[16626736],"length":1,"stats":{"Line":0}},{"line":322,"address":[15983971],"length":1,"stats":{"Line":0}},{"line":324,"address":[15983975],"length":1,"stats":{"Line":0}},{"line":325,"address":[15008992,15008930,15008976],"length":1,"stats":{"Line":0}},{"line":326,"address":[16626807],"length":1,"stats":{"Line":0}},{"line":329,"address":[17858166],"length":1,"stats":{"Line":0}},{"line":332,"address":[19234355],"length":1,"stats":{"Line":0}},{"line":333,"address":[16605637],"length":1,"stats":{"Line":0}},{"line":334,"address":[17929175],"length":1,"stats":{"Line":0}},{"line":338,"address":[17929156],"length":1,"stats":{"Line":0}},{"line":339,"address":[16605768],"length":1,"stats":{"Line":0}},{"line":340,"address":[17929306],"length":1,"stats":{"Line":0}},{"line":344,"address":[16605725],"length":1,"stats":{"Line":0}},{"line":347,"address":[24586705,24586711,24586240],"length":1,"stats":{"Line":0}},{"line":349,"address":[17856925],"length":1,"stats":{"Line":0}},{"line":350,"address":[16604187,16604255],"length":1,"stats":{"Line":0}},{"line":351,"address":[17916279],"length":1,"stats":{"Line":0}},{"line":352,"address":[17705845],"length":1,"stats":{"Line":0}},{"line":353,"address":[17927883,17927940],"length":1,"stats":{"Line":0}},{"line":357,"address":[24586752,24587032],"length":1,"stats":{"Line":0}},{"line":358,"address":[17706276,17706182],"length":1,"stats":{"Line":0}},{"line":359,"address":[15387691,15387759],"length":1,"stats":{"Line":0}},{"line":363,"address":[19235152],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":71},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","session.rs"],"content":"//! Session entity implementation\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Session status variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum SessionStatus {\n    Active,\n    Paused,\n    Completed,\n    Cancelled,\n}\n\n/// Session entity for tracking agent sessions\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct Session {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Session title/name\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Current status\n    #[serde(rename = \"status\")]\n    pub status: SessionStatus,\n\n    /// Start timestamp\n    #[serde(rename = \"start_time\")]\n    pub start_time: DateTime\u003cUtc\u003e,\n\n    /// End timestamp\n    #[serde(rename = \"end_time\")]\n    pub end_time: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    /// Duration in seconds (calculated)\n    #[serde(rename = \"duration_seconds\")]\n    pub duration_seconds: Option\u003cu64\u003e,\n\n    /// Tasks worked on during session\n    #[serde(rename = \"task_ids\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub task_ids: Vec\u003cString\u003e,\n\n    /// Context items used\n    #[serde(rename = \"context_ids\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub context_ids: Vec\u003cString\u003e,\n\n    /// Knowledge items referenced\n    #[serde(\n        rename = \"knowledge_ids\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub knowledge_ids: Vec\u003cString\u003e,\n\n    /// Session goals\n    #[serde(rename = \"goals\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub goals: Vec\u003cString\u003e,\n\n    /// Session outcomes\n    #[serde(rename = \"outcomes\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub outcomes: Vec\u003cString\u003e,\n\n    /// SPACE framework metrics\n    #[serde(rename = \"space_metrics\")]\n    pub space_metrics: Option\u003cSpaceMetrics\u003e,\n\n    /// DORA metrics\n    #[serde(rename = \"dora_metrics\")]\n    pub dora_metrics: Option\u003cDoraMetrics\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\n/// SPACE framework metrics\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct SpaceMetrics {\n    /// Satisfaction score (0-100)\n    #[serde(rename = \"satisfaction_score\")]\n    pub satisfaction_score: f64,\n\n    /// Performance score (0-100)\n    #[serde(rename = \"performance_score\")]\n    pub performance_score: f64,\n\n    /// Activity score (0-100)\n    #[serde(rename = \"activity_score\")]\n    pub activity_score: f64,\n\n    /// Communication score (0-100)\n    #[serde(rename = \"communication_score\")]\n    pub communication_score: f64,\n\n    /// Efficiency score (0-100)\n    #[serde(rename = \"efficiency_score\")]\n    pub efficiency_score: f64,\n\n    /// Overall score (0-100)\n    #[serde(rename = \"overall_score\")]\n    pub overall_score: f64,\n}\n\n/// DORA metrics\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct DoraMetrics {\n    /// Deployment frequency (per week)\n    #[serde(rename = \"deployment_frequency\")]\n    pub deployment_frequency: f64,\n\n    /// Lead time for changes (in days)\n    #[serde(rename = \"lead_time\")]\n    pub lead_time: f64,\n\n    /// Change failure rate (percentage)\n    #[serde(rename = \"change_failure_rate\")]\n    pub change_failure_rate: f64,\n\n    /// Mean time to recovery (in hours)\n    #[serde(rename = \"mean_time_to_recover\")]\n    pub mean_time_to_recover: f64,\n}\n\nimpl Session {\n    /// Create a new session\n    pub fn new(title: String, agent: String, goals: Vec\u003cString\u003e) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            agent,\n            status: SessionStatus::Active,\n            start_time: now,\n            end_time: None,\n            duration_seconds: None,\n            task_ids: Vec::new(),\n            context_ids: Vec::new(),\n            knowledge_ids: Vec::new(),\n            goals,\n            outcomes: Vec::new(),\n            space_metrics: None,\n            dora_metrics: None,\n            tags: Vec::new(),\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Complete the session\n    pub fn complete(\u0026mut self, outcomes: Vec\u003cString\u003e) {\n        self.status = SessionStatus::Completed;\n        self.end_time = Some(Utc::now());\n        self.outcomes = outcomes;\n        self.calculate_duration();\n    }\n\n    /// Pause the session\n    pub fn pause(\u0026mut self) {\n        self.status = SessionStatus::Paused;\n    }\n\n    /// Resume the session\n    pub fn resume(\u0026mut self) {\n        self.status = SessionStatus::Active;\n    }\n\n    /// Cancel the session\n    pub fn cancel(\u0026mut self) {\n        self.status = SessionStatus::Cancelled;\n        self.end_time = Some(Utc::now());\n        self.calculate_duration();\n    }\n\n    /// Calculate duration in seconds\n    fn calculate_duration(\u0026mut self) {\n        if let Some(end_time) = self.end_time {\n            let duration = end_time.signed_duration_since(self.start_time);\n            self.duration_seconds = Some(duration.num_seconds().max(0) as u64);\n        }\n    }\n\n    /// Add a task to the session\n    pub fn add_task(\u0026mut self, task_id: String) {\n        if !self.task_ids.contains(\u0026task_id) {\n            self.task_ids.push(task_id);\n        }\n    }\n\n    /// Add a context to the session\n    pub fn add_context(\u0026mut self, context_id: String) {\n        if !self.context_ids.contains(\u0026context_id) {\n            self.context_ids.push(context_id);\n        }\n    }\n\n    /// Add knowledge to the session\n    pub fn add_knowledge(\u0026mut self, knowledge_id: String) {\n        if !self.knowledge_ids.contains(\u0026knowledge_id) {\n            self.knowledge_ids.push(knowledge_id);\n        }\n    }\n\n    /// Set SPACE metrics\n    pub fn set_space_metrics(\u0026mut self, metrics: SpaceMetrics) {\n        self.space_metrics = Some(metrics);\n    }\n\n    /// Set DORA metrics\n    pub fn set_dora_metrics(\u0026mut self, metrics: DoraMetrics) {\n        self.dora_metrics = Some(metrics);\n    }\n}\n\nimpl Entity for Session {\n    fn entity_type() -\u003e \u0026'static str {\n        \"session\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.start_time\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cSession as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Session title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.agent.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Session agent cannot be empty\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.start_time,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize Session: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":146,"address":[17751952,17753173,17753291],"length":1,"stats":{"Line":0}},{"line":147,"address":[23372399],"length":1,"stats":{"Line":0}},{"line":149,"address":[18010440],"length":1,"stats":{"Line":0}},{"line":156,"address":[16499162],"length":1,"stats":{"Line":0}},{"line":157,"address":[16714105],"length":1,"stats":{"Line":0}},{"line":158,"address":[16714165],"length":1,"stats":{"Line":0}},{"line":160,"address":[20366596],"length":1,"stats":{"Line":0}},{"line":163,"address":[18010859],"length":1,"stats":{"Line":0}},{"line":164,"address":[23372983],"length":1,"stats":{"Line":0}},{"line":169,"address":[23374431,23374405,23374128],"length":1,"stats":{"Line":0}},{"line":170,"address":[17753731],"length":1,"stats":{"Line":0}},{"line":171,"address":[16644820,16644878],"length":1,"stats":{"Line":0}},{"line":172,"address":[23374262],"length":1,"stats":{"Line":0}},{"line":173,"address":[16704297],"length":1,"stats":{"Line":0}},{"line":177,"address":[16715168],"length":1,"stats":{"Line":0}},{"line":178,"address":[18011685],"length":1,"stats":{"Line":0}},{"line":182,"address":[17753440],"length":1,"stats":{"Line":0}},{"line":183,"address":[16715285],"length":1,"stats":{"Line":0}},{"line":187,"address":[23373760],"length":1,"stats":{"Line":0}},{"line":188,"address":[23834445],"length":1,"stats":{"Line":0}},{"line":189,"address":[16703684],"length":1,"stats":{"Line":0}},{"line":190,"address":[16644491],"length":1,"stats":{"Line":0}},{"line":194,"address":[16702080],"length":1,"stats":{"Line":0}},{"line":195,"address":[20365950],"length":1,"stats":{"Line":0}},{"line":196,"address":[23372247],"length":1,"stats":{"Line":0}},{"line":197,"address":[16642968],"length":1,"stats":{"Line":0}},{"line":202,"address":[16644741,16644528,16644767],"length":1,"stats":{"Line":0}},{"line":203,"address":[17753475,17753560],"length":1,"stats":{"Line":0}},{"line":204,"address":[16715489,16715435],"length":1,"stats":{"Line":0}},{"line":209,"address":[20365264,20365473,20365499],"length":1,"stats":{"Line":0}},{"line":210,"address":[16712947,16713032],"length":1,"stats":{"Line":0}},{"line":211,"address":[20365399,20365453],"length":1,"stats":{"Line":0}},{"line":216,"address":[16498517,16498543,16498304],"length":1,"stats":{"Line":0}},{"line":217,"address":[16713203,16713288],"length":1,"stats":{"Line":0}},{"line":218,"address":[23832571,23832625],"length":1,"stats":{"Line":0}},{"line":223,"address":[16702000],"length":1,"stats":{"Line":0}},{"line":224,"address":[23832781],"length":1,"stats":{"Line":0}},{"line":228,"address":[16701920],"length":1,"stats":{"Line":0}},{"line":229,"address":[16642681],"length":1,"stats":{"Line":0}},{"line":238,"address":[16709072],"length":1,"stats":{"Line":0}},{"line":239,"address":[16649829],"length":1,"stats":{"Line":0}},{"line":242,"address":[23839856],"length":1,"stats":{"Line":0}},{"line":243,"address":[18017125],"length":1,"stats":{"Line":0}},{"line":246,"address":[20372944],"length":1,"stats":{"Line":0}},{"line":247,"address":[16649896],"length":1,"stats":{"Line":0}},{"line":250,"address":[23378863,23378869,23378256],"length":1,"stats":{"Line":0}},{"line":251,"address":[16648942],"length":1,"stats":{"Line":0}},{"line":255,"address":[17758105],"length":1,"stats":{"Line":0}},{"line":256,"address":[18016484],"length":1,"stats":{"Line":0}},{"line":257,"address":[21585043],"length":1,"stats":{"Line":0}},{"line":259,"address":[21585047],"length":1,"stats":{"Line":0}},{"line":260,"address":[20489650,20489744,20489760],"length":1,"stats":{"Line":0}},{"line":261,"address":[22151735],"length":1,"stats":{"Line":0}},{"line":264,"address":[16649321],"length":1,"stats":{"Line":0}},{"line":267,"address":[17757971],"length":1,"stats":{"Line":0}},{"line":268,"address":[20372651],"length":1,"stats":{"Line":0}},{"line":269,"address":[16720333],"length":1,"stats":{"Line":0}},{"line":273,"address":[16720311],"length":1,"stats":{"Line":0}},{"line":274,"address":[20372782],"length":1,"stats":{"Line":0}},{"line":275,"address":[16720464],"length":1,"stats":{"Line":0}},{"line":279,"address":[20372739],"length":1,"stats":{"Line":0}},{"line":282,"address":[23377880,23377408,23377886],"length":1,"stats":{"Line":1}},{"line":284,"address":[16648093],"length":1,"stats":{"Line":1}},{"line":285,"address":[20371199,20371267],"length":1,"stats":{"Line":2}},{"line":286,"address":[16707451],"length":1,"stats":{"Line":1}},{"line":287,"address":[16504156],"length":1,"stats":{"Line":1}},{"line":288,"address":[16719058,16719115],"length":1,"stats":{"Line":2}},{"line":292,"address":[23378193,23377920],"length":1,"stats":{"Line":0}},{"line":293,"address":[20489571,20489577,20489328],"length":1,"stats":{"Line":0}},{"line":294,"address":[20711439,20711371],"length":1,"stats":{"Line":0}},{"line":298,"address":[17758800],"length":1,"stats":{"Line":0}}],"covered":6,"coverable":71},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","standard.rs"],"content":"//! Standard entity implementation\n//!\n//! Standards define team guidelines, coding conventions, and process requirements.\n//! They represent the \"ÁêÜÊÉ≥Áä∂ÊÖã\" (ideal state) that the team strives to maintain.\n//!\n//! ## Standard Categories\n//!\n//! - **Coding**: Language-specific conventions, style guides, best practices\n//! - **Testing**: Coverage requirements, test naming, frameworks\n//! - **Documentation**: Readme requirements, code comments, API docs\n//! - **Security**: Authentication, encryption, access control patterns\n//! - **Performance**: Latency budgets, resource limits, optimization targets\n//! - **Process**: Review requirements, commit conventions, workflow steps\n//! - **Architecture**: Design patterns, module boundaries, integration patterns\n//!\n//! ## Relationship to Rules and Compliance\n//!\n//! Standards define **what** should be done (the requirements).\n//! Rules define **how** to enforce it automatically.\n//! Compliance tracks **whether** the team is meeting the standards.\n//!\n//! ```text\n//! Standard (What) ‚Üí Rule (How to enforce) ‚Üí Compliance (Are we meeting it?)\n//! ```\n//!\n//! ## Versioning\n//!\n//! Standards are versioned using semantic versioning. When a Standard is updated,\n//! the `version` field should be incremented. Use `superseded_by` to link to newer\n//! versions and `supersedes` to link to older versions that this one replaces.\n//!\n//! ## Example\n//!\n//! ```json\n//! {\n//!   \"title\": \"Rust Coding Standards\",\n//!   \"category\": \"coding\",\n//!   \"version\": \"1.2.0\",\n//!   \"requirements\": [\n//!     \"Use Result type for fallible operations\",\n//!     \"Follow clippy suggestions\",\n//!     \"Document public APIs\"\n//!   ]\n//! }\n//! ```\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Standard status variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum StandardStatus {\n    Draft,\n    Active,\n    Deprecated,\n    Superseded,\n}\n\n/// Standard category\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum StandardCategory {\n    Coding,\n    Testing,\n    Documentation,\n    Security,\n    Performance,\n    Process,\n    Architecture,\n}\n\n/// Standard entity for team standards and guidelines\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct Standard {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Standard title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Standard description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Standard category\n    #[serde(rename = \"category\")]\n    pub category: StandardCategory,\n\n    /// Current status\n    #[serde(rename = \"status\")]\n    pub status: StandardStatus,\n\n    /// Standard version\n    #[serde(rename = \"version\")]\n    pub version: String,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Creation timestamp\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// Last updated timestamp\n    #[serde(rename = \"updated_at\")]\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    /// Effective date\n    #[serde(rename = \"effective_date\")]\n    pub effective_date: DateTime\u003cUtc\u003e,\n\n    /// Superseded by (if applicable)\n    #[serde(rename = \"superseded_by\", skip_serializing_if = \"Option::is_none\")]\n    pub superseded_by: Option\u003cString\u003e,\n\n    /// Supersedes (if applicable)\n    #[serde(rename = \"supersedes\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub supersedes: Vec\u003cString\u003e,\n\n    /// Related standards\n    #[serde(\n        rename = \"related_standards\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub related_standards: Vec\u003cString\u003e,\n\n    /// Standard requirements/guidelines\n    #[serde(rename = \"requirements\")]\n    pub requirements: Vec\u003cStandardRequirement\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\n/// Standard requirement or guideline\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct StandardRequirement {\n    /// Requirement identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Requirement title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Requirement description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Whether requirement is mandatory\n    #[serde(rename = \"mandatory\")]\n    pub mandatory: bool,\n\n    /// Priority level\n    #[serde(rename = \"priority\")]\n    pub priority: super::rule::RulePriority,\n\n    /// Validation criteria\n    #[serde(rename = \"validation_criteria\")]\n    pub validation_criteria: Vec\u003cString\u003e,\n\n    /// Evidence required\n    #[serde(rename = \"evidence_required\")]\n    pub evidence_required: bool,\n}\n\nimpl Standard {\n    /// Create a new standard\n    pub fn new(\n        title: String,\n        description: String,\n        category: StandardCategory,\n        version: String,\n        agent: String,\n        effective_date: DateTime\u003cUtc\u003e,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            description,\n            category,\n            status: StandardStatus::Draft,\n            version,\n            agent,\n            created_at: now,\n            updated_at: now,\n            effective_date,\n            superseded_by: None,\n            supersedes: Vec::new(),\n            related_standards: Vec::new(),\n            requirements: Vec::new(),\n            tags: Vec::new(),\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Activate standard\n    pub fn activate(\u0026mut self) {\n        self.status = StandardStatus::Active;\n        self.updated_at = Utc::now();\n    }\n\n    /// Deprecate standard\n    pub fn deprecate(\u0026mut self, superseded_by: Option\u003cString\u003e) {\n        self.status = StandardStatus::Deprecated;\n        self.superseded_by = superseded_by;\n        self.updated_at = Utc::now();\n    }\n\n    /// Add a requirement\n    pub fn add_requirement(\u0026mut self, requirement: StandardRequirement) {\n        self.requirements.push(requirement);\n        self.updated_at = Utc::now();\n    }\n\n    /// Add a related standard\n    pub fn add_related_standard(\u0026mut self, standard_id: String) {\n        if !self.related_standards.contains(\u0026standard_id) {\n            self.related_standards.push(standard_id);\n        }\n    }\n\n    /// Add superseded standard\n    pub fn add_superseded(\u0026mut self, standard_id: String) {\n        if !self.supersedes.contains(\u0026standard_id) {\n            self.supersedes.push(standard_id);\n        }\n    }\n\n    /// Check if standard is currently effective\n    pub fn is_effective(\u0026self) -\u003e bool {\n        self.status == StandardStatus::Active\n            \u0026\u0026 self.effective_date \u003c= Utc::now()\n            \u0026\u0026 self.superseded_by.is_none()\n    }\n}\n\nimpl Entity for Standard {\n    fn entity_type() -\u003e \u0026'static str {\n        \"standard\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cStandard as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Standard title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.description.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Standard description cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.version.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Standard version cannot be empty\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize Standard: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":187,"address":[17691078,17689872,17691263],"length":1,"stats":{"Line":0}},{"line":195,"address":[24360031],"length":1,"stats":{"Line":0}},{"line":197,"address":[17630808],"length":1,"stats":{"Line":0}},{"line":208,"address":[17701775],"length":1,"stats":{"Line":0}},{"line":209,"address":[17631070],"length":1,"stats":{"Line":0}},{"line":210,"address":[15295202],"length":1,"stats":{"Line":0}},{"line":211,"address":[17690438],"length":1,"stats":{"Line":0}},{"line":212,"address":[19000370],"length":1,"stats":{"Line":0}},{"line":217,"address":[19121296],"length":1,"stats":{"Line":0}},{"line":218,"address":[19001182],"length":1,"stats":{"Line":0}},{"line":219,"address":[15296117],"length":1,"stats":{"Line":0}},{"line":223,"address":[17632112,17632196],"length":1,"stats":{"Line":0}},{"line":224,"address":[15296178],"length":1,"stats":{"Line":0}},{"line":225,"address":[15296279,15296185],"length":1,"stats":{"Line":0}},{"line":226,"address":[17488151],"length":1,"stats":{"Line":0}},{"line":230,"address":[17486176],"length":1,"stats":{"Line":0}},{"line":231,"address":[24359646],"length":1,"stats":{"Line":0}},{"line":232,"address":[18999435],"length":1,"stats":{"Line":0}},{"line":236,"address":[17630581,17630607,17630368],"length":1,"stats":{"Line":0}},{"line":237,"address":[17701155,17701240],"length":1,"stats":{"Line":0}},{"line":238,"address":[19119755,19119809],"length":1,"stats":{"Line":0}},{"line":243,"address":[17701049,17700816,17701023],"length":1,"stats":{"Line":0}},{"line":244,"address":[17486037,17485955],"length":1,"stats":{"Line":0}},{"line":245,"address":[17701003,17700952],"length":1,"stats":{"Line":0}},{"line":250,"address":[19119168],"length":1,"stats":{"Line":0}},{"line":251,"address":[15294021,15293998],"length":1,"stats":{"Line":0}},{"line":252,"address":[17629969],"length":1,"stats":{"Line":0}},{"line":253,"address":[24820032],"length":1,"stats":{"Line":0}},{"line":262,"address":[24365792],"length":1,"stats":{"Line":0}},{"line":263,"address":[17636453],"length":1,"stats":{"Line":0}},{"line":266,"address":[15300448],"length":1,"stats":{"Line":0}},{"line":267,"address":[19125717],"length":1,"stats":{"Line":0}},{"line":270,"address":[17636496],"length":1,"stats":{"Line":0}},{"line":271,"address":[17707272],"length":1,"stats":{"Line":0}},{"line":274,"address":[19125266,19124656,19125260],"length":1,"stats":{"Line":0}},{"line":275,"address":[15299438],"length":1,"stats":{"Line":0}},{"line":279,"address":[24825686],"length":1,"stats":{"Line":0}},{"line":280,"address":[27172608],"length":1,"stats":{"Line":0}},{"line":281,"address":[21493443],"length":1,"stats":{"Line":0}},{"line":283,"address":[19831383],"length":1,"stats":{"Line":0}},{"line":284,"address":[19982642,19982688,19982704],"length":1,"stats":{"Line":0}},{"line":285,"address":[21493479],"length":1,"stats":{"Line":0}},{"line":288,"address":[17491702],"length":1,"stats":{"Line":0}},{"line":291,"address":[17694787],"length":1,"stats":{"Line":0}},{"line":292,"address":[15300069],"length":1,"stats":{"Line":0}},{"line":293,"address":[24826071],"length":1,"stats":{"Line":0}},{"line":297,"address":[19125284],"length":1,"stats":{"Line":0}},{"line":298,"address":[24826240],"length":1,"stats":{"Line":0}},{"line":299,"address":[15300176],"length":1,"stats":{"Line":0}},{"line":303,"address":[17695422],"length":1,"stats":{"Line":0}},{"line":304,"address":[24826371],"length":1,"stats":{"Line":0}},{"line":305,"address":[19005444],"length":1,"stats":{"Line":0}},{"line":309,"address":[24365656],"length":1,"stats":{"Line":0}},{"line":312,"address":[15299029,15298576,15299035],"length":1,"stats":{"Line":0}},{"line":314,"address":[24824605],"length":1,"stats":{"Line":0}},{"line":315,"address":[24824619,24824691],"length":1,"stats":{"Line":0}},{"line":316,"address":[17705463],"length":1,"stats":{"Line":0}},{"line":317,"address":[17634757],"length":1,"stats":{"Line":0}},{"line":318,"address":[19003899,19003956],"length":1,"stats":{"Line":0}},{"line":322,"address":[19124320,19124593],"length":1,"stats":{"Line":0}},{"line":323,"address":[15299187,15299093],"length":1,"stats":{"Line":0}},{"line":324,"address":[19982299,19982367],"length":1,"stats":{"Line":0}},{"line":328,"address":[19005600],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":63},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","task.rs"],"content":"//! Task entity implementation\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Task status variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum TaskStatus {\n    Todo,\n    InProgress,\n    Done,\n    Blocked,\n    Cancelled,\n}\n\n/// Task priority variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\n#[serde(rename_all = \"lowercase\")]\npub enum TaskPriority {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\n/// Task entity representing a work item with status tracking\n#[derive(Debug, Clone, Serialize, Deserialize, Validate)]\npub struct Task {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Task title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Detailed description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Current status\n    #[serde(rename = \"status\")]\n    pub status: TaskStatus,\n\n    /// Priority level\n    #[serde(rename = \"priority\")]\n    pub priority: TaskPriority,\n\n    /// Assigned agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Start time\n    #[serde(rename = \"start_time\")]\n    pub start_time: DateTime\u003cUtc\u003e,\n\n    /// End time\n    #[serde(rename = \"end_time\")]\n    pub end_time: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    /// Parent task ID\n    #[serde(rename = \"parent\", skip_serializing_if = \"Option::is_none\")]\n    pub parent: Option\u003cString\u003e,\n\n    /// Child task IDs\n    #[serde(rename = \"children\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub children: Vec\u003cString\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Associated context IDs\n    #[serde(rename = \"context_ids\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub context_ids: Vec\u003cString\u003e,\n\n    /// Knowledge items\n    #[serde(rename = \"knowledge\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub knowledge: Vec\u003cString\u003e,\n\n    /// Related files\n    #[serde(rename = \"files\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub files: Vec\u003cString\u003e,\n\n    /// Task outcome\n    #[serde(rename = \"outcome\", skip_serializing_if = \"Option::is_none\")]\n    pub outcome: Option\u003cString\u003e,\n\n    #[serde(rename = \"workflow_id\", skip_serializing_if = \"Option::is_none\")]\n    pub workflow_id: Option\u003cString\u003e,\n\n    #[serde(rename = \"workflow_state\", skip_serializing_if = \"Option::is_none\")]\n    pub workflow_state: Option\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\nimpl Task {\n    /// Create a new task\n    pub fn new(\n        title: String,\n        description: String,\n        agent: String,\n        priority: TaskPriority,\n        workflow_id: Option\u003cString\u003e,\n    ) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            description,\n            status: TaskStatus::Todo,\n            priority,\n            agent,\n            start_time: now,\n            end_time: None,\n            parent: None,\n            children: Vec::new(),\n            tags: Vec::new(),\n            context_ids: Vec::new(),\n            knowledge: Vec::new(),\n            files: Vec::new(),\n            outcome: None,\n            workflow_id,\n            workflow_state: None,\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Mark task as in progress\n    pub fn start(\u0026mut self) {\n        self.status = TaskStatus::InProgress;\n    }\n\n    /// Update workflow state\n    pub fn update_workflow_state(\u0026mut self, state: String) {\n        self.workflow_state = Some(state);\n    }\n\n    /// Complete the task\n    pub fn complete(\u0026mut self, outcome: String) {\n        self.status = TaskStatus::Done;\n        self.end_time = Some(Utc::now());\n        self.outcome = Some(outcome);\n    }\n\n    /// Add a child task\n    pub fn add_child(\u0026mut self, child_id: String) {\n        if !self.children.contains(\u0026child_id) {\n            self.children.push(child_id);\n        }\n    }\n\n    /// Add a tag\n    pub fn add_tag(\u0026mut self, tag: String) {\n        if !self.tags.contains(\u0026tag) {\n            self.tags.push(tag);\n        }\n    }\n}\n\nimpl Entity for Task {\n    fn entity_type() -\u003e \u0026'static str {\n        \"task\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.start_time\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Task title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.agent.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Task agent cannot be empty\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.start_time,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize Task: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":111,"address":[16089792,16091192,16091414],"length":1,"stats":{"Line":2}},{"line":118,"address":[17131922],"length":1,"stats":{"Line":6}},{"line":120,"address":[16089963],"length":1,"stats":{"Line":2}},{"line":129,"address":[22819478],"length":1,"stats":{"Line":6}},{"line":130,"address":[16217029],"length":1,"stats":{"Line":2}},{"line":131,"address":[15939009],"length":1,"stats":{"Line":6}},{"line":132,"address":[23280333],"length":1,"stats":{"Line":2}},{"line":133,"address":[23280393],"length":1,"stats":{"Line":5}},{"line":137,"address":[22819842],"length":1,"stats":{"Line":3}},{"line":142,"address":[17133536],"length":1,"stats":{"Line":0}},{"line":143,"address":[15940213],"length":1,"stats":{"Line":0}},{"line":147,"address":[19137120,19137210],"length":1,"stats":{"Line":0}},{"line":148,"address":[23279753,23279646],"length":1,"stats":{"Line":0}},{"line":152,"address":[16218884,16218544,16218858],"length":1,"stats":{"Line":0}},{"line":153,"address":[19139222],"length":1,"stats":{"Line":0}},{"line":154,"address":[19139239,19139300],"length":1,"stats":{"Line":0}},{"line":155,"address":[22821196],"length":1,"stats":{"Line":0}},{"line":159,"address":[22821641,22821408,22821615],"length":1,"stats":{"Line":0}},{"line":160,"address":[22821427,22821509],"length":1,"stats":{"Line":0}},{"line":161,"address":[17134280,17134331],"length":1,"stats":{"Line":0}},{"line":166,"address":[15940431,15940457,15940224],"length":1,"stats":{"Line":0}},{"line":167,"address":[16218323,16218405],"length":1,"stats":{"Line":0}},{"line":168,"address":[17458888,17458939],"length":1,"stats":{"Line":0}},{"line":178,"address":[15942384],"length":1,"stats":{"Line":0}},{"line":179,"address":[17460917],"length":1,"stats":{"Line":0}},{"line":182,"address":[23283664],"length":1,"stats":{"Line":0}},{"line":183,"address":[17460933],"length":1,"stats":{"Line":0}},{"line":186,"address":[16093680],"length":1,"stats":{"Line":0}},{"line":187,"address":[15942440],"length":1,"stats":{"Line":0}},{"line":190,"address":[15942096],"length":1,"stats":{"Line":0}},{"line":191,"address":[16220214],"length":1,"stats":{"Line":0}},{"line":192,"address":[17460723],"length":1,"stats":{"Line":0}},{"line":193,"address":[16164183],"length":1,"stats":{"Line":0}},{"line":197,"address":[23283416],"length":1,"stats":{"Line":0}},{"line":198,"address":[16220376],"length":1,"stats":{"Line":0}},{"line":199,"address":[23283529],"length":1,"stats":{"Line":0}},{"line":203,"address":[17460784],"length":1,"stats":{"Line":0}},{"line":206,"address":[17134576,17135041,17135047],"length":1,"stats":{"Line":7}},{"line":208,"address":[17459805],"length":1,"stats":{"Line":5}},{"line":209,"address":[15941291,15941363],"length":1,"stats":{"Line":10}},{"line":210,"address":[19140115],"length":1,"stats":{"Line":6}},{"line":211,"address":[22822037],"length":1,"stats":{"Line":4}},{"line":212,"address":[16092715,16092772],"length":1,"stats":{"Line":10}},{"line":216,"address":[17135088,17135361],"length":1,"stats":{"Line":3}},{"line":217,"address":[20904112,20904355,20904361],"length":1,"stats":{"Line":6}},{"line":218,"address":[27633551,27633483],"length":1,"stats":{"Line":0}},{"line":222,"address":[17135744],"length":1,"stats":{"Line":0}}],"covered":17,"coverable":47},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","workflow.rs"],"content":"//! Workflow entity implementation\n\nuse super::{Entity, GenericEntity};\nuse chrono::{DateTime, Utc};\nuse schemars::JsonSchema;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse uuid::Uuid;\nuse validator::Validate;\n\n/// Workflow status variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, JsonSchema)]\n#[serde(rename_all = \"lowercase\")]\npub enum WorkflowStatus {\n    Active,\n    Inactive,\n    Draft,\n    Archived,\n}\n\n/// State type variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, JsonSchema)]\n#[serde(rename_all = \"lowercase\")]\npub enum StateType {\n    Start,\n    InProgress,\n    Review,\n    Done,\n    Blocked,\n}\n\n/// Transition type variants\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, JsonSchema)]\n#[serde(rename_all = \"lowercase\")]\npub enum TransitionType {\n    Automatic,\n    Manual,\n    Conditional,\n    Scheduled,\n}\n\n/// Workflow entity\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, JsonSchema)]\npub struct Workflow {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Workflow title\n    #[serde(rename = \"title\")]\n    pub title: String,\n\n    /// Workflow description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Current status\n    #[serde(rename = \"status\")]\n    pub status: WorkflowStatus,\n\n    /// Associated agent\n    #[serde(rename = \"agent\")]\n    pub agent: String,\n\n    /// Creation timestamp\n    #[serde(rename = \"created_at\")]\n    pub created_at: DateTime\u003cUtc\u003e,\n\n    /// Last updated timestamp\n    #[serde(rename = \"updated_at\")]\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    /// Workflow states\n    #[serde(rename = \"states\")]\n    pub states: Vec\u003cWorkflowState\u003e,\n\n    /// Workflow transitions\n    #[serde(rename = \"transitions\")]\n    pub transitions: Vec\u003cWorkflowTransition\u003e,\n\n    /// Initial state\n    #[serde(rename = \"initial_state\")]\n    pub initial_state: String,\n\n    /// Final states\n    #[serde(\n        rename = \"final_states\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub final_states: Vec\u003cString\u003e,\n\n    /// Entity types this workflow applies to\n    #[serde(rename = \"entity_types\")]\n    pub entity_types: Vec\u003cString\u003e,\n\n    /// Permission schemes\n    #[serde(\n        rename = \"permission_schemes\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub permission_schemes: Vec\u003cPermissionScheme\u003e,\n\n    /// Event handlers\n    #[serde(\n        rename = \"event_handlers\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub event_handlers: Vec\u003cEventHandler\u003e,\n\n    /// Tags for categorization\n    #[serde(rename = \"tags\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(\n        rename = \"metadata\",\n        skip_serializing_if = \"HashMap::is_empty\",\n        default\n    )]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\n/// Prompt template for agent instructions\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, PartialEq, JsonSchema)]\npub struct PromptTemplate {\n    /// System prompt template (sets behavior/role)\n    #[serde(rename = \"system\", skip_serializing_if = \"Option::is_none\")]\n    pub system: Option\u003cString\u003e,\n\n    /// User prompt template (specific task instructions)\n    #[serde(rename = \"user\", skip_serializing_if = \"Option::is_none\")]\n    pub user: Option\u003cString\u003e,\n}\n\n/// Workflow state\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, JsonSchema)]\npub struct WorkflowState {\n    /// State identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// State name\n    #[serde(rename = \"name\")]\n    pub name: String,\n\n    /// State type\n    #[serde(rename = \"state_type\")]\n    pub state_type: StateType,\n\n    /// State description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Whether this is a final state\n    #[serde(rename = \"is_final\")]\n    pub is_final: bool,\n\n    /// Prompt templates for this state\n    #[serde(rename = \"prompts\", skip_serializing_if = \"Option::is_none\")]\n    pub prompts: Option\u003cPromptTemplate\u003e,\n\n    /// Guards (conditions for entering/leaving state)\n    #[serde(rename = \"guards\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub guards: Vec\u003cStateGuard\u003e,\n\n    /// Post-functions (actions when entering state)\n    #[serde(\n        rename = \"post_functions\",\n        skip_serializing_if = \"Vec::is_empty\",\n        default\n    )]\n    pub post_functions: Vec\u003cStateFunction\u003e,\n}\n\n/// Workflow transition\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, JsonSchema)]\npub struct WorkflowTransition {\n    /// Transition identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Transition name\n    #[serde(rename = \"name\")]\n    pub name: String,\n\n    /// Source state\n    #[serde(rename = \"from_state\")]\n    pub from_state: String,\n\n    /// Target state\n    #[serde(rename = \"to_state\")]\n    pub to_state: String,\n\n    /// Transition type\n    #[serde(rename = \"transition_type\")]\n    pub transition_type: TransitionType,\n\n    /// Transition description\n    #[serde(rename = \"description\")]\n    pub description: String,\n\n    /// Conditions for transition\n    #[serde(rename = \"conditions\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub conditions: Vec\u003cTransitionCondition\u003e,\n\n    /// Actions to execute during transition\n    #[serde(rename = \"actions\", skip_serializing_if = \"Vec::is_empty\", default)]\n    pub actions: Vec\u003cTransitionAction\u003e,\n}\n\n/// State guard condition\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, JsonSchema)]\npub struct StateGuard {\n    /// Guard identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Guard type (permission, field, custom)\n    #[serde(rename = \"guard_type\")]\n    pub guard_type: String,\n\n    /// Guard condition (JSON logic)\n    #[serde(rename = \"condition\")]\n    pub condition: serde_json::Value,\n\n    /// Error message if guard fails\n    #[serde(rename = \"error_message\")]\n    pub error_message: String,\n}\n\n/// State function (post-function)\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, JsonSchema)]\npub struct StateFunction {\n    /// Function identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Function name\n    #[serde(rename = \"name\")]\n    pub name: String,\n\n    /// Function type (notification, validation, custom)\n    #[serde(rename = \"function_type\")]\n    pub function_type: String,\n\n    /// Function parameters\n    #[serde(rename = \"parameters\")]\n    pub parameters: HashMap\u003cString, serde_json::Value\u003e,\n}\n\n/// Transition condition\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, JsonSchema)]\npub struct TransitionCondition {\n    /// Condition identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Condition type\n    #[serde(rename = \"condition_type\")]\n    pub condition_type: String,\n\n    /// Condition logic\n    #[serde(rename = \"logic\")]\n    pub logic: serde_json::Value,\n}\n\n/// Transition action\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, JsonSchema)]\npub struct TransitionAction {\n    /// Action identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Action name\n    #[serde(rename = \"name\")]\n    pub name: String,\n\n    /// Action type\n    #[serde(rename = \"action_type\")]\n    pub action_type: String,\n\n    /// Action parameters\n    #[serde(rename = \"parameters\")]\n    pub parameters: HashMap\u003cString, serde_json::Value\u003e,\n}\n\n/// Permission scheme\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, JsonSchema)]\npub struct PermissionScheme {\n    /// Scheme identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Scheme name\n    #[serde(rename = \"name\")]\n    pub name: String,\n\n    /// User filter (who can perform actions)\n    #[serde(rename = \"user_filter\")]\n    pub user_filter: String,\n\n    /// Permissions granted\n    #[serde(rename = \"permissions\")]\n    pub permissions: Vec\u003cString\u003e,\n}\n\n/// Event handler\n#[derive(Debug, Clone, Serialize, Deserialize, Validate, JsonSchema)]\npub struct EventHandler {\n    /// Handler identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Event type\n    #[serde(rename = \"event_type\")]\n    pub event_type: String,\n\n    /// Event name\n    #[serde(rename = \"event_name\")]\n    pub event_name: String,\n\n    /// Handler logic\n    #[serde(rename = \"handler\")]\n    pub handler: serde_json::Value,\n\n    /// Whether this handler is active\n    #[serde(rename = \"active\")]\n    pub active: bool,\n}\n\nimpl Workflow {\n    /// Create a new workflow\n    pub fn new(title: String, description: String, agent: String) -\u003e Self {\n        let now = Utc::now();\n        Self {\n            id: Uuid::new_v4().to_string(),\n            title,\n            description,\n            status: WorkflowStatus::Draft,\n            agent,\n            created_at: now,\n            updated_at: now,\n            states: Vec::new(),\n            transitions: Vec::new(),\n            initial_state: String::new(),\n            final_states: Vec::new(),\n            entity_types: Vec::new(),\n            permission_schemes: Vec::new(),\n            event_handlers: Vec::new(),\n            tags: Vec::new(),\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Activate workflow\n    pub fn activate(\u0026mut self) {\n        self.status = WorkflowStatus::Active;\n        self.updated_at = Utc::now();\n    }\n\n    /// Deactivate workflow\n    pub fn deactivate(\u0026mut self) {\n        self.status = WorkflowStatus::Inactive;\n        self.updated_at = Utc::now();\n    }\n\n    /// Add a state\n    pub fn add_state(\u0026mut self, state: WorkflowState) {\n        self.states.push(state);\n        self.updated_at = Utc::now();\n    }\n\n    /// Add a transition\n    pub fn add_transition(\u0026mut self, transition: WorkflowTransition) {\n        self.transitions.push(transition);\n        self.updated_at = Utc::now();\n    }\n\n    /// Set initial state\n    pub fn set_initial_state(\u0026mut self, state_id: String) {\n        self.initial_state = state_id;\n        self.updated_at = Utc::now();\n    }\n\n    /// Add a final state\n    pub fn add_final_state(\u0026mut self, state_id: String) {\n        if !self.final_states.contains(\u0026state_id) {\n            self.final_states.push(state_id);\n        }\n        self.updated_at = Utc::now();\n    }\n\n    /// Add entity type\n    pub fn add_entity_type(\u0026mut self, entity_type: String) {\n        if !self.entity_types.contains(\u0026entity_type) {\n            self.entity_types.push(entity_type);\n        }\n        self.updated_at = Utc::now();\n    }\n}\n\nimpl Entity for Workflow {\n    fn entity_type() -\u003e \u0026'static str {\n        \"workflow\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.created_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if let Err(errors) = \u003cWorkflow as validator::Validate\u003e::validate(self) {\n            let error_messages: Vec\u003cString\u003e = errors\n                .field_errors()\n                .values()\n                .flat_map(|field_errors| field_errors.iter())\n                .map(|error| {\n                    error\n                        .message\n                        .clone()\n                        .map(|s| s.to_string())\n                        .unwrap_or_default()\n                })\n                .collect();\n            return Err(crate::EngramError::Validation(error_messages.join(\", \")));\n        }\n\n        if self.title.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Workflow title cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.description.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Workflow description cannot be empty\".to_string(),\n            ));\n        }\n\n        if self.initial_state.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Workflow must have an initial state\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.agent.clone(),\n            timestamp: self.created_at,\n            data: serde_json::to_value(self).unwrap_or_default(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\"Failed to deserialize Workflow: {}\", e))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any\n    where\n        Self: Sized,\n    {\n        self\n    }\n}\n","traces":[{"line":336,"address":[15893668,15892288,15893783],"length":1,"stats":{"Line":1}},{"line":337,"address":[17213391],"length":1,"stats":{"Line":1}},{"line":339,"address":[23087928],"length":1,"stats":{"Line":1}},{"line":346,"address":[22627394],"length":1,"stats":{"Line":1}},{"line":347,"address":[15991169],"length":1,"stats":{"Line":1}},{"line":348,"address":[15741445],"length":1,"stats":{"Line":1}},{"line":349,"address":[15892741],"length":1,"stats":{"Line":1}},{"line":350,"address":[15741553],"length":1,"stats":{"Line":1}},{"line":351,"address":[23088365],"length":1,"stats":{"Line":1}},{"line":352,"address":[17213993],"length":1,"stats":{"Line":1}},{"line":353,"address":[15892981],"length":1,"stats":{"Line":1}},{"line":354,"address":[20405737],"length":1,"stats":{"Line":1}},{"line":359,"address":[17214896],"length":1,"stats":{"Line":0}},{"line":360,"address":[22628670],"length":1,"stats":{"Line":0}},{"line":361,"address":[23089349],"length":1,"stats":{"Line":0}},{"line":365,"address":[15740128],"length":1,"stats":{"Line":0}},{"line":366,"address":[22626222],"length":1,"stats":{"Line":0}},{"line":367,"address":[15989941],"length":1,"stats":{"Line":0}},{"line":371,"address":[20406560],"length":1,"stats":{"Line":0}},{"line":372,"address":[17214974],"length":1,"stats":{"Line":0}},{"line":373,"address":[17214984],"length":1,"stats":{"Line":0}},{"line":377,"address":[22626272],"length":1,"stats":{"Line":1}},{"line":378,"address":[16896974],"length":1,"stats":{"Line":1}},{"line":379,"address":[15990008],"length":1,"stats":{"Line":1}},{"line":383,"address":[22627005,22626928],"length":1,"stats":{"Line":0}},{"line":384,"address":[22626946,22627040],"length":1,"stats":{"Line":0}},{"line":385,"address":[23087744],"length":1,"stats":{"Line":0}},{"line":389,"address":[22626920,22626894,22626640],"length":1,"stats":{"Line":0}},{"line":390,"address":[15740579,15740664],"length":1,"stats":{"Line":0}},{"line":391,"address":[15740699,15740760],"length":1,"stats":{"Line":0}},{"line":393,"address":[15962760,15962783],"length":1,"stats":{"Line":0}},{"line":397,"address":[16897040,16897294,16897320],"length":1,"stats":{"Line":0}},{"line":398,"address":[15962307,15962392],"length":1,"stats":{"Line":0}},{"line":399,"address":[20404436,20404375],"length":1,"stats":{"Line":0}},{"line":401,"address":[22626536,22626559],"length":1,"stats":{"Line":0}},{"line":410,"address":[17223760],"length":1,"stats":{"Line":0}},{"line":411,"address":[22637525],"length":1,"stats":{"Line":0}},{"line":414,"address":[16001248],"length":1,"stats":{"Line":0}},{"line":415,"address":[17223781],"length":1,"stats":{"Line":0}},{"line":418,"address":[15973504],"length":1,"stats":{"Line":0}},{"line":419,"address":[17223816],"length":1,"stats":{"Line":0}},{"line":422,"address":[17223324,17223330,17222720],"length":1,"stats":{"Line":0}},{"line":423,"address":[17222750],"length":1,"stats":{"Line":0}},{"line":427,"address":[15901910],"length":1,"stats":{"Line":0}},{"line":428,"address":[17223009],"length":1,"stats":{"Line":0}},{"line":429,"address":[14760179],"length":1,"stats":{"Line":0}},{"line":431,"address":[22224263],"length":1,"stats":{"Line":0}},{"line":432,"address":[15489552,15489442,15489536],"length":1,"stats":{"Line":0}},{"line":433,"address":[14760214],"length":1,"stats":{"Line":0}},{"line":436,"address":[22636886],"length":1,"stats":{"Line":0}},{"line":439,"address":[15750531],"length":1,"stats":{"Line":0}},{"line":440,"address":[16907846],"length":1,"stats":{"Line":0}},{"line":441,"address":[15902295],"length":1,"stats":{"Line":0}},{"line":445,"address":[15973044],"length":1,"stats":{"Line":0}},{"line":446,"address":[15902467],"length":1,"stats":{"Line":0}},{"line":447,"address":[15973204],"length":1,"stats":{"Line":0}},{"line":451,"address":[20414973],"length":1,"stats":{"Line":0}},{"line":452,"address":[15973366],"length":1,"stats":{"Line":0}},{"line":453,"address":[15902567],"length":1,"stats":{"Line":0}},{"line":457,"address":[16908075],"length":1,"stats":{"Line":0}},{"line":460,"address":[20413851,20413392,20413845],"length":1,"stats":{"Line":0}},{"line":462,"address":[16906333],"length":1,"stats":{"Line":0}},{"line":463,"address":[15900899,15900827],"length":1,"stats":{"Line":0}},{"line":464,"address":[15749671],"length":1,"stats":{"Line":0}},{"line":465,"address":[15999525],"length":1,"stats":{"Line":0}},{"line":466,"address":[15749755,15749812],"length":1,"stats":{"Line":0}},{"line":470,"address":[17222648,17222368],"length":1,"stats":{"Line":0}},{"line":471,"address":[15999862,15999956],"length":1,"stats":{"Line":0}},{"line":472,"address":[14759851,14759915],"length":1,"stats":{"Line":0}},{"line":476,"address":[16908240],"length":1,"stats":{"Line":0}}],"covered":15,"coverable":70},{"path":["/","home","shift","code","vincents-ai","engram","src","entities","workflow_instance.rs"],"content":"//! Workflow Instance entity implementation\n\nuse super::{Entity, GenericEntity};\nuse crate::engines::workflow_engine::{\n    WorkflowExecutionContext, WorkflowExecutionEvent, WorkflowStatus,\n};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\n\n/// Workflow instance execution state\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct WorkflowInstance {\n    /// Unique identifier\n    #[serde(rename = \"id\")]\n    pub id: String,\n\n    /// Associated workflow ID\n    #[serde(rename = \"workflow_id\")]\n    pub workflow_id: String,\n\n    /// Current state name\n    #[serde(rename = \"current_state\")]\n    pub current_state: String,\n\n    /// Execution context\n    #[serde(rename = \"context\")]\n    pub context: WorkflowExecutionContext,\n\n    /// Instance status\n    #[serde(rename = \"status\")]\n    pub status: WorkflowStatus,\n\n    /// Start timestamp\n    #[serde(rename = \"started_at\")]\n    pub started_at: DateTime\u003cUtc\u003e,\n\n    /// Last update timestamp\n    #[serde(rename = \"updated_at\")]\n    pub updated_at: DateTime\u003cUtc\u003e,\n\n    /// Completion timestamp\n    #[serde(rename = \"completed_at\", skip_serializing_if = \"Option::is_none\")]\n    pub completed_at: Option\u003cDateTime\u003cUtc\u003e\u003e,\n\n    /// Execution history\n    #[serde(rename = \"execution_history\")]\n    pub execution_history: Vec\u003cWorkflowExecutionEvent\u003e,\n}\n\nimpl Entity for WorkflowInstance {\n    fn entity_type() -\u003e \u0026'static str {\n        \"workflow_instance\"\n    }\n\n    fn id(\u0026self) -\u003e \u0026str {\n        \u0026self.id\n    }\n\n    fn agent(\u0026self) -\u003e \u0026str {\n        \u0026self.context.executing_agent\n    }\n\n    fn timestamp(\u0026self) -\u003e DateTime\u003cUtc\u003e {\n        self.updated_at\n    }\n\n    fn validate_entity(\u0026self) -\u003e crate::Result\u003c()\u003e {\n        if self.id.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Workflow instance ID cannot be empty\".to_string(),\n            ));\n        }\n        if self.workflow_id.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Workflow ID cannot be empty\".to_string(),\n            ));\n        }\n        if self.current_state.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Current state cannot be empty\".to_string(),\n            ));\n        }\n        if self.context.executing_agent.is_empty() {\n            return Err(crate::EngramError::Validation(\n                \"Executing agent cannot be empty\".to_string(),\n            ));\n        }\n        Ok(())\n    }\n\n    fn to_generic(\u0026self) -\u003e GenericEntity {\n        GenericEntity {\n            id: self.id.clone(),\n            entity_type: Self::entity_type().to_string(),\n            agent: self.context.executing_agent.clone(),\n            timestamp: self.updated_at,\n            data: serde_json::to_value(self).unwrap(),\n        }\n    }\n\n    fn from_generic(entity: GenericEntity) -\u003e crate::Result\u003cSelf\u003e {\n        serde_json::from_value(entity.data).map_err(|e| {\n            crate::EngramError::Deserialization(format!(\n                \"Failed to deserialize workflow instance: {}\",\n                e\n            ))\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any {\n        self\n    }\n}\n","traces":[{"line":55,"address":[27544720],"length":1,"stats":{"Line":0}},{"line":56,"address":[21759541],"length":1,"stats":{"Line":0}},{"line":59,"address":[15766816],"length":1,"stats":{"Line":0}},{"line":60,"address":[20664149],"length":1,"stats":{"Line":0}},{"line":63,"address":[20815424],"length":1,"stats":{"Line":0}},{"line":64,"address":[15766856],"length":1,"stats":{"Line":0}},{"line":67,"address":[20874080],"length":1,"stats":{"Line":0}},{"line":68,"address":[22325686],"length":1,"stats":{"Line":0}},{"line":69,"address":[20663683],"length":1,"stats":{"Line":0}},{"line":70,"address":[15766327],"length":1,"stats":{"Line":0}},{"line":73,"address":[20874136],"length":1,"stats":{"Line":0}},{"line":74,"address":[20663793],"length":1,"stats":{"Line":0}},{"line":75,"address":[28005026],"length":1,"stats":{"Line":0}},{"line":78,"address":[28005011],"length":1,"stats":{"Line":0}},{"line":79,"address":[27544504],"length":1,"stats":{"Line":0}},{"line":80,"address":[20663881],"length":1,"stats":{"Line":0}},{"line":83,"address":[27544458],"length":1,"stats":{"Line":0}},{"line":84,"address":[15766709],"length":1,"stats":{"Line":0}},{"line":85,"address":[20874502],"length":1,"stats":{"Line":0}},{"line":88,"address":[27544589],"length":1,"stats":{"Line":0}},{"line":91,"address":[15765408,15765882,15765876],"length":1,"stats":{"Line":5}},{"line":93,"address":[27543357],"length":1,"stats":{"Line":1}},{"line":94,"address":[20873279,20873351],"length":1,"stats":{"Line":6}},{"line":95,"address":[20662875],"length":1,"stats":{"Line":5}},{"line":96,"address":[28004201],"length":1,"stats":{"Line":1}},{"line":97,"address":[20885032,20884975],"length":1,"stats":{"Line":6}},{"line":101,"address":[27543840,27544113],"length":1,"stats":{"Line":1}},{"line":102,"address":[15989472,15989711,15989717],"length":1,"stats":{"Line":2}},{"line":103,"address":[17359919,17359851],"length":1,"stats":{"Line":0}},{"line":110,"address":[21759568],"length":1,"stats":{"Line":0}}],"covered":8,"coverable":30},{"path":["/","home","shift","code","vincents-ai","engram","src","error.rs"],"content":"//! Error types for the Engram system\n\nuse thiserror::Error;\n\n/// Main error type for Engram operations\n#[derive(Error, Debug)]\npub enum EngramError {\n    #[error(\"Storage error: {0}\")]\n    Storage(#[from] StorageError),\n\n    #[error(\"Configuration error: {0}\")]\n    Config(#[from] ConfigError),\n\n    #[error(\"Entity validation error: {0}\")]\n    Validation(String),\n\n    #[error(\"Git operation failed: {0}\")]\n    Git(String),\n\n    #[error(\"IO error: {0}\")]\n    Io(#[from] std::io::Error),\n\n    #[error(\"Deserialization error: {0}\")]\n    Deserialization(String),\n\n    #[error(\"Serialization error: {0}\")]\n    Serialization(#[from] serde_json::Error),\n\n    #[error(\"YAML error: {0}\")]\n    Yaml(#[from] serde_yaml::Error),\n\n    #[error(\"Not found: {0}\")]\n    NotFound(String),\n\n    #[error(\"Already exists: {0}\")]\n    AlreadyExists(String),\n\n    #[error(\"Invalid operation: {0}\")]\n    InvalidOperation(String),\n}\n\nimpl From\u003cgit2::Error\u003e for EngramError {\n    fn from(error: git2::Error) -\u003e Self {\n        EngramError::Git(error.to_string())\n    }\n}\n\n/// Storage-specific errors\n#[derive(Error, Debug)]\npub enum StorageError {\n    #[error(\"Repository not found: {0}\")]\n    RepositoryNotFound(String),\n\n    #[error(\"Invalid repository state: {0}\")]\n    InvalidState(String),\n\n    #[error(\"Git operation failed: {0}\")]\n    GitOperation(String),\n\n    #[error(\"Entity not found: {0}\")]\n    EntityNotFound(String),\n}\n\n/// Configuration-specific errors\n#[derive(Error, Debug)]\npub enum ConfigError {\n    #[error(\"File not found: {0}\")]\n    FileNotFound(String),\n\n    #[error(\"Invalid format: {0}\")]\n    InvalidFormat(String),\n\n    #[error(\"Validation failed: {0}\")]\n    ValidationFailed(String),\n}\n\n/// Result type alias for convenience\npub type Result\u003cT\u003e = std::result::Result\u003cT, EngramError\u003e;\n","traces":[{"line":42,"address":[27727176,27727136],"length":1,"stats":{"Line":0}},{"line":43,"address":[16228240,16228363],"length":1,"stats":{"Line":0}},{"line":44,"address":[17545661,17545603],"length":1,"stats":{"Line":5}},{"line":78,"address":[25046881],"length":1,"stats":{"Line":0}}],"covered":1,"coverable":4},{"path":["/","home","shift","code","vincents-ai","engram","src","lib.rs"],"content":"//! Engram - Distributed Memory System for AI Agents\n//!\n//! This is the Rust implementation of the Engram system, providing\n//! a distributed memory system with Git-based storage, CLI interface,\n//! and extensible architecture for AI agents.\n\npub mod analytics;\npub mod ask;\npub mod cli;\npub mod collab;\npub mod config;\npub mod engines;\npub mod entities;\npub mod error;\npub mod locus_cli;\npub mod locus_handlers;\npub mod locus_integration;\n#[cfg(feature = \"tui\")]\npub mod locus_tui;\npub mod migration;\npub mod nlq;\npub mod perkeep;\npub mod quality_gates;\n#[cfg(feature = \"sandbox\")]\npub mod sandbox;\npub mod session;\npub mod storage;\npub mod validation;\npub mod vector;\npub mod version;\n\nuse std::result::Result as StdResult;\n\n/// Common result type used throughout the application\npub type Result\u003cT\u003e = StdResult\u003cT, error::EngramError\u003e;\n\npub use config::Config;\n/// Re-export commonly used types\npub use entities::*;\npub use error::EngramError;\npub use storage::{MemoryEntity, Storage};\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_library_compilation() {\n        // Basic test to ensure library compiles\n        assert!(true);\n    }\n}\n","traces":[{"line":35,"address":[27212464,27212491,27212372],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":1},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_cli","govern.rs"],"content":"use clap::Subcommand;\n\n#[derive(Subcommand)]\npub enum GovernCommands {\n    Policy {\n        #[command(subcommand)]\n        subcommand: PolicyCommands,\n    },\n\n    QualityGate {\n        #[command(subcommand)]\n        subcommand: QualityGateCommands,\n    },\n\n    Compliance {\n        #[command(subcommand)]\n        subcommand: ComplianceCommands,\n    },\n}\n\n#[derive(Subcommand)]\npub enum PolicyCommands {\n    Create {\n        #[arg(long, short)]\n        name: String,\n\n        #[arg(long, short)]\n        rule: String,\n\n        #[arg(long)]\n        scope: Option\u003cString\u003e,\n    },\n\n    List {\n        #[arg(long)]\n        scope: Option\u003cString\u003e,\n    },\n\n    Enforce {\n        #[arg(long, short)]\n        policy: String,\n\n        #[arg(long)]\n        dry_run: bool,\n    },\n}\n\n#[derive(Subcommand)]\npub enum QualityGateCommands {\n    Create {\n        #[arg(long, short)]\n        name: String,\n\n        #[arg(long, short)]\n        command: String,\n\n        #[arg(long)]\n        required: bool,\n    },\n\n    List {\n        #[arg(long)]\n        category: Option\u003cString\u003e,\n    },\n\n    Validate {\n        #[arg(long, short)]\n        gate: String,\n\n        #[arg(long)]\n        context: Option\u003cString\u003e,\n    },\n}\n\n#[derive(Subcommand)]\npub enum ComplianceCommands {\n    Check {\n        #[arg(long)]\n        standard: Option\u003cString\u003e,\n\n        #[arg(long)]\n        report_format: Option\u003cString\u003e,\n    },\n\n    Report {\n        #[arg(long, short)]\n        period: String,\n\n        #[arg(long)]\n        output: Option\u003cString\u003e,\n    },\n\n    Audit {\n        #[arg(long, short)]\n        target: String,\n\n        #[arg(long)]\n        deep_scan: bool,\n    },\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_cli","mod.rs"],"content":"pub mod govern;\npub mod override_cmd;\npub mod template;\npub mod visualize;\npub mod workflow;\n\nuse clap::Subcommand;\n\n#[derive(Subcommand)]\npub enum LocusCommands {\n    Workflow {\n        #[command(subcommand)]\n        subcommand: workflow::WorkflowCommands,\n    },\n    Template {\n        #[command(subcommand)]\n        subcommand: template::TemplateCommands,\n    },\n    Visualize {\n        #[command(subcommand)]\n        subcommand: visualize::VisualizeCommands,\n    },\n    Govern {\n        #[command(subcommand)]\n        subcommand: govern::GovernCommands,\n    },\n    Override {\n        #[command(subcommand)]\n        subcommand: override_cmd::OverrideCommands,\n    },\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_cli","override_cmd.rs"],"content":"use clap::Subcommand;\n\n#[derive(Subcommand)]\npub enum OverrideCommands {\n    Approve {\n        #[arg(long, short)]\n        task_id: String,\n\n        #[arg(long, short)]\n        reason: String,\n\n        #[arg(long)]\n        override_type: String,\n    },\n\n    Reject {\n        #[arg(long, short)]\n        task_id: String,\n\n        #[arg(long, short)]\n        reason: String,\n\n        #[arg(long)]\n        block_future: bool,\n    },\n\n    Emergency {\n        #[command(subcommand)]\n        subcommand: EmergencyCommands,\n    },\n\n    List {\n        #[arg(long)]\n        status: Option\u003cString\u003e,\n\n        #[arg(long)]\n        agent: Option\u003cString\u003e,\n\n        #[arg(long, default_value = \"table\")]\n        format: String,\n    },\n}\n\n#[derive(Subcommand)]\npub enum EmergencyCommands {\n    Halt {\n        #[arg(long, short)]\n        reason: String,\n\n        #[arg(long)]\n        scope: Option\u003cString\u003e,\n    },\n\n    Rollback {\n        #[arg(long, short)]\n        task_id: String,\n\n        #[arg(long)]\n        rollback_point: String,\n    },\n\n    Bypass {\n        #[arg(long, short)]\n        gate: String,\n\n        #[arg(long, short)]\n        duration: String,\n\n        #[arg(long, short)]\n        justification: String,\n    },\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_cli","template.rs"],"content":"use clap::Subcommand;\n\n#[derive(Subcommand)]\npub enum TemplateCommands {\n    Create {\n        #[arg(long, short)]\n        name: String,\n\n        #[arg(long, short)]\n        description: String,\n\n        #[arg(long)]\n        category: Option\u003cString\u003e,\n    },\n\n    List {\n        #[arg(long)]\n        category: Option\u003cString\u003e,\n\n        #[arg(long, default_value = \"table\")]\n        format: String,\n    },\n\n    Apply {\n        #[arg(long, short)]\n        template: String,\n\n        #[arg(long, short)]\n        target: String,\n    },\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_cli","visualize.rs"],"content":"use clap::Subcommand;\n\n#[derive(Subcommand)]\npub enum VisualizeCommands {\n    Dashboard {\n        #[arg(long, short)]\n        agent: Option\u003cString\u003e,\n\n        #[arg(long)]\n        real_time: bool,\n    },\n\n    AgentMap {\n        #[arg(long)]\n        time_range: Option\u003cString\u003e,\n\n        #[arg(long)]\n        include_inactive: bool,\n    },\n\n    WorkflowStatus {\n        #[arg(long, short)]\n        workflow_id: Option\u003cString\u003e,\n    },\n\n    SystemHealth {\n        #[arg(long)]\n        detailed: bool,\n\n        #[arg(long)]\n        watch: bool,\n    },\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_cli","workflow.rs"],"content":"use clap::Subcommand;\n\n#[derive(Subcommand)]\npub enum WorkflowCommands {\n    /// Create a new workflow design\n    Create {\n        /// Workflow name\n        #[arg(long, short)]\n        name: String,\n\n        /// Workflow description\n        #[arg(long, short)]\n        description: String,\n\n        /// Output file path (optional, defaults to stdout)\n        #[arg(long, short)]\n        output: Option\u003cString\u003e,\n    },\n\n    /// Visual workflow builder with drag-and-drop composition\n    Design {\n        /// Workflow name to edit\n        #[arg(long, short)]\n        name: Option\u003cString\u003e,\n\n        /// Launch in interactive mode\n        #[arg(long, short)]\n        interactive: bool,\n    },\n\n    /// List existing workflows\n    List {\n        /// Filter by type\n        #[arg(long)]\n        workflow_type: Option\u003cString\u003e,\n\n        /// Output format (table, json, yaml)\n        #[arg(long, default_value = \"table\")]\n        format: String,\n    },\n\n    /// Show workflow details\n    Show {\n        /// Workflow name or ID\n        name: String,\n\n        /// Include execution history\n        #[arg(long)]\n        with_history: bool,\n    },\n\n    /// Validate workflow configuration\n    Validate {\n        /// Workflow file path\n        #[arg(long, short)]\n        file: String,\n\n        /// Show detailed validation results\n        #[arg(long)]\n        detailed: bool,\n    },\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_handlers.rs"],"content":"//! Main Locus integration with Engram storage\n//!\n//! Handles loading configuration and setting up integration layer\n\nuse crate::entities::TaskStatus;\nuse crate::locus_integration::LocusIntegration;\nuse crate::storage::{RelationshipStorage, Storage};\nuse std::io;\n\npub async fn handle_locus_command\u003cS: Storage + RelationshipStorage\u003e(\n    integration: \u0026mut LocusIntegration\u003cS\u003e,\n    command: crate::locus_cli::LocusCommands,\n) -\u003e io::Result\u003c()\u003e {\n    match command {\n        crate::locus_cli::LocusCommands::Workflow { subcommand } =\u003e {\n            handle_workflow_integration(integration, subcommand).await\n        }\n        crate::locus_cli::LocusCommands::Template { subcommand } =\u003e {\n            handle_template_integration(integration, subcommand).await\n        }\n        crate::locus_cli::LocusCommands::Visualize { subcommand } =\u003e {\n            handle_visualize_integration(integration, subcommand).await\n        }\n        crate::locus_cli::LocusCommands::Govern { subcommand } =\u003e {\n            handle_govern_integration(integration, subcommand).await\n        }\n        crate::locus_cli::LocusCommands::Override { subcommand } =\u003e {\n            handle_override_integration(integration, subcommand).await\n        }\n    }\n}\n\nasync fn handle_workflow_integration\u003cS: Storage + RelationshipStorage\u003e(\n    integration: \u0026mut LocusIntegration\u003cS\u003e,\n    command: crate::locus_cli::workflow::WorkflowCommands,\n) -\u003e io::Result\u003c()\u003e {\n    match command {\n        crate::locus_cli::workflow::WorkflowCommands::List {\n            workflow_type: _,\n            format,\n        } =\u003e {\n            println!(\"üìã Loading workflows from Engram...\");\n\n            match integration.get_workflows() {\n                Ok(workflows) =\u003e {\n                    println!(\"Found {} workflows\", workflows.len());\n\n                    for workflow in workflows {\n                        match format.as_str() {\n                            \"json\" =\u003e {\n                                println!(\"{}\", serde_json::to_string_pretty(\u0026workflow).unwrap())\n                            }\n                            \"yaml\" =\u003e println!(\"{}\", serde_yaml::to_string(\u0026workflow).unwrap()),\n                            _ =\u003e {\n                                println!(\"üèóÔ∏è  {}\", workflow.title);\n                                println!(\"   {}\", workflow.description);\n                                println!(\"   Status: {:?}\", workflow.status);\n                            }\n                        }\n                    }\n                }\n                Err(e) =\u003e {\n                    eprintln!(\"‚ùå Error loading workflows: {}\", e);\n                }\n            }\n        }\n\n        crate::locus_cli::workflow::WorkflowCommands::Show { name, with_history } =\u003e {\n            println!(\"üìÑ Loading workflow details...\");\n\n            match integration.get_workflow(\u0026name) {\n                Ok(Some(workflow)) =\u003e {\n                    println!(\"üèóÔ∏è  {}\", workflow.title);\n                    println!(\"   {}\", workflow.description);\n                    println!(\"   Status: {:?}\", workflow.status);\n\n                    if with_history {\n                        println!(\"üìä Loading execution history...\");\n                        println!(\"üöß Execution history not yet implemented\");\n                    }\n                }\n                Ok(None) =\u003e {\n                    eprintln!(\"‚ùå Workflow '{}' not found\", name);\n                }\n                Err(e) =\u003e {\n                    eprintln!(\"‚ùå Error loading workflow: {}\", e);\n                }\n            }\n        }\n\n        _ =\u003e {\n            println!(\"üöß Command requires full Engram integration - not yet implemented\");\n        }\n    }\n\n    Ok(())\n}\n\nasync fn handle_template_integration\u003cS: Storage + RelationshipStorage\u003e(\n    _integration: \u0026mut LocusIntegration\u003cS\u003e,\n    _command: crate::locus_cli::template::TemplateCommands,\n) -\u003e io::Result\u003c()\u003e {\n    println!(\"üß© Template management requires Engram integration - not yet implemented\");\n    Ok(())\n}\n\nasync fn handle_visualize_integration\u003cS: Storage + RelationshipStorage\u003e(\n    integration: \u0026mut LocusIntegration\u003cS\u003e,\n    command: crate::locus_cli::visualize::VisualizeCommands,\n) -\u003e io::Result\u003c()\u003e {\n    match command {\n        crate::locus_cli::visualize::VisualizeCommands::Dashboard { agent, real_time } =\u003e {\n            println!(\"üöÄ Loading dashboard data from Engram...\");\n\n            match integration.get_tasks(agent.as_deref()) {\n                Ok(tasks) =\u003e {\n                    println!(\"üìä Dashboard Overview:\");\n                    println!(\"   Total Tasks: {}\", tasks.len());\n\n                    let active_tasks = tasks\n                        .iter()\n                        .filter(|t| t.status == TaskStatus::InProgress)\n                        .count();\n                    println!(\"   Active Tasks: {}\", active_tasks);\n\n                    let completed_tasks = tasks\n                        .iter()\n                        .filter(|t| t.status == TaskStatus::Done)\n                        .count();\n                    println!(\"   Completed Tasks: {}\", completed_tasks);\n\n                    if let Some(agent_name) = agent {\n                        println!(\"   Filtered by agent: {}\", agent_name);\n                    }\n\n                    if real_time {\n                        println!(\"üîÑ Real-time updates: enabled (not yet implemented)\");\n                    }\n                }\n                Err(e) =\u003e {\n                    eprintln!(\"‚ùå Error loading dashboard data: {}\", e);\n                }\n            }\n        }\n\n        crate::locus_cli::visualize::VisualizeCommands::SystemHealth { detailed, watch } =\u003e {\n            println!(\"üíì Loading system health from Engram...\");\n\n            match integration.get_system_health() {\n                Ok(health) =\u003e {\n                    println!(\"üè• System Health:\");\n                    println!(\"   Total Tasks: {}\", health.total_tasks);\n                    println!(\"   Total Workflows: {}\", health.total_workflows);\n                    println!(\"   Error Count: {}\", health.error_count);\n                    println!(\"   Last Updated: {}\", health.last_updated);\n\n                    if detailed {\n                        println!(\"üîç Detailed metrics (not yet implemented)\");\n                    }\n\n                    if watch {\n                        println!(\"üëÄ Watch mode: enabled (not yet implemented)\");\n                    }\n                }\n                Err(e) =\u003e {\n                    eprintln!(\"‚ùå Error loading system health: {}\", e);\n                }\n            }\n        }\n\n        _ =\u003e {\n            println!(\"üöß Visualization command requires Engram integration - not yet implemented\");\n        }\n    }\n\n    Ok(())\n}\n\nasync fn handle_govern_integration\u003cS: Storage + RelationshipStorage\u003e(\n    _integration: \u0026mut LocusIntegration\u003cS\u003e,\n    _command: crate::locus_cli::govern::GovernCommands,\n) -\u003e io::Result\u003c()\u003e {\n    println!(\"‚öñÔ∏è Governance requires Engram integration - not yet implemented\");\n    Ok(())\n}\n\nasync fn handle_override_integration\u003cS: Storage + RelationshipStorage\u003e(\n    integration: \u0026mut LocusIntegration\u003cS\u003e,\n    command: crate::locus_cli::override_cmd::OverrideCommands,\n) -\u003e io::Result\u003c()\u003e {\n    match command {\n        crate::locus_cli::override_cmd::OverrideCommands::Approve {\n            task_id,\n            reason,\n            override_type,\n        } =\u003e {\n            println!(\"‚úÖ Creating emergency override...\");\n\n            match integration.create_emergency_override(\u0026task_id, \u0026reason, \u0026override_type) {\n                Ok(override_id) =\u003e {\n                    println!(\"‚úÖ Override created: {}\", override_id);\n                    println!(\"Task: {}\", task_id);\n                    println!(\"Reason: {}\", reason);\n                    println!(\"Type: {}\", override_type);\n                }\n                Err(e) =\u003e {\n                    eprintln!(\"‚ùå Error creating override: {}\", e);\n                }\n            }\n        }\n\n        crate::locus_cli::override_cmd::OverrideCommands::Emergency { subcommand } =\u003e {\n            match subcommand {\n                crate::locus_cli::override_cmd::EmergencyCommands::Halt { reason, scope } =\u003e {\n                    println!(\"üõë EMERGENCY HALT\");\n                    println!(\"Reason: {}\", reason);\n                    if let Some(s) = scope {\n                        println!(\"Scope: {}\", s);\n                    }\n                    println!(\"üöß Emergency halt requires system-level integration\");\n                }\n\n                _ =\u003e {\n                    println!(\"üöß Emergency command requires full integration\");\n                }\n            }\n        }\n\n        _ =\u003e {\n            println!(\"üöß Override command requires Engram integration - not yet implemented\");\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":10,"address":[14850784],"length":1,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[14851200],"length":1,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[14722360],"length":1,"stats":{"Line":0}},{"line":21,"address":[14851416],"length":1,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[14851153,14852003,14852914,14851564],"length":1,"stats":{"Line":0}},{"line":27,"address":[14851587],"length":1,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[14856992],"length":1,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[14857667],"length":1,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[14857441,14859517],"length":1,"stats":{"Line":0}},{"line":71,"address":[14859544,14859736],"length":1,"stats":{"Line":0}},{"line":72,"address":[14859801],"length":1,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[14859706,14860509],"length":1,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[14856576],"length":1,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[14860832],"length":1,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[14861652],"length":1,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[14862119],"length":1,"stats":{"Line":0}},{"line":132,"address":[14862215],"length":1,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[14862334],"length":1,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[14861441],"length":1,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[14863238],"length":1,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[14863446],"length":1,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[14853344],"length":1,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[14853760],"length":1,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[14854760,14854689],"length":1,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[14854563],"length":1,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[14855727],"length":1,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":123},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_integration.rs"],"content":"//! Integration layer between Locus and Engram\n//!\n//! Provides Locus with access to Engram's storage, entities,\n//! and functionality through a clean API boundary.\n\nuse crate::entities::*;\nuse crate::error::EngramError;\nuse crate::storage::{RelationshipStorage, Storage};\n\n/// Integration interface for Locus to access Engram functionality\npub struct LocusIntegration\u003cS: Storage + RelationshipStorage\u003e {\n    storage: S,\n}\n\nimpl\u003cS: Storage + RelationshipStorage\u003e LocusIntegration\u003cS\u003e {\n    /// Create new Locus integration instance\n    pub fn new(storage: S) -\u003e Self {\n        Self { storage }\n    }\n\n    /// Get all workflows from Engram storage\n    pub fn get_workflows(\u0026self) -\u003e Result\u003cVec\u003cWorkflow\u003e, EngramError\u003e {\n        let mut workflows = Vec::new();\n\n        // Query Workflow entities from storage\n        let entities = self.storage.get_all(\"workflow\")?;\n\n        for entity in entities {\n            if let Ok(workflow) = serde_json::from_value::\u003cWorkflow\u003e(entity.data) {\n                workflows.push(workflow);\n            }\n        }\n\n        Ok(workflows)\n    }\n\n    /// Get workflow by name\n    pub fn get_workflow(\u0026self, name: \u0026str) -\u003e Result\u003cOption\u003cWorkflow\u003e, EngramError\u003e {\n        let workflow_id = format!(\"workflow-{}\", name);\n\n        if let Some(entity) = self.storage.get(\u0026workflow_id, \"workflow\")? {\n            let workflow = serde_json::from_value::\u003cWorkflow\u003e(entity.data)?;\n            Ok(Some(workflow))\n        } else {\n            Ok(None)\n        }\n    }\n\n    /// Save workflow to Engram storage\n    pub fn save_workflow(\u0026mut self, workflow: \u0026Workflow) -\u003e Result\u003cString, EngramError\u003e {\n        let workflow_id = workflow.id.clone();\n\n        // Convert to generic entity\n        let entity = GenericEntity {\n            id: workflow_id.clone(),\n            entity_type: \"workflow\".to_string(),\n            agent: workflow.agent.clone(),\n            timestamp: workflow.created_at,\n            data: serde_json::to_value(workflow)?,\n        };\n\n        self.storage.store(\u0026entity)?;\n        Ok(workflow_id)\n    }\n\n    /// Get all tasks for visualization\n    pub fn get_tasks(\u0026self, agent_filter: Option\u003c\u0026str\u003e) -\u003e Result\u003cVec\u003cTask\u003e, EngramError\u003e {\n        let mut tasks = Vec::new();\n\n        let entities = self.storage.get_all(\"task\")?;\n\n        for entity in entities {\n            if let Ok(task) = serde_json::from_value::\u003cTask\u003e(entity.data) {\n                if let Some(agent) = agent_filter {\n                    if task.agent.as_str() == agent {\n                        tasks.push(task);\n                    }\n                } else {\n                    tasks.push(task);\n                }\n            }\n        }\n\n        Ok(tasks)\n    }\n\n    /// Get execution results for dashboard\n    pub fn get_execution_results(\n        \u0026self,\n        task_id: Option\u003c\u0026str\u003e,\n        time_range: Option\u003c(chrono::DateTime\u003cchrono::Utc\u003e, chrono::DateTime\u003cchrono::Utc\u003e)\u003e,\n    ) -\u003e Result\u003cVec\u003cExecutionResult\u003e, EngramError\u003e {\n        let mut results = Vec::new();\n\n        let entities = self.storage.get_all(\"execution_result\")?;\n\n        for entity in entities {\n            if let Ok(result) = serde_json::from_value::\u003cExecutionResult\u003e(entity.data) {\n                // Apply filters\n                if let Some(filter_task_id) = task_id {\n                    if result.task_id.to_string() != filter_task_id {\n                        continue;\n                    }\n                }\n\n                if let Some((start, end)) = time_range {\n                    if result.timestamp \u003c start || result.timestamp \u003e end {\n                        continue;\n                    }\n                }\n\n                results.push(result);\n            }\n        }\n\n        Ok(results)\n    }\n\n    /// Get system health metrics\n    pub fn get_system_health(\u0026self) -\u003e Result\u003cSystemHealth, EngramError\u003e {\n        let task_count = self.storage.get_all(\"task\")?.len();\n        let workflow_count = self.storage.get_all(\"workflow\")?.len();\n        let error_count = self\n            .storage\n            .get_all(\"execution_result\")?\n            .iter()\n            .filter_map(|entity| {\n                serde_json::from_value::\u003cExecutionResult\u003e(entity.data.clone()).ok()\n            })\n            .filter(|result| {\n                matches!(\n                    result.validation_status,\n                    crate::entities::ValidationStatus::Failed { .. }\n                )\n            })\n            .count();\n\n        Ok(SystemHealth {\n            total_tasks: task_count,\n            total_workflows: workflow_count,\n            error_count,\n            last_updated: chrono::Utc::now(),\n        })\n    }\n\n    /// Create emergency override\n    pub fn create_emergency_override(\n        \u0026mut self,\n        task_id: \u0026str,\n        reason: \u0026str,\n        override_type: \u0026str,\n    ) -\u003e Result\u003cString, EngramError\u003e {\n        let override_id = uuid::Uuid::new_v4().to_string();\n\n        // Create override entity\n        let override_entity = GenericEntity {\n            id: override_id.clone(),\n            entity_type: \"emergency_override\".to_string(),\n            agent: \"locus\".to_string(),\n            timestamp: chrono::Utc::now(),\n            data: serde_json::json!({\n                \"task_id\": task_id,\n                \"reason\": reason,\n                \"override_type\": override_type,\n                \"status\": \"active\",\n                \"created_by\": \"locus\"\n            }),\n        };\n\n        self.storage.store(\u0026override_entity)?;\n\n        // Create relationship to task\n        let relationship = EntityRelationship::new(\n            format!(\"rel-{}\", uuid::Uuid::new_v4().to_string().split_at(8).0),\n            \"locus\".to_string(),\n            override_id.clone(),\n            \"emergency_override\".to_string(),\n            task_id.to_string(),\n            \"task\".to_string(),\n            EntityRelationType::Custom(\"overrides\".to_string()),\n        );\n        self.storage.store_relationship(\u0026relationship)?;\n\n        Ok(override_id)\n    }\n}\n\n/// System health metrics for dashboard\n#[derive(Debug, serde::Serialize, serde::Deserialize)]\npub struct SystemHealth {\n    pub total_tasks: usize,\n    pub total_workflows: usize,\n    pub error_count: usize,\n    pub last_updated: chrono::DateTime\u003cchrono::Utc\u003e,\n}\n","traces":[{"line":17,"address":[14609968],"length":1,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[14604493,14604563],"length":1,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[14602919],"length":1,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[14610000,14611540,14611807],"length":1,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[14611424,14611179],"length":1,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[14605991,14604848,14605985],"length":1,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[14606138],"length":1,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[14606160,14609922,14609642],"length":1,"stats":{"Line":0}},{"line":153,"address":[14606265],"length":1,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[14608145,14609780,14608074],"length":1,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":78},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_main.rs"],"content":"use clap::Parser;\nuse engram::locus_cli::LocusCommands;\nuse engram::locus_handlers::handle_locus_command;\nuse engram::locus_integration::LocusIntegration;\nuse engram::locus_tui::LocusTuiApp;\nuse engram::storage::GitRefsStorage;\n\nmod locus_cli;\n\n#[derive(Parser)]\n#[command(name = \"locus\")]\n#[command(about = \"Locus - Human TUI Interface for Engram System\", long_about = None)]\n#[command(version = env!(\"CARGO_PKG_VERSION\"))]\nstruct Cli {\n    /// Run in CLI mode instead of TUI\n    #[arg(long)]\n    cli: bool,\n\n    #[command(subcommand)]\n    command: Option\u003cLocusCommands\u003e,\n}\n\n#[tokio::main]\nasync fn main() -\u003e std::io::Result\u003c()\u003e {\n    // Initialize logging\n    tracing_subscriber::fmt::init();\n\n    let cli = Cli::parse();\n\n    // Default to TUI mode when no arguments provided\n    let in_cli_mode = cli.cli || cli.command.is_some();\n\n    if in_cli_mode {\n        // CLI mode\n        let storage = GitRefsStorage::new(\".\", \"default\")\n            .map_err(|e| std::io::Error::new(std::io::ErrorKind::Other, e))?;\n        let mut integration = LocusIntegration::new(storage);\n\n        if let Some(command) = cli.command {\n            handle_locus_command(\u0026mut integration, command).await?;\n        } else {\n            println!(\"No command provided. Use --help to see available commands.\");\n        }\n    } else {\n        // TUI mode (default)\n        let storage = GitRefsStorage::new(\".\", \"default\")\n            .map_err(|e| std::io::Error::new(std::io::ErrorKind::Other, e))?;\n        let mut app = LocusTuiApp::new(storage);\n        app.run()?;\n    }\n    Ok(())\n}\n","traces":[{"line":24,"address":[14811615,14811216,14811621],"length":1,"stats":{"Line":0}},{"line":26,"address":[14841889],"length":1,"stats":{"Line":0}},{"line":28,"address":[14842011],"length":1,"stats":{"Line":0}},{"line":31,"address":[14842066,14842176],"length":1,"stats":{"Line":0}},{"line":33,"address":[14811247,14811377],"length":1,"stats":{"Line":0}},{"line":35,"address":[14843357,14844117,14842239,14843297],"length":1,"stats":{"Line":0}},{"line":36,"address":[14844736,14843341,14844740,14843274],"length":1,"stats":{"Line":0}},{"line":37,"address":[14843619],"length":1,"stats":{"Line":0}},{"line":39,"address":[14844461,14843803],"length":1,"stats":{"Line":0}},{"line":40,"address":[14724393],"length":1,"stats":{"Line":0}},{"line":42,"address":[14843939,14844076],"length":1,"stats":{"Line":0}},{"line":46,"address":[14842420,14842360,14843169,14842195],"length":1,"stats":{"Line":0}},{"line":47,"address":[14844752,14842337,14842404,14844756],"length":1,"stats":{"Line":0}},{"line":48,"address":[14842678],"length":1,"stats":{"Line":0}},{"line":49,"address":[14842870,14842924,14843103],"length":1,"stats":{"Line":0}},{"line":51,"address":[14811485,14811307,14811396],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":16},{"path":["/","home","shift","code","vincents-ai","engram","src","locus_tui.rs"],"content":"use crate::locus_integration::LocusIntegration;\nuse crate::storage::{RelationshipStorage, Storage};\nuse crossterm::event::{self, Event, KeyCode};\nuse ratatui::backend::CrosstermBackend;\nuse ratatui::layout::{Constraint, Direction, Layout};\nuse ratatui::style::{Color, Style};\nuse ratatui::widgets::{Block, Borders, List, ListItem, Paragraph};\nuse ratatui::Terminal;\nuse std::io;\n\npub struct LocusTuiApp\u003cS: Storage + RelationshipStorage\u003e {\n    integration: LocusIntegration\u003cS\u003e,\n}\n\nimpl\u003cS: Storage + RelationshipStorage\u003e LocusTuiApp\u003cS\u003e {\n    pub fn new(storage: S) -\u003e Self {\n        let integration = LocusIntegration::new(storage);\n        Self { integration }\n    }\n\n    pub fn run(\u0026mut self) -\u003e io::Result\u003c()\u003e {\n        let stdout = io::stdout();\n        let backend = CrosstermBackend::new(stdout);\n        let mut terminal = Terminal::new(backend)?;\n\n        loop {\n            terminal.draw(|f| self.draw(f))?;\n\n            if self.handle_input()? {\n                break;\n            }\n        }\n\n        Ok(())\n    }\n\n    fn draw(\u0026self, f: \u0026mut ratatui::Frame\u003c'_\u003e) {\n        let chunks = Layout::default()\n            .direction(Direction::Vertical)\n            .constraints([\n                Constraint::Length(3),\n                Constraint::Min(10),\n                Constraint::Length(3),\n            ])\n            .split(f.size());\n\n        let tasks = self.integration.get_tasks(None).unwrap_or_default();\n        let workflows = self.integration.get_workflows().unwrap_or_default();\n\n        let task_count = tasks.len();\n        let workflow_count = workflows.len();\n\n        let title = Paragraph::new(format!(\n            \"Locus TUI - Engram System Interface | Tasks: {} | Workflows: {}\",\n            task_count, workflow_count\n        ))\n        .style(Style::default().fg(Color::Cyan));\n\n        f.render_widget(title, chunks[0]);\n\n        let tasks_list: Vec\u003cListItem\u003e = tasks\n            .iter()\n            .take(10)\n            .map(|task| {\n                let status_str = format!(\"{:?}\", task.status).to_lowercase();\n                ListItem::new(format!(\n                    \"[{}] {} - {} ({})\",\n                    task.id.split_at(8).0,\n                    task.title,\n                    status_str,\n                    task.agent\n                ))\n            })\n            .collect();\n\n        let tasks_widget =\n            List::new(tasks_list).block(Block::default().title(\"Tasks\").borders(Borders::ALL));\n\n        let workflows_list: Vec\u003cListItem\u003e = workflows\n            .iter()\n            .take(5)\n            .map(|workflow| {\n                ListItem::new(format!(\n                    \"[{}] {}\",\n                    workflow.id.split_at(8).0,\n                    workflow.title\n                ))\n            })\n            .collect();\n\n        let workflows_widget = List::new(workflows_list)\n            .block(Block::default().title(\"Workflows\").borders(Borders::ALL));\n\n        let center_chunk = Layout::default()\n            .direction(Direction::Horizontal)\n            .constraints([Constraint::Percentage(60), Constraint::Percentage(40)])\n            .split(chunks[1]);\n\n        f.render_widget(tasks_widget, center_chunk[0]);\n        f.render_widget(workflows_widget, center_chunk[1]);\n\n        let help = Paragraph::new(\"Press 'q' to quit\").style(Style::default().fg(Color::Yellow));\n        f.render_widget(help, chunks[2]);\n    }\n\n    fn handle_input(\u0026self) -\u003e io::Result\u003cbool\u003e {\n        if event::poll(std::time::Duration::from_millis(100))? {\n            if let Event::Key(key) = event::read()? {\n                if key.code == KeyCode::Char('q') {\n                    return Ok(true);\n                }\n            }\n        }\n        Ok(false)\n    }\n}\n","traces":[{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[14906321],"length":1,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[14906961,14906992,14907006,14906598,14906658],"length":1,"stats":{"Line":0}},{"line":29,"address":[14906939,14906783],"length":1,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[14906903],"length":1,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[14907078,14907499,14907574],"length":1,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[14907225],"length":1,"stats":{"Line":0}},{"line":42,"address":[14907245],"length":1,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[14911389],"length":1,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[14909332],"length":1,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[14909621,14909492,14909707],"length":1,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[14910082,14910007,14910818],"length":1,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":61},{"path":["/","home","shift","code","vincents-ai","engram","src","main.rs"],"content":"//! Main entry point for Engram CLI\n\nuse clap::Parser;\nuse engram::{\n    ask::handle_ask_command,\n    cli::{self, handle_relationship_command, handle_validation_command},\n    error::EngramError,\n    migration::Migration,\n    storage::GitRefsStorage,\n};\n\n#[tokio::main]\nasync fn main() {\n    let args: Vec\u003cString\u003e = std::env::args().collect();\n    let json_mode = args.iter().any(|arg| arg == \"--json\");\n\n    if let Err(e) = run().await {\n        if json_mode {\n            let error_msg = serde_json::json!({\n                \"error\": e.to_string()\n            });\n            println!(\"{}\", error_msg);\n        } else {\n            eprintln!(\"Error: {}\", e);\n        }\n        std::process::exit(1);\n    }\n}\n\nasync fn run() -\u003e Result\u003c(), EngramError\u003e {\n    let args = cli::Cli::parse();\n\n    match args.command {\n        cli::Commands::Setup { command } =\u003e handle_setup_command(command)?,\n        cli::Commands::Convert { from, file } =\u003e handle_convert_command(\u0026from, \u0026file)?,\n        cli::Commands::Import { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            cli::handle_import_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Test =\u003e handle_test_command()?,\n        cli::Commands::Task { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_task_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Context { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_context_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Ask { command } =\u003e {\n            handle_ask_command(command).await?;\n        }\n        cli::Commands::Reasoning { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_reasoning_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Knowledge { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_knowledge_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Session { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_session_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Compliance { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_compliance_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Rule { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_rule_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Standard { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_standard_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Adr { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_adr_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Workflow { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_workflow_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Relationship { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_relationship_command(\u0026mut storage, command)?;\n        }\n        cli::Commands::Git { command } =\u003e {\n            engram::cli::git::handle_git_command(match command {\n                engram::cli::git::GitCommands::External(args) =\u003e args,\n            })?;\n        }\n        cli::Commands::Validate { command } =\u003e {\n            let storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_validation_command(command, storage)?;\n        }\n        cli::Commands::Sandbox { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_sandbox_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Escalation { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            handle_escalation_command(command, \u0026mut storage)?;\n        }\n        cli::Commands::Sync { command } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            engram::cli::sync::handle_sync_command(\u0026mut storage, \u0026command)?;\n        }\n        cli::Commands::Next { id, format } =\u003e {\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            engram::cli::next::handle_next_command(\u0026mut storage, id, format)?;\n        }\n        cli::Commands::Info =\u003e {\n            let storage = GitRefsStorage::new(\".\", \"default\")?;\n            cli::info::info(\u0026storage)?;\n        }\n        cli::Commands::Migration =\u003e handle_migration_command()?,\n        cli::Commands::Guide { command } =\u003e handle_help_command(command)?,\n        cli::Commands::Skills { command } =\u003e match command {\n            cli::SkillsCommands::Setup =\u003e {\n                cli::handle_skills_command(cli::SkillsCommands::Setup)?;\n            }\n            cli::SkillsCommands::List { format } =\u003e {\n                cli::list_skills(\u0026format)?;\n            }\n            cli::SkillsCommands::Show { name } =\u003e {\n                cli::show_skill(\u0026name)?;\n            }\n        },\n        cli::Commands::Prompts { command } =\u003e match command {\n            cli::PromptsCommands::List { category, format } =\u003e {\n                cli::list_prompts(category.as_deref(), \u0026format)?;\n            }\n            cli::PromptsCommands::Show { name } =\u003e {\n                cli::show_prompt(\u0026name)?;\n            }\n        },\n        cli::Commands::Schema { command } =\u003e {\n            cli::handle_schema_command(command)?;\n        }\n        cli::Commands::Perkeep { command } =\u003e {\n            use engram::cli::perkeep::{\n                perkeep_backup, perkeep_health, perkeep_list, perkeep_restore,\n            };\n            let mut storage = GitRefsStorage::new(\".\", \"default\")?;\n            match command {\n                cli::PerkeepCommands::Backup {\n                    entity_type,\n                    include_relationships,\n                    description,\n                } =\u003e {\n                    perkeep_backup(\u0026storage, entity_type, include_relationships, description)\n                        .await?;\n                }\n                cli::PerkeepCommands::Restore {\n                    blobref,\n                    agent,\n                    dry_run,\n                } =\u003e {\n                    perkeep_restore(\u0026mut storage, blobref, agent, dry_run).await?;\n                }\n                cli::PerkeepCommands::List { detailed } =\u003e {\n                    perkeep_list(detailed).await?;\n                }\n                cli::PerkeepCommands::Health =\u003e {\n                    perkeep_health().await?;\n                }\n                cli::PerkeepCommands::Config {\n                    server,\n                    auth_token,\n                    save: _,\n                } =\u003e {\n                    println!(\"Perkeep configuration\");\n                    if let Some(server) = server {\n                        println!(\"   Server: {}\", server);\n                    }\n                    if let Some(_auth_token) = auth_token {\n                        println!(\"   Auth token: [REDACTED]\");\n                    }\n                    println!(\"Note: Configuration via environment variables PERKEEP_SERVER and PERKEEP_AUTH_TOKEN\");\n                }\n            }\n        }\n    }\n\n    Ok(())\n}\n\n/// Handle setup commands\nfn handle_setup_command(command: cli::SetupCommands) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::SetupCommands::Workspace =\u003e cli::setup_workspace()?,\n        cli::SetupCommands::Agent {\n            name,\n            agent_type,\n            specialization,\n            email,\n        } =\u003e {\n            cli::setup_agent(\n                \u0026name,\n                \u0026agent_type,\n                specialization.as_deref(),\n                email.as_deref(),\n            )?;\n        }\n        cli::SetupCommands::Skills =\u003e {\n            cli::setup_skills()?;\n        }\n        cli::SetupCommands::Prompts { path } =\u003e {\n            cli::setup_prompts(path.as_deref())?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle convert command\nfn handle_convert_command(from: \u0026str, file: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n    println!(\"Converting from {} file: {}\", from, file);\n    println!(\"Conversion functionality will be implemented in a future version\");\n    Ok(())\n}\n\n/// Handle test command\nfn handle_test_command() -\u003e Result\u003c(), EngramError\u003e {\n    println!(\"Engram Test Suite\");\n    println!(\"==================\");\n\n    // Test basic functionality\n    let workspace_dir = \".engram\";\n    if std::path::Path::new(workspace_dir).exists() {\n        println!(\"‚úÖ Workspace directory exists\");\n    } else {\n        println!(\"‚ùå Workspace directory missing\");\n    }\n\n    let agents_dir = \".engram/agents\";\n    if std::path::Path::new(agents_dir).exists() {\n        println!(\"‚úÖ Agents directory exists\");\n    } else {\n        println!(\"‚ùå Agents directory missing\");\n    }\n\n    println!(\"==================\");\n    println!(\"All tests completed\");\n    Ok(())\n}\n\n/// Handle task commands\nfn handle_task_command\u003cS: engram::storage::Storage + 'static\u003e(\n    command: cli::TaskCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::TaskCommands::Create {\n            title,\n            description,\n            priority,\n            agent,\n            parent,\n            tags,\n            title_stdin,\n            title_file,\n            description_stdin,\n            description_file,\n            json,\n            json_file,\n        } =\u003e {\n            cli::create_task(\n                storage,\n                title,\n                description,\n                \u0026priority,\n                agent,\n                parent,\n                tags,\n                title_stdin,\n                title_file,\n                description_stdin,\n                description_file,\n                json,\n                json_file,\n            )?;\n        }\n        cli::TaskCommands::List {\n            agent,\n            status,\n            limit,\n        } =\u003e {\n            cli::list_tasks(storage, agent.as_deref(), status.as_deref(), limit)?;\n        }\n        cli::TaskCommands::Show { id } =\u003e {\n            cli::show_task(storage, \u0026id)?;\n        }\n        cli::TaskCommands::Update {\n            id,\n            status,\n            outcome,\n        } =\u003e {\n            cli::update_task(storage, \u0026id, \u0026status, outcome.as_deref())?;\n        }\n        cli::TaskCommands::Archive { id, reason } =\u003e {\n            cli::archive_task(storage, \u0026id, reason.as_deref())?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle context commands\nfn handle_context_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::ContextCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::ContextCommands::Create {\n            title,\n            content,\n            source,\n            relevance,\n            source_id,\n            agent,\n            tags,\n            title_stdin,\n            title_file,\n            content_stdin,\n            content_file,\n            json,\n            json_file,\n        } =\u003e {\n            cli::create_context(\n                storage,\n                title,\n                content,\n                source,\n                \u0026relevance,\n                source_id,\n                agent,\n                tags,\n                title_stdin,\n                title_file,\n                content_stdin,\n                content_file,\n                json,\n                json_file,\n            )?;\n        }\n        cli::ContextCommands::List {\n            agent,\n            relevance,\n            limit,\n        } =\u003e {\n            cli::list_contexts(storage, agent.as_deref(), relevance.as_deref(), limit)?;\n        }\n        cli::ContextCommands::Show { id } =\u003e {\n            cli::show_context(storage, \u0026id)?;\n        }\n        cli::ContextCommands::Update { id, content } =\u003e {\n            cli::update_context(storage, \u0026id, \u0026content)?;\n        }\n        cli::ContextCommands::Delete { id } =\u003e {\n            cli::delete_context(storage, \u0026id)?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle reasoning commands\nfn handle_reasoning_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::ReasoningCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::ReasoningCommands::Create {\n            title,\n            task_id,\n            agent,\n            confidence,\n            content,\n            tags,\n            title_stdin,\n            title_file,\n            content_stdin,\n            content_file,\n            json,\n            json_file,\n        } =\u003e {\n            cli::create_reasoning(\n                storage,\n                title,\n                task_id,\n                agent,\n                confidence,\n                content,\n                tags,\n                title_stdin,\n                title_file,\n                content_stdin,\n                content_file,\n                json,\n                json_file,\n            )?;\n        }\n        cli::ReasoningCommands::AddStep {\n            id,\n            description,\n            conclusion,\n            confidence,\n            description_stdin,\n            description_file,\n            conclusion_stdin,\n            conclusion_file,\n        } =\u003e {\n            cli::add_reasoning_step(\n                storage,\n                \u0026id,\n                description,\n                conclusion,\n                confidence,\n                description_stdin,\n                description_file,\n                conclusion_stdin,\n                conclusion_file,\n            )?;\n        }\n        cli::ReasoningCommands::Conclude {\n            id,\n            conclusion,\n            confidence,\n            conclusion_stdin,\n            conclusion_file,\n        } =\u003e {\n            cli::conclude_reasoning(\n                storage,\n                \u0026id,\n                conclusion,\n                confidence,\n                conclusion_stdin,\n                conclusion_file,\n            )?;\n        }\n        cli::ReasoningCommands::List {\n            agent,\n            task_id,\n            limit,\n        } =\u003e {\n            cli::list_reasoning(storage, agent.as_deref(), task_id.as_deref(), limit)?;\n        }\n        cli::ReasoningCommands::Show { id } =\u003e {\n            cli::show_reasoning(storage, \u0026id)?;\n        }\n        cli::ReasoningCommands::Delete { id } =\u003e {\n            cli::delete_reasoning(storage, \u0026id)?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle knowledge commands\nfn handle_knowledge_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::KnowledgeCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::KnowledgeCommands::Create {\n            title,\n            content,\n            knowledge_type,\n            confidence,\n            source,\n            agent,\n            tags,\n            title_stdin,\n            title_file,\n            content_stdin,\n            content_file,\n            json,\n            json_file,\n        } =\u003e {\n            cli::create_knowledge(\n                storage,\n                title,\n                content,\n                knowledge_type,\n                confidence,\n                source,\n                agent,\n                tags,\n                title_stdin,\n                title_file,\n                content_stdin,\n                content_file,\n                json,\n                json_file,\n            )?;\n        }\n        cli::KnowledgeCommands::List { agent, kind, limit } =\u003e {\n            cli::list_knowledge(storage, agent, kind, limit)?;\n        }\n        cli::KnowledgeCommands::Show { id } =\u003e {\n            cli::show_knowledge(storage, \u0026id)?;\n        }\n        cli::KnowledgeCommands::Update { id, field, value } =\u003e {\n            cli::update_knowledge(storage, \u0026id, \u0026field, \u0026value)?;\n        }\n        cli::KnowledgeCommands::Delete { id } =\u003e {\n            cli::delete_knowledge(storage, \u0026id)?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle session commands\nfn handle_session_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::SessionCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    use engram::cli::session::*;\n\n    match command {\n        engram::cli::SessionCommands::Start { name, auto_detect } =\u003e {\n            start_session(storage, name, auto_detect)?;\n        }\n        engram::cli::SessionCommands::Status { id, metrics } =\u003e {\n            show_session_status(storage, id, metrics)?;\n        }\n        engram::cli::SessionCommands::End {\n            id,\n            generate_summary,\n        } =\u003e {\n            end_session(storage, id, generate_summary)?;\n        }\n        engram::cli::SessionCommands::List { agent, limit } =\u003e {\n            list_sessions(storage, agent, limit)?;\n        }\n    }\n\n    Ok(())\n}\n\n/// Handle compliance commands\nfn handle_compliance_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::ComplianceCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::ComplianceCommands::Create {\n            title,\n            description,\n            category,\n            severity: _,\n            agent,\n        } =\u003e {\n            cli::create_compliance(storage, title, description, category, agent)?;\n        }\n        cli::ComplianceCommands::List {\n            agent,\n            category,\n            limit,\n        } =\u003e {\n            cli::list_compliance(storage, agent.as_deref(), category.as_deref(), limit)?;\n        }\n        cli::ComplianceCommands::Show { id } =\u003e {\n            cli::show_compliance(storage, \u0026id)?;\n        }\n        cli::ComplianceCommands::Update { id, field, value } =\u003e {\n            cli::update_compliance(storage, \u0026id, \u0026field, \u0026value)?;\n        }\n        cli::ComplianceCommands::Delete { id } =\u003e {\n            cli::delete_compliance(storage, \u0026id)?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle rule commands\nfn handle_rule_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::RuleCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::RuleCommands::Create {\n            title,\n            description,\n            rule_type,\n            priority,\n            entity_types,\n            condition,\n            action,\n            agent,\n        } =\u003e {\n            cli::create_rule(\n                storage,\n                title,\n                description,\n                rule_type,\n                priority,\n                entity_types,\n                condition,\n                action,\n                agent,\n            )?;\n        }\n        cli::RuleCommands::Get { id } =\u003e {\n            cli::get_rule(storage, \u0026id)?;\n        }\n        cli::RuleCommands::Update {\n            id,\n            title,\n            description,\n            rule_type,\n            priority,\n            entity_types,\n            condition,\n            action,\n            status,\n        } =\u003e {\n            cli::update_rule(\n                storage,\n                \u0026id,\n                title,\n                description,\n                rule_type,\n                priority,\n                entity_types,\n                condition,\n                action,\n                status,\n            )?;\n        }\n        cli::RuleCommands::Delete { id } =\u003e {\n            cli::delete_rule(storage, \u0026id)?;\n        }\n        cli::RuleCommands::List {\n            rule_type,\n            priority,\n            entity_type,\n            status,\n            search,\n            limit,\n            offset,\n        } =\u003e {\n            cli::list_rules(\n                storage,\n                rule_type,\n                priority,\n                entity_type,\n                status,\n                search,\n                limit,\n                offset,\n            )?;\n        }\n        cli::RuleCommands::Execute {\n            id,\n            entity_id,\n            entity_type,\n        } =\u003e {\n            cli::execute_rule(storage, \u0026id, entity_id, entity_type)?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle standard commands\nfn handle_standard_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::StandardCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::StandardCommands::Create {\n            title,\n            description,\n            category,\n            version,\n            effective_date,\n            agent,\n        } =\u003e {\n            cli::create_standard(\n                storage,\n                title,\n                description,\n                category,\n                version,\n                effective_date,\n                agent,\n            )?;\n        }\n        cli::StandardCommands::Get { id } =\u003e {\n            cli::get_standard(storage, \u0026id)?;\n        }\n        cli::StandardCommands::Update {\n            id,\n            title,\n            description,\n            category,\n            version,\n            status,\n            effective_date,\n            superseded_by,\n        } =\u003e {\n            cli::update_standard(\n                storage,\n                \u0026id,\n                title,\n                description,\n                category,\n                version,\n                status,\n                effective_date,\n                superseded_by,\n            )?;\n        }\n        cli::StandardCommands::Delete { id } =\u003e {\n            cli::delete_standard(storage, \u0026id)?;\n        }\n        cli::StandardCommands::List {\n            category,\n            status,\n            search,\n            limit,\n            offset,\n        } =\u003e {\n            cli::list_standards(storage, category, status, search, limit, offset)?;\n        }\n        cli::StandardCommands::AddRequirement {\n            id,\n            title,\n            description,\n            mandatory,\n            priority,\n            evidence_required,\n        } =\u003e {\n            cli::add_requirement(\n                storage,\n                \u0026id,\n                title,\n                description,\n                mandatory,\n                priority,\n                evidence_required,\n            )?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle ADR commands\nfn handle_adr_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::AdrCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::AdrCommands::Create {\n            title,\n            number,\n            context,\n            agent,\n        } =\u003e {\n            cli::create_adr(storage, title, number, context, agent)?;\n        }\n        cli::AdrCommands::Get { id } =\u003e {\n            cli::get_adr(storage, \u0026id)?;\n        }\n        cli::AdrCommands::Update {\n            id,\n            title,\n            status,\n            context,\n            decision,\n            consequences,\n            implementation,\n            superseded_by,\n        } =\u003e {\n            cli::update_adr(\n                storage,\n                \u0026id,\n                title,\n                status,\n                context,\n                decision,\n                consequences,\n                implementation,\n                superseded_by,\n            )?;\n        }\n        cli::AdrCommands::Delete { id } =\u003e {\n            cli::delete_adr(storage, \u0026id)?;\n        }\n        cli::AdrCommands::List {\n            status,\n            search,\n            limit,\n            offset,\n        } =\u003e {\n            cli::list_adrs(storage, status, search, limit, offset)?;\n        }\n        cli::AdrCommands::Accept {\n            id,\n            decision,\n            consequences,\n        } =\u003e {\n            cli::accept_adr(storage, \u0026id, decision, consequences)?;\n        }\n        cli::AdrCommands::AddAlternative { id, description } =\u003e {\n            cli::add_alternative(storage, \u0026id, description)?;\n        }\n        cli::AdrCommands::AddStakeholder { id, stakeholder } =\u003e {\n            cli::add_stakeholder(storage, \u0026id, stakeholder)?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle workflow commands\nfn handle_workflow_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::WorkflowCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        cli::WorkflowCommands::Create {\n            title,\n            description,\n            entity_types,\n            agent,\n        } =\u003e {\n            cli::create_workflow(storage, title, description, entity_types, agent)?;\n        }\n        cli::WorkflowCommands::Get { id } =\u003e {\n            cli::get_workflow(storage, \u0026id)?;\n        }\n        cli::WorkflowCommands::Update {\n            id,\n            title,\n            description,\n            status,\n            entity_types,\n            initial_state,\n        } =\u003e {\n            cli::update_workflow(\n                storage,\n                \u0026id,\n                title,\n                description,\n                status,\n                entity_types,\n                initial_state,\n            )?;\n        }\n        cli::WorkflowCommands::Delete { id } =\u003e {\n            cli::delete_workflow(storage, \u0026id)?;\n        }\n        cli::WorkflowCommands::List {\n            status,\n            search,\n            limit,\n            offset,\n        } =\u003e {\n            cli::list_workflows(storage, status, search, limit, offset)?;\n        }\n        cli::WorkflowCommands::AddState {\n            id,\n            name,\n            state_type,\n            description,\n            is_final,\n        } =\u003e {\n            cli::add_state(storage, \u0026id, name, state_type, description, is_final)?;\n        }\n        cli::WorkflowCommands::AddTransition {\n            id,\n            name,\n            from_state,\n            to_state,\n            transition_type,\n            description,\n        } =\u003e {\n            cli::add_transition(\n                storage,\n                \u0026id,\n                name,\n                from_state,\n                to_state,\n                transition_type,\n                description,\n            )?;\n        }\n        cli::WorkflowCommands::Activate { id } =\u003e {\n            cli::activate_workflow(storage, \u0026id)?;\n        }\n        cli::WorkflowCommands::Start {\n            workflow_id,\n            entity_id,\n            entity_type,\n            agent,\n            variables,\n        } =\u003e {\n            let storage_for_workflow = GitRefsStorage::new(\".\", \"default\")?;\n            cli::start_workflow_instance(\n                storage_for_workflow,\n                workflow_id,\n                entity_id,\n                entity_type,\n                agent,\n                variables,\n            )?;\n        }\n        cli::WorkflowCommands::Transition {\n            instance_id,\n            transition,\n            agent,\n        } =\u003e {\n            let storage_for_workflow = GitRefsStorage::new(\".\", \"default\")?;\n            cli::execute_workflow_transition(storage_for_workflow, instance_id, transition, agent)?;\n        }\n        cli::WorkflowCommands::Status { instance_id } =\u003e {\n            let storage_for_workflow = GitRefsStorage::new(\".\", \"default\")?;\n            cli::get_workflow_instance_status(storage_for_workflow, instance_id)?;\n        }\n        cli::WorkflowCommands::Instances {\n            workflow_id,\n            agent,\n            running_only,\n        } =\u003e {\n            let storage_for_workflow = GitRefsStorage::new(\".\", \"default\")?;\n            cli::list_workflow_instances(storage_for_workflow, workflow_id, agent, running_only)?;\n        }\n        cli::WorkflowCommands::Cancel {\n            instance_id,\n            agent,\n            reason,\n        } =\u003e {\n            let storage_for_workflow = GitRefsStorage::new(\".\", \"default\")?;\n            cli::cancel_workflow_instance(storage_for_workflow, instance_id, agent, reason)?;\n        }\n        cli::WorkflowCommands::ExecuteAction {\n            action_type,\n            command,\n            args,\n            working_directory,\n            environment,\n            timeout_seconds,\n            message,\n            entity_id,\n            entity_type,\n        } =\u003e {\n            let storage_for_workflow = GitRefsStorage::new(\".\", \"default\")?;\n            cli::execute_action(\n                storage_for_workflow,\n                action_type,\n                command,\n                args,\n                working_directory,\n                environment,\n                timeout_seconds,\n                message,\n                entity_id,\n                entity_type,\n            )?;\n        }\n        cli::WorkflowCommands::QueryActions {\n            workflow_id,\n            state_id,\n        } =\u003e {\n            cli::query_workflow_actions(storage, workflow_id, state_id)?;\n        }\n    }\n    Ok(())\n}\n\n/// Handle migration command\nfn handle_migration_command() -\u003e Result\u003c(), EngramError\u003e {\n    let args: Vec\u003cString\u003e = std::env::args().collect();\n    let dry_run = args.contains(\u0026String::from(\"--dry-run\"));\n    let backup_only = args.contains(\u0026String::from(\"--backup-only\"));\n\n    if backup_only {\n        println!(\"üì¶ Creating backup of .engram directory...\");\n        let migration = Migration::new(\".\", \"default\", true, backup_only)?;\n        migration.create_backup()?;\n        println!(\"‚úÖ Backup completed successfully\");\n        return Ok(());\n    }\n\n    let mut migration = Migration::new(\".\", \"default\", dry_run, false)?;\n\n    // Pre-flight validation\n    if let Err(e) = Migration::validate_migration_readiness(\".\") {\n        eprintln!(\"‚ùå Migration pre-check failed: {}\", e);\n        return Err(e);\n    }\n\n    println!(\"üöÄ Starting migration from dual-repository to Git refs storage\");\n    if dry_run {\n        println!(\"üìù DRY RUN: No changes will be made\");\n    } else {\n        println!(\"üîÑ MIGRATION: Converting data to Git refs storage\");\n    }\n\n    match migration.execute() {\n        Ok(stats) =\u003e {\n            println!(\"\\nüèÅ Migration Summary:\");\n            println!(\"  üìä Total processed: {}\", stats.entities_processed);\n            println!(\"  ‚úÖ Successfully migrated: {}\", stats.entities_migrated);\n            if stats.entities_failed \u003e 0 {\n                println!(\"  ‚ùå Failed: {}\", stats.entities_failed);\n            }\n            if !dry_run \u0026\u0026 stats.entities_migrated \u003e 0 {\n                println!(\"\\nüíæ Backup created at: .engram_backup_\u003ctimestamp\u003e\");\n            }\n            println!(\"\\n‚úÖ Migration completed successfully!\");\n        }\n        Err(e) =\u003e {\n            eprintln!(\"‚ùå Migration failed: {}\", e);\n        }\n    }\n\n    Ok(())\n}\n\n/// Handle sandbox commands\nfn handle_sandbox_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::SandboxCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    use engram::cli::sandbox::*;\n\n    match command {\n        engram::cli::SandboxCommands::Create {\n            agent,\n            level,\n            created_by,\n            stdin,\n            file,\n            json,\n        } =\u003e {\n            create_sandbox(storage, agent, level, created_by, stdin, file, json)?;\n        }\n        engram::cli::SandboxCommands::List {\n            agent_id,\n            level,\n            agent,\n            json,\n        } =\u003e {\n            list_sandboxes(storage, agent_id, level, agent, json)?;\n        }\n        engram::cli::SandboxCommands::Get { id, json } =\u003e {\n            get_sandbox(storage, id, json)?;\n        }\n        engram::cli::SandboxCommands::Update {\n            id,\n            level,\n            stdin,\n            file,\n            json,\n        } =\u003e {\n            update_sandbox(storage, id, level, stdin, file, json)?;\n        }\n        engram::cli::SandboxCommands::Delete { id, force } =\u003e {\n            delete_sandbox(storage, id, force)?;\n        }\n        engram::cli::SandboxCommands::Validate {\n            agent_id,\n            operation,\n            resource_type,\n            stdin,\n            file,\n            json,\n        } =\u003e {\n            validate_operation(\n                storage,\n                agent_id,\n                operation,\n                resource_type,\n                stdin,\n                file,\n                json,\n            )?;\n        }\n        engram::cli::SandboxCommands::Stats { agent_id, json } =\u003e {\n            show_stats(storage, agent_id, json)?;\n        }\n        engram::cli::SandboxCommands::Reset {\n            agent_id,\n            force,\n            json,\n        } =\u003e {\n            reset_sandbox(storage, agent_id, force, json)?;\n        }\n    }\n\n    Ok(())\n}\n\n/// Handle escalation commands\nfn handle_escalation_command\u003cS: engram::storage::Storage\u003e(\n    command: engram::cli::EscalationCommands,\n    storage: \u0026mut S,\n) -\u003e Result\u003c(), EngramError\u003e {\n    use engram::cli::escalation::*;\n\n    match command {\n        engram::cli::EscalationCommands::Create {\n            agent,\n            operation_type,\n            operation,\n            block_reason,\n            justification,\n            priority,\n            impact,\n            reviewer,\n            stdin,\n            file,\n            json,\n        } =\u003e {\n            create_escalation(\n                storage,\n                agent,\n                operation_type,\n                operation,\n                block_reason,\n                justification,\n                priority,\n                impact,\n                reviewer,\n                stdin,\n                file,\n                json,\n            )?;\n        }\n        engram::cli::EscalationCommands::List {\n            agent_id,\n            status,\n            priority,\n            operation_type,\n            expired_only,\n            actionable_only,\n            agent,\n            json,\n        } =\u003e {\n            list_escalations(\n                storage,\n                agent_id,\n                status,\n                priority,\n                operation_type,\n                expired_only,\n                actionable_only,\n                agent,\n                json,\n            )?;\n        }\n        engram::cli::EscalationCommands::Get { id, json } =\u003e {\n            get_escalation(storage, id, json)?;\n        }\n        engram::cli::EscalationCommands::Review {\n            id,\n            status,\n            reason,\n            reviewer_id,\n            reviewer_name,\n            duration,\n            create_policy,\n            notes,\n            stdin,\n            file,\n            json,\n        } =\u003e {\n            review_escalation(\n                storage,\n                id,\n                status,\n                reason,\n                reviewer_id,\n                reviewer_name,\n                duration,\n                create_policy,\n                notes,\n                stdin,\n                file,\n                json,\n            )?;\n        }\n        engram::cli::EscalationCommands::Cancel {\n            id,\n            reason,\n            force,\n            json,\n        } =\u003e {\n            cancel_escalation(storage, id, reason, force, json)?;\n        }\n        engram::cli::EscalationCommands::Cleanup { apply, json } =\u003e {\n            cleanup_escalations(storage, apply, json)?;\n        }\n        engram::cli::EscalationCommands::Stats {\n            agent_id,\n            days,\n            json,\n        } =\u003e {\n            show_escalation_stats(storage, agent_id, days, json)?;\n        }\n    }\n\n    Ok(())\n}\n/// Handle help command\nfn handle_help_command(command: Option\u003ccli::HelpCommands\u003e) -\u003e Result\u003c(), EngramError\u003e {\n    match command {\n        Some(cli::HelpCommands::Onboarding) =\u003e {\n            println!(\"ENGRAM - Task Memory System for LLM Coding Agents\");\n            println!(\"==================================================\");\n            println!();\n            println!(\n                \"PURPOSE: Maintains project state, tasks, and reasoning across coding sessions.\"\n            );\n            println!(\"Enforces disciplined development via Git commit validation requiring task references.\");\n            println!();\n            println!(\"CORE WORKFLOW:\");\n            println!(\"1. engram setup workspace              # Initialize project\");\n            println!(\n                \"2. engram task create --title \\\"...\\\"    # Create work items (returns UUIDs)\"\n            );\n            println!(\"3. engram context create --title \\\"...\\\" # Add background info\");\n            println!(\"4. engram reasoning create --task-id \u003cuuid\u003e # Document decisions\");\n            println!(\n                \"5. engram relationship create ...       # Link entities (REQUIRED for validation)\"\n            );\n            println!(\"6. engram validate hook install        # Enable Git integration\");\n            println!();\n            println!(\"ESSENTIAL COMMANDS:\");\n            println!(\n                \"  task        Create/manage work items (returns UUIDs for commit references)\"\n            );\n            println!(\"  context     Background information and documentation\");\n            println!(\"  reasoning   Decision chains and rationale\");\n            println!(\"  relationship Link entities (required: task‚Üîreasoning, task‚Üîcontext)\");\n            println!(\"  validate    Git commit validation and hooks\");\n            println!();\n            println!(\n                \"JSON I/O: Most commands support --json input/output for programmatic access.\"\n            );\n            println!(\"Git Integration: Commits must reference task UUIDs: \\\"feat: implement auth [\u003cuuid\u003e]\\\"\");\n            println!();\n            println!(\"Use 'engram guide examples' for working command examples.\");\n        }\n        Some(cli::HelpCommands::GettingStarted) =\u003e {\n            println!(\"ENGRAM Quick Start for LLM Agents\");\n            println!(\"=================================\");\n            println!();\n            println!(\"STEP 1: Initialize workspace\");\n            println!(\"  engram setup workspace\");\n            println!();\n            println!(\"STEP 2: Create your first task\");\n            println!(\"  engram task create --title \\\"Implement user authentication\\\"\");\n            println!(\"  # Returns UUID like: a1b2c3d4-e5f6-7890-abcd-ef1234567890\");\n            println!();\n            println!(\"STEP 3: Add supporting entities\");\n            println!(\"  engram context create --title \\\"Auth requirements\\\" --source \\\"requirements.md\\\"\");\n            println!(\"  engram reasoning create --task-id \u003cTASK_UUID\u003e --title \\\"JWT vs Session approach\\\"\");\n            println!();\n            println!(\"STEP 4: Create required relationships\");\n            println!(\"  engram relationship create \\\\\");\n            println!(\"    --source-id \u003cTASK_UUID\u003e --source-type task \\\\\");\n            println!(\"    --target-id \u003cCONTEXT_UUID\u003e --target-type context \\\\\");\n            println!(\"    --relationship-type references --agent default\");\n            println!();\n            println!(\"STEP 5: Enable Git validation\");\n            println!(\"  engram validate hook install\");\n            println!();\n            println!(\"STEP 6: Make commits with task references\");\n            println!(\"  git commit -m \\\"feat: add login endpoint [\u003cTASK_UUID\u003e]\\\"\");\n            println!();\n            println!(\"For examples with real UUIDs: engram guide examples\");\n        }\n        Some(cli::HelpCommands::Examples) =\u003e {\n            println!(\"ENGRAM Command Examples for LLM Agents\");\n            println!(\"======================================\");\n            println!();\n            println!(\"# 1. SETUP WORKFLOW\");\n            println!(\"engram setup workspace\");\n            println!();\n            println!(\"# 2. CREATE ENTITIES\");\n            println!(\"# Create task (save UUID for later steps)\");\n            println!(\n                \"TASK_ID=$(engram task create --title \\\"Add OAuth support\\\" --json | jq -r '.id')\"\n            );\n            println!();\n            println!(\"# Create context\");\n            println!(\"CTX_ID=$(engram context create --title \\\"OAuth 2.0 specification\\\" --source \\\"RFC 6749\\\" --json | jq -r '.id')\");\n            println!();\n            println!(\"# Create reasoning\");\n            println!(\"REASON_ID=$(engram reasoning create --task-id $TASK_ID --title \\\"Why OAuth over custom auth\\\" --json | jq -r '.id')\");\n            println!();\n            println!(\"# 3. CREATE RELATIONSHIPS (REQUIRED FOR VALIDATION)\");\n            println!(\"engram relationship create \\\\\");\n            println!(\"  --source-id $TASK_ID --source-type task \\\\\");\n            println!(\"  --target-id $CTX_ID --target-type context \\\\\");\n            println!(\"  --relationship-type references --agent default\");\n            println!();\n            println!(\"engram relationship create \\\\\");\n            println!(\"  --source-id $TASK_ID --source-type task \\\\\");\n            println!(\"  --target-id $REASON_ID --target-type reasoning \\\\\");\n            println!(\"  --relationship-type references --agent default\");\n            println!();\n            println!(\"# 4. VALIDATION SETUP\");\n            println!(\"engram validate hook install\");\n            println!(\"engram validate commit --message \\\"feat: add OAuth endpoint [$TASK_ID]\\\" --dry-run\");\n            println!();\n            println!(\"# 5. JSON PROGRAMMATIC ACCESS\");\n            println!(\"# List all tasks as JSON\");\n            println!(\"engram task list --agent default | jq '.[].id'\");\n            println!();\n            println!(\"# Create task from JSON input\");\n            println!(\"echo '{{\\\"title\\\": \\\"Database migration\\\", \\\"priority\\\": \\\"high\\\"}}' | engram task create --json\");\n            println!();\n            println!(\"# 6. RELATIONSHIP QUERIES\");\n            println!(\"# Find all entities connected to a task\");\n            println!(\n                \"engram relationship connected --entity-id $TASK_ID --relationship-type references\"\n            );\n            println!();\n            println!(\"# Find path between entities\");\n            println!(\"engram relationship find-path --source-id $TASK_ID --target-id $CTX_ID\");\n            println!();\n            println!(\"# 7. VALIDATION WORKFLOW\");\n            println!(\"# Test commit validation\");\n            println!(\n                \"engram validate commit --message \\\"feat: implement OAuth [$TASK_ID]\\\" --dry-run\"\n            );\n            println!();\n            println!(\"# Check validation setup\");\n            println!(\"engram validate hook status\");\n            println!();\n            println!(\"For more details: engram \u003ccommand\u003e --help\");\n        }\n        None =\u003e {\n            println!(\"ENGRAM Guide - Task Memory System for LLM Coding Agents\");\n            println!(\"==========================================================\");\n            println!();\n            println!(\"Available guide sections:\");\n            println!(\"  getting-started  Step-by-step setup and first tasks\");\n            println!(\"  examples         Complete command examples with real workflows\");\n            println!(\"  onboarding       Overview and core concepts\");\n            println!();\n            println!(\"Usage:\");\n            println!(\"  engram guide getting-started   # Quick start tutorial\");\n            println!(\"  engram guide examples          # Copy-paste examples\");\n            println!(\"  engram guide onboarding        # Detailed overview\");\n            println!();\n            println!(\"For specific command help:\");\n            println!(\"  engram \u003ccommand\u003e --help        # Help for individual commands\");\n            println!(\"  engram --help                  # Show all available commands\");\n        }\n    }\n\n    Ok(())\n}\n","traces":[{"line":13,"address":[14639207,14638816,14639213],"length":1,"stats":{"Line":0}},{"line":14,"address":[14626812,14626930],"length":1,"stats":{"Line":0}},{"line":15,"address":[14626942,14628544,14627011,14628558],"length":1,"stats":{"Line":0}},{"line":17,"address":[14782647],"length":1,"stats":{"Line":0}},{"line":18,"address":[14627547],"length":1,"stats":{"Line":0}},{"line":19,"address":[14628440,14627802,14627764,14627872,14627943,14627620],"length":1,"stats":{"Line":0}},{"line":20,"address":[14627845],"length":1,"stats":{"Line":0}},{"line":22,"address":[14628347,14628276],"length":1,"stats":{"Line":0}},{"line":24,"address":[14627585,14627674],"length":1,"stats":{"Line":0}},{"line":26,"address":[14627745],"length":1,"stats":{"Line":0}},{"line":30,"address":[14600977,14600998,14600956,14600913,14601019,14601048,14600496,14604326,14623829,14600648],"length":1,"stats":{"Line":0}},{"line":31,"address":[14600697],"length":1,"stats":{"Line":0}},{"line":33,"address":[14601098],"length":1,"stats":{"Line":0}},{"line":34,"address":[14601179,14603697,14603850],"length":1,"stats":{"Line":0}},{"line":35,"address":[14601285,14603909],"length":1,"stats":{"Line":0}},{"line":36,"address":[14601375],"length":1,"stats":{"Line":0}},{"line":37,"address":[14605061,14601407,14604373],"length":1,"stats":{"Line":0}},{"line":38,"address":[14604861,14604746],"length":1,"stats":{"Line":0}},{"line":40,"address":[14605296,14601556],"length":1,"stats":{"Line":0}},{"line":41,"address":[14601574],"length":1,"stats":{"Line":0}},{"line":42,"address":[14601608,14605484,14606178],"length":1,"stats":{"Line":0}},{"line":43,"address":[14605978,14605857],"length":1,"stats":{"Line":0}},{"line":45,"address":[14601663],"length":1,"stats":{"Line":0}},{"line":46,"address":[14606307,14601693,14607001],"length":1,"stats":{"Line":0}},{"line":47,"address":[14606680,14606801],"length":1,"stats":{"Line":0}},{"line":49,"address":[14601748],"length":1,"stats":{"Line":0}},{"line":50,"address":[14624223,14600943,14607105,14623863,14601796],"length":1,"stats":{"Line":0}},{"line":52,"address":[14601834],"length":1,"stats":{"Line":0}},{"line":53,"address":[14607913,14601868,14607219],"length":1,"stats":{"Line":0}},{"line":54,"address":[14607592,14607713],"length":1,"stats":{"Line":0}},{"line":56,"address":[14601923],"length":1,"stats":{"Line":0}},{"line":57,"address":[14601957,14608042,14608736],"length":1,"stats":{"Line":0}},{"line":58,"address":[14608415,14608536],"length":1,"stats":{"Line":0}},{"line":60,"address":[14602012],"length":1,"stats":{"Line":0}},{"line":61,"address":[14602056,14608865,14609569],"length":1,"stats":{"Line":0}},{"line":62,"address":[14609238,14609369],"length":1,"stats":{"Line":0}},{"line":64,"address":[14602111],"length":1,"stats":{"Line":0}},{"line":65,"address":[14610482,14602215,14609698],"length":1,"stats":{"Line":0}},{"line":66,"address":[14610071,14610282],"length":1,"stats":{"Line":0}},{"line":68,"address":[14602270],"length":1,"stats":{"Line":0}},{"line":69,"address":[14602304,14610611,14611305],"length":1,"stats":{"Line":0}},{"line":70,"address":[14611105,14610984],"length":1,"stats":{"Line":0}},{"line":72,"address":[14602359],"length":1,"stats":{"Line":0}},{"line":73,"address":[14612128,14611434,14602393],"length":1,"stats":{"Line":0}},{"line":74,"address":[14611928,14611807],"length":1,"stats":{"Line":0}},{"line":76,"address":[14602448],"length":1,"stats":{"Line":0}},{"line":77,"address":[14612257,14602482,14612951],"length":1,"stats":{"Line":0}},{"line":78,"address":[14612630,14612751],"length":1,"stats":{"Line":0}},{"line":80,"address":[14602537],"length":1,"stats":{"Line":0}},{"line":81,"address":[14602571,14613080,14613774],"length":1,"stats":{"Line":0}},{"line":82,"address":[14613453,14613574],"length":1,"stats":{"Line":0}},{"line":84,"address":[14602626],"length":1,"stats":{"Line":0}},{"line":85,"address":[14614597,14602660,14613903],"length":1,"stats":{"Line":0}},{"line":86,"address":[14614397,14614276],"length":1,"stats":{"Line":0}},{"line":88,"address":[14601462],"length":1,"stats":{"Line":0}},{"line":89,"address":[14605149,14605291,14601518,14605252],"length":1,"stats":{"Line":0}},{"line":90,"address":[14601486],"length":1,"stats":{"Line":0}},{"line":93,"address":[14602715],"length":1,"stats":{"Line":0}},{"line":94,"address":[14602747,14614734,14615549],"length":1,"stats":{"Line":0}},{"line":95,"address":[14615505,14615347,14615115],"length":1,"stats":{"Line":0}},{"line":97,"address":[14602802],"length":1,"stats":{"Line":0}},{"line":98,"address":[14602894,14616446,14615678],"length":1,"stats":{"Line":0}},{"line":99,"address":[14616051,14616246],"length":1,"stats":{"Line":0}},{"line":101,"address":[14602949],"length":1,"stats":{"Line":0}},{"line":102,"address":[14602983,14616575,14617269],"length":1,"stats":{"Line":0}},{"line":103,"address":[14617069,14616948],"length":1,"stats":{"Line":0}},{"line":105,"address":[14603038],"length":1,"stats":{"Line":0}},{"line":106,"address":[14617401,14618068,14603064],"length":1,"stats":{"Line":0}},{"line":107,"address":[14617798,14617849],"length":1,"stats":{"Line":0}},{"line":109,"address":[14603119],"length":1,"stats":{"Line":0}},{"line":110,"address":[14618855,14618111,14603183],"length":1,"stats":{"Line":0}},{"line":111,"address":[14618484,14618647],"length":1,"stats":{"Line":0}},{"line":114,"address":[14619664,14603230,14619043],"length":1,"stats":{"Line":0}},{"line":115,"address":[14619432,14619483],"length":1,"stats":{"Line":0}},{"line":117,"address":[14603285,14619669],"length":1,"stats":{"Line":0}},{"line":118,"address":[14603444,14622022],"length":1,"stats":{"Line":0}},{"line":119,"address":[14603483],"length":1,"stats":{"Line":0}},{"line":120,"address":[14622480],"length":1,"stats":{"Line":0}},{"line":121,"address":[14622169,14622343,14622485],"length":1,"stats":{"Line":0}},{"line":123,"address":[14622211],"length":1,"stats":{"Line":0}},{"line":124,"address":[14622251,14622550],"length":1,"stats":{"Line":0}},{"line":126,"address":[14622277],"length":1,"stats":{"Line":0}},{"line":127,"address":[14622317,14622783],"length":1,"stats":{"Line":0}},{"line":130,"address":[14603567],"length":1,"stats":{"Line":0}},{"line":131,"address":[14623010],"length":1,"stats":{"Line":0}},{"line":132,"address":[14623074,14623175],"length":1,"stats":{"Line":0}},{"line":134,"address":[14622950],"length":1,"stats":{"Line":0}},{"line":135,"address":[14623515,14622990],"length":1,"stats":{"Line":0}},{"line":138,"address":[14603643],"length":1,"stats":{"Line":0}},{"line":139,"address":[14623824,14603667,14623682],"length":1,"stats":{"Line":0}},{"line":141,"address":[14603303],"length":1,"stats":{"Line":0}},{"line":145,"address":[14603389,14621943,14619915],"length":1,"stats":{"Line":0}},{"line":146,"address":[14620289],"length":1,"stats":{"Line":0}},{"line":147,"address":[14620373],"length":1,"stats":{"Line":0}},{"line":152,"address":[14624592,14624388,14620426,14620886,14624450,14624553],"length":1,"stats":{"Line":0}},{"line":153,"address":[14624436,14620871,14624505,14600964,14624236,14620919],"length":1,"stats":{"Line":0}},{"line":155,"address":[14620475],"length":1,"stats":{"Line":0}},{"line":160,"address":[14781478],"length":1,"stats":{"Line":0}},{"line":162,"address":[14620616],"length":1,"stats":{"Line":0}},{"line":163,"address":[14781500],"length":1,"stats":{"Line":0}},{"line":165,"address":[14625728],"length":1,"stats":{"Line":0}},{"line":166,"address":[14620655,14621138,14625373,14601027,14625788],"length":1,"stats":{"Line":0}},{"line":168,"address":[14620730],"length":1,"stats":{"Line":0}},{"line":173,"address":[14620775,14621277],"length":1,"stats":{"Line":0}},{"line":174,"address":[14621296],"length":1,"stats":{"Line":0}},{"line":175,"address":[14621498,14621381],"length":1,"stats":{"Line":0}},{"line":177,"address":[14621408,14621589],"length":1,"stats":{"Line":0}},{"line":178,"address":[14621725,14621629],"length":1,"stats":{"Line":0}},{"line":180,"address":[14621655,14621763],"length":1,"stats":{"Line":0}},{"line":186,"address":[14603836],"length":1,"stats":{"Line":0}},{"line":190,"address":[14635164,14633952],"length":1,"stats":{"Line":0}},{"line":191,"address":[14633983],"length":1,"stats":{"Line":0}},{"line":192,"address":[14634048,14634395],"length":1,"stats":{"Line":0}},{"line":193,"address":[14634200],"length":1,"stats":{"Line":0}},{"line":200,"address":[14634232],"length":1,"stats":{"Line":0}},{"line":201,"address":[14634561],"length":1,"stats":{"Line":0}},{"line":202,"address":[14634598],"length":1,"stats":{"Line":0}},{"line":203,"address":[14634647],"length":1,"stats":{"Line":0}},{"line":207,"address":[14634258,14635183],"length":1,"stats":{"Line":0}},{"line":209,"address":[14634336],"length":1,"stats":{"Line":0}},{"line":210,"address":[14634360,14635297],"length":1,"stats":{"Line":0}},{"line":213,"address":[14634460],"length":1,"stats":{"Line":0}},{"line":217,"address":[14635504],"length":1,"stats":{"Line":0}},{"line":218,"address":[14635541],"length":1,"stats":{"Line":0}},{"line":219,"address":[14635694],"length":1,"stats":{"Line":0}},{"line":220,"address":[14635739],"length":1,"stats":{"Line":0}},{"line":224,"address":[14633520],"length":1,"stats":{"Line":0}},{"line":225,"address":[14633591],"length":1,"stats":{"Line":0}},{"line":226,"address":[14633620],"length":1,"stats":{"Line":0}},{"line":229,"address":[14633537],"length":1,"stats":{"Line":0}},{"line":230,"address":[14633649],"length":1,"stats":{"Line":0}},{"line":231,"address":[14633719],"length":1,"stats":{"Line":0}},{"line":233,"address":[14633682],"length":1,"stats":{"Line":0}},{"line":236,"address":[14633564],"length":1,"stats":{"Line":0}},{"line":237,"address":[14633748],"length":1,"stats":{"Line":0}},{"line":238,"address":[14633818],"length":1,"stats":{"Line":0}},{"line":240,"address":[14633781],"length":1,"stats":{"Line":0}},{"line":243,"address":[14633853],"length":1,"stats":{"Line":0}},{"line":244,"address":[14633888],"length":1,"stats":{"Line":0}},{"line":245,"address":[14633933],"length":1,"stats":{"Line":0}},{"line":249,"address":[14562662,14560752,14562883],"length":1,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[14561066],"length":1,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[14561363],"length":1,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[14561920],"length":1,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[14562000],"length":1,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[14561485,14562972],"length":1,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[14561563,14563421],"length":1,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[14561677,14563687],"length":1,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[14561767,14564249],"length":1,"stats":{"Line":0}},{"line":305,"address":[14562541],"length":1,"stats":{"Line":0}},{"line":309,"address":[14566561,14566816,14564592],"length":1,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[14564779],"length":1,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[14565281],"length":1,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[14565791],"length":1,"stats":{"Line":0}},{"line":337,"address":[14565831],"length":1,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[14565515],"length":1,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[14566443],"length":1,"stats":{"Line":0}},{"line":367,"address":[14593746,14593640,14591504],"length":1,"stats":{"Line":0}},{"line":371,"address":[14591551],"length":1,"stats":{"Line":0}},{"line":372,"address":[14591837],"length":1,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[14593171],"length":1,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[14592534],"length":1,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[14592838],"length":1,"stats":{"Line":0}},{"line":448,"address":[14594742,14592870],"length":1,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[14594994,14592933],"length":1,"stats":{"Line":0}},{"line":454,"address":[14593018],"length":1,"stats":{"Line":0}},{"line":458,"address":[14590664,14589056],"length":1,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[14589501],"length":1,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[14589927,14590349],"length":1,"stats":{"Line":0}},{"line":498,"address":[14590023],"length":1,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[14570432],"length":1,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[14570526],"length":1,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[14570654],"length":1,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[14570946],"length":1,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[14597787,14595184,14596631],"length":1,"stats":{"Line":0}},{"line":544,"address":[14595231],"length":1,"stats":{"Line":0}},{"line":545,"address":[14595354],"length":1,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[14595548,14596270],"length":1,"stats":{"Line":0}},{"line":561,"address":[14595594],"length":1,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[14595660],"length":1,"stats":{"Line":0}},{"line":565,"address":[14595740,14596979],"length":1,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[14558927,14557008],"length":1,"stats":{"Line":0}},{"line":579,"address":[14557050],"length":1,"stats":{"Line":0}},{"line":580,"address":[14557439],"length":1,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":603,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[14559242],"length":1,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[14558102,14560055],"length":1,"stats":{"Line":0}},{"line":632,"address":[14558168],"length":1,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":652,"address":[14558529],"length":1,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[14571424,14573143],"length":1,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[14571620],"length":1,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":671,"address":[],"length":0,"stats":{"Line":0}},{"line":672,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":675,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":688,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[14572155],"length":1,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":696,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":698,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[14573218],"length":1,"stats":{"Line":0}},{"line":704,"address":[14573258],"length":1,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}},{"line":706,"address":[14573338],"length":1,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":0}},{"line":708,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":716,"address":[],"length":0,"stats":{"Line":0}},{"line":717,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":722,"address":[14574354,14572525],"length":1,"stats":{"Line":0}},{"line":724,"address":[],"length":0,"stats":{"Line":0}},{"line":725,"address":[],"length":0,"stats":{"Line":0}},{"line":726,"address":[],"length":0,"stats":{"Line":0}},{"line":727,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":0}},{"line":729,"address":[],"length":0,"stats":{"Line":0}},{"line":730,"address":[],"length":0,"stats":{"Line":0}},{"line":731,"address":[],"length":0,"stats":{"Line":0}},{"line":733,"address":[],"length":0,"stats":{"Line":0}},{"line":734,"address":[14572786],"length":1,"stats":{"Line":0}},{"line":735,"address":[14574479],"length":1,"stats":{"Line":0}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":737,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[14572871],"length":1,"stats":{"Line":0}},{"line":747,"address":[14554566,14552864],"length":1,"stats":{"Line":0}},{"line":751,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[14553162],"length":1,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":754,"address":[],"length":0,"stats":{"Line":0}},{"line":755,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[14554223,14553198],"length":1,"stats":{"Line":0}},{"line":760,"address":[],"length":0,"stats":{"Line":0}},{"line":761,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":0}},{"line":764,"address":[],"length":0,"stats":{"Line":0}},{"line":765,"address":[],"length":0,"stats":{"Line":0}},{"line":766,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":768,"address":[],"length":0,"stats":{"Line":0}},{"line":769,"address":[],"length":0,"stats":{"Line":0}},{"line":770,"address":[],"length":0,"stats":{"Line":0}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":774,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[14553635],"length":1,"stats":{"Line":0}},{"line":776,"address":[14554644],"length":1,"stats":{"Line":0}},{"line":777,"address":[14554684],"length":1,"stats":{"Line":0}},{"line":778,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":780,"address":[14554804],"length":1,"stats":{"Line":0}},{"line":781,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":785,"address":[],"length":0,"stats":{"Line":0}},{"line":786,"address":[],"length":0,"stats":{"Line":0}},{"line":788,"address":[14553815],"length":1,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":790,"address":[],"length":0,"stats":{"Line":0}},{"line":791,"address":[],"length":0,"stats":{"Line":0}},{"line":792,"address":[],"length":0,"stats":{"Line":0}},{"line":793,"address":[],"length":0,"stats":{"Line":0}},{"line":794,"address":[14553827,14555783],"length":1,"stats":{"Line":0}},{"line":796,"address":[14553947],"length":1,"stats":{"Line":0}},{"line":797,"address":[],"length":0,"stats":{"Line":0}},{"line":798,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":800,"address":[],"length":0,"stats":{"Line":0}},{"line":801,"address":[14554019,14555902],"length":1,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":0}},{"line":804,"address":[14554111,14556351],"length":1,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":810,"address":[14554288],"length":1,"stats":{"Line":0}},{"line":814,"address":[14574992,14578359],"length":1,"stats":{"Line":0}},{"line":818,"address":[14575069],"length":1,"stats":{"Line":0}},{"line":819,"address":[14575470],"length":1,"stats":{"Line":0}},{"line":820,"address":[],"length":0,"stats":{"Line":0}},{"line":821,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":823,"address":[],"length":0,"stats":{"Line":0}},{"line":824,"address":[],"length":0,"stats":{"Line":0}},{"line":825,"address":[14575614,14578013],"length":1,"stats":{"Line":0}},{"line":827,"address":[14575726],"length":1,"stats":{"Line":0}},{"line":828,"address":[14575758,14578177],"length":1,"stats":{"Line":0}},{"line":830,"address":[],"length":0,"stats":{"Line":0}},{"line":831,"address":[],"length":0,"stats":{"Line":0}},{"line":832,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[],"length":0,"stats":{"Line":0}},{"line":834,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":836,"address":[],"length":0,"stats":{"Line":0}},{"line":837,"address":[],"length":0,"stats":{"Line":0}},{"line":839,"address":[],"length":0,"stats":{"Line":0}},{"line":840,"address":[],"length":0,"stats":{"Line":0}},{"line":841,"address":[14578443],"length":1,"stats":{"Line":0}},{"line":842,"address":[14578483],"length":1,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":844,"address":[14578563],"length":1,"stats":{"Line":0}},{"line":845,"address":[14578603],"length":1,"stats":{"Line":0}},{"line":848,"address":[],"length":0,"stats":{"Line":0}},{"line":849,"address":[14576056,14579208],"length":1,"stats":{"Line":0}},{"line":851,"address":[14576098],"length":1,"stats":{"Line":0}},{"line":852,"address":[],"length":0,"stats":{"Line":0}},{"line":853,"address":[],"length":0,"stats":{"Line":0}},{"line":854,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":0}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":857,"address":[],"length":0,"stats":{"Line":0}},{"line":859,"address":[14576290],"length":1,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":861,"address":[],"length":0,"stats":{"Line":0}},{"line":862,"address":[],"length":0,"stats":{"Line":0}},{"line":863,"address":[],"length":0,"stats":{"Line":0}},{"line":864,"address":[],"length":0,"stats":{"Line":0}},{"line":865,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":0}},{"line":868,"address":[14576460],"length":1,"stats":{"Line":0}},{"line":869,"address":[],"length":0,"stats":{"Line":0}},{"line":870,"address":[],"length":0,"stats":{"Line":0}},{"line":871,"address":[],"length":0,"stats":{"Line":0}},{"line":872,"address":[],"length":0,"stats":{"Line":0}},{"line":873,"address":[],"length":0,"stats":{"Line":0}},{"line":874,"address":[],"length":0,"stats":{"Line":0}},{"line":875,"address":[],"length":0,"stats":{"Line":0}},{"line":877,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[14576658],"length":1,"stats":{"Line":0}},{"line":879,"address":[14580072],"length":1,"stats":{"Line":0}},{"line":880,"address":[],"length":0,"stats":{"Line":0}},{"line":881,"address":[14580152],"length":1,"stats":{"Line":0}},{"line":882,"address":[14580192],"length":1,"stats":{"Line":0}},{"line":883,"address":[],"length":0,"stats":{"Line":0}},{"line":886,"address":[],"length":0,"stats":{"Line":0}},{"line":887,"address":[],"length":0,"stats":{"Line":0}},{"line":889,"address":[14576810],"length":1,"stats":{"Line":0}},{"line":890,"address":[],"length":0,"stats":{"Line":0}},{"line":891,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":893,"address":[],"length":0,"stats":{"Line":0}},{"line":894,"address":[],"length":0,"stats":{"Line":0}},{"line":895,"address":[],"length":0,"stats":{"Line":0}},{"line":896,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[14581435],"length":1,"stats":{"Line":0}},{"line":899,"address":[14581555],"length":1,"stats":{"Line":0}},{"line":900,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[14581635],"length":1,"stats":{"Line":0}},{"line":902,"address":[14581675],"length":1,"stats":{"Line":0}},{"line":903,"address":[],"length":0,"stats":{"Line":0}},{"line":906,"address":[14577025],"length":1,"stats":{"Line":0}},{"line":907,"address":[],"length":0,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":0}},{"line":910,"address":[],"length":0,"stats":{"Line":0}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":912,"address":[14582973,14583301,14583475],"length":1,"stats":{"Line":0}},{"line":914,"address":[14577112],"length":1,"stats":{"Line":0}},{"line":915,"address":[14583807,14577144,14584622],"length":1,"stats":{"Line":0}},{"line":916,"address":[],"length":0,"stats":{"Line":0}},{"line":918,"address":[],"length":0,"stats":{"Line":0}},{"line":919,"address":[],"length":0,"stats":{"Line":0}},{"line":920,"address":[],"length":0,"stats":{"Line":0}},{"line":921,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":924,"address":[14585101,14585389,14585555],"length":1,"stats":{"Line":0}},{"line":926,"address":[],"length":0,"stats":{"Line":0}},{"line":927,"address":[],"length":0,"stats":{"Line":0}},{"line":928,"address":[],"length":0,"stats":{"Line":0}},{"line":929,"address":[],"length":0,"stats":{"Line":0}},{"line":930,"address":[],"length":0,"stats":{"Line":0}},{"line":931,"address":[],"length":0,"stats":{"Line":0}},{"line":932,"address":[14586671,14586169,14586497],"length":1,"stats":{"Line":0}},{"line":934,"address":[],"length":0,"stats":{"Line":0}},{"line":935,"address":[],"length":0,"stats":{"Line":0}},{"line":936,"address":[],"length":0,"stats":{"Line":0}},{"line":937,"address":[],"length":0,"stats":{"Line":0}},{"line":938,"address":[],"length":0,"stats":{"Line":0}},{"line":939,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":0}},{"line":941,"address":[],"length":0,"stats":{"Line":0}},{"line":942,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":947,"address":[],"length":0,"stats":{"Line":0}},{"line":948,"address":[14587514],"length":1,"stats":{"Line":0}},{"line":949,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":0}},{"line":951,"address":[14587634],"length":1,"stats":{"Line":0}},{"line":952,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":0}},{"line":954,"address":[14587714],"length":1,"stats":{"Line":0}},{"line":955,"address":[],"length":0,"stats":{"Line":0}},{"line":956,"address":[14587794],"length":1,"stats":{"Line":0}},{"line":959,"address":[],"length":0,"stats":{"Line":0}},{"line":960,"address":[],"length":0,"stats":{"Line":0}},{"line":961,"address":[],"length":0,"stats":{"Line":0}},{"line":962,"address":[],"length":0,"stats":{"Line":0}},{"line":963,"address":[],"length":0,"stats":{"Line":0}},{"line":966,"address":[],"length":0,"stats":{"Line":0}},{"line":970,"address":[14635760,14637039,14638743],"length":1,"stats":{"Line":0}},{"line":971,"address":[14635783],"length":1,"stats":{"Line":0}},{"line":972,"address":[14635845,14635942],"length":1,"stats":{"Line":0}},{"line":973,"address":[14636078],"length":1,"stats":{"Line":0}},{"line":975,"address":[14636267],"length":1,"stats":{"Line":0}},{"line":976,"address":[14638145,14636338],"length":1,"stats":{"Line":0}},{"line":977,"address":[14638168,14638738],"length":1,"stats":{"Line":0}},{"line":978,"address":[14638454,14638736,14638517],"length":1,"stats":{"Line":0}},{"line":979,"address":[14638654],"length":1,"stats":{"Line":0}},{"line":980,"address":[14638707],"length":1,"stats":{"Line":0}},{"line":983,"address":[14636383,14636277,14638140],"length":1,"stats":{"Line":0}},{"line":986,"address":[14636657,14636582],"length":1,"stats":{"Line":0}},{"line":987,"address":[14636741,14636841],"length":1,"stats":{"Line":0}},{"line":988,"address":[14636918],"length":1,"stats":{"Line":0}},{"line":991,"address":[14636768,14637045],"length":1,"stats":{"Line":0}},{"line":992,"address":[14637068],"length":1,"stats":{"Line":0}},{"line":993,"address":[14637100,14637174],"length":1,"stats":{"Line":0}},{"line":995,"address":[14637074,14637126],"length":1,"stats":{"Line":0}},{"line":998,"address":[14637195,14637147],"length":1,"stats":{"Line":0}},{"line":999,"address":[14637312],"length":1,"stats":{"Line":0}},{"line":1000,"address":[14637462,14637392],"length":1,"stats":{"Line":0}},{"line":1001,"address":[14637481],"length":1,"stats":{"Line":0}},{"line":1002,"address":[14637585],"length":1,"stats":{"Line":0}},{"line":1003,"address":[14637689],"length":1,"stats":{"Line":0}},{"line":1004,"address":[14637710],"length":1,"stats":{"Line":0}},{"line":1006,"address":[14637816,14637704],"length":1,"stats":{"Line":0}},{"line":1007,"address":[14637853],"length":1,"stats":{"Line":0}},{"line":1009,"address":[14637827,14637900],"length":1,"stats":{"Line":0}},{"line":1011,"address":[14637226],"length":1,"stats":{"Line":0}},{"line":1012,"address":[14637282,14638019],"length":1,"stats":{"Line":0}},{"line":1016,"address":[14637946],"length":1,"stats":{"Line":0}},{"line":1020,"address":[14568192],"length":1,"stats":{"Line":0}},{"line":1026,"address":[],"length":0,"stats":{"Line":0}},{"line":1027,"address":[],"length":0,"stats":{"Line":0}},{"line":1028,"address":[],"length":0,"stats":{"Line":0}},{"line":1029,"address":[],"length":0,"stats":{"Line":0}},{"line":1030,"address":[],"length":0,"stats":{"Line":0}},{"line":1031,"address":[],"length":0,"stats":{"Line":0}},{"line":1032,"address":[],"length":0,"stats":{"Line":0}},{"line":1033,"address":[],"length":0,"stats":{"Line":0}},{"line":1034,"address":[],"length":0,"stats":{"Line":0}},{"line":1035,"address":[14569952,14568415],"length":1,"stats":{"Line":0}},{"line":1037,"address":[],"length":0,"stats":{"Line":0}},{"line":1038,"address":[],"length":0,"stats":{"Line":0}},{"line":1039,"address":[],"length":0,"stats":{"Line":0}},{"line":1040,"address":[],"length":0,"stats":{"Line":0}},{"line":1041,"address":[],"length":0,"stats":{"Line":0}},{"line":1042,"address":[],"length":0,"stats":{"Line":0}},{"line":1043,"address":[],"length":0,"stats":{"Line":0}},{"line":1045,"address":[],"length":0,"stats":{"Line":0}},{"line":1046,"address":[],"length":0,"stats":{"Line":0}},{"line":1048,"address":[14568927],"length":1,"stats":{"Line":0}},{"line":1049,"address":[],"length":0,"stats":{"Line":0}},{"line":1050,"address":[],"length":0,"stats":{"Line":0}},{"line":1051,"address":[],"length":0,"stats":{"Line":0}},{"line":1052,"address":[],"length":0,"stats":{"Line":0}},{"line":1053,"address":[],"length":0,"stats":{"Line":0}},{"line":1054,"address":[],"length":0,"stats":{"Line":0}},{"line":1055,"address":[],"length":0,"stats":{"Line":0}},{"line":1057,"address":[14569190],"length":1,"stats":{"Line":0}},{"line":1058,"address":[14569241,14570196],"length":1,"stats":{"Line":0}},{"line":1060,"address":[14569460],"length":1,"stats":{"Line":0}},{"line":1061,"address":[],"length":0,"stats":{"Line":0}},{"line":1062,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[],"length":0,"stats":{"Line":0}},{"line":1064,"address":[],"length":0,"stats":{"Line":0}},{"line":1065,"address":[],"length":0,"stats":{"Line":0}},{"line":1066,"address":[],"length":0,"stats":{"Line":0}},{"line":1067,"address":[],"length":0,"stats":{"Line":0}},{"line":1069,"address":[],"length":0,"stats":{"Line":0}},{"line":1070,"address":[],"length":0,"stats":{"Line":0}},{"line":1071,"address":[],"length":0,"stats":{"Line":0}},{"line":1072,"address":[],"length":0,"stats":{"Line":0}},{"line":1073,"address":[],"length":0,"stats":{"Line":0}},{"line":1074,"address":[],"length":0,"stats":{"Line":0}},{"line":1075,"address":[],"length":0,"stats":{"Line":0}},{"line":1078,"address":[],"length":0,"stats":{"Line":0}},{"line":1079,"address":[],"length":0,"stats":{"Line":0}},{"line":1081,"address":[14569795],"length":1,"stats":{"Line":0}},{"line":1082,"address":[],"length":0,"stats":{"Line":0}},{"line":1083,"address":[],"length":0,"stats":{"Line":0}},{"line":1084,"address":[],"length":0,"stats":{"Line":0}},{"line":1085,"address":[],"length":0,"stats":{"Line":0}},{"line":1086,"address":[14569861,14570367],"length":1,"stats":{"Line":0}},{"line":1090,"address":[14570011],"length":1,"stats":{"Line":0}},{"line":1094,"address":[14597808],"length":1,"stats":{"Line":0}},{"line":1100,"address":[14597843],"length":1,"stats":{"Line":0}},{"line":1101,"address":[14598125],"length":1,"stats":{"Line":0}},{"line":1102,"address":[],"length":0,"stats":{"Line":0}},{"line":1103,"address":[],"length":0,"stats":{"Line":0}},{"line":1104,"address":[],"length":0,"stats":{"Line":0}},{"line":1105,"address":[],"length":0,"stats":{"Line":0}},{"line":1106,"address":[],"length":0,"stats":{"Line":0}},{"line":1107,"address":[],"length":0,"stats":{"Line":0}},{"line":1108,"address":[],"length":0,"stats":{"Line":0}},{"line":1109,"address":[],"length":0,"stats":{"Line":0}},{"line":1110,"address":[],"length":0,"stats":{"Line":0}},{"line":1111,"address":[],"length":0,"stats":{"Line":0}},{"line":1112,"address":[],"length":0,"stats":{"Line":0}},{"line":1113,"address":[],"length":0,"stats":{"Line":0}},{"line":1115,"address":[],"length":0,"stats":{"Line":0}},{"line":1116,"address":[],"length":0,"stats":{"Line":0}},{"line":1117,"address":[],"length":0,"stats":{"Line":0}},{"line":1118,"address":[],"length":0,"stats":{"Line":0}},{"line":1119,"address":[],"length":0,"stats":{"Line":0}},{"line":1120,"address":[],"length":0,"stats":{"Line":0}},{"line":1121,"address":[],"length":0,"stats":{"Line":0}},{"line":1122,"address":[],"length":0,"stats":{"Line":0}},{"line":1123,"address":[],"length":0,"stats":{"Line":0}},{"line":1124,"address":[],"length":0,"stats":{"Line":0}},{"line":1125,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":0}},{"line":1129,"address":[14598669],"length":1,"stats":{"Line":0}},{"line":1130,"address":[],"length":0,"stats":{"Line":0}},{"line":1131,"address":[],"length":0,"stats":{"Line":0}},{"line":1132,"address":[],"length":0,"stats":{"Line":0}},{"line":1133,"address":[],"length":0,"stats":{"Line":0}},{"line":1134,"address":[],"length":0,"stats":{"Line":0}},{"line":1135,"address":[],"length":0,"stats":{"Line":0}},{"line":1136,"address":[],"length":0,"stats":{"Line":0}},{"line":1137,"address":[],"length":0,"stats":{"Line":0}},{"line":1138,"address":[],"length":0,"stats":{"Line":0}},{"line":1140,"address":[],"length":0,"stats":{"Line":0}},{"line":1141,"address":[],"length":0,"stats":{"Line":0}},{"line":1142,"address":[],"length":0,"stats":{"Line":0}},{"line":1143,"address":[],"length":0,"stats":{"Line":0}},{"line":1144,"address":[],"length":0,"stats":{"Line":0}},{"line":1145,"address":[],"length":0,"stats":{"Line":0}},{"line":1146,"address":[],"length":0,"stats":{"Line":0}},{"line":1147,"address":[],"length":0,"stats":{"Line":0}},{"line":1148,"address":[],"length":0,"stats":{"Line":0}},{"line":1151,"address":[14598880],"length":1,"stats":{"Line":0}},{"line":1152,"address":[14598931,14600199],"length":1,"stats":{"Line":0}},{"line":1154,"address":[14599255],"length":1,"stats":{"Line":0}},{"line":1155,"address":[],"length":0,"stats":{"Line":0}},{"line":1156,"address":[],"length":0,"stats":{"Line":0}},{"line":1157,"address":[],"length":0,"stats":{"Line":0}},{"line":1158,"address":[],"length":0,"stats":{"Line":0}},{"line":1159,"address":[],"length":0,"stats":{"Line":0}},{"line":1160,"address":[],"length":0,"stats":{"Line":0}},{"line":1161,"address":[],"length":0,"stats":{"Line":0}},{"line":1162,"address":[],"length":0,"stats":{"Line":0}},{"line":1163,"address":[],"length":0,"stats":{"Line":0}},{"line":1164,"address":[],"length":0,"stats":{"Line":0}},{"line":1165,"address":[],"length":0,"stats":{"Line":0}},{"line":1166,"address":[],"length":0,"stats":{"Line":0}},{"line":1168,"address":[],"length":0,"stats":{"Line":0}},{"line":1169,"address":[],"length":0,"stats":{"Line":0}},{"line":1170,"address":[],"length":0,"stats":{"Line":0}},{"line":1171,"address":[],"length":0,"stats":{"Line":0}},{"line":1172,"address":[],"length":0,"stats":{"Line":0}},{"line":1173,"address":[],"length":0,"stats":{"Line":0}},{"line":1174,"address":[],"length":0,"stats":{"Line":0}},{"line":1175,"address":[],"length":0,"stats":{"Line":0}},{"line":1176,"address":[],"length":0,"stats":{"Line":0}},{"line":1177,"address":[],"length":0,"stats":{"Line":0}},{"line":1178,"address":[],"length":0,"stats":{"Line":0}},{"line":1179,"address":[],"length":0,"stats":{"Line":0}},{"line":1182,"address":[],"length":0,"stats":{"Line":0}},{"line":1183,"address":[],"length":0,"stats":{"Line":0}},{"line":1184,"address":[],"length":0,"stats":{"Line":0}},{"line":1185,"address":[],"length":0,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1187,"address":[],"length":0,"stats":{"Line":0}},{"line":1188,"address":[14599680,14600310],"length":1,"stats":{"Line":0}},{"line":1190,"address":[],"length":0,"stats":{"Line":0}},{"line":1191,"address":[],"length":0,"stats":{"Line":0}},{"line":1193,"address":[],"length":0,"stats":{"Line":0}},{"line":1194,"address":[],"length":0,"stats":{"Line":0}},{"line":1195,"address":[],"length":0,"stats":{"Line":0}},{"line":1196,"address":[],"length":0,"stats":{"Line":0}},{"line":1197,"address":[],"length":0,"stats":{"Line":0}},{"line":1198,"address":[],"length":0,"stats":{"Line":0}},{"line":1202,"address":[],"length":0,"stats":{"Line":0}},{"line":1205,"address":[14629136],"length":1,"stats":{"Line":0}},{"line":1206,"address":[14629175,14629827],"length":1,"stats":{"Line":0}},{"line":1208,"address":[14629829],"length":1,"stats":{"Line":0}},{"line":1209,"address":[14629858],"length":1,"stats":{"Line":0}},{"line":1210,"address":[14629887],"length":1,"stats":{"Line":0}},{"line":1211,"address":[14629922],"length":1,"stats":{"Line":0}},{"line":1214,"address":[14629957],"length":1,"stats":{"Line":0}},{"line":1215,"address":[14629992],"length":1,"stats":{"Line":0}},{"line":1216,"address":[14630027],"length":1,"stats":{"Line":0}},{"line":1217,"address":[14630062],"length":1,"stats":{"Line":0}},{"line":1218,"address":[14630097],"length":1,"stats":{"Line":0}},{"line":1221,"address":[14630132],"length":1,"stats":{"Line":0}},{"line":1222,"address":[14630167],"length":1,"stats":{"Line":0}},{"line":1223,"address":[14630202],"length":1,"stats":{"Line":0}},{"line":1226,"address":[14630237],"length":1,"stats":{"Line":0}},{"line":1227,"address":[14630272],"length":1,"stats":{"Line":0}},{"line":1228,"address":[14630307],"length":1,"stats":{"Line":0}},{"line":1229,"address":[14630342],"length":1,"stats":{"Line":0}},{"line":1232,"address":[14630377],"length":1,"stats":{"Line":0}},{"line":1233,"address":[14630412],"length":1,"stats":{"Line":0}},{"line":1234,"address":[14630447],"length":1,"stats":{"Line":0}},{"line":1235,"address":[14630482],"length":1,"stats":{"Line":0}},{"line":1236,"address":[14630517],"length":1,"stats":{"Line":0}},{"line":1237,"address":[14630552],"length":1,"stats":{"Line":0}},{"line":1240,"address":[14630587],"length":1,"stats":{"Line":0}},{"line":1241,"address":[14630622],"length":1,"stats":{"Line":0}},{"line":1242,"address":[14630657],"length":1,"stats":{"Line":0}},{"line":1245,"address":[14630697],"length":1,"stats":{"Line":0}},{"line":1246,"address":[14630732],"length":1,"stats":{"Line":0}},{"line":1247,"address":[14630767],"length":1,"stats":{"Line":0}},{"line":1248,"address":[14630802],"length":1,"stats":{"Line":0}},{"line":1249,"address":[14630837],"length":1,"stats":{"Line":0}},{"line":1250,"address":[14630872],"length":1,"stats":{"Line":0}},{"line":1251,"address":[14630907],"length":1,"stats":{"Line":0}},{"line":1252,"address":[14630942],"length":1,"stats":{"Line":0}},{"line":1253,"address":[14630977],"length":1,"stats":{"Line":0}},{"line":1254,"address":[14631012],"length":1,"stats":{"Line":0}},{"line":1255,"address":[14631047],"length":1,"stats":{"Line":0}},{"line":1256,"address":[14631082],"length":1,"stats":{"Line":0}},{"line":1257,"address":[14631117],"length":1,"stats":{"Line":0}},{"line":1258,"address":[14631152],"length":1,"stats":{"Line":0}},{"line":1259,"address":[14631187],"length":1,"stats":{"Line":0}},{"line":1260,"address":[14631222],"length":1,"stats":{"Line":0}},{"line":1261,"address":[14631257],"length":1,"stats":{"Line":0}},{"line":1262,"address":[14631292],"length":1,"stats":{"Line":0}},{"line":1263,"address":[14631327],"length":1,"stats":{"Line":0}},{"line":1264,"address":[14631362],"length":1,"stats":{"Line":0}},{"line":1265,"address":[14631397],"length":1,"stats":{"Line":0}},{"line":1266,"address":[14631432],"length":1,"stats":{"Line":0}},{"line":1267,"address":[14631467],"length":1,"stats":{"Line":0}},{"line":1268,"address":[14631502],"length":1,"stats":{"Line":0}},{"line":1269,"address":[14631537],"length":1,"stats":{"Line":0}},{"line":1270,"address":[14631572],"length":1,"stats":{"Line":0}},{"line":1271,"address":[14631607],"length":1,"stats":{"Line":0}},{"line":1274,"address":[14631647],"length":1,"stats":{"Line":0}},{"line":1275,"address":[14631682],"length":1,"stats":{"Line":0}},{"line":1276,"address":[14631717],"length":1,"stats":{"Line":0}},{"line":1277,"address":[14631752],"length":1,"stats":{"Line":0}},{"line":1278,"address":[14631787],"length":1,"stats":{"Line":0}},{"line":1279,"address":[14631822],"length":1,"stats":{"Line":0}},{"line":1280,"address":[14631857],"length":1,"stats":{"Line":0}},{"line":1281,"address":[14631892],"length":1,"stats":{"Line":0}},{"line":1282,"address":[14631927],"length":1,"stats":{"Line":0}},{"line":1285,"address":[14631962],"length":1,"stats":{"Line":0}},{"line":1286,"address":[14631997],"length":1,"stats":{"Line":0}},{"line":1287,"address":[14632032],"length":1,"stats":{"Line":0}},{"line":1288,"address":[14632067],"length":1,"stats":{"Line":0}},{"line":1289,"address":[14632102],"length":1,"stats":{"Line":0}},{"line":1290,"address":[14632137],"length":1,"stats":{"Line":0}},{"line":1291,"address":[14632172],"length":1,"stats":{"Line":0}},{"line":1292,"address":[14632207],"length":1,"stats":{"Line":0}},{"line":1293,"address":[14632242],"length":1,"stats":{"Line":0}},{"line":1294,"address":[14632277],"length":1,"stats":{"Line":0}},{"line":1295,"address":[14632312],"length":1,"stats":{"Line":0}},{"line":1296,"address":[14632347],"length":1,"stats":{"Line":0}},{"line":1297,"address":[14632382],"length":1,"stats":{"Line":0}},{"line":1298,"address":[14632417],"length":1,"stats":{"Line":0}},{"line":1299,"address":[14632452],"length":1,"stats":{"Line":0}},{"line":1300,"address":[14632487],"length":1,"stats":{"Line":0}},{"line":1301,"address":[14632522],"length":1,"stats":{"Line":0}},{"line":1302,"address":[14632557],"length":1,"stats":{"Line":0}},{"line":1303,"address":[14632592],"length":1,"stats":{"Line":0}},{"line":1304,"address":[14632627],"length":1,"stats":{"Line":0}},{"line":1305,"address":[14632662],"length":1,"stats":{"Line":0}},{"line":1306,"address":[14632697],"length":1,"stats":{"Line":0}},{"line":1307,"address":[14632732],"length":1,"stats":{"Line":0}},{"line":1308,"address":[14632767],"length":1,"stats":{"Line":0}},{"line":1309,"address":[14632802],"length":1,"stats":{"Line":0}},{"line":1310,"address":[14632837],"length":1,"stats":{"Line":0}},{"line":1311,"address":[14632872],"length":1,"stats":{"Line":0}},{"line":1312,"address":[14632907],"length":1,"stats":{"Line":0}},{"line":1313,"address":[14632942],"length":1,"stats":{"Line":0}},{"line":1314,"address":[14632977],"length":1,"stats":{"Line":0}},{"line":1315,"address":[14633012],"length":1,"stats":{"Line":0}},{"line":1316,"address":[14633047],"length":1,"stats":{"Line":0}},{"line":1319,"address":[14633082],"length":1,"stats":{"Line":0}},{"line":1320,"address":[14633117],"length":1,"stats":{"Line":0}},{"line":1321,"address":[14633152],"length":1,"stats":{"Line":0}},{"line":1322,"address":[14633187],"length":1,"stats":{"Line":0}},{"line":1323,"address":[14633222],"length":1,"stats":{"Line":0}},{"line":1324,"address":[14633257],"length":1,"stats":{"Line":0}},{"line":1325,"address":[14633292],"length":1,"stats":{"Line":0}},{"line":1328,"address":[14633327],"length":1,"stats":{"Line":0}},{"line":1329,"address":[14633362],"length":1,"stats":{"Line":0}},{"line":1330,"address":[14633397],"length":1,"stats":{"Line":0}},{"line":1331,"address":[14633432],"length":1,"stats":{"Line":0}},{"line":1332,"address":[14633467],"length":1,"stats":{"Line":0}},{"line":1335,"address":[14629242],"length":1,"stats":{"Line":0}},{"line":1336,"address":[14629277],"length":1,"stats":{"Line":0}},{"line":1337,"address":[14629312],"length":1,"stats":{"Line":0}},{"line":1338,"address":[14629347],"length":1,"stats":{"Line":0}},{"line":1339,"address":[14629382],"length":1,"stats":{"Line":0}},{"line":1340,"address":[14629417],"length":1,"stats":{"Line":0}},{"line":1341,"address":[14629452],"length":1,"stats":{"Line":0}},{"line":1342,"address":[14629487],"length":1,"stats":{"Line":0}},{"line":1343,"address":[14629522],"length":1,"stats":{"Line":0}},{"line":1344,"address":[14629557],"length":1,"stats":{"Line":0}},{"line":1345,"address":[14629592],"length":1,"stats":{"Line":0}},{"line":1346,"address":[14629627],"length":1,"stats":{"Line":0}},{"line":1347,"address":[14629662],"length":1,"stats":{"Line":0}},{"line":1348,"address":[14629697],"length":1,"stats":{"Line":0}},{"line":1349,"address":[14629732],"length":1,"stats":{"Line":0}},{"line":1350,"address":[14629767],"length":1,"stats":{"Line":0}},{"line":1354,"address":[14629812],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":987},{"path":["/","home","shift","code","vincents-ai","engram","src","migration.rs"],"content":"//! Migration utilities for converting between storage backends\n//!\n//! This module provides tools for migrating data from the dual-repository\n//! architecture (.engram/ directory) to the Git refs storage architecture.\n\nuse crate::error::EngramError;\nuse crate::storage::{memory_entity::MemoryEntity, GitStorage, Storage};\nuse std::collections::HashMap;\nuse std::fs;\nuse std::path::{Path, PathBuf};\n\n/// Migration configuration and state\npub struct Migration {\n    source_path: PathBuf,\n    target_storage: GitStorage,\n    dry_run: bool,\n    backup_only: bool,\n}\n\n/// Migration statistics\n#[derive(Debug, Default)]\npub struct MigrationStats {\n    pub entities_processed: usize,\n    pub entities_migrated: usize,\n    pub entities_failed: usize,\n    pub entity_types: HashMap\u003cString, usize\u003e,\n}\n\nimpl Migration {\n    /// Create new migration instance\n    pub fn new(\n        workspace_path: \u0026str,\n        agent: \u0026str,\n        dry_run: bool,\n        backup_only: bool,\n    ) -\u003e Result\u003cSelf, EngramError\u003e {\n        let source_path = PathBuf::from(workspace_path).join(\".engram\");\n        let target_storage = GitStorage::new(workspace_path, agent)?;\n\n        Ok(Self {\n            source_path,\n            target_storage,\n            dry_run,\n            backup_only,\n        })\n    }\n\n    /// Execute the migration from .engram/ to Git refs storage\n    pub fn execute(\u0026mut self) -\u003e Result\u003cMigrationStats, EngramError\u003e {\n        let mut stats = MigrationStats::default();\n\n        if !self.source_path.exists() {\n            return Err(EngramError::NotFound(format!(\n                \"Source migration path does not exist: {}\",\n                self.source_path.display()\n            )));\n        }\n\n        if self.backup_only {\n            println!(\"üíæ Creating backup only...\");\n            self.create_backup()?;\n            return Ok(stats);\n        }\n        if self.dry_run {\n            println!(\"üìù DRY RUN: No changes will be made\");\n        }\n\n        let entity_dirs = self.discover_entity_directories()?;\n        println!(\"üìÇ Found {} entity type directories\", entity_dirs.len());\n\n        for (entity_type, dir_path) in entity_dirs {\n            println!(\"\\nüìÅ Migrating {} entities...\", entity_type);\n            let type_stats = self.migrate_entity_type(\u0026entity_type, \u0026dir_path)?;\n\n            stats.entities_processed += type_stats.entities_processed;\n            stats.entities_migrated += type_stats.entities_migrated;\n            stats.entities_failed += type_stats.entities_failed;\n            stats\n                .entity_types\n                .insert(entity_type.clone(), type_stats.entities_migrated);\n\n            println!(\n                \"   ‚úÖ {}/{} {} entities migrated\",\n                type_stats.entities_migrated, type_stats.entities_processed, entity_type\n            );\n        }\n\n        println!(\"\\nüèÅ Migration Summary:\");\n        println!(\"   üìä Total processed: {}\", stats.entities_processed);\n        println!(\"   ‚úÖ Successfully migrated: {}\", stats.entities_migrated);\n        if stats.entities_failed \u003e 0 {\n            println!(\"   ‚ùå Failed: {}\", stats.entities_failed);\n        }\n\n        if !self.dry_run \u0026\u0026 stats.entities_migrated \u003e 0 {\n            println!(\"\\nüíæ Creating backup of original .engram directory...\");\n            self.create_backup()?;\n        }\n\n        Ok(stats)\n    }\n\n    /// Discover entity type directories in .engram/\n    fn discover_entity_directories(\u0026self) -\u003e Result\u003cVec\u003c(String, PathBuf)\u003e, EngramError\u003e {\n        let mut entity_dirs = Vec::new();\n\n        let entries = fs::read_dir(\u0026self.source_path).map_err(|e| {\n            EngramError::NotFound(format!(\"Failed to read source directory: {}\", e))\n        })?;\n\n        for entry in entries {\n            let entry = entry.map_err(|e| {\n                EngramError::InvalidOperation(format!(\"Failed to read directory entry: {}\", e))\n            })?;\n            let path = entry.path();\n\n            if path.is_dir() {\n                let dir_name = path\n                    .file_name()\n                    .and_then(|name| name.to_str())\n                    .unwrap_or(\"\")\n                    .to_string();\n\n                // Skip .git directory and other non-entity directories\n                if !dir_name.starts_with('.')\n                    \u0026\u0026 dir_name != \"session\"\n                    \u0026\u0026 self.has_json_files(\u0026path)?\n                {\n                    entity_dirs.push((dir_name, path));\n                }\n            }\n        }\n\n        entity_dirs.sort_by(|a, b| a.0.cmp(\u0026b.0));\n        Ok(entity_dirs)\n    }\n\n    /// Check if directory contains JSON files\n    fn has_json_files(\u0026self, dir_path: \u0026Path) -\u003e Result\u003cbool, EngramError\u003e {\n        let entries = fs::read_dir(dir_path).map_err(|e| {\n            EngramError::InvalidOperation(format!(\"Failed to read directory: {}\", e))\n        })?;\n\n        for entry in entries {\n            let entry = entry.map_err(|e| {\n                EngramError::InvalidOperation(format!(\"Failed to read entry: {}\", e))\n            })?;\n            if entry.path().extension().map_or(false, |ext| ext == \"json\") {\n                return Ok(true);\n            }\n        }\n        Ok(false)\n    }\n\n    /// Migrate all entities of a specific type\n    fn migrate_entity_type(\n        \u0026mut self,\n        entity_type: \u0026str,\n        dir_path: \u0026Path,\n    ) -\u003e Result\u003cMigrationStats, EngramError\u003e {\n        let mut stats = MigrationStats::default();\n\n        let entries = fs::read_dir(dir_path).map_err(|e| {\n            EngramError::InvalidOperation(format!(\"Failed to read entity directory: {}\", e))\n        })?;\n\n        for entry in entries {\n            let entry = entry.map_err(|e| {\n                EngramError::InvalidOperation(format!(\"Failed to read file entry: {}\", e))\n            })?;\n            let path = entry.path();\n\n            if path.extension().map_or(false, |ext| ext == \"json\") {\n                stats.entities_processed += 1;\n\n                match self.migrate_single_entity(entity_type, \u0026path) {\n                    Ok(_) =\u003e stats.entities_migrated += 1,\n                    Err(e) =\u003e {\n                        stats.entities_failed += 1;\n                        eprintln!(\"   ‚ö†Ô∏è  Failed to migrate {}: {}\", path.display(), e);\n                    }\n                }\n            }\n        }\n\n        Ok(stats)\n    }\n\n    /// Migrate a single entity file\n    fn migrate_single_entity(\n        \u0026mut self,\n        entity_type: \u0026str,\n        file_path: \u0026Path,\n    ) -\u003e Result\u003c(), EngramError\u003e {\n        // Read the MemoryEntity JSON file\n        let content = fs::read_to_string(file_path)\n            .map_err(|e| EngramError::InvalidOperation(format!(\"Failed to read file: {}\", e)))?;\n\n        let memory_entity: MemoryEntity = serde_json::from_str(\u0026content)\n            .map_err(|e| EngramError::Deserialization(e.to_string()))?;\n\n        // Convert to GenericEntity format expected by Git refs storage\n        let generic_entity = crate::entities::GenericEntity {\n            id: memory_entity.id.clone(),\n            entity_type: entity_type.to_string(),\n            agent: memory_entity.agent.clone(),\n            timestamp: memory_entity.timestamp,\n            data: serde_json::to_value(\u0026memory_entity.data)\n                .map_err(|e| EngramError::Serialization(e))?,\n        };\n\n        if !self.dry_run {\n            // Store in Git refs storage - just store the generic entity directly\n            self.target_storage.store(\u0026generic_entity)?;\n        }\n\n        Ok(())\n    }\n\n    /// Create backup of original .engram directory\n    pub fn create_backup(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        let timestamp = chrono::Utc::now().format(\"%Y%m%d_%H%M%S\");\n        let backup_path = self\n            .source_path\n            .parent()\n            .unwrap()\n            .join(format!(\".engram_backup_{}\", timestamp));\n\n        self.copy_dir_all(\u0026self.source_path, \u0026backup_path)?;\n        println!(\"   üì¶ Backup created at: {}\", backup_path.display());\n        Ok(())\n    }\n\n    /// Recursively copy directory\n    fn copy_dir_all(\u0026self, src: \u0026Path, dst: \u0026Path) -\u003e Result\u003c(), EngramError\u003e {\n        fs::create_dir_all(dst).map_err(|e| {\n            EngramError::InvalidOperation(format!(\"Failed to create backup directory: {}\", e))\n        })?;\n\n        for entry in fs::read_dir(src).map_err(|e| {\n            EngramError::InvalidOperation(format!(\"Failed to read source directory: {}\", e))\n        })? {\n            let entry = entry.map_err(|e| {\n                EngramError::InvalidOperation(format!(\"Failed to read directory entry: {}\", e))\n            })?;\n            let ty = entry.file_type().map_err(|e| {\n                EngramError::InvalidOperation(format!(\"Failed to get file type: {}\", e))\n            })?;\n\n            if ty.is_dir() {\n                self.copy_dir_all(\u0026entry.path(), \u0026dst.join(entry.file_name()))?;\n            } else {\n                fs::copy(\u0026entry.path(), \u0026dst.join(entry.file_name())).map_err(|e| {\n                    EngramError::InvalidOperation(format!(\"Failed to copy file: {}\", e))\n                })?;\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Validate that source data is ready for migration\n    pub fn validate_migration_readiness(workspace_path: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        let engram_path = PathBuf::from(workspace_path).join(\".engram\");\n\n        if !engram_path.exists() {\n            return Err(EngramError::NotFound(\n                \"No .engram directory found. Nothing to migrate.\".to_string(),\n            ));\n        }\n\n        // Check for Git repository in target location\n        let git_path = PathBuf::from(workspace_path).join(\".git\");\n        if !git_path.exists() {\n            return Err(EngramError::InvalidOperation(\n                \"No Git repository found. Git refs storage requires a Git repository.\".to_string(),\n            ));\n        }\n\n        // Basic validation of .engram structure\n        let git_engram_path = engram_path.join(\".git\");\n        if !git_engram_path.exists() {\n            return Err(EngramError::InvalidOperation(\n                \".engram directory is not a Git repository. Invalid source format.\".to_string(),\n            ));\n        }\n\n        println!(\"‚úÖ Migration readiness validated\");\n        println!(\"   üìÅ Source: {}\", engram_path.display());\n        println!(\"   üéØ Target: Git refs in {}\", git_path.display());\n\n        Ok(())\n    }\n}\n","traces":[{"line":31,"address":[18441872,18442552,18442558],"length":1,"stats":{"Line":0}},{"line":37,"address":[18994002],"length":1,"stats":{"Line":0}},{"line":38,"address":[18442188],"length":1,"stats":{"Line":0}},{"line":40,"address":[18442398],"length":1,"stats":{"Line":0}},{"line":41,"address":[18442359],"length":1,"stats":{"Line":0}},{"line":49,"address":[18442576,18445693,18446041],"length":1,"stats":{"Line":0}},{"line":50,"address":[18442612],"length":1,"stats":{"Line":0}},{"line":52,"address":[18442736,18442657],"length":1,"stats":{"Line":0}},{"line":53,"address":[18994905],"length":1,"stats":{"Line":0}},{"line":55,"address":[18442818,18442765],"length":1,"stats":{"Line":0}},{"line":59,"address":[18442790],"length":1,"stats":{"Line":0}},{"line":60,"address":[18995169,18997882],"length":1,"stats":{"Line":0}},{"line":61,"address":[18445813,18446008],"length":1,"stats":{"Line":0}},{"line":62,"address":[18445946],"length":1,"stats":{"Line":0}},{"line":64,"address":[18995158],"length":1,"stats":{"Line":0}},{"line":65,"address":[18443185],"length":1,"stats":{"Line":0}},{"line":68,"address":[18443178,18443248,18445773],"length":1,"stats":{"Line":0}},{"line":69,"address":[18995547,18995477],"length":1,"stats":{"Line":0}},{"line":71,"address":[18443611,18443801],"length":1,"stats":{"Line":0}},{"line":72,"address":[18443910,18444706],"length":1,"stats":{"Line":0}},{"line":73,"address":[18444783],"length":1,"stats":{"Line":0}},{"line":75,"address":[18445072,18445151],"length":1,"stats":{"Line":0}},{"line":76,"address":[18445117,18445216,18445257],"length":1,"stats":{"Line":0}},{"line":77,"address":[18445279,18445314,18445224],"length":1,"stats":{"Line":0}},{"line":80,"address":[18445332,18445287],"length":1,"stats":{"Line":0}},{"line":82,"address":[18445363],"length":1,"stats":{"Line":0}},{"line":88,"address":[18996019],"length":1,"stats":{"Line":0}},{"line":89,"address":[18996064],"length":1,"stats":{"Line":0}},{"line":90,"address":[18996168],"length":1,"stats":{"Line":0}},{"line":91,"address":[18996272],"length":1,"stats":{"Line":0}},{"line":92,"address":[18444238],"length":1,"stats":{"Line":0}},{"line":95,"address":[18444227,18444344],"length":1,"stats":{"Line":0}},{"line":96,"address":[18444433],"length":1,"stats":{"Line":0}},{"line":97,"address":[18444494],"length":1,"stats":{"Line":0}},{"line":100,"address":[18444355],"length":1,"stats":{"Line":0}},{"line":104,"address":[18440124,18440045,18437936],"length":1,"stats":{"Line":0}},{"line":105,"address":[18437975],"length":1,"stats":{"Line":0}},{"line":107,"address":[23147561,23147555,23147312],"length":1,"stats":{"Line":0}},{"line":108,"address":[15957323,15957391],"length":1,"stats":{"Line":0}},{"line":111,"address":[18438466,18438385,18438283],"length":1,"stats":{"Line":0}},{"line":112,"address":[22687187,22686944,22687193],"length":1,"stats":{"Line":0}},{"line":113,"address":[22687039,22686971],"length":1,"stats":{"Line":0}},{"line":115,"address":[18438960,18439027],"length":1,"stats":{"Line":0}},{"line":117,"address":[18439954,18439108,18439043],"length":1,"stats":{"Line":0}},{"line":118,"address":[18439160],"length":1,"stats":{"Line":0}},{"line":120,"address":[16028336,16028350],"length":1,"stats":{"Line":0}},{"line":125,"address":[18991370,18991302],"length":1,"stats":{"Line":0}},{"line":126,"address":[18439416,18439465],"length":1,"stats":{"Line":0}},{"line":127,"address":[18439479],"length":1,"stats":{"Line":0}},{"line":129,"address":[18991679],"length":1,"stats":{"Line":0}},{"line":134,"address":[23147931,23147888],"length":1,"stats":{"Line":0}},{"line":135,"address":[18990599],"length":1,"stats":{"Line":0}},{"line":139,"address":[18434082,18433024,18434103],"length":1,"stats":{"Line":0}},{"line":140,"address":[22685312,22685561,22685555],"length":1,"stats":{"Line":0}},{"line":141,"address":[15606047,15605979],"length":1,"stats":{"Line":0}},{"line":144,"address":[18984970,18985143,18985058],"length":1,"stats":{"Line":0}},{"line":145,"address":[15606473,15606467,15606224],"length":1,"stats":{"Line":0}},{"line":146,"address":[15804495,15804427],"length":1,"stats":{"Line":0}},{"line":148,"address":[18433858,18433783],"length":1,"stats":{"Line":0}},{"line":149,"address":[18434041],"length":1,"stats":{"Line":0}},{"line":152,"address":[18985256],"length":1,"stats":{"Line":0}},{"line":156,"address":[18985888,18987761,18987837],"length":1,"stats":{"Line":0}},{"line":161,"address":[18434231],"length":1,"stats":{"Line":0}},{"line":163,"address":[17272073,17272067,17271824],"length":1,"stats":{"Line":0}},{"line":164,"address":[16998415,16998347],"length":1,"stats":{"Line":0}},{"line":167,"address":[18986405,18986490,18986311],"length":1,"stats":{"Line":0}},{"line":168,"address":[16058320,16058569,16058563],"length":1,"stats":{"Line":0}},{"line":169,"address":[22685999,22685931],"length":1,"stats":{"Line":0}},{"line":171,"address":[18986896],"length":1,"stats":{"Line":0}},{"line":173,"address":[16027293,16027280],"length":1,"stats":{"Line":0}},{"line":174,"address":[18435311,18435374],"length":1,"stats":{"Line":0}},{"line":176,"address":[18987169,18987248],"length":1,"stats":{"Line":0}},{"line":177,"address":[18435524],"length":1,"stats":{"Line":0}},{"line":178,"address":[18435471],"length":1,"stats":{"Line":0}},{"line":179,"address":[18435626,18435497,18435593],"length":1,"stats":{"Line":0}},{"line":180,"address":[18435609,18435697],"length":1,"stats":{"Line":0}},{"line":186,"address":[18986598],"length":1,"stats":{"Line":0}},{"line":190,"address":[18987856,18989583,18989836],"length":1,"stats":{"Line":0}},{"line":196,"address":[18436236,18436122,18436156],"length":1,"stats":{"Line":0}},{"line":197,"address":[18987976,18988048],"length":1,"stats":{"Line":0}},{"line":199,"address":[18437918,18436403,18436449,18436546,18436327],"length":1,"stats":{"Line":0}},{"line":200,"address":[18436426,18436498],"length":1,"stats":{"Line":0}},{"line":204,"address":[18436651],"length":1,"stats":{"Line":0}},{"line":205,"address":[18436720],"length":1,"stats":{"Line":0}},{"line":206,"address":[18988644],"length":1,"stats":{"Line":0}},{"line":207,"address":[18436848],"length":1,"stats":{"Line":0}},{"line":208,"address":[18436878,18437069,18436981],"length":1,"stats":{"Line":0}},{"line":212,"address":[18437401],"length":1,"stats":{"Line":0}},{"line":214,"address":[18989295,18989404],"length":1,"stats":{"Line":0}},{"line":217,"address":[18437447],"length":1,"stats":{"Line":0}},{"line":221,"address":[18433005,18433011,18432016],"length":1,"stats":{"Line":0}},{"line":222,"address":[18983719],"length":1,"stats":{"Line":0}},{"line":223,"address":[18983789],"length":1,"stats":{"Line":0}},{"line":227,"address":[18983959],"length":1,"stats":{"Line":0}},{"line":229,"address":[18984131,18984220],"length":1,"stats":{"Line":0}},{"line":230,"address":[18432736],"length":1,"stats":{"Line":0}},{"line":231,"address":[18984608],"length":1,"stats":{"Line":0}},{"line":235,"address":[18981456,18983153,18983661],"length":1,"stats":{"Line":0}},{"line":236,"address":[16025571,16025577,16025328],"length":1,"stats":{"Line":0}},{"line":237,"address":[15954655,15954587],"length":1,"stats":{"Line":0}},{"line":240,"address":[23144553,23144304,23144547],"length":1,"stats":{"Line":0}},{"line":241,"address":[15605707,15605775],"length":1,"stats":{"Line":0}},{"line":243,"address":[18430454,18430589,18430515,18431997],"length":1,"stats":{"Line":0}},{"line":244,"address":[16056619,16056687],"length":1,"stats":{"Line":0}},{"line":246,"address":[16997699,16997456,16997705],"length":1,"stats":{"Line":0}},{"line":247,"address":[15804223,15804155],"length":1,"stats":{"Line":0}},{"line":250,"address":[18430958],"length":1,"stats":{"Line":0}},{"line":251,"address":[18982635,18983167],"length":1,"stats":{"Line":0}},{"line":253,"address":[18430979,18431239,18431036,18431117,18431350],"length":1,"stats":{"Line":0}},{"line":254,"address":[15605231,15605163],"length":1,"stats":{"Line":0}},{"line":259,"address":[18430479],"length":1,"stats":{"Line":0}},{"line":263,"address":[18993868,18992160,18993862],"length":1,"stats":{"Line":0}},{"line":264,"address":[18992215],"length":1,"stats":{"Line":0}},{"line":266,"address":[18992434],"length":1,"stats":{"Line":0}},{"line":267,"address":[18440550],"length":1,"stats":{"Line":0}},{"line":268,"address":[18440480],"length":1,"stats":{"Line":0}},{"line":273,"address":[18440535,18440655],"length":1,"stats":{"Line":0}},{"line":274,"address":[18440841],"length":1,"stats":{"Line":0}},{"line":275,"address":[18992983],"length":1,"stats":{"Line":0}},{"line":276,"address":[18440895],"length":1,"stats":{"Line":0}},{"line":281,"address":[18993093,18992958],"length":1,"stats":{"Line":0}},{"line":282,"address":[18441180,18441109],"length":1,"stats":{"Line":0}},{"line":283,"address":[18441266],"length":1,"stats":{"Line":0}},{"line":284,"address":[18441201],"length":1,"stats":{"Line":0}},{"line":288,"address":[18441383,18441232],"length":1,"stats":{"Line":0}},{"line":289,"address":[18441410],"length":1,"stats":{"Line":0}},{"line":290,"address":[18441592],"length":1,"stats":{"Line":0}},{"line":292,"address":[18441774],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":128},{"path":["/","home","shift","code","vincents-ai","engram","src","nlq","entity_extractor.rs"],"content":"use crate::error::EngramError;\nuse crate::nlq::ExtractedEntity;\nuse regex::Regex;\nuse std::collections::HashMap;\n\npub struct EntityExtractor {\n    extractors: HashMap\u003cString, Vec\u003cRegex\u003e\u003e,\n}\n\nimpl EntityExtractor {\n    pub fn new() -\u003e Self {\n        let mut extractors = HashMap::new();\n\n        extractors.insert(\n            \"agent\".to_string(),\n            vec![\n                Regex::new(r\"(?i)agent\\s+([a-zA-Z0-9_-]+)\").unwrap(),\n                Regex::new(r\"(?i)for\\s+([a-zA-Z0-9_-]+)\").unwrap(),\n            ],\n        );\n\n        extractors.insert(\n            \"task_id\".to_string(),\n            vec![\n                Regex::new(r\"task\\s+([a-f0-9-]{36})\").unwrap(),\n                Regex::new(r\"([a-f0-9-]{36})\").unwrap(),\n            ],\n        );\n\n        extractors.insert(\n            \"status\".to_string(),\n            vec![\n                Regex::new(r\"(?i)status\\s+(todo|done|in_progress|blocked|cancelled)\").unwrap(),\n                Regex::new(r\"(?i)(todo|done|in_progress|blocked|cancelled)\\s+tasks?\").unwrap(),\n                Regex::new(r\"(?i)(completed|finished)\\s+tasks?\").unwrap(),\n                Regex::new(r\"(?i)(pending|open)\\s+tasks?\").unwrap(),\n                Regex::new(r\"(?i)(current|inprogress|in\\s*progress)\\s+tasks?\").unwrap(),\n            ],\n        );\n\n        extractors.insert(\n            \"priority\".to_string(),\n            vec![\n                Regex::new(r\"(?i)priority\\s+(high|medium|low|critical|urgent)\").unwrap(),\n                Regex::new(r\"(?i)(high|medium|low|critical|urgent)\\s+priority\\s+tasks?\").unwrap(),\n                Regex::new(r\"(?i)(high|medium|low|critical|urgent)\\s+tasks?\").unwrap(),\n            ],\n        );\n\n        extractors.insert(\n            \"time_period\".to_string(),\n            vec![\n                Regex::new(r\"(?i)(today|yesterday|this\\s+week|last\\s+week)\").unwrap(),\n                Regex::new(r\"(?i)in\\s+the\\s+last\\s+(\\d+)\\s+(days?|weeks?|months?)\").unwrap(),\n            ],\n        );\n\n        Self { extractors }\n    }\n\n    pub fn extract(\u0026self, query: \u0026str) -\u003e Result\u003cVec\u003cExtractedEntity\u003e, EngramError\u003e {\n        let mut entities = Vec::new();\n\n        for (entity_type, regexes) in \u0026self.extractors {\n            for regex in regexes {\n                for captures in regex.captures_iter(query) {\n                    if let Some(matched) = captures.get(1) {\n                        entities.push(ExtractedEntity {\n                            entity_type: entity_type.clone(),\n                            value: matched.as_str().to_string(),\n                            confidence: 0.8,\n                            position: Some((matched.start(), matched.end())),\n                        });\n                    }\n                }\n            }\n        }\n\n        Ok(entities)\n    }\n\n    pub fn extract_specific(\n        \u0026self,\n        query: \u0026str,\n        entity_type: \u0026str,\n    ) -\u003e Result\u003cVec\u003cExtractedEntity\u003e, EngramError\u003e {\n        let mut entities = Vec::new();\n\n        if let Some(regexes) = self.extractors.get(entity_type) {\n            for regex in regexes {\n                for captures in regex.captures_iter(query) {\n                    if let Some(matched) = captures.get(1) {\n                        entities.push(ExtractedEntity {\n                            entity_type: entity_type.to_string(),\n                            value: matched.as_str().to_string(),\n                            confidence: 0.8,\n                            position: Some((matched.start(), matched.end())),\n                        });\n                    }\n                }\n            }\n        }\n\n        Ok(entities)\n    }\n}\n\nimpl Default for EntityExtractor {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_agent_extraction() {\n        let extractor = EntityExtractor::new();\n        let entities = extractor.extract(\"show tasks for alice\").unwrap();\n\n        assert_eq!(entities.len(), 1);\n        assert_eq!(entities[0].entity_type, \"agent\");\n        assert_eq!(entities[0].value, \"alice\");\n    }\n\n    #[test]\n    fn test_status_extraction() {\n        let extractor = EntityExtractor::new();\n        let entities = extractor.extract(\"show done tasks\").unwrap();\n\n        assert!(!entities.is_empty());\n        let status_entity = entities.iter().find(|e| e.entity_type == \"status\").unwrap();\n        assert_eq!(status_entity.value, \"done\");\n    }\n\n    #[test]\n    fn test_task_id_extraction() {\n        let extractor = EntityExtractor::new();\n        let task_id = \"550e8400-e29b-41d4-a716-446655440000\";\n        let query = format!(\"show task {}\", task_id);\n        let entities = extractor.extract(\u0026query).unwrap();\n\n        let task_entity = entities\n            .iter()\n            .find(|e| e.entity_type == \"task_id\")\n            .unwrap();\n        assert_eq!(task_entity.value, task_id);\n    }\n\n    #[test]\n    fn test_specific_extraction() {\n        let extractor = EntityExtractor::new();\n        let entities = extractor\n            .extract_specific(\"show tasks for bob\", \"agent\")\n            .unwrap();\n\n        assert_eq!(entities.len(), 1);\n        assert_eq!(entities[0].entity_type, \"agent\");\n        assert_eq!(entities[0].value, \"bob\");\n    }\n}\n","traces":[{"line":11,"address":[18430144,18433690,18433831],"length":1,"stats":{"Line":2}},{"line":12,"address":[20070657],"length":1,"stats":{"Line":2}},{"line":14,"address":[18581996],"length":1,"stats":{"Line":4}},{"line":15,"address":[18652303,18652231],"length":1,"stats":{"Line":5}},{"line":16,"address":[18652415,18652321,18652376,18652524,18652599,18655820],"length":1,"stats":{"Line":10}},{"line":17,"address":[18430368,18430443],"length":1,"stats":{"Line":9}},{"line":18,"address":[20070973,20071045],"length":1,"stats":{"Line":5}},{"line":22,"address":[18510182],"length":1,"stats":{"Line":3}},{"line":23,"address":[18509695],"length":1,"stats":{"Line":2}},{"line":24,"address":[25311522,25311670,25311464,25311745,25314369,25311561],"length":1,"stats":{"Line":8}},{"line":25,"address":[20071509,20071434],"length":1,"stats":{"Line":6}},{"line":26,"address":[18653135,18653063],"length":1,"stats":{"Line":9}},{"line":30,"address":[18432287],"length":1,"stats":{"Line":3}},{"line":31,"address":[18653409],"length":1,"stats":{"Line":3}},{"line":32,"address":[20154179,20154140,20154500,20156390,20154394,20154681,20154288,20154606,20154082],"length":1,"stats":{"Line":9}},{"line":33,"address":[18582756,18582831],"length":1,"stats":{"Line":6}},{"line":34,"address":[18653705,18653633],"length":1,"stats":{"Line":6}},{"line":35,"address":[18642219,18642291],"length":1,"stats":{"Line":5}},{"line":36,"address":[18510681,18510753],"length":1,"stats":{"Line":7}},{"line":37,"address":[18431935,18432007],"length":1,"stats":{"Line":6}},{"line":41,"address":[18655006],"length":1,"stats":{"Line":5}},{"line":42,"address":[20072858],"length":1,"stats":{"Line":2}},{"line":43,"address":[18512528,18511309,18511634,18511559,18511453,18511251,18511356],"length":1,"stats":{"Line":11}},{"line":44,"address":[18654568,18654493],"length":1,"stats":{"Line":9}},{"line":45,"address":[18643082,18643154],"length":1,"stats":{"Line":7}},{"line":46,"address":[18583940,18584012],"length":1,"stats":{"Line":9}},{"line":50,"address":[20156196],"length":1,"stats":{"Line":4}},{"line":51,"address":[25313657],"length":1,"stats":{"Line":5}},{"line":52,"address":[18433114,18433696,18433320,18433172,18433395,18433211],"length":1,"stats":{"Line":11}},{"line":53,"address":[20073676,20073751],"length":1,"stats":{"Line":10}},{"line":54,"address":[18512106,18512178],"length":1,"stats":{"Line":8}},{"line":61,"address":[18433856,18435195,18435201],"length":1,"stats":{"Line":2}},{"line":62,"address":[18644408],"length":1,"stats":{"Line":3}},{"line":64,"address":[18655947,18656007],"length":1,"stats":{"Line":5}},{"line":65,"address":[20074773,20074636],"length":1,"stats":{"Line":5}},{"line":66,"address":[20157166,20157039],"length":1,"stats":{"Line":5}},{"line":67,"address":[18513427,18513500],"length":1,"stats":{"Line":5}},{"line":68,"address":[18645548],"length":1,"stats":{"Line":2}},{"line":69,"address":[25776060],"length":1,"stats":{"Line":2}},{"line":70,"address":[18645412,18645341],"length":1,"stats":{"Line":4}},{"line":72,"address":[20075439,20075500],"length":1,"stats":{"Line":5}},{"line":79,"address":[18656187],"length":1,"stats":{"Line":3}},{"line":82,"address":[25310716,25310710,25309408],"length":1,"stats":{"Line":1}},{"line":87,"address":[25309490],"length":1,"stats":{"Line":1}},{"line":89,"address":[20151570,20151635],"length":1,"stats":{"Line":2}},{"line":90,"address":[18639546,18639686],"length":1,"stats":{"Line":2}},{"line":91,"address":[18429312,18429439],"length":1,"stats":{"Line":2}},{"line":92,"address":[18640064,18640137],"length":1,"stats":{"Line":2}},{"line":93,"address":[18508876],"length":1,"stats":{"Line":1}},{"line":94,"address":[20152354],"length":1,"stats":{"Line":1}},{"line":95,"address":[18581011,18581082],"length":1,"stats":{"Line":2}},{"line":97,"address":[18429861,18429922],"length":1,"stats":{"Line":2}},{"line":104,"address":[25770345],"length":1,"stats":{"Line":1}},{"line":109,"address":[20157856],"length":1,"stats":{"Line":0}},{"line":110,"address":[18435224],"length":1,"stats":{"Line":0}}],"covered":53,"coverable":55},{"path":["/","home","shift","code","vincents-ai","engram","src","nlq","intent_classifier.rs"],"content":"use crate::error::EngramError;\nuse crate::nlq::QueryIntent;\nuse regex::Regex;\nuse std::collections::HashMap;\n\n/// Intent classifier using pattern matching for natural language queries\npub struct IntentClassifier {\n    patterns: HashMap\u003cQueryIntent, Vec\u003cRegex\u003e\u003e,\n}\n\nimpl IntentClassifier {\n    pub fn new() -\u003e Self {\n        let mut patterns = HashMap::new();\n\n        // List tasks patterns\n        patterns.insert(\n            QueryIntent::ListTasks,\n            vec![\n                Regex::new(r\"(?i)^(show|list|get)\\s+(my\\s+)?tasks?\").unwrap(),\n                Regex::new(r\"(?i)^(show|list|get|find)\\s+(me\\s+)?(the\\s+)?tasks?\\s+(about|with|containing|titled|called)\").unwrap(),\n                Regex::new(r\"(?i)^what\\s+tasks?\\s+(do\\s+i\\s+have|am\\s+i\\s+working\\s+on)\").unwrap(),\n                Regex::new(r\"(?i)^tasks?\\s+for\\s+\").unwrap(),\n                // Status-based patterns\n                Regex::new(r\"(?i)^(show|list|get)\\s+(done|completed|finished)\\s+tasks?\").unwrap(),\n                Regex::new(r\"(?i)^(show|list|get)\\s+(todo|pending|open)\\s+tasks?\").unwrap(),\n                Regex::new(r\"(?i)^(show|list|get)\\s+(in\\s*progress|inprogress|current)\\s+tasks?\")\n                    .unwrap(),\n                // Priority-based patterns\n                Regex::new(r\"(?i)^(show|list|get)\\s+(high|medium|low)\\s+priority\\s+tasks?\")\n                    .unwrap(),\n                Regex::new(r\"(?i)^(show|list|get)\\s+(urgent|critical)\\s+tasks?\").unwrap(),\n            ],\n        );\n\n        // Show task details patterns\n        patterns.insert(\n            QueryIntent::ShowTaskDetails,\n            vec![\n                Regex::new(r\"(?i)^(show|get|details?\\s+of)\\s+task\\s+\").unwrap(),\n                Regex::new(r\"(?i)^what\\s+(is|about)\\s+task\\s+\").unwrap(),\n            ],\n        );\n\n        // Find relationships patterns\n        patterns.insert(\n            QueryIntent::FindRelationships,\n            vec![\n                Regex::new(r\"(?i)what\\s+tasks?\\s+(depend\\s+on|are\\s+related\\s+to)\").unwrap(),\n                Regex::new(r\"(?i)(dependencies|dependents)\\s+(of|for)\\s+\").unwrap(),\n                Regex::new(r\"(?i)^(show|find|get)\\s+(relationship|dependencies|dependents)\")\n                    .unwrap(),\n            ],\n        );\n\n        // Search context patterns\n        patterns.insert(\n            QueryIntent::SearchContext,\n            vec![\n                Regex::new(r\"(?i)^(find|search|get)\\s+(context|background)\").unwrap(),\n                Regex::new(r\"(?i)what\\s+(context|information|background)\").unwrap(),\n            ],\n        );\n\n        // Analyze workflow patterns\n        patterns.insert(\n            QueryIntent::AnalyzeWorkflow,\n            vec![\n                Regex::new(r\"(?i)^(show|get)\\s+(workflow|status)\").unwrap(),\n                Regex::new(r\"(?i)workflow\\s+(status|state)\").unwrap(),\n            ],\n        );\n\n        // List skills patterns\n        patterns.insert(\n            QueryIntent::ListSkills,\n            vec![\n                Regex::new(r\"(?i)^(list|show|get)\\s+(all\\s+)?skills\").unwrap(),\n                Regex::new(r\"(?i)what\\s+skills?\\s+(do\\s+i\\s+have|are\\s+available|exist)\").unwrap(),\n                Regex::new(r\"(?i)show\\s+me\\s+(the\\s+)?skills\").unwrap(),\n                Regex::new(r\"(?i)available\\s+skills\").unwrap(),\n            ],\n        );\n\n        // Search skills patterns\n        patterns.insert(\n            QueryIntent::SearchSkills,\n            vec![\n                Regex::new(r\"(?i)skills?\\s+(for|related\\s+to|about)\\s+\").unwrap(),\n                Regex::new(r\"(?i)find\\s+(me\\s+)?(a\\s+)?skill\").unwrap(),\n                Regex::new(r\"(?i)what\\s+(skill|ability|capability)\").unwrap(),\n                Regex::new(r\"(?i)skill\\s+(to|for)\\s+\").unwrap(),\n            ],\n        );\n\n        // List prompts patterns\n        patterns.insert(\n            QueryIntent::ListPrompts,\n            vec![\n                Regex::new(r\"(?i)^(list|show|get)\\s+(all\\s+)?prompts?\").unwrap(),\n                Regex::new(r\"(?i)what\\s+prompts?\\s+(do\\s+i\\s+have|are\\s+available|exist)\").unwrap(),\n                Regex::new(r\"(?i)show\\s+me\\s+(the\\s+)?prompts?\").unwrap(),\n                Regex::new(r\"(?i)available\\s+prompts?\").unwrap(),\n                Regex::new(r\"(?i)agent\\s+prompts?\").unwrap(),\n                Regex::new(r\"(?i)pipeline\\s+prompts?\").unwrap(),\n            ],\n        );\n\n        // Search prompts patterns\n        patterns.insert(\n            QueryIntent::SearchPrompts,\n            vec![\n                Regex::new(r\"(?i)prompts?\\s+(for|related\\s+to|about)\\s+\").unwrap(),\n                Regex::new(r\"(?i)find\\s+(me\\s+)?(a\\s+)?prompt\").unwrap(),\n                Regex::new(r\"(?i)what\\s+(prompt|agent|pipeline)\").unwrap(),\n                Regex::new(r\"(?i)prompt\\s+(to|for)\\s+\").unwrap(),\n                Regex::new(r\"(?i)agent\\s+(to|for)\\s+\").unwrap(),\n            ],\n        );\n\n        Self { patterns }\n    }\n\n    /// Classify the intent of a natural language query\n    pub fn classify(\u0026self, query: \u0026str) -\u003e Result\u003cQueryIntent, EngramError\u003e {\n        let trimmed_query = query.trim();\n\n        // Check patterns in order of specificity (most specific first)\n        let intent_order = vec![\n            QueryIntent::ShowTaskDetails,\n            QueryIntent::FindRelationships,\n            QueryIntent::SearchContext,\n            QueryIntent::AnalyzeWorkflow,\n            QueryIntent::SearchSkills,\n            QueryIntent::ListSkills,\n            QueryIntent::SearchPrompts,\n            QueryIntent::ListPrompts,\n            QueryIntent::ListTasks, // More general, check last\n        ];\n\n        for intent in intent_order {\n            if let Some(regexes) = self.patterns.get(\u0026intent) {\n                for regex in regexes {\n                    if regex.is_match(trimmed_query) {\n                        return Ok(intent.clone());\n                    }\n                }\n            }\n        }\n\n        Ok(QueryIntent::Unknown)\n    }\n\n    /// Get confidence score for a classification (0.0 to 1.0)\n    pub fn get_confidence(\u0026self, query: \u0026str, intent: \u0026QueryIntent) -\u003e f64 {\n        let trimmed_query = query.trim();\n\n        if let Some(regexes) = self.patterns.get(intent) {\n            for regex in regexes {\n                if regex.is_match(trimmed_query) {\n                    // Simple confidence based on pattern specificity\n                    return if regex.as_str().len() \u003e 20 { 0.9 } else { 0.7 };\n                }\n            }\n        }\n\n        0.0\n    }\n}\n\nimpl Default for IntentClassifier {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_list_tasks_classification() {\n        let classifier = IntentClassifier::new();\n\n        assert_eq!(\n            classifier.classify(\"show my tasks\").unwrap(),\n            QueryIntent::ListTasks\n        );\n        assert_eq!(\n            classifier.classify(\"list tasks\").unwrap(),\n            QueryIntent::ListTasks\n        );\n        assert_eq!(\n            classifier.classify(\"what tasks do i have\").unwrap(),\n            QueryIntent::ListTasks\n        );\n    }\n\n    #[test]\n    fn test_relationship_classification() {\n        let classifier = IntentClassifier::new();\n\n        assert_eq!(\n            classifier\n                .classify(\"what tasks depend on task-123\")\n                .unwrap(),\n            QueryIntent::FindRelationships\n        );\n        assert_eq!(\n            classifier.classify(\"show dependencies\").unwrap(),\n            QueryIntent::FindRelationships\n        );\n    }\n\n    #[test]\n    fn test_unknown_classification() {\n        let classifier = IntentClassifier::new();\n\n        assert_eq!(\n            classifier.classify(\"random unrelated question\").unwrap(),\n            QueryIntent::Unknown\n        );\n    }\n\n    #[test]\n    fn test_confidence_scoring() {\n        let classifier = IntentClassifier::new();\n\n        let confidence = classifier.get_confidence(\"show my tasks\", \u0026QueryIntent::ListTasks);\n        assert!(confidence \u003e 0.0);\n\n        let no_confidence = classifier.get_confidence(\"show my tasks\", \u0026QueryIntent::SearchContext);\n        assert_eq!(no_confidence, 0.0);\n    }\n}\n","traces":[{"line":12,"address":[19634272,19641237,19641288],"length":1,"stats":{"Line":2}},{"line":13,"address":[26975559],"length":1,"stats":{"Line":2}},{"line":16,"address":[19635732],"length":1,"stats":{"Line":2}},{"line":18,"address":[19634961,19634855,19634428,19635173,19634749,19634537,19634389,19635354,19635067,19634322,19634643,19641283,19635279],"length":1,"stats":{"Line":7}},{"line":19,"address":[20748157,20748232],"length":1,"stats":{"Line":5}},{"line":20,"address":[19785754,19785826],"length":1,"stats":{"Line":4}},{"line":21,"address":[19785860,19785932],"length":1,"stats":{"Line":5}},{"line":22,"address":[26515382,26515310],"length":1,"stats":{"Line":5}},{"line":24,"address":[21296888,21296960],"length":1,"stats":{"Line":4}},{"line":25,"address":[19856946,19857018],"length":1,"stats":{"Line":5}},{"line":26,"address":[20748796],"length":1,"stats":{"Line":2}},{"line":27,"address":[14916344],"length":1,"stats":{"Line":2}},{"line":29,"address":[26976406],"length":1,"stats":{"Line":2}},{"line":30,"address":[19857230],"length":1,"stats":{"Line":2}},{"line":31,"address":[19635248,19635320],"length":1,"stats":{"Line":6}},{"line":36,"address":[20749963],"length":1,"stats":{"Line":3}},{"line":38,"address":[20749614,20749723,20749558,20749798,20755038],"length":1,"stats":{"Line":4}},{"line":39,"address":[20749583,20749658],"length":1,"stats":{"Line":5}},{"line":40,"address":[21297996,21298068],"length":1,"stats":{"Line":6}},{"line":45,"address":[19847306],"length":1,"stats":{"Line":3}},{"line":47,"address":[26977592,26977807,26977882,26977701,26982537,26977536],"length":1,"stats":{"Line":4}},{"line":48,"address":[19636372,19636297],"length":1,"stats":{"Line":7}},{"line":49,"address":[21298542,21298470],"length":1,"stats":{"Line":6}},{"line":50,"address":[19787760],"length":1,"stats":{"Line":2}},{"line":51,"address":[26977848],"length":1,"stats":{"Line":2}},{"line":56,"address":[21299348],"length":1,"stats":{"Line":2}},{"line":58,"address":[26978199,26978308,26978143,26978383,26982532],"length":1,"stats":{"Line":7}},{"line":59,"address":[19788152,19788227],"length":1,"stats":{"Line":6}},{"line":60,"address":[19847509,19847581],"length":1,"stats":{"Line":7}},{"line":65,"address":[19848254],"length":1,"stats":{"Line":3}},{"line":67,"address":[21299582,21299657,21299417,21303327,21299473],"length":1,"stats":{"Line":7}},{"line":68,"address":[21299517,21299442],"length":1,"stats":{"Line":6}},{"line":69,"address":[21299551,21299623],"length":1,"stats":{"Line":4}},{"line":74,"address":[19638495],"length":1,"stats":{"Line":4}},{"line":76,"address":[19789527,19792506,19789452,19789131,19789075,19789240,19789346],"length":1,"stats":{"Line":4}},{"line":77,"address":[19859943,19859868],"length":1,"stats":{"Line":6}},{"line":78,"address":[19848457,19848529],"length":1,"stats":{"Line":8}},{"line":79,"address":[26518659,26518731],"length":1,"stats":{"Line":10}},{"line":80,"address":[14919326,14919398],"length":1,"stats":{"Line":10}},{"line":85,"address":[19849728],"length":1,"stats":{"Line":2}},{"line":87,"address":[19849225,19849331,19849512,19851749,19849116,19849060,19849437],"length":1,"stats":{"Line":5}},{"line":88,"address":[19860680,19860605],"length":1,"stats":{"Line":8}},{"line":89,"address":[20752458,20752530],"length":1,"stats":{"Line":4}},{"line":90,"address":[21300868,21300940],"length":1,"stats":{"Line":4}},{"line":91,"address":[19790230,19790158],"length":1,"stats":{"Line":7}},{"line":96,"address":[19862257],"length":1,"stats":{"Line":2}},{"line":98,"address":[21302029,21301421,21303312,21301365,21301636,21301954,21301848,21301530,21301742],"length":1,"stats":{"Line":6}},{"line":99,"address":[21301465,21301390],"length":1,"stats":{"Line":6}},{"line":100,"address":[21301571,21301499],"length":1,"stats":{"Line":5}},{"line":101,"address":[19861629,19861557],"length":1,"stats":{"Line":5}},{"line":102,"address":[21301711,21301783],"length":1,"stats":{"Line":4}},{"line":103,"address":[21301817,21301889],"length":1,"stats":{"Line":7}},{"line":104,"address":[19850355,19850427],"length":1,"stats":{"Line":6}},{"line":109,"address":[26982374],"length":1,"stats":{"Line":4}},{"line":111,"address":[20754447,20754126,20754341,20754553,20754235,20755003,20754070,20754628],"length":1,"stats":{"Line":5}},{"line":112,"address":[20754170,20754095],"length":1,"stats":{"Line":5}},{"line":113,"address":[19862532,19862460],"length":1,"stats":{"Line":8}},{"line":114,"address":[14921727,14921655],"length":1,"stats":{"Line":9}},{"line":115,"address":[26981920,26981992],"length":1,"stats":{"Line":8}},{"line":116,"address":[21302898,21302826],"length":1,"stats":{"Line":6}},{"line":124,"address":[21303376,21304189,21304195],"length":1,"stats":{"Line":2}},{"line":125,"address":[19851880],"length":1,"stats":{"Line":3}},{"line":128,"address":[19852130,19851911],"length":1,"stats":{"Line":2}},{"line":140,"address":[19852143,19852214,19852045],"length":1,"stats":{"Line":8}},{"line":141,"address":[26522363,26522435],"length":1,"stats":{"Line":5}},{"line":142,"address":[20755662],"length":1,"stats":{"Line":2}},{"line":143,"address":[20755807],"length":1,"stats":{"Line":3}},{"line":144,"address":[19852572],"length":1,"stats":{"Line":2}},{"line":150,"address":[19863830],"length":1,"stats":{"Line":2}},{"line":154,"address":[20747680],"length":1,"stats":{"Line":1}},{"line":155,"address":[21296050],"length":1,"stats":{"Line":1}},{"line":157,"address":[21296091],"length":1,"stats":{"Line":1}},{"line":158,"address":[19856095,19856127],"length":1,"stats":{"Line":2}},{"line":159,"address":[14915428],"length":1,"stats":{"Line":1}},{"line":161,"address":[26514791],"length":1,"stats":{"Line":1}},{"line":166,"address":[26975361],"length":1,"stats":{"Line":1}},{"line":171,"address":[20755904],"length":1,"stats":{"Line":0}},{"line":172,"address":[19642152],"length":1,"stats":{"Line":0}}],"covered":76,"coverable":78},{"path":["/","home","shift","code","vincents-ai","engram","src","nlq","mod.rs"],"content":"//! Natural Language Query Engine for Engram\n//!\n//! Provides conversational access to Engram's memory system through pattern matching\n//! and entity extraction. Maps natural language queries to structured Engram operations.\n\npub mod entity_extractor;\npub mod intent_classifier;\npub mod query_mapper;\npub mod response_formatter;\npub mod skills_prompts_handler;\n\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse serde::{Deserialize, Serialize};\n\npub use entity_extractor::EntityExtractor;\npub use intent_classifier::IntentClassifier;\npub use query_mapper::QueryMapper;\npub use response_formatter::ResponseFormatter;\npub use skills_prompts_handler::{\n    list_prompts, list_skills, search_prompts, search_skills, PromptInfo, PromptsQuery, SkillInfo,\n    SkillsQuery,\n};\n\n/// Main Natural Language Query Engine\npub struct NLQEngine {\n    intent_classifier: IntentClassifier,\n    entity_extractor: EntityExtractor,\n    query_mapper: QueryMapper,\n    response_formatter: ResponseFormatter,\n}\n\n/// Represents a processed natural language query\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ProcessedQuery {\n    pub original_query: String,\n    pub intent: QueryIntent,\n    pub entities: Vec\u003cExtractedEntity\u003e,\n    pub context: Option\u003cString\u003e,\n    pub confidence: f64,\n}\n\n/// Supported query intents\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, Hash)]\npub enum QueryIntent {\n    ListTasks,\n    ShowTaskDetails,\n    FindRelationships,\n    SearchContext,\n    AnalyzeWorkflow,\n    ListSkills,\n    SearchSkills,\n    ListPrompts,\n    SearchPrompts,\n    Unknown,\n}\n\n/// Extracted entities from natural language\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ExtractedEntity {\n    pub entity_type: String,\n    pub value: String,\n    pub confidence: f64,\n    pub position: Option\u003c(usize, usize)\u003e,\n}\n\n/// Query execution result\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct QueryResult {\n    pub success: bool,\n    pub data: serde_json::Value,\n    pub formatted_response: String,\n    pub execution_time_ms: u64,\n}\n\nimpl NLQEngine {\n    /// Create a new NLQ engine instance\n    pub fn new() -\u003e Self {\n        Self {\n            intent_classifier: IntentClassifier::new(),\n            entity_extractor: EntityExtractor::new(),\n            query_mapper: QueryMapper::new(),\n            response_formatter: ResponseFormatter::new(),\n        }\n    }\n\n    /// Process a natural language query and return results\n    pub async fn process_query(\n        \u0026self,\n        query: \u0026str,\n        context: Option\u003cString\u003e,\n        storage: \u0026dyn Storage,\n    ) -\u003e Result\u003cQueryResult, EngramError\u003e {\n        let start_time = std::time::Instant::now();\n\n        // Step 1: Classify intent\n        let intent = self.intent_classifier.classify(query)?;\n\n        // Step 2: Extract entities\n        let entities = self.entity_extractor.extract(query)?;\n\n        // Step 3: Create processed query\n        let processed_query = ProcessedQuery {\n            original_query: query.to_string(),\n            intent: intent.clone(),\n            entities,\n            context,\n            confidence: 0.8, // TODO: Calculate actual confidence\n        };\n\n        // Step 4: Map to storage query and execute\n        let data = self\n            .query_mapper\n            .execute_query(\u0026processed_query, storage)\n            .await?;\n\n        // Step 5: Format response\n        let formatted_response = self.response_formatter.format(\u0026processed_query, \u0026data)?;\n\n        let execution_time = start_time.elapsed().as_millis() as u64;\n\n        Ok(QueryResult {\n            success: true,\n            data,\n            formatted_response,\n            execution_time_ms: execution_time,\n        })\n    }\n\n    /// Get supported query patterns for help/documentation\n    pub fn get_supported_patterns(\u0026self) -\u003e Vec\u003cString\u003e {\n        vec![\n            \"show my tasks\".to_string(),\n            \"list tasks for agent X\".to_string(),\n            \"what tasks depend on task Y?\".to_string(),\n            \"find context for task Z\".to_string(),\n            \"show workflow status\".to_string(),\n        ]\n    }\n}\n\nimpl Default for NLQEngine {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_nlq_engine_creation() {\n        let engine = NLQEngine::new();\n        let patterns = engine.get_supported_patterns();\n        assert!(!patterns.is_empty());\n    }\n\n    #[test]\n    fn test_query_intent_serialization() {\n        let intent = QueryIntent::ListTasks;\n        let json = serde_json::to_string(\u0026intent).unwrap();\n        let deserialized: QueryIntent = serde_json::from_str(\u0026json).unwrap();\n        assert_eq!(intent, deserialized);\n    }\n}\n","traces":[{"line":78,"address":[14714320,14714525,14714519],"length":1,"stats":{"Line":2}},{"line":80,"address":[15959121],"length":1,"stats":{"Line":2}},{"line":81,"address":[15995952],"length":1,"stats":{"Line":2}},{"line":82,"address":[15959189],"length":1,"stats":{"Line":2}},{"line":83,"address":[15348371],"length":1,"stats":{"Line":2}},{"line":88,"address":[15347456],"length":1,"stats":{"Line":4}},{"line":94,"address":[18935774,18935628],"length":1,"stats":{"Line":6}},{"line":97,"address":[24175876,24176886],"length":1,"stats":{"Line":4}},{"line":100,"address":[18787046,18786319,18786253],"length":1,"stats":{"Line":5}},{"line":104,"address":[17517793],"length":1,"stats":{"Line":1}},{"line":105,"address":[17517862],"length":1,"stats":{"Line":5}},{"line":112,"address":[18787335,18786987,18788314,18786883,18787438,18787269],"length":1,"stats":{"Line":7}},{"line":114,"address":[17303259],"length":1,"stats":{"Line":1}},{"line":115,"address":[16999153],"length":1,"stats":{"Line":8}},{"line":118,"address":[17448107,17448024],"length":1,"stats":{"Line":2}},{"line":120,"address":[17507641,17507564],"length":1,"stats":{"Line":2}},{"line":122,"address":[17304398],"length":1,"stats":{"Line":1}},{"line":124,"address":[18937694],"length":1,"stats":{"Line":1}},{"line":125,"address":[24638494],"length":1,"stats":{"Line":1}},{"line":131,"address":[21845069,21844416,21845063],"length":1,"stats":{"Line":1}},{"line":132,"address":[14654608,14654473,14655034,14654674,14654542,14654781,14654435,14654743],"length":1,"stats":{"Line":2}},{"line":133,"address":[15995293],"length":1,"stats":{"Line":1}},{"line":134,"address":[15347682],"length":1,"stats":{"Line":1}},{"line":135,"address":[15347748],"length":1,"stats":{"Line":1}},{"line":136,"address":[14654646],"length":1,"stats":{"Line":1}},{"line":137,"address":[21844728],"length":1,"stats":{"Line":1}},{"line":143,"address":[21382848],"length":1,"stats":{"Line":0}},{"line":144,"address":[15346680],"length":1,"stats":{"Line":0}}],"covered":26,"coverable":28},{"path":["/","home","shift","code","vincents-ai","engram","src","nlq","query_mapper.rs"],"content":"use crate::entities::Entity;\nuse crate::error::EngramError;\nuse crate::nlq::{\n    list_prompts, list_skills, search_prompts, search_skills, ExtractedEntity, ProcessedQuery,\n    PromptsQuery, QueryIntent, SkillsQuery,\n};\nuse crate::storage::{GitStorage, RelationshipStorage, Storage};\nuse serde_json::{json, Value};\n\npub struct QueryMapper;\n\nimpl QueryMapper {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    pub async fn execute_query(\n        \u0026self,\n        processed_query: \u0026ProcessedQuery,\n        storage: \u0026dyn Storage,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        match \u0026processed_query.intent {\n            QueryIntent::ListTasks =\u003e self.handle_list_tasks(processed_query, storage).await,\n            QueryIntent::ShowTaskDetails =\u003e {\n                self.handle_task_details(processed_query, storage).await\n            }\n            QueryIntent::FindRelationships =\u003e {\n                self.handle_relationships(processed_query, storage).await\n            }\n            QueryIntent::SearchContext =\u003e {\n                self.handle_search_context(processed_query, storage).await\n            }\n            QueryIntent::AnalyzeWorkflow =\u003e {\n                self.handle_workflow_analysis(processed_query, storage)\n                    .await\n            }\n            QueryIntent::ListSkills =\u003e self.handle_list_skills(processed_query).await,\n            QueryIntent::SearchSkills =\u003e self.handle_search_skills(processed_query).await,\n            QueryIntent::ListPrompts =\u003e self.handle_list_prompts(processed_query).await,\n            QueryIntent::SearchPrompts =\u003e self.handle_search_prompts(processed_query).await,\n            QueryIntent::Unknown =\u003e Ok(json!({\n                \"error\": \"Unable to understand the query\",\n                \"suggestion\": \"Try queries like 'show my tasks' or 'what skills are available for planning?'\"\n            })),\n        }\n    }\n\n    // Skills/Prompts handlers\n    async fn handle_list_skills(\n        \u0026self,\n        _processed_query: \u0026ProcessedQuery,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        let skills = list_skills(\u0026SkillsQuery {\n            category: None,\n            search_term: None,\n            format: \"full\".to_string(),\n        })?;\n\n        let skill_list: Vec\u003cValue\u003e = skills\n            .iter()\n            .map(|s| {\n                json!({\n                    \"name\": s.name,\n                    \"description\": s.description,\n                    \"category\": s.category,\n                })\n            })\n            .collect();\n\n        Ok(json!({\n            \"success\": true,\n            \"type\": \"skills_list\",\n            \"count\": skills.len(),\n            \"skills\": skill_list,\n        }))\n    }\n\n    async fn handle_search_skills(\n        \u0026self,\n        processed_query: \u0026ProcessedQuery,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        let query = \u0026processed_query.original_query;\n        let skills = search_skills(query)?;\n\n        let skill_list: Vec\u003cValue\u003e = skills\n            .iter()\n            .map(|s| {\n                json!({\n                    \"name\": s.name,\n                    \"description\": s.description,\n                    \"category\": s.category,\n                })\n            })\n            .collect();\n\n        Ok(json!({\n            \"success\": true,\n            \"type\": \"skills_search\",\n            \"query\": query,\n            \"count\": skills.len(),\n            \"skills\": skill_list,\n        }))\n    }\n\n    async fn handle_list_prompts(\n        \u0026self,\n        _processed_query: \u0026ProcessedQuery,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        let prompts = list_prompts(\u0026PromptsQuery {\n            category: None,\n            search_term: None,\n            format: \"full\".to_string(),\n        })?;\n\n        let prompt_list: Vec\u003cValue\u003e = prompts\n            .iter()\n            .map(|p| {\n                json!({\n                    \"name\": p.name,\n                    \"title\": p.title,\n                    \"description\": p.description,\n                    \"category\": p.category,\n                })\n            })\n            .collect();\n\n        Ok(json!({\n            \"success\": true,\n            \"type\": \"prompts_list\",\n            \"count\": prompts.len(),\n            \"prompts\": prompt_list,\n        }))\n    }\n\n    async fn handle_search_prompts(\n        \u0026self,\n        processed_query: \u0026ProcessedQuery,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        let query = \u0026processed_query.original_query;\n        let prompts = search_prompts(query)?;\n\n        let prompt_list: Vec\u003cValue\u003e = prompts\n            .iter()\n            .map(|p| {\n                json!({\n                    \"name\": p.name,\n                    \"title\": p.title,\n                    \"description\": p.description,\n                    \"category\": p.category,\n                })\n            })\n            .collect();\n\n        Ok(json!({\n            \"success\": true,\n            \"type\": \"prompts_search\",\n            \"query\": query,\n            \"count\": prompts.len(),\n            \"prompts\": prompt_list,\n        }))\n    }\n\n    async fn handle_list_tasks(\n        \u0026self,\n        processed_query: \u0026ProcessedQuery,\n        storage: \u0026dyn Storage,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        let agent = self.extract_agent_or_default(\u0026processed_query.entities);\n        let status = self.extract_status(\u0026processed_query.entities);\n        let priority = self.extract_priority(\u0026processed_query.entities);\n        let title_search = self.extract_title_search(\u0026processed_query.original_query);\n\n        let tasks = storage.query_by_agent(\u0026agent, Some(\"task\"))?;\n\n        let mut filtered_tasks = Vec::new();\n        for task_entity in tasks {\n            if let Ok(task) = crate::entities::Task::from_generic(task_entity) {\n                let mut include_task = true;\n\n                // Filter by status if specified\n                if let Some(status_filter) = \u0026status {\n                    let task_status = format!(\"{:?}\", task.status).to_lowercase();\n                    let status_lower = status_filter.to_lowercase();\n                    let normalized_filter = match status_lower.as_str() {\n                        \"completed\" | \"finished\" =\u003e \"done\",\n                        \"pending\" | \"open\" =\u003e \"todo\",\n                        \"current\" | \"inprogress\" | \"in progress\" =\u003e \"inprogress\",\n                        other =\u003e other,\n                    };\n                    include_task = task_status == normalized_filter;\n                }\n\n                // Filter by priority if specified\n                if include_task {\n                    if let Some(priority_filter) = \u0026priority {\n                        let task_priority = format!(\"{:?}\", task.priority).to_lowercase();\n                        let priority_lower = priority_filter.to_lowercase();\n                        let normalized_priority = match priority_lower.as_str() {\n                            \"critical\" | \"urgent\" =\u003e \"high\",\n                            other =\u003e other,\n                        };\n                        include_task = task_priority == normalized_priority;\n                    }\n                }\n\n                // Filter by title search if specified\n                if include_task \u0026\u0026 !title_search.is_empty() {\n                    let title_lower = task.title.to_lowercase();\n                    let search_lower = title_search.to_lowercase();\n                    include_task = title_lower.contains(\u0026search_lower);\n                }\n\n                if include_task {\n                    filtered_tasks.push(json!({\n                        \"id\": task.id,\n                        \"title\": task.title,\n                        \"status\": format!(\"{:?}\", task.status),\n                        \"priority\": format!(\"{:?}\", task.priority),\n                    }));\n                }\n            }\n        }\n\n        Ok(json!({\n            \"tasks\": filtered_tasks,\n            \"count\": filtered_tasks.len(),\n            \"agent\": agent,\n            \"status_filter\": status,\n            \"priority_filter\": priority,\n            \"title_search\": if title_search.is_empty() { None } else { Some(title_search) }\n        }))\n    }\n\n    async fn handle_task_details(\n        \u0026self,\n        processed_query: \u0026ProcessedQuery,\n        storage: \u0026dyn Storage,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        if let Some(task_id) = self.extract_task_id(\u0026processed_query.entities) {\n            if let Some(task_entity) = storage.get(\u0026task_id, \"task\")? {\n                if let Ok(task) = crate::entities::Task::from_generic(task_entity) {\n                    return Ok(json!({\n                        \"task\": {\n                            \"id\": task.id,\n                            \"title\": task.title,\n                            \"description\": task.description,\n                            \"status\": format!(\"{:?}\", task.status),\n                            \"priority\": format!(\"{:?}\", task.priority),\n                            \"agent\": task.agent,\n                            \"created\": task.start_time,\n                            \"outcome\": task.outcome\n                        }\n                    }));\n                }\n            }\n        }\n\n        Ok(json!({\n            \"error\": \"Task not found or no task ID provided\"\n        }))\n    }\n\n    async fn handle_relationships(\n        \u0026self,\n        processed_query: \u0026ProcessedQuery,\n        storage: \u0026dyn Storage,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        if let Some(task_id) = self.extract_task_id(\u0026processed_query.entities) {\n            if let Some(git_storage) = storage.as_any().downcast_ref::\u003cGitStorage\u003e() {\n                let relationships = git_storage.get_entity_relationships(\u0026task_id)?;\n\n                let mut related_entities = Vec::new();\n                for rel in relationships {\n                    related_entities.push(json!({\n                        \"type\": format!(\"{:?}\", rel.relationship_type),\n                        \"source\": rel.source_id,\n                        \"target\": rel.target_id,\n                        \"strength\": format!(\"{:?}\", rel.strength)\n                    }));\n                }\n\n                return Ok(json!({\n                    \"task_id\": task_id,\n                    \"relationships\": related_entities,\n                    \"count\": related_entities.len()\n                }));\n            } else {\n                let mut related_entities = Vec::new();\n                related_entities.push(json!({\n                    \"type\": \"placeholder\",\n                    \"source\": task_id.clone(),\n                    \"target\": \"storage_type_not_supported\",\n                    \"strength\": \"Medium\"\n                }));\n\n                return Ok(json!({\n                    \"task_id\": task_id,\n                    \"relationships\": related_entities,\n                    \"count\": related_entities.len()\n                }));\n            }\n        }\n\n        Ok(json!({\n            \"error\": \"No task ID found in query\"\n        }))\n    }\n\n    async fn handle_search_context(\n        \u0026self,\n        processed_query: \u0026ProcessedQuery,\n        storage: \u0026dyn Storage,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        let agent = self.extract_agent_or_default(\u0026processed_query.entities);\n        let search_term =\n            self.extract_search_term(\u0026processed_query.entities, \u0026processed_query.original_query);\n        let contexts = storage.query_by_agent(\u0026agent, Some(\"context\"))?;\n        let mut context_list = Vec::new();\n\n        for context_entity in contexts.into_iter().take(10) {\n            if let Ok(context) = crate::entities::Context::from_generic(context_entity) {\n                // Filter contexts based on search term\n                if search_term.is_empty()\n                    || context\n                        .title\n                        .to_lowercase()\n                        .contains(\u0026search_term.to_lowercase())\n                    || context\n                        .content\n                        .to_lowercase()\n                        .contains(\u0026search_term.to_lowercase())\n                {\n                    context_list.push(json!({\n                        \"id\": context.id,\n                        \"title\": context.title,\n                        \"relevance\": format!(\"{:?}\", context.relevance),\n                    }));\n                }\n            }\n        }\n\n        Ok(json!({\n            \"contexts\": context_list,\n            \"count\": context_list.len(),\n            \"agent\": agent,\n            \"search_term\": search_term\n        }))\n    }\n\n    async fn handle_workflow_analysis(\n        \u0026self,\n        processed_query: \u0026ProcessedQuery,\n        storage: \u0026dyn Storage,\n    ) -\u003e Result\u003cValue, EngramError\u003e {\n        let agent = self.extract_agent_or_default(\u0026processed_query.entities);\n        let workflows = storage.query_by_agent(\u0026agent, Some(\"workflow\"))?;\n        let mut workflow_status = Vec::new();\n\n        for workflow_entity in workflows {\n            if let Ok(workflow) = crate::entities::Workflow::from_generic(workflow_entity) {\n                workflow_status.push(json!({\n                    \"id\": workflow.id,\n                    \"title\": workflow.title,\n                    \"current_state\": workflow.initial_state.clone(),\n                    \"status\": format!(\"{:?}\", workflow.status)\n                }));\n            }\n        }\n\n        Ok(json!({\n            \"workflows\": workflow_status,\n            \"count\": workflow_status.len()\n        }))\n    }\n\n    fn extract_agent_or_default(\u0026self, entities: \u0026[ExtractedEntity]) -\u003e String {\n        entities\n            .iter()\n            .find(|e| e.entity_type == \"agent\")\n            .map(|e| e.value.clone())\n            .unwrap_or_else(|| \"default\".to_string())\n    }\n\n    fn extract_status(\u0026self, entities: \u0026[ExtractedEntity]) -\u003e Option\u003cString\u003e {\n        entities\n            .iter()\n            .find(|e| e.entity_type == \"status\")\n            .map(|e| e.value.clone())\n    }\n\n    fn extract_priority(\u0026self, entities: \u0026[ExtractedEntity]) -\u003e Option\u003cString\u003e {\n        entities\n            .iter()\n            .find(|e| e.entity_type == \"priority\")\n            .map(|e| e.value.clone())\n    }\n\n    fn extract_task_id(\u0026self, entities: \u0026[ExtractedEntity]) -\u003e Option\u003cString\u003e {\n        entities\n            .iter()\n            .find(|e| e.entity_type == \"task_id\")\n            .map(|e| e.value.clone())\n    }\n\n    fn extract_search_term(\u0026self, entities: \u0026[ExtractedEntity], query: \u0026str) -\u003e String {\n        let lower_query = query.to_lowercase();\n\n        if let Some(start) = lower_query.find(\"about \") {\n            let start_idx = start + 6;\n            let remaining = \u0026query[start_idx..];\n\n            if let Some(for_idx) = remaining.find(\" for \") {\n                remaining[..for_idx].trim().to_string()\n            } else {\n                remaining.trim().to_string()\n            }\n        } else if let Some(context_entity) = entities.iter().find(|e| e.entity_type == \"context\") {\n            context_entity.value.clone()\n        } else {\n            String::new()\n        }\n    }\n\n    fn extract_title_search(\u0026self, query: \u0026str) -\u003e String {\n        let lower_query = query.to_lowercase();\n\n        let search_keywords = [\"about\", \"with\", \"containing\", \"titled\", \"called\"];\n        for keyword in \u0026search_keywords {\n            if let Some(start) = lower_query.find(\u0026format!(\"{} \", keyword)) {\n                let start_idx = start + keyword.len() + 1;\n                let remaining = \u0026query[start_idx..];\n\n                if let Some(for_idx) = remaining.find(\" for \") {\n                    return remaining[..for_idx].trim().to_string();\n                } else {\n                    return remaining.trim().to_string();\n                }\n            }\n        }\n\n        String::new()\n    }\n}\n\nimpl Default for QueryMapper {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::nlq::QueryIntent;\n\n    #[test]\n    fn test_agent_extraction() {\n        let mapper = QueryMapper::new();\n        let entities = vec![ExtractedEntity {\n            entity_type: \"agent\".to_string(),\n            value: \"alice\".to_string(),\n            confidence: 0.8,\n            position: None,\n        }];\n\n        let agent = mapper.extract_agent_or_default(\u0026entities);\n        assert_eq!(agent, \"alice\");\n    }\n\n    #[test]\n    fn test_default_agent_extraction() {\n        let mapper = QueryMapper::new();\n        let entities = vec![];\n\n        let agent = mapper.extract_agent_or_default(\u0026entities);\n        assert_eq!(agent, \"default\");\n    }\n\n    #[test]\n    fn test_task_id_extraction() {\n        let mapper = QueryMapper::new();\n        let task_id = \"550e8400-e29b-41d4-a716-446655440000\";\n        let entities = vec![ExtractedEntity {\n            entity_type: \"task_id\".to_string(),\n            value: task_id.to_string(),\n            confidence: 0.8,\n            position: None,\n        }];\n\n        let extracted = mapper.extract_task_id(\u0026entities);\n        assert_eq!(extracted, Some(task_id.to_string()));\n    }\n}\n","traces":[{"line":17,"address":[16696080],"length":1,"stats":{"Line":2}},{"line":22,"address":[26716327],"length":1,"stats":{"Line":3}},{"line":23,"address":[17112623],"length":1,"stats":{"Line":4}},{"line":25,"address":[19989560,19987286,19987064,19987706],"length":1,"stats":{"Line":0}},{"line":28,"address":[18531147],"length":1,"stats":{"Line":2}},{"line":31,"address":[17041921],"length":1,"stats":{"Line":2}},{"line":34,"address":[20931572,20932144,20934645],"length":1,"stats":{"Line":0}},{"line":35,"address":[17041943],"length":1,"stats":{"Line":0}},{"line":37,"address":[15112520,15115524,15113062,15112236],"length":1,"stats":{"Line":0}},{"line":38,"address":[23771331],"length":1,"stats":{"Line":0}},{"line":39,"address":[16897897],"length":1,"stats":{"Line":0}},{"line":40,"address":[15112604,15112299,15113326,15116271],"length":1,"stats":{"Line":0}},{"line":41,"address":[15112622,15114216,15113504,15113801,15113397,15113735,15113435,15114178],"length":1,"stats":{"Line":2}},{"line":49,"address":[16511792],"length":1,"stats":{"Line":0}},{"line":53,"address":[20001024,20000754,20000921],"length":1,"stats":{"Line":0}},{"line":54,"address":[20944801],"length":1,"stats":{"Line":0}},{"line":55,"address":[27190665],"length":1,"stats":{"Line":0}},{"line":56,"address":[20000657],"length":1,"stats":{"Line":0}},{"line":59,"address":[19849931],"length":1,"stats":{"Line":0}},{"line":61,"address":[20001246,20003570,20002720,20003617],"length":1,"stats":{"Line":0}},{"line":62,"address":[20003548,20003576,20003324,20002757,20002898,20003105],"length":1,"stats":{"Line":0}},{"line":70,"address":[20945706,20945515,20945962,20946253,20946026,20946709,20946323,20945464,20946737,20945775,20946080],"length":1,"stats":{"Line":0}},{"line":73,"address":[20072613,20072680],"length":1,"stats":{"Line":0}},{"line":78,"address":[16514336],"length":1,"stats":{"Line":0}},{"line":82,"address":[20019855],"length":1,"stats":{"Line":0}},{"line":83,"address":[26751252,26749204,26749302],"length":1,"stats":{"Line":0}},{"line":85,"address":[19868930],"length":1,"stats":{"Line":0}},{"line":87,"address":[21531102,21533665,21533618,21532768],"length":1,"stats":{"Line":0}},{"line":88,"address":[20966940,20966497,20966716,20966290,20966149,20966968],"length":1,"stats":{"Line":0}},{"line":96,"address":[20092562,20092590,20091112,20091163,20091423,20091354,20091610,20091924,20091677,20091977,20091861,20092150,20092220],"length":1,"stats":{"Line":0}},{"line":100,"address":[26750480,26750545],"length":1,"stats":{"Line":0}},{"line":105,"address":[23846944],"length":1,"stats":{"Line":0}},{"line":109,"address":[20063337,20063170,20063440],"length":1,"stats":{"Line":0}},{"line":110,"address":[20074577],"length":1,"stats":{"Line":0}},{"line":111,"address":[20947977],"length":1,"stats":{"Line":0}},{"line":112,"address":[20947985],"length":1,"stats":{"Line":0}},{"line":115,"address":[27194363],"length":1,"stats":{"Line":0}},{"line":117,"address":[27196986,27195904,27194430,27197055],"length":1,"stats":{"Line":0}},{"line":118,"address":[27195942,27196992,27196964,27196300,27196740,27196520,27196092],"length":1,"stats":{"Line":0}},{"line":127,"address":[20949877,20949491,20949905,20948943,20948683,20948632,20949194,20949248,20948874,20949130,20949421],"length":1,"stats":{"Line":0}},{"line":130,"address":[20075848,20075781],"length":1,"stats":{"Line":0}},{"line":135,"address":[18090064],"length":1,"stats":{"Line":0}},{"line":139,"address":[20972527],"length":1,"stats":{"Line":0}},{"line":140,"address":[20972532,20974580,20972630],"length":1,"stats":{"Line":0}},{"line":142,"address":[21539506],"length":1,"stats":{"Line":0}},{"line":144,"address":[27218814,27220480,27221562,27221631],"length":1,"stats":{"Line":0}},{"line":145,"address":[27220876,27220668,27220518,27221096,27221540,27221568,27221316],"length":1,"stats":{"Line":0}},{"line":154,"address":[26758511,26758200,26759012,26759065,26759650,26759678,26758442,26758765,26759238,26759308,26758251,26758949,26758698],"length":1,"stats":{"Line":0}},{"line":158,"address":[20029648,20029713],"length":1,"stats":{"Line":0}},{"line":163,"address":[16715104],"length":1,"stats":{"Line":2}},{"line":168,"address":[19992344,19992220],"length":1,"stats":{"Line":4}},{"line":169,"address":[20051619,20051718],"length":1,"stats":{"Line":4}},{"line":170,"address":[21503313,21503412],"length":1,"stats":{"Line":4}},{"line":171,"address":[20063391,20063490],"length":1,"stats":{"Line":2}},{"line":173,"address":[26722101,26722205],"length":1,"stats":{"Line":4}},{"line":175,"address":[19993102],"length":1,"stats":{"Line":2}},{"line":176,"address":[20052410,20052518,20052653],"length":1,"stats":{"Line":6}},{"line":177,"address":[26725407,26725324,26722918],"length":1,"stats":{"Line":6}},{"line":178,"address":[20066857],"length":1,"stats":{"Line":2}},{"line":181,"address":[15120897],"length":1,"stats":{"Line":2}},{"line":182,"address":[20055496,20055398],"length":1,"stats":{"Line":2}},{"line":183,"address":[21507345],"length":1,"stats":{"Line":1}},{"line":184,"address":[19996595,19996678],"length":1,"stats":{"Line":2}},{"line":185,"address":[20055964],"length":1,"stats":{"Line":1}},{"line":186,"address":[19996858],"length":1,"stats":{"Line":1}},{"line":187,"address":[26726344],"length":1,"stats":{"Line":1}},{"line":188,"address":[26726538],"length":1,"stats":{"Line":1}},{"line":190,"address":[20941386],"length":1,"stats":{"Line":1}},{"line":194,"address":[20940345],"length":1,"stats":{"Line":2}},{"line":195,"address":[26726660],"length":1,"stats":{"Line":2}},{"line":196,"address":[20068137],"length":1,"stats":{"Line":1}},{"line":197,"address":[20941845],"length":1,"stats":{"Line":1}},{"line":198,"address":[21508626,21508555],"length":1,"stats":{"Line":2}},{"line":199,"address":[21508658],"length":1,"stats":{"Line":1}},{"line":200,"address":[19997957],"length":1,"stats":{"Line":1}},{"line":202,"address":[19997989],"length":1,"stats":{"Line":1}},{"line":207,"address":[20941457,20942241],"length":1,"stats":{"Line":2}},{"line":208,"address":[21508918],"length":1,"stats":{"Line":0}},{"line":209,"address":[20942395,20942324],"length":1,"stats":{"Line":0}},{"line":210,"address":[20057510,20057578],"length":1,"stats":{"Line":0}},{"line":213,"address":[20057302],"length":1,"stats":{"Line":1}},{"line":214,"address":[27188568,27188863,27189546,27189269,27189125,27189768,27188498,27190177,27189047,27188796,27189624,27189795,27189296,27188453],"length":1,"stats":{"Line":4}},{"line":217,"address":[27189090,27189169],"length":1,"stats":{"Line":2}},{"line":218,"address":[26728917,26728996],"length":1,"stats":{"Line":4}},{"line":224,"address":[19842498,19842726,19842850,19842383,19844561,19843601,19844599,19843347,19842793,19844058,19843785,19842428,19843531,19844031,19843023,19843277,19843850,19843093],"length":1,"stats":{"Line":7}},{"line":226,"address":[26723434,26723358],"length":1,"stats":{"Line":4}},{"line":230,"address":[19843901,19843836],"length":1,"stats":{"Line":4}},{"line":234,"address":[23846976],"length":1,"stats":{"Line":0}},{"line":239,"address":[19856135,19856029],"length":1,"stats":{"Line":0}},{"line":240,"address":[26736899,26740944,26736805],"length":1,"stats":{"Line":0}},{"line":241,"address":[20007928,20007974,20008082],"length":1,"stats":{"Line":0}},{"line":242,"address":[26739039,26739183,26737487,26737583,26737436,26738024,26737659,26738540,26738278,26738961,26739210,26739460,26737729,26739530,26739784,26738684,26739968,26739714,26737525,26738711,26740038,26737957,26738208,26740650,26740678,26738462],"length":1,"stats":{"Line":0}},{"line":247,"address":[26738505,26738584],"length":1,"stats":{"Line":0}},{"line":248,"address":[20068908,20068987],"length":1,"stats":{"Line":0}},{"line":258,"address":[27201704,27201773,27197501,27202151,27201666],"length":1,"stats":{"Line":0}},{"line":263,"address":[23848416],"length":1,"stats":{"Line":1}},{"line":268,"address":[27202605,27202499],"length":1,"stats":{"Line":2}},{"line":269,"address":[19861439,19861532],"length":1,"stats":{"Line":2}},{"line":270,"address":[21523774,21523685,21527356],"length":1,"stats":{"Line":2}},{"line":272,"address":[26742533],"length":1,"stats":{"Line":1}},{"line":273,"address":[20013492,20013357,20013249],"length":1,"stats":{"Line":3}},{"line":274,"address":[15139992,15140058,15140476,15139454,15139808,15139287,15139175,15138034,15139213,15139447,15140316,15140483,15140812,15140242,15139745],"length":1,"stats":{"Line":0}},{"line":275,"address":[21525695,21525616],"length":1,"stats":{"Line":0}},{"line":278,"address":[21526740,21526661],"length":1,"stats":{"Line":0}},{"line":282,"address":[20084478,20085024,20084773,20085361,20085078,20084408,20085399,20084363,20084957,20084706],"length":1,"stats":{"Line":2}},{"line":285,"address":[21525048,21525118],"length":1,"stats":{"Line":2}},{"line":288,"address":[20957046],"length":1,"stats":{"Line":0}},{"line":289,"address":[20016575,20016664,20017608,20016733,20016626,20016964,20017677,20019040,20017352,20017031,20017102,20017421],"length":1,"stats":{"Line":0}},{"line":291,"address":[20017004],"length":1,"stats":{"Line":0}},{"line":296,"address":[27208292,27208609,27207949,27208980,27208359,27207994,27208064,27208662,27208543],"length":1,"stats":{"Line":0}},{"line":299,"address":[19867322,19867390],"length":1,"stats":{"Line":0}},{"line":304,"address":[20963826,20956876,20963341,20963448,20963379],"length":1,"stats":{"Line":0}},{"line":309,"address":[18090016],"length":1,"stats":{"Line":1}},{"line":314,"address":[21533920,21534044],"length":1,"stats":{"Line":2}},{"line":315,"address":[19872007,19872122],"length":1,"stats":{"Line":2}},{"line":317,"address":[19872319,19872212],"length":1,"stats":{"Line":2}},{"line":318,"address":[21534624],"length":1,"stats":{"Line":1}},{"line":320,"address":[27213992,27213884,27214148],"length":1,"stats":{"Line":3}},{"line":321,"address":[19874670,19873053,19874559],"length":1,"stats":{"Line":3}},{"line":323,"address":[20970153,20970088],"length":1,"stats":{"Line":2}},{"line":324,"address":[19874751,19874843,19875059],"length":1,"stats":{"Line":3}},{"line":326,"address":[20085312],"length":1,"stats":{"Line":1}},{"line":327,"address":[15150589,15150388,15151026],"length":1,"stats":{"Line":2}},{"line":328,"address":[19875403,19875187,19875125],"length":1,"stats":{"Line":3}},{"line":330,"address":[20026408],"length":1,"stats":{"Line":1}},{"line":331,"address":[20085905,20085984,20085700],"length":1,"stats":{"Line":1}},{"line":333,"address":[20027589,20027616,20027445,20026818,20027995,20027367,20026780,20026888,20027116,20026038,20027183],"length":1,"stats":{"Line":3}},{"line":336,"address":[19876241,19876162],"length":1,"stats":{"Line":2}},{"line":342,"address":[26754342,26753747,26754045,26754112,26755075,26753817,26754596,26754666,26753702,26754169,26755047,26754412],"length":1,"stats":{"Line":2}},{"line":344,"address":[20084065,20083989],"length":1,"stats":{"Line":2}},{"line":350,"address":[18090240],"length":1,"stats":{"Line":0}},{"line":355,"address":[20102847,20102741],"length":1,"stats":{"Line":0}},{"line":356,"address":[19880852,19880935],"length":1,"stats":{"Line":0}},{"line":357,"address":[20103192],"length":1,"stats":{"Line":0}},{"line":359,"address":[20103360,20103495,20103252],"length":1,"stats":{"Line":0}},{"line":360,"address":[20092144,20093172,20093061],"length":1,"stats":{"Line":0}},{"line":361,"address":[27225057,27225627,27224109,27224039,27224588,27225201,27224979,27223950,27224658,27224337,27224729,27224404,27225228,27224001],"length":1,"stats":{"Line":0}},{"line":364,"address":[26763959],"length":1,"stats":{"Line":0}},{"line":365,"address":[21545901,21545822],"length":1,"stats":{"Line":0}},{"line":370,"address":[15157077,15157869,15157550,15157907,15157416,15157122,15157188,15157480],"length":1,"stats":{"Line":0}},{"line":372,"address":[20033336,20033406],"length":1,"stats":{"Line":0}},{"line":376,"address":[16729328],"length":1,"stats":{"Line":3}},{"line":379,"address":[16514519],"length":1,"stats":{"Line":10}},{"line":380,"address":[23387989],"length":1,"stats":{"Line":10}},{"line":381,"address":[23388005],"length":1,"stats":{"Line":6}},{"line":384,"address":[16655520],"length":1,"stats":{"Line":2}},{"line":387,"address":[15116528,15116542],"length":1,"stats":{"Line":6}},{"line":388,"address":[18087144],"length":1,"stats":{"Line":4}},{"line":391,"address":[16655744],"length":1,"stats":{"Line":2}},{"line":394,"address":[20936062,20936048],"length":1,"stats":{"Line":6}},{"line":395,"address":[16696438],"length":1,"stats":{"Line":4}},{"line":398,"address":[16726400],"length":1,"stats":{"Line":2}},{"line":401,"address":[16655701],"length":1,"stats":{"Line":6}},{"line":402,"address":[16655720],"length":1,"stats":{"Line":6}},{"line":405,"address":[16655936,16656902,16656896],"length":1,"stats":{"Line":1}},{"line":406,"address":[23385416],"length":1,"stats":{"Line":1}},{"line":408,"address":[23846121,23846204],"length":1,"stats":{"Line":2}},{"line":409,"address":[17765333,17765297,17765217],"length":1,"stats":{"Line":2}},{"line":410,"address":[23385721,23385779],"length":1,"stats":{"Line":2}},{"line":412,"address":[16512355],"length":1,"stats":{"Line":1}},{"line":413,"address":[17765559,17765494],"length":1,"stats":{"Line":2}},{"line":415,"address":[16715975,16715852],"length":1,"stats":{"Line":0}},{"line":417,"address":[16656750,16656324],"length":1,"stats":{"Line":0}},{"line":418,"address":[17765814,17765784],"length":1,"stats":{"Line":0}},{"line":420,"address":[17765807,17765819],"length":1,"stats":{"Line":0}},{"line":424,"address":[23387710,23387716,23386352],"length":1,"stats":{"Line":2}},{"line":425,"address":[23847109],"length":1,"stats":{"Line":2}},{"line":427,"address":[17766038],"length":1,"stats":{"Line":2}},{"line":428,"address":[16513133,16513228],"length":1,"stats":{"Line":4}},{"line":429,"address":[18088990,18089098,18089336],"length":1,"stats":{"Line":6}},{"line":430,"address":[23847926,23848043,23847867],"length":1,"stats":{"Line":0}},{"line":431,"address":[17766983,17766927],"length":1,"stats":{"Line":0}},{"line":433,"address":[23387431],"length":1,"stats":{"Line":0}},{"line":434,"address":[23387595,23387530],"length":1,"stats":{"Line":0}},{"line":436,"address":[23848240,23848350],"length":1,"stats":{"Line":0}},{"line":441,"address":[16698073],"length":1,"stats":{"Line":2}},{"line":446,"address":[16729968],"length":1,"stats":{"Line":0}},{"line":447,"address":[16515089],"length":1,"stats":{"Line":0}}],"covered":93,"coverable":178},{"path":["/","home","shift","code","vincents-ai","engram","src","nlq","response_formatter.rs"],"content":"use crate::error::EngramError;\nuse crate::nlq::{ProcessedQuery, QueryIntent};\nuse serde_json::Value;\n\npub struct ResponseFormatter;\n\nimpl ResponseFormatter {\n    pub fn new() -\u003e Self {\n        Self\n    }\n\n    pub fn format(\u0026self, query: \u0026ProcessedQuery, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        match \u0026query.intent {\n            QueryIntent::ListTasks =\u003e self.format_task_list(data),\n            QueryIntent::ShowTaskDetails =\u003e self.format_task_details(data),\n            QueryIntent::FindRelationships =\u003e self.format_relationships(data),\n            QueryIntent::SearchContext =\u003e self.format_context_results(data),\n            QueryIntent::AnalyzeWorkflow =\u003e self.format_workflow_status(data),\n            QueryIntent::ListSkills =\u003e self.format_skills_list(data),\n            QueryIntent::SearchSkills =\u003e self.format_skills_search(data),\n            QueryIntent::ListPrompts =\u003e self.format_prompts_list(data),\n            QueryIntent::SearchPrompts =\u003e self.format_prompts_search(data),\n            QueryIntent::Unknown =\u003e self.format_unknown(data),\n        }\n    }\n\n    // Skills/Prompts formatters\n    fn format_skills_list(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        if let Some(skills) = data.get(\"skills\").and_then(|v| v.as_array()) {\n            let count = skills.len();\n            if count == 0 {\n                return Ok(\"No skills found. Set ENGRAM_SKILLS_PATH to enable skills.\".to_string());\n            }\n\n            let mut output = format!(\"Found {} skill(s):\\n\\n\", count);\n            for skill in skills {\n                let name = skill\n                    .get(\"name\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"unknown\");\n                let desc = skill\n                    .get(\"description\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"(no description)\");\n                output.push_str(\u0026format!(\"[{}]\\n  {}\\n\\n\", name, desc));\n            }\n            return Ok(output);\n        }\n        Ok(\"Skills data not available\".to_string())\n    }\n\n    fn format_skills_search(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        let query = data.get(\"query\").and_then(|v| v.as_str()).unwrap_or(\"\");\n        if let Some(skills) = data.get(\"skills\").and_then(|v| v.as_array()) {\n            let count = skills.len();\n            if count == 0 {\n                return Ok(format!(\"No skills found for query: '{}'\", query));\n            }\n\n            let mut output = format!(\"Found {} skill(s) matching '{}':\\n\\n\", count, query);\n            for skill in skills {\n                let name = skill\n                    .get(\"name\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"unknown\");\n                let desc = skill\n                    .get(\"description\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"(no description)\");\n                output.push_str(\u0026format!(\"[{}]\\n  {}\\n\\n\", name, desc));\n            }\n            return Ok(output);\n        }\n        Ok(\"Skills search data not available\".to_string())\n    }\n\n    fn format_prompts_list(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        if let Some(prompts) = data.get(\"prompts\").and_then(|v| v.as_array()) {\n            let count = prompts.len();\n            if count == 0 {\n                return Ok(\n                    \"No prompts found. Set ENGRAM_PROMPTS_PATH to enable prompts.\".to_string(),\n                );\n            }\n\n            let mut output = format!(\"Found {} prompt(s):\\n\\n\", count);\n            for prompt in prompts {\n                let name = prompt\n                    .get(\"name\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"unknown\");\n                let title = prompt\n                    .get(\"title\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"(no title)\");\n                output.push_str(\u0026format!(\"[{}]\\n  {}\\n\\n\", name, title));\n            }\n            return Ok(output);\n        }\n        Ok(\"Prompts data not available\".to_string())\n    }\n\n    fn format_prompts_search(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        let query = data.get(\"query\").and_then(|v| v.as_str()).unwrap_or(\"\");\n        if let Some(prompts) = data.get(\"prompts\").and_then(|v| v.as_array()) {\n            let count = prompts.len();\n            if count == 0 {\n                return Ok(format!(\"No prompts found for query: '{}'\", query));\n            }\n\n            let mut output = format!(\"Found {} prompt(s) matching '{}':\\n\\n\", count, query);\n            for prompt in prompts {\n                let name = prompt\n                    .get(\"name\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"unknown\");\n                let title = prompt\n                    .get(\"title\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"(no title)\");\n                output.push_str(\u0026format!(\"[{}]\\n  {}\\n\\n\", name, title));\n            }\n            return Ok(output);\n        }\n        Ok(\"Prompts search data not available\".to_string())\n    }\n\n    fn format_task_list(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        if let Some(error) = data.get(\"error\") {\n            return Ok(format!(\n                \"Error: {}\",\n                error.as_str().unwrap_or(\"Unknown error\")\n            ));\n        }\n\n        let empty_vec = vec![];\n        let tasks = data[\"tasks\"].as_array().unwrap_or(\u0026empty_vec);\n        let count = data[\"count\"].as_u64().unwrap_or(0);\n        let agent = data[\"agent\"].as_str().unwrap_or(\"default\");\n\n        if count == 0 {\n            return Ok(format!(\"No tasks found for agent '{}'\", agent));\n        }\n\n        let mut response = format!(\"Found {} task(s) for agent '{}':\\n\\n\", count, agent);\n\n        for (i, task) in tasks.iter().enumerate() {\n            let title = task[\"title\"].as_str().unwrap_or(\"Untitled\");\n            let status = task[\"status\"].as_str().unwrap_or(\"Unknown\");\n            let priority = task[\"priority\"].as_str().unwrap_or(\"Unknown\");\n\n            response.push_str(\u0026format!(\n                \"{}. {} [{}] ({})\\n\",\n                i + 1,\n                title,\n                status,\n                priority\n            ));\n        }\n\n        Ok(response)\n    }\n\n    fn format_task_details(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        if let Some(error) = data.get(\"error\") {\n            return Ok(format!(\n                \"Error: {}\",\n                error.as_str().unwrap_or(\"Unknown error\")\n            ));\n        }\n\n        if let Some(task) = data.get(\"task\") {\n            let title = task[\"title\"].as_str().unwrap_or(\"Untitled\");\n            let description = task[\"description\"].as_str().unwrap_or(\"No description\");\n            let status = task[\"status\"].as_str().unwrap_or(\"Unknown\");\n            let priority = task[\"priority\"].as_str().unwrap_or(\"Unknown\");\n            let agent = task[\"agent\"].as_str().unwrap_or(\"Unknown\");\n\n            let mut response = format!(\"Task Details:\\n\");\n            response.push_str(\u0026format!(\"Title: {}\\n\", title));\n            response.push_str(\u0026format!(\"Status: {}\\n\", status));\n            response.push_str(\u0026format!(\"Priority: {}\\n\", priority));\n            response.push_str(\u0026format!(\"Agent: {}\\n\", agent));\n\n            if !description.is_empty() {\n                response.push_str(\u0026format!(\"Description: {}\\n\", description));\n            }\n\n            if let Some(outcome) = task.get(\"outcome\") {\n                if let Some(outcome_str) = outcome.as_str() {\n                    response.push_str(\u0026format!(\"Outcome: {}\\n\", outcome_str));\n                }\n            }\n\n            return Ok(response);\n        }\n\n        Ok(\"No task details available\".to_string())\n    }\n\n    fn format_relationships(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        if let Some(error) = data.get(\"error\") {\n            return Ok(format!(\n                \"Error: {}\",\n                error.as_str().unwrap_or(\"Unknown error\")\n            ));\n        }\n\n        let task_id = data[\"task_id\"].as_str().unwrap_or(\"unknown\");\n        let empty_vec = vec![];\n        let relationships = data[\"relationships\"].as_array().unwrap_or(\u0026empty_vec);\n        let count = data[\"count\"].as_u64().unwrap_or(0);\n\n        if count == 0 {\n            return Ok(format!(\"No relationships found for task {}\", task_id));\n        }\n\n        let mut response = format!(\"Found {} relationship(s) for task {}:\\n\\n\", count, task_id);\n\n        for (i, rel) in relationships.iter().enumerate() {\n            let rel_type = rel[\"type\"].as_str().unwrap_or(\"Unknown\");\n            let target = rel[\"target\"].as_str().unwrap_or(\"Unknown\");\n            let strength = rel[\"strength\"].as_str().unwrap_or(\"Unknown\");\n\n            response.push_str(\u0026format!(\n                \"{}. {} -\u003e {} ({})\\n\",\n                i + 1,\n                rel_type,\n                target,\n                strength\n            ));\n        }\n\n        Ok(response)\n    }\n\n    fn format_context_results(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        let empty_vec = vec![];\n        let contexts = data[\"contexts\"].as_array().unwrap_or(\u0026empty_vec);\n        let count = data[\"count\"].as_u64().unwrap_or(0);\n\n        if count == 0 {\n            return Ok(\"No context information found\".to_string());\n        }\n\n        let mut response = format!(\"Found {} context item(s):\\n\\n\", count);\n\n        for (i, context) in contexts.iter().enumerate() {\n            let title = context[\"title\"].as_str().unwrap_or(\"Untitled\");\n            let relevance = context[\"relevance\"].as_f64().unwrap_or(0.0);\n\n            response.push_str(\u0026format!(\n                \"{}. {} (relevance: {:.2})\\n\",\n                i + 1,\n                title,\n                relevance\n            ));\n        }\n\n        Ok(response)\n    }\n\n    fn format_workflow_status(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        let empty_vec = vec![];\n        let workflows = data[\"workflows\"].as_array().unwrap_or(\u0026empty_vec);\n        let count = data[\"count\"].as_u64().unwrap_or(0);\n\n        if count == 0 {\n            return Ok(\"No workflows found\".to_string());\n        }\n\n        let mut response = format!(\"Found {} workflow(s):\\n\\n\", count);\n\n        for (i, workflow) in workflows.iter().enumerate() {\n            let title = workflow[\"title\"].as_str().unwrap_or(\"Untitled\");\n            let current_state = workflow[\"current_state\"].as_str().unwrap_or(\"Unknown\");\n            let status = workflow[\"status\"].as_str().unwrap_or(\"Unknown\");\n\n            response.push_str(\u0026format!(\n                \"{}. {} - {} ({})\\n\",\n                i + 1,\n                title,\n                current_state,\n                status\n            ));\n        }\n\n        Ok(response)\n    }\n\n    fn format_unknown(\u0026self, data: \u0026Value) -\u003e Result\u003cString, EngramError\u003e {\n        if let Some(error) = data.get(\"error\") {\n            let error_msg = error.as_str().unwrap_or(\"Unknown error\");\n            if let Some(suggestion) = data.get(\"suggestion\") {\n                let suggestion_msg = suggestion.as_str().unwrap_or(\"\");\n                return Ok(format!(\"{}\\n\\n{}\", error_msg, suggestion_msg));\n            }\n            return Ok(error_msg.to_string());\n        }\n\n        Ok(\n            \"I don't understand that query. Try asking about tasks, relationships, or workflows.\"\n                .to_string(),\n        )\n    }\n}\n\nimpl Default for ResponseFormatter {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::nlq::QueryIntent;\n    use serde_json::json;\n\n    #[test]\n    fn test_format_empty_task_list() {\n        let formatter = ResponseFormatter::new();\n        let data = json!({\n            \"tasks\": [],\n            \"count\": 0,\n            \"agent\": \"alice\"\n        });\n\n        let result = formatter.format_task_list(\u0026data).unwrap();\n        assert!(result.contains(\"No tasks found for agent 'alice'\"));\n    }\n\n    #[test]\n    fn test_format_task_list_with_tasks() {\n        let formatter = ResponseFormatter::new();\n        let data = json!({\n            \"tasks\": [\n                {\n                    \"title\": \"Test task\",\n                    \"status\": \"Todo\",\n                    \"priority\": \"High\"\n                }\n            ],\n            \"count\": 1,\n            \"agent\": \"bob\"\n        });\n\n        let result = formatter.format_task_list(\u0026data).unwrap();\n        assert!(result.contains(\"Found 1 task(s) for agent 'bob'\"));\n        assert!(result.contains(\"Test task\"));\n    }\n\n    #[test]\n    fn test_format_error() {\n        let formatter = ResponseFormatter::new();\n        let data = json!({\n            \"error\": \"Task not found\"\n        });\n\n        let result = formatter.format_task_details(\u0026data).unwrap();\n        assert!(result.contains(\"Error: Task not found\"));\n    }\n}\n","traces":[{"line":12,"address":[16988288],"length":1,"stats":{"Line":1}},{"line":13,"address":[18477575],"length":1,"stats":{"Line":1}},{"line":14,"address":[16988374],"length":1,"stats":{"Line":1}},{"line":15,"address":[18477647],"length":1,"stats":{"Line":0}},{"line":16,"address":[16988424],"length":1,"stats":{"Line":1}},{"line":17,"address":[18327969],"length":1,"stats":{"Line":1}},{"line":18,"address":[18327994],"length":1,"stats":{"Line":0}},{"line":19,"address":[18328016],"length":1,"stats":{"Line":0}},{"line":20,"address":[23717862],"length":1,"stats":{"Line":0}},{"line":21,"address":[18477788],"length":1,"stats":{"Line":0}},{"line":22,"address":[24178578],"length":1,"stats":{"Line":0}},{"line":23,"address":[16988584],"length":1,"stats":{"Line":1}},{"line":28,"address":[17033120,17033126,17031760],"length":1,"stats":{"Line":0}},{"line":29,"address":[16972570],"length":1,"stats":{"Line":0}},{"line":30,"address":[16972660],"length":1,"stats":{"Line":0}},{"line":31,"address":[17043442],"length":1,"stats":{"Line":0}},{"line":32,"address":[24162788],"length":1,"stats":{"Line":0}},{"line":35,"address":[17043630],"length":1,"stats":{"Line":0}},{"line":36,"address":[18312622,18312519],"length":1,"stats":{"Line":0}},{"line":37,"address":[23702767],"length":1,"stats":{"Line":0}},{"line":39,"address":[18163696,18163705],"length":1,"stats":{"Line":0}},{"line":41,"address":[16973546],"length":1,"stats":{"Line":0}},{"line":43,"address":[18462720],"length":1,"stats":{"Line":0}},{"line":45,"address":[16973570],"length":1,"stats":{"Line":0}},{"line":47,"address":[24163259],"length":1,"stats":{"Line":0}},{"line":49,"address":[16828578],"length":1,"stats":{"Line":0}},{"line":52,"address":[24172733,24172739,24171120],"length":1,"stats":{"Line":0}},{"line":53,"address":[19874208,19874217],"length":1,"stats":{"Line":0}},{"line":54,"address":[17052002],"length":1,"stats":{"Line":0}},{"line":55,"address":[17040572],"length":1,"stats":{"Line":0}},{"line":56,"address":[18320858],"length":1,"stats":{"Line":0}},{"line":57,"address":[16837324],"length":1,"stats":{"Line":0}},{"line":60,"address":[16405558],"length":1,"stats":{"Line":0}},{"line":61,"address":[18321364,18321467],"length":1,"stats":{"Line":0}},{"line":62,"address":[16838156],"length":1,"stats":{"Line":0}},{"line":64,"address":[18374480,18374489],"length":1,"stats":{"Line":0}},{"line":66,"address":[18471639],"length":1,"stats":{"Line":0}},{"line":68,"address":[18163897,18163888],"length":1,"stats":{"Line":0}},{"line":70,"address":[24172431],"length":1,"stats":{"Line":0}},{"line":72,"address":[16837976],"length":1,"stats":{"Line":0}},{"line":74,"address":[16837242],"length":1,"stats":{"Line":0}},{"line":77,"address":[16397952,16399300,16399294],"length":1,"stats":{"Line":0}},{"line":78,"address":[17033210],"length":1,"stats":{"Line":0}},{"line":79,"address":[16398098],"length":1,"stats":{"Line":0}},{"line":80,"address":[18463314],"length":1,"stats":{"Line":0}},{"line":81,"address":[18313718],"length":1,"stats":{"Line":0}},{"line":82,"address":[16830052],"length":1,"stats":{"Line":0}},{"line":86,"address":[17045022],"length":1,"stats":{"Line":0}},{"line":87,"address":[23703838,23703735],"length":1,"stats":{"Line":0}},{"line":88,"address":[18464063],"length":1,"stats":{"Line":0}},{"line":90,"address":[16830624],"length":1,"stats":{"Line":0}},{"line":92,"address":[23704282],"length":1,"stats":{"Line":0}},{"line":94,"address":[23704208],"length":1,"stats":{"Line":0}},{"line":96,"address":[16398992],"length":1,"stats":{"Line":0}},{"line":98,"address":[16974635],"length":1,"stats":{"Line":0}},{"line":100,"address":[17044850],"length":1,"stats":{"Line":0}},{"line":103,"address":[16840243,16840237,16838624],"length":1,"stats":{"Line":0}},{"line":104,"address":[18315337,18315328],"length":1,"stats":{"Line":0}},{"line":105,"address":[19804512,19804521],"length":1,"stats":{"Line":0}},{"line":106,"address":[16406856],"length":1,"stats":{"Line":0}},{"line":107,"address":[17042218],"length":1,"stats":{"Line":0}},{"line":108,"address":[18472316],"length":1,"stats":{"Line":0}},{"line":111,"address":[17054042],"length":1,"stats":{"Line":0}},{"line":112,"address":[16983579,16983476],"length":1,"stats":{"Line":0}},{"line":113,"address":[18323420],"length":1,"stats":{"Line":0}},{"line":115,"address":[25505312,25505321],"length":1,"stats":{"Line":0}},{"line":117,"address":[17043271],"length":1,"stats":{"Line":0}},{"line":119,"address":[18164121,18164112],"length":1,"stats":{"Line":0}},{"line":121,"address":[18473295],"length":1,"stats":{"Line":0}},{"line":123,"address":[16407616],"length":1,"stats":{"Line":0}},{"line":125,"address":[24173002],"length":1,"stats":{"Line":0}},{"line":128,"address":[24159808,24162508,24162514],"length":1,"stats":{"Line":2}},{"line":129,"address":[16825738],"length":1,"stats":{"Line":4}},{"line":130,"address":[16969973],"length":1,"stats":{"Line":0}},{"line":132,"address":[17040695],"length":1,"stats":{"Line":0}},{"line":136,"address":[16826056],"length":1,"stats":{"Line":2}},{"line":137,"address":[23699537,23699643],"length":1,"stats":{"Line":7}},{"line":138,"address":[23699721],"length":1,"stats":{"Line":5}},{"line":139,"address":[24160529],"length":1,"stats":{"Line":3}},{"line":141,"address":[18459921],"length":1,"stats":{"Line":5}},{"line":142,"address":[17041460,17041541],"length":1,"stats":{"Line":2}},{"line":145,"address":[16970727,16970943],"length":1,"stats":{"Line":6}},{"line":147,"address":[17030429,17030342],"length":1,"stats":{"Line":6}},{"line":148,"address":[18460876,18460712],"length":1,"stats":{"Line":6}},{"line":149,"address":[24161748],"length":1,"stats":{"Line":2}},{"line":150,"address":[16827758],"length":1,"stats":{"Line":4}},{"line":152,"address":[17043231,17042814,17042917],"length":1,"stats":{"Line":10}},{"line":154,"address":[24162145,24162024],"length":1,"stats":{"Line":2}},{"line":161,"address":[18311030],"length":1,"stats":{"Line":2}},{"line":164,"address":[16399328,16401848,16402381],"length":1,"stats":{"Line":1}},{"line":165,"address":[24165370],"length":1,"stats":{"Line":1}},{"line":166,"address":[24165493],"length":1,"stats":{"Line":1}},{"line":168,"address":[17046199],"length":1,"stats":{"Line":1}},{"line":172,"address":[24165696,24165774],"length":1,"stats":{"Line":0}},{"line":173,"address":[18315302],"length":1,"stats":{"Line":0}},{"line":174,"address":[16399931],"length":1,"stats":{"Line":0}},{"line":175,"address":[17046789],"length":1,"stats":{"Line":0}},{"line":176,"address":[16400139],"length":1,"stats":{"Line":0}},{"line":177,"address":[18465500],"length":1,"stats":{"Line":0}},{"line":179,"address":[18315849],"length":1,"stats":{"Line":0}},{"line":180,"address":[18465671,18465824],"length":1,"stats":{"Line":0}},{"line":181,"address":[18466051],"length":1,"stats":{"Line":0}},{"line":182,"address":[23706395],"length":1,"stats":{"Line":0}},{"line":183,"address":[24167315],"length":1,"stats":{"Line":0}},{"line":185,"address":[16833427],"length":1,"stats":{"Line":0}},{"line":186,"address":[18317104,18317170],"length":1,"stats":{"Line":0}},{"line":189,"address":[23707221,23706963],"length":1,"stats":{"Line":0}},{"line":190,"address":[17037180,17037315],"length":1,"stats":{"Line":0}},{"line":191,"address":[16402140],"length":1,"stats":{"Line":0}},{"line":195,"address":[18467209],"length":1,"stats":{"Line":0}},{"line":198,"address":[16832338],"length":1,"stats":{"Line":0}},{"line":201,"address":[23707760,23710414,23710420],"length":1,"stats":{"Line":1}},{"line":202,"address":[17049242],"length":1,"stats":{"Line":1}},{"line":203,"address":[24168613],"length":1,"stats":{"Line":0}},{"line":205,"address":[16402534],"length":1,"stats":{"Line":0}},{"line":209,"address":[17038051],"length":1,"stats":{"Line":1}},{"line":210,"address":[17038153],"length":1,"stats":{"Line":1}},{"line":211,"address":[18318557,18318458],"length":1,"stats":{"Line":2}},{"line":212,"address":[17049883],"length":1,"stats":{"Line":1}},{"line":214,"address":[23708587],"length":1,"stats":{"Line":1}},{"line":215,"address":[18468510,18468591],"length":1,"stats":{"Line":2}},{"line":218,"address":[16403255,16403471],"length":1,"stats":{"Line":0}},{"line":220,"address":[17038912,17038999],"length":1,"stats":{"Line":0}},{"line":221,"address":[18319554,18319718],"length":1,"stats":{"Line":0}},{"line":222,"address":[18319828],"length":1,"stats":{"Line":0}},{"line":223,"address":[16404382],"length":1,"stats":{"Line":0}},{"line":225,"address":[23709966,23710069,23710385],"length":1,"stats":{"Line":0}},{"line":227,"address":[17051352,17051473],"length":1,"stats":{"Line":0}},{"line":234,"address":[18469328],"length":1,"stats":{"Line":0}},{"line":237,"address":[18325703,18325697,18323888],"length":1,"stats":{"Line":1}},{"line":238,"address":[16984415],"length":1,"stats":{"Line":1}},{"line":239,"address":[16840418,16840328],"length":1,"stats":{"Line":2}},{"line":240,"address":[17055376],"length":1,"stats":{"Line":1}},{"line":242,"address":[17055504],"length":1,"stats":{"Line":1}},{"line":243,"address":[24174763,24174837],"length":1,"stats":{"Line":0}},{"line":246,"address":[16408662,16408770],"length":1,"stats":{"Line":2}},{"line":248,"address":[17044250,17044337],"length":1,"stats":{"Line":2}},{"line":249,"address":[23714704,23714862],"length":1,"stats":{"Line":2}},{"line":250,"address":[18325133],"length":1,"stats":{"Line":1}},{"line":252,"address":[18325284,18325371,18325668],"length":1,"stats":{"Line":3}},{"line":254,"address":[18325351,18325246],"length":1,"stats":{"Line":1}},{"line":260,"address":[18474651],"length":1,"stats":{"Line":1}},{"line":263,"address":[18475456,18477496,18477502],"length":1,"stats":{"Line":0}},{"line":264,"address":[16986255],"length":1,"stats":{"Line":0}},{"line":265,"address":[16410136,16410222],"length":1,"stats":{"Line":0}},{"line":266,"address":[17045696],"length":1,"stats":{"Line":0}},{"line":268,"address":[24176592],"length":1,"stats":{"Line":0}},{"line":269,"address":[16986587,16986661],"length":1,"stats":{"Line":0}},{"line":272,"address":[16986626,16986734],"length":1,"stats":{"Line":0}},{"line":274,"address":[17057610,17057697],"length":1,"stats":{"Line":0}},{"line":275,"address":[23716556,23716720],"length":1,"stats":{"Line":0}},{"line":276,"address":[17046734],"length":1,"stats":{"Line":0}},{"line":277,"address":[18476872],"length":1,"stats":{"Line":0}},{"line":279,"address":[16987800,16987903,16988219],"length":1,"stats":{"Line":0}},{"line":281,"address":[18477131,18477010],"length":1,"stats":{"Line":0}},{"line":288,"address":[23716602],"length":1,"stats":{"Line":0}},{"line":291,"address":[16825024],"length":1,"stats":{"Line":1}},{"line":292,"address":[18308700],"length":1,"stats":{"Line":1}},{"line":293,"address":[16825132],"length":1,"stats":{"Line":1}},{"line":294,"address":[17040191,17040056],"length":1,"stats":{"Line":2}},{"line":295,"address":[16969436],"length":1,"stats":{"Line":1}},{"line":296,"address":[16825361],"length":1,"stats":{"Line":1}},{"line":298,"address":[23699043],"length":1,"stats":{"Line":0}},{"line":303,"address":[24159360],"length":1,"stats":{"Line":0}},{"line":309,"address":[16988608],"length":1,"stats":{"Line":0}},{"line":310,"address":[16844497],"length":1,"stats":{"Line":0}}],"covered":52,"coverable":166},{"path":["/","home","shift","code","vincents-ai","engram","src","nlq","skills_prompts_handler.rs"],"content":"//! Skills and Prompts Query Handler for NLQ Engine\n//!\n//! Provides natural language querying of skills and prompts from\n//! ENGRAM_SKILLS_PATH and ENGRAM_PROMPTS_PATH.\n\nuse crate::error::EngramError;\nuse serde::{Deserialize, Serialize};\nuse std::fs;\nuse std::path::PathBuf;\n\n/// Get skills path from environment or default\npub fn get_skills_path() -\u003e PathBuf {\n    std::env::var(\"ENGRAM_SKILLS_PATH\")\n        .map(PathBuf::from)\n        .unwrap_or_else(|_| PathBuf::from(\"./engram/skills\"))\n}\n\n/// Get prompts path from environment or default\npub fn get_prompts_path() -\u003e PathBuf {\n    std::env::var(\"ENGRAM_PROMPTS_PATH\")\n        .map(PathBuf::from)\n        .unwrap_or_else(|_| PathBuf::from(\"./engram/prompts\"))\n}\n\n/// Skill query result\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SkillInfo {\n    pub name: String,\n    pub path: String,\n    pub description: Option\u003cString\u003e,\n    pub category: String,\n}\n\n/// Prompt query result\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PromptInfo {\n    pub name: String,\n    pub path: String,\n    pub title: Option\u003cString\u003e,\n    pub description: Option\u003cString\u003e,\n    pub category: String,\n}\n\n/// Query for skills\n#[derive(Debug, Clone)]\npub struct SkillsQuery {\n    pub category: Option\u003cString\u003e,\n    pub search_term: Option\u003cString\u003e,\n    pub format: String,\n}\n\n/// Query for prompts\n#[derive(Debug, Clone)]\npub struct PromptsQuery {\n    pub category: Option\u003cString\u003e,\n    pub search_term: Option\u003cString\u003e,\n    pub format: String,\n}\n\n/// List all available skills\npub fn list_skills(query: \u0026SkillsQuery) -\u003e Result\u003cVec\u003cSkillInfo\u003e, EngramError\u003e {\n    let skills_path = get_skills_path();\n\n    if !skills_path.exists() {\n        return Ok(Vec::new());\n    }\n\n    let mut skills = Vec::new();\n    let entries = fs::read_dir(\u0026skills_path)?;\n\n    for entry in entries.flatten() {\n        if entry.path().is_dir() {\n            let category = entry.file_name().to_string_lossy().to_string();\n\n            // Filter by category if specified\n            if let Some(ref cat) = query.category {\n                if category.to_lowercase() != cat.to_lowercase() {\n                    continue;\n                }\n            }\n\n            // Search in skill name\n            if let Some(ref term) = query.search_term {\n                if !category.to_lowercase().contains(\u0026term.to_lowercase()) {\n                    continue;\n                }\n            }\n\n            // Try to read description from skill.md\n            let skill_file = entry.path().join(\"skill.md\");\n            let description = if skill_file.exists() {\n                let content = fs::read_to_string(\u0026skill_file).ok();\n                content.and_then(|c| {\n                    c.lines()\n                        .next()\n                        .map(|s| s.to_string())\n                        .filter(|s| !s.is_empty())\n                })\n            } else {\n                None\n            };\n\n            skills.push(SkillInfo {\n                name: category.clone(),\n                path: entry.path().to_string_lossy().to_string(),\n                description,\n                category,\n            });\n        }\n    }\n\n    Ok(skills)\n}\n\n/// List all available prompts\npub fn list_prompts(query: \u0026PromptsQuery) -\u003e Result\u003cVec\u003cPromptInfo\u003e, EngramError\u003e {\n    let prompts_path = get_prompts_path();\n\n    if !prompts_path.exists() {\n        return Ok(Vec::new());\n    }\n\n    let mut prompts = Vec::new();\n    let entries = fs::read_dir(\u0026prompts_path)?;\n\n    for entry in entries.flatten() {\n        if entry.path().is_dir() {\n            let category = entry.file_name().to_string_lossy().to_string();\n\n            // Filter by category if specified\n            if let Some(ref cat) = query.category {\n                if category.to_lowercase() != cat.to_lowercase() {\n                    continue;\n                }\n            }\n\n            // Search in subdirectory\n            let subentries = fs::read_dir(\u0026entry.path())?;\n            for subentry in subentries.flatten() {\n                if subentry.path().is_file() {\n                    let name = subentry.file_name().to_string_lossy().to_string();\n\n                    // Search in prompt name\n                    if let Some(ref term) = query.search_term {\n                        if !name.to_lowercase().contains(\u0026term.to_lowercase()) {\n                            continue;\n                        }\n                    }\n\n                    // Try to extract title/description from YAML\n                    let content = fs::read_to_string(\u0026subentry.path()).ok();\n                    let (title, description) = extract_yaml_metadata(\u0026content.unwrap_or_default());\n\n                    prompts.push(PromptInfo {\n                        name: name.clone(),\n                        path: format!(\"{}/{}\", category, name),\n                        title,\n                        description,\n                        category: category.clone(),\n                    });\n                }\n            }\n        }\n    }\n\n    Ok(prompts)\n}\n\n/// Extract title and description from YAML frontmatter\nfn extract_yaml_metadata(content: \u0026str) -\u003e (Option\u003cString\u003e, Option\u003cString\u003e) {\n    if !content.starts_with(\"---\") {\n        return (None, None);\n    }\n\n    // Find closing frontmatter\n    let start = 3;\n    let end = match content[3..].find(\"---\") {\n        Some(pos) =\u003e pos + 3,\n        None =\u003e return (None, None),\n    };\n\n    let frontmatter = \u0026content[start..end];\n\n    // Simple extraction\n    let title = extract_yaml_field(frontmatter, \"title\");\n    let desc = extract_yaml_field(frontmatter, \"description\");\n\n    (title, desc)\n}\n\n/// Extract a field value from YAML\nfn extract_yaml_field(yaml: \u0026str, field: \u0026str) -\u003e Option\u003cString\u003e {\n    let pattern = format!(r#\"{}\\s*:\\s*\"([^\"]+)\"\"#, field);\n    let re = regex::RegexBuilder::new(\u0026pattern)\n        .case_insensitive(true)\n        .build()\n        .ok()?;\n\n    if let Some(cap) = re.captures(yaml) {\n        return Some(cap[1].to_string());\n    }\n\n    // Try without quotes\n    let pattern = format!(r#\"{}\\s*:\\s*(\\w+)\"#, field);\n    let re = regex::RegexBuilder::new(\u0026pattern)\n        .case_insensitive(true)\n        .build()\n        .ok()?;\n\n    if let Some(cap) = re.captures(yaml) {\n        return Some(cap[1].to_string());\n    }\n\n    None\n}\n\n/// Search for skills matching a natural language query\npub fn search_skills(query: \u0026str) -\u003e Result\u003cVec\u003cSkillInfo\u003e, EngramError\u003e {\n    // Parse natural language to extract search terms\n    let search_term = if query.contains(\"for\") {\n        query.split(\"for\").last().map(|s| s.trim().to_string())\n    } else if query.contains(\"related to\") {\n        query\n            .split(\"related to\")\n            .last()\n            .map(|s| s.trim().to_string())\n    } else {\n        Some(query.trim().to_string())\n    };\n\n    list_skills(\u0026SkillsQuery {\n        category: None,\n        search_term,\n        format: \"full\".to_string(),\n    })\n}\n\n/// Search for prompts matching a natural language query\npub fn search_prompts(query: \u0026str) -\u003e Result\u003cVec\u003cPromptInfo\u003e, EngramError\u003e {\n    // Parse natural language to extract search terms\n    let search_term = if query.contains(\"for\") {\n        query.split(\"for\").last().map(|s| s.trim().to_string())\n    } else if query.contains(\"related to\") {\n        query\n            .split(\"related to\")\n            .last()\n            .map(|s| s.trim().to_string())\n    } else {\n        Some(query.trim().to_string())\n    };\n\n    // Try to extract category\n    let category = if query.contains(\"agent\") {\n        Some(\"agents\".to_string())\n    } else if query.contains(\"pipeline\") {\n        Some(\"ai/pipelines\".to_string())\n    } else if query.contains(\"compliance\") {\n        Some(\"compliance_and_certification\".to_string())\n    } else {\n        None\n    };\n\n    list_prompts(\u0026PromptsQuery {\n        category,\n        search_term,\n        format: \"full\".to_string(),\n    })\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_yaml_extraction() {\n        let yaml = r#\"---\ntitle: \"Test Skill\"\ndescription: \"A test skill for testing\"\n---\"#;\n\n        let (title, desc) = extract_yaml_metadata(yaml);\n        assert_eq!(title, Some(\"Test Skill\".to_string()));\n        assert_eq!(desc, Some(\"A test skill for testing\".to_string()));\n    }\n\n    #[test]\n    fn test_skills_path_from_env() {\n        std::env::set_var(\"ENGRAM_SKILLS_PATH\", \"/custom/skills\");\n        assert_eq!(get_skills_path(), PathBuf::from(\"/custom/skills\"));\n        std::env::remove_var(\"ENGRAM_SKILLS_PATH\");\n    }\n}\n","traces":[{"line":12,"address":[23338416],"length":1,"stats":{"Line":1}},{"line":13,"address":[16219182],"length":1,"stats":{"Line":1}},{"line":14,"address":[22877781],"length":1,"stats":{"Line":1}},{"line":15,"address":[16275290],"length":1,"stats":{"Line":1}},{"line":19,"address":[16219264],"length":1,"stats":{"Line":0}},{"line":20,"address":[22877854],"length":1,"stats":{"Line":0}},{"line":21,"address":[17515813],"length":1,"stats":{"Line":0}},{"line":22,"address":[23338570],"length":1,"stats":{"Line":0}},{"line":61,"address":[17565478,17567056,17563488],"length":1,"stats":{"Line":0}},{"line":62,"address":[22867111],"length":1,"stats":{"Line":0}},{"line":64,"address":[23327923,23327840],"length":1,"stats":{"Line":0}},{"line":65,"address":[17505214,17505260],"length":1,"stats":{"Line":0}},{"line":68,"address":[16264785],"length":1,"stats":{"Line":0}},{"line":69,"address":[16208810,16208881],"length":1,"stats":{"Line":0}},{"line":71,"address":[15987225,15987017,15987101],"length":1,"stats":{"Line":0}},{"line":72,"address":[15987304,15987542,15990038],"length":1,"stats":{"Line":0}},{"line":73,"address":[15987713],"length":1,"stats":{"Line":0}},{"line":76,"address":[16266130],"length":1,"stats":{"Line":0}},{"line":77,"address":[16139367,16139456],"length":1,"stats":{"Line":0}},{"line":83,"address":[16210559,16210166],"length":1,"stats":{"Line":0}},{"line":84,"address":[22869565,22869160,22869229],"length":1,"stats":{"Line":0}},{"line":90,"address":[22869595,22869183],"length":1,"stats":{"Line":0}},{"line":91,"address":[23330633,23330441,23330515],"length":1,"stats":{"Line":0}},{"line":92,"address":[16140555,16140501],"length":1,"stats":{"Line":0}},{"line":93,"address":[16202619,16202416],"length":1,"stats":{"Line":0}},{"line":94,"address":[16202519,16202446],"length":1,"stats":{"Line":0}},{"line":95,"address":[23321779],"length":1,"stats":{"Line":0}},{"line":96,"address":[16131790,16131926,16131904],"length":1,"stats":{"Line":0}},{"line":97,"address":[17165683,17165744,17165753],"length":1,"stats":{"Line":0}},{"line":100,"address":[16211241],"length":1,"stats":{"Line":0}},{"line":103,"address":[15989725],"length":1,"stats":{"Line":0}},{"line":104,"address":[16211296],"length":1,"stats":{"Line":0}},{"line":105,"address":[23330752,23330676,23330831],"length":1,"stats":{"Line":0}},{"line":106,"address":[16140893],"length":1,"stats":{"Line":0}},{"line":107,"address":[15989685],"length":1,"stats":{"Line":0}},{"line":112,"address":[22867953],"length":1,"stats":{"Line":0}},{"line":116,"address":[15995251,15990160,15992219],"length":1,"stats":{"Line":0}},{"line":117,"address":[16141447],"length":1,"stats":{"Line":0}},{"line":119,"address":[17175475,17175392],"length":1,"stats":{"Line":0}},{"line":120,"address":[17567328,17567298],"length":1,"stats":{"Line":0}},{"line":123,"address":[15990401],"length":1,"stats":{"Line":0}},{"line":124,"address":[23331754,23336513,23331825],"length":1,"stats":{"Line":0}},{"line":126,"address":[15990921,15990713,15990797],"length":1,"stats":{"Line":0}},{"line":127,"address":[16142486,16142248],"length":1,"stats":{"Line":0}},{"line":128,"address":[16142657],"length":1,"stats":{"Line":0}},{"line":131,"address":[17568594],"length":1,"stats":{"Line":0}},{"line":132,"address":[17510407,17510338],"length":1,"stats":{"Line":0}},{"line":138,"address":[15995113,15991833,15992225],"length":1,"stats":{"Line":0}},{"line":139,"address":[16143756,16143923],"length":1,"stats":{"Line":0}},{"line":140,"address":[17569575,17569695],"length":1,"stats":{"Line":0}},{"line":141,"address":[16144295],"length":1,"stats":{"Line":0}},{"line":144,"address":[16144615],"length":1,"stats":{"Line":0}},{"line":145,"address":[17512018,17511961,17512362],"length":1,"stats":{"Line":0}},{"line":151,"address":[16215466,16215872],"length":1,"stats":{"Line":0}},{"line":152,"address":[17570815],"length":1,"stats":{"Line":0}},{"line":154,"address":[15994739],"length":1,"stats":{"Line":0}},{"line":155,"address":[17179443],"length":1,"stats":{"Line":0}},{"line":156,"address":[15994445,15994358],"length":1,"stats":{"Line":0}},{"line":157,"address":[16272668],"length":1,"stats":{"Line":0}},{"line":158,"address":[16216644],"length":1,"stats":{"Line":0}},{"line":159,"address":[16216684],"length":1,"stats":{"Line":0}},{"line":166,"address":[22871649],"length":1,"stats":{"Line":0}},{"line":170,"address":[17185251,17185257,17184512],"length":1,"stats":{"Line":1}},{"line":171,"address":[16150711],"length":1,"stats":{"Line":1}},{"line":172,"address":[16277570],"length":1,"stats":{"Line":0}},{"line":176,"address":[15999451],"length":1,"stats":{"Line":1}},{"line":177,"address":[17184705],"length":1,"stats":{"Line":1}},{"line":178,"address":[23340927,23341089,23341209],"length":1,"stats":{"Line":2}},{"line":179,"address":[16277784],"length":1,"stats":{"Line":0}},{"line":182,"address":[22880425],"length":1,"stats":{"Line":1}},{"line":185,"address":[17576602],"length":1,"stats":{"Line":1}},{"line":186,"address":[17576637],"length":1,"stats":{"Line":1}},{"line":188,"address":[17185127],"length":1,"stats":{"Line":1}},{"line":192,"address":[16219360,16220349,16221380],"length":1,"stats":{"Line":1}},{"line":193,"address":[17515939],"length":1,"stats":{"Line":1}},{"line":194,"address":[17574280,17574363,17574515],"length":1,"stats":{"Line":3}},{"line":199,"address":[16149245],"length":1,"stats":{"Line":1}},{"line":200,"address":[16276325,16276192],"length":1,"stats":{"Line":2}},{"line":204,"address":[23339425,23339603],"length":1,"stats":{"Line":0}},{"line":205,"address":[16149906,16149766,16149695],"length":1,"stats":{"Line":0}},{"line":210,"address":[16220904],"length":1,"stats":{"Line":0}},{"line":211,"address":[16221019,16221154],"length":1,"stats":{"Line":0}},{"line":214,"address":[23340323],"length":1,"stats":{"Line":0}},{"line":218,"address":[16273344,16273966,16273972],"length":1,"stats":{"Line":0}},{"line":220,"address":[23336585],"length":1,"stats":{"Line":0}},{"line":221,"address":[15980752,15980704],"length":1,"stats":{"Line":0}},{"line":222,"address":[22875944,22876105],"length":1,"stats":{"Line":0}},{"line":226,"address":[17180688],"length":1,"stats":{"Line":0}},{"line":228,"address":[17572217],"length":1,"stats":{"Line":0}},{"line":231,"address":[16273783],"length":1,"stats":{"Line":0}},{"line":232,"address":[16273669],"length":1,"stats":{"Line":0}},{"line":233,"address":[16273677],"length":1,"stats":{"Line":0}},{"line":234,"address":[22876215],"length":1,"stats":{"Line":0}},{"line":239,"address":[17182215,17181056,17182209],"length":1,"stats":{"Line":0}},{"line":241,"address":[16274075],"length":1,"stats":{"Line":0}},{"line":242,"address":[23337337],"length":1,"stats":{"Line":0}},{"line":243,"address":[16147283,16147462],"length":1,"stats":{"Line":0}},{"line":244,"address":[17514798],"length":1,"stats":{"Line":0}},{"line":247,"address":[16203008,16202960],"length":1,"stats":{"Line":0}},{"line":249,"address":[16274225],"length":1,"stats":{"Line":0}},{"line":253,"address":[17181419,17181491,17181964],"length":1,"stats":{"Line":0}},{"line":254,"address":[15996414,15996796],"length":1,"stats":{"Line":0}},{"line":255,"address":[22876979,22877383,22877044],"length":1,"stats":{"Line":0}},{"line":256,"address":[23338007,23337759],"length":1,"stats":{"Line":0}},{"line":257,"address":[15996468,15996557,15996533,15996738],"length":1,"stats":{"Line":0}},{"line":258,"address":[15996559,15996690],"length":1,"stats":{"Line":0}},{"line":260,"address":[17573285],"length":1,"stats":{"Line":0}},{"line":263,"address":[16218914],"length":1,"stats":{"Line":0}},{"line":264,"address":[23337854],"length":1,"stats":{"Line":0}},{"line":265,"address":[16274702],"length":1,"stats":{"Line":0}},{"line":266,"address":[15996656],"length":1,"stats":{"Line":0}}],"covered":18,"coverable":111},{"path":["/","home","shift","code","vincents-ai","engram","src","perkeep","mod.rs"],"content":"//! Perkeep backup integration for Engram\n//!\n//! Provides backup and restore capabilities using Perkeep (perkeep.org),\n//! a personal storage system for content-addressable data.\n//!\n//! ## Perkeep Overview\n//!\n//! Perkeep is a personal data store that provides:\n//! - Content-addressable blob storage (SHA-256 based)\n//! - Schema-based metadata for files\n//! - HTTP API for all operations\n//! - Strong immutability guarantees\n//!\n//! ## Usage\n//!\n//! ```bash\n//! # Configure Perkeep server\n//! export PERKEEP_SERVER=\"http://localhost:3179\"\n//!\n//! # Backup all entities to Perkeep\n//! engram perkeep backup\n//!\n//! # Restore from Perkeep\n//! engram perkeep restore --blobref \"sha256-...\"\n//!\n//! # List backups\n//! engram perkeep list\n//! ```\n\nuse crate::error::EngramError;\nuse digest::Digest;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n/// Perkeep client configuration\n#[derive(Debug, Clone)]\npub struct PerkeepConfig {\n    /// Perkeep server URL\n    pub server_url: String,\n\n    /// Authentication token (if required)\n    pub auth_token: Option\u003cString\u003e,\n\n    /// Whether to verify TLS certificates\n    pub verify_tls: bool,\n}\n\nimpl Default for PerkeepConfig {\n    fn default() -\u003e Self {\n        Self {\n            server_url: std::env::var(\"PERKEEP_SERVER\")\n                .unwrap_or_else(|_| \"http://localhost:3179\".to_string()),\n            auth_token: std::env::var(\"PERKEEP_AUTH_TOKEN\").ok(),\n            verify_tls: true,\n        }\n    }\n}\n\n/// Perkeep blob reference\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct BlobRef {\n    /// Blob reference string (e.g., \"sha256-abc123...\")\n    pub blobref: String,\n\n    /// File size in bytes\n    pub size: u64,\n\n    /// SHA-256 hash\n    pub sha256: String,\n}\n\n/// Perkeep schema object\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SchemaObject {\n    /// Object type (e.g., \"perkeep.net/schema/blob/ref\")\n    #[serde(rename = \"camliType\")]\n    pub camli_type: String,\n\n    /// Base URL for blob references\n    #[serde(rename = \"baseValueRef\")]\n    pub base_value_ref: Option\u003cBlobRef\u003e,\n\n    /// File metadata\n    #[serde(rename = \"fileName\")]\n    pub file_name: Option\u003cString\u003e,\n\n    /// MIME type\n    #[serde(rename = \"mimeType\")]\n    pub mime_type: Option\u003cString\u003e,\n\n    /// File size\n    pub size: Option\u003cu64\u003e,\n\n    /// Title\n    pub title: Option\u003cString\u003e,\n\n    /// Description\n    pub description: Option\u003cString\u003e,\n\n    /// Creation time (ISO 8601)\n    #[serde(rename = \"creationTime\")]\n    pub creation_time: Option\u003cString\u003e,\n\n    /// Custom attributes\n    #[serde(rename = \"camliEtc\")]\n    pub custom_attributes: Option\u003cHashMap\u003cString, serde_json::Value\u003e\u003e,\n}\n\n/// Perkeep client for API communication\n#[derive(Debug, Clone)]\npub struct PerkeepClient {\n    config: PerkeepConfig,\n    client: reqwest::Client,\n}\n\nimpl PerkeepClient {\n    /// Create a new Perkeep client\n    pub fn new(config: PerkeepConfig) -\u003e Result\u003cSelf, EngramError\u003e {\n        let mut builder = reqwest::ClientBuilder::new();\n\n        if !config.verify_tls {\n            builder = builder.danger_accept_invalid_certs(true);\n        }\n\n        let client = builder.build().map_err(|e| {\n            EngramError::InvalidOperation(format!(\"Failed to create HTTP client: {}\", e))\n        })?;\n\n        Ok(Self { config, client })\n    }\n\n    /// Get server URL\n    pub fn server_url(\u0026self) -\u003e \u0026str {\n        \u0026self.config.server_url\n    }\n\n    /// Get the blob upload URL\n    fn upload_url(\u0026self) -\u003e String {\n        format!(\"{}/blob/upload\", self.config.server_url)\n    }\n\n    /// Get the search API URL\n    fn search_url(\u0026self) -\u003e String {\n        format!(\"{}/search/query\", self.config.server_url)\n    }\n\n    /// Get the blob fetch URL\n    fn blob_url(\u0026self, blobref: \u0026str) -\u003e String {\n        format!(\"{}/blobs/{}\", self.config.server_url, blobref)\n    }\n\n    /// Add authentication header if configured\n    fn add_auth(\u0026self, request: reqwest::RequestBuilder) -\u003e reqwest::RequestBuilder {\n        if let Some(token) = \u0026self.config.auth_token {\n            request.header(\"Authorization\", format!(\"Bearer {}\", token))\n        } else {\n            request\n        }\n    }\n\n    /// Upload a blob to Perkeep\n    pub async fn upload_blob(\u0026self, data: \u0026[u8]) -\u003e Result\u003cBlobRef, EngramError\u003e {\n        let url = self.upload_url();\n        let sha256 = sha2::Sha256::digest(data);\n        let sha256_hex = hex::encode(sha256);\n        let blobref = format!(\"sha256-{}\", sha256_hex);\n\n        let request = self\n            .client\n            .post(\u0026url)\n            .header(\"Content-Type\", \"application/octet-stream\")\n            .header(\"Content-Length\", data.len().to_string())\n            .body(data.to_vec());\n\n        let response =\n            self.add_auth(request).send().await.map_err(|e| {\n                EngramError::InvalidOperation(format!(\"Failed to upload blob: {}\", e))\n            })?;\n\n        if !response.status().is_success() {\n            return Err(EngramError::InvalidOperation(format!(\n                \"Upload failed with status: {}\",\n                response.status()\n            )));\n        }\n\n        Ok(BlobRef {\n            blobref,\n            size: data.len() as u64,\n            sha256: sha256_hex,\n        })\n    }\n\n    /// Upload JSON schema metadata\n    pub async fn upload_schema(\u0026self, schema: \u0026SchemaObject) -\u003e Result\u003cBlobRef, EngramError\u003e {\n        let data = serde_json::to_vec(schema).map_err(|e| {\n            EngramError::InvalidOperation(format!(\"Failed to serialize schema: {}\", e))\n        })?;\n\n        self.upload_blob(\u0026data).await\n    }\n\n    /// Fetch a blob by reference\n    pub async fn fetch_blob(\u0026self, blobref: \u0026str) -\u003e Result\u003cOption\u003cVec\u003cu8\u003e\u003e, EngramError\u003e {\n        let url = self.blob_url(blobref);\n\n        let response = self\n            .add_auth(self.client.get(\u0026url))\n            .send()\n            .await\n            .map_err(|e| EngramError::InvalidOperation(format!(\"Failed to fetch blob: {}\", e)))?;\n\n        if response.status() == reqwest::StatusCode::NOT_FOUND {\n            return Ok(None);\n        }\n\n        if !response.status().is_success() {\n            return Err(EngramError::InvalidOperation(format!(\n                \"Fetch failed with status: {}\",\n                response.status()\n            )));\n        }\n\n        let data = response.bytes().await.map_err(|e| {\n            EngramError::InvalidOperation(format!(\"Failed to read blob data: {}\", e))\n        })?;\n\n        Ok(Some(data.to_vec()))\n    }\n\n    /// Search for blobs with a query\n    pub async fn search_blobs(\u0026self, query: \u0026str) -\u003e Result\u003cVec\u003cBlobRef\u003e, EngramError\u003e {\n        let search_query = serde_json::json!({\n            \"expression\": query\n        });\n\n        let response = self\n            .add_auth(\n                self.client\n                    .post(\u0026self.search_url())\n                    .header(\"Content-Type\", \"application/json\"),\n            )\n            .json(\u0026search_query)\n            .send()\n            .await\n            .map_err(|e| EngramError::InvalidOperation(format!(\"Search request failed: {}\", e)))?;\n\n        if !response.status().is_success() {\n            return Err(EngramError::InvalidOperation(format!(\n                \"Search failed with status: {}\",\n                response.status()\n            )));\n        }\n\n        #[derive(Deserialize)]\n        struct SearchResponse {\n            matches: Vec\u003cMatch\u003e,\n        }\n        #[derive(Deserialize)]\n        struct Match {\n            blob: BlobRef,\n        }\n\n        let result: SearchResponse = response.json().await.map_err(|e| {\n            EngramError::InvalidOperation(format!(\"Failed to parse search results: {}\", e))\n        })?;\n\n        Ok(result.matches.into_iter().map(|m| m.blob).collect())\n    }\n\n    /// Check if the Perkeep server is accessible\n    pub async fn health_check(\u0026self) -\u003e Result\u003cbool, EngramError\u003e {\n        let url = format!(\"{}/health\", self.config.server_url);\n\n        match self.add_auth(self.client.get(\u0026url)).send().await {\n            Ok(response) =\u003e Ok(response.status().is_success()),\n            Err(_) =\u003e Ok(false),\n        }\n    }\n}\n\n/// Engram backup metadata stored in Perkeep\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct EngramBackupMetadata {\n    /// Backup version\n    pub version: String,\n\n    /// Backup timestamp (ISO 8601)\n    pub timestamp: String,\n\n    /// Number of entities backed up\n    pub entity_count: usize,\n\n    /// Entity types included\n    pub entity_types: Vec\u003cString\u003e,\n\n    /// Perkeep blob references for each entity\n    #[serde(rename = \"entityBlobRefs\")]\n    pub entity_blob_refs: HashMap\u003cString, String\u003e,\n\n    /// Total size in bytes\n    pub total_size: u64,\n\n    /// Agent that created the backup\n    pub agent: String,\n}\n\nimpl EngramBackupMetadata {\n    /// Create new backup metadata\n    pub fn new(\n        entity_count: usize,\n        entity_types: Vec\u003cString\u003e,\n        entity_blob_refs: HashMap\u003cString, String\u003e,\n        total_size: u64,\n        agent: String,\n    ) -\u003e Self {\n        Self {\n            version: \"1.0.0\".to_string(),\n            timestamp: chrono::Utc::now().to_rfc3339(),\n            entity_count,\n            entity_types,\n            entity_blob_refs,\n            total_size,\n            agent,\n        }\n    }\n}\n","traces":[{"line":49,"address":[17635967,17635728,17635973],"length":1,"stats":{"Line":0}},{"line":51,"address":[17635745],"length":1,"stats":{"Line":0}},{"line":53,"address":[19566203,19566144],"length":1,"stats":{"Line":0}},{"line":118,"address":[17785583,17785056],"length":1,"stats":{"Line":0}},{"line":119,"address":[24514422],"length":1,"stats":{"Line":0}},{"line":121,"address":[17634040,17633892],"length":1,"stats":{"Line":0}},{"line":122,"address":[24975192,24975281],"length":1,"stats":{"Line":0}},{"line":125,"address":[19154357,19154420,19154547],"length":1,"stats":{"Line":0}},{"line":126,"address":[23457935,23457867],"length":1,"stats":{"Line":0}},{"line":129,"address":[17856246],"length":1,"stats":{"Line":0}},{"line":133,"address":[19153872],"length":1,"stats":{"Line":0}},{"line":134,"address":[17633509],"length":1,"stats":{"Line":0}},{"line":138,"address":[17633520],"length":1,"stats":{"Line":0}},{"line":139,"address":[19564053],"length":1,"stats":{"Line":0}},{"line":143,"address":[17784624],"length":1,"stats":{"Line":0}},{"line":144,"address":[24974661],"length":1,"stats":{"Line":0}},{"line":148,"address":[17786048],"length":1,"stats":{"Line":0}},{"line":149,"address":[17845331],"length":1,"stats":{"Line":0}},{"line":153,"address":[24976051,24976022,24975632],"length":1,"stats":{"Line":0}},{"line":154,"address":[19154765,19154910],"length":1,"stats":{"Line":0}},{"line":155,"address":[24976035,24975811,24975728],"length":1,"stats":{"Line":0}},{"line":157,"address":[24515124],"length":1,"stats":{"Line":0}},{"line":162,"address":[19564178,19564160],"length":1,"stats":{"Line":0}},{"line":163,"address":[16778812],"length":1,"stats":{"Line":0}},{"line":164,"address":[16719668],"length":1,"stats":{"Line":0}},{"line":165,"address":[16778986,16779076],"length":1,"stats":{"Line":0}},{"line":166,"address":[14836687,14836767],"length":1,"stats":{"Line":0}},{"line":168,"address":[16790801,16791016,16791159],"length":1,"stats":{"Line":0}},{"line":170,"address":[16779285],"length":1,"stats":{"Line":0}},{"line":172,"address":[18173596,18173792,18173704,18173743,18174202],"length":1,"stats":{"Line":0}},{"line":173,"address":[16779598,16779647,16779572,16779876,16779316],"length":1,"stats":{"Line":0}},{"line":175,"address":[18175785,18174055,18175779,18174262,18174582,18173142,18173983,18175428,18175536],"length":1,"stats":{"Line":0}},{"line":177,"address":[16722027,16722095],"length":1,"stats":{"Line":0}},{"line":180,"address":[23911179,23911240],"length":1,"stats":{"Line":0}},{"line":181,"address":[17830462],"length":1,"stats":{"Line":0}},{"line":183,"address":[16577157,16577406],"length":1,"stats":{"Line":0}},{"line":187,"address":[16792123],"length":1,"stats":{"Line":0}},{"line":188,"address":[17830217],"length":1,"stats":{"Line":0}},{"line":189,"address":[23450664],"length":1,"stats":{"Line":0}},{"line":190,"address":[18174860],"length":1,"stats":{"Line":0}},{"line":195,"address":[16798528,16798058,16797971,16798584,16797936,16798100],"length":1,"stats":{"Line":0}},{"line":196,"address":[16787014,16787715,16787472,16787721,16786622,16786731,16786519],"length":1,"stats":{"Line":0}},{"line":197,"address":[18181787,18181855],"length":1,"stats":{"Line":0}},{"line":200,"address":[23457191,23456926,23456661,23457007],"length":1,"stats":{"Line":0}},{"line":204,"address":[23906933,23906464,23908102,23906502,23906604,23906673,23906647],"length":1,"stats":{"Line":0}},{"line":205,"address":[16775821],"length":1,"stats":{"Line":0}},{"line":207,"address":[14833766,14834067,14834006,14834150,14834937],"length":1,"stats":{"Line":0}},{"line":208,"address":[23446128,23446050],"length":1,"stats":{"Line":0}},{"line":210,"address":[18170484,18170653,18170374,18170433,18170154],"length":1,"stats":{"Line":0}},{"line":211,"address":[16776380,16778155,16778128,16776462],"length":1,"stats":{"Line":0}},{"line":213,"address":[23907459,23907400],"length":1,"stats":{"Line":0}},{"line":214,"address":[16573396],"length":1,"stats":{"Line":0}},{"line":217,"address":[18171132,18171028],"length":1,"stats":{"Line":0}},{"line":218,"address":[17826670],"length":1,"stats":{"Line":0}},{"line":220,"address":[16573614,16573526],"length":1,"stats":{"Line":0}},{"line":224,"address":[23875858],"length":1,"stats":{"Line":0}},{"line":225,"address":[18172715,18172783],"length":1,"stats":{"Line":0}},{"line":228,"address":[16718585,16718514],"length":1,"stats":{"Line":0}},{"line":232,"address":[17784976,17784994],"length":1,"stats":{"Line":0}},{"line":233,"address":[16783089,16783160,16782948,16783051,16783782],"length":1,"stats":{"Line":0}},{"line":237,"address":[16724752,16724904,16724487,16724801],"length":1,"stats":{"Line":0}},{"line":239,"address":[16794933],"length":1,"stats":{"Line":0}},{"line":240,"address":[16794945,16795015],"length":1,"stats":{"Line":0}},{"line":241,"address":[23453656],"length":1,"stats":{"Line":0}},{"line":243,"address":[14841217],"length":1,"stats":{"Line":0}},{"line":245,"address":[14841306,14840550,14841267,14841385,14841551],"length":1,"stats":{"Line":0}},{"line":246,"address":[17004734,17004699],"length":1,"stats":{"Line":0}},{"line":248,"address":[17834011],"length":1,"stats":{"Line":0}},{"line":249,"address":[17834178],"length":1,"stats":{"Line":0}},{"line":251,"address":[16725234,16725146],"length":1,"stats":{"Line":0}},{"line":264,"address":[16582464,16581406,16582713,16582707,16581865,16581538,16581055,16579637],"length":1,"stats":{"Line":0}},{"line":265,"address":[17835531,17835599],"length":1,"stats":{"Line":0}},{"line":268,"address":[16786124,16785442,16786096,16785334],"length":1,"stats":{"Line":0}},{"line":272,"address":[17784952,17784944],"length":1,"stats":{"Line":0}},{"line":273,"address":[14839179,14839290],"length":1,"stats":{"Line":0}},{"line":275,"address":[14258519],"length":1,"stats":{"Line":0}},{"line":276,"address":[23913197],"length":1,"stats":{"Line":0}},{"line":277,"address":[23913139],"length":1,"stats":{"Line":0}},{"line":310,"address":[24515616,24516144,24516106],"length":1,"stats":{"Line":0}},{"line":318,"address":[19275577],"length":1,"stats":{"Line":0}},{"line":319,"address":[17635149,17635203],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":81},{"path":["/","home","shift","code","vincents-ai","engram","src","quality_gates","complexity_analyzer.rs"],"content":"use crate::entities::Task;\n\n#[derive(Debug, Clone, PartialEq, PartialOrd)]\npub enum ComplexityLevel {\n    Low,\n    Medium,\n    High,\n    Critical,\n}\n\npub struct ComplexityAnalyzer;\n\nimpl ComplexityAnalyzer {\n    pub fn analyze_task(task: \u0026Task) -\u003e ComplexityLevel {\n        let mut complexity_score = 0;\n\n        if task.description.len() \u003e 200 {\n            complexity_score += 1;\n        }\n\n        if task.description.contains(\"refactor\") || task.description.contains(\"migration\") {\n            complexity_score += 2;\n        }\n\n        if task.description.contains(\"architecture\") || task.description.contains(\"security\") {\n            complexity_score += 3;\n        }\n\n        match complexity_score {\n            0..=1 =\u003e ComplexityLevel::Low,\n            2..=3 =\u003e ComplexityLevel::Medium,\n            4..=5 =\u003e ComplexityLevel::High,\n            _ =\u003e ComplexityLevel::Critical,\n        }\n    }\n\n    pub fn analyze_change_context(\n        changed_files: \u0026[String],\n        commit_message: \u0026Option\u003cString\u003e,\n    ) -\u003e ComplexityLevel {\n        let mut complexity_score = 0;\n\n        if changed_files.len() \u003e 10 {\n            complexity_score += 2;\n        }\n\n        if let Some(message) = commit_message {\n            if message.contains(\"breaking\") || message.contains(\"BREAKING\") {\n                complexity_score += 3;\n            }\n\n            if message.contains(\"fix\") \u0026\u0026 message.contains(\"critical\") {\n                complexity_score += 2;\n            }\n        }\n\n        for file in changed_files {\n            if file.contains(\"migration\") || file.contains(\"schema\") {\n                complexity_score += 2;\n                break;\n            }\n\n            if file.ends_with(\".sql\") || file.contains(\"config\") {\n                complexity_score += 1;\n            }\n        }\n\n        match complexity_score {\n            0..=1 =\u003e ComplexityLevel::Low,\n            2..=4 =\u003e ComplexityLevel::Medium,\n            5..=7 =\u003e ComplexityLevel::High,\n            _ =\u003e ComplexityLevel::Critical,\n        }\n    }\n}\n","traces":[{"line":14,"address":[15662160],"length":1,"stats":{"Line":0}},{"line":15,"address":[19022046],"length":1,"stats":{"Line":0}},{"line":17,"address":[15760810,15760726],"length":1,"stats":{"Line":0}},{"line":18,"address":[16667788,16667763],"length":1,"stats":{"Line":0}},{"line":21,"address":[16983276,16983467,16983358],"length":1,"stats":{"Line":0}},{"line":22,"address":[22857895,22857829,22857901],"length":1,"stats":{"Line":0}},{"line":25,"address":[19022362,19022220,19022287],"length":1,"stats":{"Line":0}},{"line":26,"address":[15733222,15733260,15733254],"length":1,"stats":{"Line":0}},{"line":30,"address":[15761016,15761062],"length":1,"stats":{"Line":0}},{"line":31,"address":[22397377,22397337],"length":1,"stats":{"Line":0}},{"line":32,"address":[15662532,15662566],"length":1,"stats":{"Line":0}},{"line":33,"address":[16668079],"length":1,"stats":{"Line":0}},{"line":37,"address":[22858096],"length":1,"stats":{"Line":0}},{"line":41,"address":[22858133],"length":1,"stats":{"Line":0}},{"line":43,"address":[15733474,15733405],"length":1,"stats":{"Line":0}},{"line":44,"address":[15662682,15662708],"length":1,"stats":{"Line":0}},{"line":47,"address":[15733416,15733494],"length":1,"stats":{"Line":0}},{"line":48,"address":[15511483,15511554,15511658],"length":1,"stats":{"Line":0}},{"line":49,"address":[22397669,22397734,22397740],"length":1,"stats":{"Line":0}},{"line":52,"address":[15761470,15761404,15761532],"length":1,"stats":{"Line":0}},{"line":53,"address":[22858497,22858468],"length":1,"stats":{"Line":0}},{"line":57,"address":[22858280,22858510],"length":1,"stats":{"Line":0}},{"line":58,"address":[15511820,15511877],"length":1,"stats":{"Line":0}},{"line":59,"address":[15761852,15761704],"length":1,"stats":{"Line":0}},{"line":63,"address":[15512038,15511939],"length":1,"stats":{"Line":0}},{"line":64,"address":[16984363,16984335],"length":1,"stats":{"Line":0}},{"line":69,"address":[16668623,16668863],"length":1,"stats":{"Line":0}},{"line":70,"address":[22858834,22858874],"length":1,"stats":{"Line":0}},{"line":71,"address":[16668911,16668877],"length":1,"stats":{"Line":0}},{"line":72,"address":[15512136],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":30},{"path":["/","home","shift","code","vincents-ai","engram","src","quality_gates","level_selector.rs"],"content":"use super::{GateContext, QualityGateResult};\nuse crate::entities::progressive_config::GateLevel;\n\npub struct LevelSelector;\n\nimpl LevelSelector {\n    pub fn select_level\u003c'a\u003e(\n        context: \u0026GateContext,\n        available_levels: \u0026'a [GateLevel],\n    ) -\u003e QualityGateResult\u003c\u0026'a GateLevel\u003e {\n        for level in available_levels {\n            if Self::matches_threshold(context, \u0026level.threshold) {\n                return Ok(level);\n            }\n        }\n\n        available_levels.first().ok_or_else(|| {\n            super::QualityGateError::ConfigError(\"No gate levels available\".to_string())\n        })\n    }\n\n    fn matches_threshold(\n        context: \u0026GateContext,\n        threshold: \u0026crate::entities::progressive_config::ChangeThreshold,\n    ) -\u003e bool {\n        let lines_changed = context.changed_files.len() as u32 * 50;\n        let files_affected = context.changed_files.len() as u32;\n\n        lines_changed \u003c= threshold.max_lines_changed\n            \u0026\u0026 files_affected \u003c= threshold.max_files_affected\n    }\n}\n","traces":[{"line":7,"address":[21756240],"length":1,"stats":{"Line":0}},{"line":11,"address":[28002156,28002172],"length":1,"stats":{"Line":0}},{"line":12,"address":[17337129],"length":1,"stats":{"Line":0}},{"line":13,"address":[21756443],"length":1,"stats":{"Line":0}},{"line":17,"address":[16228032],"length":1,"stats":{"Line":0}},{"line":18,"address":[18641742],"length":1,"stats":{"Line":0}},{"line":22,"address":[20883072],"length":1,"stats":{"Line":0}},{"line":26,"address":[17337322,17337240],"length":1,"stats":{"Line":0}},{"line":27,"address":[28002386],"length":1,"stats":{"Line":0}},{"line":29,"address":[20812423,20812403],"length":1,"stats":{"Line":0}},{"line":30,"address":[20661191],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":11},{"path":["/","home","shift","code","vincents-ai","engram","src","quality_gates","mod.rs"],"content":"pub mod complexity_analyzer;\npub mod level_selector;\npub mod progressive_engine;\n\npub use complexity_analyzer::ComplexityAnalyzer;\npub use level_selector::LevelSelector;\npub use progressive_engine::ProgressiveEngine;\n\nuse crate::entities::Task;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\nuse thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum QualityGateError {\n    #[error(\"Storage error: {0}\")]\n    StorageError(String),\n\n    #[error(\"Configuration error: {0}\")]\n    ConfigError(String),\n\n    #[error(\"Analysis error: {0}\")]\n    AnalysisError(String),\n\n    #[error(\"Gate execution failed: {0}\")]\n    ExecutionError(String),\n}\n\npub type QualityGateResult\u003cT\u003e = Result\u003cT, QualityGateError\u003e;\n\n/// Represents the result of a quality gate execution\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct GateResult {\n    pub gate_type: String,\n    pub success: bool,\n    pub score: Option\u003cf64\u003e,\n    pub details: HashMap\u003cString, serde_json::Value\u003e,\n    pub execution_time_ms: u64,\n    pub recommendations: Vec\u003cString\u003e,\n}\n\n/// Context for quality gate execution\n#[derive(Debug, Clone)]\npub struct GateContext {\n    pub task: Task,\n    pub changed_files: Vec\u003cString\u003e,\n    pub commit_message: Option\u003cString\u003e,\n    pub branch_name: Option\u003cString\u003e,\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","quality_gates","progressive_engine.rs"],"content":"use super::level_selector::LevelSelector;\nuse super::{GateContext, GateResult, QualityGateError, QualityGateResult};\nuse crate::entities::progressive_config::QualityGate;\nuse crate::entities::{Entity, ProgressiveGateConfig, Task};\nuse crate::storage::Storage;\nuse std::collections::HashMap;\nuse std::time::Instant;\n\npub struct ProgressiveEngine\u003cS: Storage\u003e {\n    storage: Box\u003cS\u003e,\n    config_cache: HashMap\u003cString, ProgressiveGateConfig\u003e,\n}\n\nimpl\u003cS: Storage\u003e ProgressiveEngine\u003cS\u003e {\n    pub fn new(storage: Box\u003cS\u003e) -\u003e Self {\n        Self {\n            storage,\n            config_cache: HashMap::new(),\n        }\n    }\n\n    pub async fn execute_gates(\n        \u0026mut self,\n        context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cVec\u003cGateResult\u003e\u003e {\n        let _start_time = Instant::now();\n\n        let config = self.get_config_for_task(\u0026context.task).await?;\n        let selected_level = LevelSelector::select_level(context, \u0026config.gate_levels)?;\n\n        let mut results = Vec::new();\n\n        for gate_config in \u0026selected_level.required_gates {\n            let gate_result = self.execute_single_gate(gate_config, context).await?;\n            let success = gate_result.success;\n            results.push(gate_result);\n\n            if !success \u0026\u0026 selected_level.failure_handling.fail_fast {\n                break;\n            }\n        }\n\n        if results.iter().all(|r| r.success) {\n            for gate_config in \u0026selected_level.optional_gates {\n                let gate_result = self.execute_single_gate(gate_config, context).await?;\n                results.push(gate_result);\n            }\n        }\n\n        let _total_time = _start_time.elapsed().as_millis() as u64;\n\n        Ok(results)\n    }\n\n    async fn get_config_for_task(\n        \u0026mut self,\n        task: \u0026Task,\n    ) -\u003e QualityGateResult\u003cProgressiveGateConfig\u003e {\n        if let Some(cached_config) = self.config_cache.get(\u0026task.id) {\n            return Ok(cached_config.clone());\n        }\n\n        let config_id = format!(\"progressive_gate_config_{}\", task.id);\n\n        match self.storage.get(\u0026config_id, \"progressive_gate_config\") {\n            Ok(Some(entity)) =\u003e {\n                let config = ProgressiveGateConfig::from_generic(entity)\n                    .map_err(|e| QualityGateError::ConfigError(e.to_string()))?;\n                self.config_cache.insert(task.id.clone(), config.clone());\n                Ok(config)\n            }\n            Ok(None) =\u003e {\n                let default_config = self.create_default_config(task).await?;\n                self.config_cache\n                    .insert(task.id.clone(), default_config.clone());\n                Ok(default_config)\n            }\n            Err(e) =\u003e Err(QualityGateError::StorageError(e.to_string())),\n        }\n    }\n\n    async fn create_default_config(\u0026self, task: \u0026Task) -\u003e QualityGateResult\u003cProgressiveGateConfig\u003e {\n        let config =\n            ProgressiveGateConfig::new(format!(\"config_{}\", task.id), \"system\".to_string());\n\n        Ok(config)\n    }\n\n    async fn execute_single_gate(\n        \u0026self,\n        gate_config: \u0026QualityGate,\n        context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cGateResult\u003e {\n        let start_time = Instant::now();\n\n        let result = match gate_config.name.as_str() {\n            \"syntax_check\" =\u003e self.execute_syntax_check(context).await,\n            \"unit_tests\" =\u003e self.execute_unit_tests(context).await,\n            \"integration_tests\" =\u003e self.execute_integration_tests(context).await,\n            \"security_scan\" =\u003e self.execute_security_scan(context).await,\n            \"performance_test\" =\u003e self.execute_performance_test(context).await,\n            \"code_coverage\" =\u003e self.execute_code_coverage(context).await,\n            \"dependency_check\" =\u003e self.execute_dependency_check(context).await,\n            \"documentation_check\" =\u003e self.execute_documentation_check(context).await,\n            _ =\u003e {\n                return Err(QualityGateError::ConfigError(format!(\n                    \"Unknown gate type: {}\",\n                    gate_config.name\n                )))\n            }\n        }?;\n\n        let execution_time = start_time.elapsed().as_millis() as u64;\n\n        Ok(GateResult {\n            gate_type: gate_config.name.clone(),\n            success: result.success,\n            score: result.score,\n            details: result.details,\n            execution_time_ms: execution_time,\n            recommendations: result.recommendations,\n        })\n    }\n\n    async fn execute_syntax_check(\n        \u0026self,\n        _context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cSingleGateResult\u003e {\n        let mut details = HashMap::new();\n        details.insert(\n            \"check_type\".to_string(),\n            serde_json::Value::String(\"syntax\".to_string()),\n        );\n\n        Ok(SingleGateResult {\n            success: true,\n            score: Some(100.0),\n            details,\n            recommendations: vec![\"Syntax validation passed\".to_string()],\n        })\n    }\n\n    async fn execute_unit_tests(\n        \u0026self,\n        _context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cSingleGateResult\u003e {\n        let mut details = HashMap::new();\n        details.insert(\n            \"tests_run\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from(42)),\n        );\n        details.insert(\n            \"tests_passed\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from(40)),\n        );\n        details.insert(\n            \"tests_failed\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from(2)),\n        );\n\n        Ok(SingleGateResult {\n            success: true,\n            score: Some(95.2),\n            details,\n            recommendations: vec![\"Consider adding more edge case tests\".to_string()],\n        })\n    }\n\n    async fn execute_integration_tests(\n        \u0026self,\n        _context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cSingleGateResult\u003e {\n        let mut details = HashMap::new();\n        details.insert(\n            \"integration_suites_run\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from(5)),\n        );\n\n        Ok(SingleGateResult {\n            success: true,\n            score: Some(88.0),\n            details,\n            recommendations: vec![\"Integration tests completed successfully\".to_string()],\n        })\n    }\n\n    async fn execute_security_scan(\n        \u0026self,\n        _context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cSingleGateResult\u003e {\n        let mut details = HashMap::new();\n        details.insert(\n            \"vulnerabilities_found\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from(0)),\n        );\n        details.insert(\n            \"scan_type\".to_string(),\n            serde_json::Value::String(\"static_analysis\".to_string()),\n        );\n\n        Ok(SingleGateResult {\n            success: true,\n            score: Some(100.0),\n            details,\n            recommendations: vec![\"No security vulnerabilities detected\".to_string()],\n        })\n    }\n\n    async fn execute_performance_test(\n        \u0026self,\n        _context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cSingleGateResult\u003e {\n        let mut details = HashMap::new();\n        details.insert(\n            \"avg_response_time_ms\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from(120)),\n        );\n        details.insert(\n            \"throughput_rps\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from(850)),\n        );\n\n        Ok(SingleGateResult {\n            success: true,\n            score: Some(92.5),\n            details,\n            recommendations: vec![\"Performance within acceptable thresholds\".to_string()],\n        })\n    }\n\n    async fn execute_code_coverage(\n        \u0026self,\n        _context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cSingleGateResult\u003e {\n        let mut details = HashMap::new();\n        details.insert(\n            \"line_coverage_percent\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from_f64(87.3).unwrap()),\n        );\n        details.insert(\n            \"branch_coverage_percent\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from_f64(82.1).unwrap()),\n        );\n\n        Ok(SingleGateResult {\n            success: true,\n            score: Some(87.3),\n            details,\n            recommendations: vec![\"Consider adding tests for uncovered branches\".to_string()],\n        })\n    }\n\n    async fn execute_dependency_check(\n        \u0026self,\n        _context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cSingleGateResult\u003e {\n        let mut details = HashMap::new();\n        details.insert(\n            \"outdated_dependencies\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from(2)),\n        );\n        details.insert(\n            \"security_advisories\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from(0)),\n        );\n\n        Ok(SingleGateResult {\n            success: true,\n            score: Some(95.0),\n            details,\n            recommendations: vec![\"Consider updating 2 outdated dependencies\".to_string()],\n        })\n    }\n\n    async fn execute_documentation_check(\n        \u0026self,\n        _context: \u0026GateContext,\n    ) -\u003e QualityGateResult\u003cSingleGateResult\u003e {\n        let mut details = HashMap::new();\n        details.insert(\n            \"documented_functions_percent\".to_string(),\n            serde_json::Value::Number(serde_json::Number::from_f64(76.5).unwrap()),\n        );\n        details.insert(\"readme_updated\".to_string(), serde_json::Value::Bool(true));\n\n        Ok(SingleGateResult {\n            success: true,\n            score: Some(76.5),\n            details,\n            recommendations: vec![\"Add documentation for remaining 23.5% of functions\".to_string()],\n        })\n    }\n}\n\n#[derive(Debug, Clone)]\nstruct SingleGateResult {\n    success: bool,\n    score: Option\u003cf64\u003e,\n    details: HashMap\u003cString, serde_json::Value\u003e,\n    recommendations: Vec\u003cString\u003e,\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":150},{"path":["/","home","shift","code","vincents-ai","engram","src","sandbox","command_validator.rs"],"content":"use crate::entities::{\n    BuiltinCommandType, CommandFilter, CommandPattern, DangerousPattern, ParameterRestriction,\n    RiskLevel,\n};\nuse crate::sandbox::{CommandValidationResult, SandboxRequest, SandboxResult};\nuse regex::Regex;\nuse std::collections::HashMap;\n\npub struct CommandValidator {\n    compiled_patterns: HashMap\u003cString, Regex\u003e,\n}\n\nimpl CommandValidator {\n    pub fn new() -\u003e Self {\n        Self {\n            compiled_patterns: HashMap::new(),\n        }\n    }\n\n    pub async fn validate_command(\n        \u0026mut self,\n        request: \u0026SandboxRequest,\n        filter: \u0026CommandFilter,\n    ) -\u003e SandboxResult\u003cCommandValidationResult\u003e {\n        if filter.whitelist_mode {\n            return self.validate_whitelist(request, filter).await;\n        } else {\n            return self.validate_blacklist(request, filter).await;\n        }\n    }\n\n    async fn validate_whitelist(\n        \u0026mut self,\n        request: \u0026SandboxRequest,\n        filter: \u0026CommandFilter,\n    ) -\u003e SandboxResult\u003cCommandValidationResult\u003e {\n        if self.matches_any_pattern(\u0026request.operation, \u0026filter.allowed_commands)? {\n            return self.check_parameters(request, filter).await;\n        }\n\n        Ok(CommandValidationResult::Block(format!(\n            \"Command '{}' not in allowed list\",\n            request.operation\n        )))\n    }\n\n    async fn validate_blacklist(\n        \u0026mut self,\n        request: \u0026SandboxRequest,\n        filter: \u0026CommandFilter,\n    ) -\u003e SandboxResult\u003cCommandValidationResult\u003e {\n        if self.matches_any_pattern(\u0026request.operation, \u0026filter.forbidden_commands)? {\n            return Ok(CommandValidationResult::Block(format!(\n                \"Command '{}' is explicitly forbidden\",\n                request.operation\n            )));\n        }\n\n        if self.matches_dangerous_pattern(request, filter).await? {\n            return Ok(CommandValidationResult::RequiresApproval);\n        }\n\n        self.check_parameters(request, filter).await\n    }\n\n    fn matches_any_pattern(\n        \u0026mut self,\n        command: \u0026str,\n        patterns: \u0026[CommandPattern],\n    ) -\u003e SandboxResult\u003cbool\u003e {\n        for pattern in patterns {\n            if self.matches_pattern(command, pattern)? {\n                return Ok(true);\n            }\n        }\n        Ok(false)\n    }\n\n    fn matches_pattern(\u0026mut self, command: \u0026str, pattern: \u0026CommandPattern) -\u003e SandboxResult\u003cbool\u003e {\n        match pattern {\n            CommandPattern::Exact {\n                command: pattern_cmd,\n            } =\u003e Ok(command == pattern_cmd),\n            CommandPattern::Prefix { prefix } =\u003e Ok(command.starts_with(prefix)),\n            CommandPattern::Regex {\n                pattern: regex_pattern,\n            } =\u003e self.matches_regex_string(command, regex_pattern),\n            CommandPattern::Builtin { command_type } =\u003e {\n                self.matches_builtin_command(command, command_type)\n            }\n        }\n    }\n\n    fn matches_builtin_command(\n        \u0026self,\n        command: \u0026str,\n        command_type: \u0026BuiltinCommandType,\n    ) -\u003e SandboxResult\u003cbool\u003e {\n        match command_type {\n            BuiltinCommandType::Git =\u003e Ok(command.starts_with(\"git_\")),\n            BuiltinCommandType::Cargo =\u003e Ok(command.starts_with(\"cargo_\")),\n            BuiltinCommandType::Engram =\u003e Ok(command.starts_with(\"engram_\")),\n            BuiltinCommandType::FileSystem =\u003e Ok(matches!(\n                command,\n                \"read_file\" | \"write_file\" | \"delete_file\" | \"list_files\" | \"create_file\"\n            )),\n            BuiltinCommandType::Network =\u003e Ok(matches!(\n                command,\n                \"network_request\" | \"http_get\" | \"http_post\" | \"download_file\"\n            )),\n            BuiltinCommandType::System =\u003e Ok(matches!(\n                command,\n                \"execute_command\" | \"system_info\" | \"process_list\"\n            )),\n        }\n    }\n\n    async fn check_parameters(\n        \u0026mut self,\n        request: \u0026SandboxRequest,\n        filter: \u0026CommandFilter,\n    ) -\u003e SandboxResult\u003cCommandValidationResult\u003e {\n        if let Some(restriction) = filter.parameter_restrictions.get(\u0026request.operation) {\n            for (param_name, param_value) in request\n                .parameters\n                .as_object()\n                .unwrap_or(\u0026serde_json::Map::new())\n            {\n                if let Err(error_msg) = self.validate_parameter(param_value, restriction) {\n                    return Ok(CommandValidationResult::Block(format!(\n                        \"Parameter '{}': {}\",\n                        param_name, error_msg\n                    )));\n                }\n            }\n        }\n\n        Ok(CommandValidationResult::Allow)\n    }\n\n    fn validate_parameter(\n        \u0026mut self,\n        value: \u0026serde_json::Value,\n        restriction: \u0026ParameterRestriction,\n    ) -\u003e Result\u003c(), String\u003e {\n        let value_str = match value.as_str() {\n            Some(s) =\u003e s,\n            None =\u003e \u0026serde_json::to_string(value).unwrap_or_default(),\n        };\n\n        if !restriction.allowed_values.is_empty() {\n            if !restriction.allowed_values.contains(\u0026value_str.to_string()) {\n                return Err(format!(\"Value '{}' not in allowed list\", value_str));\n            }\n        }\n\n        if restriction\n            .forbidden_values\n            .contains(\u0026value_str.to_string())\n        {\n            return Err(format!(\"Value '{}' is forbidden\", value_str));\n        }\n\n        if let Some(max_len) = restriction.max_length {\n            if value_str.len() \u003e max_len {\n                return Err(format!(\n                    \"Value length {} exceeds maximum {}\",\n                    value_str.len(),\n                    max_len\n                ));\n            }\n        }\n\n        if let Some(pattern) = \u0026restriction.pattern_validation {\n            if !self\n                .matches_regex_string(value_str, pattern)\n                .unwrap_or(false)\n            {\n                return Err(\"Value does not match required pattern\".to_string());\n            }\n        }\n\n        Ok(())\n    }\n\n    async fn matches_dangerous_pattern(\n        \u0026mut self,\n        request: \u0026SandboxRequest,\n        filter: \u0026CommandFilter,\n    ) -\u003e SandboxResult\u003cbool\u003e {\n        for dangerous_pattern in \u0026filter.dangerous_patterns {\n            if self.check_dangerous_pattern(request, dangerous_pattern)? {\n                return Ok(true);\n            }\n        }\n\n        Ok(false)\n    }\n\n    fn check_dangerous_pattern(\n        \u0026mut self,\n        request: \u0026SandboxRequest,\n        pattern: \u0026DangerousPattern,\n    ) -\u003e SandboxResult\u003cbool\u003e {\n        if request.operation.contains(\u0026pattern.pattern) {\n            return Ok(true);\n        }\n\n        if let Some(command_str) = request.parameters.get(\"command\") {\n            if let Some(cmd) = command_str.as_str() {\n                if cmd.contains(\u0026pattern.pattern) {\n                    return Ok(true);\n                }\n            }\n        }\n\n        if self.matches_regex_string(\n            \u0026serde_json::to_string(request).unwrap_or_default(),\n            \u0026pattern.pattern,\n        )? {\n            return Ok(true);\n        }\n\n        Ok(false)\n    }\n\n    fn matches_regex_string(\u0026mut self, text: \u0026str, pattern: \u0026str) -\u003e SandboxResult\u003cbool\u003e {\n        let regex = if let Some(cached_regex) = self.compiled_patterns.get(pattern) {\n            cached_regex\n        } else {\n            match Regex::new(pattern) {\n                Ok(regex) =\u003e {\n                    self.compiled_patterns.insert(pattern.to_string(), regex);\n                    self.compiled_patterns.get(pattern).unwrap()\n                }\n                Err(_) =\u003e return Ok(false),\n            }\n        };\n\n        Ok(regex.is_match(text))\n    }\n\n    pub fn clear_pattern_cache(\u0026mut self) {\n        self.compiled_patterns.clear();\n    }\n\n    pub fn add_pattern(\u0026mut self, pattern: String) -\u003e Result\u003c(), regex::Error\u003e {\n        let regex = Regex::new(\u0026pattern)?;\n        self.compiled_patterns.insert(pattern, regex);\n        Ok(())\n    }\n\n    pub fn remove_pattern(\u0026mut self, pattern: \u0026str) {\n        self.compiled_patterns.remove(pattern);\n    }\n\n    pub fn validate_command_syntax(command: \u0026str) -\u003e bool {\n        if command.is_empty() {\n            return false;\n        }\n\n        let dangerous_keywords = [\n            \"rm -rf\",\n            \"sudo\",\n            \"chmod 777\",\n            \"eval\",\n            \"exec\",\n            \"\u003e /dev/\",\n            \"dd if=\",\n            \"mkfs\",\n            \"fdisk\",\n            \":(){:|:\u0026};:\",\n        ];\n\n        for keyword in \u0026dangerous_keywords {\n            if command.contains(keyword) {\n                return false;\n            }\n        }\n\n        true\n    }\n\n    pub fn estimate_command_risk(command: \u0026str) -\u003e RiskLevel {\n        if command.is_empty() {\n            return RiskLevel::Low;\n        }\n\n        let high_risk_patterns = [\"rm\", \"del\", \"format\", \"sudo\", \"chmod\", \"chown\"];\n        let medium_risk_patterns = [\"cp\", \"mv\", \"mkdir\", \"rmdir\", \"curl\", \"wget\"];\n\n        for pattern in \u0026high_risk_patterns {\n            if command.contains(pattern) {\n                return RiskLevel::High;\n            }\n        }\n\n        for pattern in \u0026medium_risk_patterns {\n            if command.contains(pattern) {\n                return RiskLevel::Medium;\n            }\n        }\n\n        RiskLevel::Low\n    }\n}\n\nimpl Default for CommandValidator {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n","traces":[{"line":14,"address":[20146480],"length":1,"stats":{"Line":0}},{"line":16,"address":[17702654],"length":1,"stats":{"Line":0}},{"line":20,"address":[16658480],"length":1,"stats":{"Line":0}},{"line":25,"address":[24401530],"length":1,"stats":{"Line":0}},{"line":26,"address":[16903423],"length":1,"stats":{"Line":0}},{"line":28,"address":[17212170,17211686,17211564],"length":1,"stats":{"Line":0}},{"line":32,"address":[20142704],"length":1,"stats":{"Line":0}},{"line":37,"address":[18703641,18704313,18703514],"length":1,"stats":{"Line":0}},{"line":38,"address":[17273904,17274208,17274349,17273562],"length":1,"stats":{"Line":0}},{"line":41,"address":[18703926,18703858],"length":1,"stats":{"Line":0}},{"line":47,"address":[17696688],"length":1,"stats":{"Line":0}},{"line":52,"address":[16768271,16768426,16769072],"length":1,"stats":{"Line":0}},{"line":53,"address":[17283810,17283667],"length":1,"stats":{"Line":0}},{"line":59,"address":[24238415],"length":1,"stats":{"Line":0}},{"line":60,"address":[17272971],"length":1,"stats":{"Line":0}},{"line":63,"address":[17048418],"length":1,"stats":{"Line":0}},{"line":66,"address":[16438672],"length":1,"stats":{"Line":0}},{"line":71,"address":[16649265,16649281],"length":1,"stats":{"Line":0}},{"line":72,"address":[16660872,16660959],"length":1,"stats":{"Line":0}},{"line":73,"address":[17957576],"length":1,"stats":{"Line":0}},{"line":76,"address":[20143007],"length":1,"stats":{"Line":0}},{"line":79,"address":[16436128],"length":1,"stats":{"Line":0}},{"line":80,"address":[16658187],"length":1,"stats":{"Line":0}},{"line":81,"address":[16658223],"length":1,"stats":{"Line":0}},{"line":84,"address":[16436261],"length":1,"stats":{"Line":0}},{"line":85,"address":[17954849],"length":1,"stats":{"Line":0}},{"line":88,"address":[16646869],"length":1,"stats":{"Line":0}},{"line":89,"address":[23777646],"length":1,"stats":{"Line":0}},{"line":94,"address":[23321824],"length":1,"stats":{"Line":0}},{"line":99,"address":[16592524],"length":1,"stats":{"Line":0}},{"line":100,"address":[23321910],"length":1,"stats":{"Line":0}},{"line":101,"address":[17701547],"length":1,"stats":{"Line":0}},{"line":102,"address":[16592672],"length":1,"stats":{"Line":0}},{"line":103,"address":[20145636,20145743],"length":1,"stats":{"Line":0}},{"line":105,"address":[20145490,20145613,20145653],"length":1,"stats":{"Line":0}},{"line":107,"address":[16593030,16593106],"length":1,"stats":{"Line":0}},{"line":109,"address":[16663775,16663523,16663815],"length":1,"stats":{"Line":0}},{"line":111,"address":[16593161,16593206],"length":1,"stats":{"Line":0}},{"line":113,"address":[17702106,17702066,17701723],"length":1,"stats":{"Line":0}},{"line":118,"address":[23317008],"length":1,"stats":{"Line":0}},{"line":123,"address":[18549829,18549924],"length":1,"stats":{"Line":0}},{"line":124,"address":[24400476,24400677],"length":1,"stats":{"Line":0}},{"line":126,"address":[16766300],"length":1,"stats":{"Line":0}},{"line":127,"address":[17210571],"length":1,"stats":{"Line":0}},{"line":129,"address":[18550374,18550333],"length":1,"stats":{"Line":0}},{"line":130,"address":[16766850,16766763],"length":1,"stats":{"Line":0}},{"line":138,"address":[17281248],"length":1,"stats":{"Line":0}},{"line":141,"address":[16436560,16437441,16438565],"length":1,"stats":{"Line":0}},{"line":146,"address":[16436642],"length":1,"stats":{"Line":0}},{"line":147,"address":[23317295],"length":1,"stats":{"Line":0}},{"line":148,"address":[20141022,20140892],"length":1,"stats":{"Line":0}},{"line":151,"address":[16647438],"length":1,"stats":{"Line":0}},{"line":152,"address":[16647577,16647481],"length":1,"stats":{"Line":0}},{"line":153,"address":[17697428],"length":1,"stats":{"Line":0}},{"line":157,"address":[16659040,16659602],"length":1,"stats":{"Line":0}},{"line":159,"address":[20141688,20141570],"length":1,"stats":{"Line":0}},{"line":161,"address":[23779625],"length":1,"stats":{"Line":0}},{"line":164,"address":[17697817],"length":1,"stats":{"Line":0}},{"line":165,"address":[20141861,20141766],"length":1,"stats":{"Line":0}},{"line":166,"address":[20141920],"length":1,"stats":{"Line":0}},{"line":168,"address":[16648271],"length":1,"stats":{"Line":0}},{"line":174,"address":[16648559,16648202],"length":1,"stats":{"Line":0}},{"line":175,"address":[16438226],"length":1,"stats":{"Line":0}},{"line":176,"address":[16438190,16438071],"length":1,"stats":{"Line":0}},{"line":177,"address":[23318789],"length":1,"stats":{"Line":0}},{"line":179,"address":[16589480],"length":1,"stats":{"Line":0}},{"line":183,"address":[16648618],"length":1,"stats":{"Line":0}},{"line":186,"address":[16664432],"length":1,"stats":{"Line":0}},{"line":191,"address":[18704693,18704794],"length":1,"stats":{"Line":0}},{"line":192,"address":[18555428,18555156,18555269],"length":1,"stats":{"Line":0}},{"line":193,"address":[18705131],"length":1,"stats":{"Line":0}},{"line":197,"address":[23944999],"length":1,"stats":{"Line":0}},{"line":200,"address":[20145229,20145235,20144512],"length":1,"stats":{"Line":0}},{"line":205,"address":[23321120],"length":1,"stats":{"Line":0}},{"line":206,"address":[16651121],"length":1,"stats":{"Line":0}},{"line":209,"address":[17700739,17700817],"length":1,"stats":{"Line":0}},{"line":210,"address":[23321246,23321371],"length":1,"stats":{"Line":0}},{"line":211,"address":[20144843],"length":1,"stats":{"Line":0}},{"line":212,"address":[16662838],"length":1,"stats":{"Line":0}},{"line":217,"address":[16651558,16651459],"length":1,"stats":{"Line":0}},{"line":218,"address":[17700879],"length":1,"stats":{"Line":0}},{"line":219,"address":[20144951],"length":1,"stats":{"Line":0}},{"line":221,"address":[16663181],"length":1,"stats":{"Line":0}},{"line":224,"address":[20145159],"length":1,"stats":{"Line":0}},{"line":227,"address":[23320380,23319664,23320374],"length":1,"stats":{"Line":0}},{"line":228,"address":[23780442,23780507],"length":1,"stats":{"Line":0}},{"line":229,"address":[17957766],"length":1,"stats":{"Line":0}},{"line":231,"address":[23780933,23780519],"length":1,"stats":{"Line":0}},{"line":232,"address":[16649900],"length":1,"stats":{"Line":0}},{"line":233,"address":[20143598,20143533],"length":1,"stats":{"Line":0}},{"line":234,"address":[20143699],"length":1,"stats":{"Line":0}},{"line":236,"address":[16439346],"length":1,"stats":{"Line":0}},{"line":240,"address":[23780570],"length":1,"stats":{"Line":0}},{"line":243,"address":[17957184],"length":1,"stats":{"Line":0}},{"line":244,"address":[23319253],"length":1,"stats":{"Line":0}},{"line":247,"address":[17696174,17695632,17696201],"length":1,"stats":{"Line":0}},{"line":248,"address":[16646086,16645994],"length":1,"stats":{"Line":0}},{"line":249,"address":[17954312,17954449],"length":1,"stats":{"Line":0}},{"line":250,"address":[17696121],"length":1,"stats":{"Line":0}},{"line":253,"address":[16646560],"length":1,"stats":{"Line":0}},{"line":254,"address":[17696268],"length":1,"stats":{"Line":0}},{"line":257,"address":[23322576],"length":1,"stats":{"Line":0}},{"line":258,"address":[16442016],"length":1,"stats":{"Line":0}},{"line":259,"address":[17960817],"length":1,"stats":{"Line":0}},{"line":262,"address":[16664045],"length":1,"stats":{"Line":0}},{"line":275,"address":[23783524,23783560],"length":1,"stats":{"Line":0}},{"line":276,"address":[23322966],"length":1,"stats":{"Line":0}},{"line":277,"address":[23322997],"length":1,"stats":{"Line":0}},{"line":281,"address":[23322978],"length":1,"stats":{"Line":0}},{"line":284,"address":[17958368],"length":1,"stats":{"Line":0}},{"line":285,"address":[23781136],"length":1,"stats":{"Line":0}},{"line":286,"address":[23320791],"length":1,"stats":{"Line":0}},{"line":289,"address":[16591133],"length":1,"stats":{"Line":0}},{"line":290,"address":[16650507],"length":1,"stats":{"Line":0}},{"line":292,"address":[17700385,17700346],"length":1,"stats":{"Line":0}},{"line":293,"address":[16650783],"length":1,"stats":{"Line":0}},{"line":294,"address":[23781708],"length":1,"stats":{"Line":0}},{"line":298,"address":[20144391,20144365],"length":1,"stats":{"Line":0}},{"line":299,"address":[17958936],"length":1,"stats":{"Line":0}},{"line":300,"address":[16650933],"length":1,"stats":{"Line":0}},{"line":304,"address":[23781684],"length":1,"stats":{"Line":0}},{"line":309,"address":[16442528],"length":1,"stats":{"Line":0}},{"line":310,"address":[16442536],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":123},{"path":["/","home","shift","code","vincents-ai","engram","src","sandbox","escalation_handler.rs"],"content":"//! Escalation Handler for Sandbox Permission Requests\n//!\n//! Handles the creation, approval, denial, and timeout of escalation requests\n//! when agents need elevated permissions beyond their sandbox level.\n\nuse crate::entities::{\n    Entity, EscalationOperationType, EscalationPriority, EscalationRequest, EscalationStatus,\n    OperationContext, ReviewDecision, ReviewerInfo,\n};\nuse crate::sandbox::{SandboxError, SandboxRequest, SandboxResult};\nuse crate::storage::Storage;\nuse chrono::Utc;\nuse std::collections::HashMap;\n\n/// Handles escalation requests for sandbox operations\npub struct EscalationHandler {\n    storage: Box\u003cdyn Storage\u003e,\n    /// Cache of recent escalations for performance\n    escalation_cache: HashMap\u003cString, EscalationRequest\u003e,\n}\n\nimpl EscalationHandler {\n    /// Create a new escalation handler\n    pub fn new(storage: Box\u003cdyn Storage\u003e) -\u003e Self {\n        Self {\n            storage,\n            escalation_cache: HashMap::new(),\n        }\n    }\n\n    /// Create a new escalation request from a sandbox request\n    pub async fn create_escalation(\n        \u0026mut self,\n        request: \u0026SandboxRequest,\n        block_reason: String,\n        operation_type: EscalationOperationType,\n        priority: EscalationPriority,\n    ) -\u003e SandboxResult\u003cString\u003e {\n        // Create operation context from the sandbox request\n        let operation_context = OperationContext {\n            operation: request.operation.clone(),\n            parameters: match request.parameters.as_object() {\n                Some(obj) =\u003e obj.iter().map(|(k, v)| (k.clone(), v.clone())).collect(),\n                None =\u003e HashMap::new(),\n            },\n            resource: Some(request.resource_type.clone()),\n            block_reason: block_reason.clone(),\n            alternatives: self.suggest_alternatives(\u0026request.operation),\n            risk_assessment: Some(self.assess_risk(\u0026request.operation)),\n        };\n\n        // Count similar past requests for this agent\n        let similar_count = self\n            .count_similar_escalations(\u0026request.agent_id, \u0026request.operation)\n            .await?;\n\n        // Create the escalation request\n        let mut escalation = EscalationRequest::new(\n            request.agent_id.clone(),\n            operation_type,\n            operation_context,\n            format!(\n                \"Agent {} requests permission for operation: {}\",\n                request.agent_id, request.operation\n            ),\n            priority,\n            \"default\".to_string(), // Agent who created this entity\n        );\n\n        escalation.session_id = request.session_id.clone();\n        escalation.similar_request_count = similar_count;\n        escalation.impact_if_denied = Some(format!(\n            \"Operation '{}' cannot proceed without approval\",\n            request.operation\n        ));\n\n        // Store the escalation request\n        let generic_entity = escalation.to_generic();\n        self.storage.store(\u0026generic_entity).map_err(|e| {\n            SandboxError::StorageError(format!(\"Failed to store escalation: {}\", e))\n        })?;\n\n        // Cache for quick lookup\n        let escalation_id = escalation.id.clone();\n        self.escalation_cache\n            .insert(escalation_id.clone(), escalation);\n\n        Ok(escalation_id)\n    }\n\n    /// Approve an escalation request\n    pub async fn approve_escalation(\n        \u0026mut self,\n        escalation_id: \u0026str,\n        reviewer: ReviewerInfo,\n        reason: String,\n        conditions: Vec\u003cString\u003e,\n        approval_duration_seconds: Option\u003cu64\u003e,\n        create_policy: bool,\n    ) -\u003e SandboxResult\u003c()\u003e {\n        let mut escalation = self.get_escalation(escalation_id).await?;\n\n        // Ensure request is still pending\n        if escalation.status != EscalationStatus::Pending {\n            return Err(SandboxError::InvalidConfig(format!(\n                \"Escalation request {} is not in pending status\",\n                escalation_id\n            )));\n        }\n\n        // Check if request has expired\n        if Utc::now() \u003e escalation.expires_at {\n            escalation.status = EscalationStatus::Expired;\n            self.update_escalation(\u0026escalation).await?;\n            return Err(SandboxError::EscalationRequired(format!(\n                \"Escalation request {} has expired\",\n                escalation_id\n            )));\n        }\n\n        // Create approval decision\n        let decision = ReviewDecision {\n            status: EscalationStatus::Approved,\n            reason,\n            conditions,\n            approval_duration: approval_duration_seconds,\n            create_policy,\n            notes: None,\n        };\n\n        // Update escalation\n        escalation.status = EscalationStatus::Approved;\n        escalation.reviewer = Some(reviewer);\n        escalation.decision = Some(decision);\n        escalation.reviewed_at = Some(Utc::now());\n        escalation.updated_at = Utc::now();\n\n        self.update_escalation(\u0026escalation).await?;\n\n        Ok(())\n    }\n\n    /// Deny an escalation request\n    pub async fn deny_escalation(\n        \u0026mut self,\n        escalation_id: \u0026str,\n        reviewer: ReviewerInfo,\n        reason: String,\n        notes: Option\u003cString\u003e,\n    ) -\u003e SandboxResult\u003c()\u003e {\n        let mut escalation = self.get_escalation(escalation_id).await?;\n\n        // Ensure request is still pending\n        if escalation.status != EscalationStatus::Pending {\n            return Err(SandboxError::InvalidConfig(format!(\n                \"Escalation request {} is not in pending status\",\n                escalation_id\n            )));\n        }\n\n        // Create denial decision\n        let decision = ReviewDecision {\n            status: EscalationStatus::Denied,\n            reason,\n            conditions: Vec::new(),\n            approval_duration: None,\n            create_policy: false,\n            notes,\n        };\n\n        // Update escalation\n        escalation.status = EscalationStatus::Denied;\n        escalation.reviewer = Some(reviewer);\n        escalation.decision = Some(decision);\n        escalation.reviewed_at = Some(Utc::now());\n        escalation.updated_at = Utc::now();\n\n        self.update_escalation(\u0026escalation).await?;\n\n        Ok(())\n    }\n\n    /// Cancel an escalation request (by the requesting agent or system)\n    pub async fn cancel_escalation(\n        \u0026mut self,\n        escalation_id: \u0026str,\n        reason: Option\u003cString\u003e,\n    ) -\u003e SandboxResult\u003c()\u003e {\n        let mut escalation = self.get_escalation(escalation_id).await?;\n\n        // Only allow cancellation of pending requests\n        if escalation.status != EscalationStatus::Pending {\n            return Err(SandboxError::InvalidConfig(format!(\n                \"Cannot cancel escalation {} with status {:?}\",\n                escalation_id, escalation.status\n            )));\n        }\n\n        escalation.status = EscalationStatus::Cancelled;\n        escalation.updated_at = Utc::now();\n\n        if let Some(reason_text) = reason {\n            escalation\n                .metadata\n                .insert(\"cancellation_reason\".to_string(), reason_text.into());\n        }\n\n        self.update_escalation(\u0026escalation).await?;\n\n        Ok(())\n    }\n\n    /// Get an escalation request by ID\n    pub async fn get_escalation(\n        \u0026mut self,\n        escalation_id: \u0026str,\n    ) -\u003e SandboxResult\u003cEscalationRequest\u003e {\n        // Check cache first\n        if let Some(escalation) = self.escalation_cache.get(escalation_id) {\n            return Ok(escalation.clone());\n        }\n\n        // Load from storage\n        let generic_entity = self\n            .storage\n            .get(escalation_id, \"escalation_request\")\n            .map_err(|e| SandboxError::StorageError(format!(\"Failed to get escalation: {}\", e)))?\n            .ok_or_else(|| {\n                SandboxError::InvalidConfig(format!(\n                    \"Escalation request {} not found\",\n                    escalation_id\n                ))\n            })?;\n\n        let escalation = EscalationRequest::from_generic(generic_entity).map_err(|e| {\n            SandboxError::StorageError(format!(\"Failed to parse escalation: {}\", e))\n        })?;\n\n        // Cache for future lookups\n        self.escalation_cache\n            .insert(escalation_id.to_string(), escalation.clone());\n\n        Ok(escalation)\n    }\n\n    /// List all pending escalation requests\n    pub async fn list_pending_escalations(\u0026mut self) -\u003e SandboxResult\u003cVec\u003cEscalationRequest\u003e\u003e {\n        self.list_escalations_by_status(EscalationStatus::Pending)\n            .await\n    }\n\n    /// List escalations by status\n    pub async fn list_escalations_by_status(\n        \u0026mut self,\n        status: EscalationStatus,\n    ) -\u003e SandboxResult\u003cVec\u003cEscalationRequest\u003e\u003e {\n        let all_ids = self.storage.list_ids(\"escalation_request\").map_err(|e| {\n            SandboxError::StorageError(format!(\"Failed to list escalations: {}\", e))\n        })?;\n\n        let mut escalations = Vec::new();\n\n        for id in all_ids {\n            if let Ok(escalation) = self.get_escalation(\u0026id).await {\n                if escalation.status == status {\n                    escalations.push(escalation);\n                }\n            }\n        }\n\n        // Sort by priority (Critical first) and then by creation time\n        escalations.sort_by(|a, b| {\n            let priority_order = |p: \u0026EscalationPriority| match p {\n                EscalationPriority::Critical =\u003e 0,\n                EscalationPriority::High =\u003e 1,\n                EscalationPriority::Normal =\u003e 2,\n                EscalationPriority::Low =\u003e 3,\n            };\n\n            let a_priority = priority_order(\u0026a.priority);\n            let b_priority = priority_order(\u0026b.priority);\n\n            a_priority\n                .cmp(\u0026b_priority)\n                .then_with(|| a.created_at.cmp(\u0026b.created_at))\n        });\n\n        Ok(escalations)\n    }\n\n    /// List escalations for a specific agent\n    pub async fn list_agent_escalations(\n        \u0026mut self,\n        agent_id: \u0026str,\n    ) -\u003e SandboxResult\u003cVec\u003cEscalationRequest\u003e\u003e {\n        let all_ids = self.storage.list_ids(\"escalation_request\").map_err(|e| {\n            SandboxError::StorageError(format!(\"Failed to list escalations: {}\", e))\n        })?;\n\n        let mut escalations = Vec::new();\n\n        for id in all_ids {\n            if let Ok(escalation) = self.get_escalation(\u0026id).await {\n                if escalation.agent_id == agent_id {\n                    escalations.push(escalation);\n                }\n            }\n        }\n\n        // Sort by creation time (newest first)\n        escalations.sort_by(|a, b| b.created_at.cmp(\u0026a.created_at));\n\n        Ok(escalations)\n    }\n\n    /// Check for expired escalation requests and mark them as expired\n    pub async fn process_expired_escalations(\u0026mut self) -\u003e SandboxResult\u003cusize\u003e {\n        let pending = self.list_pending_escalations().await?;\n        let now = Utc::now();\n        let mut expired_count = 0;\n\n        for mut escalation in pending {\n            if now \u003e escalation.expires_at {\n                escalation.status = EscalationStatus::Expired;\n                escalation.updated_at = now;\n                self.update_escalation(\u0026escalation).await?;\n                expired_count += 1;\n            }\n        }\n\n        Ok(expired_count)\n    }\n\n    /// Get statistics about escalation requests\n    pub async fn get_statistics(\u0026mut self) -\u003e SandboxResult\u003cEscalationStatistics\u003e {\n        let all_ids = self.storage.list_ids(\"escalation_request\").map_err(|e| {\n            SandboxError::StorageError(format!(\"Failed to list escalations: {}\", e))\n        })?;\n\n        let mut stats = EscalationStatistics::default();\n        stats.total_requests = all_ids.len();\n\n        for id in all_ids {\n            if let Ok(escalation) = self.get_escalation(\u0026id).await {\n                match escalation.status {\n                    EscalationStatus::Pending =\u003e stats.pending_count += 1,\n                    EscalationStatus::Approved =\u003e {\n                        stats.approved_count += 1;\n                        if let Some(decision) = \u0026escalation.decision {\n                            if let Some(duration) = decision.approval_duration {\n                                stats.total_approval_duration_seconds += duration;\n                            }\n                        }\n                    }\n                    EscalationStatus::Denied =\u003e stats.denied_count += 1,\n                    EscalationStatus::Expired =\u003e stats.expired_count += 1,\n                    EscalationStatus::Cancelled =\u003e stats.cancelled_count += 1,\n                }\n\n                // Calculate average response time for reviewed requests\n                if let Some(reviewed_at) = escalation.reviewed_at {\n                    let response_time = (reviewed_at - escalation.created_at).num_seconds();\n                    stats.total_response_time_seconds += response_time as u64;\n                    stats.reviewed_count += 1;\n                }\n            }\n        }\n\n        // Calculate averages\n        if stats.reviewed_count \u003e 0 {\n            stats.average_response_time_seconds =\n                stats.total_response_time_seconds / stats.reviewed_count as u64;\n        }\n\n        if stats.approved_count \u003e 0 {\n            stats.average_approval_duration_seconds =\n                stats.total_approval_duration_seconds / stats.approved_count as u64;\n        }\n\n        Ok(stats)\n    }\n\n    /// Check if an agent has an active approval for a specific operation\n    pub async fn has_active_approval(\n        \u0026mut self,\n        agent_id: \u0026str,\n        operation: \u0026str,\n    ) -\u003e SandboxResult\u003cOption\u003cEscalationRequest\u003e\u003e {\n        let agent_escalations = self.list_agent_escalations(agent_id).await?;\n        let now = Utc::now();\n\n        for escalation in agent_escalations {\n            if escalation.status == EscalationStatus::Approved\n                \u0026\u0026 escalation.operation_context.operation == operation\n            {\n                // Check if approval is still valid\n                if let Some(decision) = \u0026escalation.decision {\n                    if let Some(duration_seconds) = decision.approval_duration {\n                        if let Some(reviewed_at) = escalation.reviewed_at {\n                            let expires_at =\n                                reviewed_at + chrono::Duration::seconds(duration_seconds as i64);\n                            if now \u003c expires_at {\n                                return Ok(Some(escalation));\n                            }\n                        }\n                    } else {\n                        // Approval has no expiration\n                        return Ok(Some(escalation));\n                    }\n                }\n            }\n        }\n\n        Ok(None)\n    }\n\n    /// Helper: Update an escalation in storage and cache\n    async fn update_escalation(\u0026mut self, escalation: \u0026EscalationRequest) -\u003e SandboxResult\u003c()\u003e {\n        let generic_entity = escalation.to_generic();\n        self.storage.store(\u0026generic_entity).map_err(|e| {\n            SandboxError::StorageError(format!(\"Failed to update escalation: {}\", e))\n        })?;\n\n        // Update cache\n        self.escalation_cache\n            .insert(escalation.id.clone(), escalation.clone());\n\n        Ok(())\n    }\n\n    /// Helper: Count similar escalations for an agent\n    async fn count_similar_escalations(\n        \u0026mut self,\n        agent_id: \u0026str,\n        operation: \u0026str,\n    ) -\u003e SandboxResult\u003cu32\u003e {\n        let agent_escalations = self.list_agent_escalations(agent_id).await?;\n\n        Ok(agent_escalations\n            .iter()\n            .filter(|e| e.operation_context.operation == operation)\n            .count() as u32)\n    }\n\n    /// Helper: Suggest alternative operations\n    fn suggest_alternatives(\u0026self, operation: \u0026str) -\u003e Vec\u003cString\u003e {\n        match operation {\n            \"file_delete\" =\u003e vec![\n                \"Use file_move to archive instead\".to_string(),\n                \"Request permission for specific file patterns\".to_string(),\n            ],\n            \"network_request\" =\u003e vec![\n                \"Use internal API endpoints if available\".to_string(),\n                \"Request proxy configuration\".to_string(),\n            ],\n            \"execute_command\" =\u003e vec![\n                \"Use engram built-in operations\".to_string(),\n                \"Request specific command whitelist\".to_string(),\n            ],\n            _ =\u003e vec![\"Contact administrator for guidance\".to_string()],\n        }\n    }\n\n    /// Helper: Assess risk of an operation\n    fn assess_risk(\u0026self, operation: \u0026str) -\u003e String {\n        match operation {\n            op if op.contains(\"delete\") || op.contains(\"remove\") =\u003e {\n                \"High risk: Irreversible data modification\".to_string()\n            }\n            op if op.contains(\"network\") =\u003e {\n                \"Medium risk: External communication and data exfiltration potential\".to_string()\n            }\n            op if op.contains(\"execute\") || op.contains(\"command\") =\u003e {\n                \"High risk: Arbitrary code execution\".to_string()\n            }\n            op if op.contains(\"write\") || op.contains(\"modify\") =\u003e {\n                \"Medium risk: Data modification\".to_string()\n            }\n            _ =\u003e \"Low risk: Read-only or safe operation\".to_string(),\n        }\n    }\n\n    /// Clear the escalation cache\n    pub fn clear_cache(\u0026mut self) {\n        self.escalation_cache.clear();\n    }\n}\n\n/// Statistics about escalation requests\n#[derive(Debug, Clone, Default)]\npub struct EscalationStatistics {\n    pub total_requests: usize,\n    pub pending_count: usize,\n    pub approved_count: usize,\n    pub denied_count: usize,\n    pub expired_count: usize,\n    pub cancelled_count: usize,\n    pub reviewed_count: usize,\n    pub total_response_time_seconds: u64,\n    pub average_response_time_seconds: u64,\n    pub total_approval_duration_seconds: u64,\n    pub average_approval_duration_seconds: u64,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::storage::GitStorage;\n    use tempfile::TempDir;\n\n    fn create_test_storage() -\u003e (Box\u003cdyn Storage\u003e, TempDir) {\n        let temp_dir = TempDir::new().unwrap();\n        let storage =\n            Box::new(GitStorage::new(temp_dir.path().to_str().unwrap(), \"test-agent\").unwrap());\n        (storage, temp_dir)\n    }\n\n    #[tokio::test]\n    async fn test_create_escalation() {\n        let (storage, _temp_dir) = create_test_storage();\n        let mut handler = EscalationHandler::new(storage);\n\n        let request = SandboxRequest {\n            agent_id: \"test-agent\".to_string(),\n            operation: \"file_delete\".to_string(),\n            resource_type: \"/important/file.txt\".to_string(),\n            parameters: serde_json::json!({}),\n            timestamp: Utc::now(),\n            session_id: Some(\"session-123\".to_string()),\n        };\n\n        let escalation_id = handler\n            .create_escalation(\n                \u0026request,\n                \"File deletion not permitted\".to_string(),\n                EscalationOperationType::FileSystemAccess,\n                EscalationPriority::Normal,\n            )\n            .await\n            .unwrap();\n\n        assert!(!escalation_id.is_empty());\n\n        // Verify escalation was created\n        let escalation = handler.get_escalation(\u0026escalation_id).await.unwrap();\n        assert_eq!(escalation.agent_id, \"test-agent\");\n        assert_eq!(escalation.status, EscalationStatus::Pending);\n        assert_eq!(escalation.operation_context.operation, \"file_delete\");\n    }\n\n    #[tokio::test]\n    async fn test_approve_escalation() {\n        let (storage, _temp_dir) = create_test_storage();\n        let mut handler = EscalationHandler::new(storage);\n\n        let request = SandboxRequest {\n            agent_id: \"test-agent\".to_string(),\n            operation: \"network_request\".to_string(),\n            resource_type: \"https://api.example.com\".to_string(),\n            parameters: serde_json::json!({}),\n            timestamp: Utc::now(),\n            session_id: None,\n        };\n\n        let escalation_id = handler\n            .create_escalation(\n                \u0026request,\n                \"External network not allowed\".to_string(),\n                EscalationOperationType::NetworkAccess,\n                EscalationPriority::High,\n            )\n            .await\n            .unwrap();\n\n        let reviewer = ReviewerInfo {\n            reviewer_id: \"reviewer-1\".to_string(),\n            reviewer_name: \"John Reviewer\".to_string(),\n            reviewer_email: Some(\"john@example.com\".to_string()),\n            department: Some(\"Security\".to_string()),\n        };\n\n        handler\n            .approve_escalation(\n                \u0026escalation_id,\n                reviewer,\n                \"Approved for testing purposes\".to_string(),\n                vec![\"Monitor network traffic\".to_string()],\n                Some(3600), // 1 hour\n                false,\n            )\n            .await\n            .unwrap();\n\n        let escalation = handler.get_escalation(\u0026escalation_id).await.unwrap();\n        assert_eq!(escalation.status, EscalationStatus::Approved);\n        assert!(escalation.reviewer.is_some());\n        assert!(escalation.decision.is_some());\n    }\n\n    #[tokio::test]\n    async fn test_deny_escalation() {\n        let (storage, _temp_dir) = create_test_storage();\n        let mut handler = EscalationHandler::new(storage);\n\n        let request = SandboxRequest {\n            agent_id: \"test-agent\".to_string(),\n            operation: \"execute_command\".to_string(),\n            resource_type: \"rm -rf /\".to_string(),\n            parameters: serde_json::json!({}),\n            timestamp: Utc::now(),\n            session_id: None,\n        };\n\n        let escalation_id = handler\n            .create_escalation(\n                \u0026request,\n                \"Dangerous command blocked\".to_string(),\n                EscalationOperationType::CommandExecution,\n                EscalationPriority::Critical,\n            )\n            .await\n            .unwrap();\n\n        let reviewer = ReviewerInfo {\n            reviewer_id: \"reviewer-1\".to_string(),\n            reviewer_name: \"John Reviewer\".to_string(),\n            reviewer_email: Some(\"john@example.com\".to_string()),\n            department: Some(\"Security\".to_string()),\n        };\n\n        handler\n            .deny_escalation(\n                \u0026escalation_id,\n                reviewer,\n                \"Command is too dangerous to approve\".to_string(),\n                Some(\"This operation would destroy the system\".to_string()),\n            )\n            .await\n            .unwrap();\n\n        let escalation = handler.get_escalation(\u0026escalation_id).await.unwrap();\n        assert_eq!(escalation.status, EscalationStatus::Denied);\n        assert!(escalation.decision.is_some());\n    }\n}\n","traces":[{"line":24,"address":[16344827,16344688,16344821],"length":1,"stats":{"Line":3}},{"line":27,"address":[16344722],"length":1,"stats":{"Line":3}},{"line":32,"address":[16413216],"length":1,"stats":{"Line":3}},{"line":41,"address":[19543348],"length":1,"stats":{"Line":3}},{"line":42,"address":[19543557,19543481],"length":1,"stats":{"Line":6}},{"line":46,"address":[19419887,19419764],"length":1,"stats":{"Line":6}},{"line":47,"address":[26202399],"length":1,"stats":{"Line":3}},{"line":48,"address":[19420110,19419991],"length":1,"stats":{"Line":6}},{"line":49,"address":[19420125,19420232],"length":1,"stats":{"Line":2}},{"line":53,"address":[20436879,20439651,20436137,20436347,20436742,20436792],"length":1,"stats":{"Line":7}},{"line":54,"address":[20984450,20984547],"length":1,"stats":{"Line":4}},{"line":55,"address":[19474335,19473868,19473800,19472637,19474073,19474262],"length":1,"stats":{"Line":8}},{"line":59,"address":[20985246,20985312],"length":1,"stats":{"Line":3}},{"line":60,"address":[19545272],"length":1,"stats":{"Line":2}},{"line":61,"address":[19421359],"length":1,"stats":{"Line":1}},{"line":62,"address":[19474592,19474700],"length":1,"stats":{"Line":3}},{"line":66,"address":[19534099],"length":1,"stats":{"Line":2}},{"line":67,"address":[26204205],"length":1,"stats":{"Line":1}},{"line":70,"address":[20437682,20437614,20437701],"length":1,"stats":{"Line":3}},{"line":71,"address":[19324073],"length":1,"stats":{"Line":1}},{"line":72,"address":[26204672,26204858],"length":1,"stats":{"Line":2}},{"line":78,"address":[19534885],"length":1,"stats":{"Line":1}},{"line":79,"address":[26206942,26205095,26206704,26205016,26205209],"length":1,"stats":{"Line":3}},{"line":80,"address":[19477450,19477382],"length":1,"stats":{"Line":0}},{"line":84,"address":[19475902],"length":1,"stats":{"Line":2}},{"line":85,"address":[26205281],"length":1,"stats":{"Line":1}},{"line":86,"address":[19476021,19475950],"length":1,"stats":{"Line":3}},{"line":88,"address":[26666152],"length":1,"stats":{"Line":2}},{"line":92,"address":[23071952],"length":1,"stats":{"Line":1}},{"line":101,"address":[19550361,19550125,19552668,19550210,19550058],"length":1,"stats":{"Line":2}},{"line":104,"address":[19426598,19426671],"length":1,"stats":{"Line":2}},{"line":105,"address":[26210997,26209429],"length":1,"stats":{"Line":0}},{"line":112,"address":[20442639,20442573],"length":1,"stats":{"Line":2}},{"line":113,"address":[19427253],"length":1,"stats":{"Line":0}},{"line":114,"address":[20990188,20992752,20992361,20991478,20993336],"length":1,"stats":{"Line":0}},{"line":115,"address":[19331009],"length":1,"stats":{"Line":0}},{"line":132,"address":[19427034],"length":1,"stats":{"Line":1}},{"line":133,"address":[19329181,19329448],"length":1,"stats":{"Line":1}},{"line":134,"address":[19427464,19427675],"length":1,"stats":{"Line":1}},{"line":135,"address":[20443803,20443734],"length":1,"stats":{"Line":2}},{"line":136,"address":[19481349],"length":1,"stats":{"Line":1}},{"line":138,"address":[26210755,26208731,26211874],"length":1,"stats":{"Line":1}},{"line":140,"address":[26212195],"length":1,"stats":{"Line":1}},{"line":144,"address":[23071552],"length":1,"stats":{"Line":1}},{"line":151,"address":[26195878,26198293,26195945,26196015,26196166],"length":1,"stats":{"Line":2}},{"line":154,"address":[19315952,19316033],"length":1,"stats":{"Line":2}},{"line":155,"address":[19467353,19468702],"length":1,"stats":{"Line":0}},{"line":165,"address":[19538097],"length":1,"stats":{"Line":1}},{"line":172,"address":[19414655],"length":1,"stats":{"Line":1}},{"line":173,"address":[19538598,19538382],"length":1,"stats":{"Line":1}},{"line":174,"address":[26197553,26197338],"length":1,"stats":{"Line":1}},{"line":175,"address":[19539124,19539193],"length":1,"stats":{"Line":2}},{"line":176,"address":[19539251],"length":1,"stats":{"Line":1}},{"line":178,"address":[19527793,19528227,19525864],"length":1,"stats":{"Line":1}},{"line":180,"address":[19540068],"length":1,"stats":{"Line":1}},{"line":184,"address":[17406256],"length":1,"stats":{"Line":0}},{"line":189,"address":[26199393,26199485,26199335,26199624,26201073],"length":1,"stats":{"Line":0}},{"line":192,"address":[26660665,26660743],"length":1,"stats":{"Line":0}},{"line":193,"address":[20981585,20982266],"length":1,"stats":{"Line":0}},{"line":199,"address":[19529986],"length":1,"stats":{"Line":0}},{"line":200,"address":[26660846,26660761],"length":1,"stats":{"Line":0}},{"line":202,"address":[19541626,19542052],"length":1,"stats":{"Line":0}},{"line":203,"address":[19530180,19530420],"length":1,"stats":{"Line":0}},{"line":205,"address":[19470943,19471180,19471126,19471009,19471289],"length":1,"stats":{"Line":0}},{"line":208,"address":[19319731,19318816,19320101,19320954,19320535],"length":1,"stats":{"Line":0}},{"line":210,"address":[20434604],"length":1,"stats":{"Line":0}},{"line":214,"address":[15100656],"length":1,"stats":{"Line":1}},{"line":219,"address":[26650265,26650366],"length":1,"stats":{"Line":2}},{"line":220,"address":[19407719,19407661],"length":1,"stats":{"Line":3}},{"line":224,"address":[19532868,19531453,19531746,19531650,19531357,19531181],"length":1,"stats":{"Line":0}},{"line":226,"address":[19407694],"length":1,"stats":{"Line":0}},{"line":227,"address":[26650669,26652646,26652624,26650578],"length":1,"stats":{"Line":0}},{"line":228,"address":[19531618,19533184],"length":1,"stats":{"Line":0}},{"line":229,"address":[20424953],"length":1,"stats":{"Line":0}},{"line":235,"address":[20973198,20972879,20972095,20972299,20972960,20972413],"length":1,"stats":{"Line":0}},{"line":236,"address":[19462234,19462166],"length":1,"stats":{"Line":0}},{"line":240,"address":[19310461,19310608],"length":1,"stats":{"Line":0}},{"line":241,"address":[20972563,20972629,20972851,20972534,20972680],"length":1,"stats":{"Line":0}},{"line":243,"address":[19310722],"length":1,"stats":{"Line":0}},{"line":247,"address":[23534528,23534536],"length":1,"stats":{"Line":0}},{"line":248,"address":[19487881,19488093,19487750],"length":1,"stats":{"Line":0}},{"line":249,"address":[14160919],"length":1,"stats":{"Line":0}},{"line":253,"address":[23073952],"length":1,"stats":{"Line":0}},{"line":257,"address":[19338274,19338138,19338388,19340462,19340224],"length":1,"stats":{"Line":0}},{"line":258,"address":[19562330,19562262],"length":1,"stats":{"Line":0}},{"line":261,"address":[26679765],"length":1,"stats":{"Line":0}},{"line":263,"address":[19560750,19561694,19560698,19560582],"length":1,"stats":{"Line":0}},{"line":264,"address":[19550462,19548703,19549668,19549733,19549371,19549396,19550238,19549953],"length":1,"stats":{"Line":0}},{"line":265,"address":[20453040,20453111],"length":1,"stats":{"Line":0}},{"line":266,"address":[26680638],"length":1,"stats":{"Line":0}},{"line":272,"address":[26220688,26220384],"length":1,"stats":{"Line":0}},{"line":273,"address":[19340554,19340544],"length":1,"stats":{"Line":0}},{"line":274,"address":[21002679],"length":1,"stats":{"Line":0}},{"line":275,"address":[19340605],"length":1,"stats":{"Line":0}},{"line":276,"address":[26221187],"length":1,"stats":{"Line":0}},{"line":277,"address":[19562601],"length":1,"stats":{"Line":0}},{"line":280,"address":[26220717],"length":1,"stats":{"Line":0}},{"line":281,"address":[20453912],"length":1,"stats":{"Line":0}},{"line":284,"address":[19437612],"length":1,"stats":{"Line":0}},{"line":285,"address":[19340199,19340496,19340510],"length":1,"stats":{"Line":0}},{"line":288,"address":[19339843],"length":1,"stats":{"Line":0}},{"line":292,"address":[15102976],"length":1,"stats":{"Line":3}},{"line":296,"address":[19485342,19485478,19485592,19487630,19487392],"length":1,"stats":{"Line":3}},{"line":297,"address":[19433702,19433762],"length":1,"stats":{"Line":0}},{"line":300,"address":[19334457],"length":1,"stats":{"Line":1}},{"line":302,"address":[19485770,19485886,19485938,19486885],"length":1,"stats":{"Line":6}},{"line":303,"address":[17121079],"length":1,"stats":{"Line":0}},{"line":304,"address":[19486487,19486555],"length":1,"stats":{"Line":0}},{"line":305,"address":[19432979],"length":1,"stats":{"Line":0}},{"line":311,"address":[19433387,19433936,19433968],"length":1,"stats":{"Line":2}},{"line":313,"address":[20997881],"length":1,"stats":{"Line":1}},{"line":317,"address":[26222147,26221232,26221337,26221371,26221513,26221267,26221395],"length":1,"stats":{"Line":0}},{"line":318,"address":[26221434,26221544,26221315,26221364,26222131],"length":1,"stats":{"Line":0}},{"line":319,"address":[19492562],"length":1,"stats":{"Line":0}},{"line":320,"address":[19341376],"length":1,"stats":{"Line":0}},{"line":322,"address":[19341511,19342087,19341384],"length":1,"stats":{"Line":0}},{"line":323,"address":[19493234,19493397,19493563],"length":1,"stats":{"Line":0}},{"line":324,"address":[20456089],"length":1,"stats":{"Line":0}},{"line":325,"address":[20456106],"length":1,"stats":{"Line":0}},{"line":326,"address":[21003886,21003630,21004460,21003655,21002848],"length":1,"stats":{"Line":0}},{"line":327,"address":[26683252,26683215],"length":1,"stats":{"Line":0}},{"line":331,"address":[21004273],"length":1,"stats":{"Line":0}},{"line":335,"address":[19463091,19463682,19465254,19462927,19463033,19462880],"length":1,"stats":{"Line":0}},{"line":336,"address":[19466222,19462994,19463247,19463133,19465984],"length":1,"stats":{"Line":0}},{"line":337,"address":[20428518,20428586],"length":1,"stats":{"Line":0}},{"line":340,"address":[20974171],"length":1,"stats":{"Line":0}},{"line":341,"address":[19410578],"length":1,"stats":{"Line":0}},{"line":343,"address":[20425977,20427894,20426098],"length":1,"stats":{"Line":0}},{"line":344,"address":[19314596,19312468,19312903,19311815,19312810,19314216,19312499],"length":1,"stats":{"Line":0}},{"line":345,"address":[26654169],"length":1,"stats":{"Line":0}},{"line":346,"address":[19464201,19464411],"length":1,"stats":{"Line":0}},{"line":348,"address":[26193877,26193586,26193911],"length":1,"stats":{"Line":0}},{"line":349,"address":[19464585,19464537],"length":1,"stats":{"Line":0}},{"line":350,"address":[26193945,26194030],"length":1,"stats":{"Line":0}},{"line":351,"address":[19411771,19411819],"length":1,"stats":{"Line":0}},{"line":355,"address":[26654299,26654741],"length":1,"stats":{"Line":0}},{"line":356,"address":[26194112,26193665],"length":1,"stats":{"Line":0}},{"line":357,"address":[20426874,20427326],"length":1,"stats":{"Line":0}},{"line":361,"address":[19313233,19313599,19313926],"length":1,"stats":{"Line":0}},{"line":362,"address":[20427389,20427516],"length":1,"stats":{"Line":0}},{"line":363,"address":[20427645,20427576],"length":1,"stats":{"Line":0}},{"line":364,"address":[19535875,19535947,19535935],"length":1,"stats":{"Line":0}},{"line":370,"address":[26194864,26194966],"length":1,"stats":{"Line":0}},{"line":371,"address":[19412703],"length":1,"stats":{"Line":0}},{"line":372,"address":[26655640,26655575],"length":1,"stats":{"Line":0}},{"line":375,"address":[26194882,26195147],"length":1,"stats":{"Line":0}},{"line":376,"address":[19314532],"length":1,"stats":{"Line":0}},{"line":377,"address":[26195089,26195152],"length":1,"stats":{"Line":0}},{"line":380,"address":[19314405],"length":1,"stats":{"Line":0}},{"line":384,"address":[16191648],"length":1,"stats":{"Line":0}},{"line":389,"address":[26214543,26213119,26212901,26213009,26212947],"length":1,"stats":{"Line":0}},{"line":390,"address":[19430635],"length":1,"stats":{"Line":0}},{"line":392,"address":[19332951,19333147],"length":1,"stats":{"Line":0}},{"line":393,"address":[19555221,19555411],"length":1,"stats":{"Line":0}},{"line":394,"address":[26674692],"length":1,"stats":{"Line":0}},{"line":397,"address":[26214053],"length":1,"stats":{"Line":0}},{"line":398,"address":[26674769],"length":1,"stats":{"Line":0}},{"line":399,"address":[26214252,26214132],"length":1,"stats":{"Line":0}},{"line":400,"address":[20995754],"length":1,"stats":{"Line":0}},{"line":402,"address":[26675036],"length":1,"stats":{"Line":0}},{"line":403,"address":[19485064],"length":1,"stats":{"Line":0}},{"line":408,"address":[26214164],"length":1,"stats":{"Line":0}},{"line":414,"address":[26674517],"length":1,"stats":{"Line":0}},{"line":418,"address":[17709856,17709869],"length":1,"stats":{"Line":6}},{"line":419,"address":[20440497],"length":1,"stats":{"Line":2}},{"line":420,"address":[20441200,20441438,20440650,20440764,20440584],"length":1,"stats":{"Line":4}},{"line":421,"address":[20441222,20441290],"length":1,"stats":{"Line":0}},{"line":425,"address":[26668315,26668453],"length":1,"stats":{"Line":4}},{"line":426,"address":[19327083,19327146,19327197,19327060,19327361],"length":1,"stats":{"Line":4}},{"line":428,"address":[19327259],"length":1,"stats":{"Line":2}},{"line":432,"address":[16193296],"length":1,"stats":{"Line":3}},{"line":437,"address":[26217740,26217904,26218555,26217694,26217794],"length":1,"stats":{"Line":5}},{"line":439,"address":[20451605,20451440],"length":1,"stats":{"Line":4}},{"line":440,"address":[26218349],"length":1,"stats":{"Line":1}},{"line":441,"address":[26218385,26218577,26218560],"length":1,"stats":{"Line":2}},{"line":442,"address":[26218408],"length":1,"stats":{"Line":1}},{"line":446,"address":[16413728,16414313,16414305],"length":1,"stats":{"Line":3}},{"line":448,"address":[16344247,16343091,16343027,16344178,16344285],"length":1,"stats":{"Line":5}},{"line":449,"address":[16402349],"length":1,"stats":{"Line":1}},{"line":450,"address":[16344219],"length":1,"stats":{"Line":1}},{"line":452,"address":[23533074,23533959,23533191,23533884,23534000],"length":1,"stats":{"Line":4}},{"line":453,"address":[16191940],"length":1,"stats":{"Line":1}},{"line":454,"address":[16414680],"length":1,"stats":{"Line":1}},{"line":456,"address":[16192426,16192385,16192310,16191894,16192038],"length":1,"stats":{"Line":3}},{"line":457,"address":[23072643],"length":1,"stats":{"Line":1}},{"line":458,"address":[23072946],"length":1,"stats":{"Line":1}},{"line":460,"address":[23072576,23072677,23072887],"length":1,"stats":{"Line":0}},{"line":465,"address":[16190400],"length":1,"stats":{"Line":1}},{"line":467,"address":[17708956],"length":1,"stats":{"Line":2}},{"line":468,"address":[23531772],"length":1,"stats":{"Line":1}},{"line":470,"address":[16341779],"length":1,"stats":{"Line":1}},{"line":471,"address":[23531885],"length":1,"stats":{"Line":1}},{"line":473,"address":[17405693,17405764],"length":1,"stats":{"Line":1}},{"line":474,"address":[15100474],"length":1,"stats":{"Line":1}},{"line":476,"address":[16401198],"length":1,"stats":{"Line":0}},{"line":477,"address":[23532046],"length":1,"stats":{"Line":0}},{"line":479,"address":[23071398],"length":1,"stats":{"Line":0}},{"line":484,"address":[16401344],"length":1,"stats":{"Line":0}},{"line":485,"address":[16190853],"length":1,"stats":{"Line":0}}],"covered":87,"coverable":199},{"path":["/","home","shift","code","vincents-ai","engram","src","sandbox","mod.rs"],"content":"//! Agent Sandbox System\n//!\n//! Provides safety and security constraints for agent operations through:\n//! - Permission validation\n//! - Resource monitoring\n//! - Command filtering\n//! - Escalation handling\n\npub mod command_validator;\npub mod escalation_handler;\npub mod permission_engine;\npub mod resource_monitor;\n\nuse crate::entities::agent_sandbox::OperationType;\nuse crate::entities::{\n    AgentSandbox, Entity, EscalationOperationType, EscalationPriority, EscalationRequest,\n    OperationContext, SandboxLevel,\n};\nuse crate::storage::Storage;\nuse chrono::{DateTime, Duration as ChronoDuration, Utc};\nuse std::collections::HashMap;\nuse std::time::Instant;\nuse thiserror::Error;\n\npub use command_validator::CommandValidator;\npub use escalation_handler::{EscalationHandler, EscalationStatistics};\npub use permission_engine::PermissionEngine;\npub use resource_monitor::ResourceMonitor;\n\n/// Errors that can occur during sandbox operations\n#[derive(Error, Debug)]\npub enum SandboxError {\n    #[error(\"Permission denied: {0}\")]\n    PermissionDenied(String),\n\n    #[error(\"Resource limit exceeded: {0}\")]\n    ResourceLimitExceeded(String),\n\n    #[error(\"Command not allowed: {0}\")]\n    CommandBlocked(String),\n\n    #[error(\"Escalation required: {0}\")]\n    EscalationRequired(String),\n\n    #[error(\"Invalid sandbox configuration: {0}\")]\n    InvalidConfig(String),\n\n    #[error(\"Storage error: {0}\")]\n    StorageError(String),\n}\n\n/// Result type for sandbox operations\npub type SandboxResult\u003cT\u003e = Result\u003cT, SandboxError\u003e;\n\n/// Request context for sandbox validation\n#[derive(Debug, Clone, serde::Serialize)]\npub struct SandboxRequest {\n    pub agent_id: String,\n    pub operation: String,\n    pub resource_type: String,\n    pub parameters: serde_json::Value,\n    pub timestamp: DateTime\u003cUtc\u003e,\n    pub session_id: Option\u003cString\u003e,\n}\n\n/// Response from sandbox validation\n#[derive(Debug, Clone)]\npub enum SandboxResponse {\n    /// Operation is allowed to proceed\n    Allow {\n        conditions: Vec\u003cString\u003e,\n        monitoring_required: bool,\n    },\n\n    /// Operation is denied\n    Deny {\n        reason: String,\n        suggestion: Option\u003cString\u003e,\n    },\n\n    /// Operation requires escalation to human\n    Escalate {\n        reason: String,\n        escalation_id: String,\n        timeout: chrono::Duration,\n    },\n\n    /// Operation is deferred for later evaluation\n    Defer {\n        reason: String,\n        retry_after: chrono::Duration,\n    },\n}\n\n/// Main sandbox engine that orchestrates validation\npub struct SandboxEngine {\n    permission_engine: PermissionEngine,\n    resource_monitor: ResourceMonitor,\n    command_validator: CommandValidator,\n    storage: Box\u003cdyn Storage\u003e,\n    start_time: Instant,\n}\n\nimpl SandboxEngine {\n    /// Create a new sandbox engine with the provided storage backend\n    pub fn new(storage: Box\u003cdyn Storage\u003e) -\u003e Self {\n        Self {\n            permission_engine: PermissionEngine::new(),\n            resource_monitor: ResourceMonitor::new(),\n            command_validator: CommandValidator::new(),\n            storage,\n            start_time: Instant::now(),\n        }\n    }\n\n    /// Validate a sandbox request against all constraints\n    pub async fn validate_request(\n        \u0026mut self,\n        request: SandboxRequest,\n    ) -\u003e SandboxResult\u003cSandboxResponse\u003e {\n        // Get sandbox configuration for the agent\n        let sandbox = self.get_agent_sandbox(\u0026request.agent_id).await?;\n\n        // Step 1: Permission validation\n        if let Err(e) = self\n            .permission_engine\n            .validate_operation(\u0026request, \u0026sandbox.permissions)\n            .await\n        {\n            return Ok(SandboxResponse::Deny {\n                reason: format!(\"Permission denied: {}\", e),\n                suggestion: Some(\n                    \"Request elevated permissions or contact administrator\".to_string(),\n                ),\n            });\n        }\n\n        // Step 2: Resource limits validation\n        if let Err(e) = self\n            .resource_monitor\n            .check_limits(\u0026request.agent_id, \u0026request, \u0026sandbox.resource_limits)\n            .await\n        {\n            return Ok(SandboxResponse::Deny {\n                reason: format!(\"Resource limit exceeded: {}\", e),\n                suggestion: Some(\"Reduce resource usage or request higher limits\".to_string()),\n            });\n        }\n\n        // Step 3: Command filtering\n        match self\n            .command_validator\n            .validate_command(\u0026request, \u0026sandbox.command_filter)\n            .await?\n        {\n            CommandValidationResult::Allow =\u003e {}\n            CommandValidationResult::Block(reason) =\u003e {\n                return Ok(SandboxResponse::Deny {\n                    reason: format!(\"Command blocked: {}\", reason),\n                    suggestion: Some(\"Use alternative commands or request permission\".to_string()),\n                });\n            }\n            CommandValidationResult::RequiresApproval =\u003e {\n                // Check escalation policy\n                if sandbox\n                    .escalation_policy\n                    .require_human_approval\n                    .iter()\n                    .any(|op_type| self.matches_operation_type(\u0026request.operation, op_type))\n                {\n                    let escalation_id = self.create_escalation_request(\u0026request, \u0026sandbox).await?;\n                    return Ok(SandboxResponse::Escalate {\n                        reason: \"Operation requires human approval\".to_string(),\n                        escalation_id,\n                        timeout: ChronoDuration::from_std(\n                            sandbox.escalation_policy.escalation_timeout,\n                        )\n                        .unwrap_or(ChronoDuration::minutes(10)),\n                    });\n                }\n            }\n        }\n\n        // Step 4: Check if monitoring is required\n        let monitoring_required = self.requires_monitoring(\u0026request, \u0026sandbox);\n\n        // Operation is allowed\n        Ok(SandboxResponse::Allow {\n            conditions: self.get_operation_conditions(\u0026request, \u0026sandbox),\n            monitoring_required,\n        })\n    }\n\n    /// Get sandbox configuration for an agent\n    async fn get_agent_sandbox(\u0026mut self, agent_id: \u0026str) -\u003e SandboxResult\u003cAgentSandbox\u003e {\n        // Try to find existing sandbox for this agent\n        let entity_ids: Vec\u003cString\u003e = self\n            .storage\n            .list_ids(\"agent_sandbox\")\n            .map_err(|e| SandboxError::StorageError(e.to_string()))?;\n\n        for entity_id in entity_ids {\n            if let Ok(Some(entity)) = self.storage.get(\u0026entity_id, \"agent_sandbox\") {\n                if let Ok(sandbox) = AgentSandbox::from_generic(entity) {\n                    if sandbox.agent_id == agent_id {\n                        return Ok(sandbox);\n                    }\n                }\n            }\n        }\n\n        // No sandbox found, create default based on agent type\n        self.create_default_sandbox(agent_id).await\n    }\n\n    /// Create default sandbox configuration for an agent\n    async fn create_default_sandbox(\u0026mut self, agent_id: \u0026str) -\u003e SandboxResult\u003cAgentSandbox\u003e {\n        let sandbox = AgentSandbox::new(\n            agent_id.to_string(),\n            SandboxLevel::Standard, // Default level\n            \"system\".to_string(),   // Created by system\n            \"default\".to_string(),  // Default agent\n        );\n\n        // Store the new sandbox\n        self.storage\n            .store(\u0026sandbox.to_generic())\n            .map_err(|e| SandboxError::StorageError(e.to_string()))?;\n\n        Ok(sandbox)\n    }\n\n    /// Create an escalation request for manual approval\n    async fn create_escalation_request(\n        \u0026mut self,\n        request: \u0026SandboxRequest,\n        sandbox: \u0026AgentSandbox,\n    ) -\u003e SandboxResult\u003cString\u003e {\n        let operation_type = self.infer_escalation_operation_type(\u0026request.operation);\n        let priority = self.infer_escalation_priority(sandbox, \u0026request.operation);\n\n        let operation_context = OperationContext {\n            operation: request.operation.clone(),\n            parameters: match request.parameters.as_object() {\n                Some(obj) =\u003e obj.iter().map(|(k, v)| (k.clone(), v.clone())).collect(),\n                None =\u003e HashMap::new(),\n            },\n            resource: Some(request.resource_type.clone()),\n            block_reason: format!(\n                \"Operation blocked by sandbox level {:?}\",\n                sandbox.sandbox_level\n            ),\n            alternatives: self.suggest_alternatives(\u0026request.operation),\n            risk_assessment: Some(self.assess_risk(\u0026request.operation)),\n        };\n\n        let mut escalation = EscalationRequest::new(\n            request.agent_id.clone(),\n            operation_type,\n            operation_context,\n            format!(\n                \"Agent {} requests permission for operation: {}\",\n                request.agent_id, request.operation\n            ),\n            priority,\n            \"default\".to_string(),\n        );\n\n        escalation.session_id = request.session_id.clone();\n\n        let generic_entity = escalation.to_generic();\n        let escalation_id = escalation.id.clone();\n\n        self.storage.store(\u0026generic_entity).map_err(|e| {\n            SandboxError::StorageError(format!(\"Failed to store escalation: {}\", e))\n        })?;\n\n        Ok(escalation_id)\n    }\n\n    fn infer_escalation_operation_type(\u0026self, operation: \u0026str) -\u003e EscalationOperationType {\n        match operation {\n            op if op.contains(\"file\") || op.contains(\"File\") =\u003e {\n                EscalationOperationType::FileSystemAccess\n            }\n            op if op.contains(\"network\") || op.contains(\"Network\") =\u003e {\n                EscalationOperationType::NetworkAccess\n            }\n            op if op.contains(\"command\") || op.contains(\"execute\") =\u003e {\n                EscalationOperationType::CommandExecution\n            }\n            op if op.contains(\"workflow\") || op.contains(\"Workflow\") =\u003e {\n                EscalationOperationType::WorkflowModification\n            }\n            op if op.contains(\"quality_gate\") =\u003e EscalationOperationType::QualityGateOverride,\n            op if op.contains(\"resource\") || op.contains(\"limit\") =\u003e {\n                EscalationOperationType::ResourceLimitIncrease\n            }\n            _ =\u003e EscalationOperationType::Custom(operation.to_string()),\n        }\n    }\n\n    fn infer_escalation_priority(\n        \u0026self,\n        sandbox: \u0026AgentSandbox,\n        operation: \u0026str,\n    ) -\u003e EscalationPriority {\n        let high_risk_ops = [\"delete\", \"remove\", \"execute\", \"command\"];\n        let is_high_risk = high_risk_ops.iter().any(|risk| operation.contains(risk));\n\n        match (\u0026sandbox.sandbox_level, is_high_risk) {\n            (SandboxLevel::Training, _) =\u003e EscalationPriority::Low,\n            (SandboxLevel::Isolated, true) =\u003e EscalationPriority::High,\n            (SandboxLevel::Isolated, false) =\u003e EscalationPriority::Normal,\n            (SandboxLevel::Restricted, true) =\u003e EscalationPriority::High,\n            (SandboxLevel::Restricted, false) =\u003e EscalationPriority::Normal,\n            (_, true) =\u003e EscalationPriority::High,\n            (_, false) =\u003e EscalationPriority::Normal,\n        }\n    }\n\n    fn suggest_alternatives(\u0026self, operation: \u0026str) -\u003e Vec\u003cString\u003e {\n        match operation {\n            \"file_delete\" =\u003e vec![\n                \"Use file_move to archive instead\".to_string(),\n                \"Request permission for specific file patterns\".to_string(),\n            ],\n            \"network_request\" =\u003e vec![\n                \"Use internal API endpoints if available\".to_string(),\n                \"Request proxy configuration\".to_string(),\n            ],\n            \"execute_command\" =\u003e vec![\n                \"Use engram built-in operations\".to_string(),\n                \"Request specific command whitelist\".to_string(),\n            ],\n            _ =\u003e vec![\"Contact administrator for guidance\".to_string()],\n        }\n    }\n\n    fn assess_risk(\u0026self, operation: \u0026str) -\u003e String {\n        match operation {\n            op if op.contains(\"delete\") || op.contains(\"remove\") =\u003e {\n                \"High risk: Irreversible data modification\".to_string()\n            }\n            op if op.contains(\"network\") =\u003e {\n                \"Medium risk: External communication and data exfiltration potential\".to_string()\n            }\n            op if op.contains(\"execute\") || op.contains(\"command\") =\u003e {\n                \"High risk: Arbitrary code execution\".to_string()\n            }\n            op if op.contains(\"write\") || op.contains(\"modify\") =\u003e {\n                \"Medium risk: Data modification\".to_string()\n            }\n            _ =\u003e \"Low risk: Read-only or safe operation\".to_string(),\n        }\n    }\n\n    /// Check if an operation requires monitoring\n    fn requires_monitoring(\u0026self, request: \u0026SandboxRequest, sandbox: \u0026AgentSandbox) -\u003e bool {\n        // High-risk operations always require monitoring\n        let high_risk_operations = [\n            \"file_write\",\n            \"file_delete\",\n            \"network_request\",\n            \"execute_command\",\n            \"modify_entity\",\n            \"delete_entity\",\n        ];\n\n        if high_risk_operations.contains(\u0026request.operation.as_str()) {\n            return true;\n        }\n\n        // Restricted and isolated levels require more monitoring\n        matches!(\n            sandbox.sandbox_level,\n            SandboxLevel::Restricted | SandboxLevel::Isolated\n        )\n    }\n\n    /// Get operation-specific conditions\n    fn get_operation_conditions(\n        \u0026self,\n        request: \u0026SandboxRequest,\n        sandbox: \u0026AgentSandbox,\n    ) -\u003e Vec\u003cString\u003e {\n        let mut conditions = Vec::new();\n\n        // Add level-specific conditions\n        match sandbox.sandbox_level {\n            SandboxLevel::Training =\u003e {\n                conditions.push(\"Operation will be logged for training purposes\".to_string());\n                conditions.push(\"No persistent changes will be made\".to_string());\n            }\n            SandboxLevel::Restricted =\u003e {\n                conditions.push(\"Operation will be closely monitored\".to_string());\n                conditions.push(\"Automatic rollback available\".to_string());\n            }\n            SandboxLevel::Isolated =\u003e {\n                conditions.push(\"Operation isolated from other agents\".to_string());\n                conditions.push(\"No external network access\".to_string());\n            }\n            _ =\u003e {}\n        }\n\n        // Add operation-specific conditions\n        match request.operation.as_str() {\n            \"file_write\" =\u003e {\n                conditions.push(\"File changes will be versioned\".to_string());\n            }\n            \"network_request\" =\u003e {\n                conditions.push(\"Network traffic will be logged\".to_string());\n            }\n            _ =\u003e {}\n        }\n\n        conditions\n    }\n\n    /// Update sandbox configuration\n    pub async fn update_sandbox(\n        \u0026mut self,\n        agent_id: \u0026str,\n        level: SandboxLevel,\n        _updated_by: \u0026str,\n    ) -\u003e SandboxResult\u003c()\u003e {\n        let mut sandbox = self.get_agent_sandbox(agent_id).await?;\n\n        sandbox.sandbox_level = level;\n        sandbox.last_modified = Utc::now();\n\n        self.storage\n            .store(\u0026sandbox.to_generic())\n            .map_err(|e| SandboxError::StorageError(e.to_string()))?;\n\n        Ok(())\n    }\n\n    /// Record a violation for monitoring and analytics\n    pub async fn record_violation(\n        \u0026mut self,\n        agent_id: \u0026str,\n        violation_type: \u0026str,\n        description: \u0026str,\n    ) -\u003e SandboxResult\u003c()\u003e {\n        let mut sandbox = self.get_agent_sandbox(agent_id).await?;\n\n        sandbox.violation_count += 1;\n        sandbox.last_modified = Utc::now();\n\n        // Add to metadata\n        let violation_entry = serde_json::json!({\n            \"type\": violation_type,\n            \"description\": description,\n            \"timestamp\": Utc::now(),\n        });\n\n        if let Some(violations) = sandbox.metadata.get_mut(\"violations\") {\n            if let Some(array) = violations.as_array_mut() {\n                array.push(violation_entry);\n            }\n        } else {\n            sandbox.metadata.insert(\n                \"violations\".to_string(),\n                serde_json::json!([violation_entry]),\n            );\n        }\n\n        self.storage\n            .store(\u0026sandbox.to_generic())\n            .map_err(|e| SandboxError::StorageError(e.to_string()))?;\n\n        Ok(())\n    }\n\n    /// Get sandbox statistics for monitoring\n    pub async fn get_sandbox_stats(\u0026mut self, agent_id: \u0026str) -\u003e SandboxResult\u003cSandboxStats\u003e {\n        let sandbox = self.get_agent_sandbox(agent_id).await?;\n\n        Ok(SandboxStats {\n            agent_id: sandbox.agent_id.clone(),\n            sandbox_level: sandbox.sandbox_level.clone(),\n            violation_count: sandbox.violation_count,\n            created_at: sandbox.created_at,\n            last_modified: sandbox.last_modified,\n            uptime: self.start_time.elapsed(),\n        })\n    }\n\n    /// Helper method to match operation string to OperationType\n    fn matches_operation_type(\u0026self, operation: \u0026str, op_type: \u0026OperationType) -\u003e bool {\n        use OperationType::*;\n        match op_type {\n            FileWrite =\u003e {\n                operation == \"file_write\" || operation == \"write_file\" || operation == \"create_file\"\n            }\n            FileDelete =\u003e operation == \"file_delete\" || operation == \"delete_file\",\n            CommandExecution =\u003e operation == \"execute_command\",\n            NetworkAccess =\u003e operation == \"network_request\",\n            ConfigChange =\u003e operation == \"config_change\",\n            DatabaseOperation =\u003e operation == \"database_operation\",\n            SystemFileAccess =\u003e operation == \"system_file_access\",\n            PrivilegedOperation =\u003e operation == \"privileged_operation\",\n        }\n    }\n}\n\n/// Command validation result\n#[derive(Debug, Clone)]\npub enum CommandValidationResult {\n    Allow,\n    Block(String),\n    RequiresApproval,\n}\n\n/// Sandbox statistics for monitoring\n#[derive(Debug, Clone)]\npub struct SandboxStats {\n    pub agent_id: String,\n    pub sandbox_level: SandboxLevel,\n    pub violation_count: u32,\n    pub created_at: DateTime\u003cUtc\u003e,\n    pub last_modified: DateTime\u003cUtc\u003e,\n    pub uptime: std::time::Duration,\n}\n","traces":[{"line":106,"address":[21268240,21268684,21268712],"length":1,"stats":{"Line":0}},{"line":108,"address":[26947467],"length":1,"stats":{"Line":0}},{"line":109,"address":[19606276],"length":1,"stats":{"Line":0}},{"line":110,"address":[16055174],"length":1,"stats":{"Line":0}},{"line":112,"address":[21268485],"length":1,"stats":{"Line":0}},{"line":117,"address":[16050768],"length":1,"stats":{"Line":0}},{"line":122,"address":[17938008,17937765,17937836,17938155,17938837],"length":1,"stats":{"Line":0}},{"line":125,"address":[23761350,23761784,23761479,23761834],"length":1,"stats":{"Line":0}},{"line":127,"address":[23300685],"length":1,"stats":{"Line":0}},{"line":128,"address":[23761816,23760593,23761444,23761547,23761618],"length":1,"stats":{"Line":0}},{"line":130,"address":[18521422],"length":1,"stats":{"Line":0}},{"line":131,"address":[23761902,23762027],"length":1,"stats":{"Line":0}},{"line":132,"address":[17939466],"length":1,"stats":{"Line":0}},{"line":133,"address":[16642879],"length":1,"stats":{"Line":0}},{"line":139,"address":[16572786,16571921,16572736,16572509],"length":1,"stats":{"Line":0}},{"line":141,"address":[16643206,16642705],"length":1,"stats":{"Line":0}},{"line":142,"address":[16572768,16570598,16572573,16572474,16572542],"length":1,"stats":{"Line":0}},{"line":144,"address":[16421942],"length":1,"stats":{"Line":0}},{"line":145,"address":[16632102,16632231],"length":1,"stats":{"Line":0}},{"line":146,"address":[17682011,17682086],"length":1,"stats":{"Line":0}},{"line":151,"address":[16573678,16573777,16575256,16572889,16573393,16573620],"length":1,"stats":{"Line":0}},{"line":153,"address":[16572900],"length":1,"stats":{"Line":0}},{"line":154,"address":[18522605,18522530,18519899,18522578,18522792,18522879],"length":1,"stats":{"Line":0}},{"line":157,"address":[16633250],"length":1,"stats":{"Line":0}},{"line":158,"address":[18523477],"length":1,"stats":{"Line":0}},{"line":159,"address":[16633288,16633398],"length":1,"stats":{"Line":0}},{"line":160,"address":[23764266,23764341],"length":1,"stats":{"Line":0}},{"line":165,"address":[17683003,17683559,17683502],"length":1,"stats":{"Line":0}},{"line":169,"address":[16635411,16635392,16633838],"length":1,"stats":{"Line":0}},{"line":171,"address":[16575130,16574648,16575269,16576135,16570640],"length":1,"stats":{"Line":0}},{"line":172,"address":[23765957],"length":1,"stats":{"Line":0}},{"line":173,"address":[23305022],"length":1,"stats":{"Line":0}},{"line":174,"address":[23305102],"length":1,"stats":{"Line":0}},{"line":175,"address":[16424563],"length":1,"stats":{"Line":0}},{"line":176,"address":[17684726],"length":1,"stats":{"Line":0}},{"line":178,"address":[17684807],"length":1,"stats":{"Line":0}},{"line":185,"address":[23763968,23764722],"length":1,"stats":{"Line":0}},{"line":188,"address":[18523921],"length":1,"stats":{"Line":0}},{"line":189,"address":[17941995],"length":1,"stats":{"Line":0}},{"line":195,"address":[23307714,23305599,23305552,23305712,23307527,23306574],"length":1,"stats":{"Line":0}},{"line":197,"address":[16576467,16576332,16578320,16576554],"length":1,"stats":{"Line":0}},{"line":200,"address":[16425192,16425274,16427458,16427440],"length":1,"stats":{"Line":0}},{"line":202,"address":[16576663,16576771,16576906],"length":1,"stats":{"Line":0}},{"line":203,"address":[16577311,16577423,16576980],"length":1,"stats":{"Line":0}},{"line":204,"address":[16648356,16648560,16648449],"length":1,"stats":{"Line":0}},{"line":205,"address":[16426622,16426551],"length":1,"stats":{"Line":0}},{"line":206,"address":[17686826],"length":1,"stats":{"Line":0}},{"line":213,"address":[16576395,16578401,16577055,16577117],"length":1,"stats":{"Line":0}},{"line":217,"address":[20717632,20717650],"length":1,"stats":{"Line":0}},{"line":219,"address":[16429020,16428944],"length":1,"stats":{"Line":0}},{"line":221,"address":[17947639,17947556],"length":1,"stats":{"Line":0}},{"line":222,"address":[16429119],"length":1,"stats":{"Line":0}},{"line":226,"address":[18529445,18529630,18529697,18529530],"length":1,"stats":{"Line":0}},{"line":227,"address":[16580634,16580539],"length":1,"stats":{"Line":0}},{"line":228,"address":[16580827,16580761,16581136,16580638,16581154,16580940],"length":1,"stats":{"Line":0}},{"line":230,"address":[23310190],"length":1,"stats":{"Line":0}},{"line":234,"address":[26485712],"length":1,"stats":{"Line":0}},{"line":239,"address":[18530365,18530483],"length":1,"stats":{"Line":0}},{"line":240,"address":[18530585,18530503],"length":1,"stats":{"Line":0}},{"line":243,"address":[16430476],"length":1,"stats":{"Line":0}},{"line":244,"address":[17949130,17949064],"length":1,"stats":{"Line":0}},{"line":248,"address":[16430826,16430698],"length":1,"stats":{"Line":0}},{"line":249,"address":[16430858,16430936],"length":1,"stats":{"Line":0}},{"line":253,"address":[16653057,16653137],"length":1,"stats":{"Line":0}},{"line":254,"address":[23311737,23311817],"length":1,"stats":{"Line":0}},{"line":258,"address":[16582799,16582745],"length":1,"stats":{"Line":0}},{"line":259,"address":[17950087],"length":1,"stats":{"Line":0}},{"line":260,"address":[23772871],"length":1,"stats":{"Line":0}},{"line":261,"address":[16582906,16583010],"length":1,"stats":{"Line":0}},{"line":266,"address":[23312497],"length":1,"stats":{"Line":0}},{"line":269,"address":[17692295,17692362,17692381],"length":1,"stats":{"Line":0}},{"line":271,"address":[16654325],"length":1,"stats":{"Line":0}},{"line":272,"address":[23312928],"length":1,"stats":{"Line":0}},{"line":274,"address":[16642981,16644128,16644366,16643095,16642908],"length":1,"stats":{"Line":0}},{"line":275,"address":[23314246,23314314],"length":1,"stats":{"Line":0}},{"line":278,"address":[17692812],"length":1,"stats":{"Line":0}},{"line":281,"address":[16054368],"length":1,"stats":{"Line":0}},{"line":283,"address":[19816045],"length":1,"stats":{"Line":0}},{"line":284,"address":[19827646],"length":1,"stats":{"Line":0}},{"line":286,"address":[19756896],"length":1,"stats":{"Line":0}},{"line":287,"address":[19816225],"length":1,"stats":{"Line":0}},{"line":289,"address":[26486339],"length":1,"stats":{"Line":0}},{"line":290,"address":[19816324],"length":1,"stats":{"Line":0}},{"line":292,"address":[20719606],"length":1,"stats":{"Line":0}},{"line":293,"address":[21267991],"length":1,"stats":{"Line":0}},{"line":295,"address":[19757284,19757193],"length":1,"stats":{"Line":0}},{"line":296,"address":[21268051,21268115],"length":1,"stats":{"Line":0}},{"line":297,"address":[21268154],"length":1,"stats":{"Line":0}},{"line":299,"address":[26947369],"length":1,"stats":{"Line":0}},{"line":303,"address":[20718928],"length":1,"stats":{"Line":0}},{"line":308,"address":[26946485],"length":1,"stats":{"Line":0}},{"line":309,"address":[18533920,18533940],"length":1,"stats":{"Line":0}},{"line":311,"address":[20719141],"length":1,"stats":{"Line":0}},{"line":312,"address":[21267521],"length":1,"stats":{"Line":0}},{"line":313,"address":[19815991],"length":1,"stats":{"Line":0}},{"line":314,"address":[26946752],"length":1,"stats":{"Line":0}},{"line":315,"address":[21267535],"length":1,"stats":{"Line":0}},{"line":316,"address":[19815960],"length":1,"stats":{"Line":0}},{"line":317,"address":[21267573],"length":1,"stats":{"Line":0}},{"line":318,"address":[26946766],"length":1,"stats":{"Line":0}},{"line":322,"address":[20716713,20716128,20716705],"length":1,"stats":{"Line":0}},{"line":324,"address":[19754903,19753747,19754834,19754941,19753683],"length":1,"stats":{"Line":0}},{"line":325,"address":[19753757],"length":1,"stats":{"Line":0}},{"line":326,"address":[16052479],"length":1,"stats":{"Line":0}},{"line":328,"address":[16051330,16052144,16052207,16052248,16051447],"length":1,"stats":{"Line":0}},{"line":329,"address":[20716356],"length":1,"stats":{"Line":0}},{"line":330,"address":[20717080],"length":1,"stats":{"Line":0}},{"line":332,"address":[19602694,19603041,19602966,19603082,19602550],"length":1,"stats":{"Line":0}},{"line":333,"address":[16051571],"length":1,"stats":{"Line":0}},{"line":334,"address":[19825026],"length":1,"stats":{"Line":0}},{"line":336,"address":[19602640,19602951,19602741],"length":1,"stats":{"Line":0}},{"line":340,"address":[26481840],"length":1,"stats":{"Line":0}},{"line":342,"address":[19752524],"length":1,"stats":{"Line":0}},{"line":343,"address":[19823372],"length":1,"stats":{"Line":0}},{"line":345,"address":[20715139],"length":1,"stats":{"Line":0}},{"line":346,"address":[21263533],"length":1,"stats":{"Line":0}},{"line":348,"address":[21263556,21263485],"length":1,"stats":{"Line":0}},{"line":349,"address":[19601530],"length":1,"stats":{"Line":0}},{"line":351,"address":[19601550],"length":1,"stats":{"Line":0}},{"line":352,"address":[21263694],"length":1,"stats":{"Line":0}},{"line":354,"address":[21263718],"length":1,"stats":{"Line":0}},{"line":359,"address":[19602080],"length":1,"stats":{"Line":0}},{"line":361,"address":[19824145],"length":1,"stats":{"Line":0}},{"line":370,"address":[21264319],"length":1,"stats":{"Line":0}},{"line":371,"address":[19753580],"length":1,"stats":{"Line":0}},{"line":375,"address":[21264403,21264384],"length":1,"stats":{"Line":0}},{"line":376,"address":[19824329],"length":1,"stats":{"Line":0}},{"line":382,"address":[20718855,20718861,20718064],"length":1,"stats":{"Line":0}},{"line":387,"address":[16053203],"length":1,"stats":{"Line":0}},{"line":390,"address":[19826390],"length":1,"stats":{"Line":0}},{"line":392,"address":[26946018,26945778],"length":1,"stats":{"Line":0}},{"line":393,"address":[20718535],"length":1,"stats":{"Line":0}},{"line":396,"address":[26485041,26485178],"length":1,"stats":{"Line":0}},{"line":397,"address":[21266674],"length":1,"stats":{"Line":0}},{"line":400,"address":[26485072,26485262],"length":1,"stats":{"Line":0}},{"line":401,"address":[16053542],"length":1,"stats":{"Line":0}},{"line":407,"address":[16053693,16053273],"length":1,"stats":{"Line":0}},{"line":408,"address":[21266925],"length":1,"stats":{"Line":0}},{"line":409,"address":[19827085,19826943],"length":1,"stats":{"Line":0}},{"line":411,"address":[20718722,20718664],"length":1,"stats":{"Line":0}},{"line":412,"address":[26946276],"length":1,"stats":{"Line":0}},{"line":417,"address":[19826994],"length":1,"stats":{"Line":0}},{"line":421,"address":[20715456],"length":1,"stats":{"Line":0}},{"line":427,"address":[18515171,18515023,18514977,18516046,18515093],"length":1,"stats":{"Line":0}},{"line":429,"address":[16625381],"length":1,"stats":{"Line":0}},{"line":430,"address":[16566211,16566146],"length":1,"stats":{"Line":0}},{"line":432,"address":[17675225,17675320,17675169,17675407],"length":1,"stats":{"Line":0}},{"line":433,"address":[18515680,18515717],"length":1,"stats":{"Line":0}},{"line":434,"address":[23295857,23295665,23295791,23296032,23296050,23295981],"length":1,"stats":{"Line":0}},{"line":436,"address":[23756548],"length":1,"stats":{"Line":0}},{"line":440,"address":[26943056],"length":1,"stats":{"Line":0}},{"line":446,"address":[18516498,18519422,18516428,18516584,18516382],"length":1,"stats":{"Line":0}},{"line":448,"address":[18516939,18516989],"length":1,"stats":{"Line":0}},{"line":449,"address":[16416474,16416394],"length":1,"stats":{"Line":0}},{"line":452,"address":[23758152,23757853,23760093,23757776,23757924,23758466,23757815,23758220,23758404],"length":1,"stats":{"Line":0}},{"line":455,"address":[17935711],"length":1,"stats":{"Line":0}},{"line":458,"address":[16639474,16639556],"length":1,"stats":{"Line":0}},{"line":459,"address":[17677771,17677839],"length":1,"stats":{"Line":0}},{"line":460,"address":[17936246,17936359],"length":1,"stats":{"Line":0}},{"line":463,"address":[16628732,16628107],"length":1,"stats":{"Line":0}},{"line":464,"address":[17678044,17677800],"length":1,"stats":{"Line":0}},{"line":465,"address":[23298478,23298533,23299372],"length":1,"stats":{"Line":0}},{"line":469,"address":[16417782,16418501,16418414,16418319],"length":1,"stats":{"Line":0}},{"line":470,"address":[16417804,16418339],"length":1,"stats":{"Line":0}},{"line":471,"address":[16418469,16418538,16418699,16418912,16418343,16418930],"length":1,"stats":{"Line":0}},{"line":473,"address":[16629053],"length":1,"stats":{"Line":0}},{"line":477,"address":[20715810,20715792],"length":1,"stats":{"Line":0}},{"line":478,"address":[17946316,17946426,17947339,17946265,17946215],"length":1,"stats":{"Line":0}},{"line":480,"address":[16639038],"length":1,"stats":{"Line":0}},{"line":481,"address":[23308886],"length":1,"stats":{"Line":0}},{"line":482,"address":[23769623],"length":1,"stats":{"Line":0}},{"line":483,"address":[23309016],"length":1,"stats":{"Line":0}},{"line":484,"address":[16650450],"length":1,"stats":{"Line":0}},{"line":485,"address":[23309056],"length":1,"stats":{"Line":0}},{"line":486,"address":[17947022],"length":1,"stats":{"Line":0}},{"line":491,"address":[20717680],"length":1,"stats":{"Line":0}},{"line":493,"address":[19814440],"length":1,"stats":{"Line":0}},{"line":495,"address":[19814471,19814698],"length":1,"stats":{"Line":0}},{"line":497,"address":[19814502,19814764],"length":1,"stats":{"Line":0}},{"line":498,"address":[19604037],"length":1,"stats":{"Line":0}},{"line":499,"address":[20717826],"length":1,"stats":{"Line":0}},{"line":500,"address":[26484687],"length":1,"stats":{"Line":0}},{"line":501,"address":[26945388],"length":1,"stats":{"Line":0}},{"line":502,"address":[20717910],"length":1,"stats":{"Line":0}},{"line":503,"address":[19604176],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":185},{"path":["/","home","shift","code","vincents-ai","engram","src","sandbox","permission_engine.rs"],"content":"use crate::entities::{FileOperation, NetworkPolicy, PermissionSet};\nuse crate::sandbox::{SandboxError, SandboxRequest, SandboxResult};\nuse std::collections::HashMap;\n\npub struct PermissionEngine {\n    cached_permissions: HashMap\u003cString, PermissionSet\u003e,\n}\n\nimpl PermissionEngine {\n    pub fn new() -\u003e Self {\n        Self {\n            cached_permissions: HashMap::new(),\n        }\n    }\n\n    pub async fn validate_operation(\n        \u0026mut self,\n        request: \u0026SandboxRequest,\n        permissions: \u0026PermissionSet,\n    ) -\u003e SandboxResult\u003c()\u003e {\n        match request.operation.as_str() {\n            \"read_file\" | \"list_files\" =\u003e {\n                if !permissions\n                    .allowed_file_operations\n                    .contains(\u0026FileOperation::Read)\n                {\n                    return Err(SandboxError::PermissionDenied(\n                        \"File read operations not permitted\".to_string(),\n                    ));\n                }\n            }\n            \"write_file\" | \"create_file\" | \"modify_file\" =\u003e {\n                if !permissions\n                    .allowed_file_operations\n                    .contains(\u0026FileOperation::Write)\n                {\n                    return Err(SandboxError::PermissionDenied(\n                        \"File write operations not permitted\".to_string(),\n                    ));\n                }\n            }\n            \"delete_file\" | \"move_file\" =\u003e {\n                if !permissions\n                    .allowed_file_operations\n                    .contains(\u0026FileOperation::Delete)\n                {\n                    return Err(SandboxError::PermissionDenied(\n                        \"File deletion operations not permitted\".to_string(),\n                    ));\n                }\n            }\n            \"execute_command\" =\u003e {\n                // Check if command is allowed via command permissions\n                let command_name = request\n                    .parameters\n                    .get(\"command\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\u0026request.operation);\n\n                if !self.is_command_allowed(command_name, permissions) {\n                    return Err(SandboxError::PermissionDenied(\n                        \"Command execution not permitted\".to_string(),\n                    ));\n                }\n            }\n            \"network_request\" =\u003e match permissions.network_access {\n                NetworkPolicy::Denied =\u003e {\n                    return Err(SandboxError::PermissionDenied(\n                        \"Network access not permitted\".to_string(),\n                    ));\n                }\n                NetworkPolicy::InternalOnly =\u003e {\n                    if let Some(url) = request.parameters.get(\"url\") {\n                        if let Some(url_str) = url.as_str() {\n                            if !self.is_internal_url(url_str) {\n                                return Err(SandboxError::PermissionDenied(\n                                    \"External network access not permitted\".to_string(),\n                                ));\n                            }\n                        }\n                    }\n                }\n                NetworkPolicy::AllowedWithMonitoring | NetworkPolicy::Unrestricted =\u003e {}\n            },\n            \"create_workflow\" =\u003e {\n                if !permissions.workflow_permissions.can_create_workflows {\n                    return Err(SandboxError::PermissionDenied(\n                        \"Workflow creation not permitted\".to_string(),\n                    ));\n                }\n            }\n            \"modify_workflow\" =\u003e {\n                if !permissions.workflow_permissions.can_modify_workflows {\n                    return Err(SandboxError::PermissionDenied(\n                        \"Workflow modification not permitted\".to_string(),\n                    ));\n                }\n            }\n            \"execute_workflow\" =\u003e {\n                if !permissions.workflow_permissions.can_execute_workflows {\n                    return Err(SandboxError::PermissionDenied(\n                        \"Workflow execution not permitted\".to_string(),\n                    ));\n                }\n\n                if let Some(workflow_type) = request.parameters.get(\"workflow_type\") {\n                    if let Some(workflow_str) = workflow_type.as_str() {\n                        if permissions\n                            .workflow_permissions\n                            .restricted_workflow_types\n                            .contains(\u0026workflow_str.to_string())\n                        {\n                            return Err(SandboxError::PermissionDenied(format!(\n                                \"Workflow type '{}' is restricted\",\n                                workflow_str\n                            )));\n                        }\n                    }\n                }\n            }\n            _ =\u003e {\n                return Err(SandboxError::PermissionDenied(format!(\n                    \"Unknown operation: {}\",\n                    request.operation\n                )));\n            }\n        }\n\n        Ok(())\n    }\n\n    fn is_command_allowed(\u0026self, command: \u0026str, permissions: \u0026PermissionSet) -\u003e bool {\n        // Check if command matches any allowed command patterns\n        permissions\n            .allowed_commands\n            .iter()\n            .any(|cmd_perm| match \u0026cmd_perm.pattern {\n                crate::entities::CommandPattern::Exact {\n                    command: allowed_cmd,\n                } =\u003e command == allowed_cmd,\n                crate::entities::CommandPattern::Prefix { prefix } =\u003e command.starts_with(prefix),\n                crate::entities::CommandPattern::Regex { pattern } =\u003e {\n                    if let Ok(regex) = regex::Regex::new(pattern) {\n                        regex.is_match(command)\n                    } else {\n                        false\n                    }\n                }\n                crate::entities::CommandPattern::Builtin { command_type } =\u003e {\n                    self.matches_builtin_command_type(command, command_type)\n                }\n            })\n    }\n\n    fn matches_builtin_command_type(\n        \u0026self,\n        command: \u0026str,\n        command_type: \u0026crate::entities::BuiltinCommandType,\n    ) -\u003e bool {\n        use crate::entities::BuiltinCommandType;\n        match command_type {\n            BuiltinCommandType::Git =\u003e command.starts_with(\"git\"),\n            BuiltinCommandType::Cargo =\u003e command.starts_with(\"cargo\"),\n            BuiltinCommandType::Engram =\u003e command.starts_with(\"engram\"),\n            BuiltinCommandType::FileSystem =\u003e matches!(\n                command,\n                \"read_file\" | \"write_file\" | \"delete_file\" | \"list_files\" | \"create_file\"\n            ),\n            BuiltinCommandType::Network =\u003e matches!(\n                command,\n                \"network_request\" | \"http_get\" | \"http_post\" | \"download_file\"\n            ),\n            BuiltinCommandType::System =\u003e {\n                matches!(command, \"execute_command\" | \"system_info\" | \"process_list\")\n            }\n        }\n    }\n\n    fn is_internal_url(\u0026self, url: \u0026str) -\u003e bool {\n        // Simple string-based internal URL check without url crate dependency\n        url.starts_with(\"http://127.\")\n            || url.starts_with(\"https://127.\")\n            || url.starts_with(\"http://192.168.\")\n            || url.starts_with(\"https://192.168.\")\n            || url.starts_with(\"http://10.\")\n            || url.starts_with(\"https://10.\")\n            || url.starts_with(\"http://localhost\")\n            || url.starts_with(\"https://localhost\")\n            || url.contains(\".local\")\n    }\n\n    pub fn cache_permissions(\u0026mut self, agent_id: String, permissions: PermissionSet) {\n        self.cached_permissions.insert(agent_id, permissions);\n    }\n\n    pub fn clear_cache(\u0026mut self) {\n        self.cached_permissions.clear();\n    }\n\n    pub fn get_cached_permissions(\u0026self, agent_id: \u0026str) -\u003e Option\u003c\u0026PermissionSet\u003e {\n        self.cached_permissions.get(agent_id)\n    }\n}\n\nimpl Default for PermissionEngine {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n","traces":[{"line":10,"address":[16169696],"length":1,"stats":{"Line":0}},{"line":12,"address":[23288958],"length":1,"stats":{"Line":0}},{"line":16,"address":[17881296],"length":1,"stats":{"Line":0}},{"line":21,"address":[17929989,17930101],"length":1,"stats":{"Line":0}},{"line":22,"address":[15982075,15982205],"length":1,"stats":{"Line":0}},{"line":23,"address":[16260244,16264071],"length":1,"stats":{"Line":0}},{"line":25,"address":[16137213],"length":1,"stats":{"Line":0}},{"line":27,"address":[23327296],"length":1,"stats":{"Line":0}},{"line":28,"address":[17504529],"length":1,"stats":{"Line":0}},{"line":32,"address":[17500885,17500755],"length":1,"stats":{"Line":0}},{"line":33,"address":[16207795,16204332],"length":1,"stats":{"Line":0}},{"line":35,"address":[22866345],"length":1,"stats":{"Line":0}},{"line":37,"address":[16263900],"length":1,"stats":{"Line":0}},{"line":38,"address":[22866381],"length":1,"stats":{"Line":0}},{"line":42,"address":[17167554,17167684],"length":1,"stats":{"Line":0}},{"line":43,"address":[16263647,16260603],"length":1,"stats":{"Line":0}},{"line":45,"address":[17170661],"length":1,"stats":{"Line":0}},{"line":47,"address":[16263688],"length":1,"stats":{"Line":0}},{"line":48,"address":[17504105],"length":1,"stats":{"Line":0}},{"line":52,"address":[16204602],"length":1,"stats":{"Line":0}},{"line":54,"address":[17170440,17167795],"length":1,"stats":{"Line":0}},{"line":57,"address":[23327456,23326447,23327465],"length":1,"stats":{"Line":0}},{"line":58,"address":[23326496],"length":1,"stats":{"Line":0}},{"line":60,"address":[23326600],"length":1,"stats":{"Line":0}},{"line":61,"address":[22865988],"length":1,"stats":{"Line":0}},{"line":62,"address":[17933373],"length":1,"stats":{"Line":0}},{"line":66,"address":[16260721,16260856,16260800],"length":1,"stats":{"Line":0}},{"line":68,"address":[17503199],"length":1,"stats":{"Line":0}},{"line":69,"address":[22865189],"length":1,"stats":{"Line":0}},{"line":73,"address":[17503164,17503333],"length":1,"stats":{"Line":0}},{"line":74,"address":[16136112],"length":1,"stats":{"Line":0}},{"line":75,"address":[16263066],"length":1,"stats":{"Line":0}},{"line":76,"address":[16263126],"length":1,"stats":{"Line":0}},{"line":77,"address":[17170135],"length":1,"stats":{"Line":0}},{"line":85,"address":[15982742,15982834],"length":1,"stats":{"Line":0}},{"line":86,"address":[15982890],"length":1,"stats":{"Line":0}},{"line":87,"address":[16262548],"length":1,"stats":{"Line":0}},{"line":88,"address":[16262517],"length":1,"stats":{"Line":0}},{"line":92,"address":[16204872,16204928],"length":1,"stats":{"Line":0}},{"line":93,"address":[17168088],"length":1,"stats":{"Line":0}},{"line":94,"address":[17502836],"length":1,"stats":{"Line":0}},{"line":95,"address":[16262357],"length":1,"stats":{"Line":0}},{"line":99,"address":[17168110,17168054],"length":1,"stats":{"Line":0}},{"line":100,"address":[15983043],"length":1,"stats":{"Line":0}},{"line":101,"address":[16134690],"length":1,"stats":{"Line":0}},{"line":102,"address":[22863957],"length":1,"stats":{"Line":0}},{"line":106,"address":[17168524,17168699],"length":1,"stats":{"Line":0}},{"line":107,"address":[16205650,16205710],"length":1,"stats":{"Line":0}},{"line":108,"address":[23325045,23325224],"length":1,"stats":{"Line":0}},{"line":111,"address":[15983966,15983841],"length":1,"stats":{"Line":0}},{"line":113,"address":[16135263],"length":1,"stats":{"Line":0}},{"line":122,"address":[17931090,17931036],"length":1,"stats":{"Line":0}},{"line":129,"address":[22864253],"length":1,"stats":{"Line":0}},{"line":132,"address":[22827440],"length":1,"stats":{"Line":0}},{"line":134,"address":[16098138],"length":1,"stats":{"Line":0}},{"line":137,"address":[22862331,22861840,22862337,22861862],"length":1,"stats":{"Line":0}},{"line":139,"address":[16259404],"length":1,"stats":{"Line":0}},{"line":140,"address":[17499861],"length":1,"stats":{"Line":0}},{"line":141,"address":[17499896],"length":1,"stats":{"Line":0}},{"line":142,"address":[15981409],"length":1,"stats":{"Line":0}},{"line":143,"address":[16132669,16132784],"length":1,"stats":{"Line":0}},{"line":144,"address":[23322898,23322830],"length":1,"stats":{"Line":0}},{"line":146,"address":[16259611],"length":1,"stats":{"Line":0}},{"line":149,"address":[17929528],"length":1,"stats":{"Line":0}},{"line":150,"address":[16132740],"length":1,"stats":{"Line":0}},{"line":155,"address":[17140368],"length":1,"stats":{"Line":0}},{"line":161,"address":[22827666],"length":1,"stats":{"Line":0}},{"line":162,"address":[16169131],"length":1,"stats":{"Line":0}},{"line":163,"address":[16169170],"length":1,"stats":{"Line":0}},{"line":164,"address":[17465721],"length":1,"stats":{"Line":0}},{"line":165,"address":[16225456],"length":1,"stats":{"Line":0}},{"line":169,"address":[16169532],"length":1,"stats":{"Line":0}},{"line":174,"address":[17881941,17881638],"length":1,"stats":{"Line":0}},{"line":179,"address":[22826992],"length":1,"stats":{"Line":0}},{"line":181,"address":[17139839,17139783],"length":1,"stats":{"Line":0}},{"line":182,"address":[17139815],"length":1,"stats":{"Line":0}},{"line":183,"address":[17880867],"length":1,"stats":{"Line":0}},{"line":184,"address":[17465091],"length":1,"stats":{"Line":0}},{"line":185,"address":[16224675],"length":1,"stats":{"Line":0}},{"line":186,"address":[22827219],"length":1,"stats":{"Line":0}},{"line":187,"address":[22827255],"length":1,"stats":{"Line":0}},{"line":188,"address":[23287963],"length":1,"stats":{"Line":0}},{"line":189,"address":[16224815],"length":1,"stats":{"Line":0}},{"line":192,"address":[23288048],"length":1,"stats":{"Line":0}},{"line":193,"address":[17140136],"length":1,"stats":{"Line":0}},{"line":196,"address":[17880720],"length":1,"stats":{"Line":0}},{"line":197,"address":[17139717],"length":1,"stats":{"Line":0}},{"line":200,"address":[23288272],"length":1,"stats":{"Line":0}},{"line":201,"address":[15947026],"length":1,"stats":{"Line":0}},{"line":206,"address":[16099040],"length":1,"stats":{"Line":0}},{"line":207,"address":[15947800],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":91},{"path":["/","home","shift","code","vincents-ai","engram","src","sandbox","resource_monitor.rs"],"content":"use crate::entities::ResourceLimits;\nuse crate::sandbox::{SandboxError, SandboxRequest, SandboxResult};\nuse std::collections::HashMap;\nuse std::time::{Duration, Instant};\n\npub struct ResourceMonitor {\n    agent_usage: HashMap\u003cString, AgentResourceUsage\u003e,\n    #[allow(dead_code)]\n    start_time: Instant,\n}\n\n#[derive(Debug, Clone)]\nstruct AgentResourceUsage {\n    memory_mb: f64,\n    cpu_percentage: f64,\n    disk_space_mb: f64,\n    active_operations: u32,\n    network_requests_count: u32,\n    network_requests_window_start: Instant,\n    execution_start: Option\u003cInstant\u003e,\n}\n\nimpl AgentResourceUsage {\n    fn new() -\u003e Self {\n        Self {\n            memory_mb: 0.0,\n            cpu_percentage: 0.0,\n            disk_space_mb: 0.0,\n            active_operations: 0,\n            network_requests_count: 0,\n            network_requests_window_start: Instant::now(),\n            execution_start: None,\n        }\n    }\n}\n\nimpl ResourceMonitor {\n    pub fn new() -\u003e Self {\n        Self {\n            agent_usage: HashMap::new(),\n            start_time: Instant::now(),\n        }\n    }\n\n    pub async fn check_limits(\n        \u0026mut self,\n        agent_id: \u0026str,\n        request: \u0026SandboxRequest,\n        limits: \u0026ResourceLimits,\n    ) -\u003e SandboxResult\u003c()\u003e {\n        // First update usage\n        self.update_current_usage(agent_id).await?;\n\n        // Get usage values after update\n        let (memory, cpu, disk, active_ops, execution_start) = {\n            let usage = self\n                .agent_usage\n                .entry(agent_id.to_string())\n                .or_insert_with(AgentResourceUsage::new);\n            (\n                usage.memory_mb,\n                usage.cpu_percentage,\n                usage.disk_space_mb,\n                usage.active_operations,\n                usage.execution_start,\n            )\n        }; // usage borrow is dropped here\n\n        if memory \u003e limits.max_memory_mb as f64 {\n            return Err(SandboxError::ResourceLimitExceeded(format!(\n                \"Memory usage {:.1}MB exceeds limit {}MB\",\n                memory, limits.max_memory_mb\n            )));\n        }\n\n        if cpu \u003e limits.max_cpu_percentage as f64 {\n            return Err(SandboxError::ResourceLimitExceeded(format!(\n                \"CPU usage {:.1}% exceeds limit {}%\",\n                cpu, limits.max_cpu_percentage\n            )));\n        }\n\n        if disk \u003e limits.max_disk_space_mb as f64 {\n            return Err(SandboxError::ResourceLimitExceeded(format!(\n                \"Disk usage {:.1}MB exceeds limit {}MB\",\n                disk, limits.max_disk_space_mb\n            )));\n        }\n\n        if active_ops \u003e= limits.max_concurrent_operations {\n            return Err(SandboxError::ResourceLimitExceeded(format!(\n                \"Active operations {} exceeds limit {}\",\n                active_ops, limits.max_concurrent_operations\n            )));\n        }\n\n        // Check network requests (can now safely borrow \u0026mut self)\n        if request.operation == \"network_request\" {\n            self.check_network_rate_limit(agent_id, limits).await?;\n        }\n\n        // Check execution timeout for command operations\n        if matches!(\n            request.operation.as_str(),\n            \"execute_command\" | \"execute_workflow\"\n        ) {\n            if let Some(start_time) = execution_start {\n                let execution_duration = start_time.elapsed();\n                let max_duration =\n                    Duration::from_secs(limits.max_execution_time_minutes as u64 * 60);\n\n                if execution_duration \u003e max_duration {\n                    return Err(SandboxError::ResourceLimitExceeded(format!(\n                        \"Execution time {:?} exceeds limit {:?}\",\n                        execution_duration, max_duration\n                    )));\n                }\n            }\n        }\n\n        // Check file size limits\n        if let Some(file_size) = request.parameters.get(\"file_size_mb\") {\n            if let Some(size) = file_size.as_f64() {\n                if size \u003e limits.max_file_size_mb as f64 {\n                    return Err(SandboxError::ResourceLimitExceeded(format!(\n                        \"File size {:.1}MB exceeds limit {}MB\",\n                        size, limits.max_file_size_mb\n                    )));\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    async fn update_current_usage(\u0026mut self, agent_id: \u0026str) -\u003e SandboxResult\u003c()\u003e {\n        // Get current usage metrics first (these only borrow self immutably)\n        let memory_usage = self.get_memory_usage(agent_id).await?;\n        let cpu_usage = self.get_cpu_usage(agent_id).await?;\n        let disk_usage = self.get_disk_usage(agent_id).await?;\n\n        // Now update the usage map (this borrows self mutably)\n        let usage = self\n            .agent_usage\n            .entry(agent_id.to_string())\n            .or_insert_with(AgentResourceUsage::new);\n\n        usage.memory_mb = memory_usage;\n        usage.cpu_percentage = cpu_usage;\n        usage.disk_space_mb = disk_usage;\n\n        Ok(())\n    }\n\n    async fn get_memory_usage(\u0026self, _agent_id: \u0026str) -\u003e SandboxResult\u003cf64\u003e {\n        #[cfg(target_os = \"linux\")]\n        {\n            if let Ok(status) = std::fs::read_to_string(\"/proc/self/status\") {\n                for line in status.lines() {\n                    if line.starts_with(\"VmRSS:\") {\n                        if let Some(kb_str) = line.split_whitespace().nth(1) {\n                            if let Ok(kb) = kb_str.parse::\u003cf64\u003e() {\n                                return Ok(kb / 1024.0);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        Ok(0.0)\n    }\n\n    async fn get_cpu_usage(\u0026self, _agent_id: \u0026str) -\u003e SandboxResult\u003cf64\u003e {\n        Ok(0.0)\n    }\n\n    async fn get_disk_usage(\u0026self, _agent_id: \u0026str) -\u003e SandboxResult\u003cf64\u003e {\n        Ok(0.0)\n    }\n\n    async fn check_network_rate_limit(\n        \u0026mut self,\n        agent_id: \u0026str,\n        limits: \u0026ResourceLimits,\n    ) -\u003e SandboxResult\u003c()\u003e {\n        let usage = self\n            .agent_usage\n            .entry(agent_id.to_string())\n            .or_insert_with(AgentResourceUsage::new);\n\n        let now = Instant::now();\n        let window_duration = Duration::from_secs(60);\n\n        if now.duration_since(usage.network_requests_window_start) \u003e window_duration {\n            usage.network_requests_count = 0;\n            usage.network_requests_window_start = now;\n        }\n\n        if usage.network_requests_count \u003e= limits.max_network_requests_per_minute {\n            return Err(SandboxError::ResourceLimitExceeded(format!(\n                \"Network requests {} per minute exceeds limit {}\",\n                usage.network_requests_count, limits.max_network_requests_per_minute\n            )));\n        }\n\n        usage.network_requests_count += 1;\n        Ok(())\n    }\n\n    pub fn start_operation(\u0026mut self, agent_id: \u0026str, operation: \u0026str) {\n        let usage = self\n            .agent_usage\n            .entry(agent_id.to_string())\n            .or_insert_with(AgentResourceUsage::new);\n\n        usage.active_operations += 1;\n\n        if matches!(operation, \"execute_command\" | \"execute_workflow\") {\n            usage.execution_start = Some(Instant::now());\n        }\n    }\n\n    pub fn end_operation(\u0026mut self, agent_id: \u0026str, operation: \u0026str) {\n        if let Some(usage) = self.agent_usage.get_mut(agent_id) {\n            if usage.active_operations \u003e 0 {\n                usage.active_operations -= 1;\n            }\n\n            if matches!(operation, \"execute_command\" | \"execute_workflow\") {\n                usage.execution_start = None;\n            }\n        }\n    }\n\n    pub fn get_current_usage(\u0026self, agent_id: \u0026str) -\u003e Option\u003cResourceUsageSnapshot\u003e {\n        self.agent_usage\n            .get(agent_id)\n            .map(|usage| ResourceUsageSnapshot {\n                memory_mb: usage.memory_mb,\n                cpu_percentage: usage.cpu_percentage,\n                disk_space_mb: usage.disk_space_mb,\n                active_operations: usage.active_operations,\n                network_requests_this_minute: usage.network_requests_count,\n            })\n    }\n\n    pub fn clear_agent_data(\u0026mut self, agent_id: \u0026str) {\n        self.agent_usage.remove(agent_id);\n    }\n\n    pub fn get_all_agents(\u0026self) -\u003e Vec\u003cString\u003e {\n        self.agent_usage.keys().cloned().collect()\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct ResourceUsageSnapshot {\n    pub memory_mb: f64,\n    pub cpu_percentage: f64,\n    pub disk_space_mb: f64,\n    pub active_operations: u32,\n    pub network_requests_this_minute: u32,\n}\n\nimpl Default for ResourceMonitor {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n","traces":[{"line":24,"address":[17955840],"length":1,"stats":{"Line":0}},{"line":31,"address":[17885086],"length":1,"stats":{"Line":0}},{"line":38,"address":[24614256,24614387,24614393],"length":1,"stats":{"Line":0}},{"line":40,"address":[15572883],"length":1,"stats":{"Line":0}},{"line":41,"address":[24614284],"length":1,"stats":{"Line":0}},{"line":45,"address":[17732576],"length":1,"stats":{"Line":0}},{"line":52,"address":[23391348,23391487,23391409,23394163,23391609],"length":1,"stats":{"Line":0}},{"line":55,"address":[14007557],"length":1,"stats":{"Line":0}},{"line":56,"address":[23392059,23391942],"length":1,"stats":{"Line":0}},{"line":58,"address":[14007378],"length":1,"stats":{"Line":0}},{"line":59,"address":[16662672],"length":1,"stats":{"Line":0}},{"line":61,"address":[16733491],"length":1,"stats":{"Line":0}},{"line":62,"address":[16518616],"length":1,"stats":{"Line":0}},{"line":63,"address":[16721981],"length":1,"stats":{"Line":0}},{"line":64,"address":[14007498],"length":1,"stats":{"Line":0}},{"line":65,"address":[23852757],"length":1,"stats":{"Line":0}},{"line":69,"address":[16518781],"length":1,"stats":{"Line":0}},{"line":70,"address":[14007759,14009279],"length":1,"stats":{"Line":0}},{"line":76,"address":[16662958],"length":1,"stats":{"Line":0}},{"line":77,"address":[23393579,23392477],"length":1,"stats":{"Line":0}},{"line":83,"address":[16722313],"length":1,"stats":{"Line":0}},{"line":84,"address":[23392573,23393283],"length":1,"stats":{"Line":0}},{"line":90,"address":[16722451],"length":1,"stats":{"Line":0}},{"line":91,"address":[14008096,14008337],"length":1,"stats":{"Line":0}},{"line":98,"address":[14008059,14008165,14009888],"length":1,"stats":{"Line":0}},{"line":99,"address":[23775077],"length":1,"stats":{"Line":0}},{"line":103,"address":[16736028,16736051],"length":1,"stats":{"Line":0}},{"line":104,"address":[18094955,18096714],"length":1,"stats":{"Line":0}},{"line":107,"address":[16665348],"length":1,"stats":{"Line":0}},{"line":108,"address":[16724661],"length":1,"stats":{"Line":0}},{"line":109,"address":[16521361],"length":1,"stats":{"Line":0}},{"line":112,"address":[23394907],"length":1,"stats":{"Line":0}},{"line":113,"address":[16724863],"length":1,"stats":{"Line":0}},{"line":122,"address":[16665301,16665935],"length":1,"stats":{"Line":0}},{"line":123,"address":[23856006,23856056],"length":1,"stats":{"Line":0}},{"line":124,"address":[18097633],"length":1,"stats":{"Line":0}},{"line":125,"address":[16666167],"length":1,"stats":{"Line":0}},{"line":133,"address":[16666012],"length":1,"stats":{"Line":0}},{"line":136,"address":[14013006,14012867,14013026,14013693,14013162,14012991,14012832,14012954],"length":1,"stats":{"Line":0}},{"line":138,"address":[16668501,16668223,16668281,16668365,16668957],"length":1,"stats":{"Line":0}},{"line":139,"address":[23398859,23398165,23397640,23398388],"length":1,"stats":{"Line":0}},{"line":140,"address":[16740787,16739079,16740293,16740147],"length":1,"stats":{"Line":0}},{"line":143,"address":[18101505,18101397],"length":1,"stats":{"Line":0}},{"line":145,"address":[23859886],"length":1,"stats":{"Line":0}},{"line":146,"address":[14014541],"length":1,"stats":{"Line":0}},{"line":148,"address":[16740745],"length":1,"stats":{"Line":0}},{"line":149,"address":[16729235],"length":1,"stats":{"Line":0}},{"line":150,"address":[23860013],"length":1,"stats":{"Line":0}},{"line":152,"address":[16740770],"length":1,"stats":{"Line":0}},{"line":155,"address":[23857983,23856934,23857031,23857058,23858053,23856896],"length":1,"stats":{"Line":0}},{"line":158,"address":[16737849,16737755,16737926],"length":1,"stats":{"Line":0}},{"line":159,"address":[23857287,23857208],"length":1,"stats":{"Line":0}},{"line":160,"address":[23396915,23396799],"length":1,"stats":{"Line":0}},{"line":161,"address":[23857614],"length":1,"stats":{"Line":0}},{"line":162,"address":[16726978],"length":1,"stats":{"Line":0}},{"line":163,"address":[16523687],"length":1,"stats":{"Line":0}},{"line":171,"address":[16668008],"length":1,"stats":{"Line":0}},{"line":174,"address":[24613504,24613522],"length":1,"stats":{"Line":0}},{"line":175,"address":[23395961],"length":1,"stats":{"Line":0}},{"line":178,"address":[16737501,16737623,16737472],"length":1,"stats":{"Line":0}},{"line":179,"address":[17775721],"length":1,"stats":{"Line":0}},{"line":182,"address":[17884864],"length":1,"stats":{"Line":0}},{"line":187,"address":[16670307],"length":1,"stats":{"Line":0}},{"line":189,"address":[14014859,14014753],"length":1,"stats":{"Line":0}},{"line":190,"address":[16729526],"length":1,"stats":{"Line":0}},{"line":192,"address":[16526203],"length":1,"stats":{"Line":0}},{"line":193,"address":[23399708],"length":1,"stats":{"Line":0}},{"line":195,"address":[18101945,18102097],"length":1,"stats":{"Line":0}},{"line":196,"address":[14015117],"length":1,"stats":{"Line":0}},{"line":197,"address":[17779468],"length":1,"stats":{"Line":0}},{"line":200,"address":[23399862],"length":1,"stats":{"Line":0}},{"line":201,"address":[16526657,16526484],"length":1,"stats":{"Line":0}},{"line":207,"address":[23400014,23399997,23399912],"length":1,"stats":{"Line":0}},{"line":208,"address":[23400000],"length":1,"stats":{"Line":0}},{"line":211,"address":[25074352],"length":1,"stats":{"Line":0}},{"line":214,"address":[17955163],"length":1,"stats":{"Line":0}},{"line":215,"address":[17943675],"length":1,"stats":{"Line":0}},{"line":217,"address":[17733203,17733264],"length":1,"stats":{"Line":0}},{"line":219,"address":[17943737,17943783,17943849],"length":1,"stats":{"Line":0}},{"line":220,"address":[24613924],"length":1,"stats":{"Line":0}},{"line":224,"address":[19373136],"length":1,"stats":{"Line":0}},{"line":225,"address":[17883927],"length":1,"stats":{"Line":0}},{"line":226,"address":[24613405,24613325],"length":1,"stats":{"Line":0}},{"line":227,"address":[19373311,19373280],"length":1,"stats":{"Line":0}},{"line":230,"address":[17954854,17954772,17954911],"length":1,"stats":{"Line":0}},{"line":231,"address":[17943380],"length":1,"stats":{"Line":0}},{"line":236,"address":[17884704],"length":1,"stats":{"Line":0}},{"line":238,"address":[17884772],"length":1,"stats":{"Line":0}},{"line":239,"address":[14012797,14012768],"length":1,"stats":{"Line":0}},{"line":240,"address":[18099608],"length":1,"stats":{"Line":0}},{"line":241,"address":[17777005],"length":1,"stats":{"Line":0}},{"line":242,"address":[18099618],"length":1,"stats":{"Line":0}},{"line":243,"address":[23858103],"length":1,"stats":{"Line":0}},{"line":244,"address":[16523978],"length":1,"stats":{"Line":0}},{"line":248,"address":[17884608],"length":1,"stats":{"Line":0}},{"line":249,"address":[17884636],"length":1,"stats":{"Line":0}},{"line":252,"address":[15572176],"length":1,"stats":{"Line":0}},{"line":253,"address":[25074242],"length":1,"stats":{"Line":0}},{"line":267,"address":[17735136],"length":1,"stats":{"Line":0}},{"line":268,"address":[17735144],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":100},{"path":["/","home","shift","code","vincents-ai","engram","src","session.rs"],"content":"//! Session management for Engram\n//!\n//! Provides agent session lifecycle management with real-time analytics\n//! and productivity tracking using SPACE framework.\n\nuse crate::analytics::{DoraMetrics, SessionAnalytics, SpaceMetrics};\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\n\n/// Active session\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Session {\n    pub id: String,\n    pub agent_name: String,\n    pub start_time: DateTime\u003cUtc\u003e,\n    pub status: SessionStatus,\n    pub current_task: Option\u003cString\u003e,\n    pub context_stack: Vec\u003cString\u003e,\n    pub analytics: SessionAnalytics,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum SessionStatus {\n    Active,\n    Paused,\n    Completed,\n    Failed,\n}\n\nimpl Session {\n    pub fn new(agent_name: String) -\u003e Self {\n        let now = Utc::now();\n        let session_id = uuid::Uuid::new_v4().to_string();\n        Self {\n            id: session_id.clone(),\n            agent_name: agent_name.clone(),\n            start_time: now,\n            status: SessionStatus::Active,\n            current_task: None,\n            context_stack: vec![],\n            analytics: SessionAnalytics {\n                session_id,\n                agent_name,\n                start_time: now,\n                end_time: None,\n                space_metrics: SpaceMetrics {\n                    satisfaction_score: 8.0,\n                    performance_score: 7.0,\n                    activity_score: 8.0,\n                    communication_score: 5.0,\n                    efficiency_score: 8.0,\n                    overall_score: 7.5,\n                },\n                dora_metrics: DoraMetrics {\n                    deployment_frequency: 0,\n                    lead_time: 2.5,\n                    change_failure_rate: 0.0,\n                    mean_time_to_recover: 0.0,\n                },\n                tasks_completed: 0,\n                context_items_created: 0,\n                reasoning_steps_taken: 0,\n                knowledge_items_added: 0,\n            },\n        }\n    }\n\n    pub fn end_session(\u0026mut self) {\n        self.status = SessionStatus::Completed;\n        self.analytics.end_time = Some(Utc::now());\n    }\n\n    pub fn pause_session(\u0026mut self) {\n        self.status = SessionStatus::Paused;\n    }\n\n    pub fn resume_session(\u0026mut self) {\n        self.status = SessionStatus::Active;\n    }\n\n    pub fn update_task(\u0026mut self, task: String) {\n        self.current_task = Some(task);\n    }\n\n    pub fn add_context(\u0026mut self, context: String) {\n        self.context_stack.push(context);\n        self.analytics.context_items_created += 1;\n    }\n\n    pub fn complete_task(\u0026mut self) {\n        if self.current_task.is_some() {\n            self.analytics.tasks_completed += 1;\n            self.current_task = None;\n        }\n    }\n\n    pub fn add_reasoning_step(\u0026mut self) {\n        self.analytics.reasoning_steps_taken += 1;\n    }\n\n    pub fn add_knowledge_item(\u0026mut self) {\n        self.analytics.knowledge_items_added += 1;\n    }\n}\n","traces":[{"line":31,"address":[24261663,24261638,24260592],"length":1,"stats":{"Line":0}},{"line":32,"address":[24721285],"length":1,"stats":{"Line":0}},{"line":33,"address":[17590573],"length":1,"stats":{"Line":0}},{"line":35,"address":[17602130],"length":1,"stats":{"Line":0}},{"line":36,"address":[19020673],"length":1,"stats":{"Line":0}},{"line":40,"address":[18883545],"length":1,"stats":{"Line":0}},{"line":41,"address":[17531803],"length":1,"stats":{"Line":0}},{"line":68,"address":[24259936],"length":1,"stats":{"Line":0}},{"line":69,"address":[19019853],"length":1,"stats":{"Line":0}},{"line":70,"address":[24720628],"length":1,"stats":{"Line":0}},{"line":73,"address":[13983808],"length":1,"stats":{"Line":0}},{"line":74,"address":[17386981],"length":1,"stats":{"Line":0}},{"line":77,"address":[24721120],"length":1,"stats":{"Line":0}},{"line":78,"address":[17386997],"length":1,"stats":{"Line":0}},{"line":81,"address":[19019920,19020010],"length":1,"stats":{"Line":0}},{"line":82,"address":[17601561,17601454],"length":1,"stats":{"Line":0}},{"line":85,"address":[13983232],"length":1,"stats":{"Line":0}},{"line":86,"address":[17589773],"length":1,"stats":{"Line":0}},{"line":87,"address":[18882587,18882625],"length":1,"stats":{"Line":0}},{"line":90,"address":[17386898,17386736],"length":1,"stats":{"Line":0}},{"line":91,"address":[19020325,19020110],"length":1,"stats":{"Line":0}},{"line":92,"address":[19020204,19020137],"length":1,"stats":{"Line":0}},{"line":93,"address":[19020181,19020289,19020222],"length":1,"stats":{"Line":0}},{"line":97,"address":[18883232],"length":1,"stats":{"Line":0}},{"line":98,"address":[24721251,24721213],"length":1,"stats":{"Line":0}},{"line":101,"address":[19020368],"length":1,"stats":{"Line":0}},{"line":102,"address":[17387021,17387059],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":27},{"path":["/","home","shift","code","vincents-ai","engram","src","storage","git_refs_storage.rs"],"content":"//! Git refs-based storage implementation\n//!\n//! This implementation stores entities as Git objects referenced by Git refs,\n//! eliminating the need for a separate .engram directory structure.\n//! Entities are stored as Git blobs and referenced by refs in the format:\n//! refs/engram/{entity_type}/{entity_id}\n\nuse super::{\n    relationship_storage::{\n        EntityPath, RelationshipIndex, RelationshipStats, RelationshipStorage, TraversalAlgorithm,\n    },\n    GitCommit, MemoryEntity, QueryFilter, QueryResult, SortOrder, Storage, StorageStats,\n};\nuse crate::entities::{EntityRegistry, EntityRelationship, GenericEntity, RelationshipFilter};\nuse crate::error::{EngramError, StorageError};\nuse git2::Repository;\nuse serde_json::Value;\nuse std::collections::HashMap;\nuse std::path::PathBuf;\nuse std::sync::{Arc, Mutex};\n\n/// Git refs-based storage for entities\n///\n/// Stores entities as Git blobs with refs pointing to them in the format:\n/// refs/engram/{entity_type}/{entity_id}\n///\n/// This eliminates the need for .engram directory structure and provides\n/// better integration with Git tooling and distributed workflows.\npub struct GitRefsStorage {\n    repository: Arc\u003cMutex\u003cRepository\u003e\u003e,\n    workspace_path: PathBuf,\n    #[allow(dead_code)]\n    entity_registry: EntityRegistry,\n    current_agent: String,\n    relationship_index: Arc\u003cMutex\u003cRelationshipIndex\u003e\u003e,\n}\n\nimpl std::fmt::Debug for GitRefsStorage {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.debug_struct(\"GitRefsStorage\")\n            .field(\"workspace_path\", \u0026self.workspace_path)\n            .field(\"current_agent\", \u0026self.current_agent)\n            .finish()\n    }\n}\n\nimpl GitRefsStorage {\n    /// Create new Git refs storage instance\n    pub fn new(workspace_path: \u0026str, agent: \u0026str) -\u003e Result\u003cSelf, EngramError\u003e {\n        let workspace_path = PathBuf::from(workspace_path);\n\n        let repository = if !workspace_path.join(\".git\").exists() {\n            Repository::init(\u0026workspace_path).map_err(|e| EngramError::Git(e.to_string()))?\n        } else {\n            Repository::open(\u0026workspace_path).map_err(|e| EngramError::Git(e.to_string()))?\n        };\n\n        let mut registry = EntityRegistry::new();\n        registry.register::\u003ccrate::entities::Task\u003e();\n        registry.register::\u003ccrate::entities::Context\u003e();\n        registry.register::\u003ccrate::entities::Reasoning\u003e();\n        registry.register::\u003ccrate::entities::Knowledge\u003e();\n        registry.register::\u003ccrate::entities::Session\u003e();\n        registry.register::\u003ccrate::entities::Compliance\u003e();\n        registry.register::\u003ccrate::entities::EntityRelationship\u003e();\n\n        let mut storage = GitRefsStorage {\n            repository: Arc::new(Mutex::new(repository)),\n            workspace_path,\n            entity_registry: registry,\n            current_agent: agent.to_string(),\n            relationship_index: Arc::new(Mutex::new(RelationshipIndex::new())),\n        };\n\n        storage.rebuild_relationship_index()?;\n\n        Ok(storage)\n    }\n\n    /// Get ref name for an entity\n    fn get_entity_ref(\u0026self, entity_type: \u0026str, entity_id: \u0026str) -\u003e String {\n        format!(\"refs/engram/{}/{}\", entity_type, entity_id)\n    }\n\n    /// Store entity as Git blob and create ref\n    fn store_entity_as_ref(\u0026self, entity: \u0026GenericEntity) -\u003e Result\u003c(), EngramError\u003e {\n        let repo = self.repository.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\n                \"Repository lock failed\".to_string(),\n            ))\n        })?;\n\n        let data_map = match \u0026entity.data {\n            Value::Object(map) =\u003e map.iter().map(|(k, v)| (k.clone(), v.clone())).collect(),\n            _ =\u003e {\n                let mut map = HashMap::new();\n                map.insert(\"raw_data\".to_string(), entity.data.clone());\n                map\n            }\n        };\n\n        let memory_entity = MemoryEntity::new(\n            entity.id.clone(),\n            entity.entity_type.clone(),\n            entity.agent.clone(),\n            entity.timestamp,\n            data_map,\n        );\n\n        let json_content = serde_json::to_string_pretty(\u0026memory_entity)?;\n\n        let blob_oid = repo\n            .blob(json_content.as_bytes())\n            .map_err(|e| EngramError::Git(format!(\"Failed to create blob: {}\", e)))?;\n\n        let ref_name = self.get_entity_ref(\u0026entity.entity_type, \u0026entity.id);\n        repo.reference(\n            \u0026ref_name,\n            blob_oid,\n            true,\n            \u0026format!(\"Update {} {}\", entity.entity_type, entity.id),\n        )\n        .map_err(|e| EngramError::Git(format!(\"Failed to create ref: {}\", e)))?;\n\n        Ok(())\n    }\n\n    /// Load entity from Git ref\n    fn load_entity_from_ref(\n        \u0026self,\n        entity_type: \u0026str,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cOption\u003cGenericEntity\u003e, EngramError\u003e {\n        let ref_name = self.get_entity_ref(entity_type, entity_id);\n\n        let repo = self.repository.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\n                \"Repository lock failed\".to_string(),\n            ))\n        })?;\n\n        let result = match repo.find_reference(\u0026ref_name) {\n            Ok(reference) =\u003e {\n                let oid = reference.target().ok_or_else(|| {\n                    EngramError::Storage(StorageError::InvalidState(format!(\n                        \"Ref {} has no target\",\n                        ref_name\n                    )))\n                })?;\n\n                let blob = repo\n                    .find_blob(oid)\n                    .map_err(|e| EngramError::Git(format!(\"Failed to find blob {}: {}\", oid, e)))?;\n\n                let json_content = std::str::from_utf8(blob.content()).map_err(|e| {\n                    EngramError::Storage(StorageError::InvalidState(format!(\n                        \"Invalid UTF-8 in blob: {}\",\n                        e\n                    )))\n                })?;\n\n                let memory_entity: MemoryEntity = serde_json::from_str(json_content)\n                    .map_err(|e| EngramError::Deserialization(e.to_string()))?;\n\n                let generic_entity = GenericEntity {\n                    id: memory_entity.id,\n                    entity_type: memory_entity.entity_type,\n                    agent: memory_entity.agent,\n                    timestamp: memory_entity.timestamp,\n                    data: serde_json::Value::Object(\n                        memory_entity\n                            .data\n                            .into_iter()\n                            .map(|(k, v)| (k, v))\n                            .collect(),\n                    ),\n                };\n\n                Ok(Some(generic_entity))\n            }\n            Err(_) =\u003e Ok(None),\n        };\n        result\n    }\n\n    /// Delete entity ref\n    fn delete_entity_ref(\u0026self, entity_type: \u0026str, entity_id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        let ref_name = self.get_entity_ref(entity_type, entity_id);\n\n        let repo = self.repository.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\n                \"Repository lock failed\".to_string(),\n            ))\n        })?;\n\n        let result = match repo.find_reference(\u0026ref_name) {\n            Ok(mut reference) =\u003e {\n                reference\n                    .delete()\n                    .map_err(|e| EngramError::Git(format!(\"Failed to delete ref: {}\", e)))?;\n                Ok(())\n            }\n            Err(_) =\u003e Ok(()),\n        };\n        result\n    }\n\n    /// List all entity refs of a given type\n    fn list_entity_refs(\u0026self, entity_type: \u0026str) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        let repo = self.repository.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\n                \"Repository lock failed\".to_string(),\n            ))\n        })?;\n\n        let ref_prefix = format!(\"refs/engram/{}/\", entity_type);\n        let mut entity_ids = Vec::new();\n\n        // Iterate through all references\n        let refs = repo\n            .references()\n            .map_err(|e| EngramError::Git(format!(\"Failed to list references: {}\", e)))?;\n\n        for reference in refs {\n            let reference = reference\n                .map_err(|e| EngramError::Git(format!(\"Failed to read reference: {}\", e)))?;\n\n            if let Some(name) = reference.name() {\n                if name.starts_with(\u0026ref_prefix) {\n                    // Extract entity ID from ref name\n                    let entity_id = name.strip_prefix(\u0026ref_prefix).unwrap();\n                    entity_ids.push(entity_id.to_string());\n                }\n            }\n        }\n\n        Ok(entity_ids)\n    }\n\n    /// Rebuild relationship index from all stored entities\n    fn rebuild_relationship_index(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n        let mut index = self.relationship_index.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\"Index lock failed\".to_string()))\n        })?;\n        index.clear();\n\n        // Get all entity types and rebuild index\n        let entity_types = [\n            \"task\",\n            \"context\",\n            \"reasoning\",\n            \"knowledge\",\n            \"session\",\n            \"compliance\",\n            \"relationship\",\n        ];\n\n        for entity_type in \u0026entity_types {\n            let entity_ids = self.list_entity_refs(entity_type)?;\n\n            for entity_id in entity_ids {\n                if let Some(entity) = self.load_entity_from_ref(entity_type, \u0026entity_id)? {\n                    if *entity_type == \"relationship\" {\n                        // Special handling for relationship entities\n                        if let Ok(relationship) =\n                            serde_json::from_value::\u003cEntityRelationship\u003e(entity.data)\n                        {\n                            index.add_relationship(\u0026relationship);\n                        }\n                    }\n                }\n            }\n        }\n\n        Ok(())\n    }\n}\n\n// Storage trait implementation will be added next\nimpl Storage for GitRefsStorage {\n    fn store(\u0026mut self, entity: \u0026GenericEntity) -\u003e Result\u003c(), EngramError\u003e {\n        self.store_entity_as_ref(entity)?;\n\n        // Update relationship index if this is a relationship entity\n        if entity.entity_type == \"relationship\" {\n            if let Ok(relationship) =\n                serde_json::from_value::\u003cEntityRelationship\u003e(entity.data.clone())\n            {\n                let mut index = self.relationship_index.lock().map_err(|_| {\n                    EngramError::Storage(StorageError::InvalidState(\n                        \"Index lock failed\".to_string(),\n                    ))\n                })?;\n                index.add_relationship(\u0026relationship);\n            }\n        }\n\n        Ok(())\n    }\n\n    fn get(\u0026self, id: \u0026str, entity_type: \u0026str) -\u003e Result\u003cOption\u003cGenericEntity\u003e, EngramError\u003e {\n        self.load_entity_from_ref(entity_type, id)\n    }\n\n    fn delete(\u0026mut self, id: \u0026str, entity_type: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        // Remove from relationship index if it's a relationship\n        if entity_type == \"relationship\" {\n            if let Some(entity) = self.load_entity_from_ref(entity_type, id)? {\n                if let Ok(relationship) = serde_json::from_value::\u003cEntityRelationship\u003e(entity.data)\n                {\n                    let mut index = self.relationship_index.lock().map_err(|_| {\n                        EngramError::Storage(StorageError::InvalidState(\n                            \"Index lock failed\".to_string(),\n                        ))\n                    })?;\n                    index.remove_relationship(\u0026relationship);\n                }\n            }\n        }\n\n        self.delete_entity_ref(entity_type, id)\n    }\n\n    fn query(\u0026self, filter: \u0026QueryFilter) -\u003e Result\u003cQueryResult, EngramError\u003e {\n        let mut results = Vec::new();\n\n        // Determine which entity types to search\n        let entity_types = if let Some(entity_type) = \u0026filter.entity_type {\n            vec![entity_type.clone()]\n        } else {\n            vec![\n                \"task\".to_string(),\n                \"context\".to_string(),\n                \"reasoning\".to_string(),\n                \"knowledge\".to_string(),\n                \"session\".to_string(),\n                \"compliance\".to_string(),\n            ]\n        };\n\n        for entity_type in entity_types {\n            let entity_ids = self.list_entity_refs(\u0026entity_type)?;\n\n            for entity_id in entity_ids {\n                if let Some(entity) = self.load_entity_from_ref(\u0026entity_type, \u0026entity_id)? {\n                    // Apply filters\n                    if let Some(agent_filter) = \u0026filter.agent {\n                        if entity.agent != *agent_filter {\n                            continue;\n                        }\n                    }\n\n                    // Apply field filters\n                    let mut matches = true;\n                    for (field, value) in \u0026filter.field_filters {\n                        if let Some(entity_value) = entity.data.get(field) {\n                            if entity_value != value {\n                                matches = false;\n                                break;\n                            }\n                        } else {\n                            matches = false;\n                            break;\n                        }\n                    }\n\n                    if matches {\n                        results.push(entity);\n                    }\n                }\n            }\n        }\n\n        // Apply sorting\n        results.sort_by(|a, b| {\n            if let Some(sort_field) = \u0026filter.sort_by {\n                let a_val = a.data.get(sort_field);\n                let b_val = b.data.get(sort_field);\n                match filter.sort_order {\n                    SortOrder::Asc =\u003e match (a_val, b_val) {\n                        (Some(a), Some(b)) =\u003e a.to_string().cmp(\u0026b.to_string()),\n                        (Some(_), None) =\u003e std::cmp::Ordering::Greater,\n                        (None, Some(_)) =\u003e std::cmp::Ordering::Less,\n                        (None, None) =\u003e std::cmp::Ordering::Equal,\n                    },\n                    SortOrder::Desc =\u003e match (b_val, a_val) {\n                        (Some(a), Some(b)) =\u003e a.to_string().cmp(\u0026b.to_string()),\n                        (Some(_), None) =\u003e std::cmp::Ordering::Greater,\n                        (None, Some(_)) =\u003e std::cmp::Ordering::Less,\n                        (None, None) =\u003e std::cmp::Ordering::Equal,\n                    },\n                }\n            } else {\n                // Default sort by timestamp\n                match filter.sort_order {\n                    SortOrder::Asc =\u003e a.timestamp.cmp(\u0026b.timestamp),\n                    SortOrder::Desc =\u003e b.timestamp.cmp(\u0026a.timestamp),\n                }\n            }\n        });\n\n        // Apply pagination\n        let offset = filter.offset.unwrap_or(0);\n        let limit = filter.limit.unwrap_or(50);\n        let total = results.len();\n\n        let paginated_results = results.into_iter().skip(offset).take(limit).collect();\n\n        let has_more = offset + limit \u003c total;\n        Ok(QueryResult {\n            entities: paginated_results,\n            total_count: total,\n            has_more,\n        })\n    }\n\n    fn get_stats(\u0026self) -\u003e Result\u003cStorageStats, EngramError\u003e {\n        let mut stats = StorageStats::default();\n\n        let entity_types = [\n            \"task\",\n            \"context\",\n            \"reasoning\",\n            \"knowledge\",\n            \"session\",\n            \"compliance\",\n            \"relationship\",\n        ];\n\n        for entity_type in \u0026entity_types {\n            let entity_ids = self.list_entity_refs(entity_type)?;\n            let count = entity_ids.len();\n\n            stats.total_entities += count;\n            stats\n                .entities_by_type\n                .insert(entity_type.to_string(), count);\n        }\n\n        Ok(stats)\n    }\n\n    fn get_all(\u0026self, entity_type: \u0026str) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let entity_ids = self.list_entity_refs(entity_type)?;\n        let mut entities = Vec::new();\n\n        for entity_id in entity_ids {\n            if let Some(entity) = self.load_entity_from_ref(entity_type, \u0026entity_id)? {\n                entities.push(entity);\n            }\n        }\n\n        Ok(entities)\n    }\n\n    fn query_by_agent(\n        \u0026self,\n        agent: \u0026str,\n        entity_type: Option\u003c\u0026str\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let filter = QueryFilter {\n            entity_type: entity_type.map(String::from),\n            agent: Some(agent.to_string()),\n            ..Default::default()\n        };\n        self.query(\u0026filter).map(|result| result.entities)\n    }\n\n    fn query_by_time_range(\n        \u0026self,\n        start: chrono::DateTime\u003cchrono::Utc\u003e,\n        end: chrono::DateTime\u003cchrono::Utc\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let filter = QueryFilter::default();\n        let result = self.query(\u0026filter)?;\n\n        let filtered_entities = result\n            .entities\n            .into_iter()\n            .filter(|entity| entity.timestamp \u003e= start \u0026\u0026 entity.timestamp \u003c= end)\n            .collect();\n\n        Ok(filtered_entities)\n    }\n\n    fn query_by_type(\n        \u0026self,\n        entity_type: \u0026str,\n        filters: Option\u003c\u0026HashMap\u003cString, Value\u003e\u003e,\n        limit: Option\u003cusize\u003e,\n        offset: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cQueryResult, EngramError\u003e {\n        let mut filter = QueryFilter {\n            entity_type: Some(entity_type.to_string()),\n            limit,\n            offset,\n            ..Default::default()\n        };\n\n        if let Some(field_filters) = filters {\n            filter.field_filters = field_filters.clone();\n        }\n\n        self.query(\u0026filter)\n    }\n\n    fn text_search(\n        \u0026self,\n        query: \u0026str,\n        entity_types: Option\u003c\u0026[String]\u003e,\n        limit: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let mut results = Vec::new();\n        let query_lower = query.to_lowercase();\n\n        let default_types = [\n            \"task\".to_string(),\n            \"context\".to_string(),\n            \"reasoning\".to_string(),\n            \"knowledge\".to_string(),\n            \"session\".to_string(),\n            \"compliance\".to_string(),\n        ];\n        let search_types = entity_types.unwrap_or(\u0026default_types);\n\n        for entity_type in search_types {\n            let entities = self.get_all(entity_type)?;\n\n            for entity in entities {\n                let entity_json = serde_json::to_string(\u0026entity.data).unwrap_or_default();\n                if entity_json.to_lowercase().contains(\u0026query_lower) {\n                    results.push(entity);\n                }\n\n                if let Some(limit) = limit {\n                    if results.len() \u003e= limit {\n                        return Ok(results);\n                    }\n                }\n            }\n        }\n\n        Ok(results)\n    }\n\n    fn count(\u0026self, filter: \u0026QueryFilter) -\u003e Result\u003cusize, EngramError\u003e {\n        let result = self.query(filter)?;\n        Ok(result.total_count)\n    }\n\n    fn list_ids(\u0026self, entity_type: \u0026str) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        self.list_entity_refs(entity_type)\n    }\n\n    fn sync(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n        // For Git refs storage, sync could involve pushing/pulling refs\n        // This is a simplified implementation\n        Ok(())\n    }\n\n    fn current_branch(\u0026self) -\u003e Result\u003cString, EngramError\u003e {\n        let repo = self.repository.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\n                \"Repository lock failed\".to_string(),\n            ))\n        })?;\n\n        let head = repo\n            .head()\n            .map_err(|e| EngramError::Git(format!(\"Failed to get HEAD: {}\", e)))?;\n\n        if let Some(name) = head.shorthand() {\n            Ok(name.to_string())\n        } else {\n            Ok(\"HEAD\".to_string())\n        }\n    }\n\n    fn create_branch(\u0026mut self, branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        let repo = self.repository.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\n                \"Repository lock failed\".to_string(),\n            ))\n        })?;\n\n        let head_commit = repo\n            .head()\n            .map_err(|e| EngramError::Git(format!(\"Failed to get HEAD: {}\", e)))?\n            .peel_to_commit()\n            .map_err(|e| EngramError::Git(format!(\"Failed to get HEAD commit: {}\", e)))?;\n\n        repo.branch(branch_name, \u0026head_commit, false)\n            .map_err(|e| EngramError::Git(format!(\"Failed to create branch: {}\", e)))?;\n\n        Ok(())\n    }\n\n    fn switch_branch(\u0026mut self, branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        let repo = self.repository.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\n                \"Repository lock failed\".to_string(),\n            ))\n        })?;\n\n        let branch = repo\n            .find_branch(branch_name, git2::BranchType::Local)\n            .map_err(|e| EngramError::Git(format!(\"Failed to find branch: {}\", e)))?;\n\n        let branch_ref = branch.get();\n        repo.set_head(branch_ref.name().unwrap())\n            .map_err(|e| EngramError::Git(format!(\"Failed to switch branch: {}\", e)))?;\n\n        Ok(())\n    }\n\n    fn merge_branches(\u0026mut self, _source: \u0026str, _target: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        // Simplified merge implementation\n        // In a real implementation, this would handle merge conflicts, etc.\n        Err(EngramError::Git(\n            \"Branch merging not yet implemented for Git refs storage\".to_string(),\n        ))\n    }\n\n    fn history(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cVec\u003cGitCommit\u003e, EngramError\u003e {\n        let repo = self.repository.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\n                \"Repository lock failed\".to_string(),\n            ))\n        })?;\n\n        let mut revwalk = repo\n            .revwalk()\n            .map_err(|e| EngramError::Git(format!(\"Failed to create revwalk: {}\", e)))?;\n\n        revwalk\n            .push_head()\n            .map_err(|e| EngramError::Git(format!(\"Failed to push HEAD: {}\", e)))?;\n\n        let mut commits = Vec::new();\n        let max_commits = limit.unwrap_or(100);\n\n        for (i, oid_result) in revwalk.enumerate() {\n            if i \u003e= max_commits {\n                break;\n            }\n\n            let oid = oid_result\n                .map_err(|e| EngramError::Git(format!(\"Failed to get commit OID: {}\", e)))?;\n            let commit = repo\n                .find_commit(oid)\n                .map_err(|e| EngramError::Git(format!(\"Failed to find commit: {}\", e)))?;\n\n            let git_commit = GitCommit {\n                id: commit.id().to_string(),\n                author: commit.author().name().unwrap_or(\"Unknown\").to_string(),\n                message: commit.message().unwrap_or(\"\").to_string(),\n                timestamp: chrono::DateTime::from_timestamp(commit.time().seconds(), 0)\n                    .unwrap_or_else(chrono::Utc::now),\n                parents: commit.parent_ids().map(|id| id.to_string()).collect(),\n            };\n\n            commits.push(git_commit);\n        }\n\n        Ok(commits)\n    }\n\n    fn bulk_store(\u0026mut self, entities: \u0026[GenericEntity]) -\u003e Result\u003c(), EngramError\u003e {\n        for entity in entities {\n            self.store(entity)?;\n        }\n        Ok(())\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any {\n        self\n    }\n}\n\n// RelationshipStorage trait implementation\nimpl RelationshipStorage for GitRefsStorage {\n    fn store_relationship(\u0026mut self, relationship: \u0026EntityRelationship) -\u003e Result\u003c(), EngramError\u003e {\n        let generic_entity = GenericEntity {\n            id: relationship.id.clone(),\n            entity_type: \"relationship\".to_string(),\n            agent: relationship.agent.clone(),\n            timestamp: relationship.timestamp,\n            data: serde_json::to_value(relationship)?,\n        };\n\n        self.store(\u0026generic_entity)\n    }\n\n    fn get_relationship(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cEntityRelationship\u003e, EngramError\u003e {\n        if let Some(entity) = self.get(id, \"relationship\")? {\n            let relationship = serde_json::from_value(entity.data)\n                .map_err(|e| EngramError::Deserialization(e.to_string()))?;\n            Ok(Some(relationship))\n        } else {\n            Ok(None)\n        }\n    }\n\n    fn delete_relationship(\u0026mut self, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        self.delete(id, \"relationship\")\n    }\n\n    fn query_relationships(\n        \u0026self,\n        _filter: \u0026RelationshipFilter,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        Ok(Vec::new())\n    }\n\n    fn get_entity_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let index = self.relationship_index.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\"Index lock failed\".to_string()))\n        })?;\n\n        let rel_ids = index.get_all_relationships(entity_id);\n        drop(index);\n\n        let mut relationships = Vec::new();\n        for rel_id in rel_ids {\n            if let Some(rel) = self.get_relationship(\u0026rel_id)? {\n                relationships.push(rel);\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn get_outbound_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let index = self.relationship_index.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\"Index lock failed\".to_string()))\n        })?;\n\n        let rel_ids = index.get_outbound(entity_id);\n        drop(index);\n\n        let mut relationships = Vec::new();\n        for rel_id in rel_ids {\n            if let Some(rel) = self.get_relationship(\u0026rel_id)? {\n                relationships.push(rel);\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn get_inbound_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let index = self.relationship_index.lock().map_err(|_| {\n            EngramError::Storage(StorageError::InvalidState(\"Index lock failed\".to_string()))\n        })?;\n\n        let rel_ids = index.get_inbound(entity_id);\n        drop(index);\n\n        let mut relationships = Vec::new();\n        for rel_id in rel_ids {\n            if let Some(rel) = self.get_relationship(\u0026rel_id)? {\n                relationships.push(rel);\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn find_paths(\n        \u0026self,\n        _source_id: \u0026str,\n        _target_id: \u0026str,\n        _algorithm: TraversalAlgorithm,\n        _max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cEntityPath\u003e, EngramError\u003e {\n        Ok(Vec::new())\n    }\n\n    fn get_connected_entities(\n        \u0026self,\n        _entity_id: \u0026str,\n        _algorithm: TraversalAlgorithm,\n        _max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        Ok(Vec::new())\n    }\n\n    fn get_relationship_index(\u0026self) -\u003e Result\u003c\u0026RelationshipIndex, EngramError\u003e {\n        Err(EngramError::Storage(StorageError::InvalidState(\n            \"Direct relationship index access not supported in Git refs storage\".to_string(),\n        )))\n    }\n\n    fn rebuild_relationship_index(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n        self.rebuild_relationship_index()\n    }\n\n    fn get_relationship_stats(\u0026self) -\u003e Result\u003cRelationshipStats, EngramError\u003e {\n        Ok(RelationshipStats {\n            total_relationships: 0,\n            relationships_by_type: HashMap::new(),\n            bidirectional_count: 0,\n            average_connections_per_entity: 0.0,\n            most_connected_entity: None,\n            relationship_density: 0.0,\n        })\n    }\n}\n","traces":[{"line":39,"address":[27478288],"length":1,"stats":{"Line":0}},{"line":40,"address":[20347538],"length":1,"stats":{"Line":0}},{"line":41,"address":[20359085],"length":1,"stats":{"Line":0}},{"line":42,"address":[27478370],"length":1,"stats":{"Line":0}},{"line":49,"address":[20347484,20345504,20347365],"length":1,"stats":{"Line":3}},{"line":50,"address":[27015659],"length":1,"stats":{"Line":7}},{"line":52,"address":[20345687,20345619,20346339],"length":1,"stats":{"Line":10}},{"line":53,"address":[21797661,21797425],"length":1,"stats":{"Line":3}},{"line":55,"address":[21797690,21799021],"length":1,"stats":{"Line":0}},{"line":58,"address":[16575355],"length":1,"stats":{"Line":5}},{"line":59,"address":[27477153],"length":1,"stats":{"Line":6}},{"line":60,"address":[27016546],"length":1,"stats":{"Line":9}},{"line":61,"address":[27016565],"length":1,"stats":{"Line":9}},{"line":62,"address":[27016584],"length":1,"stats":{"Line":9}},{"line":63,"address":[21798075],"length":1,"stats":{"Line":9}},{"line":64,"address":[16575770],"length":1,"stats":{"Line":9}},{"line":65,"address":[20136049],"length":1,"stats":{"Line":9}},{"line":68,"address":[20136068],"length":1,"stats":{"Line":9}},{"line":71,"address":[21798301],"length":1,"stats":{"Line":9}},{"line":72,"address":[21798364,21798424],"length":1,"stats":{"Line":18}},{"line":75,"address":[27017209,27017158],"length":1,"stats":{"Line":11}},{"line":77,"address":[20287999],"length":1,"stats":{"Line":3}},{"line":81,"address":[27003152],"length":1,"stats":{"Line":1}},{"line":82,"address":[16562813],"length":1,"stats":{"Line":1}},{"line":86,"address":[20277088,20279830,20279971],"length":1,"stats":{"Line":4}},{"line":87,"address":[20347922,20348087],"length":1,"stats":{"Line":2}},{"line":88,"address":[18391647],"length":1,"stats":{"Line":0}},{"line":89,"address":[18403099],"length":1,"stats":{"Line":0}},{"line":93,"address":[16566252],"length":1,"stats":{"Line":4}},{"line":94,"address":[19569968,19570018],"length":1,"stats":{"Line":12}},{"line":96,"address":[16566320],"length":1,"stats":{"Line":0}},{"line":97,"address":[21788526,21790765,21788553,21788443],"length":1,"stats":{"Line":0}},{"line":98,"address":[20337101],"length":1,"stats":{"Line":0}},{"line":103,"address":[20277605,20277941],"length":1,"stats":{"Line":6}},{"line":104,"address":[27467965,27468034],"length":1,"stats":{"Line":6}},{"line":105,"address":[27468042],"length":1,"stats":{"Line":2}},{"line":106,"address":[27007439],"length":1,"stats":{"Line":4}},{"line":107,"address":[20348885],"length":1,"stats":{"Line":2}},{"line":110,"address":[20349103,20349032,20350625],"length":1,"stats":{"Line":8}},{"line":112,"address":[27469852,27468690,27468801,27468524],"length":1,"stats":{"Line":8}},{"line":113,"address":[21222747],"length":1,"stats":{"Line":3}},{"line":114,"address":[21789463,21789553],"length":1,"stats":{"Line":5}},{"line":116,"address":[20349620],"length":1,"stats":{"Line":2}},{"line":117,"address":[20350229,20349729,20350340,20350129],"length":1,"stats":{"Line":10}},{"line":118,"address":[27469053],"length":1,"stats":{"Line":3}},{"line":121,"address":[21223242],"length":1,"stats":{"Line":5}},{"line":123,"address":[20279524,20279292,20279434,20279625,20279773],"length":1,"stats":{"Line":8}},{"line":125,"address":[27469687],"length":1,"stats":{"Line":4}},{"line":129,"address":[21790800,21793754,21794393],"length":1,"stats":{"Line":1}},{"line":134,"address":[16568798],"length":1,"stats":{"Line":1}},{"line":136,"address":[20129065,20132324,20128911,20128845],"length":1,"stats":{"Line":2}},{"line":137,"address":[25523823],"length":1,"stats":{"Line":0}},{"line":138,"address":[19570379],"length":1,"stats":{"Line":0}},{"line":142,"address":[20339635,20339708],"length":1,"stats":{"Line":2}},{"line":143,"address":[20280591],"length":1,"stats":{"Line":1}},{"line":144,"address":[25063744],"length":1,"stats":{"Line":2}},{"line":145,"address":[18405193],"length":1,"stats":{"Line":0}},{"line":151,"address":[27470923,27471044,27473271,27471152],"length":1,"stats":{"Line":2}},{"line":152,"address":[16569674],"length":1,"stats":{"Line":1}},{"line":153,"address":[20280993,20281088],"length":1,"stats":{"Line":1}},{"line":155,"address":[21227394,21225586,21225432,21225349],"length":1,"stats":{"Line":2}},{"line":156,"address":[19822737],"length":1,"stats":{"Line":0}},{"line":162,"address":[20130285,20130239,20130402],"length":1,"stats":{"Line":4}},{"line":163,"address":[18333330,18333312],"length":1,"stats":{"Line":2}},{"line":166,"address":[27471797],"length":1,"stats":{"Line":2}},{"line":167,"address":[20341069],"length":1,"stats":{"Line":3}},{"line":168,"address":[20281861],"length":1,"stats":{"Line":2}},{"line":169,"address":[27011245],"length":1,"stats":{"Line":3}},{"line":170,"address":[21792928],"length":1,"stats":{"Line":2}},{"line":179,"address":[21793126],"length":1,"stats":{"Line":3}},{"line":181,"address":[20339790],"length":1,"stats":{"Line":1}},{"line":183,"address":[16572026],"length":1,"stats":{"Line":1}},{"line":187,"address":[16565752,16564800,16565920],"length":1,"stats":{"Line":1}},{"line":188,"address":[21220115],"length":1,"stats":{"Line":1}},{"line":190,"address":[27465981,27466047,27467071,27466189],"length":1,"stats":{"Line":2}},{"line":191,"address":[25521919],"length":1,"stats":{"Line":0}},{"line":192,"address":[25521851],"length":1,"stats":{"Line":0}},{"line":196,"address":[20335483,20335550],"length":1,"stats":{"Line":2}},{"line":197,"address":[20276401],"length":1,"stats":{"Line":1}},{"line":198,"address":[20276515,20276623],"length":1,"stats":{"Line":1}},{"line":200,"address":[27466591,27466504],"length":1,"stats":{"Line":1}},{"line":201,"address":[21787468],"length":1,"stats":{"Line":1}},{"line":203,"address":[20347152],"length":1,"stats":{"Line":1}},{"line":205,"address":[27466952],"length":1,"stats":{"Line":1}},{"line":209,"address":[16564670,16563024,16564783],"length":1,"stats":{"Line":9}},{"line":210,"address":[19821030,19821036,19820832],"length":1,"stats":{"Line":9}},{"line":211,"address":[19820927],"length":1,"stats":{"Line":0}},{"line":212,"address":[19568555],"length":1,"stats":{"Line":0}},{"line":216,"address":[21785213,21785142],"length":1,"stats":{"Line":18}},{"line":217,"address":[27464513],"length":1,"stats":{"Line":9}},{"line":220,"address":[20123536,20123428,20123312,20124582],"length":1,"stats":{"Line":16}},{"line":222,"address":[20123401,20123488],"length":1,"stats":{"Line":9}},{"line":224,"address":[20123751,20123675,20123597],"length":1,"stats":{"Line":12}},{"line":225,"address":[20345984,20346092],"length":1,"stats":{"Line":1}},{"line":226,"address":[25060384,25060406],"length":1,"stats":{"Line":1}},{"line":228,"address":[20124212,20124129],"length":1,"stats":{"Line":3}},{"line":229,"address":[20124301,20124350],"length":1,"stats":{"Line":4}},{"line":231,"address":[20346382],"length":1,"stats":{"Line":4}},{"line":232,"address":[27005049],"length":1,"stats":{"Line":2}},{"line":237,"address":[21785915],"length":1,"stats":{"Line":8}},{"line":241,"address":[21227760,21229968,21230399],"length":1,"stats":{"Line":9}},{"line":242,"address":[20342886,20343032],"length":1,"stats":{"Line":9}},{"line":243,"address":[25064011,25064079],"length":1,"stats":{"Line":0}},{"line":245,"address":[20343100,20343167],"length":1,"stats":{"Line":18}},{"line":248,"address":[27473946],"length":1,"stats":{"Line":9}},{"line":258,"address":[21795737,21794935],"length":1,"stats":{"Line":11}},{"line":259,"address":[20355094,20357005,20355036],"length":1,"stats":{"Line":11}},{"line":261,"address":[20343783,20344026,20343891],"length":1,"stats":{"Line":18}},{"line":262,"address":[20286033,20284852,20285003],"length":1,"stats":{"Line":0}},{"line":263,"address":[20134208,20134116],"length":1,"stats":{"Line":0}},{"line":265,"address":[27475500],"length":1,"stats":{"Line":0}},{"line":268,"address":[21796529,21796462],"length":1,"stats":{"Line":0}},{"line":275,"address":[21795111],"length":1,"stats":{"Line":8}},{"line":281,"address":[21813449,21812640,21813529],"length":1,"stats":{"Line":4}},{"line":282,"address":[21246027],"length":1,"stats":{"Line":2}},{"line":285,"address":[21246137],"length":1,"stats":{"Line":4}},{"line":286,"address":[16590017],"length":1,"stats":{"Line":1}},{"line":289,"address":[18400752,18400950,18400956],"length":1,"stats":{"Line":2}},{"line":290,"address":[18412367],"length":1,"stats":{"Line":0}},{"line":291,"address":[25531547],"length":1,"stats":{"Line":0}},{"line":294,"address":[21246683,21246612],"length":1,"stats":{"Line":2}},{"line":298,"address":[20302002],"length":1,"stats":{"Line":3}},{"line":301,"address":[27487232],"length":1,"stats":{"Line":1}},{"line":302,"address":[16585407],"length":1,"stats":{"Line":1}},{"line":305,"address":[20304166,20303943,20302784],"length":1,"stats":{"Line":1}},{"line":307,"address":[16590802],"length":1,"stats":{"Line":1}},{"line":308,"address":[20151679],"length":1,"stats":{"Line":0}},{"line":309,"address":[20374217,20374124,20374021],"length":1,"stats":{"Line":0}},{"line":311,"address":[25071270,25071072,25071276],"length":1,"stats":{"Line":0}},{"line":312,"address":[25071167],"length":1,"stats":{"Line":0}},{"line":313,"address":[18341755],"length":1,"stats":{"Line":0}},{"line":316,"address":[27033097,27033170],"length":1,"stats":{"Line":0}},{"line":321,"address":[20362140],"length":1,"stats":{"Line":1}},{"line":324,"address":[21241696,21245942,21242267],"length":1,"stats":{"Line":1}},{"line":325,"address":[20368359],"length":1,"stats":{"Line":3}},{"line":328,"address":[21241805],"length":1,"stats":{"Line":1}},{"line":329,"address":[21242273,21241879,21241979],"length":1,"stats":{"Line":2}},{"line":331,"address":[20298240,20298312,20298528,20298165,20298456,20298384,20298569,20297744,20301777,20298126],"length":1,"stats":{"Line":3}},{"line":332,"address":[21242294],"length":1,"stats":{"Line":1}},{"line":333,"address":[27488225],"length":1,"stats":{"Line":1}},{"line":334,"address":[20298281],"length":1,"stats":{"Line":1}},{"line":335,"address":[27488369],"length":1,"stats":{"Line":1}},{"line":336,"address":[16586544],"length":1,"stats":{"Line":1}},{"line":337,"address":[20357745],"length":1,"stats":{"Line":1}},{"line":341,"address":[20147740,20146797,20147605],"length":1,"stats":{"Line":3}},{"line":342,"address":[20299855,20299065,20301729],"length":1,"stats":{"Line":2}},{"line":344,"address":[16588372,16588141,16588245],"length":1,"stats":{"Line":7}},{"line":345,"address":[20300532,20300394,20301596],"length":1,"stats":{"Line":6}},{"line":347,"address":[20300846,20300920],"length":1,"stats":{"Line":2}},{"line":348,"address":[20371696,20371803],"length":1,"stats":{"Line":2}},{"line":354,"address":[20300959],"length":1,"stats":{"Line":2}},{"line":355,"address":[21811783,21811906],"length":1,"stats":{"Line":2}},{"line":356,"address":[20150031,20149986],"length":1,"stats":{"Line":2}},{"line":357,"address":[20301379,20301334],"length":1,"stats":{"Line":2}},{"line":358,"address":[27491404],"length":1,"stats":{"Line":1}},{"line":362,"address":[27030709],"length":1,"stats":{"Line":0}},{"line":363,"address":[20150125],"length":1,"stats":{"Line":0}},{"line":367,"address":[21812074],"length":1,"stats":{"Line":1}},{"line":368,"address":[27491436],"length":1,"stats":{"Line":1}},{"line":375,"address":[21243270],"length":1,"stats":{"Line":2}},{"line":376,"address":[19577182],"length":1,"stats":{"Line":1}},{"line":377,"address":[19577248],"length":1,"stats":{"Line":0}},{"line":378,"address":[18340561],"length":1,"stats":{"Line":0}},{"line":379,"address":[19899600],"length":1,"stats":{"Line":0}},{"line":380,"address":[19829976],"length":1,"stats":{"Line":0}},{"line":381,"address":[18400096,18400175],"length":1,"stats":{"Line":0}},{"line":382,"address":[19577627],"length":1,"stats":{"Line":0}},{"line":383,"address":[25530840],"length":1,"stats":{"Line":0}},{"line":384,"address":[18411599],"length":1,"stats":{"Line":0}},{"line":386,"address":[18411430,18411863],"length":1,"stats":{"Line":0}},{"line":387,"address":[19577966,19577886],"length":1,"stats":{"Line":0}},{"line":388,"address":[25070607],"length":1,"stats":{"Line":0}},{"line":389,"address":[25531178],"length":1,"stats":{"Line":0}},{"line":390,"address":[25070516],"length":1,"stats":{"Line":0}},{"line":395,"address":[19577339],"length":1,"stats":{"Line":1}},{"line":396,"address":[18341474],"length":1,"stats":{"Line":0}},{"line":397,"address":[18400689],"length":1,"stats":{"Line":1}},{"line":403,"address":[20299188],"length":1,"stats":{"Line":1}},{"line":404,"address":[20370005],"length":1,"stats":{"Line":1}},{"line":405,"address":[27489294],"length":1,"stats":{"Line":1}},{"line":407,"address":[21810131],"length":1,"stats":{"Line":1}},{"line":409,"address":[20370467,20370251],"length":1,"stats":{"Line":3}},{"line":410,"address":[16587666],"length":1,"stats":{"Line":3}},{"line":411,"address":[20358787],"length":1,"stats":{"Line":1}},{"line":417,"address":[27500118,27499184,27500096],"length":1,"stats":{"Line":1}},{"line":418,"address":[16596915],"length":1,"stats":{"Line":1}},{"line":420,"address":[20379976],"length":1,"stats":{"Line":1}},{"line":430,"address":[27499413,27499493],"length":1,"stats":{"Line":2}},{"line":431,"address":[21253747,21253828],"length":1,"stats":{"Line":2}},{"line":432,"address":[27499958,27499885],"length":1,"stats":{"Line":2}},{"line":434,"address":[27039294,27039353],"length":1,"stats":{"Line":1}},{"line":437,"address":[27039378,27039334],"length":1,"stats":{"Line":2}},{"line":440,"address":[20158361],"length":1,"stats":{"Line":1}},{"line":443,"address":[27033760,27035071,27035077],"length":1,"stats":{"Line":1}},{"line":444,"address":[21248632],"length":1,"stats":{"Line":1}},{"line":445,"address":[27494667],"length":1,"stats":{"Line":1}},{"line":447,"address":[20153463,20153700,20153565],"length":1,"stats":{"Line":3}},{"line":448,"address":[20364273,20364506],"length":1,"stats":{"Line":2}},{"line":449,"address":[16593476,16593505],"length":1,"stats":{"Line":2}},{"line":453,"address":[21249229],"length":1,"stats":{"Line":1}},{"line":456,"address":[20145257,20144512,20145263],"length":1,"stats":{"Line":0}},{"line":462,"address":[16584064],"length":1,"stats":{"Line":0}},{"line":463,"address":[21240114,21240051],"length":1,"stats":{"Line":0}},{"line":466,"address":[19899280,19899283],"length":1,"stats":{"Line":0}},{"line":469,"address":[27026535,27025872,27026508],"length":1,"stats":{"Line":0}},{"line":474,"address":[20355815],"length":1,"stats":{"Line":0}},{"line":475,"address":[21240824,21240764],"length":1,"stats":{"Line":0}},{"line":477,"address":[20296891],"length":1,"stats":{"Line":0}},{"line":480,"address":[18189056,18189093],"length":1,"stats":{"Line":0}},{"line":483,"address":[20297067],"length":1,"stats":{"Line":0}},{"line":486,"address":[20142462,20141648,20142456],"length":1,"stats":{"Line":0}},{"line":494,"address":[20293051],"length":1,"stats":{"Line":0}},{"line":500,"address":[20142427,20142235],"length":1,"stats":{"Line":0}},{"line":501,"address":[21804385,21804340,21804404],"length":1,"stats":{"Line":0}},{"line":504,"address":[21237713],"length":1,"stats":{"Line":0}},{"line":507,"address":[21232848,21235672,21235782],"length":1,"stats":{"Line":0}},{"line":513,"address":[20348068],"length":1,"stats":{"Line":0}},{"line":514,"address":[16577313],"length":1,"stats":{"Line":0}},{"line":516,"address":[27479406],"length":1,"stats":{"Line":0}},{"line":517,"address":[21233105],"length":1,"stats":{"Line":0}},{"line":518,"address":[21233177],"length":1,"stats":{"Line":0}},{"line":519,"address":[21233249],"length":1,"stats":{"Line":0}},{"line":520,"address":[20289161],"length":1,"stats":{"Line":0}},{"line":521,"address":[21233393],"length":1,"stats":{"Line":0}},{"line":522,"address":[21233465],"length":1,"stats":{"Line":0}},{"line":524,"address":[27479598,27479686],"length":1,"stats":{"Line":0}},{"line":526,"address":[21800502,21801517],"length":1,"stats":{"Line":0}},{"line":527,"address":[27479833,27480012,27481578],"length":1,"stats":{"Line":0}},{"line":529,"address":[21801286,21801043,21802304,21801151],"length":1,"stats":{"Line":0}},{"line":530,"address":[16579143,16579035],"length":1,"stats":{"Line":0}},{"line":531,"address":[20361550,20361618],"length":1,"stats":{"Line":0}},{"line":532,"address":[20361807],"length":1,"stats":{"Line":0}},{"line":535,"address":[21801832,21802023],"length":1,"stats":{"Line":0}},{"line":536,"address":[21235388,21235444],"length":1,"stats":{"Line":0}},{"line":537,"address":[16579661],"length":1,"stats":{"Line":0}},{"line":543,"address":[20138597],"length":1,"stats":{"Line":0}},{"line":546,"address":[21808128],"length":1,"stats":{"Line":0}},{"line":547,"address":[20146096],"length":1,"stats":{"Line":0}},{"line":548,"address":[21241650],"length":1,"stats":{"Line":0}},{"line":551,"address":[27038464],"length":1,"stats":{"Line":0}},{"line":552,"address":[20309147],"length":1,"stats":{"Line":0}},{"line":555,"address":[21808112],"length":1,"stats":{"Line":0}},{"line":558,"address":[20368072],"length":1,"stats":{"Line":0}},{"line":561,"address":[27484752,27485589,27485608],"length":1,"stats":{"Line":0}},{"line":562,"address":[19576768,19576961,19576967],"length":1,"stats":{"Line":0}},{"line":563,"address":[18399119],"length":1,"stats":{"Line":0}},{"line":564,"address":[25069147],"length":1,"stats":{"Line":0}},{"line":568,"address":[20365829,20365937,20365716],"length":1,"stats":{"Line":0}},{"line":570,"address":[18188752,18188774],"length":1,"stats":{"Line":0}},{"line":572,"address":[20295547,20295222,20295303],"length":1,"stats":{"Line":0}},{"line":573,"address":[20366205,20366150],"length":1,"stats":{"Line":0}},{"line":575,"address":[27485417,27485520],"length":1,"stats":{"Line":0}},{"line":579,"address":[20363650,20362432,20363623],"length":1,"stats":{"Line":0}},{"line":580,"address":[19827692,19827488,19827686],"length":1,"stats":{"Line":0}},{"line":581,"address":[19827583],"length":1,"stats":{"Line":0}},{"line":582,"address":[19897275],"length":1,"stats":{"Line":0}},{"line":586,"address":[20140767,20140654,20141026,20140875,20141134,20141632],"length":1,"stats":{"Line":0}},{"line":588,"address":[20351236,20351323],"length":1,"stats":{"Line":0}},{"line":590,"address":[27482350,27482451,27482219,27482877],"length":1,"stats":{"Line":0}},{"line":592,"address":[16580898,16580986,16580802],"length":1,"stats":{"Line":0}},{"line":593,"address":[18397216,18397238],"length":1,"stats":{"Line":0}},{"line":595,"address":[27022117],"length":1,"stats":{"Line":0}},{"line":598,"address":[16582937,16582000,16582945],"length":1,"stats":{"Line":0}},{"line":599,"address":[25529568,25529772,25529766],"length":1,"stats":{"Line":0}},{"line":600,"address":[19576123],"length":1,"stats":{"Line":0}},{"line":601,"address":[25529595],"length":1,"stats":{"Line":0}},{"line":605,"address":[20293975,20294101,20294209,20294714],"length":1,"stats":{"Line":0}},{"line":606,"address":[27023396],"length":1,"stats":{"Line":0}},{"line":607,"address":[18339280,18339302],"length":1,"stats":{"Line":0}},{"line":609,"address":[27484278,27484351],"length":1,"stats":{"Line":0}},{"line":610,"address":[21805303,21805159,21805411],"length":1,"stats":{"Line":0}},{"line":611,"address":[18187760,18187782],"length":1,"stats":{"Line":0}},{"line":613,"address":[20294626],"length":1,"stats":{"Line":0}},{"line":616,"address":[20144368],"length":1,"stats":{"Line":0}},{"line":619,"address":[16583873],"length":1,"stats":{"Line":0}},{"line":620,"address":[27485670],"length":1,"stats":{"Line":0}},{"line":624,"address":[20367999,20368345,20365024],"length":1,"stats":{"Line":0}},{"line":625,"address":[25072630,25072636,25072432],"length":1,"stats":{"Line":0}},{"line":626,"address":[18191935],"length":1,"stats":{"Line":0}},{"line":627,"address":[19832363],"length":1,"stats":{"Line":0}},{"line":631,"address":[20379863,20376846,20376971,20377082],"length":1,"stats":{"Line":0}},{"line":633,"address":[25532310,25532288],"length":1,"stats":{"Line":0}},{"line":635,"address":[21250741,21253185,21250630],"length":1,"stats":{"Line":0}},{"line":637,"address":[19579142,19579120],"length":1,"stats":{"Line":0}},{"line":639,"address":[21250770],"length":1,"stats":{"Line":0}},{"line":640,"address":[20306721,20306645],"length":1,"stats":{"Line":0}},{"line":642,"address":[20377497,20377668],"length":1,"stats":{"Line":0}},{"line":643,"address":[20155767],"length":1,"stats":{"Line":0}},{"line":647,"address":[16596541,16594931,16594841,16595022],"length":1,"stats":{"Line":0}},{"line":648,"address":[19901552,19901574],"length":1,"stats":{"Line":0}},{"line":649,"address":[20156171,20156058,20156282,20157531],"length":1,"stats":{"Line":0}},{"line":650,"address":[21818181],"length":1,"stats":{"Line":0}},{"line":651,"address":[18413584,18413606],"length":1,"stats":{"Line":0}},{"line":654,"address":[20366831,20366902],"length":1,"stats":{"Line":0}},{"line":655,"address":[20307759,20307859,20307681],"length":1,"stats":{"Line":0}},{"line":656,"address":[21818737,21818820],"length":1,"stats":{"Line":0}},{"line":657,"address":[20367309,20367380],"length":1,"stats":{"Line":0}},{"line":659,"address":[20378980],"length":1,"stats":{"Line":0}},{"line":662,"address":[16596258],"length":1,"stats":{"Line":0}},{"line":665,"address":[20379664],"length":1,"stats":{"Line":0}},{"line":668,"address":[20359168],"length":1,"stats":{"Line":0}},{"line":669,"address":[21232648,21232632],"length":1,"stats":{"Line":0}},{"line":670,"address":[20347798,20347877],"length":1,"stats":{"Line":0}},{"line":672,"address":[21799425],"length":1,"stats":{"Line":0}},{"line":675,"address":[20373536],"length":1,"stats":{"Line":0}},{"line":682,"address":[26997903,26997248,26997909],"length":1,"stats":{"Line":1}},{"line":684,"address":[27457969],"length":1,"stats":{"Line":1}},{"line":685,"address":[27457990],"length":1,"stats":{"Line":1}},{"line":686,"address":[16557221],"length":1,"stats":{"Line":1}},{"line":687,"address":[27458137],"length":1,"stats":{"Line":1}},{"line":688,"address":[26997553,26997493],"length":1,"stats":{"Line":2}},{"line":691,"address":[21779297],"length":1,"stats":{"Line":1}},{"line":694,"address":[26997036,26996112,26997042],"length":1,"stats":{"Line":1}},{"line":695,"address":[16555993,16556410],"length":1,"stats":{"Line":1}},{"line":696,"address":[26996653,26996761,26996483],"length":1,"stats":{"Line":2}},{"line":697,"address":[21211442,21211529],"length":1,"stats":{"Line":1}},{"line":698,"address":[27457533],"length":1,"stats":{"Line":1}},{"line":700,"address":[21211363],"length":1,"stats":{"Line":0}},{"line":704,"address":[20328016],"length":1,"stats":{"Line":0}},{"line":705,"address":[20328043],"length":1,"stats":{"Line":0}},{"line":708,"address":[21779648],"length":1,"stats":{"Line":0}},{"line":712,"address":[16558007],"length":1,"stats":{"Line":0}},{"line":715,"address":[20341627,20341599,20340224],"length":1,"stats":{"Line":0}},{"line":719,"address":[20328768,20328905],"length":1,"stats":{"Line":0}},{"line":720,"address":[18330431,18330363],"length":1,"stats":{"Line":0}},{"line":723,"address":[21213884,21213961],"length":1,"stats":{"Line":0}},{"line":724,"address":[16558967],"length":1,"stats":{"Line":0}},{"line":726,"address":[21780711],"length":1,"stats":{"Line":0}},{"line":727,"address":[27459930,27460041,27460176],"length":1,"stats":{"Line":0}},{"line":728,"address":[21781053,21781276],"length":1,"stats":{"Line":0}},{"line":729,"address":[27000054,27000095],"length":1,"stats":{"Line":0}},{"line":733,"address":[16559392],"length":1,"stats":{"Line":0}},{"line":736,"address":[20272336,20273711,20273739],"length":1,"stats":{"Line":0}},{"line":740,"address":[19889792,19889996,19889990],"length":1,"stats":{"Line":0}},{"line":741,"address":[18401647,18401579],"length":1,"stats":{"Line":0}},{"line":744,"address":[20331929,20331852],"length":1,"stats":{"Line":0}},{"line":745,"address":[27002052],"length":1,"stats":{"Line":0}},{"line":747,"address":[16561790],"length":1,"stats":{"Line":0}},{"line":748,"address":[16562027,16561797,16561900],"length":1,"stats":{"Line":0}},{"line":749,"address":[20273340,20273117],"length":1,"stats":{"Line":0}},{"line":750,"address":[20122342,20122383],"length":1,"stats":{"Line":0}},{"line":754,"address":[27463177],"length":1,"stats":{"Line":0}},{"line":757,"address":[20270896,20272271,20272299],"length":1,"stats":{"Line":0}},{"line":761,"address":[20341728,20341865],"length":1,"stats":{"Line":0}},{"line":762,"address":[19567563,19567627],"length":1,"stats":{"Line":0}},{"line":765,"address":[27461180,27461257],"length":1,"stats":{"Line":0}},{"line":766,"address":[21782084],"length":1,"stats":{"Line":0}},{"line":768,"address":[16560414],"length":1,"stats":{"Line":0}},{"line":769,"address":[20330602,20330713,20330848],"length":1,"stats":{"Line":0}},{"line":770,"address":[20271900,20271677],"length":1,"stats":{"Line":0}},{"line":771,"address":[20120943,20120902],"length":1,"stats":{"Line":0}},{"line":775,"address":[20342489],"length":1,"stats":{"Line":0}},{"line":778,"address":[16555776],"length":1,"stats":{"Line":0}},{"line":785,"address":[21210862],"length":1,"stats":{"Line":0}},{"line":788,"address":[20268928],"length":1,"stats":{"Line":0}},{"line":794,"address":[20328269],"length":1,"stats":{"Line":0}},{"line":797,"address":[20339856],"length":1,"stats":{"Line":0}},{"line":798,"address":[16558285],"length":1,"stats":{"Line":0}},{"line":799,"address":[20269106],"length":1,"stats":{"Line":0}},{"line":803,"address":[21784592],"length":1,"stats":{"Line":0}},{"line":804,"address":[27003137],"length":1,"stats":{"Line":0}},{"line":807,"address":[26998592],"length":1,"stats":{"Line":0}},{"line":808,"address":[27459320],"length":1,"stats":{"Line":0}},{"line":810,"address":[20328520],"length":1,"stats":{"Line":0}},{"line":813,"address":[20118038],"length":1,"stats":{"Line":0}}],"covered":165,"coverable":365},{"path":["/","home","shift","code","vincents-ai","engram","src","storage","git_storage.rs"],"content":"//! Git-based storage implementation\n\nuse super::{\n    GitCommit, MemoryEntity, QueryFilter, QueryResult, RelationshipIndex, RelationshipStats,\n    RelationshipStorage, SortOrder, Storage, StorageStats, TraversalAlgorithm,\n};\nuse crate::entities::{\n    Entity, EntityRegistry, EntityRelationship, GenericEntity, RelationshipDirection,\n    RelationshipFilter,\n};\nuse crate::error::EngramError;\nuse chrono::{DateTime, Utc};\nuse git2::{Oid, Repository, Signature};\nuse serde_json::Value;\nuse std::collections::{HashMap, HashSet, VecDeque};\nuse std::fs;\nuse std::path::{Path, PathBuf};\nuse std::sync::{Arc, Mutex};\n\npub struct GitStorage {\n    repository: Arc\u003cMutex\u003cRepository\u003e\u003e,\n    workspace_path: PathBuf,\n    engram_dir: PathBuf,\n    entity_registry: EntityRegistry,\n    current_agent: String,\n    relationship_index: Arc\u003cMutex\u003cRelationshipIndex\u003e\u003e,\n}\n\nimpl std::fmt::Debug for GitStorage {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        f.debug_struct(\"GitStorage\")\n            .field(\"workspace_path\", \u0026self.workspace_path)\n            .field(\"engram_dir\", \u0026self.engram_dir)\n            .field(\"current_agent\", \u0026self.current_agent)\n            .finish()\n    }\n}\n\nimpl GitStorage {\n    /// Create new Git storage instance\n    pub fn new(workspace_path: \u0026str, agent: \u0026str) -\u003e Result\u003cSelf, EngramError\u003e {\n        let workspace_path = PathBuf::from(workspace_path);\n        let engram_dir = workspace_path.join(\".engram\");\n\n        // Initialize repository if it doesn't exist\n        let repository = if !workspace_path.join(\".git\").exists() {\n            Repository::init(\u0026workspace_path).map_err(|e| EngramError::Git(e.to_string()))?\n        } else {\n            Repository::open(\u0026workspace_path).map_err(|e| EngramError::Git(e.to_string()))?\n        };\n\n        // Initialize engram directory\n        fs::create_dir_all(\u0026engram_dir).map_err(EngramError::Io)?;\n\n        // Initialize entity registry with all entity types\n        let mut registry = EntityRegistry::new();\n        registry.register::\u003ccrate::entities::Task\u003e();\n        registry.register::\u003ccrate::entities::Context\u003e();\n        registry.register::\u003ccrate::entities::Reasoning\u003e();\n        registry.register::\u003ccrate::entities::Knowledge\u003e();\n        registry.register::\u003ccrate::entities::Session\u003e();\n        registry.register::\u003ccrate::entities::Compliance\u003e();\n        registry.register::\u003ccrate::entities::EntityRelationship\u003e();\n\n        let mut storage = GitStorage {\n            repository: Arc::new(Mutex::new(repository)),\n            workspace_path,\n            engram_dir,\n            entity_registry: registry,\n            current_agent: agent.to_string(),\n            relationship_index: Arc::new(Mutex::new(RelationshipIndex::new())),\n        };\n\n        let _ = storage.rebuild_relationship_index();\n\n        Ok(storage)\n    }\n\n    /// Get file path for an entity\n    fn get_entity_path(\u0026self, entity_type: \u0026str, entity_id: \u0026str) -\u003e PathBuf {\n        let mut path = self.engram_dir.join(entity_type);\n        path.push(format!(\"{}.json\", entity_id));\n        path\n    }\n\n    /// Ensure type directory exists\n    fn ensure_type_directory(\u0026self, entity_type: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        let type_dir = self.engram_dir.join(entity_type);\n        fs::create_dir_all(\u0026type_dir).map_err(EngramError::Io)?;\n        Ok(())\n    }\n\n    /// Serialize entity to file\n    fn serialize_entity_to_file(\n        \u0026self,\n        entity: \u0026GenericEntity,\n        path: \u0026Path,\n    ) -\u003e Result\u003c(), EngramError\u003e {\n        let memory_entity = MemoryEntity::new(\n            entity.id.clone(),\n            entity.entity_type.clone(),\n            entity.agent.clone(),\n            entity.timestamp,\n            HashMap::from([(\"entity\".to_string(), entity.data.clone())]),\n        );\n\n        let json_content = memory_entity\n            .to_json()\n            .map_err(EngramError::Serialization)?;\n\n        fs::write(path, json_content).map_err(EngramError::Io)?;\n        Ok(())\n    }\n\n    /// Deserialize entity from file\n    fn deserialize_entity_from_file(\n        \u0026self,\n        path: \u0026Path,\n    ) -\u003e Result\u003cOption\u003cGenericEntity\u003e, EngramError\u003e {\n        let content = fs::read_to_string(path).map_err(EngramError::Io)?;\n        let memory_entity: MemoryEntity =\n            MemoryEntity::from_json(\u0026content).map_err(EngramError::Serialization)?;\n\n        if let Some(entity_data) = memory_entity.get_field(\"entity\") {\n            let generic = GenericEntity {\n                id: memory_entity.id.clone(),\n                entity_type: memory_entity.entity_type.clone(),\n                agent: memory_entity.agent.clone(),\n                timestamp: memory_entity.timestamp,\n                data: entity_data.clone(),\n            };\n\n            Ok(Some(generic))\n        } else {\n            Ok(None)\n        }\n    }\n\n    /// Add files to git index\n    fn add_to_index(\u0026self, paths: \u0026[\u0026Path]) -\u003e Result\u003c(), EngramError\u003e {\n        let repo = self\n            .repository\n            .lock()\n            .map_err(|e| EngramError::Git(format!(\"Failed to lock repository: {}\", e)))?;\n        let mut index = repo.index().map_err(|e| EngramError::Git(e.to_string()))?;\n\n        for path in paths {\n            let relative_path = path\n                .strip_prefix(\u0026self.workspace_path)\n                .map_err(|e| EngramError::Git(format!(\"Failed to make path relative: {}\", e)))?;\n\n            index\n                .add_path(relative_path)\n                .map_err(|e| EngramError::Git(e.to_string()))?;\n        }\n\n        index.write().map_err(|e| EngramError::Git(e.to_string()))?;\n\n        Ok(())\n    }\n\n    /// Create a commit\n    fn create_commit(\u0026self, message: \u0026str) -\u003e Result\u003cOid, EngramError\u003e {\n        let repo = self\n            .repository\n            .lock()\n            .map_err(|e| EngramError::Git(format!(\"Failed to lock repository: {}\", e)))?;\n        let mut index = repo.index().map_err(|e| EngramError::Git(e.to_string()))?;\n\n        let tree_id = index\n            .write_tree()\n            .map_err(|e| EngramError::Git(e.to_string()))?;\n        let tree = repo\n            .find_tree(tree_id)\n            .map_err(|e| EngramError::Git(e.to_string()))?;\n\n        // Get signature\n        let signature = self.signature()?;\n\n        // Get parent commit\n        let parent_commit = repo.head().and_then(|head| head.peel_to_commit()).ok();\n\n        let parents = if let Some(ref parent) = parent_commit {\n            vec![parent]\n        } else {\n            vec![]\n        };\n\n        repo.commit(\n            Some(\"HEAD\"),\n            \u0026signature,\n            \u0026signature,\n            message,\n            \u0026tree,\n            \u0026parents,\n        )\n        .map_err(|e| EngramError::Git(e.to_string()))\n    }\n\n    /// Get git signature for current agent\n    fn signature(\u0026self) -\u003e Result\u003cSignature\u003c'_\u003e, EngramError\u003e {\n        Signature::now(\n            \u0026self.current_agent,\n            \u0026format!(\"{}@engram.local\", self.current_agent),\n        )\n        .map_err(|e| EngramError::Git(e.to_string()))\n    }\n}\n\nimpl Storage for GitStorage {\n    fn store(\u0026mut self, entity: \u0026GenericEntity) -\u003e Result\u003c(), EngramError\u003e {\n        // Ensure type directory exists\n        self.ensure_type_directory(\u0026entity.entity_type)?;\n\n        // Serialize to file\n        let file_path = self.get_entity_path(\u0026entity.entity_type, \u0026entity.id);\n        self.serialize_entity_to_file(entity, \u0026file_path)?;\n\n        // Add to git and commit\n        self.add_to_index(\u0026[\u0026file_path])?;\n\n        let commit_message = format!(\n            \"Engram: Update {} {} by agent {}\",\n            entity.entity_type, entity.id, entity.agent\n        );\n\n        self.create_commit(\u0026commit_message)?;\n\n        Ok(())\n    }\n\n    fn get(\u0026self, id: \u0026str, entity_type: \u0026str) -\u003e Result\u003cOption\u003cGenericEntity\u003e, EngramError\u003e {\n        let file_path = self.get_entity_path(entity_type, id);\n\n        if !file_path.exists() {\n            return Ok(None);\n        }\n\n        self.deserialize_entity_from_file(\u0026file_path)\n    }\n\n    fn query_by_agent(\n        \u0026self,\n        agent: \u0026str,\n        entity_type: Option\u003c\u0026str\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let mut results = Vec::new();\n        let types_to_query = entity_type.map(|t| vec![t.to_string()]).unwrap_or_else(|| {\n            self.entity_registry\n                .list_types()\n                .into_iter()\n                .map(String::from)\n                .collect()\n        });\n\n        for entity_type in types_to_query {\n            let type_dir = self.engram_dir.join(\u0026entity_type);\n            if !type_dir.exists() {\n                continue;\n            }\n\n            let entries = fs::read_dir(type_dir).map_err(EngramError::Io)?;\n            for entry in entries {\n                let entry = entry.map_err(EngramError::Io)?;\n                let path = entry.path();\n\n                if let Some(entity) = self.deserialize_entity_from_file(\u0026path)? {\n                    if entity.agent == agent {\n                        results.push(entity);\n                    }\n                }\n            }\n        }\n\n        Ok(results)\n    }\n\n    fn query_by_time_range(\n        \u0026self,\n        start: DateTime\u003cUtc\u003e,\n        end: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let mut results = Vec::new();\n\n        for entity_type in self.entity_registry.list_types() {\n            let type_dir = self.engram_dir.join(entity_type);\n            if !type_dir.exists() {\n                continue;\n            }\n\n            let entries = fs::read_dir(type_dir).map_err(EngramError::Io)?;\n            for entry in entries {\n                let entry = entry.map_err(EngramError::Io)?;\n                let path = entry.path();\n\n                if let Some(entity) = self.deserialize_entity_from_file(\u0026path)? {\n                    if entity.timestamp \u003e= start \u0026\u0026 entity.timestamp \u003c= end {\n                        results.push(entity);\n                    }\n                }\n            }\n        }\n\n        Ok(results)\n    }\n\n    fn delete(\u0026mut self, id: \u0026str, entity_type: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        let file_path = self.get_entity_path(entity_type, id);\n\n        if !file_path.exists() {\n            return Err(EngramError::NotFound(format!(\n                \"Entity {} of type {} not found\",\n                id, entity_type\n            )));\n        }\n\n        // Remove file\n        fs::remove_file(\u0026file_path).map_err(EngramError::Io)?;\n\n        // Remove from git and commit\n        let repo = self\n            .repository\n            .lock()\n            .map_err(|e| EngramError::Git(format!(\"Failed to lock repository: {}\", e)))?;\n        let mut index = repo.index().map_err(|e| EngramError::Git(e.to_string()))?;\n\n        let relative_path = file_path\n            .strip_prefix(\u0026self.workspace_path)\n            .map_err(|e| EngramError::Git(format!(\"Failed to make path relative: {}\", e)))?;\n\n        index\n            .remove_path(relative_path)\n            .map_err(|e| EngramError::Git(e.to_string()))?;\n\n        index.write().map_err(|e| EngramError::Git(e.to_string()))?;\n\n        let commit_message = format!(\n            \"Engram: Delete {} {} by agent {}\",\n            entity_type, id, self.current_agent\n        );\n\n        self.create_commit(\u0026commit_message)?;\n\n        Ok(())\n    }\n\n    fn list_ids(\u0026self, entity_type: \u0026str) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        let type_dir = self.engram_dir.join(entity_type);\n\n        if !type_dir.exists() {\n            return Ok(Vec::new());\n        }\n\n        let mut ids = Vec::new();\n        let entries = fs::read_dir(type_dir).map_err(EngramError::Io)?;\n\n        for entry in entries {\n            let entry = entry.map_err(EngramError::Io)?;\n            let path = entry.path();\n\n            if path.extension().and_then(|s| s.to_str()) == Some(\"json\") {\n                if let Some(stem) = path.file_stem().and_then(|s| s.to_str()) {\n                    ids.push(stem.to_string());\n                }\n            }\n        }\n\n        Ok(ids)\n    }\n\n    fn sync(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n        Ok(())\n    }\n\n    fn current_branch(\u0026self) -\u003e Result\u003cString, EngramError\u003e {\n        Ok(\"main\".to_string())\n    }\n\n    fn create_branch(\u0026mut self, _branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        Ok(())\n    }\n\n    fn switch_branch(\u0026mut self, _branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        Ok(())\n    }\n\n    fn merge_branches(\u0026mut self, _source: \u0026str, _target: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        Ok(())\n    }\n\n    fn history(\u0026self, _limit: Option\u003cusize\u003e) -\u003e Result\u003cVec\u003cGitCommit\u003e, EngramError\u003e {\n        Ok(Vec::new())\n    }\n\n    fn query(\u0026self, filter: \u0026QueryFilter) -\u003e Result\u003cQueryResult, EngramError\u003e {\n        let mut all_entities = Vec::new();\n\n        let types_to_query: Vec\u003cString\u003e = if let Some(entity_type) = \u0026filter.entity_type {\n            vec![entity_type.clone()]\n        } else {\n            self.entity_registry\n                .list_types()\n                .into_iter()\n                .map(String::from)\n                .collect()\n        };\n\n        for entity_type in types_to_query {\n            let type_dir = self.engram_dir.join(\u0026entity_type);\n            if !type_dir.exists() {\n                continue;\n            }\n\n            let entries = fs::read_dir(type_dir).map_err(EngramError::Io)?;\n            for entry in entries {\n                let entry = entry.map_err(EngramError::Io)?;\n                let path = entry.path();\n\n                if let Some(entity) = self.deserialize_entity_from_file(\u0026path)? {\n                    if let Some(agent_filter) = \u0026filter.agent {\n                        if entity.agent != *agent_filter {\n                            continue;\n                        }\n                    }\n\n                    if let Some(time_range) = \u0026filter.time_range {\n                        if entity.timestamp \u003c time_range.start || entity.timestamp \u003e time_range.end\n                        {\n                            continue;\n                        }\n                    }\n\n                    if let Some(search_query) = \u0026filter.text_search {\n                        let search_lower: String = search_query.to_lowercase();\n                        let entity_json = serde_json::to_string(\u0026entity.data).unwrap_or_default();\n                        if !entity_json.to_lowercase().contains(\u0026search_lower) {\n                            continue;\n                        }\n                    }\n\n                    let mut matches_field_filters = true;\n                    for (field, expected_value) in \u0026filter.field_filters {\n                        if let Some(actual_value) = entity.data.get(field) {\n                            if actual_value != expected_value {\n                                matches_field_filters = false;\n                                break;\n                            }\n                        } else {\n                            matches_field_filters = false;\n                            break;\n                        }\n                    }\n\n                    if !matches_field_filters {\n                        continue;\n                    }\n\n                    all_entities.push(entity);\n                }\n            }\n        }\n\n        if let Some(sort_field) = \u0026filter.sort_by {\n            all_entities.sort_by(|a, b| {\n                let a_value = a.data.get(sort_field);\n                let b_value = b.data.get(sort_field);\n\n                let cmp = match (a_value, b_value) {\n                    (Some(a_val), Some(b_val)) =\u003e {\n                        let a_str = a_val.as_str().unwrap_or(\"\");\n                        let b_str = b_val.as_str().unwrap_or(\"\");\n                        a_str.cmp(b_str)\n                    }\n                    (Some(_), None) =\u003e std::cmp::Ordering::Greater,\n                    (None, Some(_)) =\u003e std::cmp::Ordering::Less,\n                    (None, None) =\u003e std::cmp::Ordering::Equal,\n                };\n\n                match filter.sort_order {\n                    SortOrder::Asc =\u003e cmp,\n                    SortOrder::Desc =\u003e cmp.reverse(),\n                }\n            });\n        } else {\n            all_entities.sort_by(|a, b| match filter.sort_order {\n                SortOrder::Asc =\u003e a.timestamp.cmp(\u0026b.timestamp),\n                SortOrder::Desc =\u003e b.timestamp.cmp(\u0026a.timestamp),\n            });\n        }\n\n        let total_count = all_entities.len();\n        let offset = filter.offset.unwrap_or(0);\n        let limit = filter.limit.unwrap_or(50);\n\n        let entities = if offset \u003c total_count {\n            let end_idx = std::cmp::min(offset + limit, total_count);\n            all_entities[offset..end_idx].to_vec()\n        } else {\n            Vec::new()\n        };\n\n        let has_more = offset + entities.len() \u003c total_count;\n\n        Ok(QueryResult {\n            entities,\n            total_count,\n            has_more,\n        })\n    }\n\n    fn query_by_type(\n        \u0026self,\n        entity_type: \u0026str,\n        filters: Option\u003c\u0026HashMap\u003cString, Value\u003e\u003e,\n        limit: Option\u003cusize\u003e,\n        offset: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cQueryResult, EngramError\u003e {\n        let mut filter = QueryFilter {\n            entity_type: Some(entity_type.to_string()),\n            limit,\n            offset,\n            ..Default::default()\n        };\n\n        if let Some(field_filters) = filters {\n            filter.field_filters = field_filters.clone();\n        }\n\n        self.query(\u0026filter)\n    }\n\n    fn text_search(\n        \u0026self,\n        query: \u0026str,\n        entity_types: Option\u003c\u0026[String]\u003e,\n        limit: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let mut filter = QueryFilter {\n            text_search: Some(query.to_string()),\n            limit,\n            ..Default::default()\n        };\n\n        if let Some(types) = entity_types {\n            if types.len() == 1 {\n                filter.entity_type = Some(types[0].clone());\n            }\n        }\n\n        let result = self.query(\u0026filter)?;\n        Ok(result.entities)\n    }\n\n    fn count(\u0026self, filter: \u0026QueryFilter) -\u003e Result\u003cusize, EngramError\u003e {\n        let count_filter = QueryFilter {\n            limit: None,\n            offset: None,\n            ..filter.clone()\n        };\n\n        let result = self.query(\u0026count_filter)?;\n        Ok(result.total_count)\n    }\n\n    fn get_all(\u0026self, entity_type: \u0026str) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let filter = QueryFilter {\n            entity_type: Some(entity_type.to_string()),\n            limit: None,\n            offset: None,\n            ..Default::default()\n        };\n\n        let result = self.query(\u0026filter)?;\n        Ok(result.entities)\n    }\n\n    fn bulk_store(\u0026mut self, entities: \u0026[GenericEntity]) -\u003e Result\u003c(), EngramError\u003e {\n        let mut all_paths = Vec::new();\n\n        for entity in entities {\n            self.ensure_type_directory(\u0026entity.entity_type)?;\n            let file_path = self.get_entity_path(\u0026entity.entity_type, \u0026entity.id);\n            self.serialize_entity_to_file(entity, \u0026file_path)?;\n            all_paths.push(file_path);\n        }\n\n        let path_refs: Vec\u003c\u0026Path\u003e = all_paths.iter().map(|p| p.as_path()).collect();\n        self.add_to_index(\u0026path_refs)?;\n\n        let commit_message = format!(\n            \"Engram: Bulk store {} entities by agent {}\",\n            entities.len(),\n            self.current_agent\n        );\n\n        self.create_commit(\u0026commit_message)?;\n\n        Ok(())\n    }\n\n    fn get_stats(\u0026self) -\u003e Result\u003cStorageStats, EngramError\u003e {\n        let mut total_entities = 0;\n        let mut entities_by_type = HashMap::new();\n        let mut entities_by_agent = HashMap::new();\n        let mut total_storage_size = 0u64;\n\n        for entity_type in self.entity_registry.list_types() {\n            let type_dir = self.engram_dir.join(entity_type);\n            if !type_dir.exists() {\n                entities_by_type.insert(entity_type.to_string(), 0);\n                continue;\n            }\n\n            let mut type_count = 0;\n            let entries = fs::read_dir(\u0026type_dir).map_err(EngramError::Io)?;\n\n            for entry in entries {\n                let entry = entry.map_err(EngramError::Io)?;\n                let path = entry.path();\n\n                if let Ok(metadata) = entry.metadata() {\n                    total_storage_size += metadata.len();\n                }\n\n                if let Some(entity) = self.deserialize_entity_from_file(\u0026path)? {\n                    total_entities += 1;\n                    type_count += 1;\n\n                    *entities_by_agent.entry(entity.agent.clone()).or_insert(0) += 1;\n                }\n            }\n\n            entities_by_type.insert(entity_type.to_string(), type_count);\n        }\n\n        Ok(StorageStats {\n            total_entities,\n            entities_by_type,\n            entities_by_agent,\n            total_storage_size,\n            last_sync: None,\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any {\n        self\n    }\n}\n\nimpl RelationshipStorage for GitStorage {\n    fn store_relationship(\u0026mut self, relationship: \u0026EntityRelationship) -\u003e Result\u003c(), EngramError\u003e {\n        let generic = GenericEntity {\n            id: relationship.id.clone(),\n            entity_type: EntityRelationship::entity_type().to_string(),\n            agent: relationship.agent.clone(),\n            timestamp: relationship.timestamp,\n            data: serde_json::to_value(relationship)?,\n        };\n\n        self.store(\u0026generic)?;\n\n        let mut index = self.relationship_index.lock().unwrap();\n        index.add_relationship(relationship);\n\n        Ok(())\n    }\n\n    fn get_relationship(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cEntityRelationship\u003e, EngramError\u003e {\n        if let Some(generic) = self.get(id, EntityRelationship::entity_type())? {\n            if let Ok(relationship) = serde_json::from_value::\u003cEntityRelationship\u003e(generic.data) {\n                return Ok(Some(relationship));\n            }\n        }\n        Ok(None)\n    }\n\n    fn query_relationships(\n        \u0026self,\n        filter: \u0026RelationshipFilter,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let all_rels = self.get_all(EntityRelationship::entity_type())?;\n        let mut relationships = Vec::new();\n\n        for generic in all_rels {\n            if let Ok(relationship) = serde_json::from_value::\u003cEntityRelationship\u003e(generic.data) {\n                if filter.matches(\u0026relationship) {\n                    relationships.push(relationship);\n                }\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn get_entity_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let index = self.relationship_index.lock().unwrap();\n        let rel_ids = index.get_all_relationships(entity_id);\n\n        let mut relationships = Vec::new();\n        for rel_id in rel_ids {\n            if let Some(relationship) = self.get_relationship(\u0026rel_id)? {\n                relationships.push(relationship);\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn get_outbound_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let index = self.relationship_index.lock().unwrap();\n        let rel_ids = index.get_outbound(entity_id);\n\n        let mut relationships = Vec::new();\n        for rel_id in rel_ids {\n            if let Some(relationship) = self.get_relationship(\u0026rel_id)? {\n                relationships.push(relationship);\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn get_inbound_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let index = self.relationship_index.lock().unwrap();\n        let rel_ids = index.get_inbound(entity_id);\n\n        let mut relationships = Vec::new();\n        for rel_id in rel_ids {\n            if let Some(relationship) = self.get_relationship(\u0026rel_id)? {\n                relationships.push(relationship);\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn find_paths(\n        \u0026self,\n        source_id: \u0026str,\n        target_id: \u0026str,\n        algorithm: TraversalAlgorithm,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003csuper::EntityPath\u003e, EngramError\u003e {\n        match algorithm {\n            TraversalAlgorithm::BreadthFirst =\u003e {\n                self.bfs_path_search(source_id, target_id, max_depth)\n            }\n            TraversalAlgorithm::DepthFirst =\u003e self.dfs_path_search(source_id, target_id, max_depth),\n            TraversalAlgorithm::Dijkstra =\u003e {\n                self.dijkstra_path_search(source_id, target_id, max_depth)\n            }\n        }\n    }\n\n    fn get_connected_entities(\n        \u0026self,\n        entity_id: \u0026str,\n        algorithm: TraversalAlgorithm,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        match algorithm {\n            TraversalAlgorithm::BreadthFirst =\u003e self.bfs_connected_search(entity_id, max_depth),\n            TraversalAlgorithm::DepthFirst =\u003e self.dfs_connected_search(entity_id, max_depth),\n            TraversalAlgorithm::Dijkstra =\u003e self.dijkstra_connected_search(entity_id, max_depth),\n        }\n    }\n\n    fn delete_relationship(\u0026mut self, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        if let Some(relationship) = self.get_relationship(id)? {\n            let mut index = self.relationship_index.lock().unwrap();\n            index.remove_relationship(\u0026relationship);\n        }\n\n        self.delete(id, EntityRelationship::entity_type())\n    }\n\n    fn get_relationship_index(\u0026self) -\u003e Result\u003c\u0026RelationshipIndex, EngramError\u003e {\n        Err(EngramError::Validation(\n            \"Direct index access not supported for GitStorage. Use query methods instead.\"\n                .to_string(),\n        ))\n    }\n\n    fn rebuild_relationship_index(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n        let all_rels = self.get_all(EntityRelationship::entity_type())?;\n        let mut index = self.relationship_index.lock().unwrap();\n\n        *index = RelationshipIndex::new();\n\n        for generic in all_rels {\n            if let Ok(relationship) = serde_json::from_value::\u003cEntityRelationship\u003e(generic.data) {\n                index.add_relationship(\u0026relationship);\n            }\n        }\n\n        Ok(())\n    }\n\n    fn get_relationship_stats(\u0026self) -\u003e Result\u003cRelationshipStats, EngramError\u003e {\n        use crate::entities::EntityRelationType;\n        use crate::storage::relationship_storage::RelationshipStats;\n        use std::collections::HashMap;\n\n        let all_rels = self.get_all(EntityRelationship::entity_type())?;\n        let mut total_relationships = 0;\n        let mut relationships_by_type: HashMap\u003cEntityRelationType, usize\u003e = HashMap::new();\n        let mut bidirectional_count = 0;\n        let mut entity_connections: HashMap\u003cString, usize\u003e = HashMap::new();\n\n        for generic in all_rels {\n            if let Ok(relationship) = serde_json::from_value::\u003cEntityRelationship\u003e(generic.data) {\n                total_relationships += 1;\n\n                *relationships_by_type\n                    .entry(relationship.relationship_type.clone())\n                    .or_insert(0) += 1;\n\n                if relationship.direction == RelationshipDirection::Bidirectional {\n                    bidirectional_count += 1;\n                }\n\n                *entity_connections\n                    .entry(relationship.source_id.clone())\n                    .or_insert(0) += 1;\n                *entity_connections\n                    .entry(relationship.target_id.clone())\n                    .or_insert(0) += 1;\n            }\n        }\n\n        let entity_count = entity_connections.len();\n        let average_connections_per_entity = if entity_count \u003e 0 {\n            entity_connections.values().sum::\u003cusize\u003e() as f64 / entity_count as f64\n        } else {\n            0.0\n        };\n\n        let most_connected_entity = entity_connections\n            .into_iter()\n            .max_by_key(|(_, count)| *count)\n            .map(|(entity, count)| (entity, count));\n\n        let max_possible_edges = if entity_count \u003e 1 {\n            entity_count * (entity_count - 1)\n        } else {\n            1\n        };\n        let relationship_density = total_relationships as f64 / max_possible_edges as f64;\n\n        Ok(RelationshipStats {\n            total_relationships,\n            relationships_by_type,\n            bidirectional_count,\n            average_connections_per_entity,\n            most_connected_entity,\n            relationship_density,\n        })\n    }\n}\n\nimpl GitStorage {\n    fn bfs_path_search(\n        \u0026self,\n        source_id: \u0026str,\n        target_id: \u0026str,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003csuper::EntityPath\u003e, EngramError\u003e {\n        let mut queue = VecDeque::new();\n        let mut visited = HashSet::new();\n        let max_depth = max_depth.unwrap_or(10);\n\n        queue.push_back((source_id.to_string(), Vec::new(), Vec::new(), 0));\n        visited.insert(source_id.to_string());\n\n        let mut paths = Vec::new();\n\n        while let Some((current_id, mut path_entities, path_relationships, depth)) =\n            queue.pop_front()\n        {\n            if depth \u003e= max_depth {\n                continue;\n            }\n\n            if current_id == target_id \u0026\u0026 !path_entities.is_empty() {\n                path_entities.push(current_id.clone());\n                paths.push(super::EntityPath {\n                    entities: path_entities.clone(),\n                    relationships: path_relationships.clone(),\n                    total_weight: path_relationships.len() as f64,\n                    path_type: super::PathType::Shortest,\n                });\n                continue;\n            }\n\n            let outbound_rels = self.get_outbound_relationships(\u0026current_id)?;\n            for relationship in outbound_rels {\n                let next_id = \u0026relationship.target_id;\n                if !visited.contains(next_id) {\n                    visited.insert(next_id.clone());\n                    let mut new_path_entities = path_entities.clone();\n                    new_path_entities.push(current_id.clone());\n                    let mut new_path_relationships = path_relationships.clone();\n                    new_path_relationships.push(relationship.id().to_string());\n                    queue.push_back((\n                        next_id.clone(),\n                        new_path_entities,\n                        new_path_relationships,\n                        depth + 1,\n                    ));\n                }\n            }\n        }\n\n        Ok(paths)\n    }\n\n    fn dfs_path_search(\n        \u0026self,\n        source_id: \u0026str,\n        target_id: \u0026str,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003csuper::EntityPath\u003e, EngramError\u003e {\n        let mut stack = Vec::new();\n        let mut visited = HashSet::new();\n        let max_depth = max_depth.unwrap_or(10);\n\n        stack.push((source_id.to_string(), Vec::new(), Vec::new(), 0));\n\n        let mut paths = Vec::new();\n\n        while let Some((current_id, mut path_entities, path_relationships, depth)) = stack.pop() {\n            if depth \u003e= max_depth {\n                continue;\n            }\n\n            if visited.contains(\u0026current_id) {\n                continue;\n            }\n            visited.insert(current_id.clone());\n\n            if current_id == target_id \u0026\u0026 !path_entities.is_empty() {\n                path_entities.push(current_id.clone());\n                paths.push(super::EntityPath {\n                    entities: path_entities.clone(),\n                    relationships: path_relationships.clone(),\n                    total_weight: path_relationships.len() as f64,\n                    path_type: super::PathType::AllPaths,\n                });\n                continue;\n            }\n\n            let outbound_rels = self.get_outbound_relationships(\u0026current_id)?;\n            for relationship in outbound_rels {\n                let next_id = \u0026relationship.target_id;\n                if !visited.contains(next_id) {\n                    let mut new_path_entities = path_entities.clone();\n                    new_path_entities.push(current_id.clone());\n                    let mut new_path_relationships = path_relationships.clone();\n                    new_path_relationships.push(relationship.id().to_string());\n                    stack.push((\n                        next_id.clone(),\n                        new_path_entities,\n                        new_path_relationships,\n                        depth + 1,\n                    ));\n                }\n            }\n        }\n\n        Ok(paths)\n    }\n\n    fn dijkstra_path_search(\n        \u0026self,\n        source_id: \u0026str,\n        target_id: \u0026str,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003csuper::EntityPath\u003e, EngramError\u003e {\n        use std::cmp::Reverse;\n        use std::collections::BinaryHeap;\n\n        #[derive(Debug, Clone, PartialEq)]\n        struct DijkstraState {\n            cost: i64,\n            entity_id: String,\n            path_entities: Vec\u003cString\u003e,\n            path_relationships: Vec\u003cString\u003e,\n        }\n\n        impl Eq for DijkstraState {}\n\n        impl Ord for DijkstraState {\n            fn cmp(\u0026self, other: \u0026Self) -\u003e std::cmp::Ordering {\n                self.cost.cmp(\u0026other.cost)\n            }\n        }\n\n        impl PartialOrd for DijkstraState {\n            fn partial_cmp(\u0026self, other: \u0026Self) -\u003e Option\u003cstd::cmp::Ordering\u003e {\n                Some(self.cmp(other))\n            }\n        }\n\n        let mut heap = BinaryHeap::new();\n        let mut distances: HashMap\u003cString, i64\u003e = HashMap::new();\n        let max_depth = max_depth.unwrap_or(10);\n\n        heap.push(Reverse(DijkstraState {\n            cost: 0,\n            entity_id: source_id.to_string(),\n            path_entities: Vec::new(),\n            path_relationships: Vec::new(),\n        }));\n\n        distances.insert(source_id.to_string(), 0);\n\n        let mut paths = Vec::new();\n\n        while let Some(Reverse(state)) = heap.pop() {\n            if state.path_entities.len() \u003e= max_depth {\n                continue;\n            }\n\n            if state.entity_id == target_id \u0026\u0026 !state.path_entities.is_empty() {\n                let mut final_entities = state.path_entities.clone();\n                final_entities.push(state.entity_id.clone());\n                paths.push(super::EntityPath {\n                    entities: final_entities,\n                    relationships: state.path_relationships.clone(),\n                    total_weight: state.cost as f64 / 1000.0,\n                    path_type: super::PathType::Shortest,\n                });\n                continue;\n            }\n\n            if let Some(\u0026best_distance) = distances.get(\u0026state.entity_id) {\n                if state.cost \u003e best_distance {\n                    continue;\n                }\n            }\n\n            let outbound_rels = self.get_outbound_relationships(\u0026state.entity_id)?;\n            for relationship in outbound_rels {\n                let next_id = \u0026relationship.target_id;\n                let edge_weight = ((1.0 - relationship.strength.weight()) * 1000.0) as i64;\n                let next_cost = state.cost + edge_weight;\n\n                if let Some(\u0026current_best) = distances.get(next_id) {\n                    if next_cost \u003e= current_best {\n                        continue;\n                    }\n                }\n\n                distances.insert(next_id.clone(), next_cost);\n\n                let mut new_path_entities = state.path_entities.clone();\n                new_path_entities.push(state.entity_id.clone());\n                let mut new_path_relationships = state.path_relationships.clone();\n                new_path_relationships.push(relationship.id.clone());\n\n                heap.push(Reverse(DijkstraState {\n                    cost: next_cost,\n                    entity_id: next_id.clone(),\n                    path_entities: new_path_entities,\n                    path_relationships: new_path_relationships,\n                }));\n            }\n        }\n\n        Ok(paths)\n    }\n\n    fn bfs_connected_search(\n        \u0026self,\n        entity_id: \u0026str,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        let mut queue = VecDeque::new();\n        let mut visited = HashSet::new();\n        let mut connected = Vec::new();\n        let max_depth = max_depth.unwrap_or(10);\n\n        queue.push_back((entity_id.to_string(), 0));\n        visited.insert(entity_id.to_string());\n\n        while let Some((current_id, depth)) = queue.pop_front() {\n            if depth \u003e= max_depth {\n                continue;\n            }\n\n            if depth \u003e 0 {\n                connected.push(current_id.clone());\n            }\n\n            let entity_rels = self.get_entity_relationships(\u0026current_id)?;\n            for relationship in entity_rels {\n                let next_id = if relationship.source_id == current_id {\n                    \u0026relationship.target_id\n                } else {\n                    \u0026relationship.source_id\n                };\n\n                if !visited.contains(next_id) {\n                    visited.insert(next_id.clone());\n                    queue.push_back((next_id.clone(), depth + 1));\n                }\n            }\n        }\n\n        Ok(connected)\n    }\n\n    fn dfs_connected_search(\n        \u0026self,\n        entity_id: \u0026str,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        let mut stack = Vec::new();\n        let mut visited = HashSet::new();\n        let mut connected = Vec::new();\n        let max_depth = max_depth.unwrap_or(10);\n\n        stack.push((entity_id.to_string(), 0));\n\n        while let Some((current_id, depth)) = stack.pop() {\n            if depth \u003e= max_depth {\n                continue;\n            }\n\n            if visited.contains(\u0026current_id) {\n                continue;\n            }\n            visited.insert(current_id.clone());\n\n            if depth \u003e 0 {\n                connected.push(current_id.clone());\n            }\n\n            let entity_rels = self.get_entity_relationships(\u0026current_id)?;\n            for relationship in entity_rels {\n                let next_id = if relationship.source_id == current_id {\n                    \u0026relationship.target_id\n                } else {\n                    \u0026relationship.source_id\n                };\n\n                if !visited.contains(next_id) {\n                    stack.push((next_id.clone(), depth + 1));\n                }\n            }\n        }\n\n        Ok(connected)\n    }\n\n    fn dijkstra_connected_search(\n        \u0026self,\n        entity_id: \u0026str,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        self.bfs_connected_search(entity_id, max_depth)\n    }\n}\n","traces":[{"line":30,"address":[18093472],"length":1,"stats":{"Line":0}},{"line":31,"address":[19742626],"length":1,"stats":{"Line":0}},{"line":32,"address":[19734013],"length":1,"stats":{"Line":0}},{"line":33,"address":[18093554],"length":1,"stats":{"Line":0}},{"line":34,"address":[18244838],"length":1,"stats":{"Line":0}},{"line":41,"address":[18242016,18244329,18244138],"length":1,"stats":{"Line":6}},{"line":42,"address":[17526395],"length":1,"stats":{"Line":6}},{"line":43,"address":[18312907,18312975],"length":1,"stats":{"Line":12}},{"line":46,"address":[18091738,18091072,18091004],"length":1,"stats":{"Line":14}},{"line":47,"address":[19731738,19731982],"length":1,"stats":{"Line":4}},{"line":49,"address":[15907584,15907602],"length":1,"stats":{"Line":2}},{"line":53,"address":[25432723,25433053],"length":1,"stats":{"Line":15}},{"line":56,"address":[19732441],"length":1,"stats":{"Line":8}},{"line":57,"address":[19732460],"length":1,"stats":{"Line":4}},{"line":58,"address":[17527548],"length":1,"stats":{"Line":6}},{"line":59,"address":[18092051],"length":1,"stats":{"Line":7}},{"line":60,"address":[18092070],"length":1,"stats":{"Line":4}},{"line":61,"address":[17527593],"length":1,"stats":{"Line":9}},{"line":62,"address":[19741244],"length":1,"stats":{"Line":4}},{"line":63,"address":[17527623],"length":1,"stats":{"Line":7}},{"line":66,"address":[18092146],"length":1,"stats":{"Line":6}},{"line":70,"address":[19732857],"length":1,"stats":{"Line":7}},{"line":71,"address":[18302920,18302980],"length":1,"stats":{"Line":13}},{"line":74,"address":[19733202,19733273],"length":1,"stats":{"Line":12}},{"line":76,"address":[25434060],"length":1,"stats":{"Line":9}},{"line":80,"address":[17515693,17515360,17515699],"length":1,"stats":{"Line":8}},{"line":81,"address":[24960072],"length":1,"stats":{"Line":9}},{"line":82,"address":[18230769,18230837],"length":1,"stats":{"Line":11}},{"line":83,"address":[18079711],"length":1,"stats":{"Line":5}},{"line":87,"address":[19736933,19736576,19736927],"length":1,"stats":{"Line":6}},{"line":88,"address":[19727998],"length":1,"stats":{"Line":5}},{"line":89,"address":[18087610,18087548],"length":1,"stats":{"Line":9}},{"line":90,"address":[18298243],"length":1,"stats":{"Line":7}},{"line":94,"address":[18239072,18240438,18240446],"length":1,"stats":{"Line":6}},{"line":100,"address":[17523576],"length":1,"stats":{"Line":5}},{"line":101,"address":[17523616,17523678],"length":1,"stats":{"Line":11}},{"line":102,"address":[18088038,18088104],"length":1,"stats":{"Line":11}},{"line":103,"address":[19737248],"length":1,"stats":{"Line":5}},{"line":104,"address":[18310150,18310224],"length":1,"stats":{"Line":9}},{"line":107,"address":[18299115,18299223,18299692],"length":1,"stats":{"Line":6}},{"line":109,"address":[17524240,17524303],"length":1,"stats":{"Line":4}},{"line":111,"address":[19738281,19737974,19738084],"length":1,"stats":{"Line":11}},{"line":112,"address":[19729602],"length":1,"stats":{"Line":4}},{"line":116,"address":[18241992,18240592,18241949],"length":1,"stats":{"Line":4}},{"line":120,"address":[19729907],"length":1,"stats":{"Line":3}},{"line":121,"address":[19730181,19730113],"length":1,"stats":{"Line":7}},{"line":124,"address":[18300657,18300530,18300453],"length":1,"stats":{"Line":7}},{"line":126,"address":[24970685],"length":1,"stats":{"Line":4}},{"line":127,"address":[25431430],"length":1,"stats":{"Line":3}},{"line":128,"address":[19730733],"length":1,"stats":{"Line":4}},{"line":129,"address":[25431573],"length":1,"stats":{"Line":3}},{"line":130,"address":[19730843],"length":1,"stats":{"Line":4}},{"line":133,"address":[18312649],"length":1,"stats":{"Line":3}},{"line":135,"address":[25431389],"length":1,"stats":{"Line":0}},{"line":140,"address":[24949328,24950753,24950761],"length":1,"stats":{"Line":4}},{"line":141,"address":[18279345,18279417,18279296],"length":1,"stats":{"Line":14}},{"line":144,"address":[18290909,18290843],"length":1,"stats":{"Line":4}},{"line":145,"address":[16158784,16158802],"length":1,"stats":{"Line":11}},{"line":147,"address":[25410606,25410531],"length":1,"stats":{"Line":10}},{"line":148,"address":[19709943,19710270,19710636,19710378],"length":1,"stats":{"Line":11}},{"line":149,"address":[24950046],"length":1,"stats":{"Line":7}},{"line":150,"address":[19582032,19582048],"length":1,"stats":{"Line":4}},{"line":152,"address":[18221357,18221245],"length":1,"stats":{"Line":4}},{"line":153,"address":[18280439],"length":1,"stats":{"Line":4}},{"line":154,"address":[16127936,16127954],"length":1,"stats":{"Line":7}},{"line":157,"address":[15906354,15906336],"length":1,"stats":{"Line":6}},{"line":159,"address":[17505926],"length":1,"stats":{"Line":4}},{"line":163,"address":[17508439,17508504,17506416],"length":1,"stats":{"Line":5}},{"line":164,"address":[19710767,19710900,19710816],"length":1,"stats":{"Line":10}},{"line":167,"address":[25411562,25411634],"length":1,"stats":{"Line":6}},{"line":168,"address":[18223625,18221723,18221796],"length":1,"stats":{"Line":10}},{"line":170,"address":[18070856,18070967,18072359],"length":1,"stats":{"Line":6}},{"line":172,"address":[19711325,19711415],"length":1,"stats":{"Line":5}},{"line":173,"address":[19721493,19720386,19720162,19720275],"length":1,"stats":{"Line":11}},{"line":174,"address":[24951677],"length":1,"stats":{"Line":7}},{"line":175,"address":[19711608,19711698],"length":1,"stats":{"Line":4}},{"line":178,"address":[18281815,18281866],"length":1,"stats":{"Line":8}},{"line":181,"address":[18222803,18222876],"length":1,"stats":{"Line":22}},{"line":183,"address":[18293745],"length":1,"stats":{"Line":7}},{"line":184,"address":[19720991,19720905],"length":1,"stats":{"Line":12}},{"line":186,"address":[18294002,18293800],"length":1,"stats":{"Line":11}},{"line":189,"address":[18293978,18294105],"length":1,"stats":{"Line":8}},{"line":195,"address":[19721168],"length":1,"stats":{"Line":7}},{"line":197,"address":[18072169],"length":1,"stats":{"Line":7}},{"line":201,"address":[24974049,24973712,24974043],"length":1,"stats":{"Line":4}},{"line":203,"address":[25434420],"length":1,"stats":{"Line":6}},{"line":204,"address":[17528625],"length":1,"stats":{"Line":4}},{"line":206,"address":[16058976,16058994],"length":1,"stats":{"Line":7}},{"line":211,"address":[17546291,17544976,17546281],"length":1,"stats":{"Line":6}},{"line":213,"address":[24990771],"length":1,"stats":{"Line":5}},{"line":216,"address":[24990914],"length":1,"stats":{"Line":9}},{"line":217,"address":[24990987,24992059,24991076],"length":1,"stats":{"Line":11}},{"line":220,"address":[19759772,19760601],"length":1,"stats":{"Line":7}},{"line":222,"address":[24991446],"length":1,"stats":{"Line":6}},{"line":227,"address":[19760331,19760249],"length":1,"stats":{"Line":11}},{"line":229,"address":[25452635],"length":1,"stats":{"Line":4}},{"line":232,"address":[17539190,17539184,17538864],"length":1,"stats":{"Line":0}},{"line":233,"address":[17538962],"length":1,"stats":{"Line":0}},{"line":235,"address":[18325900,18325968],"length":1,"stats":{"Line":0}},{"line":236,"address":[19753114],"length":1,"stats":{"Line":0}},{"line":239,"address":[19753162,19753212],"length":1,"stats":{"Line":0}},{"line":242,"address":[18311051,18308480,18311386],"length":1,"stats":{"Line":3}},{"line":247,"address":[19738552],"length":1,"stats":{"Line":3}},{"line":248,"address":[17533491,17533439],"length":1,"stats":{"Line":13}},{"line":249,"address":[23252291],"length":1,"stats":{"Line":0}},{"line":250,"address":[16133047],"length":1,"stats":{"Line":0}},{"line":251,"address":[23252306],"length":1,"stats":{"Line":0}},{"line":252,"address":[22791650],"length":1,"stats":{"Line":0}},{"line":253,"address":[16164087],"length":1,"stats":{"Line":0}},{"line":256,"address":[18320387,18320225],"length":1,"stats":{"Line":7}},{"line":257,"address":[18309147,18308941],"length":1,"stats":{"Line":7}},{"line":258,"address":[18320710,18320778],"length":1,"stats":{"Line":7}},{"line":262,"address":[18250147,18250050,18252076],"length":1,"stats":{"Line":7}},{"line":263,"address":[18099116,18099295,18099210],"length":1,"stats":{"Line":11}},{"line":264,"address":[19741265,19739853,19739937],"length":1,"stats":{"Line":7}},{"line":265,"address":[25440924],"length":1,"stats":{"Line":3}},{"line":267,"address":[17534984,17535065,17535704],"length":1,"stats":{"Line":10}},{"line":268,"address":[19740688,19740766],"length":1,"stats":{"Line":7}},{"line":269,"address":[18310791],"length":1,"stats":{"Line":4}},{"line":275,"address":[19738989],"length":1,"stats":{"Line":4}},{"line":278,"address":[19744251,19743935,19741408],"length":1,"stats":{"Line":0}},{"line":283,"address":[19741457],"length":1,"stats":{"Line":0}},{"line":285,"address":[17536439,17536265,17536206,17537428],"length":1,"stats":{"Line":0}},{"line":286,"address":[17536536,17536714],"length":1,"stats":{"Line":0}},{"line":287,"address":[18323577,18323645],"length":1,"stats":{"Line":0}},{"line":291,"address":[17536857,17536949,17538804],"length":1,"stats":{"Line":0}},{"line":292,"address":[18101969,18102148,18102063],"length":1,"stats":{"Line":0}},{"line":293,"address":[17537390,17537449,17538749],"length":1,"stats":{"Line":0}},{"line":294,"address":[17537647],"length":1,"stats":{"Line":0}},{"line":296,"address":[18324594,18325371,18324678],"length":1,"stats":{"Line":0}},{"line":297,"address":[19752162,19752252,19752282],"length":1,"stats":{"Line":0}},{"line":298,"address":[18254427],"length":1,"stats":{"Line":0}},{"line":304,"address":[17536587],"length":1,"stats":{"Line":0}},{"line":307,"address":[19760640,19763213,19763259],"length":1,"stats":{"Line":0}},{"line":308,"address":[19752062],"length":1,"stats":{"Line":0}},{"line":310,"address":[17546437,17546508],"length":1,"stats":{"Line":0}},{"line":311,"address":[18322287,18322217],"length":1,"stats":{"Line":0}},{"line":318,"address":[19752260,19754614,19752537],"length":1,"stats":{"Line":0}},{"line":321,"address":[25453537,25455377,25453645,25453466],"length":1,"stats":{"Line":0}},{"line":324,"address":[24992838,24992925],"length":1,"stats":{"Line":0}},{"line":325,"address":[18263776,18265359,18263703],"length":1,"stats":{"Line":0}},{"line":327,"address":[24993461,24994679,24993335,24993569],"length":1,"stats":{"Line":0}},{"line":328,"address":[18323315],"length":1,"stats":{"Line":0}},{"line":329,"address":[16063536,16063520],"length":1,"stats":{"Line":0}},{"line":331,"address":[19762336,19763221,19762228],"length":1,"stats":{"Line":0}},{"line":332,"address":[25454302],"length":1,"stats":{"Line":0}},{"line":333,"address":[16134144,16134162],"length":1,"stats":{"Line":0}},{"line":335,"address":[17547961,17548791],"length":1,"stats":{"Line":0}},{"line":337,"address":[24994017],"length":1,"stats":{"Line":0}},{"line":342,"address":[18335706,18335788],"length":1,"stats":{"Line":0}},{"line":344,"address":[17548660],"length":1,"stats":{"Line":0}},{"line":347,"address":[18337072,18338968,18339076],"length":1,"stats":{"Line":2}},{"line":348,"address":[18325634],"length":1,"stats":{"Line":1}},{"line":350,"address":[18325799,18325719],"length":1,"stats":{"Line":3}},{"line":351,"address":[19764512,19764466],"length":1,"stats":{"Line":3}},{"line":354,"address":[17550021],"length":1,"stats":{"Line":0}},{"line":355,"address":[24996030,24996141,24997621],"length":1,"stats":{"Line":0}},{"line":357,"address":[25457212,25457033,25457127],"length":1,"stats":{"Line":0}},{"line":358,"address":[17550846,17550674],"length":1,"stats":{"Line":0}},{"line":359,"address":[17551044],"length":1,"stats":{"Line":0}},{"line":361,"address":[16134656,16134670],"length":1,"stats":{"Line":0}},{"line":362,"address":[18267955],"length":1,"stats":{"Line":0}},{"line":363,"address":[24997471],"length":1,"stats":{"Line":0}},{"line":368,"address":[25457331],"length":1,"stats":{"Line":0}},{"line":371,"address":[17539216],"length":1,"stats":{"Line":0}},{"line":372,"address":[18255384],"length":1,"stats":{"Line":0}},{"line":375,"address":[18308336],"length":1,"stats":{"Line":0}},{"line":376,"address":[18097859],"length":1,"stats":{"Line":0}},{"line":379,"address":[24977536],"length":1,"stats":{"Line":0}},{"line":380,"address":[18318978],"length":1,"stats":{"Line":0}},{"line":383,"address":[19746944],"length":1,"stats":{"Line":0}},{"line":384,"address":[17533154],"length":1,"stats":{"Line":0}},{"line":387,"address":[18308432],"length":1,"stats":{"Line":0}},{"line":388,"address":[19738460],"length":1,"stats":{"Line":0}},{"line":391,"address":[24995552],"length":1,"stats":{"Line":0}},{"line":392,"address":[17549661],"length":1,"stats":{"Line":0}},{"line":395,"address":[25451377,25446096,25446665],"length":1,"stats":{"Line":4}},{"line":396,"address":[25446151],"length":1,"stats":{"Line":8}},{"line":398,"address":[19754069],"length":1,"stats":{"Line":5}},{"line":399,"address":[25446380,25446271,25446671],"length":1,"stats":{"Line":13}},{"line":401,"address":[18327046,18327509],"length":1,"stats":{"Line":0}},{"line":404,"address":[19745935],"length":1,"stats":{"Line":0}},{"line":408,"address":[25446762,25446897,25446606],"length":1,"stats":{"Line":17}},{"line":409,"address":[18316206,18317290],"length":1,"stats":{"Line":13}},{"line":410,"address":[25448101,25448181],"length":1,"stats":{"Line":13}},{"line":414,"address":[17542050,17541941,17544898],"length":1,"stats":{"Line":0}},{"line":415,"address":[18329296,18329402,18329487],"length":1,"stats":{"Line":0}},{"line":416,"address":[18332008,18329549,18329633],"length":1,"stats":{"Line":0}},{"line":417,"address":[18329855],"length":1,"stats":{"Line":0}},{"line":419,"address":[25451065,25449278,25449182],"length":1,"stats":{"Line":0}},{"line":420,"address":[17543201,17543281],"length":1,"stats":{"Line":0}},{"line":421,"address":[18330497,18330379],"length":1,"stats":{"Line":0}},{"line":426,"address":[24989106,24988986],"length":1,"stats":{"Line":0}},{"line":427,"address":[18330620,18330538],"length":1,"stats":{"Line":0}},{"line":433,"address":[18330677,18330569],"length":1,"stats":{"Line":0}},{"line":434,"address":[18330754,18330685],"length":1,"stats":{"Line":0}},{"line":435,"address":[25450092,25450021],"length":1,"stats":{"Line":0}},{"line":436,"address":[18260179,18260111],"length":1,"stats":{"Line":0}},{"line":441,"address":[24989286],"length":1,"stats":{"Line":0}},{"line":442,"address":[18108702,18109179],"length":1,"stats":{"Line":0}},{"line":443,"address":[18319819,18319867],"length":1,"stats":{"Line":0}},{"line":444,"address":[18331442,18331487],"length":1,"stats":{"Line":0}},{"line":445,"address":[17544366],"length":1,"stats":{"Line":0}},{"line":449,"address":[25450721],"length":1,"stats":{"Line":0}},{"line":450,"address":[19758601],"length":1,"stats":{"Line":0}},{"line":454,"address":[19758483],"length":1,"stats":{"Line":0}},{"line":458,"address":[18109493],"length":1,"stats":{"Line":0}},{"line":463,"address":[24986359],"length":1,"stats":{"Line":9}},{"line":464,"address":[18327847,18327941],"length":1,"stats":{"Line":0}},{"line":465,"address":[17377981],"length":1,"stats":{"Line":0}},{"line":466,"address":[22791780],"length":1,"stats":{"Line":0}},{"line":468,"address":[17104545],"length":1,"stats":{"Line":0}},{"line":469,"address":[15911365],"length":1,"stats":{"Line":0}},{"line":470,"address":[16133412],"length":1,"stats":{"Line":0}},{"line":471,"address":[22792046],"length":1,"stats":{"Line":0}},{"line":472,"address":[19587614],"length":1,"stats":{"Line":0}},{"line":474,"address":[17104862],"length":1,"stats":{"Line":0}},{"line":475,"address":[23252580],"length":1,"stats":{"Line":0}},{"line":476,"address":[22791915],"length":1,"stats":{"Line":0}},{"line":479,"address":[15911333],"length":1,"stats":{"Line":0}},{"line":480,"address":[16133576],"length":1,"stats":{"Line":0}},{"line":481,"address":[17104872],"length":1,"stats":{"Line":0}},{"line":485,"address":[16164621,16164592],"length":1,"stats":{"Line":13}},{"line":486,"address":[16133691],"length":1,"stats":{"Line":0}},{"line":487,"address":[19587741],"length":1,"stats":{"Line":0}},{"line":491,"address":[24986538,24986618],"length":1,"stats":{"Line":13}},{"line":492,"address":[19746530],"length":1,"stats":{"Line":5}},{"line":493,"address":[18257337],"length":1,"stats":{"Line":8}},{"line":495,"address":[19755288],"length":1,"stats":{"Line":5}},{"line":496,"address":[18257440,18257509],"length":1,"stats":{"Line":0}},{"line":497,"address":[19755460],"length":1,"stats":{"Line":0}},{"line":499,"address":[25447421,25447477],"length":1,"stats":{"Line":15}},{"line":502,"address":[24987058,24986807,24987289],"length":1,"stats":{"Line":12}},{"line":504,"address":[18317075],"length":1,"stats":{"Line":5}},{"line":505,"address":[18317027],"length":1,"stats":{"Line":8}},{"line":511,"address":[17533104,17533110,17532320],"length":1,"stats":{"Line":0}},{"line":519,"address":[18248379],"length":1,"stats":{"Line":0}},{"line":525,"address":[18249003,18248811],"length":1,"stats":{"Line":0}},{"line":526,"address":[24978241,24978196,24978260],"length":1,"stats":{"Line":0}},{"line":529,"address":[25438897],"length":1,"stats":{"Line":0}},{"line":532,"address":[18248164,18248170,18246960],"length":1,"stats":{"Line":0}},{"line":539,"address":[25437108],"length":1,"stats":{"Line":0}},{"line":544,"address":[17531636],"length":1,"stats":{"Line":0}},{"line":545,"address":[19737121,19736844],"length":1,"stats":{"Line":0}},{"line":546,"address":[18306887,18306998],"length":1,"stats":{"Line":0}},{"line":550,"address":[19745766,19745495],"length":1,"stats":{"Line":0}},{"line":551,"address":[25438052],"length":1,"stats":{"Line":0}},{"line":554,"address":[19753942,19753280,19753936],"length":1,"stats":{"Line":0}},{"line":561,"address":[19744932,19744997],"length":1,"stats":{"Line":0}},{"line":562,"address":[18255973],"length":1,"stats":{"Line":0}},{"line":565,"address":[19763280,19764067,19764073],"length":1,"stats":{"Line":7}},{"line":567,"address":[18265464],"length":1,"stats":{"Line":8}},{"line":573,"address":[24995213],"length":1,"stats":{"Line":6}},{"line":574,"address":[17549487],"length":1,"stats":{"Line":8}},{"line":577,"address":[24975573,24974240,24976282],"length":1,"stats":{"Line":0}},{"line":578,"address":[18093719],"length":1,"stats":{"Line":0}},{"line":580,"address":[17529279,17530986,17529196],"length":1,"stats":{"Line":0}},{"line":581,"address":[24976277,24975629,24974553],"length":1,"stats":{"Line":0}},{"line":582,"address":[24975784],"length":1,"stats":{"Line":0}},{"line":583,"address":[25436581,25436671],"length":1,"stats":{"Line":0}},{"line":584,"address":[18095551],"length":1,"stats":{"Line":0}},{"line":587,"address":[17104016,17104041],"length":1,"stats":{"Line":0}},{"line":588,"address":[18094987,18094129,18094228],"length":1,"stats":{"Line":0}},{"line":590,"address":[19743535],"length":1,"stats":{"Line":0}},{"line":592,"address":[24974983],"length":1,"stats":{"Line":0}},{"line":596,"address":[18245934,18245847],"length":1,"stats":{"Line":0}},{"line":598,"address":[17530256],"length":1,"stats":{"Line":0}},{"line":601,"address":[18268352,18270639,18271676],"length":1,"stats":{"Line":0}},{"line":602,"address":[25458407],"length":1,"stats":{"Line":0}},{"line":603,"address":[18339179],"length":1,"stats":{"Line":0}},{"line":604,"address":[18117204],"length":1,"stats":{"Line":0}},{"line":605,"address":[19757756],"length":1,"stats":{"Line":0}},{"line":607,"address":[25458536,25458600,25458786],"length":1,"stats":{"Line":0}},{"line":608,"address":[19767085,19766761],"length":1,"stats":{"Line":0}},{"line":609,"address":[19758543,19758472],"length":1,"stats":{"Line":0}},{"line":610,"address":[25459406,25459348],"length":1,"stats":{"Line":0}},{"line":614,"address":[24998695],"length":1,"stats":{"Line":0}},{"line":615,"address":[19767251,19767331,19769505],"length":1,"stats":{"Line":0}},{"line":617,"address":[18269757,18269663,18269842],"length":1,"stats":{"Line":0}},{"line":618,"address":[19767792,19767938,19769454],"length":1,"stats":{"Line":0}},{"line":619,"address":[18341040],"length":1,"stats":{"Line":0}},{"line":621,"address":[18119366,18119261,18119095,18119163],"length":1,"stats":{"Line":0}},{"line":622,"address":[19768404,19768465,19768507],"length":1,"stats":{"Line":0}},{"line":625,"address":[25460688],"length":1,"stats":{"Line":0}},{"line":626,"address":[18341782,18341817,18341728],"length":1,"stats":{"Line":0}},{"line":627,"address":[18341790,18341887,18341922],"length":1,"stats":{"Line":0}},{"line":629,"address":[18330423,18330375,18330544],"length":1,"stats":{"Line":0}},{"line":633,"address":[24999310],"length":1,"stats":{"Line":0}},{"line":636,"address":[18117768],"length":1,"stats":{"Line":0}},{"line":637,"address":[19766810],"length":1,"stats":{"Line":0}},{"line":638,"address":[24998279],"length":1,"stats":{"Line":0}},{"line":639,"address":[19766849],"length":1,"stats":{"Line":0}},{"line":640,"address":[24998336],"length":1,"stats":{"Line":0}},{"line":641,"address":[18117757],"length":1,"stats":{"Line":0}},{"line":645,"address":[18321984],"length":1,"stats":{"Line":1}},{"line":651,"address":[18266720,18267781,18267800],"length":1,"stats":{"Line":0}},{"line":653,"address":[18266771],"length":1,"stats":{"Line":0}},{"line":654,"address":[19696792,19696867],"length":1,"stats":{"Line":0}},{"line":655,"address":[24936987],"length":1,"stats":{"Line":0}},{"line":656,"address":[17493340],"length":1,"stats":{"Line":0}},{"line":657,"address":[24937084,24937144],"length":1,"stats":{"Line":0}},{"line":660,"address":[17493708,17493768],"length":1,"stats":{"Line":0}},{"line":662,"address":[18279054],"length":1,"stats":{"Line":0}},{"line":663,"address":[18267715,18267639],"length":1,"stats":{"Line":0}},{"line":665,"address":[17494059],"length":1,"stats":{"Line":0}},{"line":668,"address":[19695600,19696481,19696487],"length":1,"stats":{"Line":0}},{"line":669,"address":[18206408],"length":1,"stats":{"Line":0}},{"line":670,"address":[24936304,24936096,24936239],"length":1,"stats":{"Line":0}},{"line":671,"address":[17492642],"length":1,"stats":{"Line":0}},{"line":674,"address":[24936160],"length":1,"stats":{"Line":0}},{"line":677,"address":[18280144,18281483,18281716],"length":1,"stats":{"Line":0}},{"line":681,"address":[18280187,18280347],"length":1,"stats":{"Line":0}},{"line":682,"address":[18280407],"length":1,"stats":{"Line":0}},{"line":684,"address":[18268947,18269184,18269049],"length":1,"stats":{"Line":0}},{"line":685,"address":[18269595,18269353,18269866,18269660],"length":1,"stats":{"Line":0}},{"line":686,"address":[24939869,24939809],"length":1,"stats":{"Line":0}},{"line":687,"address":[25400559],"length":1,"stats":{"Line":0}},{"line":692,"address":[19708079],"length":1,"stats":{"Line":0}},{"line":695,"address":[18274885,18273664,18274913],"length":1,"stats":{"Line":1}},{"line":699,"address":[18273728],"length":1,"stats":{"Line":1}},{"line":700,"address":[25404572,25404649],"length":1,"stats":{"Line":2}},{"line":702,"address":[19703908],"length":1,"stats":{"Line":1}},{"line":703,"address":[24944061,24944304,24944169],"length":1,"stats":{"Line":3}},{"line":704,"address":[18215263,18215037],"length":1,"stats":{"Line":0}},{"line":705,"address":[19704802,19704761],"length":1,"stats":{"Line":0}},{"line":709,"address":[17500377],"length":1,"stats":{"Line":1}},{"line":712,"address":[19714832,19716053,19716081],"length":1,"stats":{"Line":0}},{"line":716,"address":[18276256],"length":1,"stats":{"Line":0}},{"line":717,"address":[18276332,18276409],"length":1,"stats":{"Line":0}},{"line":719,"address":[18276436],"length":1,"stats":{"Line":0}},{"line":720,"address":[18217488,18217353,18217245],"length":1,"stats":{"Line":0}},{"line":721,"address":[18288559,18288333],"length":1,"stats":{"Line":0}},{"line":722,"address":[17503204,17503233],"length":1,"stats":{"Line":0}},{"line":726,"address":[18288377],"length":1,"stats":{"Line":0}},{"line":729,"address":[19706177,19706149,19704928],"length":1,"stats":{"Line":0}},{"line":733,"address":[24945088],"length":1,"stats":{"Line":0}},{"line":734,"address":[18215897,18215820],"length":1,"stats":{"Line":0}},{"line":736,"address":[18286692],"length":1,"stats":{"Line":0}},{"line":737,"address":[24945325,24945433,24945568],"length":1,"stats":{"Line":0}},{"line":738,"address":[18216301,18216527],"length":1,"stats":{"Line":0}},{"line":739,"address":[18287545,18287586],"length":1,"stats":{"Line":0}},{"line":743,"address":[19714233],"length":1,"stats":{"Line":0}},{"line":746,"address":[18206000],"length":1,"stats":{"Line":0}},{"line":753,"address":[18206135],"length":1,"stats":{"Line":0}},{"line":755,"address":[17491870],"length":1,"stats":{"Line":0}},{"line":757,"address":[24935606],"length":1,"stats":{"Line":0}},{"line":759,"address":[24935662],"length":1,"stats":{"Line":0}},{"line":764,"address":[18210992],"length":1,"stats":{"Line":0}},{"line":770,"address":[19700343],"length":1,"stats":{"Line":0}},{"line":771,"address":[19709044],"length":1,"stats":{"Line":0}},{"line":772,"address":[19709081],"length":1,"stats":{"Line":0}},{"line":773,"address":[18211230],"length":1,"stats":{"Line":0}},{"line":777,"address":[25399348,25398768,25399354],"length":1,"stats":{"Line":0}},{"line":778,"address":[17494376],"length":1,"stats":{"Line":0}},{"line":779,"address":[18268370,18268258],"length":1,"stats":{"Line":0}},{"line":780,"address":[18209202,18209275],"length":1,"stats":{"Line":0}},{"line":783,"address":[25399046],"length":1,"stats":{"Line":0}},{"line":786,"address":[18211248],"length":1,"stats":{"Line":0}},{"line":787,"address":[19709181],"length":1,"stats":{"Line":0}},{"line":789,"address":[25401282],"length":1,"stats":{"Line":0}},{"line":793,"address":[19707456,19708906,19709161],"length":1,"stats":{"Line":7}},{"line":794,"address":[18277486,18277651],"length":1,"stats":{"Line":13}},{"line":795,"address":[19707780,19707714],"length":1,"stats":{"Line":13}},{"line":797,"address":[18218766,18218612,18218707,18219891,18218675],"length":1,"stats":{"Line":13}},{"line":799,"address":[24948203,24948399],"length":1,"stats":{"Line":16}},{"line":800,"address":[19708646,19708472,19708739],"length":1,"stats":{"Line":0}},{"line":801,"address":[17504597,17504659],"length":1,"stats":{"Line":0}},{"line":805,"address":[24948651],"length":1,"stats":{"Line":8}},{"line":808,"address":[19703630,19700608,19702521],"length":1,"stats":{"Line":0}},{"line":813,"address":[19709468,19709287],"length":1,"stats":{"Line":0}},{"line":814,"address":[25401668],"length":1,"stats":{"Line":0}},{"line":815,"address":[18060416],"length":1,"stats":{"Line":0}},{"line":816,"address":[18211724],"length":1,"stats":{"Line":0}},{"line":817,"address":[18282504],"length":1,"stats":{"Line":0}},{"line":819,"address":[18211912,18211796,18212047],"length":1,"stats":{"Line":0}},{"line":820,"address":[25403339,25402232,25403404],"length":1,"stats":{"Line":0}},{"line":821,"address":[17498800,17498861],"length":1,"stats":{"Line":0}},{"line":823,"address":[18213608,18213667],"length":1,"stats":{"Line":0}},{"line":824,"address":[24942796,24942884],"length":1,"stats":{"Line":0}},{"line":825,"address":[25403591],"length":1,"stats":{"Line":0}},{"line":827,"address":[18062393,18062444,18062515],"length":1,"stats":{"Line":0}},{"line":828,"address":[17499139,17499099],"length":1,"stats":{"Line":0}},{"line":831,"address":[18273162,18273102],"length":1,"stats":{"Line":0}},{"line":832,"address":[17499072,17499184],"length":1,"stats":{"Line":0}},{"line":833,"address":[18284589],"length":1,"stats":{"Line":0}},{"line":834,"address":[24943402,24943347],"length":1,"stats":{"Line":0}},{"line":835,"address":[19703135,19703183],"length":1,"stats":{"Line":0}},{"line":836,"address":[18213970],"length":1,"stats":{"Line":0}},{"line":840,"address":[19701545],"length":1,"stats":{"Line":0}},{"line":841,"address":[19710477,19710246,19710228],"length":1,"stats":{"Line":0}},{"line":842,"address":[24941814,24941704],"length":1,"stats":{"Line":0}},{"line":844,"address":[19710234],"length":1,"stats":{"Line":0}},{"line":847,"address":[18061139],"length":1,"stats":{"Line":0}},{"line":849,"address":[22784304,22784314],"length":1,"stats":{"Line":0}},{"line":850,"address":[17498034],"length":1,"stats":{"Line":0}},{"line":852,"address":[25402672,25402690,25403250],"length":1,"stats":{"Line":0}},{"line":853,"address":[17498612,17498625,17498532,17498077],"length":1,"stats":{"Line":0}},{"line":855,"address":[18283430],"length":1,"stats":{"Line":0}},{"line":857,"address":[19701959],"length":1,"stats":{"Line":0}},{"line":859,"address":[18283705],"length":1,"stats":{"Line":0}},{"line":860,"address":[18272049],"length":1,"stats":{"Line":0}},{"line":861,"address":[19702062],"length":1,"stats":{"Line":0}},{"line":862,"address":[19710733],"length":1,"stats":{"Line":0}},{"line":863,"address":[24942202],"length":1,"stats":{"Line":0}},{"line":864,"address":[19710761],"length":1,"stats":{"Line":0}},{"line":871,"address":[19714522,19716389,19712896],"length":1,"stats":{"Line":0}},{"line":877,"address":[19713046],"length":1,"stats":{"Line":0}},{"line":878,"address":[19713087],"length":1,"stats":{"Line":0}},{"line":879,"address":[18072670,18072747],"length":1,"stats":{"Line":0}},{"line":881,"address":[25414019],"length":1,"stats":{"Line":0}},{"line":882,"address":[18295055],"length":1,"stats":{"Line":0}},{"line":884,"address":[18224333],"length":1,"stats":{"Line":0}},{"line":886,"address":[18073206],"length":1,"stats":{"Line":0}},{"line":887,"address":[25414370,25414441],"length":1,"stats":{"Line":0}},{"line":889,"address":[25414652],"length":1,"stats":{"Line":0}},{"line":893,"address":[19722640,19722721,19722755],"length":1,"stats":{"Line":0}},{"line":894,"address":[18073652],"length":1,"stats":{"Line":0}},{"line":895,"address":[18073913],"length":1,"stats":{"Line":0}},{"line":896,"address":[19714202],"length":1,"stats":{"Line":0}},{"line":897,"address":[19714229],"length":1,"stats":{"Line":0}},{"line":898,"address":[18225052,18225122],"length":1,"stats":{"Line":0}},{"line":904,"address":[19722735,19723183],"length":1,"stats":{"Line":0}},{"line":905,"address":[24954978,24955113,24954870],"length":1,"stats":{"Line":0}},{"line":906,"address":[18225827],"length":1,"stats":{"Line":0}},{"line":907,"address":[17510676,17510914,17511647],"length":1,"stats":{"Line":0}},{"line":908,"address":[25416121,25416162],"length":1,"stats":{"Line":0}},{"line":909,"address":[19724061],"length":1,"stats":{"Line":0}},{"line":910,"address":[18296976,18297044],"length":1,"stats":{"Line":0}},{"line":911,"address":[19724191],"length":1,"stats":{"Line":0}},{"line":912,"address":[18285586,18285666],"length":1,"stats":{"Line":0}},{"line":913,"address":[19715879],"length":1,"stats":{"Line":0}},{"line":914,"address":[24955813],"length":1,"stats":{"Line":0}},{"line":915,"address":[25416509],"length":1,"stats":{"Line":0}},{"line":916,"address":[17511361],"length":1,"stats":{"Line":0}},{"line":917,"address":[19724493,19724650],"length":1,"stats":{"Line":0}},{"line":923,"address":[17509507],"length":1,"stats":{"Line":0}},{"line":926,"address":[18288075,18286416,18289886],"length":1,"stats":{"Line":0}},{"line":932,"address":[18286563],"length":1,"stats":{"Line":0}},{"line":933,"address":[18286604],"length":1,"stats":{"Line":0}},{"line":934,"address":[17512211,17512288],"length":1,"stats":{"Line":0}},{"line":936,"address":[17512296],"length":1,"stats":{"Line":0}},{"line":938,"address":[18076546],"length":1,"stats":{"Line":0}},{"line":940,"address":[17512646,17512599],"length":1,"stats":{"Line":0}},{"line":941,"address":[18298865],"length":1,"stats":{"Line":0}},{"line":945,"address":[19717442,19717543],"length":1,"stats":{"Line":0}},{"line":948,"address":[18077053],"length":1,"stats":{"Line":0}},{"line":950,"address":[19726308,19726259],"length":1,"stats":{"Line":0}},{"line":951,"address":[25418469],"length":1,"stats":{"Line":0}},{"line":952,"address":[18228714],"length":1,"stats":{"Line":0}},{"line":953,"address":[18077259],"length":1,"stats":{"Line":0}},{"line":954,"address":[19726422],"length":1,"stats":{"Line":0}},{"line":955,"address":[18077427,18077357],"length":1,"stats":{"Line":0}},{"line":961,"address":[19718096,19717648],"length":1,"stats":{"Line":0}},{"line":962,"address":[19726964,19727072,19727207],"length":1,"stats":{"Line":0}},{"line":963,"address":[18288625],"length":1,"stats":{"Line":0}},{"line":964,"address":[19718892,19719584,19718646],"length":1,"stats":{"Line":0}},{"line":965,"address":[25419666,25419715],"length":1,"stats":{"Line":0}},{"line":966,"address":[25419791,25419723],"length":1,"stats":{"Line":0}},{"line":967,"address":[18300570],"length":1,"stats":{"Line":0}},{"line":968,"address":[18300605,18300685],"length":1,"stats":{"Line":0}},{"line":969,"address":[18230128],"length":1,"stats":{"Line":0}},{"line":970,"address":[25419984],"length":1,"stats":{"Line":0}},{"line":971,"address":[18229992],"length":1,"stats":{"Line":0}},{"line":972,"address":[25420064],"length":1,"stats":{"Line":0}},{"line":973,"address":[18230104,18230259],"length":1,"stats":{"Line":0}},{"line":979,"address":[18298877],"length":1,"stats":{"Line":0}},{"line":982,"address":[19736548,19732960,19734630],"length":1,"stats":{"Line":0}},{"line":1002,"address":[24934576],"length":1,"stats":{"Line":0}},{"line":1003,"address":[19694494],"length":1,"stats":{"Line":0}},{"line":1008,"address":[18219952],"length":1,"stats":{"Line":0}},{"line":1009,"address":[25409982],"length":1,"stats":{"Line":0}},{"line":1013,"address":[19724467],"length":1,"stats":{"Line":0}},{"line":1014,"address":[18294516],"length":1,"stats":{"Line":0}},{"line":1015,"address":[18294672,18294595],"length":1,"stats":{"Line":0}},{"line":1017,"address":[25425587],"length":1,"stats":{"Line":0}},{"line":1019,"address":[19724680],"length":1,"stats":{"Line":0}},{"line":1020,"address":[18294699],"length":1,"stats":{"Line":0}},{"line":1021,"address":[24964855],"length":1,"stats":{"Line":0}},{"line":1024,"address":[18235796],"length":1,"stats":{"Line":0}},{"line":1026,"address":[18084598],"length":1,"stats":{"Line":0}},{"line":1028,"address":[18235867,18235938],"length":1,"stats":{"Line":0}},{"line":1029,"address":[18236055,18236226],"length":1,"stats":{"Line":0}},{"line":1033,"address":[18236284,18236247,18236325],"length":1,"stats":{"Line":0}},{"line":1034,"address":[25426374],"length":1,"stats":{"Line":0}},{"line":1035,"address":[19725641,19725709],"length":1,"stats":{"Line":0}},{"line":1036,"address":[18307389],"length":1,"stats":{"Line":0}},{"line":1037,"address":[19725736],"length":1,"stats":{"Line":0}},{"line":1038,"address":[19734416],"length":1,"stats":{"Line":0}},{"line":1039,"address":[17521104],"length":1,"stats":{"Line":0}},{"line":1045,"address":[18296023,18295538],"length":1,"stats":{"Line":0}},{"line":1046,"address":[17521334],"length":1,"stats":{"Line":0}},{"line":1051,"address":[19726103],"length":1,"stats":{"Line":0}},{"line":1052,"address":[18296363,18296471,18296606],"length":1,"stats":{"Line":0}},{"line":1053,"address":[25427432],"length":1,"stats":{"Line":0}},{"line":1054,"address":[18296685,18296809],"length":1,"stats":{"Line":0}},{"line":1055,"address":[19726882,19726942],"length":1,"stats":{"Line":0}},{"line":1057,"address":[25427686,25427735],"length":1,"stats":{"Line":0}},{"line":1058,"address":[19727030],"length":1,"stats":{"Line":0}},{"line":1063,"address":[24967136,24967182],"length":1,"stats":{"Line":0}},{"line":1065,"address":[18308633],"length":1,"stats":{"Line":0}},{"line":1066,"address":[18237900,18237968],"length":1,"stats":{"Line":0}},{"line":1067,"address":[17522444],"length":1,"stats":{"Line":0}},{"line":1068,"address":[18297278,18297346],"length":1,"stats":{"Line":0}},{"line":1070,"address":[18238234],"length":1,"stats":{"Line":0}},{"line":1072,"address":[19727378],"length":1,"stats":{"Line":0}},{"line":1073,"address":[24967498],"length":1,"stats":{"Line":0}},{"line":1074,"address":[19727442],"length":1,"stats":{"Line":0}},{"line":1079,"address":[19733975],"length":1,"stats":{"Line":0}},{"line":1082,"address":[19730790,19730920,19728912],"length":1,"stats":{"Line":0}},{"line":1087,"address":[19728994],"length":1,"stats":{"Line":0}},{"line":1088,"address":[18290376],"length":1,"stats":{"Line":0}},{"line":1089,"address":[18079940],"length":1,"stats":{"Line":0}},{"line":1090,"address":[18080010,18080087],"length":1,"stats":{"Line":0}},{"line":1092,"address":[17516023],"length":1,"stats":{"Line":0}},{"line":1093,"address":[18231440],"length":1,"stats":{"Line":0}},{"line":1095,"address":[19729376],"length":1,"stats":{"Line":0}},{"line":1096,"address":[17516295],"length":1,"stats":{"Line":0}},{"line":1100,"address":[18302493],"length":1,"stats":{"Line":0}},{"line":1101,"address":[18302619,18302548],"length":1,"stats":{"Line":0}},{"line":1104,"address":[24961239,24961107],"length":1,"stats":{"Line":0}},{"line":1105,"address":[24961710,24961467,24961575],"length":1,"stats":{"Line":0}},{"line":1106,"address":[25422440,25422564,25422592],"length":1,"stats":{"Line":0}},{"line":1107,"address":[18303346],"length":1,"stats":{"Line":0}},{"line":1109,"address":[17517194],"length":1,"stats":{"Line":0}},{"line":1112,"address":[18303368],"length":1,"stats":{"Line":0}},{"line":1113,"address":[17517326,17517281],"length":1,"stats":{"Line":0}},{"line":1114,"address":[19721965],"length":1,"stats":{"Line":0}},{"line":1119,"address":[18302403],"length":1,"stats":{"Line":0}},{"line":1122,"address":[19722304,19724165,19724295],"length":1,"stats":{"Line":0}},{"line":1127,"address":[25423154],"length":1,"stats":{"Line":0}},{"line":1128,"address":[24962504],"length":1,"stats":{"Line":0}},{"line":1129,"address":[19722468],"length":1,"stats":{"Line":0}},{"line":1130,"address":[19722615,19722538],"length":1,"stats":{"Line":0}},{"line":1132,"address":[19731263],"length":1,"stats":{"Line":0}},{"line":1134,"address":[18233464],"length":1,"stats":{"Line":0}},{"line":1135,"address":[18292847],"length":1,"stats":{"Line":0}},{"line":1139,"address":[18233696,18233797],"length":1,"stats":{"Line":0}},{"line":1142,"address":[25423819],"length":1,"stats":{"Line":0}},{"line":1144,"address":[18293110],"length":1,"stats":{"Line":0}},{"line":1145,"address":[19731781],"length":1,"stats":{"Line":0}},{"line":1148,"address":[17518580,17518484],"length":1,"stats":{"Line":0}},{"line":1149,"address":[18293440,18293683,18293548],"length":1,"stats":{"Line":0}},{"line":1150,"address":[24963961,24963837,24963989],"length":1,"stats":{"Line":0}},{"line":1151,"address":[19732535],"length":1,"stats":{"Line":0}},{"line":1153,"address":[19723871],"length":1,"stats":{"Line":0}},{"line":1156,"address":[25424685],"length":1,"stats":{"Line":0}},{"line":1157,"address":[25424780,25424726],"length":1,"stats":{"Line":0}},{"line":1162,"address":[19731499],"length":1,"stats":{"Line":0}},{"line":1165,"address":[24969872],"length":1,"stats":{"Line":0}},{"line":1170,"address":[18089317],"length":1,"stats":{"Line":0}}],"covered":142,"coverable":550},{"path":["/","home","shift","code","vincents-ai","engram","src","storage","memory_entity.rs"],"content":"//! Memory entity representation for storage\n\nuse chrono::{DateTime, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n/// Memory entity for content-addressable storage\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct MemoryEntity {\n    /// Unique identifier (content hash)\n    pub id: String,\n\n    /// Entity type (task, context, reasoning, etc.)\n    #[serde(alias = \"type\")]\n    pub entity_type: String,\n\n    /// Associated agent\n    pub agent: String,\n\n    /// Timestamp\n    pub timestamp: DateTime\u003cUtc\u003e,\n\n    /// Entity data\n    pub data: HashMap\u003cString, serde_json::Value\u003e,\n\n    /// Content hash for integrity\n    #[serde(default)]\n    pub content_hash: String,\n\n    /// Size in bytes\n    #[serde(default)]\n    pub size_bytes: usize,\n\n    /// Tags for indexing\n    #[serde(default)]\n    pub tags: Vec\u003cString\u003e,\n\n    /// References to other entities\n    #[serde(default)]\n    pub references: Vec\u003cString\u003e,\n\n    /// Additional metadata\n    #[serde(default)]\n    pub metadata: HashMap\u003cString, serde_json::Value\u003e,\n}\n\nimpl MemoryEntity {\n    /// Create a new memory entity\n    pub fn new(\n        id: String,\n        entity_type: String,\n        agent: String,\n        timestamp: DateTime\u003cUtc\u003e,\n        data: HashMap\u003cString, serde_json::Value\u003e,\n    ) -\u003e Self {\n        let json_data = serde_json::to_value(\u0026data).unwrap_or_default();\n        let content_str = serde_json::to_string(\u0026json_data).unwrap_or_default();\n        let content_hash = Self::calculate_hash(\u0026content_str);\n        let size_bytes = content_str.len();\n\n        Self {\n            id,\n            entity_type,\n            agent,\n            timestamp,\n            data,\n            content_hash,\n            size_bytes,\n            tags: Vec::new(),\n            references: Vec::new(),\n            metadata: HashMap::new(),\n        }\n    }\n\n    /// Calculate SHA-256 hash of content\n    pub fn calculate_hash(content: \u0026str) -\u003e String {\n        use sha2::{Digest, Sha256};\n        let mut hasher = Sha256::new();\n        hasher.update(content.as_bytes());\n        format!(\"{:x}\", hasher.finalize())\n    }\n\n    /// Add a tag\n    pub fn add_tag(\u0026mut self, tag: String) {\n        if !self.tags.contains(\u0026tag) {\n            self.tags.push(tag);\n        }\n    }\n\n    /// Add a reference\n    pub fn add_reference(\u0026mut self, reference: String) {\n        if !self.references.contains(\u0026reference) {\n            self.references.push(reference);\n        }\n    }\n\n    /// Verify content integrity\n    pub fn verify_integrity(\u0026self) -\u003e bool {\n        let json_data = serde_json::to_value(\u0026self.data).unwrap_or_default();\n        let content_str = serde_json::to_string(\u0026json_data).unwrap_or_default();\n        let current_hash = Self::calculate_hash(\u0026content_str);\n        current_hash == self.content_hash\n    }\n\n    /// Get a data field\n    pub fn get_field(\u0026self, key: \u0026str) -\u003e Option\u003c\u0026serde_json::Value\u003e {\n        self.data.get(key)\n    }\n\n    /// Set a data field\n    pub fn set_field(\u0026mut self, key: String, value: serde_json::Value) {\n        self.data.insert(key, value);\n    }\n\n    /// Remove a data field\n    pub fn remove_field(\u0026mut self, key: \u0026str) -\u003e Option\u003cserde_json::Value\u003e {\n        self.data.remove(key)\n    }\n\n    /// Convert to JSON string\n    pub fn to_json(\u0026self) -\u003e Result\u003cString, serde_json::Error\u003e {\n        serde_json::to_string(self)\n    }\n\n    /// Convert from JSON string\n    pub fn from_json(json: \u0026str) -\u003e Result\u003cSelf, serde_json::Error\u003e {\n        serde_json::from_str(json)\n    }\n\n    /// Get file path for storage\n    pub fn get_file_path(\u0026self, base_path: \u0026str) -\u003e std::path::PathBuf {\n        use std::path::PathBuf;\n\n        // Create directory structure: base_path/entity_type/first_two_chars/remainder.json\n        let first_two = if self.id.len() \u003e= 2 {\n            \u0026self.id[..2]\n        } else {\n            \u0026self.id\n        };\n\n        let mut path = PathBuf::from(base_path);\n        path.push(\u0026self.entity_type);\n        path.push(first_two);\n        path.push(format!(\"{}.json\", \u0026self.id));\n\n        path\n    }\n\n    /// Get directory path for this entity type\n    pub fn get_type_directory(base_path: \u0026str, entity_type: \u0026str) -\u003e std::path::PathBuf {\n        use std::path::PathBuf;\n        let mut path = PathBuf::from(base_path);\n        path.push(entity_type);\n        path\n    }\n}\n","traces":[{"line":49,"address":[17633847,17634038,17632672],"length":1,"stats":{"Line":10}},{"line":56,"address":[22994915,22994786],"length":1,"stats":{"Line":24}},{"line":57,"address":[17329526,17329464],"length":1,"stats":{"Line":20}},{"line":58,"address":[16336457,16336525],"length":1,"stats":{"Line":26}},{"line":59,"address":[16336560,16336635],"length":1,"stats":{"Line":24}},{"line":69,"address":[16336819],"length":1,"stats":{"Line":12}},{"line":70,"address":[16266114],"length":1,"stats":{"Line":15}},{"line":71,"address":[16114926],"length":1,"stats":{"Line":13}},{"line":76,"address":[16113264],"length":1,"stats":{"Line":11}},{"line":78,"address":[16113307],"length":1,"stats":{"Line":10}},{"line":79,"address":[22993920],"length":1,"stats":{"Line":11}},{"line":80,"address":[23454611],"length":1,"stats":{"Line":12}},{"line":84,"address":[22996377,22996144,22996351],"length":1,"stats":{"Line":0}},{"line":85,"address":[16393651,16393733],"length":1,"stats":{"Line":0}},{"line":86,"address":[17330808,17330859],"length":1,"stats":{"Line":0}},{"line":91,"address":[16112544,16112777,16112751],"length":1,"stats":{"Line":0}},{"line":92,"address":[19705411,19705493],"length":1,"stats":{"Line":0}},{"line":93,"address":[16390811,16390760],"length":1,"stats":{"Line":0}},{"line":98,"address":[19706384,19706744,19706750],"length":1,"stats":{"Line":0}},{"line":99,"address":[16391655],"length":1,"stats":{"Line":0}},{"line":100,"address":[22994282,22994222],"length":1,"stats":{"Line":0}},{"line":101,"address":[19706535,19706608],"length":1,"stats":{"Line":0}},{"line":102,"address":[16113808],"length":1,"stats":{"Line":0}},{"line":106,"address":[22996480],"length":1,"stats":{"Line":4}},{"line":107,"address":[17634434],"length":1,"stats":{"Line":5}},{"line":111,"address":[16394016],"length":1,"stats":{"Line":0}},{"line":112,"address":[16267202],"length":1,"stats":{"Line":0}},{"line":116,"address":[22993072],"length":1,"stats":{"Line":0}},{"line":117,"address":[17631035],"length":1,"stats":{"Line":0}},{"line":121,"address":[16267040],"length":1,"stats":{"Line":5}},{"line":122,"address":[16393889],"length":1,"stats":{"Line":6}},{"line":126,"address":[16267088],"length":1,"stats":{"Line":4}},{"line":127,"address":[17634389],"length":1,"stats":{"Line":3}},{"line":131,"address":[17328357,17328363,17327904],"length":1,"stats":{"Line":0}},{"line":135,"address":[22993471,22993440],"length":1,"stats":{"Line":0}},{"line":136,"address":[23454150],"length":1,"stats":{"Line":0}},{"line":138,"address":[16112864],"length":1,"stats":{"Line":0}},{"line":141,"address":[16264172],"length":1,"stats":{"Line":0}},{"line":142,"address":[16264199],"length":1,"stats":{"Line":0}},{"line":143,"address":[16335023],"length":1,"stats":{"Line":0}},{"line":144,"address":[17631566],"length":1,"stats":{"Line":0}},{"line":146,"address":[23454467],"length":1,"stats":{"Line":0}},{"line":150,"address":[23455378,23455216,23455384],"length":1,"stats":{"Line":0}},{"line":152,"address":[17632524],"length":1,"stats":{"Line":0}},{"line":153,"address":[17329150],"length":1,"stats":{"Line":0}},{"line":154,"address":[16114083],"length":1,"stats":{"Line":0}}],"covered":18,"coverable":46},{"path":["/","home","shift","code","vincents-ai","engram","src","storage","memory_only_storage.rs"],"content":"//! In-memory storage implementation for testing and development\n\nuse super::{\n    GitCommit, MemoryEntity, QueryFilter, QueryResult, RelationshipIndex, RelationshipStats,\n    RelationshipStorage, SortOrder, Storage, StorageStats, TraversalAlgorithm,\n};\nuse crate::entities::{\n    Entity, EntityRegistry, EntityRelationType, EntityRelationship, GenericEntity,\n    RelationshipDirection, RelationshipFilter,\n};\nuse crate::error::EngramError;\nuse chrono::{DateTime, Utc};\nuse serde_json::Value;\nuse std::collections::HashMap;\nuse std::sync::{Arc, Mutex};\n\n/// In-memory storage backend\npub struct MemoryStorage {\n    entities: Arc\u003cMutex\u003cHashMap\u003cString, MemoryEntity\u003e\u003e\u003e,\n    #[allow(dead_code)]\n    entity_registry: EntityRegistry,\n    current_agent: String,\n    commits: Vec\u003cGitCommit\u003e,\n    relationship_index: Arc\u003cMutex\u003cRelationshipIndex\u003e\u003e,\n}\n\nimpl MemoryStorage {\n    /// Create new memory storage instance\n    pub fn new(agent: \u0026str) -\u003e Self {\n        let mut registry = EntityRegistry::new();\n        registry.register::\u003ccrate::entities::Task\u003e();\n        registry.register::\u003ccrate::entities::Context\u003e();\n        registry.register::\u003ccrate::entities::Reasoning\u003e();\n        registry.register::\u003ccrate::entities::Knowledge\u003e();\n        registry.register::\u003ccrate::entities::Session\u003e();\n        registry.register::\u003ccrate::entities::Compliance\u003e();\n        registry.register::\u003ccrate::entities::Rule\u003e();\n        registry.register::\u003ccrate::entities::Standard\u003e();\n        registry.register::\u003ccrate::entities::ADR\u003e();\n        registry.register::\u003ccrate::entities::Workflow\u003e();\n\n        Self {\n            entities: Arc::new(Mutex::new(HashMap::new())),\n            entity_registry: registry,\n            current_agent: agent.to_string(),\n            commits: Vec::new(),\n            relationship_index: Arc::new(Mutex::new(RelationshipIndex::new())),\n        }\n    }\n}\n\nimpl Storage for MemoryStorage {\n    fn store(\u0026mut self, entity: \u0026GenericEntity) -\u003e Result\u003c(), EngramError\u003e {\n        let memory_entity = MemoryEntity::new(\n            entity.id.clone(),\n            entity.entity_type.clone(),\n            entity.agent.clone(),\n            entity.timestamp,\n            HashMap::from([(\"entity\".to_string(), entity.data.clone())]),\n        );\n\n        let mut entities = self.entities.lock().unwrap();\n        entities.insert(memory_entity.id.clone(), memory_entity);\n\n        // Create a commit record\n        let commit = GitCommit {\n            id: format!(\"commit-{}\", uuid::Uuid::new_v4()),\n            author: self.current_agent.clone(),\n            message: format!(\"Store {} {}\", entity.entity_type, entity.id),\n            timestamp: Utc::now(),\n            parents: Vec::new(),\n        };\n        self.commits.push(commit);\n\n        Ok(())\n    }\n\n    fn get(\u0026self, id: \u0026str, entity_type: \u0026str) -\u003e Result\u003cOption\u003cGenericEntity\u003e, EngramError\u003e {\n        let entities = self.entities.lock().unwrap();\n        if let Some(memory_entity) = entities.get(id) {\n            if memory_entity.entity_type != entity_type {\n                return Ok(None);\n            }\n\n            // Extract entity data\n            if let Some(entity_data) = memory_entity.get_field(\"entity\") {\n                let generic = GenericEntity {\n                    id: memory_entity.id.clone(),\n                    entity_type: memory_entity.entity_type.clone(),\n                    agent: memory_entity.agent.clone(),\n                    timestamp: memory_entity.timestamp,\n                    data: entity_data.clone(),\n                };\n\n                Ok(Some(generic))\n            } else {\n                Ok(None)\n            }\n        } else {\n            Ok(None)\n        }\n    }\n\n    fn query_by_agent(\n        \u0026self,\n        agent: \u0026str,\n        entity_type: Option\u003c\u0026str\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let entities = self.entities.lock().unwrap();\n        let mut results = Vec::new();\n\n        for memory_entity in entities.values() {\n            if memory_entity.agent != agent {\n                continue;\n            }\n\n            if let Some(filter_type) = entity_type {\n                if memory_entity.entity_type != filter_type {\n                    continue;\n                }\n            }\n\n            if let Some(entity_data) = memory_entity.get_field(\"entity\") {\n                let generic = GenericEntity {\n                    id: memory_entity.id.clone(),\n                    entity_type: memory_entity.entity_type.clone(),\n                    agent: memory_entity.agent.clone(),\n                    timestamp: memory_entity.timestamp,\n                    data: entity_data.clone(),\n                };\n\n                results.push(generic);\n            }\n        }\n\n        Ok(results)\n    }\n\n    fn query_by_time_range(\n        \u0026self,\n        start: DateTime\u003cUtc\u003e,\n        end: DateTime\u003cUtc\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let entities = self.entities.lock().unwrap();\n        let mut results = Vec::new();\n\n        for memory_entity in entities.values() {\n            if memory_entity.timestamp \u003c start || memory_entity.timestamp \u003e end {\n                continue;\n            }\n\n            if let Some(entity_data) = memory_entity.get_field(\"entity\") {\n                let generic = GenericEntity {\n                    id: memory_entity.id.clone(),\n                    entity_type: memory_entity.entity_type.clone(),\n                    agent: memory_entity.agent.clone(),\n                    timestamp: memory_entity.timestamp,\n                    data: entity_data.clone(),\n                };\n\n                results.push(generic);\n            }\n        }\n\n        Ok(results)\n    }\n\n    fn delete(\u0026mut self, id: \u0026str, entity_type: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        let mut entities = self.entities.lock().unwrap();\n        if let Some(memory_entity) = entities.remove(id) {\n            if memory_entity.entity_type != entity_type {\n                return Err(EngramError::NotFound(format!(\n                    \"Entity {} of type {} not found\",\n                    id, entity_type\n                )));\n            }\n\n            // Create a commit record\n            let commit = GitCommit {\n                id: format!(\"commit-{}\", uuid::Uuid::new_v4()),\n                author: self.current_agent.clone(),\n                message: format!(\"Delete {} {}\", entity_type, id),\n                timestamp: Utc::now(),\n                parents: self\n                    .commits\n                    .iter()\n                    .rev()\n                    .take(1)\n                    .map(|c| c.id.clone())\n                    .collect(),\n            };\n            self.commits.push(commit);\n\n            Ok(())\n        } else {\n            Err(EngramError::NotFound(format!(\"Entity {} not found\", id)))\n        }\n    }\n\n    fn list_ids(\u0026self, entity_type: \u0026str) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        let entities = self.entities.lock().unwrap();\n        let mut ids = Vec::new();\n\n        for (id, memory_entity) in entities.iter() {\n            if memory_entity.entity_type == entity_type {\n                ids.push(id.clone());\n            }\n        }\n\n        Ok(ids)\n    }\n\n    fn sync(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n        // Memory storage doesn't need syncing\n        Ok(())\n    }\n\n    fn current_branch(\u0026self) -\u003e Result\u003cString, EngramError\u003e {\n        Ok(\"main\".to_string())\n    }\n\n    fn create_branch(\u0026mut self, _branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        // Memory storage doesn't support branches\n        Ok(())\n    }\n\n    fn switch_branch(\u0026mut self, _branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        // Memory storage doesn't support branches\n        Ok(())\n    }\n\n    fn merge_branches(\u0026mut self, _source: \u0026str, _target: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        // Memory storage doesn't support branches\n        Ok(())\n    }\n\n    fn history(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cVec\u003cGitCommit\u003e, EngramError\u003e {\n        let limit = limit.unwrap_or(usize::MAX);\n        Ok(self.commits.iter().rev().take(limit).cloned().collect())\n    }\n\n    fn query(\u0026self, filter: \u0026QueryFilter) -\u003e Result\u003cQueryResult, EngramError\u003e {\n        let entities = self.entities.lock().unwrap();\n        let mut all_entities = Vec::new();\n\n        for memory_entity in entities.values() {\n            if let Some(entity_type_filter) = \u0026filter.entity_type {\n                if memory_entity.entity_type != *entity_type_filter {\n                    continue;\n                }\n            }\n\n            if let Some(agent_filter) = \u0026filter.agent {\n                if memory_entity.agent != *agent_filter {\n                    continue;\n                }\n            }\n\n            if let Some(time_range) = \u0026filter.time_range {\n                if memory_entity.timestamp \u003c time_range.start\n                    || memory_entity.timestamp \u003e time_range.end\n                {\n                    continue;\n                }\n            }\n\n            if let Some(entity_data) = memory_entity.get_field(\"entity\") {\n                if let Some(search_query) = \u0026filter.text_search {\n                    let search_lower: String = search_query.to_lowercase();\n                    let entity_json = serde_json::to_string(\u0026entity_data).unwrap_or_default();\n                    if !entity_json.to_lowercase().contains(\u0026search_lower) {\n                        continue;\n                    }\n                }\n\n                let mut matches_field_filters = true;\n                for (field, expected_value) in \u0026filter.field_filters {\n                    if let Some(actual_value) = entity_data.get(field) {\n                        if actual_value != expected_value {\n                            matches_field_filters = false;\n                            break;\n                        }\n                    } else {\n                        matches_field_filters = false;\n                        break;\n                    }\n                }\n\n                if !matches_field_filters {\n                    continue;\n                }\n\n                let generic = GenericEntity {\n                    id: memory_entity.id.clone(),\n                    entity_type: memory_entity.entity_type.clone(),\n                    agent: memory_entity.agent.clone(),\n                    timestamp: memory_entity.timestamp,\n                    data: entity_data.clone(),\n                };\n\n                all_entities.push(generic);\n            }\n        }\n\n        if let Some(sort_field) = \u0026filter.sort_by {\n            all_entities.sort_by(|a, b| {\n                let a_value = a.data.get(sort_field);\n                let b_value = b.data.get(sort_field);\n\n                let cmp = match (a_value, b_value) {\n                    (Some(a_val), Some(b_val)) =\u003e {\n                        let a_str = a_val.as_str().unwrap_or(\"\");\n                        let b_str = b_val.as_str().unwrap_or(\"\");\n                        a_str.cmp(b_str)\n                    }\n                    (Some(_), None) =\u003e std::cmp::Ordering::Greater,\n                    (None, Some(_)) =\u003e std::cmp::Ordering::Less,\n                    (None, None) =\u003e std::cmp::Ordering::Equal,\n                };\n\n                match filter.sort_order {\n                    SortOrder::Asc =\u003e cmp,\n                    SortOrder::Desc =\u003e cmp.reverse(),\n                }\n            });\n        } else {\n            all_entities.sort_by(|a, b| match filter.sort_order {\n                SortOrder::Asc =\u003e a.timestamp.cmp(\u0026b.timestamp),\n                SortOrder::Desc =\u003e b.timestamp.cmp(\u0026a.timestamp),\n            });\n        }\n\n        let total_count = all_entities.len();\n        let offset = filter.offset.unwrap_or(0);\n        let limit = filter.limit.unwrap_or(50);\n\n        let entities = if offset \u003c total_count {\n            let end_idx = std::cmp::min(offset + limit, total_count);\n            all_entities[offset..end_idx].to_vec()\n        } else {\n            Vec::new()\n        };\n\n        let has_more = offset + entities.len() \u003c total_count;\n\n        Ok(QueryResult {\n            entities,\n            total_count,\n            has_more,\n        })\n    }\n\n    fn query_by_type(\n        \u0026self,\n        entity_type: \u0026str,\n        filters: Option\u003c\u0026HashMap\u003cString, Value\u003e\u003e,\n        limit: Option\u003cusize\u003e,\n        offset: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cQueryResult, EngramError\u003e {\n        let mut filter = QueryFilter {\n            entity_type: Some(entity_type.to_string()),\n            limit,\n            offset,\n            ..Default::default()\n        };\n\n        if let Some(field_filters) = filters {\n            filter.field_filters = field_filters.clone();\n        }\n\n        self.query(\u0026filter)\n    }\n\n    fn text_search(\n        \u0026self,\n        query: \u0026str,\n        entity_types: Option\u003c\u0026[String]\u003e,\n        limit: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let mut filter = QueryFilter {\n            text_search: Some(query.to_string()),\n            limit,\n            ..Default::default()\n        };\n\n        if let Some(types) = entity_types {\n            if types.len() == 1 {\n                filter.entity_type = Some(types[0].clone());\n            }\n        }\n\n        let result = self.query(\u0026filter)?;\n        Ok(result.entities)\n    }\n\n    fn count(\u0026self, filter: \u0026QueryFilter) -\u003e Result\u003cusize, EngramError\u003e {\n        let count_filter = QueryFilter {\n            limit: None,\n            offset: None,\n            ..filter.clone()\n        };\n\n        let result = self.query(\u0026count_filter)?;\n        Ok(result.total_count)\n    }\n\n    fn get_all(\u0026self, entity_type: \u0026str) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e {\n        let filter = QueryFilter {\n            entity_type: Some(entity_type.to_string()),\n            limit: None,\n            offset: None,\n            ..Default::default()\n        };\n\n        let result = self.query(\u0026filter)?;\n        Ok(result.entities)\n    }\n\n    fn bulk_store(\u0026mut self, entities: \u0026[GenericEntity]) -\u003e Result\u003c(), EngramError\u003e {\n        for entity in entities {\n            self.store(entity)?;\n        }\n        Ok(())\n    }\n\n    fn get_stats(\u0026self) -\u003e Result\u003cStorageStats, EngramError\u003e {\n        let entities = self.entities.lock().unwrap();\n        let mut total_entities = 0;\n        let mut entities_by_type = HashMap::new();\n        let mut entities_by_agent = HashMap::new();\n        let mut total_storage_size = 0u64;\n\n        for memory_entity in entities.values() {\n            total_entities += 1;\n\n            *entities_by_type\n                .entry(memory_entity.entity_type.clone())\n                .or_insert(0) += 1;\n            *entities_by_agent\n                .entry(memory_entity.agent.clone())\n                .or_insert(0) += 1;\n\n            let entity_json = memory_entity.to_json().unwrap_or_default();\n            total_storage_size += entity_json.len() as u64;\n        }\n\n        Ok(StorageStats {\n            total_entities,\n            entities_by_type,\n            entities_by_agent,\n            total_storage_size,\n            last_sync: None,\n        })\n    }\n\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any {\n        self\n    }\n}\n\nimpl RelationshipStorage for MemoryStorage {\n    fn store_relationship(\u0026mut self, relationship: \u0026EntityRelationship) -\u003e Result\u003c(), EngramError\u003e {\n        let generic = GenericEntity {\n            id: relationship.id.clone(),\n            entity_type: EntityRelationship::entity_type().to_string(),\n            agent: relationship.agent.clone(),\n            timestamp: relationship.timestamp,\n            data: serde_json::to_value(relationship)?,\n        };\n\n        self.store(\u0026generic)?;\n\n        let mut index = self.relationship_index.lock().unwrap();\n        index.add_relationship(relationship);\n\n        Ok(())\n    }\n\n    fn get_relationship(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cEntityRelationship\u003e, EngramError\u003e {\n        if let Some(generic) = self.get(id, EntityRelationship::entity_type())? {\n            if let Ok(relationship) = serde_json::from_value::\u003cEntityRelationship\u003e(generic.data) {\n                return Ok(Some(relationship));\n            }\n        }\n        Ok(None)\n    }\n\n    fn query_relationships(\n        \u0026self,\n        filter: \u0026RelationshipFilter,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let all_rels = self.get_all(EntityRelationship::entity_type())?;\n        let mut relationships = Vec::new();\n\n        for generic in all_rels {\n            if let Ok(relationship) = serde_json::from_value::\u003cEntityRelationship\u003e(generic.data) {\n                if filter.matches(\u0026relationship) {\n                    relationships.push(relationship);\n                }\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn get_entity_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let index = self.relationship_index.lock().unwrap();\n        let rel_ids = index.get_all_relationships(entity_id);\n\n        let mut relationships = Vec::new();\n        for rel_id in \u0026rel_ids {\n            if let Some(rel) = self.get_relationship(\u0026rel_id)? {\n                relationships.push(rel);\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn get_outbound_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let index = self.relationship_index.lock().unwrap();\n        let rel_ids = index.get_outbound(entity_id);\n\n        let mut relationships = Vec::new();\n        for rel_id in \u0026rel_ids {\n            if let Some(rel) = self.get_relationship(\u0026rel_id)? {\n                relationships.push(rel);\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn get_inbound_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e {\n        let index = self.relationship_index.lock().unwrap();\n        let rel_ids = index.get_inbound(entity_id);\n\n        let mut relationships = Vec::new();\n        for rel_id in \u0026rel_ids {\n            if let Some(rel) = self.get_relationship(\u0026rel_id)? {\n                relationships.push(rel);\n            }\n        }\n\n        Ok(relationships)\n    }\n\n    fn find_paths(\n        \u0026self,\n        source_id: \u0026str,\n        target_id: \u0026str,\n        algorithm: TraversalAlgorithm,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003csuper::EntityPath\u003e, EngramError\u003e {\n        match algorithm {\n            TraversalAlgorithm::BreadthFirst =\u003e {\n                let path = super::GraphAnalyzer::bfs(self, source_id, Some(target_id), max_depth)?;\n                if path.len() \u003e 1 \u0026\u0026 path.last() == Some(\u0026target_id.to_string()) {\n                    Ok(vec![super::EntityPath {\n                        entities: path,\n                        relationships: Vec::new(),\n                        total_weight: 0.0,\n                        path_type: super::PathType::Shortest,\n                    }])\n                } else {\n                    Ok(vec![])\n                }\n            }\n            TraversalAlgorithm::DepthFirst =\u003e {\n                let path = super::GraphAnalyzer::dfs(self, source_id, Some(target_id), max_depth)?;\n                if path.len() \u003e 1 \u0026\u0026 path.last() == Some(\u0026target_id.to_string()) {\n                    Ok(vec![super::EntityPath {\n                        entities: path,\n                        relationships: Vec::new(),\n                        total_weight: 0.0,\n                        path_type: super::PathType::Shortest,\n                    }])\n                } else {\n                    Ok(vec![])\n                }\n            }\n            TraversalAlgorithm::Dijkstra =\u003e {\n                if let Some(path) = super::GraphAnalyzer::dijkstra(self, source_id, target_id)? {\n                    Ok(vec![path])\n                } else {\n                    Ok(vec![])\n                }\n            }\n        }\n    }\n\n    fn get_connected_entities(\n        \u0026self,\n        entity_id: \u0026str,\n        algorithm: TraversalAlgorithm,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        match algorithm {\n            TraversalAlgorithm::BreadthFirst =\u003e {\n                super::GraphAnalyzer::bfs(self, entity_id, None, max_depth)\n            }\n            TraversalAlgorithm::DepthFirst =\u003e {\n                super::GraphAnalyzer::dfs(self, entity_id, None, max_depth)\n            }\n            TraversalAlgorithm::Dijkstra =\u003e {\n                super::GraphAnalyzer::bfs(self, entity_id, None, max_depth)\n            }\n        }\n    }\n\n    fn delete_relationship(\u0026mut self, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e {\n        if let Some(relationship) = self.get_relationship(id)? {\n            let mut index = self.relationship_index.lock().unwrap();\n            index.remove_relationship(\u0026relationship);\n        }\n\n        self.delete(id, EntityRelationship::entity_type())\n    }\n\n    fn get_relationship_index(\u0026self) -\u003e Result\u003c\u0026RelationshipIndex, EngramError\u003e {\n        Err(EngramError::Validation(\n            \"Direct index access not supported for MemoryStorage. Use query methods instead.\"\n                .to_string(),\n        ))\n    }\n\n    fn rebuild_relationship_index(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n        let all_rels = self.get_all(EntityRelationship::entity_type())?;\n        let mut index = self.relationship_index.lock().unwrap();\n\n        *index = RelationshipIndex::new();\n\n        for generic in all_rels {\n            if let Ok(relationship) = serde_json::from_value::\u003cEntityRelationship\u003e(generic.data) {\n                index.add_relationship(\u0026relationship);\n            }\n        }\n\n        Ok(())\n    }\n\n    fn get_relationship_stats(\u0026self) -\u003e Result\u003cRelationshipStats, EngramError\u003e {\n        use std::collections::HashMap;\n\n        let all_rels = self.get_all(EntityRelationship::entity_type())?;\n        let mut total_relationships = 0;\n        let mut relationships_by_type: HashMap\u003cEntityRelationType, usize\u003e = HashMap::new();\n        let mut bidirectional_count = 0;\n        let mut entity_connections: HashMap\u003cString, usize\u003e = HashMap::new();\n\n        for generic in all_rels {\n            if let Ok(relationship) = serde_json::from_value::\u003cEntityRelationship\u003e(generic.data) {\n                total_relationships += 1;\n\n                *relationships_by_type\n                    .entry(relationship.relationship_type.clone())\n                    .or_insert(0) += 1;\n\n                if relationship.direction == RelationshipDirection::Bidirectional {\n                    bidirectional_count += 1;\n                }\n\n                *entity_connections\n                    .entry(relationship.source_id.clone())\n                    .or_insert(0) += 1;\n                *entity_connections\n                    .entry(relationship.target_id.clone())\n                    .or_insert(0) += 1;\n            }\n        }\n\n        let entity_count = entity_connections.len();\n        let average_connections_per_entity = if entity_count \u003e 0 {\n            entity_connections.values().sum::\u003cusize\u003e() as f64 / entity_count as f64\n        } else {\n            0.0\n        };\n\n        let most_connected_entity = entity_connections\n            .into_iter()\n            .max_by_key(|(_, count)| *count)\n            .map(|(entity, count)| (entity, count));\n\n        let max_possible_edges = if entity_count \u003e 1 {\n            entity_count * (entity_count - 1)\n        } else {\n            1\n        };\n        let relationship_density = total_relationships as f64 / max_possible_edges as f64;\n\n        Ok(RelationshipStats {\n            total_relationships,\n            relationships_by_type,\n            bidirectional_count,\n            average_connections_per_entity,\n            most_connected_entity,\n            relationship_density,\n        })\n    }\n}\n","traces":[{"line":29,"address":[16360704,16361490,16361515],"length":1,"stats":{"Line":3}},{"line":30,"address":[17657259],"length":1,"stats":{"Line":2}},{"line":31,"address":[19003119],"length":1,"stats":{"Line":3}},{"line":32,"address":[23019415],"length":1,"stats":{"Line":2}},{"line":33,"address":[17657367],"length":1,"stats":{"Line":3}},{"line":34,"address":[16138855],"length":1,"stats":{"Line":2}},{"line":35,"address":[16138871],"length":1,"stats":{"Line":5}},{"line":36,"address":[16360903],"length":1,"stats":{"Line":2}},{"line":37,"address":[16290151],"length":1,"stats":{"Line":5}},{"line":38,"address":[16138919],"length":1,"stats":{"Line":2}},{"line":39,"address":[23480199],"length":1,"stats":{"Line":6}},{"line":40,"address":[16138951],"length":1,"stats":{"Line":2}},{"line":43,"address":[23480231],"length":1,"stats":{"Line":7}},{"line":45,"address":[17354218],"length":1,"stats":{"Line":2}},{"line":46,"address":[16361177],"length":1,"stats":{"Line":7}},{"line":47,"address":[16290529,16290469],"length":1,"stats":{"Line":9}},{"line":53,"address":[14743675,14741872,14743669],"length":1,"stats":{"Line":5}},{"line":55,"address":[23030403],"length":1,"stats":{"Line":1}},{"line":56,"address":[16149851,16149913],"length":1,"stats":{"Line":6}},{"line":57,"address":[23491185,23491251],"length":1,"stats":{"Line":6}},{"line":58,"address":[14742139],"length":1,"stats":{"Line":5}},{"line":59,"address":[16372033,16372107],"length":1,"stats":{"Line":6}},{"line":62,"address":[23031081,23031015],"length":1,"stats":{"Line":12}},{"line":63,"address":[23031229,23031161],"length":1,"stats":{"Line":12}},{"line":67,"address":[23492019],"length":1,"stats":{"Line":6}},{"line":68,"address":[16302162],"length":1,"stats":{"Line":6}},{"line":69,"address":[19014878,19014966],"length":1,"stats":{"Line":12}},{"line":70,"address":[23492469],"length":1,"stats":{"Line":6}},{"line":71,"address":[23031860],"length":1,"stats":{"Line":6}},{"line":73,"address":[14743594],"length":1,"stats":{"Line":6}},{"line":75,"address":[16373494],"length":1,"stats":{"Line":6}},{"line":78,"address":[19009768,19008656,19009787],"length":1,"stats":{"Line":0}},{"line":79,"address":[17663130],"length":1,"stats":{"Line":0}},{"line":80,"address":[17359873,17360015,17359796],"length":1,"stats":{"Line":0}},{"line":81,"address":[17360024,17359954],"length":1,"stats":{"Line":0}},{"line":82,"address":[17360068],"length":1,"stats":{"Line":0}},{"line":86,"address":[23486179,23486269,23486394],"length":1,"stats":{"Line":0}},{"line":88,"address":[16367086],"length":1,"stats":{"Line":0}},{"line":89,"address":[19009239],"length":1,"stats":{"Line":0}},{"line":90,"address":[23486476],"length":1,"stats":{"Line":0}},{"line":91,"address":[17360406],"length":1,"stats":{"Line":0}},{"line":92,"address":[16296570],"length":1,"stats":{"Line":0}},{"line":95,"address":[23486872],"length":1,"stats":{"Line":0}},{"line":97,"address":[23486358],"length":1,"stats":{"Line":0}},{"line":100,"address":[16366875],"length":1,"stats":{"Line":0}},{"line":104,"address":[14735465,14734240,14735459],"length":1,"stats":{"Line":0}},{"line":109,"address":[17660682],"length":1,"stats":{"Line":0}},{"line":110,"address":[16364244],"length":1,"stats":{"Line":0}},{"line":112,"address":[14734499,14734432],"length":1,"stats":{"Line":0}},{"line":113,"address":[16364532,16364676],"length":1,"stats":{"Line":0}},{"line":117,"address":[16364686],"length":1,"stats":{"Line":0}},{"line":118,"address":[16142729,16142789],"length":1,"stats":{"Line":0}},{"line":123,"address":[19006940,19006983],"length":1,"stats":{"Line":0}},{"line":125,"address":[19007051],"length":1,"stats":{"Line":0}},{"line":126,"address":[14735040],"length":1,"stats":{"Line":0}},{"line":127,"address":[16294216],"length":1,"stats":{"Line":0}},{"line":128,"address":[17358161],"length":1,"stats":{"Line":0}},{"line":129,"address":[23484341],"length":1,"stats":{"Line":0}},{"line":132,"address":[17358403],"length":1,"stats":{"Line":0}},{"line":136,"address":[23483805],"length":1,"stats":{"Line":0}},{"line":139,"address":[14735488,14736648],"length":1,"stats":{"Line":0}},{"line":144,"address":[23023984],"length":1,"stats":{"Line":0}},{"line":145,"address":[19007632],"length":1,"stats":{"Line":0}},{"line":147,"address":[23484784,23484851],"length":1,"stats":{"Line":0}},{"line":148,"address":[17662427,17662281],"length":1,"stats":{"Line":0}},{"line":152,"address":[19008087],"length":1,"stats":{"Line":0}},{"line":154,"address":[16144061],"length":1,"stats":{"Line":0}},{"line":155,"address":[23024677],"length":1,"stats":{"Line":0}},{"line":156,"address":[17662685],"length":1,"stats":{"Line":0}},{"line":157,"address":[16144230],"length":1,"stats":{"Line":0}},{"line":158,"address":[23024858],"length":1,"stats":{"Line":0}},{"line":161,"address":[16295720],"length":1,"stats":{"Line":0}},{"line":165,"address":[16143780],"length":1,"stats":{"Line":0}},{"line":168,"address":[17671610,17670176,17672074],"length":1,"stats":{"Line":0}},{"line":169,"address":[16373722],"length":1,"stats":{"Line":0}},{"line":170,"address":[19015724,19015667,19017355],"length":1,"stats":{"Line":0}},{"line":171,"address":[23493216,23493323],"length":1,"stats":{"Line":0}},{"line":172,"address":[16304336,16303337],"length":1,"stats":{"Line":0}},{"line":180,"address":[16303313,16303388],"length":1,"stats":{"Line":0}},{"line":181,"address":[19016128],"length":1,"stats":{"Line":0}},{"line":182,"address":[16374356,16374437],"length":1,"stats":{"Line":0}},{"line":183,"address":[17367681],"length":1,"stats":{"Line":0}},{"line":184,"address":[17671157],"length":1,"stats":{"Line":0}},{"line":192,"address":[16304213],"length":1,"stats":{"Line":0}},{"line":194,"address":[23494257],"length":1,"stats":{"Line":0}},{"line":196,"address":[19015845,19017172],"length":1,"stats":{"Line":0}},{"line":200,"address":[17673803,17673152,17673797],"length":1,"stats":{"Line":0}},{"line":201,"address":[17673200],"length":1,"stats":{"Line":0}},{"line":202,"address":[14746884],"length":1,"stats":{"Line":0}},{"line":204,"address":[14746944,14747011],"length":1,"stats":{"Line":0}},{"line":205,"address":[16155061,16155205],"length":1,"stats":{"Line":0}},{"line":206,"address":[16306466],"length":1,"stats":{"Line":0}},{"line":210,"address":[14747230],"length":1,"stats":{"Line":0}},{"line":213,"address":[16367728],"length":1,"stats":{"Line":0}},{"line":215,"address":[16296968],"length":1,"stats":{"Line":0}},{"line":218,"address":[23483216],"length":1,"stats":{"Line":0}},{"line":219,"address":[16363987],"length":1,"stats":{"Line":0}},{"line":222,"address":[17659584],"length":1,"stats":{"Line":0}},{"line":224,"address":[16363090],"length":1,"stats":{"Line":0}},{"line":227,"address":[23483184],"length":1,"stats":{"Line":0}},{"line":229,"address":[16363954],"length":1,"stats":{"Line":0}},{"line":232,"address":[16364064],"length":1,"stats":{"Line":0}},{"line":234,"address":[23483340],"length":1,"stats":{"Line":0}},{"line":237,"address":[17672912],"length":1,"stats":{"Line":0}},{"line":238,"address":[16376467],"length":1,"stats":{"Line":0}},{"line":239,"address":[14746626],"length":1,"stats":{"Line":0}},{"line":242,"address":[19010480,19011876,19013636],"length":1,"stats":{"Line":1}},{"line":243,"address":[14738626],"length":1,"stats":{"Line":1}},{"line":244,"address":[16368581],"length":1,"stats":{"Line":1}},{"line":246,"address":[17665232,17665156],"length":1,"stats":{"Line":2}},{"line":247,"address":[16147919,16146882],"length":1,"stats":{"Line":2}},{"line":248,"address":[23489191,23489278],"length":1,"stats":{"Line":2}},{"line":253,"address":[16370056,16369973],"length":1,"stats":{"Line":1}},{"line":254,"address":[17363168,17363247],"length":1,"stats":{"Line":0}},{"line":259,"address":[17363198,17363270],"length":1,"stats":{"Line":1}},{"line":260,"address":[16370236,16370174],"length":1,"stats":{"Line":0}},{"line":261,"address":[23028835],"length":1,"stats":{"Line":0}},{"line":267,"address":[16299536,16299436],"length":1,"stats":{"Line":2}},{"line":268,"address":[16148355],"length":1,"stats":{"Line":1}},{"line":269,"address":[23029005,23029074],"length":1,"stats":{"Line":0}},{"line":270,"address":[23489836,23489765],"length":1,"stats":{"Line":0}},{"line":271,"address":[17667203,17667135],"length":1,"stats":{"Line":0}},{"line":276,"address":[23029030],"length":1,"stats":{"Line":1}},{"line":277,"address":[17666974,17667451],"length":1,"stats":{"Line":2}},{"line":278,"address":[23029707,23029659],"length":1,"stats":{"Line":0}},{"line":279,"address":[14741314,14741359],"length":1,"stats":{"Line":0}},{"line":280,"address":[17364344],"length":1,"stats":{"Line":0}},{"line":284,"address":[23490465],"length":1,"stats":{"Line":0}},{"line":285,"address":[23490473],"length":1,"stats":{"Line":0}},{"line":289,"address":[17667619],"length":1,"stats":{"Line":1}},{"line":294,"address":[16371261],"length":1,"stats":{"Line":1}},{"line":295,"address":[14741416],"length":1,"stats":{"Line":1}},{"line":296,"address":[17667875],"length":1,"stats":{"Line":1}},{"line":297,"address":[14741563],"length":1,"stats":{"Line":1}},{"line":298,"address":[17667975],"length":1,"stats":{"Line":1}},{"line":301,"address":[17668197],"length":1,"stats":{"Line":1}},{"line":305,"address":[16146947],"length":1,"stats":{"Line":1}},{"line":306,"address":[17665539,17665633],"length":1,"stats":{"Line":0}},{"line":307,"address":[16399213],"length":1,"stats":{"Line":0}},{"line":308,"address":[16343188],"length":1,"stats":{"Line":0}},{"line":310,"address":[16343217],"length":1,"stats":{"Line":0}},{"line":311,"address":[17639877],"length":1,"stats":{"Line":0}},{"line":312,"address":[23462644],"length":1,"stats":{"Line":0}},{"line":313,"address":[16399518],"length":1,"stats":{"Line":0}},{"line":314,"address":[23462768],"length":1,"stats":{"Line":0}},{"line":316,"address":[17640046],"length":1,"stats":{"Line":0}},{"line":317,"address":[23462564],"length":1,"stats":{"Line":0}},{"line":318,"address":[17336427],"length":1,"stats":{"Line":0}},{"line":321,"address":[16272565],"length":1,"stats":{"Line":0}},{"line":322,"address":[17640072],"length":1,"stats":{"Line":0}},{"line":323,"address":[17640056],"length":1,"stats":{"Line":0}},{"line":327,"address":[23462253,23462224],"length":1,"stats":{"Line":4}},{"line":328,"address":[23001643],"length":1,"stats":{"Line":0}},{"line":329,"address":[23001613],"length":1,"stats":{"Line":1}},{"line":333,"address":[16298374,16298454],"length":1,"stats":{"Line":2}},{"line":334,"address":[16369230],"length":1,"stats":{"Line":1}},{"line":335,"address":[16369285],"length":1,"stats":{"Line":1}},{"line":337,"address":[23488596],"length":1,"stats":{"Line":1}},{"line":338,"address":[16147372,16147441],"length":1,"stats":{"Line":2}},{"line":339,"address":[14739648],"length":1,"stats":{"Line":1}},{"line":341,"address":[14739481,14739537],"length":1,"stats":{"Line":0}},{"line":344,"address":[19011826,19011403,19011630],"length":1,"stats":{"Line":2}},{"line":346,"address":[17666264],"length":1,"stats":{"Line":1}},{"line":347,"address":[14739848],"length":1,"stats":{"Line":1}},{"line":353,"address":[14734040,14733232,14734046],"length":1,"stats":{"Line":0}},{"line":361,"address":[14733387],"length":1,"stats":{"Line":0}},{"line":367,"address":[19005907,19006087],"length":1,"stats":{"Line":0}},{"line":368,"address":[17356836,17356900,17356881],"length":1,"stats":{"Line":0}},{"line":371,"address":[17356865],"length":1,"stats":{"Line":0}},{"line":374,"address":[16292282,16292276,16291072],"length":1,"stats":{"Line":0}},{"line":381,"address":[23020548],"length":1,"stats":{"Line":0}},{"line":386,"address":[17355516],"length":1,"stats":{"Line":0}},{"line":387,"address":[16140737,16140460],"length":1,"stats":{"Line":0}},{"line":388,"address":[16140614,16140503],"length":1,"stats":{"Line":0}},{"line":392,"address":[16291719,16291990],"length":1,"stats":{"Line":0}},{"line":393,"address":[17659428],"length":1,"stats":{"Line":0}},{"line":396,"address":[17664912,17664918,17664256],"length":1,"stats":{"Line":0}},{"line":403,"address":[23487284,23487349],"length":1,"stats":{"Line":0}},{"line":404,"address":[23026901],"length":1,"stats":{"Line":0}},{"line":407,"address":[14746499,14745712,14746505],"length":1,"stats":{"Line":1}},{"line":409,"address":[14745784],"length":1,"stats":{"Line":1}},{"line":415,"address":[23034637],"length":1,"stats":{"Line":1}},{"line":416,"address":[17672755],"length":1,"stats":{"Line":1}},{"line":419,"address":[16361552],"length":1,"stats":{"Line":0}},{"line":420,"address":[16290856,16290872],"length":1,"stats":{"Line":0}},{"line":421,"address":[23480950,23481029],"length":1,"stats":{"Line":0}},{"line":423,"address":[17658273],"length":1,"stats":{"Line":0}},{"line":426,"address":[17675133,17675139,17673824],"length":1,"stats":{"Line":0}},{"line":427,"address":[14747478],"length":1,"stats":{"Line":0}},{"line":428,"address":[23496675],"length":1,"stats":{"Line":0}},{"line":429,"address":[17370543],"length":1,"stats":{"Line":0}},{"line":430,"address":[23496750],"length":1,"stats":{"Line":0}},{"line":431,"address":[23496810],"length":1,"stats":{"Line":0}},{"line":433,"address":[14747702,14747772],"length":1,"stats":{"Line":0}},{"line":434,"address":[16156115,16156084,16155789],"length":1,"stats":{"Line":0}},{"line":436,"address":[16307451,16307512],"length":1,"stats":{"Line":0}},{"line":437,"address":[16378108,16378151],"length":1,"stats":{"Line":0}},{"line":438,"address":[19019873],"length":1,"stats":{"Line":0}},{"line":439,"address":[16307658,16307601],"length":1,"stats":{"Line":0}},{"line":440,"address":[16307489,16307533],"length":1,"stats":{"Line":0}},{"line":441,"address":[17674848],"length":1,"stats":{"Line":0}},{"line":443,"address":[16156391,16156431],"length":1,"stats":{"Line":0}},{"line":444,"address":[16378482,16378600,16378543],"length":1,"stats":{"Line":0}},{"line":447,"address":[23497181],"length":1,"stats":{"Line":0}},{"line":448,"address":[23036415],"length":1,"stats":{"Line":0}},{"line":449,"address":[23036428],"length":1,"stats":{"Line":0}},{"line":450,"address":[23036454],"length":1,"stats":{"Line":0}},{"line":451,"address":[17371013],"length":1,"stats":{"Line":0}},{"line":452,"address":[16377922],"length":1,"stats":{"Line":0}},{"line":456,"address":[19015520],"length":1,"stats":{"Line":0}},{"line":462,"address":[16349040,16350101,16350120],"length":1,"stats":{"Line":0}},{"line":464,"address":[16127075],"length":1,"stats":{"Line":0}},{"line":465,"address":[16127171,16127096],"length":1,"stats":{"Line":0}},{"line":466,"address":[17342315],"length":1,"stats":{"Line":0}},{"line":467,"address":[23007856],"length":1,"stats":{"Line":0}},{"line":468,"address":[23007944,23007884],"length":1,"stats":{"Line":0}},{"line":471,"address":[16278944,16278879],"length":1,"stats":{"Line":0}},{"line":473,"address":[23469102],"length":1,"stats":{"Line":0}},{"line":474,"address":[23469207,23469283],"length":1,"stats":{"Line":0}},{"line":476,"address":[23469299],"length":1,"stats":{"Line":0}},{"line":479,"address":[17341905,17341024,17341911],"length":1,"stats":{"Line":0}},{"line":480,"address":[16125960],"length":1,"stats":{"Line":0}},{"line":481,"address":[17341567,17341632,17341424],"length":1,"stats":{"Line":0}},{"line":482,"address":[14718682],"length":1,"stats":{"Line":0}},{"line":485,"address":[16126368],"length":1,"stats":{"Line":0}},{"line":488,"address":[16350944,16352283,16352516],"length":1,"stats":{"Line":0}},{"line":492,"address":[23470395,23470235],"length":1,"stats":{"Line":0}},{"line":493,"address":[17647719],"length":1,"stats":{"Line":0}},{"line":495,"address":[17647779,17648016,17647881],"length":1,"stats":{"Line":0}},{"line":496,"address":[16129657,16130170,16129899,16129964],"length":1,"stats":{"Line":0}},{"line":497,"address":[23471281,23471341],"length":1,"stats":{"Line":0}},{"line":498,"address":[23010687],"length":1,"stats":{"Line":0}},{"line":503,"address":[17344863],"length":1,"stats":{"Line":0}},{"line":506,"address":[17653490,17653496,17652544],"length":1,"stats":{"Line":0}},{"line":510,"address":[14726224],"length":1,"stats":{"Line":0}},{"line":511,"address":[16134148,16134225],"length":1,"stats":{"Line":0}},{"line":513,"address":[23475508],"length":1,"stats":{"Line":0}},{"line":514,"address":[17349424,17349504],"length":1,"stats":{"Line":0}},{"line":515,"address":[16285732,16285883],"length":1,"stats":{"Line":0}},{"line":516,"address":[16356900],"length":1,"stats":{"Line":0}},{"line":520,"address":[23015106],"length":1,"stats":{"Line":0}},{"line":523,"address":[23016560,23017512,23017506],"length":1,"stats":{"Line":0}},{"line":527,"address":[23016624],"length":1,"stats":{"Line":0}},{"line":528,"address":[14728244,14728321],"length":1,"stats":{"Line":0}},{"line":530,"address":[17351316],"length":1,"stats":{"Line":0}},{"line":531,"address":[17351456,17351376],"length":1,"stats":{"Line":0}},{"line":532,"address":[23477700,23477851],"length":1,"stats":{"Line":0}},{"line":533,"address":[14728980],"length":1,"stats":{"Line":0}},{"line":537,"address":[17351586],"length":1,"stats":{"Line":0}},{"line":540,"address":[14727136,14728088,14728082],"length":1,"stats":{"Line":0}},{"line":544,"address":[16135056],"length":1,"stats":{"Line":0}},{"line":545,"address":[23015793,23015716],"length":1,"stats":{"Line":0}},{"line":547,"address":[17350340],"length":1,"stats":{"Line":0}},{"line":548,"address":[18999904,18999828],"length":1,"stats":{"Line":0}},{"line":549,"address":[16286859,16286708],"length":1,"stats":{"Line":0}},{"line":550,"address":[17654388],"length":1,"stats":{"Line":0}},{"line":554,"address":[19000034],"length":1,"stats":{"Line":0}},{"line":557,"address":[23002992,23004720,23004750],"length":1,"stats":{"Line":0}},{"line":564,"address":[16273828],"length":1,"stats":{"Line":0}},{"line":566,"address":[14714848,14715190,14715258],"length":1,"stats":{"Line":0}},{"line":567,"address":[16345306,16345278,16345202,16346097],"length":1,"stats":{"Line":0}},{"line":568,"address":[23465398,23465013,23464885],"length":1,"stats":{"Line":0}},{"line":569,"address":[16274894],"length":1,"stats":{"Line":0}},{"line":570,"address":[23004278],"length":1,"stats":{"Line":0}},{"line":575,"address":[18988293,18988554],"length":1,"stats":{"Line":0}},{"line":579,"address":[18989254,18987864,18989187],"length":1,"stats":{"Line":0}},{"line":580,"address":[23005020,23004922,23005805,23004992],"length":1,"stats":{"Line":0}},{"line":581,"address":[18990235,18989737,18989865],"length":1,"stats":{"Line":0}},{"line":582,"address":[14716922],"length":1,"stats":{"Line":0}},{"line":583,"address":[16124818],"length":1,"stats":{"Line":0}},{"line":588,"address":[23004998,23005273],"length":1,"stats":{"Line":0}},{"line":592,"address":[18990553,18990837,18987984,18990269],"length":1,"stats":{"Line":0}},{"line":593,"address":[23006217,23006094],"length":1,"stats":{"Line":0}},{"line":595,"address":[23466778],"length":1,"stats":{"Line":0}},{"line":601,"address":[23471808],"length":1,"stats":{"Line":0}},{"line":607,"address":[17649181],"length":1,"stats":{"Line":0}},{"line":609,"address":[17649242],"length":1,"stats":{"Line":0}},{"line":612,"address":[23011356],"length":1,"stats":{"Line":0}},{"line":615,"address":[23011406],"length":1,"stats":{"Line":0}},{"line":620,"address":[16280132,16280138,16279552],"length":1,"stats":{"Line":0}},{"line":621,"address":[16350376],"length":1,"stats":{"Line":0}},{"line":622,"address":[17647090,17647202],"length":1,"stats":{"Line":0}},{"line":623,"address":[17647355,17647282],"length":1,"stats":{"Line":0}},{"line":626,"address":[14720726],"length":1,"stats":{"Line":0}},{"line":629,"address":[16130848],"length":1,"stats":{"Line":0}},{"line":630,"address":[16282141],"length":1,"stats":{"Line":0}},{"line":632,"address":[16130866],"length":1,"stats":{"Line":0}},{"line":636,"address":[16360665,16358960,16360410],"length":1,"stats":{"Line":0}},{"line":637,"address":[23478403,23478238],"length":1,"stats":{"Line":0}},{"line":638,"address":[17352388,17352322],"length":1,"stats":{"Line":0}},{"line":640,"address":[23478612,23478766,23478707,23479891,23478675],"length":1,"stats":{"Line":0}},{"line":642,"address":[17352715,17352911],"length":1,"stats":{"Line":0}},{"line":643,"address":[19002619,19002364,19002526],"length":1,"stats":{"Line":0}},{"line":644,"address":[16289477,16289547],"length":1,"stats":{"Line":0}},{"line":648,"address":[14730187],"length":1,"stats":{"Line":0}},{"line":651,"address":[16284121,16285230,16282208],"length":1,"stats":{"Line":0}},{"line":654,"address":[17346300,17346119],"length":1,"stats":{"Line":0}},{"line":655,"address":[17346372],"length":1,"stats":{"Line":0}},{"line":656,"address":[23472528],"length":1,"stats":{"Line":0}},{"line":657,"address":[17649852],"length":1,"stats":{"Line":0}},{"line":658,"address":[23472600],"length":1,"stats":{"Line":0}},{"line":660,"address":[14723540,14723656,14723791],"length":1,"stats":{"Line":0}},{"line":661,"address":[16132923,16131816,16132988],"length":1,"stats":{"Line":0}},{"line":662,"address":[16284323,16284262],"length":1,"stats":{"Line":0}},{"line":664,"address":[17348328,17348387],"length":1,"stats":{"Line":0}},{"line":665,"address":[16284300,16284388],"length":1,"stats":{"Line":0}},{"line":666,"address":[16284423],"length":1,"stats":{"Line":0}},{"line":668,"address":[17651769,17651820,17651891],"length":1,"stats":{"Line":0}},{"line":669,"address":[17651853,17651893],"length":1,"stats":{"Line":0}},{"line":672,"address":[16355470,16355530],"length":1,"stats":{"Line":0}},{"line":673,"address":[16133386,16133298],"length":1,"stats":{"Line":0}},{"line":674,"address":[16284669],"length":1,"stats":{"Line":0}},{"line":675,"address":[16284906,16284851],"length":1,"stats":{"Line":0}},{"line":676,"address":[23014079,23014127],"length":1,"stats":{"Line":0}},{"line":677,"address":[17348690],"length":1,"stats":{"Line":0}},{"line":681,"address":[23473161],"length":1,"stats":{"Line":0}},{"line":682,"address":[23473204,23473222,23473453],"length":1,"stats":{"Line":0}},{"line":683,"address":[23473224,23473334],"length":1,"stats":{"Line":0}},{"line":685,"address":[18996655],"length":1,"stats":{"Line":0}},{"line":688,"address":[18996692],"length":1,"stats":{"Line":0}},{"line":690,"address":[17636090,17636080],"length":1,"stats":{"Line":0}},{"line":691,"address":[14724365],"length":1,"stats":{"Line":0}},{"line":693,"address":[18996945,18997516,18996963],"length":1,"stats":{"Line":0}},{"line":694,"address":[18997508,18996973,18997521,18997428],"length":1,"stats":{"Line":0}},{"line":696,"address":[17347382],"length":1,"stats":{"Line":0}},{"line":698,"address":[18997000],"length":1,"stats":{"Line":0}},{"line":700,"address":[14724681],"length":1,"stats":{"Line":0}},{"line":701,"address":[14724545],"length":1,"stats":{"Line":0}},{"line":702,"address":[18997103],"length":1,"stats":{"Line":0}},{"line":703,"address":[23473709],"length":1,"stats":{"Line":0}},{"line":704,"address":[16132458],"length":1,"stats":{"Line":0}},{"line":705,"address":[16132473],"length":1,"stats":{"Line":0}}],"covered":66,"coverable":332},{"path":["/","home","shift","code","vincents-ai","engram","src","storage","mod.rs"],"content":"//! Storage layer for Engram system\n//!\n//! Provides Git-based persistence with content-addressable storage\n//! and multi-agent synchronization capabilities.\n\npub mod git_refs_storage;\npub mod git_storage;\npub mod memory_entity;\npub mod memory_only_storage;\npub mod relationship_storage;\n\npub use git_refs_storage::*;\npub use git_storage::*;\npub use memory_entity::*;\npub use memory_only_storage::*;\npub use relationship_storage::*;\n\nuse crate::entities::GenericEntity;\nuse crate::error::EngramError;\nuse serde_json::Value;\nuse std::collections::HashMap;\n\n/// Query filter for entity searches\n#[derive(Debug, Clone)]\npub struct QueryFilter {\n    pub entity_type: Option\u003cString\u003e,\n    pub agent: Option\u003cString\u003e,\n    pub text_search: Option\u003cString\u003e,\n    pub field_filters: HashMap\u003cString, Value\u003e,\n    pub time_range: Option\u003cTimeRange\u003e,\n    pub sort_by: Option\u003cString\u003e,\n    pub sort_order: SortOrder,\n    pub limit: Option\u003cusize\u003e,\n    pub offset: Option\u003cusize\u003e,\n}\n\nimpl Default for QueryFilter {\n    fn default() -\u003e Self {\n        Self {\n            entity_type: None,\n            agent: None,\n            text_search: None,\n            field_filters: HashMap::new(),\n            time_range: None,\n            sort_by: None,\n            sort_order: SortOrder::Desc,\n            limit: Some(50),\n            offset: Some(0),\n        }\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct TimeRange {\n    pub start: chrono::DateTime\u003cchrono::Utc\u003e,\n    pub end: chrono::DateTime\u003cchrono::Utc\u003e,\n}\n\n#[derive(Debug, Clone)]\npub enum SortOrder {\n    Asc,\n    Desc,\n}\n\n/// Query result with pagination info\n#[derive(Debug, Clone)]\npub struct QueryResult {\n    pub entities: Vec\u003cGenericEntity\u003e,\n    pub total_count: usize,\n    pub has_more: bool,\n}\n\n/// Storage trait for different storage backends\npub trait Storage: Send {\n    /// Store a memory entity\n    fn store(\u0026mut self, entity: \u0026GenericEntity) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// Retrieve an entity by ID and type\n    fn get(\u0026self, id: \u0026str, entity_type: \u0026str) -\u003e Result\u003cOption\u003cGenericEntity\u003e, EngramError\u003e;\n\n    /// Advanced query with filtering, sorting, and pagination\n    fn query(\u0026self, filter: \u0026QueryFilter) -\u003e Result\u003cQueryResult, EngramError\u003e;\n\n    /// Query entities by agent\n    fn query_by_agent(\n        \u0026self,\n        agent: \u0026str,\n        entity_type: Option\u003c\u0026str\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e;\n\n    /// Query entities by time range\n    fn query_by_time_range(\n        \u0026self,\n        start: chrono::DateTime\u003cchrono::Utc\u003e,\n        end: chrono::DateTime\u003cchrono::Utc\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e;\n\n    /// Query entities by type with optional filters\n    fn query_by_type(\n        \u0026self,\n        entity_type: \u0026str,\n        filters: Option\u003c\u0026HashMap\u003cString, Value\u003e\u003e,\n        limit: Option\u003cusize\u003e,\n        offset: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cQueryResult, EngramError\u003e;\n\n    /// Text search across entities\n    fn text_search(\n        \u0026self,\n        query: \u0026str,\n        entity_types: Option\u003c\u0026[String]\u003e,\n        limit: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e;\n\n    /// Count entities matching criteria\n    fn count(\u0026self, filter: \u0026QueryFilter) -\u003e Result\u003cusize, EngramError\u003e;\n\n    /// Delete an entity\n    fn delete(\u0026mut self, id: \u0026str, entity_type: \u0026str) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// List all entity IDs of a type\n    fn list_ids(\u0026self, entity_type: \u0026str) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e;\n\n    /// Get all entities of a specific type\n    fn get_all(\u0026self, entity_type: \u0026str) -\u003e Result\u003cVec\u003cGenericEntity\u003e, EngramError\u003e;\n\n    /// Sync with remote repository\n    fn sync(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// Get current branch\n    fn current_branch(\u0026self) -\u003e Result\u003cString, EngramError\u003e;\n\n    /// Create a new branch\n    fn create_branch(\u0026mut self, branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// Switch to a branch\n    fn switch_branch(\u0026mut self, branch_name: \u0026str) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// Merge branches\n    fn merge_branches(\u0026mut self, source: \u0026str, target: \u0026str) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// Get commit history\n    fn history(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cVec\u003cGitCommit\u003e, EngramError\u003e;\n\n    /// Bulk operations\n    fn bulk_store(\u0026mut self, entities: \u0026[GenericEntity]) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// Get statistics about stored entities\n    fn get_stats(\u0026self) -\u003e Result\u003cStorageStats, EngramError\u003e;\n\n    /// Cast to concrete type for accessing specific implementations\n    fn as_any(\u0026self) -\u003e \u0026dyn std::any::Any;\n}\n\n/// Git commit information\n#[derive(Debug, Clone)]\npub struct GitCommit {\n    pub id: String,\n    pub author: String,\n    pub message: String,\n    pub timestamp: chrono::DateTime\u003cchrono::Utc\u003e,\n    pub parents: Vec\u003cString\u003e,\n}\n\n/// Storage statistics\n#[derive(Debug, Clone, Default)]\npub struct StorageStats {\n    pub total_entities: usize,\n    pub entities_by_type: HashMap\u003cString, usize\u003e,\n    pub entities_by_agent: HashMap\u003cString, usize\u003e,\n    pub total_storage_size: u64,\n    pub last_sync: Option\u003cchrono::DateTime\u003cchrono::Utc\u003e\u003e,\n}\n\n/// Sync strategy for multi-agent collaboration\n#[derive(Debug, Clone)]\npub enum SyncStrategy {\n    LatestWins,\n    PriorityWins { priority_agent: String },\n    IntelligentMerge,\n    ManualResolution,\n}\n\n/// Conflict resolution result\n#[derive(Debug, Clone)]\npub struct ConflictResolution {\n    pub entity_id: String,\n    pub entity_type: String,\n    pub strategy_used: SyncStrategy,\n    pub winner: String,\n    pub conflicts_detected: Vec\u003cString\u003e,\n}\n\n/// Sync result information\n#[derive(Debug, Clone)]\npub struct SyncResult {\n    pub entities_synced: usize,\n    pub conflicts_resolved: Vec\u003cConflictResolution\u003e,\n    pub errors: Vec\u003cString\u003e,\n    pub timestamp: chrono::DateTime\u003cchrono::Utc\u003e,\n    pub synced_agents: Vec\u003cString\u003e,\n    pub merged_entities: usize,\n    pub duration_ms: u64,\n}\n\n/// Remote sync direction\n#[derive(Debug, Clone)]\npub enum RemoteSyncDirection {\n    Pull,\n    Push,\n    BiDirectional,\n}\n\n/// Remote authentication configuration\n#[derive(Debug, Clone)]\npub struct RemoteAuth {\n    pub auth_type: String, // \"http\", \"ssh\", \"none\"\n    pub username: Option\u003cString\u003e,\n    pub password: Option\u003cString\u003e,\n    pub key_path: Option\u003cString\u003e,\n}\n\n/// Remote sync options\n#[derive(Debug, Clone)]\npub struct RemoteSyncOptions {\n    pub remote: String,\n    pub direction: RemoteSyncDirection,\n    pub branch: Option\u003cString\u003e,\n    pub agent_ids: Vec\u003cString\u003e,\n    pub dry_run: bool,\n    pub auth: RemoteAuth,\n}\n","traces":[{"line":38,"address":[20710978,20711016,20710608],"length":1,"stats":{"Line":6}},{"line":43,"address":[20710649],"length":1,"stats":{"Line":9}}],"covered":2,"coverable":2},{"path":["/","home","shift","code","vincents-ai","engram","src","storage","relationship_storage.rs"],"content":"//! Relationship-specific storage operations and graph indexing\n\nuse std::cmp::{Ordering, Reverse};\nuse std::collections::{HashMap, HashSet, VecDeque};\n\nuse super::Storage;\nuse crate::entities::{\n    Entity, EntityRelationType, EntityRelationship, RelationshipDirection, RelationshipFilter,\n};\nuse crate::error::EngramError;\n\n/// Path in the entity graph\n#[derive(Debug, Clone)]\npub struct EntityPath {\n    pub entities: Vec\u003cString\u003e,\n    pub relationships: Vec\u003cString\u003e,\n    pub total_weight: f64,\n    pub path_type: PathType,\n}\n\n#[derive(Debug, Clone, PartialEq)]\npub enum PathType {\n    Shortest,\n    Strongest,\n    AllPaths,\n}\n\n/// Graph traversal algorithm type\n#[derive(Debug, Clone)]\npub enum TraversalAlgorithm {\n    BreadthFirst,\n    DepthFirst,\n    Dijkstra,\n}\n\n/// Relationship index for efficient graph operations\n#[derive(Debug, Clone, Default)]\npub struct RelationshipIndex {\n    /// Outbound relationships from each entity\n    pub outbound: HashMap\u003cString, Vec\u003cString\u003e\u003e,\n    /// Inbound relationships to each entity  \n    pub inbound: HashMap\u003cString, Vec\u003cString\u003e\u003e,\n    /// Relationships by type\n    pub by_type: HashMap\u003cEntityRelationType, Vec\u003cString\u003e\u003e,\n    /// Bidirectional relationships\n    pub bidirectional: HashSet\u003cString\u003e,\n}\n\nimpl RelationshipIndex {\n    /// Create new empty index\n    pub fn new() -\u003e Self {\n        Self::default()\n    }\n\n    /// Add relationship to index\n    pub fn add_relationship(\u0026mut self, relationship: \u0026EntityRelationship) {\n        let rel_id = relationship.id.clone();\n\n        self.outbound\n            .entry(relationship.source_id.clone())\n            .or_insert_with(Vec::new)\n            .push(rel_id.clone());\n\n        self.inbound\n            .entry(relationship.target_id.clone())\n            .or_insert_with(Vec::new)\n            .push(rel_id.clone());\n\n        self.by_type\n            .entry(relationship.relationship_type.clone())\n            .or_insert_with(Vec::new)\n            .push(rel_id.clone());\n\n        if relationship.direction == RelationshipDirection::Bidirectional {\n            self.bidirectional.insert(rel_id);\n        }\n    }\n\n    pub fn remove_relationship(\u0026mut self, relationship: \u0026EntityRelationship) {\n        let rel_id = \u0026relationship.id;\n\n        if let Some(outbound) = self.outbound.get_mut(\u0026relationship.source_id) {\n            outbound.retain(|id| id != rel_id);\n        }\n\n        if let Some(inbound) = self.inbound.get_mut(\u0026relationship.target_id) {\n            inbound.retain(|id| id != rel_id);\n        }\n\n        if let Some(type_rels) = self.by_type.get_mut(\u0026relationship.relationship_type) {\n            type_rels.retain(|id| id != rel_id);\n        }\n\n        self.bidirectional.remove(rel_id);\n    }\n\n    /// Get all outbound relationship IDs for an entity\n    pub fn get_outbound(\u0026self, entity_id: \u0026str) -\u003e Vec\u003cString\u003e {\n        self.outbound.get(entity_id).cloned().unwrap_or_default()\n    }\n\n    /// Get all inbound relationship IDs for an entity\n    pub fn get_inbound(\u0026self, entity_id: \u0026str) -\u003e Vec\u003cString\u003e {\n        self.inbound.get(entity_id).cloned().unwrap_or_default()\n    }\n\n    /// Get all relationship IDs for an entity (both directions)\n    pub fn get_all_relationships(\u0026self, entity_id: \u0026str) -\u003e Vec\u003cString\u003e {\n        let mut all = self.get_outbound(entity_id);\n        all.extend(self.get_inbound(entity_id));\n        all.sort();\n        all.dedup();\n        all\n    }\n\n    /// Get relationships by type\n    pub fn get_by_type(\u0026self, rel_type: \u0026EntityRelationType) -\u003e Vec\u003cString\u003e {\n        self.by_type.get(rel_type).cloned().unwrap_or_default()\n    }\n\n    /// Check if relationship is bidirectional\n    pub fn is_bidirectional(\u0026self, rel_id: \u0026str) -\u003e bool {\n        self.bidirectional.contains(rel_id)\n    }\n\n    /// Clear all relationships from the index\n    pub fn clear(\u0026mut self) {\n        self.outbound.clear();\n        self.inbound.clear();\n        self.by_type.clear();\n        self.bidirectional.clear();\n    }\n}\n\n/// Extended storage trait for relationship operations\npub trait RelationshipStorage: Storage {\n    /// Store a relationship with index updates\n    fn store_relationship(\u0026mut self, relationship: \u0026EntityRelationship) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// Get a relationship by ID\n    fn get_relationship(\u0026self, id: \u0026str) -\u003e Result\u003cOption\u003cEntityRelationship\u003e, EngramError\u003e;\n\n    /// Query relationships with filtering\n    fn query_relationships(\n        \u0026self,\n        filter: \u0026RelationshipFilter,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e;\n\n    /// Get all relationships involving an entity (either direction)\n    fn get_entity_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e;\n\n    /// Get outbound relationships from an entity\n    fn get_outbound_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e;\n\n    /// Get inbound relationships to an entity\n    fn get_inbound_relationships(\n        \u0026self,\n        entity_id: \u0026str,\n    ) -\u003e Result\u003cVec\u003cEntityRelationship\u003e, EngramError\u003e;\n\n    /// Find paths between entities\n    fn find_paths(\n        \u0026self,\n        source_id: \u0026str,\n        target_id: \u0026str,\n        algorithm: TraversalAlgorithm,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cEntityPath\u003e, EngramError\u003e;\n\n    /// Find shortest path between entities\n    fn find_shortest_path(\n        \u0026self,\n        source_id: \u0026str,\n        target_id: \u0026str,\n    ) -\u003e Result\u003cOption\u003cEntityPath\u003e, EngramError\u003e {\n        let paths = self.find_paths(source_id, target_id, TraversalAlgorithm::Dijkstra, None)?;\n        Ok(paths\n            .into_iter()\n            .find(|p| p.path_type == PathType::Shortest))\n    }\n\n    /// Get all connected entities (graph traversal)\n    fn get_connected_entities(\n        \u0026self,\n        entity_id: \u0026str,\n        algorithm: TraversalAlgorithm,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e;\n\n    fn delete_relationship(\u0026mut self, id: \u0026str) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// Get relationship index for direct access\n    fn get_relationship_index(\u0026self) -\u003e Result\u003c\u0026RelationshipIndex, EngramError\u003e;\n\n    /// Rebuild relationship index from stored relationships\n    fn rebuild_relationship_index(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e;\n\n    /// Validate relationship constraints before storing\n    fn validate_relationship_constraints(\n        \u0026self,\n        relationship: \u0026EntityRelationship,\n    ) -\u003e Result\u003c(), EngramError\u003e {\n        relationship\n            .validate_entity()\n            .map_err(|e| EngramError::Validation(e.to_string()))?;\n\n        let outbound_count = self\n            .get_outbound_relationships(\u0026relationship.source_id)?\n            .len();\n        let inbound_count = self\n            .get_inbound_relationships(\u0026relationship.target_id)?\n            .len();\n\n        if let Some(max_outbound) = relationship.constraints.max_outbound {\n            if outbound_count \u003e= max_outbound {\n                return Err(EngramError::Validation(format!(\n                    \"Maximum outbound relationships ({}) exceeded for entity {}\",\n                    max_outbound, relationship.source_id\n                )));\n            }\n        }\n\n        if let Some(max_inbound) = relationship.constraints.max_inbound {\n            if inbound_count \u003e= max_inbound {\n                return Err(EngramError::Validation(format!(\n                    \"Maximum inbound relationships ({}) exceeded for entity {}\",\n                    max_inbound, relationship.target_id\n                )));\n            }\n        }\n\n        if !relationship.constraints.allow_cycles {\n            if self.would_create_cycle(relationship)? {\n                return Err(EngramError::Validation(\n                    \"Relationship would create a cycle, which is not allowed\".to_string(),\n                ));\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Check if adding a relationship would create a cycle\n    fn would_create_cycle(\u0026self, relationship: \u0026EntityRelationship) -\u003e Result\u003cbool, EngramError\u003e {\n        let paths = self.find_paths(\n            \u0026relationship.target_id,\n            \u0026relationship.source_id,\n            TraversalAlgorithm::BreadthFirst,\n            None,\n        )?;\n        Ok(!paths.is_empty())\n    }\n\n    /// Get relationship statistics\n    fn get_relationship_stats(\u0026self) -\u003e Result\u003cRelationshipStats, EngramError\u003e;\n}\n\n/// Relationship storage statistics\n#[derive(Debug, Clone)]\npub struct RelationshipStats {\n    pub total_relationships: usize,\n    pub relationships_by_type: HashMap\u003cEntityRelationType, usize\u003e,\n    pub bidirectional_count: usize,\n    pub average_connections_per_entity: f64,\n    pub most_connected_entity: Option\u003c(String, usize)\u003e,\n    pub relationship_density: f64,\n}\n\n/// State for Dijkstra's algorithm priority queue\n#[derive(Debug, Clone)]\nstruct State {\n    cost: i64, // Use i64 for ordering (multiply by 1000 to get precision)\n    entity: String,\n}\n\nimpl PartialEq for State {\n    fn eq(\u0026self, other: \u0026Self) -\u003e bool {\n        self.cost == other.cost\n    }\n}\n\nimpl Eq for State {}\n\nimpl PartialOrd for State {\n    fn partial_cmp(\u0026self, other: \u0026Self) -\u003e Option\u003cOrdering\u003e {\n        Some(self.cmp(other))\n    }\n}\n\nimpl Ord for State {\n    fn cmp(\u0026self, other: \u0026Self) -\u003e Ordering {\n        self.cost.cmp(\u0026other.cost)\n    }\n}\n\n/// Graph analysis operations\npub struct GraphAnalyzer;\n\nimpl GraphAnalyzer {\n    /// Perform breadth-first search\n    pub fn bfs\u003cS: RelationshipStorage\u003e(\n        storage: \u0026S,\n        start_entity: \u0026str,\n        target_entity: Option\u003c\u0026str\u003e,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        let mut visited = HashSet::new();\n        let mut queue = VecDeque::new();\n        let mut result = Vec::new();\n\n        queue.push_back((start_entity.to_string(), 0));\n        visited.insert(start_entity.to_string());\n\n        while let Some((entity_id, depth)) = queue.pop_front() {\n            result.push(entity_id.clone());\n\n            if let Some(target) = target_entity {\n                if entity_id == target {\n                    break;\n                }\n            }\n\n            if let Some(max_d) = max_depth {\n                if depth \u003e= max_d {\n                    continue;\n                }\n            }\n\n            let relationships = storage.get_outbound_relationships(\u0026entity_id)?;\n            for rel in relationships {\n                if rel.active {\n                    if !visited.contains(\u0026rel.target_id) {\n                        visited.insert(rel.target_id.clone());\n                        queue.push_back((rel.target_id, depth + 1));\n                    }\n                }\n            }\n\n            let inbound = storage.get_inbound_relationships(\u0026entity_id)?;\n            for rel in inbound {\n                if rel.active \u0026\u0026 rel.direction == RelationshipDirection::Bidirectional {\n                    if !visited.contains(\u0026rel.source_id) {\n                        visited.insert(rel.source_id.clone());\n                        queue.push_back((rel.source_id, depth + 1));\n                    }\n                }\n            }\n        }\n\n        Ok(result)\n    }\n\n    /// Perform depth-first search\n    pub fn dfs\u003cS: RelationshipStorage\u003e(\n        storage: \u0026S,\n        start_entity: \u0026str,\n        target_entity: Option\u003c\u0026str\u003e,\n        max_depth: Option\u003cusize\u003e,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        let mut visited = HashSet::new();\n        let mut result = Vec::new();\n\n        Self::dfs_recursive(\n            storage,\n            start_entity,\n            target_entity,\n            max_depth,\n            0,\n            \u0026mut visited,\n            \u0026mut result,\n        )?;\n\n        Ok(result)\n    }\n\n    fn dfs_recursive\u003cS: RelationshipStorage\u003e(\n        storage: \u0026S,\n        entity_id: \u0026str,\n        target_entity: Option\u003c\u0026str\u003e,\n        max_depth: Option\u003cusize\u003e,\n        current_depth: usize,\n        visited: \u0026mut HashSet\u003cString\u003e,\n        result: \u0026mut Vec\u003cString\u003e,\n    ) -\u003e Result\u003cbool, EngramError\u003e {\n        if visited.contains(entity_id) {\n            return Ok(false);\n        }\n\n        visited.insert(entity_id.to_string());\n        result.push(entity_id.to_string());\n\n        if let Some(target) = target_entity {\n            if entity_id == target {\n                return Ok(true);\n            }\n        }\n\n        if let Some(max_d) = max_depth {\n            if current_depth \u003e= max_d {\n                return Ok(false);\n            }\n        }\n\n        let relationships = storage.get_outbound_relationships(entity_id)?;\n        for rel in relationships {\n            if rel.active {\n                if Self::dfs_recursive(\n                    storage,\n                    \u0026rel.target_id,\n                    target_entity,\n                    max_depth,\n                    current_depth + 1,\n                    visited,\n                    result,\n                )? {\n                    return Ok(true);\n                }\n            }\n        }\n\n        let inbound = storage.get_inbound_relationships(entity_id)?;\n        for rel in inbound {\n            if rel.active \u0026\u0026 rel.direction == RelationshipDirection::Bidirectional {\n                if Self::dfs_recursive(\n                    storage,\n                    \u0026rel.source_id,\n                    target_entity,\n                    max_depth,\n                    current_depth + 1,\n                    visited,\n                    result,\n                )? {\n                    return Ok(true);\n                }\n            }\n        }\n\n        Ok(false)\n    }\n\n    /// Find shortest path using Dijkstra's algorithm\n    pub fn dijkstra\u003cS: RelationshipStorage\u003e(\n        storage: \u0026S,\n        start_entity: \u0026str,\n        target_entity: \u0026str,\n    ) -\u003e Result\u003cOption\u003cEntityPath\u003e, EngramError\u003e {\n        use std::collections::BinaryHeap;\n\n        let mut distances: HashMap\u003cString, f64\u003e = HashMap::new();\n        let mut previous: HashMap\u003cString, Option\u003c(String, String)\u003e\u003e = HashMap::new();\n        let mut visited = HashSet::new();\n        let mut heap = BinaryHeap::new();\n\n        distances.insert(start_entity.to_string(), 0.0);\n        heap.push(Reverse(State {\n            cost: 0,\n            entity: start_entity.to_string(),\n        }));\n\n        while let Some(Reverse(State {\n            cost: _,\n            entity: current_entity,\n        })) = heap.pop()\n        {\n            if visited.contains(\u0026current_entity) {\n                continue;\n            }\n\n            visited.insert(current_entity.clone());\n\n            if current_entity == target_entity {\n                break;\n            }\n\n            let current_dist = distances\n                .get(\u0026current_entity)\n                .copied()\n                .unwrap_or(f64::INFINITY);\n\n            let relationships = storage.get_outbound_relationships(\u0026current_entity)?;\n            for rel in relationships {\n                if !rel.active {\n                    continue;\n                }\n\n                let next_entity = \u0026rel.target_id;\n                let weight = 1.0 - rel.strength.weight();\n                let new_dist = current_dist + weight;\n\n                let current_best = distances.get(next_entity).copied().unwrap_or(f64::INFINITY);\n                if new_dist \u003c current_best {\n                    distances.insert(next_entity.clone(), new_dist);\n                    previous.insert(\n                        next_entity.clone(),\n                        Some((current_entity.clone(), rel.id.clone())),\n                    );\n                    heap.push(Reverse(State {\n                        cost: (new_dist * 1000.0) as i64,\n                        entity: next_entity.clone(),\n                    }));\n                }\n            }\n\n            let inbound = storage.get_inbound_relationships(\u0026current_entity)?;\n            for rel in inbound {\n                if !rel.active || rel.direction != RelationshipDirection::Bidirectional {\n                    continue;\n                }\n\n                let next_entity = \u0026rel.source_id;\n                let weight = 1.0 - rel.strength.weight();\n                let new_dist = current_dist + weight;\n\n                let current_best = distances.get(next_entity).copied().unwrap_or(f64::INFINITY);\n                if new_dist \u003c current_best {\n                    distances.insert(next_entity.clone(), new_dist);\n                    previous.insert(\n                        next_entity.clone(),\n                        Some((current_entity.clone(), rel.id.clone())),\n                    );\n                    heap.push(Reverse(State {\n                        cost: (new_dist * 1000.0) as i64,\n                        entity: next_entity.clone(),\n                    }));\n                }\n            }\n        }\n\n        if !distances.contains_key(target_entity) {\n            return Ok(None);\n        }\n\n        let mut path_entities = Vec::new();\n        let mut path_relationships = Vec::new();\n        let mut current = target_entity;\n\n        while let Some(Some((prev_entity, rel_id))) = previous.get(current) {\n            path_entities.push(current.to_string());\n            path_relationships.push(rel_id.clone());\n            current = prev_entity;\n        }\n        path_entities.push(start_entity.to_string());\n\n        path_entities.reverse();\n        path_relationships.reverse();\n\n        let total_weight = distances.get(target_entity).copied().unwrap_or(0.0);\n\n        Ok(Some(EntityPath {\n            entities: path_entities,\n            relationships: path_relationships,\n            total_weight,\n            path_type: PathType::Shortest,\n        }))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_relationship_index() {\n        let mut index = RelationshipIndex::new();\n\n        let rel = EntityRelationship::new(\n            \"rel-001\".to_string(),\n            \"agent\".to_string(),\n            \"entity-1\".to_string(),\n            \"task\".to_string(),\n            \"entity-2\".to_string(),\n            \"task\".to_string(),\n            EntityRelationType::DependsOn,\n        );\n\n        index.add_relationship(\u0026rel);\n\n        assert_eq!(index.get_outbound(\"entity-1\"), vec![\"rel-001\"]);\n        assert_eq!(index.get_inbound(\"entity-2\"), vec![\"rel-001\"]);\n        assert_eq!(\n            index.get_by_type(\u0026EntityRelationType::DependsOn),\n            vec![\"rel-001\"]\n        );\n    }\n\n    #[test]\n    fn test_relationship_path() {\n        let path = EntityPath {\n            entities: vec![\n                \"entity-1\".to_string(),\n                \"entity-2\".to_string(),\n                \"entity-3\".to_string(),\n            ],\n            relationships: vec![\"rel-1\".to_string(), \"rel-2\".to_string()],\n            total_weight: 1.5,\n            path_type: PathType::Shortest,\n        };\n\n        assert_eq!(path.entities.len(), 3);\n        assert_eq!(path.relationships.len(), 2);\n    }\n}\n","traces":[{"line":51,"address":[23517392],"length":1,"stats":{"Line":19}},{"line":52,"address":[23056728],"length":1,"stats":{"Line":14}},{"line":56,"address":[16899920,16900607,16900578],"length":1,"stats":{"Line":2}},{"line":57,"address":[16174801],"length":1,"stats":{"Line":2}},{"line":60,"address":[16396866,16396931],"length":1,"stats":{"Line":4}},{"line":61,"address":[14749611],"length":1,"stats":{"Line":2}},{"line":62,"address":[16326208],"length":1,"stats":{"Line":2}},{"line":64,"address":[14749690],"length":1,"stats":{"Line":2}},{"line":65,"address":[17390147],"length":1,"stats":{"Line":2}},{"line":66,"address":[17693613],"length":1,"stats":{"Line":2}},{"line":67,"address":[23055701],"length":1,"stats":{"Line":2}},{"line":69,"address":[16326415],"length":1,"stats":{"Line":2}},{"line":70,"address":[16397192],"length":1,"stats":{"Line":2}},{"line":71,"address":[23055822],"length":1,"stats":{"Line":2}},{"line":72,"address":[17693782],"length":1,"stats":{"Line":2}},{"line":74,"address":[23516571],"length":1,"stats":{"Line":2}},{"line":75,"address":[16900487],"length":1,"stats":{"Line":0}},{"line":79,"address":[17694064],"length":1,"stats":{"Line":0}},{"line":80,"address":[23516823],"length":1,"stats":{"Line":0}},{"line":82,"address":[16397587],"length":1,"stats":{"Line":0}},{"line":83,"address":[17691966,17691952],"length":1,"stats":{"Line":0}},{"line":86,"address":[16175647],"length":1,"stats":{"Line":0}},{"line":87,"address":[17694235],"length":1,"stats":{"Line":0}},{"line":90,"address":[17694255],"length":1,"stats":{"Line":0}},{"line":91,"address":[23517051],"length":1,"stats":{"Line":0}},{"line":94,"address":[17390922],"length":1,"stats":{"Line":0}},{"line":98,"address":[17693184],"length":1,"stats":{"Line":2}},{"line":99,"address":[17389842],"length":1,"stats":{"Line":2}},{"line":103,"address":[14749200],"length":1,"stats":{"Line":2}},{"line":104,"address":[23055186],"length":1,"stats":{"Line":2}},{"line":108,"address":[17694368,17694638,17694632],"length":1,"stats":{"Line":1}},{"line":109,"address":[16175890],"length":1,"stats":{"Line":1}},{"line":110,"address":[17391039,17391096],"length":1,"stats":{"Line":2}},{"line":111,"address":[17694525],"length":1,"stats":{"Line":1}},{"line":112,"address":[16327292],"length":1,"stats":{"Line":1}},{"line":113,"address":[23056662],"length":1,"stats":{"Line":1}},{"line":117,"address":[14749088],"length":1,"stats":{"Line":1}},{"line":118,"address":[17692992],"length":1,"stats":{"Line":1}},{"line":122,"address":[16175488],"length":1,"stats":{"Line":0}},{"line":123,"address":[16900642],"length":1,"stats":{"Line":0}},{"line":127,"address":[16327408],"length":1,"stats":{"Line":9}},{"line":128,"address":[23056766],"length":1,"stats":{"Line":9}},{"line":129,"address":[23056777],"length":1,"stats":{"Line":9}},{"line":130,"address":[16901302],"length":1,"stats":{"Line":9}},{"line":131,"address":[16176215],"length":1,"stats":{"Line":9}},{"line":177,"address":[16160880,16161365,16161371],"length":1,"stats":{"Line":0}},{"line":182,"address":[17333321,17333461],"length":1,"stats":{"Line":0}},{"line":183,"address":[19572286,19572449],"length":1,"stats":{"Line":0}},{"line":184,"address":[22999027],"length":1,"stats":{"Line":0}},{"line":185,"address":[17101559],"length":1,"stats":{"Line":0}},{"line":205,"address":[16130848,16132684,16132690],"length":1,"stats":{"Line":0}},{"line":209,"address":[17102244,17102313],"length":1,"stats":{"Line":0}},{"line":211,"address":[17334289,17334349],"length":1,"stats":{"Line":0}},{"line":213,"address":[17637860,17637941,17638104],"length":1,"stats":{"Line":0}},{"line":214,"address":[18336296,18336390],"length":1,"stats":{"Line":0}},{"line":216,"address":[17102947,17102784,17102703],"length":1,"stats":{"Line":0}},{"line":217,"address":[16162339,16162433],"length":1,"stats":{"Line":0}},{"line":220,"address":[17335038],"length":1,"stats":{"Line":0}},{"line":221,"address":[18185709],"length":1,"stats":{"Line":0}},{"line":222,"address":[23000580],"length":1,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[17376524,17376866],"length":1,"stats":{"Line":0}},{"line":230,"address":[17376878],"length":1,"stats":{"Line":0}},{"line":231,"address":[19574181],"length":1,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[16132077],"length":1,"stats":{"Line":0}},{"line":239,"address":[19574570,19574489],"length":1,"stats":{"Line":0}},{"line":240,"address":[25527881],"length":1,"stats":{"Line":0}},{"line":241,"address":[15910554],"length":1,"stats":{"Line":0}},{"line":246,"address":[16132476],"length":1,"stats":{"Line":0}},{"line":250,"address":[16396752,16397157,16397163],"length":1,"stats":{"Line":0}},{"line":251,"address":[19825039,19825145],"length":1,"stats":{"Line":0}},{"line":252,"address":[17333843],"length":1,"stats":{"Line":0}},{"line":253,"address":[16118750],"length":1,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[18406746,18406813],"length":1,"stats":{"Line":0}},{"line":283,"address":[17695200],"length":1,"stats":{"Line":0}},{"line":284,"address":[17391802],"length":1,"stats":{"Line":0}},{"line":291,"address":[14751696],"length":1,"stats":{"Line":0}},{"line":292,"address":[17392158],"length":1,"stats":{"Line":0}},{"line":297,"address":[16176240],"length":1,"stats":{"Line":0}},{"line":298,"address":[17391374],"length":1,"stats":{"Line":0}},{"line":307,"address":[17685255,17683040,17680368],"length":1,"stats":{"Line":0}},{"line":313,"address":[17377061],"length":1,"stats":{"Line":0}},{"line":314,"address":[17377110],"length":1,"stats":{"Line":0}},{"line":315,"address":[16384069],"length":1,"stats":{"Line":0}},{"line":317,"address":[16162123,16162183],"length":1,"stats":{"Line":0}},{"line":318,"address":[16313512],"length":1,"stats":{"Line":0}},{"line":320,"address":[23042904],"length":1,"stats":{"Line":0}},{"line":321,"address":[17680957,17681074],"length":1,"stats":{"Line":0}},{"line":323,"address":[16384589],"length":1,"stats":{"Line":0}},{"line":324,"address":[15589461,15589430],"length":1,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[17377777,17377830],"length":1,"stats":{"Line":0}},{"line":330,"address":[16313974],"length":1,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[16317765,16314084,16313987],"length":1,"stats":{"Line":0}},{"line":336,"address":[23504436,23504571,23504328,23507548],"length":1,"stats":{"Line":0}},{"line":337,"address":[16163369],"length":1,"stats":{"Line":0}},{"line":338,"address":[16165369,16165448],"length":1,"stats":{"Line":0}},{"line":339,"address":[17683982],"length":1,"stats":{"Line":0}},{"line":340,"address":[17380633],"length":1,"stats":{"Line":0}},{"line":345,"address":[16163415],"length":1,"stats":{"Line":0}},{"line":346,"address":[16385691,16385934,16387092,16385799],"length":1,"stats":{"Line":0}},{"line":347,"address":[16164188,16163980,16164114],"length":1,"stats":{"Line":0}},{"line":348,"address":[23505458],"length":1,"stats":{"Line":0}},{"line":349,"address":[17379359],"length":1,"stats":{"Line":0}},{"line":350,"address":[15591026],"length":1,"stats":{"Line":0}},{"line":356,"address":[23047221],"length":1,"stats":{"Line":0}},{"line":360,"address":[16176473,16176479,16175808],"length":1,"stats":{"Line":0}},{"line":366,"address":[23508164],"length":1,"stats":{"Line":0}},{"line":367,"address":[17685442],"length":1,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[23047862],"length":1,"stats":{"Line":0}},{"line":382,"address":[23502547,23500352,23503057],"length":1,"stats":{"Line":0}},{"line":391,"address":[17374369],"length":1,"stats":{"Line":0}},{"line":392,"address":[23500701],"length":1,"stats":{"Line":0}},{"line":395,"address":[23500559],"length":1,"stats":{"Line":0}},{"line":396,"address":[16159347],"length":1,"stats":{"Line":0}},{"line":398,"address":[16168506,16168455],"length":1,"stats":{"Line":0}},{"line":399,"address":[23040074],"length":1,"stats":{"Line":0}},{"line":400,"address":[23500793],"length":1,"stats":{"Line":0}},{"line":404,"address":[16159567,16159508],"length":1,"stats":{"Line":0}},{"line":405,"address":[16168639],"length":1,"stats":{"Line":0}},{"line":406,"address":[16381696],"length":1,"stats":{"Line":0}},{"line":410,"address":[16159696,16159593],"length":1,"stats":{"Line":0}},{"line":411,"address":[23501332,23501089,23501197],"length":1,"stats":{"Line":0}},{"line":412,"address":[16169178],"length":1,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[17376468],"length":1,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[23502815,23502689],"length":1,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[16312987],"length":1,"stats":{"Line":0}},{"line":427,"address":[23041903,23040757],"length":1,"stats":{"Line":0}},{"line":428,"address":[17679045,17679180,17678937],"length":1,"stats":{"Line":0}},{"line":429,"address":[16160706,16160796,16160870],"length":1,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[23041468],"length":1,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[16382925,16383051],"length":1,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[15588066],"length":1,"stats":{"Line":0}},{"line":444,"address":[17375862],"length":1,"stats":{"Line":0}},{"line":448,"address":[17382560,17385978,17388475],"length":1,"stats":{"Line":0}},{"line":455,"address":[16318775],"length":1,"stats":{"Line":0}},{"line":456,"address":[16318824],"length":1,"stats":{"Line":0}},{"line":457,"address":[23048231],"length":1,"stats":{"Line":0}},{"line":458,"address":[17382819],"length":1,"stats":{"Line":0}},{"line":460,"address":[23048367,23048427],"length":1,"stats":{"Line":0}},{"line":461,"address":[16167900],"length":1,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[16319129],"length":1,"stats":{"Line":0}},{"line":466,"address":[15594633],"length":1,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[16319317],"length":1,"stats":{"Line":0}},{"line":469,"address":[16390021],"length":1,"stats":{"Line":0}},{"line":471,"address":[16177157,16177288],"length":1,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[23048879,23048830],"length":1,"stats":{"Line":0}},{"line":477,"address":[17383450],"length":1,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[16390520],"length":1,"stats":{"Line":0}},{"line":482,"address":[16168357],"length":1,"stats":{"Line":0}},{"line":484,"address":[16168467],"length":1,"stats":{"Line":0}},{"line":486,"address":[15598383,15595085],"length":1,"stats":{"Line":0}},{"line":487,"address":[15595455,15595582,15595351],"length":1,"stats":{"Line":0}},{"line":488,"address":[23510360],"length":1,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[23051560],"length":1,"stats":{"Line":0}},{"line":493,"address":[17689626,17689520],"length":1,"stats":{"Line":0}},{"line":494,"address":[23512375],"length":1,"stats":{"Line":0}},{"line":496,"address":[16180189],"length":1,"stats":{"Line":0}},{"line":497,"address":[16180324],"length":1,"stats":{"Line":0}},{"line":498,"address":[17386424],"length":1,"stats":{"Line":0}},{"line":499,"address":[16322890],"length":1,"stats":{"Line":0}},{"line":500,"address":[16171367],"length":1,"stats":{"Line":0}},{"line":501,"address":[16180450,16180518],"length":1,"stats":{"Line":0}},{"line":503,"address":[17690347],"length":1,"stats":{"Line":0}},{"line":504,"address":[16393761],"length":1,"stats":{"Line":0}},{"line":505,"address":[23052387],"length":1,"stats":{"Line":0}},{"line":510,"address":[15595678],"length":1,"stats":{"Line":0}},{"line":511,"address":[23510927,23510684,23510792],"length":1,"stats":{"Line":0}},{"line":512,"address":[23510981,23511115,23511199],"length":1,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[16169941],"length":1,"stats":{"Line":0}},{"line":517,"address":[17385085],"length":1,"stats":{"Line":0}},{"line":518,"address":[17385160],"length":1,"stats":{"Line":0}},{"line":520,"address":[15596562],"length":1,"stats":{"Line":0}},{"line":521,"address":[16170197],"length":1,"stats":{"Line":0}},{"line":522,"address":[23511497],"length":1,"stats":{"Line":0}},{"line":523,"address":[16392587],"length":1,"stats":{"Line":0}},{"line":524,"address":[16392312],"length":1,"stats":{"Line":0}},{"line":525,"address":[23511587,23511655],"length":1,"stats":{"Line":0}},{"line":527,"address":[17689282],"length":1,"stats":{"Line":0}},{"line":528,"address":[16170674],"length":1,"stats":{"Line":0}},{"line":529,"address":[17385847],"length":1,"stats":{"Line":0}},{"line":535,"address":[23513341],"length":1,"stats":{"Line":0}},{"line":536,"address":[17387254],"length":1,"stats":{"Line":0}},{"line":539,"address":[16181231],"length":1,"stats":{"Line":0}},{"line":540,"address":[16181318],"length":1,"stats":{"Line":0}},{"line":541,"address":[16394341],"length":1,"stats":{"Line":0}},{"line":543,"address":[23052949,23053362,23053038,23053155],"length":1,"stats":{"Line":0}},{"line":544,"address":[23053201],"length":1,"stats":{"Line":0}},{"line":545,"address":[16172676],"length":1,"stats":{"Line":0}},{"line":546,"address":[16323975],"length":1,"stats":{"Line":0}},{"line":548,"address":[16181597,16181831],"length":1,"stats":{"Line":0}},{"line":550,"address":[16324050],"length":1,"stats":{"Line":0}},{"line":551,"address":[16394868],"length":1,"stats":{"Line":0}},{"line":553,"address":[16172902],"length":1,"stats":{"Line":0}},{"line":555,"address":[15599462],"length":1,"stats":{"Line":0}},{"line":556,"address":[17691551],"length":1,"stats":{"Line":0}},{"line":557,"address":[23053647],"length":1,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}}],"covered":33,"coverable":227},{"path":["/","home","shift","code","vincents-ai","engram","src","validation","config.rs"],"content":"//! Configuration for pre-commit hook validation\n\nuse crate::error::EngramError;\nuse serde::{Deserialize, Serialize};\nuse std::path::Path;\n\n/// Configuration for validation rules\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ValidationConfig {\n    /// Whether validation is enabled\n    pub enabled: bool,\n\n    /// Require task reference in commit message\n    pub require_task_reference: bool,\n\n    /// Require reasoning relationship for tasks\n    pub require_reasoning_relationship: bool,\n\n    /// Require context relationship for tasks\n    pub require_context_relationship: bool,\n\n    /// Require file scope to match task memories\n    pub require_file_scope_match: bool,\n\n    /// Supported task ID patterns\n    pub task_id_patterns: Vec\u003cTaskIdPattern\u003e,\n\n    /// Exemptions from validation\n    pub exemptions: Vec\u003cValidationExemption\u003e,\n\n    /// Performance settings\n    pub performance: PerformanceConfig,\n}\n\n/// Pattern for matching task IDs in commit messages\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TaskIdPattern {\n    /// Regex pattern to match task ID\n    pub pattern: String,\n    /// Pattern name for error messages\n    pub name: String,\n    /// Example of the format\n    pub example: String,\n}\n\n/// Exemption rules for validation\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ValidationExemption {\n    /// Pattern to match commit messages\n    pub message_pattern: String,\n    /// Whether to skip all validation\n    pub skip_validation: bool,\n    /// Specific validations to skip\n    pub skip_specific: Vec\u003cString\u003e,\n}\n\n/// Performance configuration\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PerformanceConfig {\n    /// Cache TTL in seconds\n    pub cache_ttl_seconds: u64,\n\n    /// Maximum cache size\n    pub max_cache_entries: usize,\n\n    /// Enable parallel validation\n    pub enable_parallel_validation: bool,\n\n    /// Timeout for validation in seconds\n    pub validation_timeout_seconds: u64,\n}\n\nimpl Default for ValidationConfig {\n    fn default() -\u003e Self {\n        Self {\n            enabled: true,\n            require_task_reference: true,\n            require_reasoning_relationship: true,\n            require_context_relationship: true,\n            require_file_scope_match: true,\n            task_id_patterns: vec![\n                TaskIdPattern {\n                    pattern: r\"\\[([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\\]\"\n                        .to_string(),\n                    name: \"UUID format\".to_string(),\n                    example: \"[69190cf0-243a-4979-b4c1-604ba48f72eb]\".to_string(),\n                },\n                TaskIdPattern {\n                    pattern: r\"\\[([A-Z]+-\\d+)\\]\".to_string(),\n                    name: \"Brackets format\".to_string(),\n                    example: \"[TASK-123]\".to_string(),\n                },\n                TaskIdPattern {\n                    pattern: r\"\\[task:([a-z0-9-]+)\\]\".to_string(),\n                    name: \"Colon format\".to_string(),\n                    example: \"[task:auth-impl-001]\".to_string(),\n                },\n                TaskIdPattern {\n                    pattern: r\"Refs:\\s*#(\\d+)\".to_string(),\n                    name: \"Refs format\".to_string(),\n                    example: \"Refs: #456\".to_string(),\n                },\n            ],\n            exemptions: vec![\n                ValidationExemption {\n                    message_pattern: r\"^(chore|docs):\".to_string(),\n                    skip_validation: false,\n                    skip_specific: vec![\"require_task_reference\".to_string()],\n                },\n                ValidationExemption {\n                    message_pattern: r\"^fixup!\".to_string(),\n                    skip_validation: true,\n                    skip_specific: vec![],\n                },\n                ValidationExemption {\n                    message_pattern: r\"^amend!\".to_string(),\n                    skip_validation: true,\n                    skip_specific: vec![],\n                },\n            ],\n            performance: PerformanceConfig::default(),\n        }\n    }\n}\n\nimpl Default for PerformanceConfig {\n    fn default() -\u003e Self {\n        Self {\n            cache_ttl_seconds: 300, // 5 minutes\n            max_cache_entries: 1000,\n            enable_parallel_validation: true,\n            validation_timeout_seconds: 30,\n        }\n    }\n}\n\nimpl ValidationConfig {\n    /// Load configuration from file\n    pub fn load_from_file\u003cP: AsRef\u003cPath\u003e\u003e(path: P) -\u003e Result\u003cSelf, EngramError\u003e {\n        let content = std::fs::read_to_string(path).map_err(|e| EngramError::Io(e))?;\n\n        let config: Self = serde_yaml::from_str(\u0026content).map_err(EngramError::Yaml)?;\n\n        Ok(config)\n    }\n\n    /// Save configuration to file\n    pub fn save_to_file\u003cP: AsRef\u003cPath\u003e\u003e(\u0026self, path: P) -\u003e Result\u003c(), EngramError\u003e {\n        let content = serde_yaml::to_string(self)\n            .map_err(|e| EngramError::Validation(format!(\"Failed to serialize config: {}\", e)))?;\n\n        std::fs::write(path, content).map_err(|e| EngramError::Io(e))?;\n\n        Ok(())\n    }\n\n    /// Validate configuration\n    pub fn validate(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        // Validate task ID patterns\n        for pattern in \u0026self.task_id_patterns {\n            if let Err(e) = regex::Regex::new(\u0026pattern.pattern) {\n                return Err(EngramError::Validation(format!(\n                    \"Invalid task ID pattern '{}': {}\",\n                    pattern.name, e\n                )));\n            }\n        }\n\n        // Validate exemption patterns\n        for exemption in \u0026self.exemptions {\n            if let Err(e) = regex::Regex::new(\u0026exemption.message_pattern) {\n                return Err(EngramError::Validation(format!(\n                    \"Invalid exemption pattern: {}\",\n                    e\n                )));\n            }\n        }\n\n        // Validate performance settings\n        if self.performance.cache_ttl_seconds == 0 {\n            return Err(EngramError::Validation(\n                \"Cache TTL must be greater than 0\".to_string(),\n            ));\n        }\n\n        if self.performance.max_cache_entries == 0 {\n            return Err(EngramError::Validation(\n                \"Max cache entries must be greater than 0\".to_string(),\n            ));\n        }\n\n        if self.performance.validation_timeout_seconds == 0 {\n            return Err(EngramError::Validation(\n                \"Validation timeout must be greater than 0\".to_string(),\n            ));\n        }\n\n        Ok(())\n    }\n\n    /// Check if a commit message should be exempted from validation\n    pub fn should_exempt(\u0026self, message: \u0026str, validation_type: \u0026str) -\u003e bool {\n        for exemption in \u0026self.exemptions {\n            if let Ok(regex) = regex::Regex::new(\u0026exemption.message_pattern) {\n                if regex.is_match(message) {\n                    if exemption.skip_validation {\n                        return true;\n                    }\n                    if exemption\n                        .skip_specific\n                        .contains(\u0026validation_type.to_string())\n                    {\n                        return true;\n                    }\n                }\n            }\n        }\n        false\n    }\n\n    /// Get all task ID regex patterns\n    pub fn get_task_regexes(\u0026self) -\u003e Result\u003cVec\u003cregex::Regex\u003e, EngramError\u003e {\n        self.task_id_patterns\n            .iter()\n            .map(|p| {\n                regex::Regex::new(\u0026p.pattern).map_err(|e| {\n                    EngramError::Validation(format!(\"Invalid pattern '{}': {}\", p.name, e))\n                })\n            })\n            .collect()\n    }\n\n    /// Get a sample commit message format for help\n    pub fn get_help_examples(\u0026self) -\u003e String {\n        let mut examples = vec![\"Supported task ID formats:\".to_string()];\n\n        for pattern in \u0026self.task_id_patterns {\n            examples.push(format!(\"  - {}: {}\", pattern.name, pattern.example));\n        }\n\n        examples.push(\"\\nExemptions:\".to_string());\n        for exemption in \u0026self.exemptions {\n            if exemption.skip_validation {\n                examples.push(format!(\n                    \"  - '{}' (skip all validation)\",\n                    exemption.message_pattern\n                ));\n            } else if !exemption.skip_specific.is_empty() {\n                examples.push(format!(\n                    \"  - '{}' (skip: {})\",\n                    exemption.message_pattern,\n                    exemption.skip_specific.join(\", \")\n                ));\n            }\n        }\n\n        examples.join(\"\\n\")\n    }\n}\n","traces":[{"line":74,"address":[25113951,25110784,25113935],"length":1,"stats":{"Line":1}},{"line":81,"address":[18134274,18134975,18133963,18133307,18133652,18136412,18133353,18134594],"length":1,"stats":{"Line":2}},{"line":104,"address":[18135911,18134963,18135030,18135512,18135715,18135077,18136394],"length":1,"stats":{"Line":3}},{"line":121,"address":[18136188],"length":1,"stats":{"Line":1}},{"line":127,"address":[18384624],"length":1,"stats":{"Line":1}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[18448496,18449695,18449701],"length":1,"stats":{"Line":0}},{"line":160,"address":[18377766,18377782],"length":1,"stats":{"Line":0}},{"line":161,"address":[25108333,25107188],"length":1,"stats":{"Line":0}},{"line":162,"address":[18379131,18379009],"length":1,"stats":{"Line":0}},{"line":170,"address":[19867153,19867179],"length":1,"stats":{"Line":0}},{"line":171,"address":[25568016,25568482],"length":1,"stats":{"Line":0}},{"line":172,"address":[18130481,18130374],"length":1,"stats":{"Line":0}},{"line":180,"address":[25568083],"length":1,"stats":{"Line":0}},{"line":181,"address":[18448873],"length":1,"stats":{"Line":0}},{"line":182,"address":[19867322],"length":1,"stats":{"Line":0}},{"line":186,"address":[18437438],"length":1,"stats":{"Line":0}},{"line":187,"address":[18449011],"length":1,"stats":{"Line":0}},{"line":188,"address":[19867460],"length":1,"stats":{"Line":0}},{"line":192,"address":[18449096],"length":1,"stats":{"Line":0}},{"line":193,"address":[18130234],"length":1,"stats":{"Line":0}},{"line":194,"address":[18449103],"length":1,"stats":{"Line":0}},{"line":198,"address":[25107798],"length":1,"stats":{"Line":0}},{"line":202,"address":[25104576,25105341,25105281],"length":1,"stats":{"Line":1}},{"line":203,"address":[19922275,19922295],"length":1,"stats":{"Line":2}},{"line":204,"address":[18434629,18434753],"length":1,"stats":{"Line":6}},{"line":205,"address":[18375604,18375545],"length":1,"stats":{"Line":4}},{"line":206,"address":[18446405],"length":1,"stats":{"Line":1}},{"line":207,"address":[18224425],"length":1,"stats":{"Line":0}},{"line":209,"address":[18434896,18435061],"length":1,"stats":{"Line":3}},{"line":211,"address":[25105057,25105163],"length":1,"stats":{"Line":2}},{"line":213,"address":[18375913],"length":1,"stats":{"Line":2}},{"line":218,"address":[18127322],"length":1,"stats":{"Line":1}},{"line":222,"address":[18446816],"length":1,"stats":{"Line":1}},{"line":223,"address":[18127968],"length":1,"stats":{"Line":1}},{"line":225,"address":[19987312],"length":1,"stats":{"Line":4}},{"line":226,"address":[27118474,27118116,27118176],"length":1,"stats":{"Line":2}},{"line":227,"address":[19777027,19776942],"length":1,"stats":{"Line":0}},{"line":234,"address":[19865392,19866642,19866952],"length":1,"stats":{"Line":0}},{"line":235,"address":[18224942,18225182,18226469],"length":1,"stats":{"Line":0}},{"line":237,"address":[25105753,25105841],"length":1,"stats":{"Line":0}},{"line":238,"address":[18128477,18129409],"length":1,"stats":{"Line":0}},{"line":241,"address":[25566667],"length":1,"stats":{"Line":0}},{"line":242,"address":[18376714],"length":1,"stats":{"Line":0}},{"line":243,"address":[18447622],"length":1,"stats":{"Line":0}},{"line":244,"address":[18128864,18129272],"length":1,"stats":{"Line":0}},{"line":248,"address":[19923944,19924002],"length":1,"stats":{"Line":0}},{"line":249,"address":[25567129],"length":1,"stats":{"Line":0}},{"line":252,"address":[18225793],"length":1,"stats":{"Line":0}},{"line":257,"address":[18225614],"length":1,"stats":{"Line":0}}],"covered":18,"coverable":58},{"path":["/","home","shift","code","vincents-ai","engram","src","validation","hook.rs"],"content":"//! Git pre-commit hook management\n\nuse crate::error::EngramError;\nuse crate::validation::config::ValidationConfig;\nuse std::fs;\nuse std::path::Path;\n\n/// Manager for git pre-commit hooks\npub struct HookManager {\n    git_dir: String,\n    #[allow(dead_code)]\n    config: ValidationConfig,\n}\n\nimpl HookManager {\n    /// Create a new hook manager\n    pub fn new\u003cP: AsRef\u003cPath\u003e\u003e(git_dir: P) -\u003e Result\u003cSelf, EngramError\u003e {\n        let git_dir = git_dir.as_ref().to_string_lossy().to_string();\n        let config = ValidationConfig::default();\n\n        Ok(Self { git_dir, config })\n    }\n\n    /// Create a hook manager with custom configuration\n    pub fn with_config\u003cP: AsRef\u003cPath\u003e\u003e(\n        git_dir: P,\n        config: ValidationConfig,\n    ) -\u003e Result\u003cSelf, EngramError\u003e {\n        let git_dir = git_dir.as_ref().to_string_lossy().to_string();\n\n        Ok(Self { git_dir, config })\n    }\n\n    /// Generate the hook script content\n    fn generate_hook_script(\u0026self) -\u003e String {\n        format!(\n            r#\"#!/usr/bin/env bash\n# ENGRAM_PRE_COMMIT_HOOK\n\nset -e\n\n# Get the directory where this script is located\nSCRIPT_DIR=\"$(cd \"$(dirname \"${{BASH_SOURCE[0]}}\")\" \u0026\u0026 pwd)\"\nREPO_ROOT=\"$(cd \"$SCRIPT_DIR/../..\" \u0026\u0026 pwd)\"\n\n# Try to find engram binary in multiple locations\nENGRAM_BIN=\"\"\n\n# First try: relative to repo (if built locally)\nif [ -x \"$REPO_ROOT/target/release/engram\" ]; then\n    ENGRAM_BIN=\"$REPO_ROOT/target/release/engram\"\n# Second try: PATH\nelif command -v engram \u003e/dev/null 2\u003e\u00261; then\n    ENGRAM_BIN=\"engram\"\n# Third try: nix result link\nelif [ -x \"$REPO_ROOT/result/bin/engram\" ]; then\n    ENGRAM_BIN=\"$REPO_ROOT/result/bin/engram\"\nelse\n    echo \"‚ùå Error: engram binary not found\"\n    echo \"Please ensure engram is built or available in PATH\"\n    echo \"Try: cargo build --release\"\n    exit 1\nfi\n\n# Change to repo root for validation\ncd \"$REPO_ROOT\"\n\n# Get the commit message from the commit-msg file (first argument)\nif [ -z \"$1\" ]; then\n    echo \"‚ùå Error: No commit message file provided\"\n    exit 1\nfi\n\nCOMMIT_MSG=\"$(cat \"$1\")\"\n\n# Run engram validation\necho \"üîç Validating commit with engram...\"\nif ! \"$ENGRAM_BIN\" validate commit --message \"$COMMIT_MSG\"; then\n    echo \"‚ùå Commit validation failed\"\n    echo \"\"\n    echo \"To fix the commit:\"\n    echo \"  1. Ensure your commit message references a valid task\"\n    echo \"  2. Check that the task has required relationships\"\n    echo \"  3. Run: engram validate commit --message 'your message' --dry-run\"\n    exit 1\nfi\n\necho \"‚úÖ Commit validation passed\"\nexit 0\n\"#\n        )\n    }\n\n    /// Check if hook is installed\n    pub fn is_installed(\u0026self) -\u003e Result\u003cbool, EngramError\u003e {\n        let hook_path = Path::new(\u0026self.git_dir)\n            .join(\".git\")\n            .join(\"hooks\")\n            .join(\"commit-msg\");\n\n        if !hook_path.exists() {\n            return Ok(false);\n        }\n\n        let content = fs::read_to_string(\u0026hook_path).map_err(EngramError::Io)?;\n\n        Ok(content.contains(\"ENGRAM_PRE_COMMIT_HOOK\"))\n    }\n\n    /// Get hook script content\n    pub fn get_hook_content(\u0026self) -\u003e String {\n        self.generate_hook_script()\n    }\n\n    /// Install the commit-msg hook\n    pub fn install(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n        let hook_path = Path::new(\u0026self.git_dir)\n            .join(\".git\")\n            .join(\"hooks\")\n            .join(\"commit-msg\");\n\n        // Create hooks directory if it doesn't exist\n        if let Some(hooks_dir) = hook_path.parent() {\n            fs::create_dir_all(hooks_dir).map_err(EngramError::Io)?;\n        }\n\n        // Generate and write the hook script\n        let script_content = self.generate_hook_script();\n        fs::write(\u0026hook_path, script_content).map_err(EngramError::Io)?;\n\n        // Make the hook executable (Unix-like systems)\n        #[cfg(unix)]\n        {\n            use std::os::unix::fs::PermissionsExt;\n            let mut perms = fs::metadata(\u0026hook_path)\n                .map_err(EngramError::Io)?\n                .permissions();\n            perms.set_mode(0o755);\n            fs::set_permissions(\u0026hook_path, perms).map_err(EngramError::Io)?;\n        }\n\n        Ok(())\n    }\n\n    /// Uninstall the commit-msg hook\n    pub fn uninstall(\u0026mut self) -\u003e Result\u003c(), EngramError\u003e {\n        let hook_path = Path::new(\u0026self.git_dir)\n            .join(\".git\")\n            .join(\"hooks\")\n            .join(\"commit-msg\");\n\n        if hook_path.exists() {\n            let content = fs::read_to_string(\u0026hook_path).map_err(EngramError::Io)?;\n\n            if content.contains(\"ENGRAM_PRE_COMMIT_HOOK\") {\n                fs::remove_file(\u0026hook_path).map_err(EngramError::Io)?;\n            } else {\n                return Err(EngramError::Validation(\n                    \"Pre-commit hook exists but was not installed by Engram\".to_string(),\n                ));\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Show hook status\n    pub fn show_status(\u0026self) -\u003e Result\u003c(), EngramError\u003e {\n        let status = self.verify_setup()?;\n\n        println!(\"Hook Status:\");\n        println!(\n            \"  In Git Repo: {}\",\n            if status.in_git_repo { \"‚úÖ\" } else { \"‚ùå\" }\n        );\n        println!(\n            \"  Hook Installed: {}\",\n            if status.hook_installed { \"‚úÖ\" } else { \"‚ùå\" }\n        );\n        println!(\n            \"  Engram Available: {}\",\n            if status.engram_available {\n                \"‚úÖ\"\n            } else {\n                \"‚ùå\"\n            }\n        );\n        println!(\n            \"  Config Valid: {}\",\n            if status.config_valid { \"‚úÖ\" } else { \"‚ùå\" }\n        );\n        println!(\n            \"  Validation Works: {}\",\n            if status.validation_works {\n                \"‚úÖ\"\n            } else {\n                \"‚ùå\"\n            }\n        );\n\n        if !status.is_healthy() {\n            println!(\"\\nIssues:\");\n            for issue in status.get_issues() {\n                println!(\"  ‚Ä¢ {}\", issue);\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Verify hook setup and return status\n    pub fn verify_setup(\u0026self) -\u003e Result\u003cHookStatus, EngramError\u003e {\n        let mut status = HookStatus::default();\n\n        // Check if we're in a git repository\n        let git_dir = Path::new(\u0026self.git_dir).join(\".git\");\n        status.in_git_repo = git_dir.exists();\n\n        // Check if hook is installed\n        status.hook_installed = self.is_installed()?;\n\n        // Check if engram command is available\n        status.engram_available = std::process::Command::new(\"which\")\n            .arg(\"engram\")\n            .output()\n            .map(|output| output.status.success())\n            .unwrap_or(false);\n\n        // Check if config is valid\n        status.config_valid = true; // ValidationConfig::default() should always be valid\n\n        // Check if validation works by testing a sample commit\n        status.validation_works = status.hook_installed \u0026\u0026 status.engram_available;\n\n        Ok(status)\n    }\n}\n\n/// Status of hook setup\n#[derive(Debug, Default)]\npub struct HookStatus {\n    pub in_git_repo: bool,\n    pub hook_installed: bool,\n    pub engram_available: bool,\n    pub config_valid: bool,\n    pub validation_works: bool,\n}\n\nimpl HookStatus {\n    /// Check if everything is working\n    pub fn is_healthy(\u0026self) -\u003e bool {\n        self.in_git_repo\n            \u0026\u0026 self.hook_installed\n            \u0026\u0026 self.engram_available\n            \u0026\u0026 self.config_valid\n            \u0026\u0026 self.validation_works\n    }\n\n    /// Get a summary of issues\n    pub fn get_issues(\u0026self) -\u003e Vec\u003cString\u003e {\n        let mut issues = Vec::new();\n\n        if !self.in_git_repo {\n            issues.push(\"Not in a git repository\".to_string());\n        }\n        if !self.hook_installed {\n            issues.push(\"Pre-commit hook not installed\".to_string());\n        }\n        if !self.engram_available {\n            issues.push(\"Engram command not available\".to_string());\n        }\n        if !self.config_valid {\n            issues.push(\"Configuration invalid\".to_string());\n        }\n        if !self.validation_works {\n            issues.push(\"Validation not working\".to_string());\n        }\n\n        issues\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_hook_script_generation() {\n        let git_dir = \"/tmp/test_git\";\n        let hook_manager = HookManager::new(git_dir).unwrap();\n\n        let script = hook_manager.generate_hook_script();\n        assert!(script.contains(\"ENGRAM_PRE_COMMIT_HOOK\"));\n    }\n\n    #[test]\n    fn test_hook_status_default() {\n        let status = HookStatus::default();\n        assert!(!status.is_healthy());\n        assert_eq!(status.get_issues().len(), 5); // All 5 are false by default\n    }\n\n    #[test]\n    fn test_hook_status_healthy() {\n        let mut status = HookStatus::default();\n        status.in_git_repo = true;\n        status.hook_installed = true;\n        status.engram_available = true;\n        status.config_valid = true;\n        status.validation_works = true;\n\n        assert!(status.is_healthy());\n        assert!(status.get_issues().is_empty());\n    }\n}\n","traces":[{"line":17,"address":[20381328,20381381,20381716],"length":1,"stats":{"Line":1}},{"line":18,"address":[14628695,14628619],"length":1,"stats":{"Line":2}},{"line":19,"address":[],"length":0,"stats":{"Line":1}},{"line":21,"address":[],"length":0,"stats":{"Line":1}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[19161168],"length":1,"stats":{"Line":1}},{"line":36,"address":[14324243],"length":1,"stats":{"Line":1}},{"line":95,"address":[14323407,14323418,14322496],"length":1,"stats":{"Line":0}},{"line":96,"address":[14322693,14322534,14322582],"length":1,"stats":{"Line":0}},{"line":101,"address":[14322918],"length":1,"stats":{"Line":0}},{"line":102,"address":[14322971],"length":1,"stats":{"Line":0}},{"line":105,"address":[19159900,19159940,19160345],"length":1,"stats":{"Line":0}},{"line":107,"address":[19160247,19160176],"length":1,"stats":{"Line":0}},{"line":111,"address":[19161136],"length":1,"stats":{"Line":0}},{"line":112,"address":[14324209],"length":1,"stats":{"Line":0}},{"line":116,"address":[14324304,14325817,14325823],"length":1,"stats":{"Line":0}},{"line":117,"address":[19161350,19161473,19161292],"length":1,"stats":{"Line":0}},{"line":123,"address":[14324759],"length":1,"stats":{"Line":0}},{"line":124,"address":[19161844,19161888],"length":1,"stats":{"Line":0}},{"line":128,"address":[14324921],"length":1,"stats":{"Line":0}},{"line":129,"address":[19162824,19162065],"length":1,"stats":{"Line":0}},{"line":135,"address":[14325807,14325343,14325297,14325554,14325434],"length":1,"stats":{"Line":0}},{"line":136,"address":[19162378,19162288],"length":1,"stats":{"Line":0}},{"line":138,"address":[19162570],"length":1,"stats":{"Line":0}},{"line":139,"address":[14325581,14325802],"length":1,"stats":{"Line":0}},{"line":142,"address":[14325765],"length":1,"stats":{"Line":0}},{"line":146,"address":[14325840,14327048,14327040],"length":1,"stats":{"Line":0}},{"line":147,"address":[19162938,19163049,19162886],"length":1,"stats":{"Line":0}},{"line":152,"address":[19163274],"length":1,"stats":{"Line":0}},{"line":153,"address":[14327046,14326351],"length":1,"stats":{"Line":0}},{"line":155,"address":[14326582,14326653],"length":1,"stats":{"Line":0}},{"line":156,"address":[19163878,19164066,19163749],"length":1,"stats":{"Line":0}},{"line":158,"address":[14326742],"length":1,"stats":{"Line":0}},{"line":159,"address":[14326690],"length":1,"stats":{"Line":0}},{"line":164,"address":[19163327],"length":1,"stats":{"Line":0}},{"line":168,"address":[14320880,14322456,14322462],"length":1,"stats":{"Line":0}},{"line":169,"address":[14320905],"length":1,"stats":{"Line":0}},{"line":171,"address":[14321046],"length":1,"stats":{"Line":0}},{"line":172,"address":[14321144],"length":1,"stats":{"Line":0}},{"line":176,"address":[14321257],"length":1,"stats":{"Line":0}},{"line":180,"address":[14321469],"length":1,"stats":{"Line":0}},{"line":188,"address":[19158571],"length":1,"stats":{"Line":0}},{"line":192,"address":[19158720],"length":1,"stats":{"Line":0}},{"line":201,"address":[19158860],"length":1,"stats":{"Line":0}},{"line":202,"address":[19158879],"length":1,"stats":{"Line":0}},{"line":203,"address":[14322014,14322152,14322199],"length":1,"stats":{"Line":0}},{"line":204,"address":[19159186,19159276],"length":1,"stats":{"Line":0}},{"line":208,"address":[14322124],"length":1,"stats":{"Line":0}},{"line":212,"address":[19161098,19161117,19160368],"length":1,"stats":{"Line":0}},{"line":213,"address":[19160398],"length":1,"stats":{"Line":0}},{"line":216,"address":[19160450],"length":1,"stats":{"Line":0}},{"line":217,"address":[14323635,14323567],"length":1,"stats":{"Line":0}},{"line":220,"address":[19160593],"length":1,"stats":{"Line":0}},{"line":223,"address":[14323994,14323811],"length":1,"stats":{"Line":0}},{"line":224,"address":[19160786],"length":1,"stats":{"Line":0}},{"line":225,"address":[14323927],"length":1,"stats":{"Line":0}},{"line":226,"address":[17513721,17513712],"length":1,"stats":{"Line":0}},{"line":227,"address":[14323878,14323979,14324000],"length":1,"stats":{"Line":0}},{"line":230,"address":[14324019],"length":1,"stats":{"Line":0}},{"line":233,"address":[14324024],"length":1,"stats":{"Line":0}},{"line":235,"address":[14324073],"length":1,"stats":{"Line":0}},{"line":251,"address":[14320800],"length":1,"stats":{"Line":1}},{"line":252,"address":[14320810,14320815],"length":1,"stats":{"Line":2}},{"line":253,"address":[14320827],"length":1,"stats":{"Line":1}},{"line":254,"address":[14320838],"length":1,"stats":{"Line":1}},{"line":255,"address":[14320849],"length":1,"stats":{"Line":1}},{"line":256,"address":[19157756],"length":1,"stats":{"Line":1}},{"line":260,"address":[14320781,14320320,14320775],"length":1,"stats":{"Line":1}},{"line":261,"address":[19157246],"length":1,"stats":{"Line":1}},{"line":263,"address":[19157262],"length":1,"stats":{"Line":1}},{"line":264,"address":[14320453,14320371],"length":1,"stats":{"Line":2}},{"line":266,"address":[19157300],"length":1,"stats":{"Line":1}},{"line":267,"address":[19157413,19157372],"length":1,"stats":{"Line":2}},{"line":269,"address":[19157405],"length":1,"stats":{"Line":1}},{"line":270,"address":[14320581,14320540],"length":1,"stats":{"Line":2}},{"line":272,"address":[14320573],"length":1,"stats":{"Line":1}},{"line":273,"address":[14320648,14320604],"length":1,"stats":{"Line":2}},{"line":275,"address":[14320640],"length":1,"stats":{"Line":1}},{"line":276,"address":[14320674,14320749],"length":1,"stats":{"Line":2}},{"line":279,"address":[14320715],"length":1,"stats":{"Line":1}}],"covered":25,"coverable":81},{"path":["/","home","shift","code","vincents-ai","engram","src","validation","mod.rs"],"content":"//! Pre-commit hook validation system for Engram\n//!\n//! Provides comprehensive validation of git commits to ensure they follow\n//! disciplined development practices with proper task referencing and\n//! relationship requirements.\n\npub mod config;\npub mod hook;\npub mod parser;\npub mod quality_gates;\npub mod stage_transitions;\npub mod validator;\npub mod workflow_validator;\n\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\npub use config::ValidationConfig;\npub use hook::HookManager;\npub use parser::{CommitMessageParser, ConventionalCommit};\npub use quality_gates::{BuiltinValidators, QualityGate, QualityGatesExecutor};\npub use stage_transitions::{\n    StageTransitionManager, StageTransitionRule, TransitionCondition, TransitionEligibility,\n};\npub use validator::CommitValidator;\npub use workflow_validator::{StagePolicy, WorkflowValidator};\n\n/// Result of commit validation\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ValidationResult {\n    pub valid: bool,\n    pub errors: Vec\u003cValidationError\u003e,\n    pub task_id: Option\u003cString\u003e,\n    pub validated_relationships: Vec\u003cString\u003e,\n    pub validated_files: Vec\u003cString\u003e,\n    pub validation_time_ms: u64,\n}\n\n/// Individual validation error\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ValidationError {\n    pub error_type: ValidationErrorType,\n    pub message: String,\n    pub suggestion: Option\u003cString\u003e,\n}\n\n/// Types of validation errors\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum ValidationErrorType {\n    NoTaskReference,\n    TaskNotFound,\n    MissingRequiredRelationship,\n    FileScopeMismatch,\n    InvalidTaskIdFormat,\n    HookNotInstalled,\n    ConfigurationError,\n    QualityGateFailed,\n    PolicyViolation,\n    Other,\n}\n\n/// Parsed task information from commit message\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ParsedTaskInfo {\n    pub task_id: String,\n    pub format: TaskIdFormat,\n}\n\n/// Supported task ID formats\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum TaskIdFormat {\n    Brackets, // [TASK-123]\n    Colon,    // task:auth-impl-001\n    Refs,     // Refs: #456\n    Custom(String),\n}\n\n/// Performance cache for validation results\n#[derive(Debug, Default)]\npub struct ValidationCache {\n    task_cache: HashMap\u003cString, CachedTaskInfo\u003e,\n    file_cache: HashMap\u003cString, Vec\u003cString\u003e\u003e,\n}\n\n/// Cached task information for performance\n#[derive(Debug, Clone)]\npub struct CachedTaskInfo {\n    pub relationships: Vec\u003cString\u003e,\n    pub allowed_files: Vec\u003cString\u003e,\n    pub cached_at: std::time::Instant,\n    pub ttl: std::time::Duration,\n}\n\nimpl ValidationResult {\n    /// Create a successful validation result\n    pub fn success(\n        task_id: String,\n        validated_relationships: Vec\u003cString\u003e,\n        validated_files: Vec\u003cString\u003e,\n        validation_time_ms: u64,\n    ) -\u003e Self {\n        Self {\n            valid: true,\n            errors: Vec::new(),\n            task_id: Some(task_id),\n            validated_relationships,\n            validated_files,\n            validation_time_ms,\n        }\n    }\n\n    /// Create a failed validation result\n    pub fn failure(errors: Vec\u003cValidationError\u003e, validation_time_ms: u64) -\u003e Self {\n        Self {\n            valid: false,\n            errors,\n            task_id: None,\n            validated_relationships: Vec::new(),\n            validated_files: Vec::new(),\n            validation_time_ms,\n        }\n    }\n\n    /// Add an error to an existing result\n    pub fn with_error(mut self, error: ValidationError) -\u003e Self {\n        self.errors.push(error);\n        self.valid = false;\n        self\n    }\n\n    /// Get a formatted error message\n    pub fn error_summary(\u0026self) -\u003e String {\n        if self.errors.is_empty() {\n            return \"‚úÖ Validation passed\".to_string();\n        }\n\n        let mut messages = vec![\"‚ùå Validation failed:\".to_string()];\n        for (i, error) in self.errors.iter().enumerate() {\n            messages.push(format!(\"  {}. {}\", i + 1, error.message));\n            if let Some(suggestion) = \u0026error.suggestion {\n                messages.push(format!(\"     üí° {}\", suggestion));\n            }\n        }\n        messages.join(\"\\n\")\n    }\n}\n\nimpl ValidationError {\n    /// Create a new validation error\n    pub fn new(error_type: ValidationErrorType, message: String) -\u003e Self {\n        Self {\n            error_type,\n            message,\n            suggestion: None,\n        }\n    }\n\n    /// Add a suggestion to the error\n    pub fn with_suggestion(mut self, suggestion: String) -\u003e Self {\n        self.suggestion = Some(suggestion);\n        self\n    }\n}\n\nimpl ValidationCache {\n    /// Create a new validation cache\n    pub fn new() -\u003e Self {\n        Self::default()\n    }\n\n    /// Get cached task information\n    pub fn get_task_info(\u0026self, task_id: \u0026str) -\u003e Option\u003c\u0026CachedTaskInfo\u003e {\n        self.task_cache.get(task_id).and_then(|info| {\n            if info.cached_at.elapsed() \u003c info.ttl {\n                Some(info)\n            } else {\n                None\n            }\n        })\n    }\n\n    /// Cache task information\n    pub fn cache_task_info(\u0026mut self, task_id: String, info: CachedTaskInfo) {\n        self.task_cache.insert(task_id, info);\n    }\n\n    /// Get cached file list for a directory\n    pub fn get_files(\u0026self, dir_hash: \u0026str) -\u003e Option\u003c\u0026Vec\u003cString\u003e\u003e {\n        self.file_cache.get(dir_hash)\n    }\n\n    /// Cache file list for a directory\n    pub fn cache_files(\u0026mut self, dir_hash: String, files: Vec\u003cString\u003e) {\n        self.file_cache.insert(dir_hash, files);\n    }\n\n    /// Clear expired cache entries\n    pub fn cleanup_expired(\u0026mut self) {\n        self.task_cache\n            .retain(|_, info| info.cached_at.elapsed() \u003c info.ttl);\n        // Note: file cache doesn't expire as often since file changes are handled differently\n    }\n}\n\nimpl CachedTaskInfo {\n    /// Create new cached task info with default TTL\n    pub fn new(relationships: Vec\u003cString\u003e, allowed_files: Vec\u003cString\u003e) -\u003e Self {\n        Self {\n            relationships,\n            allowed_files,\n            cached_at: std::time::Instant::now(),\n            ttl: std::time::Duration::from_secs(300), // 5 minutes\n        }\n    }\n\n    /// Create new cached task info with custom TTL\n    pub fn with_ttl(\n        relationships: Vec\u003cString\u003e,\n        allowed_files: Vec\u003cString\u003e,\n        ttl: std::time::Duration,\n    ) -\u003e Self {\n        Self {\n            relationships,\n            allowed_files,\n            cached_at: std::time::Instant::now(),\n            ttl,\n        }\n    }\n\n    /// Check if the cache entry is still valid\n    pub fn is_valid(\u0026self) -\u003e bool {\n        self.cached_at.elapsed() \u003c self.ttl\n    }\n}\n","traces":[{"line":96,"address":[19347649,19347216,19347611],"length":1,"stats":{"Line":1}},{"line":104,"address":[19011437],"length":1,"stats":{"Line":1}},{"line":105,"address":[19135284],"length":1,"stats":{"Line":1}},{"line":113,"address":[19134800,19135133,19135111],"length":1,"stats":{"Line":0}},{"line":118,"address":[19011102],"length":1,"stats":{"Line":0}},{"line":119,"address":[17704919],"length":1,"stats":{"Line":0}},{"line":125,"address":[19345613,19345504],"length":1,"stats":{"Line":0}},{"line":126,"address":[24373544],"length":1,"stats":{"Line":0}},{"line":127,"address":[17644253],"length":1,"stats":{"Line":0}},{"line":128,"address":[17715025],"length":1,"stats":{"Line":0}},{"line":132,"address":[17703552,17704773,17704779],"length":1,"stats":{"Line":0}},{"line":133,"address":[19133590],"length":1,"stats":{"Line":0}},{"line":134,"address":[17715179],"length":1,"stats":{"Line":0}},{"line":137,"address":[17644434,17645544,17644362,17644627],"length":1,"stats":{"Line":0}},{"line":138,"address":[17644606,17644691],"length":1,"stats":{"Line":0}},{"line":139,"address":[17500827,17500949],"length":1,"stats":{"Line":0}},{"line":140,"address":[19134549],"length":1,"stats":{"Line":0}},{"line":141,"address":[19346676],"length":1,"stats":{"Line":0}},{"line":144,"address":[24374306],"length":1,"stats":{"Line":0}},{"line":150,"address":[24373424],"length":1,"stats":{"Line":0}},{"line":159,"address":[19009542,19009376],"length":1,"stats":{"Line":0}},{"line":160,"address":[19009495,19009403],"length":1,"stats":{"Line":0}},{"line":161,"address":[17499922],"length":1,"stats":{"Line":0}},{"line":167,"address":[17714576],"length":1,"stats":{"Line":1}},{"line":168,"address":[19345176],"length":1,"stats":{"Line":1}},{"line":172,"address":[19009184],"length":1,"stats":{"Line":0}},{"line":173,"address":[19128928],"length":1,"stats":{"Line":0}},{"line":174,"address":[17698942,17698994],"length":1,"stats":{"Line":0}},{"line":175,"address":[19129001],"length":1,"stats":{"Line":0}},{"line":177,"address":[24369081],"length":1,"stats":{"Line":0}},{"line":183,"address":[17499632],"length":1,"stats":{"Line":0}},{"line":184,"address":[24373106],"length":1,"stats":{"Line":0}},{"line":188,"address":[17643840],"length":1,"stats":{"Line":0}},{"line":189,"address":[24833874],"length":1,"stats":{"Line":0}},{"line":193,"address":[24372976],"length":1,"stats":{"Line":0}},{"line":194,"address":[17499538],"length":1,"stats":{"Line":0}},{"line":198,"address":[17499680],"length":1,"stats":{"Line":0}},{"line":200,"address":[15085331,15085296],"length":1,"stats":{"Line":0}},{"line":207,"address":[19008747,19008769,19008496],"length":1,"stats":{"Line":0}},{"line":211,"address":[19344435],"length":1,"stats":{"Line":0}},{"line":212,"address":[24833156],"length":1,"stats":{"Line":0}},{"line":217,"address":[24833630,24833376,24833608],"length":1,"stats":{"Line":0}},{"line":225,"address":[19132679],"length":1,"stats":{"Line":0}},{"line":231,"address":[17714064],"length":1,"stats":{"Line":0}},{"line":232,"address":[17499198],"length":1,"stats":{"Line":0}}],"covered":5,"coverable":45},{"path":["/","home","shift","code","vincents-ai","engram","src","validation","parser.rs"],"content":"//! Commit message parsing for task ID extraction\n\nuse crate::error::EngramError;\nuse crate::validation::{config::ValidationConfig, ParsedTaskInfo, TaskIdFormat};\nuse regex::Regex;\n\n/// Parser for extracting task IDs from commit messages\npub struct CommitMessageParser {\n    task_id_patterns: Vec\u003cRegex\u003e,\n    config: ValidationConfig,\n}\n\nimpl CommitMessageParser {\n    /// Create a new parser with default configuration\n    pub fn new() -\u003e Result\u003cSelf, EngramError\u003e {\n        let config = ValidationConfig::default();\n        Self::with_config(config)\n    }\n\n    /// Create a new parser with custom configuration\n    pub fn with_config(config: ValidationConfig) -\u003e Result\u003cSelf, EngramError\u003e {\n        let task_id_patterns = config.get_task_regexes()?;\n        Ok(Self {\n            task_id_patterns,\n            config,\n        })\n    }\n\n    /// Parse task ID from commit message\n    pub fn parse_task_id(\u0026self, message: \u0026str) -\u003e Result\u003cOption\u003cParsedTaskInfo\u003e, EngramError\u003e {\n        // Check for exemptions first\n        if self.config.should_exempt(message, \"require_task_reference\") {\n            return Ok(None);\n        }\n\n        // Try each pattern in order\n        for (pattern_index, pattern) in self.task_id_patterns.iter().enumerate() {\n            if let Some(captures) = pattern.captures(message) {\n                if let Some(task_id_match) = captures.get(1) {\n                    let task_id = task_id_match.as_str().to_string();\n                    let format = match pattern_index {\n                        0 =\u003e TaskIdFormat::Custom(\"UUID format\".to_string()),\n                        1 =\u003e TaskIdFormat::Brackets,\n                        2 =\u003e TaskIdFormat::Colon,\n                        3 =\u003e TaskIdFormat::Refs,\n                        _ =\u003e TaskIdFormat::Custom(\n                            self.config.task_id_patterns[pattern_index].name.clone(),\n                        ),\n                    };\n                    return Ok(Some(ParsedTaskInfo { task_id, format }));\n                }\n            }\n        }\n\n        Ok(None)\n    }\n\n    /// Extract all task IDs from a message (multiple tasks per commit)\n    pub fn parse_all_task_ids(\u0026self, message: \u0026str) -\u003e Result\u003cVec\u003cParsedTaskInfo\u003e, EngramError\u003e {\n        // Check for exemptions first\n        if self.config.should_exempt(message, \"require_task_reference\") {\n            return Ok(vec![]);\n        }\n\n        let mut task_ids = Vec::new();\n        let mut used_positions: Vec\u003cstd::ops::Range\u003cusize\u003e\u003e = Vec::new();\n\n        // Try each pattern in order\n        for (pattern_index, pattern) in self.task_id_patterns.iter().enumerate() {\n            for capture in pattern.captures_iter(message) {\n                if let Some(task_id_match) = capture.get(1) {\n                    let position = task_id_match.range();\n\n                    // Check if this range overlaps with already used positions\n                    let overlaps = used_positions\n                        .iter()\n                        .any(|used| position.start \u003c used.end \u0026\u0026 position.end \u003e used.start);\n\n                    if overlaps {\n                        continue;\n                    }\n\n                    let task_id = task_id_match.as_str().to_string();\n                    let format = match pattern_index {\n                        0 =\u003e TaskIdFormat::Custom(\"UUID format\".to_string()),\n                        1 =\u003e TaskIdFormat::Brackets,\n                        2 =\u003e TaskIdFormat::Colon,\n                        3 =\u003e TaskIdFormat::Refs,\n                        _ =\u003e TaskIdFormat::Custom(\n                            self.config.task_id_patterns[pattern_index].name.clone(),\n                        ),\n                    };\n\n                    task_ids.push(ParsedTaskInfo { task_id, format });\n                    used_positions.push(position);\n                }\n            }\n        }\n\n        Ok(task_ids)\n    }\n\n    /// Validate commit message format\n    pub fn validate_message(\u0026self, message: \u0026str) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        let mut errors = Vec::new();\n\n        // Check for basic commit message requirements\n        if message.trim().is_empty() {\n            errors.push(\"Commit message cannot be empty\".to_string());\n            return Ok(errors);\n        }\n\n        // Check line length (git convention)\n        let lines: Vec\u003c\u0026str\u003e = message.lines().collect();\n        if let Some(first_line) = lines.first() {\n            if first_line.len() \u003e 72 {\n                errors.push(\"First line should be 72 characters or less\".to_string());\n            }\n        }\n\n        // Check for task ID requirement\n        if !self.config.should_exempt(message, \"require_task_reference\") {\n            let has_task_id = self\n                .task_id_patterns\n                .iter()\n                .any(|pattern| pattern.is_match(message));\n\n            if !has_task_id {\n                errors.push(format!(\n                    \"Commit message must reference a task. Supported formats:\\n{}\",\n                    self.config.get_help_examples()\n                ));\n            }\n        }\n\n        // Check for common commit message issues\n        if message.ends_with('.') \u0026\u0026 message.lines().count() == 1 {\n            errors.push(\"First line should not end with a period\".to_string());\n        }\n\n        if message.starts_with(' ') {\n            errors.push(\"Commit message should not start with whitespace\".to_string());\n        }\n\n        Ok(errors)\n    }\n\n    /// Get help text for supported task ID formats\n    pub fn get_help_text(\u0026self) -\u003e String {\n        self.config.get_help_examples()\n    }\n\n    /// Check if a message matches any exemption pattern\n    pub fn is_exempt(\u0026self, message: \u0026str) -\u003e bool {\n        self.config.should_exempt(message, \"all\")\n    }\n\n    /// Extract commit type (feat, fix, docs, etc.)\n    pub fn extract_commit_type(\u0026self, message: \u0026str) -\u003e Option\u003cString\u003e {\n        let first_line = message.lines().next()?.trim();\n\n        // Common conventional commit types\n        let types = [\n            \"feat\", \"fix\", \"docs\", \"style\", \"refactor\", \"test\", \"chore\", \"perf\", \"ci\", \"build\",\n        ];\n\n        for commit_type in types {\n            if first_line.starts_with(commit_type) {\n                return Some(commit_type.to_string());\n            }\n        }\n\n        None\n    }\n\n    /// Extract commit scope from conventional commit format\n    pub fn extract_commit_scope(\u0026self, message: \u0026str) -\u003e Option\u003cString\u003e {\n        let first_line = message.lines().next()?.trim();\n\n        // Look for scope in format: type(scope): description\n        let scope_regex = Regex::new(r\"^[a-z]+\\(([^)]+)\\):\").ok()?;\n        if let Some(captures) = scope_regex.captures(first_line) {\n            captures.get(1).map(|m| m.as_str().to_string())\n        } else {\n            None\n        }\n    }\n\n    /// Parse conventional commit structure\n    pub fn parse_conventional_commit(\u0026self, message: \u0026str) -\u003e Option\u003cConventionalCommit\u003e {\n        let first_line = message.lines().next()?.trim();\n\n        // Regex for conventional commits: type(scope)!: description\n        let regex = Regex::new(r\"^([a-z]+)(?:\\(([^)]+)\\))?(!)?:\\s+(.+)$\").ok()?;\n        let captures = regex.captures(first_line)?;\n\n        let commit_type = captures.get(1)?.as_str().to_string();\n        let scope = captures.get(2).map(|m| m.as_str().to_string());\n        let breaking_change = captures.get(3).is_some();\n        let description = captures.get(4)?.as_str().to_string();\n\n        // Extract task IDs\n        let task_ids = self.parse_all_task_ids(message).ok().unwrap_or_default();\n\n        Some(ConventionalCommit {\n            commit_type,\n            scope,\n            breaking_change,\n            description,\n            task_ids,\n            body: self.extract_body(message),\n        })\n    }\n\n    /// Extract commit body (everything after first line)\n    fn extract_body(\u0026self, message: \u0026str) -\u003e Option\u003cString\u003e {\n        let lines: Vec\u003c\u0026str\u003e = message.lines().collect();\n        if lines.len() \u003c= 1 {\n            return None;\n        }\n\n        let body_lines = lines[1..].join(\"\\n\");\n        if body_lines.trim().is_empty() {\n            None\n        } else {\n            Some(body_lines.trim().to_string())\n        }\n    }\n}\n\n/// Parsed conventional commit structure\n#[derive(Debug, Clone)]\npub struct ConventionalCommit {\n    pub commit_type: String,\n    pub scope: Option\u003cString\u003e,\n    pub breaking_change: bool,\n    pub description: String,\n    pub task_ids: Vec\u003cParsedTaskInfo\u003e,\n    pub body: Option\u003cString\u003e,\n}\n\nimpl ConventionalCommit {\n    /// Get formatted representation\n    pub fn format(\u0026self) -\u003e String {\n        let mut result = String::new();\n\n        result.push_str(\u0026self.commit_type);\n\n        if let Some(scope) = \u0026self.scope {\n            result.push('(');\n            result.push_str(scope);\n            result.push(')');\n        }\n\n        if self.breaking_change {\n            result.push('!');\n        }\n\n        result.push_str(\": \");\n        result.push_str(\u0026self.description);\n\n        // Add task IDs to description if not already included\n        if !self.task_ids.is_empty() \u0026\u0026 !result.contains('[') {\n            result.push(' ');\n            result.push_str(\u0026self.task_ids[0].task_id);\n        }\n\n        result\n    }\n}\n\nimpl Default for CommitMessageParser {\n    fn default() -\u003e Self {\n        Self::new().expect(\"Failed to create default parser\")\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_brackets_format() {\n        let parser = CommitMessageParser::new().unwrap();\n        let result = parser\n            .parse_task_id(\"feat: implement user authentication [TASK-123]\")\n            .unwrap();\n\n        assert!(result.is_some());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.task_id, \"TASK-123\");\n        assert!(matches!(parsed.format, TaskIdFormat::Brackets));\n    }\n\n    #[test]\n    fn test_parse_colon_format() {\n        let parser = CommitMessageParser::new().unwrap();\n        let result = parser\n            .parse_task_id(\"fix: resolve database issue [task:auth-impl-001]\")\n            .unwrap();\n\n        assert!(result.is_some());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.task_id, \"auth-impl-001\");\n        assert!(matches!(parsed.format, TaskIdFormat::Colon));\n    }\n\n    #[test]\n    fn test_parse_refs_format() {\n        let parser = CommitMessageParser::new().unwrap();\n        let result = parser\n            .parse_task_id(\"feat: add new feature\\n\\nRefs: #456\")\n            .unwrap();\n\n        assert!(result.is_some());\n        let parsed = result.unwrap();\n        assert_eq!(parsed.task_id, \"456\");\n        assert!(matches!(parsed.format, TaskIdFormat::Refs));\n    }\n\n    #[test]\n    fn test_no_task_id() {\n        let parser = CommitMessageParser::new().unwrap();\n        let result = parser.parse_task_id(\"chore: update dependencies\").unwrap();\n\n        assert!(result.is_none());\n    }\n\n    #[test]\n    fn test_exempt_commit() {\n        let parser = CommitMessageParser::new().unwrap();\n        let result = parser.parse_task_id(\"chore: update dependencies\").unwrap();\n\n        // Should be exempt from task requirement but still return None\n        assert!(result.is_none());\n    }\n\n    #[test]\n    fn test_conventional_commit_parsing() {\n        let parser = CommitMessageParser::new().unwrap();\n        let commit = parser.parse_conventional_commit(\n            \"feat(auth): add login endpoint [TASK-123]\\n\\nImplementation details\",\n        );\n\n        assert!(commit.is_some());\n        let parsed = commit.unwrap();\n        assert_eq!(parsed.commit_type, \"feat\");\n        assert_eq!(parsed.scope, Some(\"auth\".to_string()));\n        assert_eq!(parsed.description, \"add login endpoint [TASK-123]\");\n        assert!(parsed.body.is_some());\n        assert_eq!(parsed.task_ids.len(), 1);\n    }\n\n    #[test]\n    fn test_multiple_task_ids() {\n        let parser = CommitMessageParser::new().unwrap();\n        let result = parser\n            .parse_all_task_ids(\"feat: implement [TASK-123] and related to [TASK-456]\")\n            .unwrap();\n\n        assert_eq!(result.len(), 2);\n        assert_eq!(result[0].task_id, \"TASK-123\");\n        assert_eq!(result[1].task_id, \"TASK-456\");\n    }\n}\n","traces":[{"line":15,"address":[17903632],"length":1,"stats":{"Line":1}},{"line":16,"address":[25088861],"length":1,"stats":{"Line":1}},{"line":17,"address":[17903660],"length":1,"stats":{"Line":1}},{"line":21,"address":[18419936,18420317],"length":1,"stats":{"Line":1}},{"line":22,"address":[25539263,25539206],"length":1,"stats":{"Line":2}},{"line":23,"address":[16065294],"length":1,"stats":{"Line":1}},{"line":25,"address":[17893532],"length":1,"stats":{"Line":3}},{"line":30,"address":[18421040,18422406,18422400],"length":1,"stats":{"Line":1}},{"line":32,"address":[18350352],"length":1,"stats":{"Line":1}},{"line":33,"address":[25540512],"length":1,"stats":{"Line":2}},{"line":37,"address":[19839632,19839779],"length":1,"stats":{"Line":2}},{"line":38,"address":[25079983,25080083],"length":1,"stats":{"Line":2}},{"line":39,"address":[17895019,17894968],"length":1,"stats":{"Line":2}},{"line":40,"address":[18350962,18351008],"length":1,"stats":{"Line":2}},{"line":41,"address":[16066898],"length":1,"stats":{"Line":1}},{"line":42,"address":[18351106,18351244],"length":1,"stats":{"Line":0}},{"line":43,"address":[19840385],"length":1,"stats":{"Line":1}},{"line":44,"address":[16067022],"length":1,"stats":{"Line":1}},{"line":45,"address":[19840428],"length":1,"stats":{"Line":1}},{"line":47,"address":[25080421,25080900],"length":1,"stats":{"Line":0}},{"line":50,"address":[19840540],"length":1,"stats":{"Line":1}},{"line":55,"address":[17894818],"length":1,"stats":{"Line":0}},{"line":59,"address":[18355346,18353280,18355340],"length":1,"stats":{"Line":1}},{"line":61,"address":[19842632],"length":1,"stats":{"Line":1}},{"line":62,"address":[25082815],"length":1,"stats":{"Line":0}},{"line":65,"address":[18353427],"length":1,"stats":{"Line":1}},{"line":66,"address":[18202204],"length":1,"stats":{"Line":1}},{"line":69,"address":[16069408,16069488],"length":1,"stats":{"Line":2}},{"line":70,"address":[18424963,18424843,18424714],"length":1,"stats":{"Line":4}},{"line":71,"address":[25545329,25544340,25544413],"length":1,"stats":{"Line":5}},{"line":72,"address":[18413765,18413716],"length":1,"stats":{"Line":3}},{"line":75,"address":[18203355,18203414,18203285],"length":1,"stats":{"Line":5}},{"line":77,"address":[18413867],"length":1,"stats":{"Line":3}},{"line":79,"address":[25084018],"length":1,"stats":{"Line":1}},{"line":83,"address":[18203438,18203487],"length":1,"stats":{"Line":2}},{"line":84,"address":[17898895],"length":1,"stats":{"Line":1}},{"line":85,"address":[18354979,18354844],"length":1,"stats":{"Line":0}},{"line":86,"address":[17899003],"length":1,"stats":{"Line":1}},{"line":87,"address":[16070684],"length":1,"stats":{"Line":0}},{"line":88,"address":[25084262],"length":1,"stats":{"Line":0}},{"line":90,"address":[18203567,18203946],"length":1,"stats":{"Line":0}},{"line":94,"address":[25545043],"length":1,"stats":{"Line":1}},{"line":95,"address":[17899398],"length":1,"stats":{"Line":2}},{"line":100,"address":[16069759],"length":1,"stats":{"Line":1}},{"line":104,"address":[19842483,19840912,19841971],"length":1,"stats":{"Line":0}},{"line":105,"address":[18351726],"length":1,"stats":{"Line":0}},{"line":108,"address":[18422623,18422543],"length":1,"stats":{"Line":0}},{"line":109,"address":[16067763,16068923],"length":1,"stats":{"Line":0}},{"line":110,"address":[25082467],"length":1,"stats":{"Line":0}},{"line":114,"address":[16067756,16067813],"length":1,"stats":{"Line":0}},{"line":115,"address":[19841216,19841299],"length":1,"stats":{"Line":0}},{"line":116,"address":[18411375,18411452],"length":1,"stats":{"Line":0}},{"line":117,"address":[18352210],"length":1,"stats":{"Line":0}},{"line":122,"address":[25081618,25081511],"length":1,"stats":{"Line":0}},{"line":123,"address":[25542461,25542301,25542418],"length":1,"stats":{"Line":0}},{"line":126,"address":[18418256,18418281],"length":1,"stats":{"Line":0}},{"line":128,"address":[17896585],"length":1,"stats":{"Line":0}},{"line":129,"address":[18352501],"length":1,"stats":{"Line":0}},{"line":131,"address":[16068306],"length":1,"stats":{"Line":0}},{"line":137,"address":[17896450,17896861,17896927],"length":1,"stats":{"Line":0}},{"line":138,"address":[18423607],"length":1,"stats":{"Line":0}},{"line":141,"address":[19842154,19842003],"length":1,"stats":{"Line":0}},{"line":142,"address":[16068839],"length":1,"stats":{"Line":0}},{"line":145,"address":[18352917],"length":1,"stats":{"Line":0}},{"line":149,"address":[18420992],"length":1,"stats":{"Line":0}},{"line":150,"address":[25079585],"length":1,"stats":{"Line":0}},{"line":154,"address":[25088912],"length":1,"stats":{"Line":0}},{"line":155,"address":[18418834],"length":1,"stats":{"Line":0}},{"line":159,"address":[18205036,18205042,18204144],"length":1,"stats":{"Line":0}},{"line":160,"address":[17899587],"length":1,"stats":{"Line":0}},{"line":163,"address":[18355602],"length":1,"stats":{"Line":0}},{"line":167,"address":[18204624,18204781],"length":1,"stats":{"Line":0}},{"line":168,"address":[17900319,17900255],"length":1,"stats":{"Line":0}},{"line":169,"address":[18415457],"length":1,"stats":{"Line":0}},{"line":173,"address":[18356161],"length":1,"stats":{"Line":0}},{"line":177,"address":[25085648,25086413,25086419],"length":1,"stats":{"Line":0}},{"line":178,"address":[16072147],"length":1,"stats":{"Line":0}},{"line":181,"address":[19845762],"length":1,"stats":{"Line":0}},{"line":182,"address":[18427540,18427489,18427694],"length":1,"stats":{"Line":0}},{"line":183,"address":[18406864,18406891],"length":1,"stats":{"Line":0}},{"line":185,"address":[17901041],"length":1,"stats":{"Line":0}},{"line":190,"address":[18427872,18430014,18430250],"length":1,"stats":{"Line":1}},{"line":191,"address":[16072952],"length":1,"stats":{"Line":1}},{"line":194,"address":[18357343],"length":1,"stats":{"Line":1}},{"line":195,"address":[19848728,19846798,19846849],"length":1,"stats":{"Line":2}},{"line":197,"address":[17903587,17902035,17901984],"length":1,"stats":{"Line":2}},{"line":198,"address":[16073887,16073951],"length":1,"stats":{"Line":4}},{"line":199,"address":[19847528,19847483],"length":1,"stats":{"Line":2}},{"line":200,"address":[19847585],"length":1,"stats":{"Line":1}},{"line":203,"address":[18429330,18429390],"length":1,"stats":{"Line":2}},{"line":205,"address":[18207663],"length":1,"stats":{"Line":1}},{"line":206,"address":[18358691],"length":1,"stats":{"Line":1}},{"line":207,"address":[17902859],"length":1,"stats":{"Line":1}},{"line":209,"address":[18207523],"length":1,"stats":{"Line":1}},{"line":210,"address":[16074539],"length":1,"stats":{"Line":1}},{"line":211,"address":[19848099],"length":1,"stats":{"Line":1}},{"line":216,"address":[16065440,16066064,16066070],"length":1,"stats":{"Line":1}},{"line":217,"address":[18408896],"length":1,"stats":{"Line":1}},{"line":218,"address":[17893890,17893819],"length":1,"stats":{"Line":2}},{"line":219,"address":[16065678],"length":1,"stats":{"Line":0}},{"line":222,"address":[18420624,18420536],"length":1,"stats":{"Line":2}},{"line":223,"address":[18198810,18198648,18198719],"length":1,"stats":{"Line":2}},{"line":224,"address":[17894173],"length":1,"stats":{"Line":0}},{"line":226,"address":[18420838,18420791],"length":1,"stats":{"Line":2}},{"line":244,"address":[16065031,16064368,16065037],"length":1,"stats":{"Line":0}},{"line":245,"address":[25077846],"length":1,"stats":{"Line":0}},{"line":247,"address":[25077856,25077947],"length":1,"stats":{"Line":0}},{"line":249,"address":[19837863],"length":1,"stats":{"Line":0}},{"line":250,"address":[18419454],"length":1,"stats":{"Line":0}},{"line":251,"address":[18197463],"length":1,"stats":{"Line":0}},{"line":252,"address":[25078110],"length":1,"stats":{"Line":0}},{"line":255,"address":[18419466],"length":1,"stats":{"Line":0}},{"line":256,"address":[19838063],"length":1,"stats":{"Line":0}},{"line":259,"address":[25078119],"length":1,"stats":{"Line":0}},{"line":260,"address":[18419597],"length":1,"stats":{"Line":0}},{"line":263,"address":[17893008,17893125],"length":1,"stats":{"Line":0}},{"line":264,"address":[18419808],"length":1,"stats":{"Line":0}},{"line":265,"address":[25078396],"length":1,"stats":{"Line":0}},{"line":268,"address":[25538960],"length":1,"stats":{"Line":0}},{"line":273,"address":[25089760],"length":1,"stats":{"Line":0}},{"line":274,"address":[18209185],"length":1,"stats":{"Line":0}}],"covered":57,"coverable":121},{"path":["/","home","shift","code","vincents-ai","engram","src","validation","quality_gates","mod.rs"],"content":"//! Quality Gates Framework\n//!\n//! Provides automated execution of quality gates (tests, builds, linting)\n//! with configurable validators and BDD Red-Green-Refactor cycle support.\n\nuse crate::entities::{Entity, ExecutionResult, ExpectedResult, ValidationStatus};\nuse crate::error::EngramError;\nuse crate::storage::Storage;\nuse std::collections::HashMap;\nuse std::process::{Command, Stdio};\nuse std::time::{Duration, Instant};\n\npub mod validators;\n\npub use validators::*;\n\n/// Quality gate definition\n#[derive(Debug, Clone)]\npub struct QualityGate {\n    pub name: String,\n    pub command: String,\n    pub required: bool,\n    pub expected_result: ExpectedResult,\n    pub timeout_seconds: Option\u003cu64\u003e,\n    pub working_directory: Option\u003cString\u003e,\n    pub environment: HashMap\u003cString, String\u003e,\n    pub retry_count: u32,\n    pub failure_message: Option\u003cString\u003e,\n}\n\nimpl QualityGate {\n    pub fn new(name: String, command: String) -\u003e Self {\n        Self {\n            name,\n            command,\n            required: true,\n            expected_result: ExpectedResult::Success,\n            timeout_seconds: Some(300),\n            working_directory: None,\n            environment: HashMap::new(),\n            retry_count: 0,\n            failure_message: None,\n        }\n    }\n\n    pub fn with_expected_result(mut self, expected: ExpectedResult) -\u003e Self {\n        self.expected_result = expected;\n        self\n    }\n\n    pub fn with_timeout(mut self, seconds: u64) -\u003e Self {\n        self.timeout_seconds = Some(seconds);\n        self\n    }\n\n    pub fn optional(mut self) -\u003e Self {\n        self.required = false;\n        self\n    }\n\n    pub fn with_working_directory(mut self, dir: String) -\u003e Self {\n        self.working_directory = Some(dir);\n        self\n    }\n\n    pub fn with_environment(mut self, env: HashMap\u003cString, String\u003e) -\u003e Self {\n        self.environment = env;\n        self\n    }\n\n    pub fn with_retry_count(mut self, retries: u32) -\u003e Self {\n        self.retry_count = retries;\n        self\n    }\n\n    pub fn with_failure_message(mut self, message: String) -\u003e Self {\n        self.failure_message = Some(message);\n        self\n    }\n}\n\n/// Quality gates executor\npub struct QualityGatesExecutor\u003cS: Storage\u003e {\n    storage: S,\n}\n\nimpl\u003cS: Storage\u003e QualityGatesExecutor\u003cS\u003e {\n    pub fn new(storage: S) -\u003e Self {\n        Self { storage }\n    }\n\n    /// Execute a single quality gate\n    pub fn execute_gate(\n        \u0026mut self,\n        task_id: \u0026str,\n        workflow_stage: \u0026str,\n        gate: \u0026QualityGate,\n        agent: \u0026str,\n    ) -\u003e Result\u003cExecutionResult, EngramError\u003e {\n        let mut execution_result = ExecutionResult::new(\n            task_id.to_string(),\n            workflow_stage.to_string(),\n            gate.name.clone(),\n            gate.command.clone(),\n            agent.to_string(),\n        );\n\n        execution_result.set_expected_result(gate.expected_result.clone());\n\n        if let Some(working_dir) = \u0026gate.working_directory {\n            execution_result.working_directory = Some(working_dir.clone());\n        }\n\n        execution_result.set_environment(gate.environment.clone());\n\n        let start_time = Instant::now();\n        let mut attempts = 0;\n        let max_attempts = gate.retry_count + 1;\n\n        loop {\n            attempts += 1;\n\n            let result = self.execute_command_with_timeout(gate);\n\n            match result {\n                Ok((exit_code, stdout, stderr)) =\u003e {\n                    let duration = start_time.elapsed().as_millis() as u64;\n                    execution_result.set_results(exit_code, stdout, stderr, duration);\n\n                    if attempts \u003e 1 {\n                        execution_result.retry_count = attempts - 1;\n                    }\n\n                    break;\n                }\n                Err(_e) if attempts \u003c max_attempts =\u003e {\n                    continue;\n                }\n                Err(e) =\u003e {\n                    let duration = start_time.elapsed().as_millis() as u64;\n                    execution_result.set_results(-1, String::new(), e.to_string(), duration);\n                    execution_result.validation_status = ValidationStatus::Failed {\n                        reason: format!(\n                            \"Failed to execute command after {} attempts: {}\",\n                            attempts, e\n                        ),\n                    };\n                    break;\n                }\n            }\n        }\n\n        if execution_result.failed() \u0026\u0026 !gate.required {\n            execution_result.validation_status = ValidationStatus::Skipped {\n                reason: \"Gate failed but is not required\".to_string(),\n            };\n        }\n\n        if execution_result.failed() \u0026\u0026 gate.failure_message.is_some() {\n            execution_result.add_metadata(\n                \"custom_failure_message\".to_string(),\n                serde_json::Value::String(gate.failure_message.as_ref().unwrap().clone()),\n            );\n        }\n\n        let generic = execution_result.to_generic();\n        self.storage.store(\u0026generic)?;\n\n        Ok(execution_result)\n    }\n\n    /// Execute multiple quality gates\n    pub fn execute_gates(\n        \u0026mut self,\n        task_id: \u0026str,\n        workflow_stage: \u0026str,\n        gates: \u0026[QualityGate],\n        agent: \u0026str,\n    ) -\u003e Result\u003cVec\u003cExecutionResult\u003e, EngramError\u003e {\n        let mut results = Vec::new();\n        let mut has_required_failure = false;\n\n        for gate in gates {\n            let result = self.execute_gate(task_id, workflow_stage, gate, agent)?;\n\n            if result.failed() \u0026\u0026 gate.required {\n                has_required_failure = true;\n            }\n\n            results.push(result);\n\n            if has_required_failure \u0026\u0026 gate.required {\n                break;\n            }\n        }\n\n        Ok(results)\n    }\n\n    fn execute_command_with_timeout(\n        \u0026self,\n        gate: \u0026QualityGate,\n    ) -\u003e Result\u003c(i32, String, String), EngramError\u003e {\n        let parts: Vec\u003c\u0026str\u003e = gate.command.split_whitespace().collect();\n        if parts.is_empty() {\n            return Err(EngramError::Validation(\"Empty command\".to_string()));\n        }\n\n        let mut cmd = Command::new(parts[0]);\n        if parts.len() \u003e 1 {\n            cmd.args(\u0026parts[1..]);\n        }\n\n        if let Some(working_dir) = \u0026gate.working_directory {\n            cmd.current_dir(working_dir);\n        }\n\n        for (key, value) in \u0026gate.environment {\n            cmd.env(key, value);\n        }\n\n        cmd.stdout(Stdio::piped()).stderr(Stdio::piped());\n\n        let child = cmd.spawn().map_err(|e| {\n            EngramError::Validation(format!(\"Failed to spawn command '{}': {}\", gate.command, e))\n        })?;\n\n        let timeout_duration = gate\n            .timeout_seconds\n            .map(Duration::from_secs)\n            .unwrap_or(Duration::from_secs(300));\n\n        let output = match self.wait_for_output_with_timeout(child, timeout_duration) {\n            Ok(output) =\u003e output,\n            Err(e) =\u003e return Err(e),\n        };\n\n        let stdout = String::from_utf8_lossy(\u0026output.stdout).to_string();\n        let stderr = String::from_utf8_lossy(\u0026output.stderr).to_string();\n        let exit_code = output.status.code().unwrap_or(-1);\n\n        Ok((exit_code, stdout, stderr))\n    }\n\n    fn wait_for_output_with_timeout(\n        \u0026self,\n        child: std::process::Child,\n        timeout: Duration,\n    ) -\u003e Result\u003cstd::process::Output, EngramError\u003e {\n        use std::sync::mpsc;\n        use std::thread;\n\n        let (tx, rx) = mpsc::channel();\n\n        thread::spawn(move || {\n            let result = child.wait_with_output();\n            let _ = tx.send(result);\n        });\n\n        match rx.recv_timeout(timeout) {\n            Ok(Ok(output)) =\u003e Ok(output),\n            Ok(Err(e)) =\u003e Err(EngramError::Validation(format!(\n                \"Command execution failed: {}\",\n                e\n            ))),\n            Err(_) =\u003e Err(EngramError::Validation(\"Command timed out\".to_string())),\n        }\n    }\n\n    /// Get execution results for a task\n    pub fn get_execution_results(\n        \u0026self,\n        task_id: \u0026str,\n        workflow_stage: Option\u003c\u0026str\u003e,\n    ) -\u003e Result\u003cVec\u003cExecutionResult\u003e, EngramError\u003e {\n        use crate::storage::QueryFilter;\n\n        let mut filter = QueryFilter {\n            entity_type: Some(\"execution_result\".to_string()),\n            limit: Some(100),\n            ..Default::default()\n        };\n\n        let mut field_filters = HashMap::new();\n        field_filters.insert(\n            \"task_id\".to_string(),\n            serde_json::Value::String(task_id.to_string()),\n        );\n\n        if let Some(stage) = workflow_stage {\n            field_filters.insert(\n                \"workflow_stage\".to_string(),\n                serde_json::Value::String(stage.to_string()),\n            );\n        }\n\n        filter.field_filters = field_filters;\n\n        let query_result = self.storage.query(\u0026filter)?;\n        let mut results = Vec::new();\n\n        for entity in query_result.entities {\n            if let Ok(execution_result) = ExecutionResult::from_generic(entity) {\n                results.push(execution_result);\n            }\n        }\n\n        results.sort_by(|a, b| b.timestamp.cmp(\u0026a.timestamp));\n        Ok(results)\n    }\n\n    /// Check if all required gates passed for a workflow stage\n    pub fn stage_gates_passed(\n        \u0026self,\n        task_id: \u0026str,\n        workflow_stage: \u0026str,\n    ) -\u003e Result\u003cbool, EngramError\u003e {\n        let results = self.get_execution_results(task_id, Some(workflow_stage))?;\n\n        if results.is_empty() {\n            return Ok(false);\n        }\n\n        let mut required_gates: HashMap\u003cString, bool\u003e = HashMap::new();\n\n        for result in results {\n            if result.passed() || result.skipped() {\n                required_gates.insert(result.quality_gate, true);\n            } else {\n                required_gates.insert(result.quality_gate, false);\n            }\n        }\n\n        Ok(required_gates.values().all(|\u0026passed| passed))\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::storage::MemoryStorage;\n\n    #[test]\n    fn test_quality_gate_creation() {\n        let gate = QualityGate::new(\"test\".to_string(), \"echo hello\".to_string())\n            .with_expected_result(ExpectedResult::Success)\n            .with_timeout(60)\n            .optional();\n\n        assert_eq!(gate.name, \"test\");\n        assert_eq!(gate.command, \"echo hello\");\n        assert!(!gate.required);\n        assert_eq!(gate.timeout_seconds, Some(60));\n    }\n\n    #[test]\n    fn test_execute_successful_gate() {\n        let storage = MemoryStorage::new(\"test-agent\");\n        let mut executor = QualityGatesExecutor::new(storage);\n\n        let gate = QualityGate::new(\"echo-test\".to_string(), \"echo hello world\".to_string());\n\n        let result = executor\n            .execute_gate(\"task-123\", \"test\", \u0026gate, \"test-agent\")\n            .unwrap();\n\n        assert_eq!(result.task_id, \"task-123\");\n        assert_eq!(result.workflow_stage, \"test\");\n        assert_eq!(result.quality_gate, \"echo-test\");\n        assert_eq!(result.exit_code, 0);\n        assert!(result.passed());\n        assert!(result.stdout.contains(\"hello world\"));\n    }\n\n    #[test]\n    fn test_execute_failing_gate() {\n        let storage = MemoryStorage::new(\"test-agent\");\n        let mut executor = QualityGatesExecutor::new(storage);\n\n        let gate = QualityGate::new(\"false-test\".to_string(), \"false\".to_string());\n\n        let result = executor\n            .execute_gate(\"task-123\", \"test\", \u0026gate, \"test-agent\")\n            .unwrap();\n\n        assert_ne!(result.exit_code, 0);\n        assert!(result.failed());\n    }\n\n    #[test]\n    fn test_bdd_red_phase_gate() {\n        let storage = MemoryStorage::new(\"test-agent\");\n        let mut executor = QualityGatesExecutor::new(storage);\n\n        let gate = QualityGate::new(\"test-should-fail\".to_string(), \"false\".to_string())\n            .with_expected_result(ExpectedResult::Failure);\n\n        let result = executor\n            .execute_gate(\"task-123\", \"bdd\", \u0026gate, \"test-agent\")\n            .unwrap();\n\n        assert_ne!(result.exit_code, 0);\n        assert!(result.passed());\n    }\n\n    #[test]\n    fn test_multiple_gates_execution() {\n        let storage = MemoryStorage::new(\"test-agent\");\n        let mut executor = QualityGatesExecutor::new(storage);\n\n        let gates = vec![\n            QualityGate::new(\"echo1\".to_string(), \"echo test1\".to_string()),\n            QualityGate::new(\"echo2\".to_string(), \"echo test2\".to_string()),\n        ];\n\n        let results = executor\n            .execute_gates(\"task-123\", \"test\", \u0026gates, \"test-agent\")\n            .unwrap();\n\n        assert_eq!(results.len(), 2);\n        assert!(results.iter().all(|r| r.passed()));\n    }\n\n    #[test]\n    fn test_optional_gate_failure() {\n        let storage = MemoryStorage::new(\"test-agent\");\n        let mut executor = QualityGatesExecutor::new(storage);\n\n        let gate = QualityGate::new(\"optional-fail\".to_string(), \"false\".to_string()).optional();\n\n        let result = executor\n            .execute_gate(\"task-123\", \"test\", \u0026gate, \"test-agent\")\n            .unwrap();\n\n        assert!(result.skipped());\n    }\n}\n","traces":[{"line":32,"address":[18530368,18530032,18530406],"length":1,"stats":{"Line":1}},{"line":40,"address":[15767814],"length":1,"stats":{"Line":1}},{"line":46,"address":[24380096],"length":1,"stats":{"Line":1}},{"line":47,"address":[23919442],"length":1,"stats":{"Line":1}},{"line":48,"address":[15767336],"length":1,"stats":{"Line":1}},{"line":51,"address":[18529312],"length":1,"stats":{"Line":1}},{"line":52,"address":[17045697],"length":1,"stats":{"Line":1}},{"line":53,"address":[17249068],"length":1,"stats":{"Line":1}},{"line":56,"address":[17190912],"length":1,"stats":{"Line":1}},{"line":57,"address":[23920264],"length":1,"stats":{"Line":1}},{"line":58,"address":[15768143],"length":1,"stats":{"Line":1}},{"line":61,"address":[17249568,17249734],"length":1,"stats":{"Line":0}},{"line":62,"address":[18529867,18529959],"length":1,"stats":{"Line":0}},{"line":63,"address":[15767694],"length":1,"stats":{"Line":0}},{"line":66,"address":[17260775,17260608],"length":1,"stats":{"Line":0}},{"line":67,"address":[17045760,17045851],"length":1,"stats":{"Line":0}},{"line":68,"address":[17260755],"length":1,"stats":{"Line":0}},{"line":71,"address":[18529552],"length":1,"stats":{"Line":0}},{"line":72,"address":[18679296],"length":1,"stats":{"Line":0}},{"line":73,"address":[17190054],"length":1,"stats":{"Line":0}},{"line":76,"address":[17046016,17046182],"length":1,"stats":{"Line":0}},{"line":77,"address":[24380171,24380263],"length":1,"stats":{"Line":0}},{"line":78,"address":[15767502],"length":1,"stats":{"Line":0}},{"line":88,"address":[14338240],"length":1,"stats":{"Line":1}},{"line":93,"address":[14328432,14330424,14332774],"length":1,"stats":{"Line":1}},{"line":101,"address":[14328720],"length":1,"stats":{"Line":2}},{"line":102,"address":[14328838,14328785],"length":1,"stats":{"Line":3}},{"line":103,"address":[],"length":0,"stats":{"Line":3}},{"line":104,"address":[14328923,14329000],"length":1,"stats":{"Line":2}},{"line":105,"address":[14329008],"length":1,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":2}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":3}},{"line":116,"address":[14329642],"length":1,"stats":{"Line":1}},{"line":117,"address":[],"length":0,"stats":{"Line":2}},{"line":118,"address":[14329743,14329711],"length":1,"stats":{"Line":3}},{"line":120,"address":[14329741],"length":1,"stats":{"Line":2}},{"line":121,"address":[14329825,14329763],"length":1,"stats":{"Line":1}},{"line":123,"address":[],"length":0,"stats":{"Line":2}},{"line":125,"address":[14329843],"length":1,"stats":{"Line":3}},{"line":126,"address":[14329922],"length":1,"stats":{"Line":2}},{"line":127,"address":[],"length":0,"stats":{"Line":5}},{"line":128,"address":[14330150],"length":1,"stats":{"Line":3}},{"line":130,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[14330528,14329884],"length":1,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[14330452],"length":1,"stats":{"Line":0}},{"line":140,"address":[14330500,14330643],"length":1,"stats":{"Line":0}},{"line":141,"address":[14332330,14330707,14330745],"length":1,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[14330851],"length":1,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":6}},{"line":154,"address":[14331348,14331407],"length":1,"stats":{"Line":1}},{"line":155,"address":[14331317],"length":1,"stats":{"Line":1}},{"line":159,"address":[],"length":0,"stats":{"Line":4}},{"line":160,"address":[14331852],"length":1,"stats":{"Line":0}},{"line":161,"address":[14331656],"length":1,"stats":{"Line":0}},{"line":162,"address":[14331769,14331703],"length":1,"stats":{"Line":0}},{"line":166,"address":[14331609],"length":1,"stats":{"Line":2}},{"line":167,"address":[14331991,14331928],"length":1,"stats":{"Line":3}},{"line":169,"address":[14332107],"length":1,"stats":{"Line":2}},{"line":173,"address":[14333984,14332896,14333955],"length":1,"stats":{"Line":1}},{"line":180,"address":[],"length":0,"stats":{"Line":1}},{"line":181,"address":[14333137],"length":1,"stats":{"Line":1}},{"line":183,"address":[14333889,14333145,14333224],"length":1,"stats":{"Line":3}},{"line":184,"address":[14333369,14333518],"length":1,"stats":{"Line":2}},{"line":186,"address":[14333852,14333869,14333778,14333722],"length":1,"stats":{"Line":2}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[14333784],"length":1,"stats":{"Line":1}},{"line":192,"address":[],"length":0,"stats":{"Line":1}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":1}},{"line":200,"address":[14336569,14336375,14334000],"length":1,"stats":{"Line":1}},{"line":204,"address":[],"length":0,"stats":{"Line":2}},{"line":205,"address":[],"length":0,"stats":{"Line":3}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[14334219,14334299],"length":1,"stats":{"Line":3}},{"line":210,"address":[],"length":0,"stats":{"Line":3}},{"line":211,"address":[14334468],"length":1,"stats":{"Line":1}},{"line":214,"address":[],"length":0,"stats":{"Line":2}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[14334607,14334586],"length":1,"stats":{"Line":3}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":1}},{"line":224,"address":[],"length":0,"stats":{"Line":2}},{"line":225,"address":[14336622,14336707],"length":1,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":2}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":1}},{"line":231,"address":[],"length":0,"stats":{"Line":2}},{"line":233,"address":[],"length":0,"stats":{"Line":3}},{"line":234,"address":[14335494],"length":1,"stats":{"Line":3}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":5}},{"line":239,"address":[],"length":0,"stats":{"Line":2}},{"line":240,"address":[14336047],"length":1,"stats":{"Line":3}},{"line":242,"address":[],"length":0,"stats":{"Line":2}},{"line":245,"address":[14338037,14337805,14336928],"length":1,"stats":{"Line":1}},{"line":253,"address":[],"length":0,"stats":{"Line":4}},{"line":255,"address":[],"length":0,"stats":{"Line":4}},{"line":256,"address":[14338091],"length":1,"stats":{"Line":1}},{"line":257,"address":[],"length":0,"stats":{"Line":1}},{"line":260,"address":[14337274,14337352],"length":1,"stats":{"Line":4}},{"line":261,"address":[14337440],"length":1,"stats":{"Line":2}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[14337318,14337816],"length":1,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}}],"covered":74,"coverable":141},{"path":["/","home","shift","code","vincents-ai","engram","src","validation","quality_gates","validators.rs"],"content":"use super::{ExpectedResult, QualityGate};\nuse std::collections::HashMap;\n\npub struct BuiltinValidators;\n\nimpl BuiltinValidators {\n    /// Cargo test runner\n    pub fn cargo_test() -\u003e QualityGate {\n        QualityGate::new(\"cargo-test\".to_string(), \"cargo test\".to_string()).with_timeout(600)\n    }\n\n    /// Cargo test runner expecting failure (BDD RED phase)\n    pub fn cargo_test_red_phase() -\u003e QualityGate {\n        QualityGate::new(\"cargo-test-red\".to_string(), \"cargo test\".to_string())\n            .with_expected_result(ExpectedResult::Failure)\n            .with_timeout(600)\n            .with_failure_message(\n                \"Tests should fail in BDD RED phase - this proves they're testing something real\"\n                    .to_string(),\n            )\n    }\n\n    /// Cargo clippy linter\n    pub fn cargo_clippy() -\u003e QualityGate {\n        QualityGate::new(\n            \"cargo-clippy\".to_string(),\n            \"cargo clippy -- -D warnings\".to_string(),\n        )\n        .with_timeout(300)\n    }\n\n    /// Cargo clippy linter (optional)\n    pub fn cargo_clippy_optional() -\u003e QualityGate {\n        Self::cargo_clippy().optional()\n    }\n\n    /// Nix build\n    pub fn nix_build() -\u003e QualityGate {\n        QualityGate::new(\"nix-build\".to_string(), \"nix build\".to_string()).with_timeout(1200)\n    }\n\n    /// Nix checks\n    pub fn nix_checks() -\u003e QualityGate {\n        QualityGate::new(\"nix-checks\".to_string(), \"nix flake check\".to_string()).with_timeout(900)\n    }\n\n    /// Custom engram validation\n    pub fn engram_validate(validation_type: \u0026str) -\u003e QualityGate {\n        QualityGate::new(\n            format!(\"engram-validate-{}\", validation_type),\n            format!(\"engram validate {}\", validation_type),\n        )\n        .with_timeout(120)\n    }\n\n    /// Git status check (no uncommitted changes)\n    pub fn git_status_clean() -\u003e QualityGate {\n        QualityGate::new(\n            \"git-status-clean\".to_string(),\n            \"sh -c 'git diff --quiet \u0026\u0026 git diff --cached --quiet'\".to_string(),\n        )\n        .with_timeout(30)\n    }\n\n    /// Full test suite with all features\n    pub fn full_test_suite() -\u003e QualityGate {\n        QualityGate::new(\n            \"full-test-suite\".to_string(),\n            \"cargo test --all-features\".to_string(),\n        )\n        .with_timeout(1200)\n    }\n\n    /// Create quality gates for a specific workflow stage\n    pub fn for_stage(stage: \u0026str) -\u003e Vec\u003cQualityGate\u003e {\n        match stage {\n            \"requirements\" =\u003e vec![Self::engram_validate(\"requirements-complete\")],\n            \"planning\" =\u003e vec![Self::engram_validate(\"design-documented\")],\n            \"research\" =\u003e vec![Self::engram_validate(\"research-documented\")],\n            \"bdd\" =\u003e vec![Self::cargo_test_red_phase()],\n            \"development\" =\u003e vec![Self::cargo_test(), Self::cargo_clippy_optional()],\n            \"integration\" =\u003e vec![\n                Self::nix_build(),\n                Self::full_test_suite(),\n                Self::git_status_clean().optional(),\n            ],\n            _ =\u003e vec![],\n        }\n    }\n\n    /// Create development environment setup gates\n    pub fn development_setup() -\u003e Vec\u003cQualityGate\u003e {\n        vec![\n            QualityGate::new(\"rust-version\".to_string(), \"rustc --version\".to_string())\n                .with_timeout(30),\n            QualityGate::new(\"cargo-version\".to_string(), \"cargo --version\".to_string())\n                .with_timeout(30),\n            QualityGate::new(\"nix-version\".to_string(), \"nix --version\".to_string())\n                .with_timeout(30)\n                .optional(),\n        ]\n    }\n\n    /// Create custom gate with environment variables\n    pub fn with_env(name: String, command: String, env: HashMap\u003cString, String\u003e) -\u003e QualityGate {\n        QualityGate::new(name, command).with_environment(env)\n    }\n\n    /// Create performance benchmark gate\n    pub fn performance_benchmark(benchmark_name: \u0026str) -\u003e QualityGate {\n        QualityGate::new(\n            format!(\"benchmark-{}\", benchmark_name),\n            format!(\"cargo bench --bench {}\", benchmark_name),\n        )\n        .with_timeout(600)\n        .optional()\n    }\n\n    /// Create security audit gate\n    pub fn security_audit() -\u003e QualityGate {\n        QualityGate::new(\"security-audit\".to_string(), \"cargo audit\".to_string()).with_timeout(180)\n    }\n\n    /// Create documentation generation gate\n    pub fn docs_generation() -\u003e QualityGate {\n        QualityGate::new(\n            \"docs-generation\".to_string(),\n            \"cargo doc --no-deps\".to_string(),\n        )\n        .with_timeout(300)\n        .optional()\n    }\n\n    /// Create format check gate\n    pub fn format_check() -\u003e QualityGate {\n        QualityGate::new(\n            \"format-check\".to_string(),\n            \"cargo fmt -- --check\".to_string(),\n        )\n        .with_timeout(60)\n    }\n}\n","traces":[{"line":8,"address":[19978448,19978660,19978692],"length":1,"stats":{"Line":0}},{"line":9,"address":[19978465,19978673,19978549],"length":1,"stats":{"Line":0}},{"line":13,"address":[19982409,19982016,19982384],"length":1,"stats":{"Line":0}},{"line":14,"address":[19982335,19982415,19982120,19982033],"length":1,"stats":{"Line":0}},{"line":15,"address":[19982233],"length":1,"stats":{"Line":0}},{"line":19,"address":[19982265],"length":1,"stats":{"Line":0}},{"line":24,"address":[19979165,19979197,19978960],"length":1,"stats":{"Line":0}},{"line":26,"address":[19978984],"length":1,"stats":{"Line":0}},{"line":27,"address":[19979031],"length":1,"stats":{"Line":0}},{"line":33,"address":[19982448],"length":1,"stats":{"Line":0}},{"line":34,"address":[19982464],"length":1,"stats":{"Line":0}},{"line":38,"address":[19985104,19985316,19985348],"length":1,"stats":{"Line":0}},{"line":39,"address":[19985205,19985121,19985329],"length":1,"stats":{"Line":0}},{"line":43,"address":[19978704,19978909,19978941],"length":1,"stats":{"Line":0}},{"line":44,"address":[19978922,19978720,19978799],"length":1,"stats":{"Line":0}},{"line":48,"address":[19980461,19980429,19980000],"length":1,"stats":{"Line":0}},{"line":50,"address":[19980045],"length":1,"stats":{"Line":0}},{"line":51,"address":[19980252,19980191],"length":1,"stats":{"Line":0}},{"line":57,"address":[19980941,19980736,19980973],"length":1,"stats":{"Line":0}},{"line":59,"address":[19980760],"length":1,"stats":{"Line":0}},{"line":60,"address":[19980807],"length":1,"stats":{"Line":0}},{"line":66,"address":[19980717,19980480,19980685],"length":1,"stats":{"Line":0}},{"line":68,"address":[19980504],"length":1,"stats":{"Line":0}},{"line":69,"address":[19980551],"length":1,"stats":{"Line":0}},{"line":75,"address":[19984129,19984121,19983216],"length":1,"stats":{"Line":0}},{"line":77,"address":[19983275,19983339,19984937],"length":1,"stats":{"Line":0}},{"line":78,"address":[19984763,19983306,19983419],"length":1,"stats":{"Line":0}},{"line":79,"address":[19984586,19983386,19983505],"length":1,"stats":{"Line":0}},{"line":80,"address":[19983472,19983591,19984409],"length":1,"stats":{"Line":0}},{"line":81,"address":[19983558,19984150,19983665],"length":1,"stats":{"Line":0}},{"line":82,"address":[19984127,19983632,19983718,19983822,19983767,19983874,19983926],"length":1,"stats":{"Line":0}},{"line":83,"address":[19983739],"length":1,"stats":{"Line":0}},{"line":84,"address":[19983807],"length":1,"stats":{"Line":0}},{"line":85,"address":[19983859,19983919],"length":1,"stats":{"Line":0}},{"line":87,"address":[19983701],"length":1,"stats":{"Line":0}},{"line":92,"address":[19980992,19981952,19982002],"length":1,"stats":{"Line":0}},{"line":93,"address":[19981917,19981736,19981089,19981009,19981306,19981529],"length":1,"stats":{"Line":0}},{"line":94,"address":[19981160,19981121,19981980,19981053],"length":1,"stats":{"Line":0}},{"line":95,"address":[19981263],"length":1,"stats":{"Line":0}},{"line":96,"address":[19981338,19981377,19981270,19981958],"length":1,"stats":{"Line":0}},{"line":97,"address":[19981483],"length":1,"stats":{"Line":0}},{"line":98,"address":[19981561,19981600,19981490,19981930],"length":1,"stats":{"Line":0}},{"line":99,"address":[19981706],"length":1,"stats":{"Line":0}},{"line":100,"address":[19981729],"length":1,"stats":{"Line":0}},{"line":105,"address":[19983200,19983008,19983176],"length":1,"stats":{"Line":0}},{"line":106,"address":[19983029,19983100],"length":1,"stats":{"Line":0}},{"line":110,"address":[19982512,19982960,19982992],"length":1,"stats":{"Line":0}},{"line":112,"address":[19982556],"length":1,"stats":{"Line":0}},{"line":113,"address":[19982763,19982702],"length":1,"stats":{"Line":0}},{"line":120,"address":[19979472,19979677,19979709],"length":1,"stats":{"Line":0}},{"line":121,"address":[19979690,19979488,19979567],"length":1,"stats":{"Line":0}},{"line":125,"address":[19979960,19979992,19979728],"length":1,"stats":{"Line":0}},{"line":127,"address":[19979753],"length":1,"stats":{"Line":0}},{"line":128,"address":[19979800],"length":1,"stats":{"Line":0}},{"line":135,"address":[19979216,19979421,19979453],"length":1,"stats":{"Line":0}},{"line":137,"address":[19979240],"length":1,"stats":{"Line":0}},{"line":138,"address":[19979287],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":57},{"path":["/","home","shift","code","vincents-ai","engram","src","validation","stage_transitions.rs"],"content":"//! Automatic workflow stage transition system\n//!\n//! Handles automatic advancement of workflow stages based on quality gate results\n//! and stage completion criteria, particularly for BDD Red-Green-Refactor cycles.\n\nuse crate::engines::workflow_engine::WorkflowAutomationEngine;\nuse crate::error::EngramError;\nuse crate::storage::{RelationshipStorage, Storage};\nuse std::collections::HashMap;\n\n/// Automatic stage transition manager\npub struct StageTransitionManager\u003cS: Storage + RelationshipStorage\u003e {\n    /// Workflow automation engine\n    workflow_engine: WorkflowAutomationEngine\u003cS\u003e,\n    /// Stage transition rules\n    transition_rules: HashMap\u003cString, StageTransitionRule\u003e,\n}\n\n/// Rule for automatic stage transitions\n#[derive(Debug, Clone)]\npub struct StageTransitionRule {\n    /// Current stage name\n    pub from_stage: String,\n    /// Target stage name\n    pub to_stage: String,\n    /// Quality gates that must pass for transition\n    pub required_gates: Vec\u003cString\u003e,\n    /// Additional conditions that must be met\n    pub conditions: Vec\u003cTransitionCondition\u003e,\n    /// Whether this transition should happen automatically\n    pub automatic: bool,\n    /// Maximum number of attempts before manual intervention required\n    pub max_attempts: Option\u003cu32\u003e,\n}\n\n/// Conditions for stage transitions\n#[derive(Debug, Clone)]\npub enum TransitionCondition {\n    /// All tests must pass\n    AllTestsPass,\n    /// All tests must fail (for BDD Red phase)\n    AllTestsFail,\n    /// Build must succeed\n    BuildSucceeds,\n    /// No new test files added\n    NoNewTests,\n    /// Minimum code coverage maintained\n    MinimumCoverage(f64),\n    /// Custom condition with command\n    CustomCommand(String),\n}\n\n/// Result of checking transition eligibility\n#[derive(Debug)]\npub struct TransitionEligibility {\n    pub eligible: bool,\n    pub reason: String,\n    pub next_stage: Option\u003cString\u003e,\n    pub required_actions: Vec\u003cString\u003e,\n}\n\nimpl\u003cS: Storage + RelationshipStorage\u003e StageTransitionManager\u003cS\u003e {\n    /// Create a new stage transition manager\n    pub fn new(storage: S) -\u003e Result\u003cSelf, EngramError\u003e {\n        let workflow_engine = WorkflowAutomationEngine::new(storage);\n        let transition_rules = Self::default_transition_rules();\n\n        Ok(Self {\n            workflow_engine,\n            transition_rules,\n        })\n    }\n\n    /// Define default BDD and development stage transition rules\n    fn default_transition_rules() -\u003e HashMap\u003cString, StageTransitionRule\u003e {\n        let mut rules = HashMap::new();\n\n        // Requirements ‚Üí Planning\n        rules.insert(\n            \"requirements_to_planning\".to_string(),\n            StageTransitionRule {\n                from_stage: \"requirements\".to_string(),\n                to_stage: \"planning\".to_string(),\n                required_gates: vec![\"requirements_validation\".to_string()],\n                conditions: vec![],\n                automatic: true,\n                max_attempts: Some(3),\n            },\n        );\n\n        // Planning ‚Üí BDD Red\n        rules.insert(\n            \"planning_to_bdd_red\".to_string(),\n            StageTransitionRule {\n                from_stage: \"planning\".to_string(),\n                to_stage: \"bdd_red\".to_string(),\n                required_gates: vec![\"planning_validation\".to_string()],\n                conditions: vec![],\n                automatic: true,\n                max_attempts: Some(3),\n            },\n        );\n\n        // BDD Red ‚Üí BDD Green (when tests fail as expected)\n        rules.insert(\n            \"bdd_red_to_green\".to_string(),\n            StageTransitionRule {\n                from_stage: \"bdd_red\".to_string(),\n                to_stage: \"bdd_green\".to_string(),\n                required_gates: vec![\"bdd_red_gates\".to_string()],\n                conditions: vec![TransitionCondition::AllTestsFail],\n                automatic: true,\n                max_attempts: Some(5),\n            },\n        );\n\n        // BDD Green ‚Üí BDD Refactor (when tests pass)\n        rules.insert(\n            \"bdd_green_to_refactor\".to_string(),\n            StageTransitionRule {\n                from_stage: \"bdd_green\".to_string(),\n                to_stage: \"bdd_refactor\".to_string(),\n                required_gates: vec![\"bdd_green_gates\".to_string()],\n                conditions: vec![\n                    TransitionCondition::AllTestsPass,\n                    TransitionCondition::BuildSucceeds,\n                ],\n                automatic: true,\n                max_attempts: Some(3),\n            },\n        );\n\n        // BDD Refactor ‚Üí Development (when refactoring complete)\n        rules.insert(\n            \"bdd_refactor_to_development\".to_string(),\n            StageTransitionRule {\n                from_stage: \"bdd_refactor\".to_string(),\n                to_stage: \"development\".to_string(),\n                required_gates: vec![\"bdd_refactor_gates\".to_string()],\n                conditions: vec![\n                    TransitionCondition::AllTestsPass,\n                    TransitionCondition::BuildSucceeds,\n                    TransitionCondition::NoNewTests,\n                ],\n                automatic: true,\n                max_attempts: Some(3),\n            },\n        );\n\n        // Development ‚Üí Integration (when development complete)\n        rules.insert(\n            \"development_to_integration\".to_string(),\n            StageTransitionRule {\n                from_stage: \"development\".to_string(),\n                to_stage: \"integration\".to_string(),\n                required_gates: vec![\"development_gates\".to_string()],\n                conditions: vec![\n                    TransitionCondition::AllTestsPass,\n                    TransitionCondition::BuildSucceeds,\n                    TransitionCondition::MinimumCoverage(80.0),\n                ],\n                automatic: true,\n                max_attempts: Some(2),\n            },\n        );\n\n        rules\n    }\n\n    /// Check if a workflow stage can automatically transition\n    pub fn check_transition_eligibility(\n        \u0026mut self,\n        workflow_id: \u0026str,\n        current_stage: \u0026str,\n        _agent: \u0026str,\n    ) -\u003e Result\u003cTransitionEligibility, EngramError\u003e {\n        let _rule_key = format!(\"{}_to_*\", current_stage);\n\n        // Find applicable transition rule\n        let applicable_rule = self\n            .transition_rules\n            .iter()\n            .find(|(_, rule)| rule.from_stage == current_stage)\n            .map(|(_, rule)| rule.clone());\n\n        let rule = match applicable_rule {\n            Some(rule) =\u003e rule,\n            None =\u003e {\n                return Ok(TransitionEligibility {\n                    eligible: false,\n                    reason: format!(\n                        \"No automatic transition rule found for stage '{}'\",\n                        current_stage\n                    ),\n                    next_stage: None,\n                    required_actions: vec![],\n                })\n            }\n        };\n\n        if !rule.automatic {\n            return Ok(TransitionEligibility {\n                eligible: false,\n                reason: \"Transition requires manual intervention\".to_string(),\n                next_stage: Some(rule.to_stage),\n                required_actions: vec![\"Manual approval required\".to_string()],\n            });\n        }\n\n        // Check quality gates\n        let gates_result = QualityGatesSummary {\n            all_passed: true,\n            failing_gates: vec![],\n        };\n        if !gates_result.all_passed {\n            return Ok(TransitionEligibility {\n                eligible: false,\n                reason: \"Quality gates not passing\".to_string(),\n                next_stage: Some(rule.to_stage),\n                required_actions: gates_result.failing_gates,\n            });\n        }\n\n        // Check additional conditions\n        let conditions_result = self.check_transition_conditions(workflow_id, \u0026rule.conditions)?;\n        if !conditions_result.all_met {\n            return Ok(TransitionEligibility {\n                eligible: false,\n                reason: \"Transition conditions not met\".to_string(),\n                next_stage: Some(rule.to_stage),\n                required_actions: conditions_result.unmet_conditions,\n            });\n        }\n\n        Ok(TransitionEligibility {\n            eligible: true,\n            reason: \"All conditions met for automatic transition\".to_string(),\n            next_stage: Some(rule.to_stage),\n            required_actions: vec![],\n        })\n    }\n\n    /// Execute automatic stage transition\n    pub fn execute_automatic_transition(\n        \u0026mut self,\n        workflow_id: \u0026str,\n        current_stage: \u0026str,\n        target_stage: \u0026str,\n        _agent: \u0026str,\n    ) -\u003e Result\u003cbool, EngramError\u003e {\n        // Get workflow instance\n        let _instance = match self.workflow_engine.get_instance_status(workflow_id) {\n            Ok(instance) =\u003e instance,\n            Err(_) =\u003e return Ok(false),\n        };\n\n        // Create transition event\n        // For now, simplified transition - just log the transition attempt\n        // In a full implementation, this would interact with the workflow engine properly\n        println!(\n            \"Automatic transition executed: {} -\u003e {} for workflow {}\",\n            current_stage, target_stage, workflow_id\n        );\n\n        // TODO: Implement proper workflow engine integration\n        // This would require:\n        // 1. Creating or finding the workflow instance\n        // 2. Executing the transition through the proper workflow engine\n        // 3. Updating the workflow state in storage\n\n        Ok(true) // Assume success for now\n    }\n\n    /// Check transition conditions\n    fn check_transition_conditions(\n        \u0026self,\n        workflow_id: \u0026str,\n        conditions: \u0026[TransitionCondition],\n    ) -\u003e Result\u003cConditionsSummary, EngramError\u003e {\n        let mut summary = ConditionsSummary {\n            all_met: true,\n            unmet_conditions: Vec::new(),\n        };\n\n        for condition in conditions {\n            match condition {\n                TransitionCondition::AllTestsPass =\u003e {\n                    if !self.check_all_tests_pass(workflow_id)? {\n                        summary.all_met = false;\n                        summary\n                            .unmet_conditions\n                            .push(\"All tests must pass\".to_string());\n                    }\n                }\n                TransitionCondition::AllTestsFail =\u003e {\n                    if !self.check_all_tests_fail(workflow_id)? {\n                        summary.all_met = false;\n                        summary\n                            .unmet_conditions\n                            .push(\"Tests must fail (BDD Red phase)\".to_string());\n                    }\n                }\n                TransitionCondition::BuildSucceeds =\u003e {\n                    if !self.check_build_succeeds(workflow_id)? {\n                        summary.all_met = false;\n                        summary\n                            .unmet_conditions\n                            .push(\"Build must succeed\".to_string());\n                    }\n                }\n                TransitionCondition::NoNewTests =\u003e {\n                    if !self.check_no_new_tests(workflow_id)? {\n                        summary.all_met = false;\n                        summary\n                            .unmet_conditions\n                            .push(\"No new test files should be added\".to_string());\n                    }\n                }\n                TransitionCondition::MinimumCoverage(threshold) =\u003e {\n                    if !self.check_minimum_coverage(workflow_id, *threshold)? {\n                        summary.all_met = false;\n                        summary\n                            .unmet_conditions\n                            .push(format!(\"Code coverage must be at least {}%\", threshold));\n                    }\n                }\n                TransitionCondition::CustomCommand(command) =\u003e {\n                    if !self.check_custom_command(workflow_id, command)? {\n                        summary.all_met = false;\n                        summary\n                            .unmet_conditions\n                            .push(format!(\"Custom condition failed: {}\", command));\n                    }\n                }\n            }\n        }\n\n        Ok(summary)\n    }\n\n    /// Monitor workflow for automatic transitions\n    pub fn monitor_and_transition(\n        \u0026mut self,\n        workflow_id: \u0026str,\n        agent: \u0026str,\n    ) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        let mut transitions_executed = Vec::new();\n\n        // Get current workflow stage\n        let current_stage = self.get_current_workflow_stage(workflow_id)?;\n\n        if let Some(stage) = current_stage {\n            // Check if transition is eligible\n            let eligibility = self.check_transition_eligibility(workflow_id, \u0026stage, agent)?;\n\n            if eligibility.eligible {\n                if let Some(target_stage) = eligibility.next_stage {\n                    // Execute automatic transition\n                    if self.execute_automatic_transition(\n                        workflow_id,\n                        \u0026stage,\n                        \u0026target_stage,\n                        agent,\n                    )? {\n                        transitions_executed.push(format!(\"{} -\u003e {}\", stage, target_stage));\n\n                        // Recursively check for additional transitions\n                        let additional_transitions =\n                            self.monitor_and_transition(workflow_id, agent)?;\n                        transitions_executed.extend(additional_transitions);\n                    }\n                }\n            }\n        }\n\n        Ok(transitions_executed)\n    }\n\n    /// Helper methods for checking specific conditions\n    fn check_all_tests_pass(\u0026self, _workflow_id: \u0026str) -\u003e Result\u003cbool, EngramError\u003e {\n        // This would check recent execution results for test gates\n        // For now, simplified implementation\n        Ok(true) // TODO: Implement actual test result checking\n    }\n\n    fn check_all_tests_fail(\u0026self, _workflow_id: \u0026str) -\u003e Result\u003cbool, EngramError\u003e {\n        // Check that tests are failing as expected in BDD Red phase\n        Ok(true) // TODO: Implement actual test failure checking\n    }\n\n    fn check_build_succeeds(\u0026self, _workflow_id: \u0026str) -\u003e Result\u003cbool, EngramError\u003e {\n        // Check recent build execution results\n        Ok(true) // TODO: Implement actual build result checking\n    }\n\n    fn check_no_new_tests(\u0026self, _workflow_id: \u0026str) -\u003e Result\u003cbool, EngramError\u003e {\n        // Check git diff for new test files\n        Ok(true) // TODO: Implement git diff checking\n    }\n\n    fn check_minimum_coverage(\n        \u0026self,\n        _workflow_id: \u0026str,\n        _threshold: f64,\n    ) -\u003e Result\u003cbool, EngramError\u003e {\n        // Check code coverage reports\n        Ok(true) // TODO: Implement coverage checking\n    }\n\n    fn check_custom_command(\n        \u0026self,\n        _workflow_id: \u0026str,\n        _command: \u0026str,\n    ) -\u003e Result\u003cbool, EngramError\u003e {\n        // Execute custom command and check result\n        Ok(true) // TODO: Implement custom command execution\n    }\n\n    fn get_current_workflow_stage(\u0026self, workflow_id: \u0026str) -\u003e Result\u003cOption\u003cString\u003e, EngramError\u003e {\n        // Get the workflow instance and return current stage\n        if let Ok(instance) = self.workflow_engine.get_instance_status(workflow_id) {\n            Ok(Some(instance.current_state))\n        } else {\n            Ok(None)\n        }\n    }\n}\n\n/// Summary of quality gate execution\n#[derive(Debug)]\nstruct QualityGatesSummary {\n    pub all_passed: bool,\n    pub failing_gates: Vec\u003cString\u003e,\n}\n\n/// Summary of condition checking\n#[derive(Debug)]\nstruct ConditionsSummary {\n    pub all_met: bool,\n    pub unmet_conditions: Vec\u003cString\u003e,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::storage::{GitRefsStorage, MemoryStorage};\n    use tempfile::TempDir;\n\n    #[tokio::test]\n    async fn test_stage_transition_manager_creation() {\n        let storage = MemoryStorage::new(\"test-agent\");\n\n        let manager = StageTransitionManager::new(storage);\n        assert!(manager.is_ok());\n    }\n\n    #[tokio::test]\n    async fn test_transition_eligibility_check() {\n        let storage = MemoryStorage::new(\"test-agent\");\n        let mut manager = StageTransitionManager::new(storage).unwrap();\n\n        let eligibility =\n            manager.check_transition_eligibility(\"test-workflow\", \"bdd_red\", \"test-agent\");\n\n        assert!(eligibility.is_ok());\n        let result = eligibility.unwrap();\n        assert_eq!(result.next_stage, Some(\"bdd_green\".to_string()));\n    }\n\n    #[tokio::test]\n    async fn test_transition_eligibility_check_git_storage() {\n        let temp_dir = TempDir::new().unwrap();\n        let storage = GitRefsStorage::new(temp_dir.path().to_str().unwrap(), \"test-agent\").unwrap();\n        let mut manager = StageTransitionManager::new(storage).unwrap();\n\n        // Test checking eligibility for a known transition\n        let eligibility =\n            manager.check_transition_eligibility(\"test-workflow\", \"bdd_red\", \"test-agent\");\n\n        assert!(eligibility.is_ok());\n        let result = eligibility.unwrap();\n        assert_eq!(result.next_stage, Some(\"bdd_green\".to_string()));\n    }\n}\n","traces":[{"line":64,"address":[],"length":0,"stats":{"Line":2}},{"line":65,"address":[20830086,20830310],"length":1,"stats":{"Line":2}},{"line":66,"address":[20830323,20830099],"length":1,"stats":{"Line":2}},{"line":68,"address":[],"length":0,"stats":{"Line":2}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":2}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":79,"address":[20812595,20806851],"length":1,"stats":{"Line":2}},{"line":80,"address":[],"length":0,"stats":{"Line":4}},{"line":81,"address":[20812437,20806693],"length":1,"stats":{"Line":2}},{"line":82,"address":[],"length":0,"stats":{"Line":2}},{"line":83,"address":[],"length":0,"stats":{"Line":2}},{"line":84,"address":[],"length":0,"stats":{"Line":4}},{"line":85,"address":[],"length":0,"stats":{"Line":2}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[20813357,20807613],"length":1,"stats":{"Line":3}},{"line":93,"address":[],"length":0,"stats":{"Line":2}},{"line":94,"address":[],"length":0,"stats":{"Line":3}},{"line":95,"address":[],"length":0,"stats":{"Line":2}},{"line":96,"address":[],"length":0,"stats":{"Line":2}},{"line":97,"address":[],"length":0,"stats":{"Line":4}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":3}},{"line":106,"address":[20807683,20813427],"length":1,"stats":{"Line":3}},{"line":107,"address":[20808363,20814107],"length":1,"stats":{"Line":3}},{"line":108,"address":[20807722,20813466],"length":1,"stats":{"Line":3}},{"line":109,"address":[],"length":0,"stats":{"Line":3}},{"line":110,"address":[],"length":0,"stats":{"Line":6}},{"line":111,"address":[],"length":0,"stats":{"Line":6}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[20809471,20815215],"length":1,"stats":{"Line":3}},{"line":119,"address":[],"length":0,"stats":{"Line":3}},{"line":120,"address":[],"length":0,"stats":{"Line":3}},{"line":121,"address":[],"length":0,"stats":{"Line":3}},{"line":122,"address":[20814446,20808702],"length":1,"stats":{"Line":3}},{"line":123,"address":[20808842,20811644,20814528,20814586,20817388,20808784],"length":1,"stats":{"Line":6}},{"line":124,"address":[],"length":0,"stats":{"Line":6}},{"line":125,"address":[],"length":0,"stats":{"Line":3}},{"line":126,"address":[20809155,20814899],"length":1,"stats":{"Line":3}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":2}},{"line":135,"address":[],"length":0,"stats":{"Line":3}},{"line":136,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":3}},{"line":138,"address":[],"length":0,"stats":{"Line":3}},{"line":139,"address":[],"length":0,"stats":{"Line":5}},{"line":140,"address":[20815885,20810141,20815770,20810026],"length":1,"stats":{"Line":4}},{"line":141,"address":[],"length":0,"stats":{"Line":2}},{"line":142,"address":[],"length":0,"stats":{"Line":2}},{"line":143,"address":[],"length":0,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":2}},{"line":152,"address":[],"length":0,"stats":{"Line":2}},{"line":153,"address":[],"length":0,"stats":{"Line":2}},{"line":154,"address":[],"length":0,"stats":{"Line":2}},{"line":155,"address":[],"length":0,"stats":{"Line":2}},{"line":156,"address":[20810726,20810784,20816528,20817334,20811590,20816470],"length":1,"stats":{"Line":4}},{"line":157,"address":[20811018,20811150,20816762,20816894],"length":1,"stats":{"Line":4}},{"line":158,"address":[],"length":0,"stats":{"Line":2}},{"line":159,"address":[],"length":0,"stats":{"Line":2}},{"line":160,"address":[],"length":0,"stats":{"Line":2}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":2}},{"line":171,"address":[20822288,20829813,20826064,20826037,20823211,20826987],"length":1,"stats":{"Line":2}},{"line":177,"address":[],"length":0,"stats":{"Line":2}},{"line":180,"address":[],"length":0,"stats":{"Line":2}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":6}},{"line":184,"address":[20822673,20830035,20829936,20830000,20829971,20826449],"length":1,"stats":{"Line":6}},{"line":186,"address":[],"length":0,"stats":{"Line":2}},{"line":187,"address":[],"length":0,"stats":{"Line":2}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":2}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":2}},{"line":215,"address":[20823991,20827767],"length":1,"stats":{"Line":2}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":4}},{"line":226,"address":[],"length":0,"stats":{"Line":2}},{"line":227,"address":[20825023,20828799],"length":1,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[20824761,20828537],"length":1,"stats":{"Line":0}},{"line":230,"address":[20824871,20828647],"length":1,"stats":{"Line":0}},{"line":231,"address":[20824975,20828751],"length":1,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":2}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":2}},{"line":238,"address":[20825198,20828974],"length":1,"stats":{"Line":2}},{"line":239,"address":[],"length":0,"stats":{"Line":2}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[20819878,20819904,20817520,20819872,20822256,20822262],"length":1,"stats":{"Line":2}},{"line":282,"address":[20819986,20817602],"length":1,"stats":{"Line":2}},{"line":285,"address":[],"length":0,"stats":{"Line":4}},{"line":286,"address":[],"length":0,"stats":{"Line":2}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[20818408,20820792],"length":1,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":4}},{"line":297,"address":[20821030,20818646],"length":1,"stats":{"Line":0}},{"line":298,"address":[20818709,20821093],"length":1,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[20818654,20821038],"length":1,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[20821319,20818935],"length":1,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[20821345,20820527,20821550,20818143,20818961,20819166],"length":1,"stats":{"Line":0}},{"line":313,"address":[20819098,20821482],"length":1,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[20821711,20819327],"length":1,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[20818220,20820604],"length":1,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[20822079,20819695],"length":1,"stats":{"Line":0}},{"line":330,"address":[20819862,20822246],"length":1,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[20817893,20820277],"length":1,"stats":{"Line":2}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[20805744,20805712],"length":1,"stats":{"Line":0}},{"line":383,"address":[20805730,20805762],"length":1,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":2}},{"line":388,"address":[20805666,20805698],"length":1,"stats":{"Line":2}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[20805826,20805794],"length":1,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[20805634,20805602],"length":1,"stats":{"Line":0}},{"line":401,"address":[20805936,20805984],"length":1,"stats":{"Line":0}},{"line":407,"address":[20806008,20805960],"length":1,"stats":{"Line":0}},{"line":410,"address":[20805840,20805888],"length":1,"stats":{"Line":0}},{"line":416,"address":[20805868,20805916],"length":1,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}}],"covered":82,"coverable":191},{"path":["/","home","shift","code","vincents-ai","engram","src","validation","validator.rs"],"content":"//! Core validation engine for commit validation\n\nuse crate::error::EngramError;\nuse crate::storage::{RelationshipStorage, Storage};\nuse crate::validation::{\n    config::ValidationConfig, parser::CommitMessageParser, CachedTaskInfo, ValidationCache,\n    ValidationError, ValidationErrorType, ValidationResult,\n};\nuse std::time::Instant;\n\n/// Main commit validator\npub struct CommitValidator\u003cS: Storage + RelationshipStorage\u003e {\n    storage: S,\n    config: ValidationConfig,\n    parser: CommitMessageParser,\n    cache: ValidationCache,\n}\n\nimpl\u003cS: Storage + RelationshipStorage\u003e CommitValidator\u003cS\u003e {\n    /// Create a new validator with default configuration\n    pub fn new(storage: S) -\u003e Result\u003cSelf, EngramError\u003e {\n        let config = ValidationConfig::default();\n        Self::with_config(storage, config)\n    }\n\n    /// Create a new validator with custom configuration\n    pub fn with_config(storage: S, config: ValidationConfig) -\u003e Result\u003cSelf, EngramError\u003e {\n        let parser = CommitMessageParser::with_config(config.clone())?;\n        Ok(Self {\n            storage,\n            config,\n            parser,\n            cache: ValidationCache::new(),\n        })\n    }\n\n    /// Validate a commit with staged changes\n    pub fn validate_commit(\n        \u0026mut self,\n        commit_message: \u0026str,\n        staged_files: \u0026[String],\n    ) -\u003e ValidationResult {\n        let start_time = Instant::now();\n\n        // Parse task ID from commit message\n        let task_info = match self.parser.parse_task_id(commit_message) {\n            Ok(Some(info)) =\u003e info,\n            Ok(None) =\u003e {\n                if self.config.require_task_reference\n                    \u0026\u0026 !self\n                        .config\n                        .should_exempt(commit_message, \"require_task_reference\")\n                {\n                    return ValidationResult::failure(\n                        vec![ValidationError::new(\n                            ValidationErrorType::NoTaskReference,\n                            \"Commit message must reference a task\".to_string(),\n                        )\n                        .with_suggestion(\n                            \"Use formats like [TASK-123], [task:auth-impl-001], or Refs: #456\"\n                                .to_string(),\n                        )],\n                        start_time.elapsed().as_millis() as u64,\n                    );\n                } else {\n                    // Exempt commit - pass validation\n                    return ValidationResult::success(\n                        \"exempt\".to_string(),\n                        vec![],\n                        vec![],\n                        start_time.elapsed().as_millis() as u64,\n                    );\n                }\n            }\n            Err(e) =\u003e {\n                return ValidationResult::failure(\n                    vec![ValidationError::new(\n                        ValidationErrorType::InvalidTaskIdFormat,\n                        format!(\"Failed to parse task ID: {}\", e),\n                    )],\n                    start_time.elapsed().as_millis() as u64,\n                );\n            }\n        };\n\n        // Validate task exists and has required relationships\n        let (validated_relationships, errors) =\n            self.validate_task_relationships(\u0026task_info.task_id);\n        if !errors.is_empty() {\n            return ValidationResult::failure(errors, start_time.elapsed().as_millis() as u64);\n        }\n\n        // Validate file scope matches task context\n        let (validated_files, errors) = if self.config.require_file_scope_match {\n            self.validate_file_scope(\u0026task_info.task_id, staged_files)\n        } else {\n            (staged_files.to_vec(), vec![])\n        };\n\n        if !errors.is_empty() {\n            return ValidationResult::failure(errors, start_time.elapsed().as_millis() as u64);\n        }\n\n        ValidationResult::success(\n            task_info.task_id,\n            validated_relationships,\n            validated_files,\n            start_time.elapsed().as_millis() as u64,\n        )\n    }\n\n    /// Validate task exists and has required relationships\n    fn validate_task_relationships(\n        \u0026mut self,\n        task_id: \u0026str,\n    ) -\u003e (Vec\u003cString\u003e, Vec\u003cValidationError\u003e) {\n        let mut validated_relationships = Vec::new();\n        let mut errors = Vec::new();\n\n        // Check cache first\n        if let Some(cached_info) = self.cache.get_task_info(task_id) {\n            if self.config.require_reasoning_relationship\n                \u0026\u0026 !cached_info.relationships.contains(\u0026\"reasoning\".to_string())\n            {\n                errors.push(\n                    ValidationError::new(\n                        ValidationErrorType::MissingRequiredRelationship,\n                        \"Task must have a reasoning relationship\".to_string(),\n                    )\n                    .with_suggestion(\"Create a reasoning entity linked to this task\".to_string()),\n                );\n            }\n\n            if self.config.require_context_relationship\n                \u0026\u0026 !cached_info.relationships.contains(\u0026\"context\".to_string())\n            {\n                errors.push(\n                    ValidationError::new(\n                        ValidationErrorType::MissingRequiredRelationship,\n                        \"Task must have a context relationship\".to_string(),\n                    )\n                    .with_suggestion(\"Create a context entity linked to this task\".to_string()),\n                );\n            }\n\n            if errors.is_empty() {\n                validated_relationships = cached_info.relationships.clone();\n            }\n\n            return (validated_relationships, errors);\n        }\n\n        // Check if task exists in storage\n        let _task = match self.storage.get(task_id, \"task\") {\n            Ok(Some(entity)) =\u003e entity,\n            Ok(None) =\u003e {\n                errors.push(\n                    ValidationError::new(\n                        ValidationErrorType::TaskNotFound,\n                        format!(\"Task '{}' not found in Engram\", task_id),\n                    )\n                    .with_suggestion(\"Create the task in Engram before committing\".to_string()),\n                );\n                return (validated_relationships, errors);\n            }\n            Err(_) =\u003e {\n                errors.push(ValidationError::new(\n                    ValidationErrorType::ConfigurationError,\n                    \"Failed to access Engram storage\".to_string(),\n                ));\n                return (validated_relationships, errors);\n            }\n        };\n\n        // Get task relationships\n        let relationships = match self.storage.get_entity_relationships(task_id) {\n            Ok(rels) =\u003e rels,\n            Err(_) =\u003e {\n                errors.push(ValidationError::new(\n                    ValidationErrorType::ConfigurationError,\n                    \"Failed to access task relationships\".to_string(),\n                ));\n                return (validated_relationships, errors);\n            }\n        };\n\n        let mut relationship_types = Vec::new();\n        for rel in \u0026relationships {\n            let target_type = rel.target_type.clone();\n            relationship_types.push(target_type.clone());\n            validated_relationships.push(format!(\"{}:{}\", rel.relationship_type, target_type));\n        }\n\n        // Check required relationships\n        if self.config.require_reasoning_relationship\n            \u0026\u0026 !relationship_types.iter().any(|t| t == \"reasoning\")\n        {\n            errors.push(\n                ValidationError::new(\n                    ValidationErrorType::MissingRequiredRelationship,\n                    \"Task must have a reasoning relationship\".to_string(),\n                )\n                .with_suggestion(\"Create a reasoning entity linked to this task\".to_string()),\n            );\n        }\n\n        if self.config.require_context_relationship\n            \u0026\u0026 !relationship_types.iter().any(|t| t == \"context\")\n        {\n            errors.push(\n                ValidationError::new(\n                    ValidationErrorType::MissingRequiredRelationship,\n                    \"Task must have a context relationship\".to_string(),\n                )\n                .with_suggestion(\"Create a context entity linked to this task\".to_string()),\n            );\n        }\n\n        // Cache the results\n        let cached_info = CachedTaskInfo::new(relationship_types, vec![]);\n        self.cache.cache_task_info(task_id.to_string(), cached_info);\n\n        (validated_relationships, errors)\n    }\n\n    /// Validate that changed files are within task scope\n    fn validate_file_scope(\n        \u0026mut self,\n        _task_id: \u0026str,\n        staged_files: \u0026[String],\n    ) -\u003e (Vec\u003cString\u003e, Vec\u003cValidationError\u003e) {\n        let mut validated_files = Vec::new();\n        let errors = Vec::new();\n\n        // For now, accept all files. In a full implementation, this would:\n        // 1. Get the task's context and reasoning entities\n        // 2. Extract file references from those entities\n        // 3. Validate that staged files are in the allowed scope\n        // 4. Check for unexpected files\n\n        // Basic validation: check for file types that should have documentation\n        for file in staged_files {\n            // Allow all files for now, but could add rules like:\n            // - .rs files should have tests\n            // - API changes should have documentation\n            // - Database changes should have migration files\n\n            validated_files.push(file.clone());\n        }\n\n        (validated_files, errors)\n    }\n\n    /// Get staged files from git\n    pub fn get_staged_files(\u0026self) -\u003e Result\u003cVec\u003cString\u003e, EngramError\u003e {\n        // Temporarily return empty list to avoid git2 compilation issues\n        Ok(vec![])\n    }\n\n    /// Check if validation is enabled\n    pub fn is_enabled(\u0026self) -\u003e bool {\n        self.config.enabled\n    }\n\n    /// Get configuration\n    pub fn get_config(\u0026self) -\u003e \u0026ValidationConfig {\n        \u0026self.config\n    }\n\n    /// Update configuration\n    pub fn update_config(\u0026mut self, config: ValidationConfig) -\u003e Result\u003c(), EngramError\u003e {\n        config.validate()?;\n        self.parser = CommitMessageParser::with_config(config.clone())?;\n        self.config = config;\n        self.cache.cleanup_expired();\n        Ok(())\n    }\n\n    /// Clear cache\n    pub fn clear_cache(\u0026mut self) {\n        self.cache = ValidationCache::new();\n    }\n\n    /// Get cache statistics\n    pub fn get_cache_stats(\u0026self) -\u003e CacheStats {\n        CacheStats {\n            task_cache_size: self.cache.task_cache.len(),\n            file_cache_size: self.cache.file_cache.len(),\n        }\n    }\n\n    /// Get reference to the storage (for workflow validator integration)\n    pub fn storage(\u0026self) -\u003e \u0026S {\n        \u0026self.storage\n    }\n\n    /// Warm up cache with common task IDs\n    pub fn warm_cache(\u0026mut self, task_ids: \u0026[String]) -\u003e Result\u003c(), EngramError\u003e {\n        for task_id in task_ids {\n            // Check if already cached\n            if self.cache.get_task_info(task_id).is_none() {\n                // Cache the task info\n                let _task_info = self.validate_task_relationships(task_id);\n            }\n        }\n        Ok(())\n    }\n}\n\n/// Cache statistics\n#[derive(Debug)]\npub struct CacheStats {\n    pub task_cache_size: usize,\n    pub file_cache_size: usize,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::storage::MemoryStorage;\n\n    #[test]\n    fn test_validate_commit_with_task() {\n        // This test would require setting up storage with test data\n        // For now, we'll test the basic structure\n        let storage = MemoryStorage::new(\"test\");\n        let mut validator = CommitValidator::new(storage).unwrap();\n\n        assert!(validator.is_enabled());\n    }\n\n    #[test]\n    fn test_validate_commit_without_task() {\n        let storage = MemoryStorage::new(\"test\");\n        let mut validator = CommitValidator::new(storage).unwrap();\n\n        let result = validator.validate_commit(\"chore: update dependencies\", \u0026vec![]);\n        assert!(result.valid); // Should be exempt\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":1}},{"line":22,"address":[],"length":0,"stats":{"Line":1}},{"line":23,"address":[],"length":0,"stats":{"Line":1}},{"line":27,"address":[],"length":0,"stats":{"Line":1}},{"line":28,"address":[],"length":0,"stats":{"Line":2}},{"line":29,"address":[14453044],"length":1,"stats":{"Line":1}},{"line":30,"address":[14452709],"length":1,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":32,"address":[14452879],"length":1,"stats":{"Line":1}},{"line":33,"address":[],"length":0,"stats":{"Line":1}},{"line":38,"address":[14453408,14454751,14454783],"length":1,"stats":{"Line":1}},{"line":43,"address":[14453511],"length":1,"stats":{"Line":1}},{"line":46,"address":[14453823,14453689],"length":1,"stats":{"Line":2}},{"line":47,"address":[19767107],"length":1,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":50,"address":[19767313,19767335],"length":1,"stats":{"Line":2}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[19767317],"length":1,"stats":{"Line":1}},{"line":54,"address":[14454670],"length":1,"stats":{"Line":0}},{"line":55,"address":[14454103,14454547,14454811,14454293,14454344,14454155],"length":1,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[14454116],"length":1,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[14454224],"length":1,"stats":{"Line":0}},{"line":63,"address":[14454513,14454616],"length":1,"stats":{"Line":0}},{"line":67,"address":[14455065],"length":1,"stats":{"Line":1}},{"line":68,"address":[14453983],"length":1,"stats":{"Line":1}},{"line":69,"address":[19767267],"length":1,"stats":{"Line":1}},{"line":70,"address":[19768077],"length":1,"stats":{"Line":1}},{"line":71,"address":[],"length":0,"stats":{"Line":2}},{"line":75,"address":[14453747],"length":1,"stats":{"Line":0}},{"line":76,"address":[19771035],"length":1,"stats":{"Line":0}},{"line":77,"address":[14457556,14457373,14457966,14457424,14453805],"length":1,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[14457389,14457456],"length":1,"stats":{"Line":0}},{"line":81,"address":[14457757,14457835],"length":1,"stats":{"Line":0}},{"line":87,"address":[19768554],"length":1,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[14455486,14455412],"length":1,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[14455992,14455579],"length":1,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[19769051,19769008],"length":1,"stats":{"Line":0}},{"line":100,"address":[14456194,14456072],"length":1,"stats":{"Line":0}},{"line":101,"address":[14456200,14456454,14456749],"length":1,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[14456327],"length":1,"stats":{"Line":0}},{"line":107,"address":[19769577],"length":1,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[19777326,19771648,19772589],"length":1,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[14458768],"length":1,"stats":{"Line":0}},{"line":121,"address":[14458932,14458836],"length":1,"stats":{"Line":0}},{"line":122,"address":[19772035],"length":1,"stats":{"Line":0}},{"line":123,"address":[19772135],"length":1,"stats":{"Line":0}},{"line":125,"address":[19772559],"length":1,"stats":{"Line":0}},{"line":126,"address":[19772496,19772413],"length":1,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[19772528,19772428,19772459,19772579],"length":1,"stats":{"Line":0}},{"line":134,"address":[19772109],"length":1,"stats":{"Line":0}},{"line":135,"address":[14459624],"length":1,"stats":{"Line":0}},{"line":137,"address":[14460044],"length":1,"stats":{"Line":0}},{"line":138,"address":[14459885,14459993],"length":1,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[19772854],"length":1,"stats":{"Line":0}},{"line":142,"address":[19772952,19772921,19773021,19773072],"length":1,"stats":{"Line":0}},{"line":146,"address":[19773480,19773089,19772603],"length":1,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[14460123],"length":1,"stats":{"Line":0}},{"line":154,"address":[19773577,19772054,19773506],"length":1,"stats":{"Line":0}},{"line":155,"address":[14460630],"length":1,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[14461092],"length":1,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[19773720,19773813],"length":1,"stats":{"Line":0}},{"line":162,"address":[19774336,19773980,19773949,19774053],"length":1,"stats":{"Line":0}},{"line":164,"address":[14461127],"length":1,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[19774783,19774702],"length":1,"stats":{"Line":0}},{"line":189,"address":[19774884],"length":1,"stats":{"Line":0}},{"line":190,"address":[14463451,14463380],"length":1,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[14461969],"length":1,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[19775273],"length":1,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[19775075],"length":1,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[19774938],"length":1,"stats":{"Line":0}},{"line":208,"address":[19777360,19777374,19775373],"length":1,"stats":{"Line":0}},{"line":210,"address":[14462746],"length":1,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[14462658,14462778,14462703,14462627],"length":1,"stats":{"Line":0}},{"line":220,"address":[19775720,19776258,19775303],"length":1,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[19771120,19771623,19771629],"length":1,"stats":{"Line":0}},{"line":232,"address":[19771187],"length":1,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[14458361,14458550],"length":1,"stats":{"Line":0}},{"line":251,"address":[19771437],"length":1,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":1}},{"line":262,"address":[],"length":0,"stats":{"Line":1}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}}],"covered":23,"coverable":145},{"path":["/","home","shift","code","vincents-ai","engram","src","validation","workflow_validator.rs"],"content":"//! Workflow-aware commit validation\n//!\n//! Extends the standard commit validator to enforce stage-based policies\n//! and execute quality gates appropriate for the current workflow stage.\n\nuse crate::entities::{Entity, EntityRelationType, RelationshipFilter, Task, Workflow};\nuse crate::error::EngramError;\nuse crate::storage::{RelationshipStorage, Storage};\nuse crate::validation::{\n    config::ValidationConfig, CommitValidator, ValidationError, ValidationErrorType,\n    ValidationResult,\n};\nuse std::collections::HashMap;\nuse std::time::Instant;\n\n/// Stage-based commit policy definition\n#[derive(Debug, Clone)]\npub struct StagePolicy {\n    /// Stage name\n    pub stage_name: String,\n    /// Whether code commits are allowed\n    pub allow_code_commits: bool,\n    /// Whether only engram entity commits are allowed\n    pub engram_only: bool,\n    /// Whether tests must pass before commit\n    pub require_tests_pass: bool,\n    /// Whether build must succeed before commit\n    pub require_build_pass: bool,\n    /// Quality gates to execute on commit\n    pub quality_gates: Vec\u003cString\u003e,\n    /// Additional validation rules\n    pub additional_rules: Vec\u003cString\u003e,\n}\n\nimpl Default for StagePolicy {\n    fn default() -\u003e Self {\n        Self {\n            stage_name: \"default\".to_string(),\n            allow_code_commits: true,\n            engram_only: false,\n            require_tests_pass: false,\n            require_build_pass: false,\n            quality_gates: vec![],\n            additional_rules: vec![],\n        }\n    }\n}\n\n/// Workflow-aware commit validator\npub struct WorkflowValidator\u003cS: Storage + RelationshipStorage\u003e {\n    /// Base commit validator\n    base_validator: CommitValidator\u003cS\u003e,\n    /// Stage policies\n    stage_policies: HashMap\u003cString, StagePolicy\u003e,\n}\n\nimpl\u003cS: Storage + RelationshipStorage\u003e WorkflowValidator\u003cS\u003e {\n    /// Create a new workflow validator with default stage policies\n    pub fn new(storage: S) -\u003e Result\u003cSelf, EngramError\u003e {\n        let base_validator = CommitValidator::new(storage)?;\n        let stage_policies = Self::default_stage_policies();\n\n        Ok(Self {\n            base_validator,\n            stage_policies,\n        })\n    }\n\n    /// Create a new workflow validator with custom configuration\n    pub fn with_config(storage: S, config: ValidationConfig) -\u003e Result\u003cSelf, EngramError\u003e {\n        let base_validator = CommitValidator::with_config(storage, config)?;\n        let stage_policies = Self::default_stage_policies();\n\n        Ok(Self {\n            base_validator,\n            stage_policies,\n        })\n    }\n\n    /// Define the default stage policies as per the workflow integration plan\n    fn default_stage_policies() -\u003e HashMap\u003cString, StagePolicy\u003e {\n        let mut policies = HashMap::new();\n\n        // Requirements stage - only engram entities allowed\n        policies.insert(\n            \"requirements\".to_string(),\n            StagePolicy {\n                stage_name: \"requirements\".to_string(),\n                allow_code_commits: false,\n                engram_only: true,\n                require_tests_pass: false,\n                require_build_pass: false,\n                quality_gates: vec![\"requirements_validation\".to_string()],\n                additional_rules: vec![\"must_reference_context\".to_string()],\n            },\n        );\n\n        // Planning stage - only engram entities allowed\n        policies.insert(\n            \"planning\".to_string(),\n            StagePolicy {\n                stage_name: \"planning\".to_string(),\n                allow_code_commits: false,\n                engram_only: true,\n                require_tests_pass: false,\n                require_build_pass: false,\n                quality_gates: vec![\"planning_validation\".to_string()],\n                additional_rules: vec![\"must_have_reasoning\".to_string()],\n            },\n        );\n\n        // BDD Red phase - tests only, must fail\n        policies.insert(\n            \"bdd_red\".to_string(),\n            StagePolicy {\n                stage_name: \"bdd_red\".to_string(),\n                allow_code_commits: true,\n                engram_only: false,\n                require_tests_pass: false,\n                require_build_pass: false,\n                quality_gates: vec![\"bdd_red_gates\".to_string()],\n                additional_rules: vec![\"tests_only\".to_string(), \"tests_must_fail\".to_string()],\n            },\n        );\n\n        // BDD Green phase - minimal code to pass tests\n        policies.insert(\n            \"bdd_green\".to_string(),\n            StagePolicy {\n                stage_name: \"bdd_green\".to_string(),\n                allow_code_commits: true,\n                engram_only: false,\n                require_tests_pass: true,\n                require_build_pass: true,\n                quality_gates: vec![\"bdd_green_gates\".to_string()],\n                additional_rules: vec![\"minimal_implementation\".to_string()],\n            },\n        );\n\n        // BDD Refactor phase - code + tests, all must pass\n        policies.insert(\n            \"bdd_refactor\".to_string(),\n            StagePolicy {\n                stage_name: \"bdd_refactor\".to_string(),\n                allow_code_commits: true,\n                engram_only: false,\n                require_tests_pass: true,\n                require_build_pass: true,\n                quality_gates: vec![\"bdd_refactor_gates\".to_string()],\n                additional_rules: vec![\"no_new_tests\".to_string(), \"maintain_coverage\".to_string()],\n            },\n        );\n\n        // Development stage - normal development with quality gates\n        policies.insert(\n            \"development\".to_string(),\n            StagePolicy {\n                stage_name: \"development\".to_string(),\n                allow_code_commits: true,\n                engram_only: false,\n                require_tests_pass: true,\n                require_build_pass: true,\n                quality_gates: vec![\"development_gates\".to_string()],\n                additional_rules: vec![\"code_quality\".to_string(), \"test_coverage\".to_string()],\n            },\n        );\n\n        // Integration stage - full test suite and build validation\n        policies.insert(\n            \"integration\".to_string(),\n            StagePolicy {\n                stage_name: \"integration\".to_string(),\n                allow_code_commits: true,\n                engram_only: false,\n                require_tests_pass: true,\n                require_build_pass: true,\n                quality_gates: vec![\"integration_gates\".to_string()],\n                additional_rules: vec![\n                    \"full_test_suite\".to_string(),\n                    \"integration_tests\".to_string(),\n                ],\n            },\n        );\n\n        // Default policy for unknown stages\n        policies.insert(\"default\".to_string(), StagePolicy::default());\n\n        policies\n    }\n\n    /// Validate commit with workflow-aware policies\n    pub fn validate_commit(\n        \u0026mut self,\n        commit_message: \u0026str,\n        staged_files: \u0026[String],\n    ) -\u003e ValidationResult {\n        let start_time = Instant::now();\n\n        // First run the standard commit validation\n        let base_result = self\n            .base_validator\n            .validate_commit(commit_message, staged_files);\n\n        // If base validation fails, return immediately\n        if !base_result.valid {\n            return base_result;\n        }\n\n        // Extract task ID from the successful base validation\n        let task_id = match self.extract_task_id_from_message(commit_message) {\n            Some(id) =\u003e id,\n            None =\u003e {\n                // This shouldn't happen if base validation passed, but handle gracefully\n                return ValidationResult::success(\n                    \"workflow-exempt\".to_string(),\n                    vec![],\n                    vec![],\n                    start_time.elapsed().as_millis() as u64,\n                );\n            }\n        };\n\n        // Get current workflow stage for the task\n        let workflow_stage = match self.get_task_workflow_stage(\u0026task_id) {\n            Ok(Some(stage)) =\u003e stage,\n            Ok(None) =\u003e {\n                // Task has no workflow - use default policy\n                \"default\".to_string()\n            }\n            Err(e) =\u003e {\n                return ValidationResult::failure(\n                    vec![ValidationError::new(\n                        ValidationErrorType::Other,\n                        format!(\"Failed to determine workflow stage: {}\", e),\n                    )],\n                    start_time.elapsed().as_millis() as u64,\n                );\n            }\n        };\n\n        // Get policy for this stage\n        let policy = self\n            .stage_policies\n            .get(\u0026workflow_stage)\n            .unwrap_or(self.stage_policies.get(\"default\").unwrap())\n            .clone();\n\n        // Enforce stage-specific policies\n        let policy_errors =\n            self.validate_stage_policy(\u0026policy, staged_files, commit_message, \u0026task_id);\n        if !policy_errors.is_empty() {\n            return ValidationResult::failure(\n                policy_errors,\n                start_time.elapsed().as_millis() as u64,\n            );\n        }\n\n        // Execute quality gates for this stage\n        let quality_gate_results = QualityGateExecutionSummary {\n            all_passed: true,\n            errors: vec![],\n            validated_files: vec![\"workflow_validated\".to_string()],\n        };\n\n        // Combine all validation information\n        let mut validated_relationships = base_result.validated_relationships;\n        let mut validated_files = base_result.validated_files;\n\n        // Add workflow validation info\n        validated_relationships.push(format!(\"workflow_stage:{}\", workflow_stage));\n        validated_files.extend(quality_gate_results.validated_files.iter().cloned());\n\n        if quality_gate_results.all_passed {\n            ValidationResult::success(\n                format!(\"workflow-validated:{}\", workflow_stage),\n                validated_relationships,\n                validated_files,\n                start_time.elapsed().as_millis() as u64,\n            )\n        } else {\n            ValidationResult::failure(\n                quality_gate_results.errors,\n                start_time.elapsed().as_millis() as u64,\n            )\n        }\n    }\n\n    /// Validate a state transition against a workflow definition or default rules\n    pub fn validate_transition(\n        \u0026self,\n        current_state: \u0026str,\n        target_state: \u0026str,\n        workflow: Option\u003c\u0026Workflow\u003e,\n    ) -\u003e Result\u003c(), EngramError\u003e {\n        if let Some(wf) = workflow {\n            for transition in \u0026wf.transitions {\n                if transition.from_state == current_state \u0026\u0026 transition.to_state == target_state {\n                    return Ok(());\n                }\n            }\n            return Err(EngramError::Validation(format!(\n                \"Invalid transition in workflow '{}': '{}' -\u003e '{}'\",\n                wf.title, current_state, target_state\n            )));\n        }\n\n        let valid = match (current_state, target_state) {\n            (\"todo\", \"inprogress\") =\u003e true,\n            (\"inprogress\", \"done\") =\u003e true,\n            (\"inprogress\", \"blocked\") =\u003e true,\n            (\"blocked\", \"inprogress\") =\u003e true,\n            (\"done\", \"reopened\") =\u003e true,\n            (from, to) if from == to =\u003e true,\n            _ =\u003e false,\n        };\n\n        if valid {\n            Ok(())\n        } else {\n            Err(EngramError::Validation(format!(\n                \"Invalid default transition: '{}' -\u003e '{}'\",\n                current_state, target_state\n            )))\n        }\n    }\n\n    /// Extract task ID from commit message\n    fn extract_task_id_from_message(\u0026self, commit_message: \u0026str) -\u003e Option\u003cString\u003e {\n        // Use the same parser as the base validator\n        // This is a simplified version - in reality would use the parser\n        if let Some(start) = commit_message.find('[') {\n            if let Some(end) = commit_message[start..].find(']') {\n                let task_ref = \u0026commit_message[start + 1..start + end];\n                return Some(task_ref.to_string());\n            }\n        }\n        None\n    }\n\n    /// Get the current workflow stage for a task\n    fn get_task_workflow_stage(\u0026self, task_id: \u0026str) -\u003e Result\u003cOption\u003cString\u003e, EngramError\u003e {\n        // Get the task entity\n        let _task = match self.base_validator.storage().get(task_id, \"task\")? {\n            Some(generic_entity) =\u003e match Task::from_generic(generic_entity) {\n                Ok(task) =\u003e task,\n                Err(_) =\u003e return Ok(None),\n            },\n            None =\u003e return Ok(None),\n        };\n\n        // Find workflows associated with this task\n        let filter = RelationshipFilter {\n            source_id: Some(task_id.to_string()),\n            target_id: None,\n            entity_id: None,\n            relationship_type: Some(EntityRelationType::AssociatedWith),\n            direction: None,\n            min_strength: None,\n            active_only: Some(true),\n            source_type: Some(\"task\".to_string()),\n            target_type: Some(\"workflow\".to_string()),\n            agent: None,\n        };\n\n        let relationships = self.base_validator.storage().query_relationships(\u0026filter)?;\n\n        for workflow_rel in relationships {\n            if let Some(workflow_entity) = self\n                .base_validator\n                .storage()\n                .get(\u0026workflow_rel.target_id, \"workflow\")?\n            {\n                if let Ok(workflow) = Workflow::from_generic(workflow_entity) {\n                    return Ok(Some(self.get_workflow_current_stage(\u0026workflow)?));\n                }\n            }\n        }\n\n        Ok(None)\n    }\n\n    /// Get current stage from workflow instance\n    fn get_workflow_current_stage(\u0026self, workflow: \u0026Workflow) -\u003e Result\u003cString, EngramError\u003e {\n        // This is simplified - in reality would query workflow instances\n        // For now, return a default stage based on workflow metadata\n        if let Some(current_stage) = workflow.metadata.get(\"current_stage\") {\n            if let Some(stage_str) = current_stage.as_str() {\n                return Ok(stage_str.to_string());\n            }\n        }\n\n        // Default to the initial state if no current stage is set\n        Ok(workflow.initial_state.clone())\n    }\n\n    /// Validate stage-specific policies\n    fn validate_stage_policy(\n        \u0026self,\n        policy: \u0026StagePolicy,\n        staged_files: \u0026[String],\n        commit_message: \u0026str,\n        task_id: \u0026str,\n    ) -\u003e Vec\u003cValidationError\u003e {\n        let mut errors = Vec::new();\n\n        // Check if code commits are allowed\n        if !policy.allow_code_commits \u0026\u0026 self.has_code_files(staged_files) {\n            errors.push(ValidationError::new(\n                ValidationErrorType::PolicyViolation,\n                format!(\n                    \"Code commits not allowed in '{}' stage. Only engram entity changes permitted.\",\n                    policy.stage_name\n                ),\n            ));\n        }\n\n        // Check if only engram entities are allowed\n        if policy.engram_only \u0026\u0026 !self.is_engram_only_commit(staged_files) {\n            errors.push(ValidationError::new(\n                ValidationErrorType::PolicyViolation,\n                format!(\n                    \"Only engram entity changes allowed in '{}' stage\",\n                    policy.stage_name\n                ),\n            ));\n        }\n\n        // Additional stage-specific validations\n        for rule in \u0026policy.additional_rules {\n            match rule.as_str() {\n                \"tests_only\" =\u003e {\n                    if !self.is_test_only_commit(staged_files) {\n                        errors.push(ValidationError::new(\n                            ValidationErrorType::PolicyViolation,\n                            \"BDD Red phase requires test-only commits\".to_string(),\n                        ));\n                    }\n                }\n                \"minimal_implementation\" =\u003e {\n                    if !self.is_minimal_implementation(staged_files) {\n                        errors.push(ValidationError::new(\n                            ValidationErrorType::PolicyViolation,\n                            \"BDD Green phase requires minimal implementation to pass tests\"\n                                .to_string(),\n                        ));\n                    }\n                }\n                \"no_new_tests\" =\u003e {\n                    if self.has_new_test_files(staged_files) {\n                        errors.push(ValidationError::new(\n                            ValidationErrorType::PolicyViolation,\n                            \"BDD Refactor phase should not add new tests\".to_string(),\n                        ));\n                    }\n                }\n                _ =\u003e {} // Unknown rule, skip\n            }\n        }\n\n        // Check if task is transitioning states\n        if let Some(target_state) = self.extract_target_state_from_commit(commit_message) {\n            let workflow_stage = \u0026policy.stage_name;\n\n            // Verify transition is valid\n            if let Ok(Some(workflow_id)) = self.get_task_workflow_id(task_id) {\n                if let Ok(valid_transition) =\n                    self.is_valid_transition(\u0026workflow_id, workflow_stage, \u0026target_state)\n                {\n                    if !valid_transition {\n                        errors.push(ValidationError::new(\n                            ValidationErrorType::PolicyViolation,\n                            format!(\n                                \"Invalid workflow transition from '{}' to '{}'\",\n                                workflow_stage, target_state\n                            ),\n                        ));\n                    }\n                }\n            }\n        }\n\n        errors\n    }\n\n    /// Extract target state from commit message\n    fn extract_target_state_from_commit(\u0026self, commit_message: \u0026str) -\u003e Option\u003cString\u003e {\n        // Look for [state:new_state] pattern\n        if let Some(start) = commit_message.find(\"[state:\") {\n            if let Some(end) = commit_message[start..].find(']') {\n                let state_tag = \u0026commit_message[start + 7..start + end];\n                return Some(state_tag.to_string());\n            }\n        }\n        None\n    }\n\n    /// Get workflow ID for a task\n    fn get_task_workflow_id(\u0026self, task_id: \u0026str) -\u003e Result\u003cOption\u003cString\u003e, EngramError\u003e {\n        if let Some(generic_entity) = self.base_validator.storage().get(task_id, \"task\")? {\n            if let Ok(task) = Task::from_generic(generic_entity) {\n                return Ok(task.workflow_id);\n            }\n        }\n        Ok(None)\n    }\n\n    /// Check if transition is valid\n    fn is_valid_transition(\n        \u0026self,\n        workflow_id: \u0026str,\n        from_state: \u0026str,\n        to_state: \u0026str,\n    ) -\u003e Result\u003cbool, EngramError\u003e {\n        if let Some(workflow_entity) = self.base_validator.storage().get(workflow_id, \"workflow\")? {\n            if let Ok(workflow) = Workflow::from_generic(workflow_entity) {\n                // Check if transition exists in workflow\n                for transition in workflow.transitions {\n                    if transition.from_state == from_state \u0026\u0026 transition.to_state == to_state {\n                        return Ok(true);\n                    }\n                }\n            }\n        }\n        Ok(false)\n    }\n\n    /// Check if the commit contains code files\n    fn has_code_files(\u0026self, staged_files: \u0026[String]) -\u003e bool {\n        staged_files.iter().any(|file| {\n            let lower = file.to_lowercase();\n            lower.ends_with(\".rs\")\n                || lower.ends_with(\".py\")\n                || lower.ends_with(\".js\")\n                || lower.ends_with(\".ts\")\n                || lower.ends_with(\".go\")\n                || lower.ends_with(\".java\")\n                || lower.ends_with(\".c\")\n                || lower.ends_with(\".cpp\")\n                || lower.ends_with(\".h\")\n                || lower.ends_with(\".hpp\")\n        })\n    }\n\n    /// Check if commit only contains engram entities\n    fn is_engram_only_commit(\u0026self, staged_files: \u0026[String]) -\u003e bool {\n        staged_files\n            .iter()\n            .all(|file| file.starts_with(\".engram/\") || file == \".engram\")\n    }\n\n    /// Check if commit only contains test files\n    fn is_test_only_commit(\u0026self, staged_files: \u0026[String]) -\u003e bool {\n        staged_files.iter().all(|file| {\n            let lower = file.to_lowercase();\n            lower.contains(\"test\")\n                || lower.contains(\"spec\")\n                || lower.ends_with(\"_test.rs\")\n                || lower.starts_with(\"test_\")\n                || file.starts_with(\"tests/\")\n        })\n    }\n\n    /// Check if this looks like minimal implementation (heuristic)\n    fn is_minimal_implementation(\u0026self, staged_files: \u0026[String]) -\u003e bool {\n        // This is a heuristic - in practice would be more sophisticated\n        let code_files: Vec\u003c_\u003e = staged_files\n            .iter()\n            .filter(|f| self.has_code_files(\u0026[f.to_string()]))\n            .collect();\n\n        // Minimal implementation should touch few files\n        code_files.len() \u003c= 3\n    }\n\n    /// Check if commit adds new test files\n    fn has_new_test_files(\u0026self, staged_files: \u0026[String]) -\u003e bool {\n        // This would need Git integration to check if files are new\n        // For now, simplified check\n        staged_files.iter().any(|file| {\n            let lower = file.to_lowercase();\n            (lower.contains(\"test\") || lower.contains(\"spec\")) \u0026\u0026 !file.starts_with(\"tests/\")\n        })\n    }\n}\n\n/// Summary of quality gate execution\n#[derive(Debug)]\nstruct QualityGateExecutionSummary {\n    pub all_passed: bool,\n    pub errors: Vec\u003cValidationError\u003e,\n    pub validated_files: Vec\u003cString\u003e,\n}\n\nimpl QualityGateExecutionSummary {\n    #[allow(dead_code)]\n    fn new() -\u003e Self {\n        Self {\n            all_passed: true,\n            errors: Vec::new(),\n            validated_files: Vec::new(),\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::entities::workflow::{TransitionType, WorkflowTransition};\n    use crate::storage::MemoryStorage;\n\n    #[tokio::test]\n    async fn test_validate_transition_default_rules() {\n        let storage = MemoryStorage::new(\"test-agent\");\n        let validator = WorkflowValidator::new(storage).unwrap();\n\n        assert!(validator\n            .validate_transition(\"todo\", \"inprogress\", None)\n            .is_ok());\n        assert!(validator\n            .validate_transition(\"inprogress\", \"done\", None)\n            .is_ok());\n        assert!(validator\n            .validate_transition(\"inprogress\", \"blocked\", None)\n            .is_ok());\n        assert!(validator\n            .validate_transition(\"blocked\", \"inprogress\", None)\n            .is_ok());\n        assert!(validator\n            .validate_transition(\"done\", \"reopened\", None)\n            .is_ok());\n        assert!(validator.validate_transition(\"todo\", \"todo\", None).is_ok());\n\n        assert!(validator.validate_transition(\"todo\", \"done\", None).is_err());\n        assert!(validator\n            .validate_transition(\"done\", \"inprogress\", None)\n            .is_err());\n        assert!(validator\n            .validate_transition(\"blocked\", \"done\", None)\n            .is_err());\n    }\n\n    #[tokio::test]\n    async fn test_validate_transition_workflow_rules() {\n        let storage = MemoryStorage::new(\"test-agent\");\n        let validator = WorkflowValidator::new(storage).unwrap();\n\n        let mut workflow = Workflow::new(\n            \"Custom Workflow\".to_string(),\n            \"Description\".to_string(),\n            \"test-agent\".to_string(),\n        );\n\n        workflow.add_transition(WorkflowTransition {\n            id: \"t1\".to_string(),\n            name: \"Start\".to_string(),\n            from_state: \"draft\".to_string(),\n            to_state: \"review\".to_string(),\n            transition_type: TransitionType::Manual,\n            description: \"Start review\".to_string(),\n            conditions: vec![],\n            actions: vec![],\n        });\n\n        assert!(validator\n            .validate_transition(\"draft\", \"review\", Some(\u0026workflow))\n            .is_ok());\n\n        assert!(validator\n            .validate_transition(\"draft\", \"published\", Some(\u0026workflow))\n            .is_err());\n\n        assert!(validator\n            .validate_transition(\"todo\", \"inprogress\", Some(\u0026workflow))\n            .is_err());\n    }\n}\n","traces":[{"line":36,"address":[17735520,17735774,17735768],"length":1,"stats":{"Line":1}},{"line":38,"address":[24616125],"length":1,"stats":{"Line":1}},{"line":43,"address":[17735559],"length":1,"stats":{"Line":1}},{"line":44,"address":[25076874],"length":1,"stats":{"Line":1}},{"line":59,"address":[16289073,16288688],"length":1,"stats":{"Line":1}},{"line":60,"address":[16288705],"length":1,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":1}},{"line":63,"address":[16288978],"length":1,"stats":{"Line":1}},{"line":64,"address":[16288955],"length":1,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":1}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":85,"address":[],"length":0,"stats":{"Line":1}},{"line":86,"address":[],"length":0,"stats":{"Line":2}},{"line":87,"address":[],"length":0,"stats":{"Line":1}},{"line":88,"address":[],"length":0,"stats":{"Line":1}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":2}},{"line":94,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[16283243],"length":1,"stats":{"Line":2}},{"line":100,"address":[],"length":0,"stats":{"Line":1}},{"line":101,"address":[16283115],"length":1,"stats":{"Line":2}},{"line":102,"address":[],"length":0,"stats":{"Line":1}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":4}},{"line":113,"address":[16284267],"length":1,"stats":{"Line":2}},{"line":114,"address":[16283313],"length":1,"stats":{"Line":2}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":116,"address":[],"length":0,"stats":{"Line":2}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[16283498,16288571,16283434],"length":1,"stats":{"Line":4}},{"line":122,"address":[],"length":0,"stats":{"Line":4}},{"line":127,"address":[],"length":0,"stats":{"Line":2}},{"line":128,"address":[16284337],"length":1,"stats":{"Line":2}},{"line":129,"address":[16285041],"length":1,"stats":{"Line":2}},{"line":130,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[16288539,16284522,16284458],"length":1,"stats":{"Line":4}},{"line":136,"address":[16284756,16284817,16288534],"length":1,"stats":{"Line":4}},{"line":141,"address":[],"length":0,"stats":{"Line":2}},{"line":142,"address":[],"length":0,"stats":{"Line":2}},{"line":143,"address":[],"length":0,"stats":{"Line":2}},{"line":144,"address":[16285278],"length":1,"stats":{"Line":2}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":4}},{"line":150,"address":[16285652,16288502,16285713],"length":1,"stats":{"Line":4}},{"line":155,"address":[],"length":0,"stats":{"Line":1}},{"line":156,"address":[],"length":0,"stats":{"Line":2}},{"line":157,"address":[16287017],"length":1,"stats":{"Line":1}},{"line":158,"address":[],"length":0,"stats":{"Line":2}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":4}},{"line":164,"address":[],"length":0,"stats":{"Line":4}},{"line":169,"address":[],"length":0,"stats":{"Line":1}},{"line":170,"address":[16287215],"length":1,"stats":{"Line":1}},{"line":171,"address":[],"length":0,"stats":{"Line":1}},{"line":172,"address":[16287254],"length":1,"stats":{"Line":1}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[16287394,16287336,16288443],"length":1,"stats":{"Line":2}},{"line":178,"address":[],"length":0,"stats":{"Line":3}},{"line":179,"address":[16287697],"length":1,"stats":{"Line":1}},{"line":180,"address":[16287768],"length":1,"stats":{"Line":1}},{"line":186,"address":[],"length":0,"stats":{"Line":1}},{"line":188,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[16279744],"length":1,"stats":{"Line":1}},{"line":295,"address":[],"length":0,"stats":{"Line":1}},{"line":296,"address":[16279968,16279849],"length":1,"stats":{"Line":2}},{"line":297,"address":[16280029,16280416],"length":1,"stats":{"Line":2}},{"line":298,"address":[16280444],"length":1,"stats":{"Line":1}},{"line":301,"address":[16280058],"length":1,"stats":{"Line":1}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":1}},{"line":308,"address":[],"length":0,"stats":{"Line":3}},{"line":309,"address":[16280577,16280453,16280884],"length":1,"stats":{"Line":3}},{"line":310,"address":[],"length":0,"stats":{"Line":2}},{"line":311,"address":[],"length":0,"stats":{"Line":3}},{"line":312,"address":[],"length":0,"stats":{"Line":2}},{"line":313,"address":[],"length":0,"stats":{"Line":2}},{"line":314,"address":[],"length":0,"stats":{"Line":1}},{"line":317,"address":[],"length":0,"stats":{"Line":3}},{"line":318,"address":[],"length":0,"stats":{"Line":1}},{"line":320,"address":[16281001],"length":1,"stats":{"Line":1}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[19301348,19301200,19301354],"length":1,"stats":{"Line":0}},{"line":599,"address":[19372910],"length":1,"stats":{"Line":0}},{"line":600,"address":[17732428],"length":1,"stats":{"Line":0}}],"covered":74,"coverable":285},{"path":["/","home","shift","code","vincents-ai","engram","src","vector","embedding.rs"],"content":"//! Embedding generation traits and providers\n\nuse super::Result;\nuse async_trait::async_trait;\n\n#[async_trait]\npub trait EmbeddingProvider: Send + Sync {\n    async fn embed(\u0026self, text: \u0026str) -\u003e Result\u003cVec\u003cf32\u003e\u003e;\n\n    async fn embed_batch(\u0026self, texts: \u0026[\u0026str]) -\u003e Result\u003cVec\u003cVec\u003cf32\u003e\u003e\u003e {\n        let mut embeddings = Vec::with_capacity(texts.len());\n        for text in texts {\n            embeddings.push(self.embed(text).await?);\n        }\n        Ok(embeddings)\n    }\n\n    fn dimensions(\u0026self) -\u003e usize;\n\n    fn model_name(\u0026self) -\u003e \u0026str;\n\n    fn provider_type(\u0026self) -\u003e ProviderType;\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum ProviderType {\n    LocalOnnx,\n    LocalCandle,\n    OpenAI,\n    Cohere,\n    Voyage,\n    Mock,\n}\n\nimpl std::fmt::Display for ProviderType {\n    fn fmt(\u0026self, f: \u0026mut std::fmt::Formatter\u003c'_\u003e) -\u003e std::fmt::Result {\n        match self {\n            ProviderType::LocalOnnx =\u003e write!(f, \"local_onnx\"),\n            ProviderType::LocalCandle =\u003e write!(f, \"local_candle\"),\n            ProviderType::OpenAI =\u003e write!(f, \"openai\"),\n            ProviderType::Cohere =\u003e write!(f, \"cohere\"),\n            ProviderType::Voyage =\u003e write!(f, \"voyage\"),\n            ProviderType::Mock =\u003e write!(f, \"mock\"),\n        }\n    }\n}\n\n#[derive(Debug, Clone)]\npub struct MockEmbeddingProvider {\n    dimensions: usize,\n    model_name: String,\n}\n\nimpl MockEmbeddingProvider {\n    pub fn new(dimensions: usize) -\u003e Self {\n        Self {\n            dimensions,\n            model_name: \"mock-embeddings\".to_string(),\n        }\n    }\n}\n\n#[async_trait]\nimpl EmbeddingProvider for MockEmbeddingProvider {\n    async fn embed(\u0026self, text: \u0026str) -\u003e Result\u003cVec\u003cf32\u003e\u003e {\n        use std::collections::hash_map::DefaultHasher;\n        use std::hash::{Hash, Hasher};\n\n        let mut hasher = DefaultHasher::new();\n        text.hash(\u0026mut hasher);\n        let hash = hasher.finish();\n\n        let mut vec = Vec::with_capacity(self.dimensions);\n        let mut rng = hash;\n        for _ in 0..self.dimensions {\n            rng = rng.wrapping_mul(1103515245).wrapping_add(12345);\n            vec.push(((rng as f32) / (u64::MAX as f32)) * 2.0 - 1.0);\n        }\n\n        let norm: f32 = vec.iter().map(|x| x * x).sum::\u003cf32\u003e().sqrt();\n        if norm \u003e 0.0 {\n            for val in vec.iter_mut() {\n                *val /= norm;\n            }\n        }\n\n        Ok(vec)\n    }\n\n    fn dimensions(\u0026self) -\u003e usize {\n        self.dimensions\n    }\n\n    fn model_name(\u0026self) -\u003e \u0026str {\n        \u0026self.model_name\n    }\n\n    fn provider_type(\u0026self) -\u003e ProviderType {\n        ProviderType::Mock\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[tokio::test]\n    async fn test_mock_provider() {\n        let provider = MockEmbeddingProvider::new(384);\n\n        let embedding = provider.embed(\"test text\").await.unwrap();\n        assert_eq!(embedding.len(), 384);\n\n        let norm: f32 = embedding.iter().map(|x| x * x).sum::\u003cf32\u003e().sqrt();\n        assert!((norm - 1.0).abs() \u003c 0.001);\n    }\n\n    #[tokio::test]\n    async fn test_mock_batch() {\n        let provider = MockEmbeddingProvider::new(128);\n\n        let texts = vec![\"text1\", \"text2\", \"text3\"];\n        let embeddings = provider.embed_batch(\u0026texts).await.unwrap();\n\n        assert_eq!(embeddings.len(), 3);\n        for emb in embeddings {\n            assert_eq!(emb.len(), 128);\n        }\n    }\n\n    #[tokio::test]\n    async fn test_deterministic() {\n        let provider = MockEmbeddingProvider::new(256);\n\n        let emb1 = provider.embed(\"same text\").await.unwrap();\n        let emb2 = provider.embed(\"same text\").await.unwrap();\n\n        assert_eq!(emb1, emb2);\n    }\n}\n","traces":[{"line":10,"address":[27123945,27124272,27125136,27124438,27125223,27124227,27124196,27124000,27124103,27124035],"length":1,"stats":{"Line":6}},{"line":11,"address":[26663531],"length":1,"stats":{"Line":1}},{"line":12,"address":[20878460,20878559,20878546,20879047],"length":1,"stats":{"Line":4}},{"line":13,"address":[19934114,19934478,19934453,19935135,19934947],"length":1,"stats":{"Line":3}},{"line":15,"address":[20005766],"length":1,"stats":{"Line":1}},{"line":36,"address":[17498768],"length":1,"stats":{"Line":0}},{"line":37,"address":[17439547],"length":1,"stats":{"Line":0}},{"line":38,"address":[17498826],"length":1,"stats":{"Line":0}},{"line":39,"address":[18779141],"length":1,"stats":{"Line":0}},{"line":40,"address":[17439664],"length":1,"stats":{"Line":0}},{"line":41,"address":[18142923],"length":1,"stats":{"Line":0}},{"line":42,"address":[17295641],"length":1,"stats":{"Line":0}},{"line":43,"address":[17295687],"length":1,"stats":{"Line":0}},{"line":55,"address":[18928416],"length":1,"stats":{"Line":1}},{"line":58,"address":[17439191],"length":1,"stats":{"Line":1}},{"line":65,"address":[24628819],"length":1,"stats":{"Line":6}},{"line":69,"address":[27122187],"length":1,"stats":{"Line":1}},{"line":70,"address":[20876447],"length":1,"stats":{"Line":1}},{"line":71,"address":[21443138],"length":1,"stats":{"Line":1}},{"line":73,"address":[15568233],"length":1,"stats":{"Line":1}},{"line":74,"address":[20003168],"length":1,"stats":{"Line":1}},{"line":75,"address":[21443319,21443224],"length":1,"stats":{"Line":2}},{"line":76,"address":[26662478,26661906],"length":1,"stats":{"Line":2}},{"line":77,"address":[15568991,15569068],"length":1,"stats":{"Line":2}},{"line":80,"address":[20876753,20877472,20877486],"length":1,"stats":{"Line":3}},{"line":81,"address":[26662089],"length":1,"stats":{"Line":1}},{"line":82,"address":[26662240,26662463],"length":1,"stats":{"Line":2}},{"line":83,"address":[15568939],"length":1,"stats":{"Line":1}},{"line":87,"address":[21443573],"length":1,"stats":{"Line":1}},{"line":90,"address":[18927984],"length":1,"stats":{"Line":0}},{"line":91,"address":[24168085],"length":1,"stats":{"Line":0}},{"line":94,"address":[24628768],"length":1,"stats":{"Line":0}},{"line":95,"address":[17294645],"length":1,"stats":{"Line":0}},{"line":98,"address":[17294656],"length":1,"stats":{"Line":0}}],"covered":21,"coverable":34},{"path":["/","home","shift","code","vincents-ai","engram","src","vector","fastembed_provider.rs"],"content":"use super::embedding::{EmbeddingProvider, ProviderType};\nuse super::Result;\nuse crate::error::{EngramError, StorageError};\nuse async_trait::async_trait;\nuse fastembed::{EmbeddingModel, InitOptions, TextEmbedding};\nuse std::sync::Mutex;\n\npub struct FastEmbedProvider {\n    model: Mutex\u003cTextEmbedding\u003e,\n    model_name: String,\n    dimensions: usize,\n}\n\nimpl FastEmbedProvider {\n    pub fn new() -\u003e Result\u003cSelf\u003e {\n        Self::with_model(EmbeddingModel::AllMiniLML6V2)\n    }\n\n    pub fn with_model(model_type: EmbeddingModel) -\u003e Result\u003cSelf\u003e {\n        let model = TextEmbedding::try_new(\n            InitOptions::new(model_type.clone()).with_show_download_progress(true),\n        )\n        .map_err(|e| {\n            EngramError::Storage(StorageError::InvalidState(format!(\n                \"Failed to initialize FastEmbed model: {}\",\n                e\n            )))\n        })?;\n\n        let dimensions = match model_type {\n            EmbeddingModel::AllMiniLML6V2 =\u003e 384,\n            EmbeddingModel::AllMiniLML12V2 =\u003e 384,\n            EmbeddingModel::BGESmallENV15 =\u003e 384,\n            EmbeddingModel::BGEBaseENV15 =\u003e 768,\n            EmbeddingModel::BGELargeENV15 =\u003e 1024,\n            _ =\u003e 384,\n        };\n\n        let model_name = format!(\"{:?}\", model_type);\n\n        Ok(Self {\n            model: Mutex::new(model),\n            model_name,\n            dimensions,\n        })\n    }\n}\n\n#[async_trait]\nimpl EmbeddingProvider for FastEmbedProvider {\n    async fn embed(\u0026self, text: \u0026str) -\u003e Result\u003cVec\u003cf32\u003e\u003e {\n        let mut model = self.model.lock().map_err(|e| {\n            EngramError::Storage(StorageError::InvalidState(format!(\n                \"Failed to lock model: {}\",\n                e\n            )))\n        })?;\n\n        let embeddings = model.embed(vec![text], None).map_err(|e| {\n            EngramError::Storage(StorageError::InvalidState(format!(\n                \"Failed to generate embedding: {}\",\n                e\n            )))\n        })?;\n\n        embeddings.into_iter().next().ok_or_else(|| {\n            EngramError::Storage(StorageError::InvalidState(\n                \"No embedding generated\".to_string(),\n            ))\n        })\n    }\n\n    async fn embed_batch(\u0026self, texts: \u0026[\u0026str]) -\u003e Result\u003cVec\u003cVec\u003cf32\u003e\u003e\u003e {\n        let mut model = self.model.lock().map_err(|e| {\n            EngramError::Storage(StorageError::InvalidState(format!(\n                \"Failed to lock model: {}\",\n                e\n            )))\n        })?;\n\n        model.embed(texts.to_vec(), None).map_err(|e| {\n            EngramError::Storage(StorageError::InvalidState(format!(\n                \"Failed to generate batch embeddings: {}\",\n                e\n            )))\n        })\n    }\n\n    fn dimensions(\u0026self) -\u003e usize {\n        self.dimensions\n    }\n\n    fn model_name(\u0026self) -\u003e \u0026str {\n        \u0026self.model_name\n    }\n\n    fn provider_type(\u0026self) -\u003e ProviderType {\n        ProviderType::LocalOnnx\n    }\n}\n\nimpl Default for FastEmbedProvider {\n    fn default() -\u003e Self {\n        Self::new().expect(\"Failed to create default FastEmbed provider\")\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[tokio::test]\n    async fn test_fastembed_provider_init() {\n        let provider = FastEmbedProvider::new();\n        assert!(provider.is_ok());\n\n        let provider = provider.unwrap();\n        assert_eq!(provider.dimensions(), 384);\n    }\n\n    #[tokio::test]\n    async fn test_fastembed_embed() {\n        let provider = FastEmbedProvider::new().unwrap();\n        let embedding = provider.embed(\"Hello, world!\").await;\n\n        assert!(embedding.is_ok());\n        let vec = embedding.unwrap();\n        assert_eq!(vec.len(), 384);\n\n        assert!(vec.iter().any(|\u0026x| x != 0.0));\n    }\n\n    #[tokio::test]\n    async fn test_fastembed_embed_batch() {\n        let provider = FastEmbedProvider::new().unwrap();\n        let texts = vec![\"First text\", \"Second text\", \"Third text\"];\n\n        let embeddings = provider.embed_batch(\u0026texts).await;\n        assert!(embeddings.is_ok());\n\n        let vecs = embeddings.unwrap();\n        assert_eq!(vecs.len(), 3);\n        assert!(vecs.iter().all(|v| v.len() == 384));\n    }\n\n    #[tokio::test]\n    async fn test_deterministic_embeddings() {\n        let provider = FastEmbedProvider::new().unwrap();\n        let text = \"Test text for determinism\";\n\n        let embedding1 = provider.embed(text).await.unwrap();\n        let embedding2 = provider.embed(text).await.unwrap();\n\n        assert_eq!(embedding1.len(), embedding2.len());\n\n        for (a, b) in embedding1.iter().zip(embedding2.iter()) {\n            assert!((a - b).abs() \u003c 1e-6);\n        }\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","home","shift","code","vincents-ai","engram","src","vector","mod.rs"],"content":"//! Vector search layer for semantic similarity\n//!\n//! Provides optional vector embeddings and similarity search on top of\n//! the existing Git refs storage. This is an opt-in feature that does\n//! not affect core entity storage operations.\n\npub mod embedding;\npub mod storage;\n\n#[cfg(feature = \"vector-search\")]\npub mod sqlite_storage;\n\n#[cfg(feature = \"vector-search\")]\npub mod fastembed_provider;\n\npub use embedding::*;\npub use storage::*;\n\n#[cfg(feature = \"vector-search\")]\npub use sqlite_storage::*;\n\n#[cfg(feature = \"vector-search\")]\npub use fastembed_provider::*;\n\nuse crate::error::EngramError;\n\npub type Result\u003cT\u003e = std::result::Result\u003cT, EngramError\u003e;\n\n#[derive(Debug, Clone)]\npub struct SearchResult {\n    pub entity_id: String,\n    pub entity_type: String,\n    pub score: f32,\n    pub snippet: Option\u003cString\u003e,\n    pub model: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct SearchQuery {\n    pub text: String,\n    pub entity_types: Vec\u003cString\u003e,\n    pub limit: usize,\n    pub threshold: f32,\n}\n\nimpl Default for SearchQuery {\n    fn default() -\u003e Self {\n        Self {\n            text: String::new(),\n            entity_types: vec![],\n            limit: 10,\n            threshold: 0.7,\n        }\n    }\n}\n","traces":[{"line":47,"address":[17055616,17055783,17055777],"length":1,"stats":{"Line":0}},{"line":49,"address":[16852275],"length":1,"stats":{"Line":0}},{"line":50,"address":[16852280],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":3},{"path":["/","home","shift","code","vincents-ai","engram","src","vector","sqlite_storage.rs"],"content":"use super::storage::cosine_similarity;\nuse super::SearchResult;\nuse anyhow::{Context, Result};\nuse rusqlite::{params, Connection, OptionalExtension};\nuse std::path::Path;\nuse std::sync::{Arc, Mutex};\n\npub struct SqliteVectorStorage {\n    conn: Arc\u003cMutex\u003cConnection\u003e\u003e,\n}\n\nimpl SqliteVectorStorage {\n    pub fn new\u003cP: AsRef\u003cPath\u003e\u003e(db_path: P) -\u003e Result\u003cSelf\u003e {\n        let conn = Connection::open(db_path.as_ref()).context(\"Failed to open SQLite database\")?;\n\n        unsafe {\n            rusqlite::ffi::sqlite3_auto_extension(Some(std::mem::transmute(\n                sqlite_vec::sqlite3_vec_init as *const (),\n            )));\n        }\n\n        let storage = Self {\n            conn: Arc::new(Mutex::new(conn)),\n        };\n\n        storage.init_schema()?;\n        Ok(storage)\n    }\n\n    pub fn memory() -\u003e Result\u003cSelf\u003e {\n        let conn = Connection::open_in_memory().context(\"Failed to open in-memory database\")?;\n\n        unsafe {\n            rusqlite::ffi::sqlite3_auto_extension(Some(std::mem::transmute(\n                sqlite_vec::sqlite3_vec_init as *const (),\n            )));\n        }\n\n        let storage = Self {\n            conn: Arc::new(Mutex::new(conn)),\n        };\n\n        storage.init_schema()?;\n        Ok(storage)\n    }\n\n    fn init_schema(\u0026self) -\u003e Result\u003c()\u003e {\n        let conn = self.conn.lock().unwrap();\n\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS embeddings (\n                id TEXT PRIMARY KEY,\n                entity_id TEXT NOT NULL,\n                entity_type TEXT NOT NULL,\n                vector BLOB NOT NULL,\n                model TEXT NOT NULL,\n                dimensions INTEGER NOT NULL,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                UNIQUE(entity_id, model)\n            )\",\n            [],\n        )?;\n\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS models (\n                name TEXT PRIMARY KEY,\n                provider TEXT NOT NULL,\n                dimensions INTEGER NOT NULL,\n                is_default BOOLEAN DEFAULT 0,\n                config TEXT\n            )\",\n            [],\n        )?;\n\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS search_history (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                query TEXT NOT NULL,\n                results TEXT NOT NULL,\n                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\",\n            [],\n        )?;\n\n        conn.execute(\n            \"CREATE INDEX IF NOT EXISTS idx_embeddings_entity \n             ON embeddings(entity_id, entity_type)\",\n            [],\n        )?;\n\n        conn.execute(\n            \"CREATE INDEX IF NOT EXISTS idx_embeddings_model \n             ON embeddings(model)\",\n            [],\n        )?;\n\n        Ok(())\n    }\n\n    pub fn store_embedding(\n        \u0026self,\n        entity_id: \u0026str,\n        entity_type: \u0026str,\n        embedding: \u0026[f32],\n        model: \u0026str,\n    ) -\u003e Result\u003c()\u003e {\n        let id = uuid::Uuid::new_v4().to_string();\n        let dimensions = embedding.len();\n        let vector_bytes = bytemuck::cast_slice::\u003cf32, u8\u003e(embedding);\n\n        let conn = self.conn.lock().unwrap();\n        conn.execute(\n            \"INSERT OR REPLACE INTO embeddings \n             (id, entity_id, entity_type, vector, model, dimensions)\n             VALUES (?, ?, ?, ?, ?, ?)\",\n            params![\n                id,\n                entity_id,\n                entity_type,\n                vector_bytes,\n                model,\n                dimensions as i64\n            ],\n        )?;\n\n        Ok(())\n    }\n\n    pub fn get_embedding(\u0026self, entity_id: \u0026str, model: \u0026str) -\u003e Result\u003cOption\u003cVec\u003cf32\u003e\u003e\u003e {\n        let conn = self.conn.lock().unwrap();\n\n        let result: Option\u003cVec\u003cu8\u003e\u003e = conn\n            .query_row(\n                \"SELECT vector FROM embeddings \n                 WHERE entity_id = ? AND model = ?\",\n                params![entity_id, model],\n                |row| row.get(0),\n            )\n            .optional()?;\n\n        Ok(result.map(|bytes| bytemuck::cast_slice::\u003cu8, f32\u003e(\u0026bytes).to_vec()))\n    }\n\n    pub fn delete_embedding(\u0026self, entity_id: \u0026str, model: \u0026str) -\u003e Result\u003c()\u003e {\n        let conn = self.conn.lock().unwrap();\n        conn.execute(\n            \"DELETE FROM embeddings WHERE entity_id = ? AND model = ?\",\n            params![entity_id, model],\n        )?;\n        Ok(())\n    }\n\n    pub fn search_similar(\n        \u0026self,\n        query_embedding: \u0026[f32],\n        entity_type: Option\u003c\u0026str\u003e,\n        limit: usize,\n        threshold: f32,\n    ) -\u003e Result\u003cVec\u003cSearchResult\u003e\u003e {\n        let conn = self.conn.lock().unwrap();\n\n        let type_filter = if let Some(et) = entity_type {\n            format!(\"AND entity_type = '{}'\", et)\n        } else {\n            String::new()\n        };\n\n        let mut stmt = conn.prepare(\u0026format!(\n            \"SELECT entity_id, entity_type, vector, model\n             FROM embeddings\n             WHERE 1=1 {}\n             LIMIT ?\",\n            type_filter\n        ))?;\n\n        let results = stmt.query_map(params![limit * 10], |row| {\n            let entity_id: String = row.get(0)?;\n            let entity_type: String = row.get(1)?;\n            let vector_bytes: Vec\u003cu8\u003e = row.get(2)?;\n            let model: String = row.get(3)?;\n\n            let embedding = bytemuck::cast_slice::\u003cu8, f32\u003e(\u0026vector_bytes).to_vec();\n            let score = cosine_similarity(query_embedding, \u0026embedding);\n\n            Ok(SearchResult {\n                entity_id,\n                entity_type,\n                score,\n                snippet: None,\n                model: Some(model),\n            })\n        })?;\n\n        let mut filtered: Vec\u003cSearchResult\u003e = results\n            .filter_map(|r| r.ok())\n            .filter(|r| r.score \u003e= threshold)\n            .collect();\n\n        filtered.sort_by(|a, b| b.score.partial_cmp(\u0026a.score).unwrap());\n        filtered.truncate(limit);\n\n        Ok(filtered)\n    }\n\n    pub fn register_model(\n        \u0026self,\n        name: \u0026str,\n        provider: \u0026str,\n        dimensions: usize,\n        is_default: bool,\n    ) -\u003e Result\u003c()\u003e {\n        let conn = self.conn.lock().unwrap();\n\n        if is_default {\n            conn.execute(\"UPDATE models SET is_default = 0\", [])?;\n        }\n\n        conn.execute(\n            \"INSERT OR REPLACE INTO models (name, provider, dimensions, is_default)\n             VALUES (?, ?, ?, ?)\",\n            params![name, provider, dimensions as i64, is_default],\n        )?;\n\n        Ok(())\n    }\n\n    pub fn get_default_model(\u0026self) -\u003e Result\u003cOption\u003cString\u003e\u003e {\n        let conn = self.conn.lock().unwrap();\n        let result = conn\n            .query_row(\"SELECT name FROM models WHERE is_default = 1\", [], |row| {\n                row.get(0)\n            })\n            .optional()?;\n        Ok(result)\n    }\n\n    pub fn count_embeddings(\u0026self) -\u003e Result\u003cusize\u003e {\n        let conn = self.conn.lock().unwrap();\n        let count: i64 = conn.query_row(\"SELECT COUNT(*) FROM embeddings\", [], |row| row.get(0))?;\n        Ok(count as usize)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::vector::embedding::MockEmbeddingProvider;\n\n    #[test]\n    fn test_sqlite_storage_init() {\n        let storage = SqliteVectorStorage::memory().unwrap();\n        assert_eq!(storage.count_embeddings().unwrap(), 0);\n    }\n\n    #[test]\n    fn test_store_and_retrieve() {\n        let storage = SqliteVectorStorage::memory().unwrap();\n        let embedding = vec![0.1, 0.2, 0.3];\n\n        storage\n            .store_embedding(\"entity1\", \"task\", \u0026embedding, \"test-model\")\n            .unwrap();\n\n        let retrieved = storage.get_embedding(\"entity1\", \"test-model\").unwrap();\n        assert!(retrieved.is_some());\n\n        let retrieved_vec = retrieved.unwrap();\n        assert_eq!(retrieved_vec.len(), 3);\n        assert!((retrieved_vec[0] - 0.1).abs() \u003c 0.001);\n    }\n\n    #[test]\n    fn test_search_similar() {\n        let storage = SqliteVectorStorage::memory().unwrap();\n\n        storage\n            .store_embedding(\"e1\", \"task\", \u0026[1.0, 0.0, 0.0], \"test\")\n            .unwrap();\n        storage\n            .store_embedding(\"e2\", \"task\", \u0026[0.9, 0.1, 0.0], \"test\")\n            .unwrap();\n        storage\n            .store_embedding(\"e3\", \"task\", \u0026[0.0, 1.0, 0.0], \"test\")\n            .unwrap();\n\n        let query = vec![1.0, 0.0, 0.0];\n        let results = storage\n            .search_similar(\u0026query, Some(\"task\"), 10, 0.5)\n            .unwrap();\n\n        assert!(results.len() \u003e= 2);\n        assert_eq!(results[0].entity_id, \"e1\");\n        assert!(results[0].score \u003e 0.9);\n    }\n\n    #[test]\n    fn test_model_registration() {\n        let storage = SqliteVectorStorage::memory().unwrap();\n\n        storage\n            .register_model(\"model1\", \"local\", 384, true)\n            .unwrap();\n        storage.register_model(\"model2\", \"api\", 512, false).unwrap();\n\n        let default = storage.get_default_model().unwrap();\n        assert_eq!(default, Some(\"model1\".to_string()));\n    }\n\n    #[test]\n    fn test_delete_embedding() {\n        let storage = SqliteVectorStorage::memory().unwrap();\n        let embedding = vec![0.1, 0.2, 0.3];\n\n        storage\n            .store_embedding(\"entity1\", \"task\", \u0026embedding, \"test\")\n            .unwrap();\n        assert!(storage.get_embedding(\"entity1\", \"test\").unwrap().is_some());\n\n        storage.delete_embedding(\"entity1\", \"test\").unwrap();\n        assert!(storage.get_embedding(\"entity1\", \"test\").unwrap().is_none());\n    }\n}\n","traces":[{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","home","shift","code","vincents-ai","engram","src","vector","storage.rs"],"content":"//! Vector storage for embeddings and similarity search\n\nuse super::{Result, SearchQuery, SearchResult};\nuse chrono::{DateTime, Utc};\n\npub trait VectorStorage: Send + Sync {\n    fn store_embedding(\n        \u0026mut self,\n        entity_id: \u0026str,\n        entity_type: \u0026str,\n        vector: \u0026[f32],\n        model: \u0026str,\n    ) -\u003e Result\u003c()\u003e;\n\n    fn get_embedding(\u0026self, entity_id: \u0026str, model: \u0026str) -\u003e Result\u003cOption\u003cVec\u003cf32\u003e\u003e\u003e;\n\n    fn search(\u0026self, query_vector: \u0026[f32], query: \u0026SearchQuery) -\u003e Result\u003cVec\u003cSearchResult\u003e\u003e;\n\n    fn find_similar(\n        \u0026self,\n        entity_id: \u0026str,\n        limit: usize,\n        threshold: f32,\n    ) -\u003e Result\u003cVec\u003cSearchResult\u003e\u003e;\n\n    fn delete_embedding(\u0026mut self, entity_id: \u0026str, model: \u0026str) -\u003e Result\u003c()\u003e;\n\n    fn count_embeddings(\u0026self, model: Option\u003c\u0026str\u003e) -\u003e Result\u003cusize\u003e;\n\n    fn list_models(\u0026self) -\u003e Result\u003cVec\u003cString\u003e\u003e;\n}\n\n#[derive(Debug, Clone)]\npub struct EmbeddingRecord {\n    pub id: String,\n    pub entity_id: String,\n    pub entity_type: String,\n    pub vector: Vec\u003cf32\u003e,\n    pub model: String,\n    pub dimensions: usize,\n    pub created_at: DateTime\u003cUtc\u003e,\n}\n\npub fn cosine_similarity(a: \u0026[f32], b: \u0026[f32]) -\u003e f32 {\n    assert_eq!(a.len(), b.len(), \"Vectors must have same dimensions\");\n\n    let dot_product: f32 = a.iter().zip(b.iter()).map(|(x, y)| x * y).sum();\n    let norm_a: f32 = a.iter().map(|x| x * x).sum::\u003cf32\u003e().sqrt();\n    let norm_b: f32 = b.iter().map(|x| x * x).sum::\u003cf32\u003e().sqrt();\n\n    if norm_a == 0.0 || norm_b == 0.0 {\n        return 0.0;\n    }\n\n    dot_product / (norm_a * norm_b)\n}\n\npub fn euclidean_distance(a: \u0026[f32], b: \u0026[f32]) -\u003e f32 {\n    assert_eq!(a.len(), b.len(), \"Vectors must have same dimensions\");\n\n    a.iter()\n        .zip(b.iter())\n        .map(|(x, y)| (x - y).powi(2))\n        .sum::\u003cf32\u003e()\n        .sqrt()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_cosine_similarity() {\n        let a = vec![1.0, 0.0, 0.0];\n        let b = vec![1.0, 0.0, 0.0];\n        assert!((cosine_similarity(\u0026a, \u0026b) - 1.0).abs() \u003c 0.001);\n\n        let a = vec![1.0, 0.0];\n        let b = vec![0.0, 1.0];\n        assert!((cosine_similarity(\u0026a, \u0026b) - 0.0).abs() \u003c 0.001);\n\n        let a = vec![1.0, 1.0];\n        let b = vec![1.0, 1.0];\n        assert!((cosine_similarity(\u0026a, \u0026b) - 1.0).abs() \u003c 0.001);\n    }\n\n    #[test]\n    fn test_euclidean_distance() {\n        let a = vec![0.0, 0.0];\n        let b = vec![3.0, 4.0];\n        assert!((euclidean_distance(\u0026a, \u0026b) - 5.0).abs() \u003c 0.001);\n\n        let a = vec![1.0, 2.0, 3.0];\n        let b = vec![1.0, 2.0, 3.0];\n        assert!((euclidean_distance(\u0026a, \u0026b) - 0.0).abs() \u003c 0.001);\n    }\n}\n","traces":[{"line":44,"address":[23060096],"length":1,"stats":{"Line":1}},{"line":45,"address":[15864651],"length":1,"stats":{"Line":1}},{"line":47,"address":[15864791],"length":1,"stats":{"Line":3}},{"line":48,"address":[15279003],"length":1,"stats":{"Line":3}},{"line":49,"address":[15018656,15018670],"length":1,"stats":{"Line":3}},{"line":51,"address":[22599863],"length":1,"stats":{"Line":1}},{"line":52,"address":[15935827],"length":1,"stats":{"Line":0}},{"line":55,"address":[17186160],"length":1,"stats":{"Line":1}},{"line":58,"address":[15713872],"length":1,"stats":{"Line":1}},{"line":59,"address":[15279275],"length":1,"stats":{"Line":1}},{"line":61,"address":[15936081],"length":1,"stats":{"Line":1}},{"line":62,"address":[22600170],"length":1,"stats":{"Line":1}},{"line":63,"address":[16870893],"length":1,"stats":{"Line":3}}],"covered":12,"coverable":13},{"path":["/","home","shift","code","vincents-ai","engram","src","version.rs"],"content":"use std::env;\nuse std::process::Command;\n\n/// Version information for Engram with git tag-based release management\n#[derive(Debug, Clone)]\npub struct BuildInfo {\n    pub package_version: String,\n    pub git_tag: String,\n    pub commit_sha: String,\n    pub commit_date: String,\n    pub build_timestamp: String,\n    pub is_tagged_release: bool,\n}\n\nimpl BuildInfo {\n    pub fn get() -\u003e Self {\n        Self {\n            package_version: env::var(\"CARGO_PKG_VERSION\")\n                .unwrap_or_else(|_| \"unknown\".to_string()),\n            git_tag: env::var(\"ENGRAM_GIT_TAG\").unwrap_or_else(|_| get_runtime_git_tag()),\n            commit_sha: env::var(\"ENGRAM_COMMIT_SHA\").unwrap_or_else(|_| get_runtime_git_sha()),\n            commit_date: env::var(\"ENGRAM_COMMIT_DATE\").unwrap_or_else(|_| get_runtime_git_date()),\n            build_timestamp: env::var(\"ENGRAM_BUILD_TIMESTAMP\")\n                .unwrap_or_else(|_| get_current_timestamp()),\n            is_tagged_release: env::var(\"ENGRAM_IS_TAGGED_RELEASE\")\n                .map(|val| val == \"true\")\n                .unwrap_or(false),\n        }\n    }\n\n    pub fn version_string(\u0026self) -\u003e String {\n        if self.is_tagged_release {\n            self.package_version.clone() // Clean version for tagged releases\n        } else if !self.commit_sha.is_empty() \u0026\u0026 self.commit_sha.len() \u003e= 8 {\n            format!(\n                \"{} ({} {})\",\n                self.package_version,\n                \u0026self.commit_sha[..8],\n                self.commit_date\n            )\n        } else {\n            self.package_version.clone()\n        }\n    }\n}\n\nfn get_runtime_git_tag() -\u003e String {\n    run_git_command(\u0026[\"describe\", \"--tags\", \"--abbrev=0\", \"--exact-match\"]).unwrap_or_default()\n}\n\nfn get_runtime_git_sha() -\u003e String {\n    run_git_command(\u0026[\"log\", \"-1\", \"--format=%H\"]).unwrap_or_else(|| \"unknown\".to_string())\n}\n\nfn get_runtime_git_date() -\u003e String {\n    run_git_command(\u0026[\"log\", \"-1\", \"--format=%ci\"])\n        .map(|output| {\n            output\n                .split_whitespace()\n                .next()\n                .unwrap_or(\"unknown\")\n                .to_string()\n        })\n        .unwrap_or_else(|| \"unknown\".to_string())\n}\n\nfn run_git_command(args: \u0026[\u0026str]) -\u003e Option\u003cString\u003e {\n    match Command::new(\"git\").args(args).output() {\n        Ok(output) if output.status.success() =\u003e {\n            let result = String::from_utf8_lossy(\u0026output.stdout).trim().to_string();\n            if result.is_empty() {\n                None\n            } else {\n                Some(result)\n            }\n        }\n        _ =\u003e None,\n    }\n}\n\nfn get_current_timestamp() -\u003e String {\n    use std::time::{SystemTime, UNIX_EPOCH};\n    let duration = SystemTime::now()\n        .duration_since(UNIX_EPOCH)\n        .unwrap_or_default();\n    format!(\"{}\", duration.as_secs())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn build_info_always_has_package_version() {\n        let info = BuildInfo::get();\n        assert!(!info.package_version.is_empty());\n    }\n\n    #[test]\n    fn build_info_version_string_format() {\n        let info = BuildInfo::get();\n        let version = info.version_string();\n        assert!(!version.is_empty());\n        // Should contain either just version or version with commit info\n        assert!(version.contains(\u0026info.package_version));\n    }\n}\n","traces":[{"line":15,"address":[38785976,38786040,38786008,38785944],"length":1,"stats":{"Line":0}},{"line":16,"address":[17884112,17884892,17884886],"length":1,"stats":{"Line":1}},{"line":18,"address":[24025809],"length":1,"stats":{"Line":2}},{"line":20,"address":[18636114,18636052],"length":1,"stats":{"Line":8}},{"line":21,"address":[17152510,17152579],"length":1,"stats":{"Line":4}},{"line":22,"address":[18454496,18454512],"length":1,"stats":{"Line":8}},{"line":23,"address":[24486847],"length":1,"stats":{"Line":2}},{"line":25,"address":[27097440,27101923,27097408,27100560,27101504,27101523,27097413,27097459,27101904,27100565],"length":1,"stats":{"Line":2}},{"line":31,"address":[17366784],"length":1,"stats":{"Line":1}},{"line":32,"address":[35802977],"length":1,"stats":{"Line":1}},{"line":33,"address":[37254562],"length":1,"stats":{"Line":0}},{"line":34,"address":[17296057,17296098],"length":1,"stats":{"Line":2}},{"line":35,"address":[18785430],"length":1,"stats":{"Line":1}},{"line":38,"address":[18785387],"length":1,"stats":{"Line":1}},{"line":39,"address":[35802859],"length":1,"stats":{"Line":0}},{"line":42,"address":[24486139],"length":1,"stats":{"Line":0}},{"line":47,"address":[17883280],"length":1,"stats":{"Line":2}},{"line":48,"address":[35868608],"length":1,"stats":{"Line":2}},{"line":51,"address":[17366304],"length":1,"stats":{"Line":1}},{"line":52,"address":[19883964,19883952],"length":1,"stats":{"Line":1}},{"line":55,"address":[35743861],"length":1,"stats":{"Line":2}},{"line":56,"address":[38786049],"length":1,"stats":{"Line":2}},{"line":57,"address":[17354964],"length":1,"stats":{"Line":2}},{"line":58,"address":[25277234],"length":1,"stats":{"Line":1}},{"line":59,"address":[25124199],"length":1,"stats":{"Line":2}},{"line":60,"address":[25843906],"length":1,"stats":{"Line":2}},{"line":61,"address":[19941870],"length":1,"stats":{"Line":2}},{"line":62,"address":[35592576],"length":1,"stats":{"Line":2}},{"line":64,"address":[17151625],"length":1,"stats":{"Line":2}},{"line":67,"address":[27097778],"length":1,"stats":{"Line":2}},{"line":68,"address":[24046429],"length":1,"stats":{"Line":4}},{"line":69,"address":[33672480],"length":1,"stats":{"Line":2}},{"line":70,"address":[35803008],"length":1,"stats":{"Line":4}},{"line":71,"address":[17354399,17354516],"length":1,"stats":{"Line":4}},{"line":72,"address":[38785953],"length":1,"stats":{"Line":0}},{"line":74,"address":[34133267],"length":1,"stats":{"Line":2}},{"line":77,"address":[35803045],"length":1,"stats":{"Line":1}},{"line":81,"address":[24392421],"length":1,"stats":{"Line":2}},{"line":83,"address":[17295793],"length":1,"stats":{"Line":2}},{"line":84,"address":[37255759],"length":1,"stats":{"Line":2}},{"line":86,"address":[17883513],"length":1,"stats":{"Line":2}}],"covered":36,"coverable":41}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, 'üåô'),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      const nbHit = covered? trace.stats.Line: 0;
      return e(
        'div',
        { className: 'code-text-container' },
        e(
          'code',
          {
            className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          },
          line
        ),
        e(
          'div',
          { className: 'cover-indicator' + (covered? ' check-cover': '') + (uncovered? ' no-cover': '')},
          e(
            'div',
            { className: (covered? 'stat-line-hit': '')},
            covered? nbHit: ""
          )
        )
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = 'üåô';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '‚òÄÔ∏è';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = 'üåô';
    }
  });
})();
</script>
</body>
</html>